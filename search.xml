<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>åŸºäºNginxå’Œdnsmasqå®ç°è·¯ç”±çš„åŠ¨æ€DNSè§£æ</title>
      <link href="/posts/8255/"/>
      <url>/posts/8255/</url>
      
        <content type="html"><![CDATA[<p>è¿‘æœŸåœ¨è·Ÿå‰ç«¯åŒå­¦è”è°ƒçš„æ—¶å€™ï¼Œå‡ºç°äº†ä¸€ç‚¹å°æ’æ›²ï¼Œæˆ‘ä»¬ä¸¤ä¸ªçš„é¡¹ç›®æ˜¯åŒä¸€ä¸ªåŸŸåï¼Œç„¶è€Œï¼Œä»–çš„æœ¬åœ°æ²¡æœ‰æ­æœåŠ¡ç«¯çš„è¿è¡Œç¯å¢ƒï¼Œæ‰€ä»¥å°±å¯¼è‡´äº†å‰ç«¯éœ€è¦çš„hostsæ–‡ä»¶å’Œè¯·æ±‚æ¥å£éœ€è¦çš„hostsæ–‡ä»¶ä¸ä¸€è‡´çš„æƒ…å†µï¼ŒåŸºäºè¿™ç§æƒ…å†µï¼Œæˆ‘å°±è€ƒè™‘æ˜¯å¦å¯ä»¥é€šè¿‡nginxæ¥åŒ¹é…ä¸åŒçš„è·¯ç”±ï¼Œå°†è¯·æ±‚æ‰“åˆ°ä¸åŒçš„æœºå™¨ä¸Šé¢ï¼Ÿ</p><a id="more"></a><p>æˆ‘ä»¬éƒ½çŸ¥é“ nginxå¯ä»¥é€šè¿‡ <code>resolver</code> å‘½ä»¤æ¥è®¾ç½®åŸŸåçš„DNSè§£ææœåŠ¡å™¨ï¼Œæ‰€ä»¥ï¼Œå¦‚æœè·¯ç”±æ˜¯å‰ç«¯è·¯ç”±ï¼Œå°±è¯·æ±‚ è‡ªèº«çš„DNSæœåŠ¡å™¨ï¼Œå°†åŸŸåè§£æåˆ°æœ¬æœºï¼Œå¦‚æœæ˜¯æ¥å£ï¼Œå°±é€šè¿‡æˆ‘çš„DNSæœåŠ¡å™¨æˆ–è€…æ­£å¸¸çš„DNSæœåŠ¡å™¨è§£æåˆ°å…¶ä»–çš„åœ°å€</p><p>æŒ‰ç…§ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨æœ¬æœºæ­å»ºä¸€ä¸ªDNSæœåŠ¡å™¨ï¼Œè¿™é‡Œæˆ‘é€‰ç”¨äº† <code>dnsmasq</code>ï¼Œæ²¡æœ‰ä»€ä¹ˆç†ç”±ï¼Œå°±æ˜¯ç½‘ä¸Šèµ„æ–™å¤šğŸ¤ª</p><h1 id="dnsmasq"><a href="#dnsmasq" class="headerlink" title="dnsmasq"></a>dnsmasq</h1><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>é€šè¿‡ <code>brew</code> å®‰è£…å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install dnsmasq</span><br></pre></td></tr></table></figure><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><h3 id="é…ç½®dnsmasq"><a href="#é…ç½®dnsmasq" class="headerlink" title="é…ç½®dnsmasq"></a>é…ç½®dnsmasq</h3><p>é…ç½®æ–‡ä»¶åœ¨ <code>/usr/local/etc/dnsmasq.conf</code></p><ol><li>è®¾ç½® <code>listen-address</code>: listen-address=127.0.0.1 æˆ–è€…å…¶ä»–éœ€è¦ç›‘å¬çš„å†…ç½‘æˆ–å…¬ç½‘ipåœ°å€</li><li>å–æ¶ˆæ³¨é‡Š <code>strict-order</code></li><li>å¦‚æœä¸æƒ³ä½¿ç”¨ <code>/etc/hosts</code> å’Œ <code>/etc/resolve.conf</code> å¯ä»¥ä¿®æ”¹å¦‚ä¸‹<ol><li>é…ç½® <code>resolv-file</code>: resolv-file=/etc/resolv.dnsmasq.conf æ–‡ä»¶åå­—éšæ„</li><li>é…ç½® <code>addn-hosts</code>: addn-hosts=/etc/dnsmasq.hosts æ–‡ä»¶åå­—éšæ„</li></ol></li></ol><h3 id="é…ç½®resolv"><a href="#é…ç½®resolv" class="headerlink" title="é…ç½®resolv"></a>é…ç½®resolv</h3><p>è¿™é‡Œçš„resolvæŒ‡çš„æ˜¯ ä¸Šé¢é…ç½®ä¸­ <code>resolv-file</code> æ‰€å¯¹åº”çš„æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nameserver 127.0.0.1 # æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œä¼šé¦–å…ˆå»è¿™ä¸ªåœ°å€è¯·æ±‚dnsè§£æ</span><br><span class="line">nameserver 114.114.114.114</span><br></pre></td></tr></table></figure><h3 id="é…ç½®hosts"><a href="#é…ç½®hosts" class="headerlink" title="é…ç½®hosts"></a>é…ç½®hosts</h3><p>æŠŠ éœ€è¦è§£æçš„åŸŸå æ·»åŠ è¿›å»å³å¯ï¼Œä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 test.tyloafer.cn</span><br></pre></td></tr></table></figure><h2 id="å¯åœæ§åˆ¶"><a href="#å¯åœæ§åˆ¶" class="headerlink" title="å¯åœæ§åˆ¶"></a>å¯åœæ§åˆ¶</h2><ul><li>å¯åŠ¨ï¼š brew services start dnsmasq</li><li>åœæ­¢ï¼š brew services stop dnsmasq</li><li>é‡å¯ï¼š brew services restart dnsmasq</li></ul><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  test.tyloafer.cn;</span><br><span class="line">    <span class="attribute">root</span> html;</span><br><span class="line">    <span class="attribute">add_header</span> Content-Type <span class="string">'text/html; charset=utf-8'</span>;</span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /local</span> &#123;</span><br><span class="line">        <span class="attribute">resolver</span> <span class="number">127.0.0.1</span> ipv6=<span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://test.tyloafer.cn/1.html<span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /remote</span> &#123;</span><br><span class="line">        <span class="attribute">resolver</span> <span class="number">114.114.114.114</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://test.tyloafer.cn/1.html<span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /1.html</span> &#123;</span><br><span class="line">        <span class="attribute">add_header</span> Content-Type <span class="string">'text/html; charset=utf-8'</span>;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">"ok"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ±‚æµç¨‹åˆ†æï¼š</p><blockquote><p><a href="http://test.tyloafer.cn/local" target="_blank" rel="noopener">http://test.tyloafer.cn/local</a></p></blockquote><ol><li>é¦–å…ˆ æ ¹æ®æœ¬æœºçš„dnsè§£æï¼Œä¼šè§£æåˆ°127.0.0.1ï¼Œä¹Ÿå°±æ˜¯æœ¬æœº</li><li>ç„¶å nginxæ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œä¼šåŒ¹é…åˆ° <code>location ~ /local</code> è¿™æ¡è§„åˆ™ï¼Œç„¶å è°ƒç”¨127.0.0.1 çš„DNSæœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æ­å»ºçš„ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°æœ¬æœºçš„ <code>/1.html</code> è·¯ç”±ä¸‹</li><li>nginxæ”¶åˆ° proxy_passçš„è¯·æ±‚ï¼ŒåŒ¹é…åˆ° <code>location ~ /1.html</code> ï¼Œç„¶åè¾“å‡º â€œokâ€</li></ol><blockquote><p><a href="http://test.tyloafer.cn/remote" target="_blank" rel="noopener">http://test.tyloafer.cn/remote</a></p></blockquote><ol><li>é¦–å…ˆ æ ¹æ®æœ¬æœºçš„dnsè§£æï¼Œä¼šè§£æåˆ°127.0.0.1ï¼Œä¹Ÿå°±æ˜¯æœ¬æœº</li><li>ç„¶å nginxæ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œä¼šåŒ¹é…åˆ° <code>location ~ /remote</code> è¿™æ¡è§„åˆ™ï¼Œç„¶å è°ƒç”¨114.114.114.114 çš„DNSæœåŠ¡å™¨ï¼Œè¿™é‡Œä¼šè¿›è¡Œæ­£å¸¸çš„DNSè§£æï¼Œæ‰¾åˆ°çœŸå®çš„æœåŠ¡å™¨åœ°å€</li><li>ç›®æ ‡æœåŠ¡å™¨çš„nginxæ”¶åˆ° proxy_passçš„è¯·æ±‚ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼ˆ1.html åœ¨æˆ‘çš„ç›®æ ‡æœåŠ¡å™¨ä¸Šæ²¡æœ‰ï¼Œæ‰€ä»¥ä¼šè¿”å›404ï¼‰</li></ol>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
          <category> DNS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go HttpåŒ…è§£æï¼šä¸ºä»€ä¹ˆéœ€è¦response.Body.Close()</title>
      <link href="/posts/33256/"/>
      <url>/posts/33256/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘çº¿ä¸Šçš„ä¸€ä¸ªé¡¹ç›®é‡åˆ°äº†å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼ŒæŸ¥äº†heapä¹‹åï¼Œå‘ç° httpåŒ…çš„ dialConnå‡½æ•°ç«Ÿç„¶å äº†å†…å­˜ä½¿ç”¨çš„å¤§å¤´ï¼Œè¿™ä¸ªæœ‰ç‚¹æ‡µé€¼äº†ï¼Œåé¢åœ¨ç½‘ä¸ŠæŸ¥è¯¢èµ„æ–™çš„æ—¶å€™æ— æ„é—´å‘ç°ä¸€å¥è¯</p><blockquote><p>10æ¬¡å†…å­˜æ³„éœ²ï¼Œæœ‰9æ¬¡æ˜¯goroutineæ³„éœ²ã€‚</p></blockquote><p>ç»“æœå‘ç°ï¼Œæ­£æ˜¯æˆ‘è®¤ä¸ºçš„ä¸å¯èƒ½çš„goroutineæ³„éœ²å¯¼è‡´äº†è¿™æ¬¡çš„å†…å­˜æ³„éœ²ï¼Œè€Œgoroutineæ³„éœ²çš„åŸå› å°±æ˜¯ æ²¡æœ‰è°ƒç”¨ <code>response.Body.Close()</code></p><a id="more"></a><h1 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h1><p>æ—¢ç„¶å‘ç°æ˜¯ <code>response.Body.Close()</code> æƒ¹çš„ç¥¸ï¼Œé‚£å°±åšä¸ªå®éªŒè¯å®ä¸€ä¸‹</p><h2 id="ä¸close-response-Body"><a href="#ä¸close-response-Body" class="headerlink" title="ä¸close response.Body"></a>ä¸close response.Body</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> <span class="literal">true</span> &#123;</span><br><span class="line">requestWithNoClose()</span><br><span class="line">time.Sleep(time.Microsecond * <span class="number">100</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requestWithNoClose</span><span class="params">()</span></span> &#123;</span><br><span class="line">_, err := http.Get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"error occurred while fetching page, error: %s"</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"ok"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>##close response.Body</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> <span class="literal">true</span> &#123;</span><br><span class="line">requestWithClose()</span><br><span class="line">time.Sleep(time.Microsecond * <span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requestWithClose</span><span class="params">()</span></span> &#123;</span><br><span class="line">resp, err := http.Get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"error occurred while fetching page, error: %s"</span>, err.Error())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">fmt.Println(<span class="string">"ok"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><p>åŒæ ·çš„ä»£ç ï¼ŒåŒºåˆ«åªæœ‰ æ˜¯å¦<code>resp.Body.Close()</code> æ˜¯å¦è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå‘ç°å†…å­˜å·®è·å¦‚æ­¤ä¹‹å¤§</p><p><img src="http://note-1253518569.cossh.myqcloud.com/20190712195959.png" alt></p><p>åé¢ï¼Œæˆ‘ä»¬å°±å¸¦ç€é—®é¢˜ï¼Œæ·±å…¥ä¸€ä¸‹HttpåŒ…çš„åº•å±‚å®ç°æ¥æ‰¾å‡ºå…·ä½“åŸå› </p><h1 id="ç»“æ„ä½“"><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h1><p>åªåˆ†ææˆ‘ä»¬å¯èƒ½ç”¨ä¼šç”¨åˆ°çš„</p><h2 id="Transport"><a href="#Transport" class="headerlink" title="Transport"></a>Transport</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Transport <span class="keyword">struct</span> &#123;</span><br><span class="line">idleMu     sync.Mutex</span><br><span class="line">wantIdle   <span class="keyword">bool</span>                                <span class="comment">// user has requested to close all idle conns</span></span><br><span class="line">  <span class="comment">// ç©ºé—²çš„è¿æ¥ ç¼“å­˜çš„åœ°æ–¹</span></span><br><span class="line">idleConn   <span class="keyword">map</span>[connectMethodKey][]*persistConn <span class="comment">// most recently used at end</span></span><br><span class="line">  <span class="comment">// connectMethodKey =&gt; ç©ºé—²è¿æ¥çš„chan å½¢æˆçš„map</span></span><br><span class="line">  <span class="comment">// æœ‰ç©ºé—²è¿æ¥æ”¾å…¥çš„æ—¶å€™ï¼Œé¦–å…ˆå°è¯•æ”¾å…¥è¿™ä¸ªchanï¼Œæ–¹ä¾¿å¦ä¸€ä¸ªå¯èƒ½éœ€è¦è¿æ¥çš„goroutineç›´æ¥ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰goroutineéœ€è¦è¿æ¥ï¼Œå°±æ”¾å…¥åˆ°ä¸Šé¢çš„idleConné‡Œé¢ï¼Œä¾¿äºåé¢çš„è¯·æ±‚è¿æ¥å¤ç”¨</span></span><br><span class="line">idleConnCh <span class="keyword">map</span>[connectMethodKey]<span class="keyword">chan</span> *persistConn</span><br><span class="line"><span class="comment">// DisableKeepAlives, if true, disables HTTP keep-alives and</span></span><br><span class="line"><span class="comment">// will only use the connection to the server for a single</span></span><br><span class="line"><span class="comment">// HTTP request.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This is unrelated to the similarly named TCP keep-alives.</span></span><br><span class="line">  <span class="comment">// æ˜¯å¦å¼€å¯ keepAliveï¼Œä¸ºtrueçš„è¯ï¼Œè¿æ¥ä¸ä¼šè¢«å¤ç”¨</span></span><br><span class="line">DisableKeepAlives <span class="keyword">bool</span></span><br><span class="line"><span class="comment">// MaxIdleConns controls the maximum number of idle (keep-alive)</span></span><br><span class="line"><span class="comment">// connections across all hosts. Zero means no limit.</span></span><br><span class="line">  <span class="comment">// æ‰€æœ‰hostså¯¹åº”çš„æœ€å¤§çš„è¿æ¥æ€»æ•°</span></span><br><span class="line">MaxIdleConns <span class="keyword">int</span></span><br><span class="line">  <span class="comment">// æ¯ä¸€ä¸ªhostå¯¹åº”çš„æœ€å¤§çš„ç©ºé—²è¿æ¥æ•°</span></span><br><span class="line">MaxIdleConnsPerHost <span class="keyword">int</span></span><br><span class="line">  <span class="comment">// æ¯ä¸€ä¸ªhostå¯¹åº”çš„æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">MaxConnsPerHost <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="pconnect"><a href="#pconnect" class="headerlink" title="pconnect"></a>pconnect</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> persistConn <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="comment">// alt optionally specifies the TLS NextProto RoundTripper.</span></span><br><span class="line">   <span class="comment">// This is used for HTTP/2 today and future protocols later.</span></span><br><span class="line">   <span class="comment">// If it's non-nil, the rest of the fields are unused.</span></span><br><span class="line">   alt RoundTripper</span><br><span class="line"></span><br><span class="line">   t         *Transport</span><br><span class="line">   cacheKey  connectMethodKey</span><br><span class="line">   conn      net.Conn</span><br><span class="line">   tlsState  *tls.ConnectionState</span><br><span class="line">   br        *bufio.Reader       <span class="comment">// from conn</span></span><br><span class="line">   bw        *bufio.Writer       <span class="comment">// to conn</span></span><br><span class="line">   nwrite    <span class="keyword">int64</span>               <span class="comment">// bytes written</span></span><br><span class="line">   <span class="comment">// roundTrip å¾€ è¿™ä¸ªchan é‡Œå†™å…¥requestï¼ŒreadLoopä»è¿™ä¸ª chan è¯»å–request</span></span><br><span class="line">   reqch     <span class="keyword">chan</span> requestAndChan <span class="comment">// written by roundTrip; read by readLoop</span></span><br><span class="line">   <span class="comment">// roundTrip å¾€ è¿™ä¸ªchan é‡Œå†™å…¥request å’Œ writeErrChï¼ŒwriteLoopä»è¿™ä¸ª chan è¯»å–requestå†™å…¥å¤§ç›˜ è¿æ¥ é‡Œï¼Œå¹¶å†™å…¥ err åˆ° writeErrCh chan</span></span><br><span class="line">   writech   <span class="keyword">chan</span> writeRequest   <span class="comment">// written by roundTrip; read by writeLoop</span></span><br><span class="line">   closech   <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;       <span class="comment">// closed when conn closed</span></span><br><span class="line">   <span class="comment">// åˆ¤æ–­bodyæ˜¯å¦è¯»å–å®Œ</span></span><br><span class="line">   sawEOF    <span class="keyword">bool</span>  <span class="comment">// whether we've seen EOF from conn; owned by readLoop</span></span><br><span class="line">   <span class="comment">// writeErrCh passes the request write error (usually nil)</span></span><br><span class="line">   <span class="comment">// from the writeLoop goroutine to the readLoop which passes</span></span><br><span class="line">   <span class="comment">// it off to the res.Body reader, which then uses it to decide</span></span><br><span class="line">   <span class="comment">// whether or not a connection can be reused. Issue 7569.</span></span><br><span class="line">   <span class="comment">// writeLoop å†™å…¥ errçš„ chan</span></span><br><span class="line">   writeErrCh <span class="keyword">chan</span> error</span><br><span class="line"> <span class="comment">// writeLoop ç»“æŸçš„æ—¶å€™å…³é—­</span></span><br><span class="line">   writeLoopDone <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// closed when write loop ends</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="writeRequest"><a href="#writeRequest" class="headerlink" title="writeRequest"></a>writeRequest</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> writeRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">   req *transportRequest</span><br><span class="line">   ch  <span class="keyword">chan</span>&lt;- error</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Optional blocking chan for Expect: 100-continue (for receive).</span></span><br><span class="line">   <span class="comment">// If not nil, writeLoop blocks sending request body until</span></span><br><span class="line">   <span class="comment">// it receives from this chan.</span></span><br><span class="line">   continueCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>##requestAndChan</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> requestAndChan <span class="keyword">struct</span> &#123;</span><br><span class="line">   req *Request</span><br><span class="line">   ch  <span class="keyword">chan</span> responseAndError <span class="comment">// unbuffered; always send in select on callerGone</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// whether the Transport (as opposed to the user client code)</span></span><br><span class="line">   <span class="comment">// added the Accept-Encoding gzip header. If the Transport</span></span><br><span class="line">   <span class="comment">// set it, only then do we transparently decode the gzip.</span></span><br><span class="line">   addedGzip <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Optional blocking chan for Expect: 100-continue (for send).</span></span><br><span class="line">   <span class="comment">// If the request has an "Expect: 100-continue" header and</span></span><br><span class="line">   <span class="comment">// the server responds 100 Continue, readLoop send a value</span></span><br><span class="line">   <span class="comment">// to writeLoop via this chan.</span></span><br><span class="line">   continueCh <span class="keyword">chan</span>&lt;- <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">   callerGone &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// closed when roundTrip caller has returned</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="è¯·æ±‚æµç¨‹"><a href="#è¯·æ±‚æµç¨‹" class="headerlink" title="è¯·æ±‚æµç¨‹"></a>è¯·æ±‚æµç¨‹</h1><p>è¿™é‡Œçš„å‡½æ•°æ²¡æœ‰å¤ªå¤šçš„é€»è¾‘ï¼Œè´´å‡ºæ¥ä¸»è¦æ˜¯ä¸ºäº†è¿½è¸ªè¿‡ç¨‹</p><p>è¿™é‡Œç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­è¡¨ç¤º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ Http åŒ…çš„ Get å‡½æ•°å¤„ç†</span></span><br><span class="line">resp, err := http.Get(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">resp.Body.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="client-Get"><a href="#client-Get" class="headerlink" title="client.Get"></a>client.Get</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> DefaultClient = &amp;Client&#123;&#125;</span><br><span class="line">....</span><br><span class="line"><span class="comment">// ä½¿ç”¨é»˜è®¤çš„ clientï¼Œ è°ƒç”¨ client.Get æ¥å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Get</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="params">(resp *Response, err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> DefaultClient.Get(url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">Get</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="params">(resp *Response, err error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// requestè¿™é‡Œçš„åˆ›å»ºå¿½ç•¥</span></span><br><span class="line">req, err := NewRequest(<span class="string">"GET"</span>, url, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ client.Do å‡½æ•°æ¥å¤„ç†ï¼Œ ç„¶å client.Do è°ƒç”¨ client.do æ¥å¤„ç†ï¼Œä¸æ‡‚ä¸ºå•¥éè¦å¤šä¸€å±‚åµŒå¥—</span></span><br><span class="line"><span class="keyword">return</span> c.Do(req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="client-do"><a href="#client-do" class="headerlink" title="client.do"></a>client.do</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">do</span><span class="params">(req *Request)</span> <span class="params">(retres *Response, reterr error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// URL åŠ hookæ£€æµ‹ï¼Œå¿½ç•¥...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">deadline      = c.deadline()</span><br><span class="line">reqs          []*Request</span><br><span class="line">resp          *Response</span><br><span class="line">copyHeaders   = c.makeHeadersCopier(req)</span><br><span class="line">reqBodyClosed = <span class="literal">false</span> <span class="comment">// have we closed the current req.Body?</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Redirect behavior:</span></span><br><span class="line">redirectMethod <span class="keyword">string</span></span><br><span class="line">includeBody    <span class="keyword">bool</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é”™è¯¯è‡ªå®šä¹‰å¤„ç†ï¼Œå¿½ç•¥....</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥æ— å…³çš„ä»£ç ....</span></span><br><span class="line">    </span><br><span class="line">reqs = <span class="built_in">append</span>(reqs, req)</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="keyword">var</span> didTimeout <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span></span></span><br><span class="line"><span class="function">    // è°ƒç”¨ <span class="title">client</span>.<span class="title">send</span> æ–¹æ³•æ¥è·å–<span class="title">response</span>ï¼Œä¸»è¦é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="title">resp</span>, <span class="title">didTimeout</span>, <span class="title">err</span> = <span class="title">c</span>.<span class="title">send</span><span class="params">(req, deadline)</span>; <span class="title">err</span> != <span class="title">nil</span></span> &#123;</span><br><span class="line"><span class="comment">// c.send() always closes req.Body</span></span><br><span class="line">reqBodyClosed = <span class="literal">true</span></span><br><span class="line"><span class="keyword">if</span> !deadline.IsZero() &amp;&amp; didTimeout() &#123;</span><br><span class="line">err = &amp;httpError&#123;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> early in cycle: s/Client.Timeout exceeded/timeout or context cancelation/</span></span><br><span class="line">err:     err.Error() + <span class="string">" (Client.Timeout exceeded while awaiting headers)"</span>,</span><br><span class="line">timeout: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, uerr(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è½¬ï¼Œè¿›è€Œè¿›ä¸€æ­¥è¯·æ±‚</span></span><br><span class="line"><span class="keyword">var</span> shouldRedirect <span class="keyword">bool</span></span><br><span class="line">redirectMethod, shouldRedirect, includeBody = redirectBehavior(req.Method, resp, reqs[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> !shouldRedirect &#123;</span><br><span class="line"><span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req.closeBody()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="client-send"><a href="#client-send" class="headerlink" title="client.send"></a>client.send</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">send</span><span class="params">(req *Request, deadline time.Time)</span> <span class="params">(resp *Response, didTimeout <span class="keyword">func</span>()</span> <span class="title">bool</span>, <span class="title">err</span> <span class="title">error</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> c.Jar != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, cookie := <span class="keyword">range</span> c.Jar.Cookies(req.URL) &#123;</span><br><span class="line">req.AddCookie(cookie)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ send æ–¹æ³•æ¥è·å– response</span></span><br><span class="line">resp, didTimeout, err = send(req, c.transport(), deadline)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, didTimeout, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> c.Jar != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> rc := resp.Cookies(); <span class="built_in">len</span>(rc) &gt; <span class="number">0</span> &#123;</span><br><span class="line">c.Jar.SetCookies(req.URL, rc)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> resp, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="send"><a href="#send" class="headerlink" title="send"></a>send</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ireq *Request, rt RoundTripper, deadline time.Time)</span> <span class="params">(resp *Response, didTimeout <span class="keyword">func</span>()</span> <span class="title">bool</span>, <span class="title">err</span> <span class="title">error</span>)</span> &#123;</span><br><span class="line">req := ireq <span class="comment">// req is either the original request, or a modified fork</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// URL Hader ç­‰åˆ¤æ–­åŠè¯·æ±‚forkï¼Œå¿½ç•¥....</span></span><br><span class="line">  </span><br><span class="line">stopTimer, didTimeout := setRequestCancel(req, rt, deadline)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è°ƒç”¨ Transport.RoundTrip æ¥å¤„ç†è¯·æ±‚</span></span><br><span class="line">resp, err = rt.RoundTrip(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">stopTimer()</span><br><span class="line"><span class="keyword">if</span> resp != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"RoundTripper returned a response &amp; error; ignoring response"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> tlsErr, ok := err.(tls.RecordHeaderError); ok &#123;</span><br><span class="line"><span class="comment">// If we get a bad TLS record header, check to see if the</span></span><br><span class="line"><span class="comment">// response looks like HTTP and give a more helpful error.</span></span><br><span class="line"><span class="comment">// See golang.org/issue/11111.</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">string</span>(tlsErr.RecordHeader[:]) == <span class="string">"HTTP/"</span> &#123;</span><br><span class="line">err = errors.New(<span class="string">"http: server gave HTTP response to HTTPS client"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, didTimeout, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> !deadline.IsZero() &#123;</span><br><span class="line">resp.Body = &amp;cancelTimerBody&#123;</span><br><span class="line">stop:          stopTimer,</span><br><span class="line">rc:            resp.Body,</span><br><span class="line">reqDidTimeout: didTimeout,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> resp, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Transport-roundTrip"><a href="#Transport-roundTrip" class="headerlink" title="Transport.roundTrip"></a>Transport.roundTrip</h2><p>è¿™é‡Œå¼€å§‹æ¥è¿‘é‡ç‚¹åŒºåŸŸäº†</p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯æ¹–åŒºè¿æ¥ï¼Œç„¶åè·å–responseè¿”å›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Transport)</span> <span class="title">roundTrip</span><span class="params">(req *Request)</span> <span class="params">(*Response, error)</span></span> &#123;</span><br><span class="line">   t.nextProtoOnce.Do(t.onceSetNextProtoDefaults)</span><br><span class="line">   ctx := req.Context()</span><br><span class="line">   trace := httptrace.ContextClientTrace(ctx)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// URL, header schema ç­‰åˆ¤æ–­ï¼Œä¸ä¸»æµç¨‹æ— å…³ï¼Œå¿½ç•¥...</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">     <span class="comment">// åˆ¤æ–­context æ˜¯å¦å®Œæˆï¼Œè¶…æ—¶ç­‰</span></span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">         req.closeBody()</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span>, ctx.Err()</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// treq gets modified by roundTrip, so we need to recreate for each retry.</span></span><br><span class="line">      <span class="comment">// treqä¼šè¢« roundTrip æ–¹æ³•ä¿®æ”¹ï¼Œæ‰€æœ‰æ¯ä¸€æ¬¡å¾ªç¯éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„</span></span><br><span class="line">      treq := &amp;transportRequest&#123;Request: req, trace: trace&#125;</span><br><span class="line">      <span class="comment">// æ ¹æ®å½“å‰çš„è¯·æ±‚è·å– connectMethodï¼ŒåŒ…å«schemaå’Œaddressï¼Œæ–¹ä¾¿è¯·æ±‚çš„å¤ç”¨ï¼Œè¿™é‡Œä¸é‡è¦ï¼Œä¸åšè¯¦ç»†åˆ†æ</span></span><br><span class="line">      cm, err := t.connectMethodForRequest(treq)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         req.closeBody()</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Get the cached or newly-created connection to either the</span></span><br><span class="line">      <span class="comment">// host (for http or https), the http proxy, or the http proxy</span></span><br><span class="line">      <span class="comment">// pre-CONNECTed to https server. In any case, we'll be ready</span></span><br><span class="line">      <span class="comment">// to send it requests.</span></span><br><span class="line">      <span class="comment">// æ ¹æ®è¯·æ±‚å’ŒconnectMethodè·å–ä¸€ä¸ªå¯ç”¨çš„è¿æ¥ï¼Œé‡è¦ï¼Œåé¢ä¼šå…·ä½“åˆ†æ</span></span><br><span class="line">      pconn, err := t.getConn(treq, cm)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         t.setReqCanceler(req, <span class="literal">nil</span>)</span><br><span class="line">         req.closeBody()</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> resp *Response</span><br><span class="line">      <span class="keyword">if</span> pconn.alt != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="comment">// HTTP/2 path.</span></span><br><span class="line">         <span class="comment">// http2 ä½¿ç”¨ï¼Œè¿™é‡Œä¸å±•å¼€</span></span><br><span class="line">         t.decHostConnCount(cm.key()) <span class="comment">// don't count cached http2 conns toward conns per host</span></span><br><span class="line">         t.setReqCanceler(req, <span class="literal">nil</span>)   <span class="comment">// not cancelable with CancelRequest</span></span><br><span class="line">         resp, err = pconn.alt.RoundTrip(req)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// è·å–responseï¼Œè¿™é‡Œæ˜¯é‡ç‚¹ï¼Œåé¢å±•å¼€</span></span><br><span class="line">         resp, err = pconn.roundTrip(treq)</span><br><span class="line">      &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// åˆ¤æ–­è·å–responseæ˜¯å¦æœ‰è¯¯åŠé”™è¯¯å¤„ç†ç­‰æ“ä½œï¼Œæ— å…³ç´§è¦ï¼Œå¿½ç•¥</span></span><br><span class="line">     </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œè¿›å…¥é‡ç‚¹åˆ†æäº† <code>getConn</code> <code>persistConn.roundTrip</code> <code>Transport.dialConn</code> ä»¥åŠå†…å­˜æ³„éœ²çš„ç½ªé­ç¥¸é¦– <code>persistConn.readLoop</code> <code>persistConn.writeLoop</code></p><h3 id="Transport-getConn"><a href="#Transport-getConn" class="headerlink" title="Transport.getConn"></a>Transport.getConn</h3><p>è¿™ä¸ªæ–¹æ³•æ ¹æ®connectMethodï¼Œä¹Ÿå°±æ˜¯ schemaå’Œaddrï¼ˆå¿½ç•¥proxyä»£ç†ï¼‰ï¼Œå¤ç”¨è¿æ¥æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ï¼ŒåŒæ—¶å¼€å¯äº†ä¸¤ä¸ªgoroutineï¼Œåˆ†åˆ« è¯»å–response å’Œ å†™request</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Transport)</span> <span class="title">getConn</span><span class="params">(treq *transportRequest, cm connectMethod)</span> <span class="params">(*persistConn, error)</span></span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// traceç›¸å…³çš„å¿½ç•¥...</span></span><br><span class="line">  </span><br><span class="line">req := treq.Request</span><br><span class="line">trace := treq.trace</span><br><span class="line">ctx := req.Context()</span><br><span class="line"><span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.GetConn != <span class="literal">nil</span> &#123;</span><br><span class="line">trace.GetConn(cm.addr())</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä»idleConné‡Œé¢è·å–ä¸€ä¸ª connectMethodå¯¹åº”çš„ç©ºé—²çš„ è¿æ¥ï¼Œè·å–åˆ°äº†ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">if</span> pc, idleSince := t.getIdleConn(cm); pc != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.GotConn != <span class="literal">nil</span> &#123;</span><br><span class="line">trace.GotConn(pc.gotIdleConnTrace(idleSince))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// set request canceler to some non-nil function so we</span></span><br><span class="line"><span class="comment">// can detect whether it was cleared between now and when</span></span><br><span class="line"><span class="comment">// we enter roundTrip</span></span><br><span class="line">t.setReqCanceler(req, <span class="function"><span class="keyword">func</span><span class="params">(error)</span></span> &#123;&#125;)</span><br><span class="line"><span class="keyword">return</span> pc, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> dialRes <span class="keyword">struct</span> &#123;</span><br><span class="line">pc  *persistConn</span><br><span class="line">err error</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰è·å–åˆ°ç©ºé—²è¿æ¥ï¼Œå®šä¹‰ä¸€ä¸ª dialRes ç»“æ„ä½“ï¼Œç”¨äºæ¥æ”¶ è‡ªèº«åˆ›å»ºçš„å¦ä¸€ä¸ªgoroutineåˆ›å»ºçš„ è¿æ¥</span></span><br><span class="line">dialc := <span class="built_in">make</span>(<span class="keyword">chan</span> dialRes)</span><br><span class="line">cmKey := cm.key()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Copy these hooks so we don't race on the postPendingDial in</span></span><br><span class="line"><span class="comment">// the goroutine we launch. Issue 11136.</span></span><br><span class="line">testHookPrePendingDial := testHookPrePendingDial</span><br><span class="line">testHookPostPendingDial := testHookPostPendingDial</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç† dialc ä¸­æš‚æ—¶ç”¨ä¸åˆ°çš„è¿æ¥çš„æ–¹æ³•ï¼Œåé¢ä¼šè®²åˆ°ä¸ºä»€ä¹ˆæœ‰å¯èƒ½åˆ›å»ºçš„è¿æ¥æ˜¯æ²¡æœ‰äººä½¿ç”¨çš„</span></span><br><span class="line">handlePendingDial := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">testHookPrePendingDial()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> v := &lt;-dialc; v.err == <span class="literal">nil</span> &#123;</span><br><span class="line">t.putOrCloseIdleConn(v.pc)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">t.decHostConnCount(cmKey)</span><br><span class="line">&#125;</span><br><span class="line">testHookPostPendingDial()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cancelc := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</span><br><span class="line">t.setReqCanceler(req, <span class="function"><span class="keyword">func</span><span class="params">(err error)</span></span> &#123; cancelc &lt;- err &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¿½ç•¥éƒ¨åˆ†åˆ¤æ–­...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å¯ä¸€ä¸ªgoroutineï¼Œå»åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼ŒdialConn æ˜¯é‡ç‚¹ï¼Œåé¢æ·±å…¥åˆ†æ</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">pc, err := t.dialConn(ctx, cm)</span><br><span class="line">dialc &lt;- dialRes&#123;pc, err&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å– idleChanä¸­å¯¹åº”connectMethodçš„ channel</span></span><br><span class="line">idleConnCh := t.getIdleConnCh(cm)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä»å¤šä¸ªchanä¸­è·å–è¿æ¥ï¼Œè·å–å–æ¶ˆä¿¡å·ï¼Œå…ˆæ¥çš„å…ˆå¤„ç†</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> v := &lt;-dialc:</span><br><span class="line">    <span class="comment">// ä¸Šé¢ goroutineé¦–å…ˆåˆ›å»ºå®Œæˆäº†ä¸€ä¸ªè¿æ¥ï¼Œä½¿ç”¨è¿™ä¸ªé“¾æ¥</span></span><br><span class="line"><span class="comment">// Our dial finished.</span></span><br><span class="line"><span class="keyword">if</span> v.pc != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.GotConn != <span class="literal">nil</span> &amp;&amp; v.pc.alt == <span class="literal">nil</span> &#123;</span><br><span class="line">trace.GotConn(httptrace.GotConnInfo&#123;Conn: v.pc.conn&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> v.pc, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Our dial failed. See why to return a nicer error</span></span><br><span class="line"><span class="comment">// value.</span></span><br><span class="line">t.decHostConnCount(cmKey)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-req.Cancel:</span><br><span class="line"><span class="comment">// It was an error due to cancelation, so prioritize that</span></span><br><span class="line"><span class="comment">// error value. (Issue 16049)</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errRequestCanceledConn</span><br><span class="line"><span class="keyword">case</span> &lt;-req.Context().Done():</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, req.Context().Err()</span><br><span class="line"><span class="keyword">case</span> err := &lt;-cancelc:</span><br><span class="line"><span class="keyword">if</span> err == errRequestCanceled &#123;</span><br><span class="line">err = errRequestCanceledConn</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">// It wasn't an error due to cancelation, so</span></span><br><span class="line"><span class="comment">// return the original error message:</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, v.err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> pc := &lt;-idleConnCh:</span><br><span class="line">    <span class="comment">// å¦ä¸€ä¸ªgoroutineçš„requesté¦–å…ˆå®Œæˆäº†ï¼Œç„¶åä¼šæŠŠè¿™ä¸ªé“¾æ¥é¦–å…ˆå°è¯•æ”¾å…¥å¯¹åº”connectMethodå¯¹åº”çš„ chanï¼Œå¦‚æœæ”¾å…¥ä¸äº†ï¼Œåˆ™æ”¾å…¥idleConnsçš„mapä¸­ï¼Œè¿›å…¥è¿™é‡Œè¯´æ˜ï¼Œå¦ä¸€ä¸ªgoroutineæŠŠè¿æ¥æ”¾å…¥äº†chanï¼Œå¹¶è¢«å½“å‰goroutineæ•è·äº†ï¼Œé‚£ä¹ˆä¸Šé¢ </span></span><br><span class="line">    <span class="comment">// go func() &#123;</span></span><br><span class="line"><span class="comment">//     pc, err := t.dialConn(ctx, cm)</span></span><br><span class="line"><span class="comment">//     dialc &lt;- dialRes&#123;pc, err&#125;</span></span><br><span class="line"><span class="comment">// &#125;()</span></span><br><span class="line">    <span class="comment">// ç”Ÿæˆçš„è¿æ¥å°±æš‚æ—¶æ²¡ç”¨äº†ï¼Œè¿™æ—¶å€™å°±ç”¨åˆ°ä¸Šé¢ handlePendingDial å®šä¹‰çš„æ–¹æ³•ï¼Œå»å¤„ç†è¿™ä¸ªå¤šä½™çš„è¿æ¥</span></span><br><span class="line"><span class="comment">// Another request finished first and its net.Conn</span></span><br><span class="line"><span class="comment">// became available before our dial. Or somebody</span></span><br><span class="line"><span class="comment">// else's dial that they didn't use.</span></span><br><span class="line"><span class="comment">// But our dial is still going, so give it away</span></span><br><span class="line"><span class="comment">// when it finishes:</span></span><br><span class="line">handlePendingDial()</span><br><span class="line"><span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.GotConn != <span class="literal">nil</span> &#123;</span><br><span class="line">trace.GotConn(httptrace.GotConnInfo&#123;Conn: pc.conn, Reused: pc.isReused()&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pc, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> &lt;-req.Cancel:</span><br><span class="line">handlePendingDial()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errRequestCanceledConn</span><br><span class="line"><span class="keyword">case</span> &lt;-req.Context().Done():</span><br><span class="line">handlePendingDial()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, req.Context().Err()</span><br><span class="line"><span class="keyword">case</span> err := &lt;-cancelc:</span><br><span class="line">handlePendingDial()</span><br><span class="line"><span class="keyword">if</span> err == errRequestCanceled &#123;</span><br><span class="line">err = errRequestCanceledConn</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ <code>handlePendingDial</code> æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº† <code>putOrCloseIdleConn</code>ï¼Œè¿™ä¸ªæ–¹æ³•åˆ°åº•å¹²äº†ä»€ä¹ˆï¼Œè·Ÿ <code>idleConnCh</code> å’Œ <code>idleConn</code> æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</p><h4 id="Transport-putOrCloseIdleConn"><a href="#Transport-putOrCloseIdleConn" class="headerlink" title="Transport.putOrCloseIdleConn"></a>Transport.putOrCloseIdleConn</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Transport)</span> <span class="title">putOrCloseIdleConn</span><span class="params">(pconn *persistConn)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := t.tryPutIdleConn(pconn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">pconn.<span class="built_in">close</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Transport-tryPutIdleConn"><a href="#Transport-tryPutIdleConn" class="headerlink" title="Transport.tryPutIdleConn"></a>Transport.tryPutIdleConn</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Transport)</span> <span class="title">tryPutIdleConn</span><span class="params">(pconn *persistConn)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> t.DisableKeepAlives || t.MaxIdleConnsPerHost &lt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errKeepAlivesDisabled</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> pconn.isBroken() &#123;</span><br><span class="line"><span class="keyword">return</span> errConnBroken</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// http2åˆ¤æ–­</span></span><br><span class="line"><span class="keyword">if</span> pconn.alt != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errNotCachingH2Conn</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// æ ‡è®°ä¸º reused</span></span><br><span class="line">pconn.markReused()</span><br><span class="line">  <span class="comment">// cacheKeyæ˜¯ç”± connectMethodå¾—åˆ°çš„</span></span><br><span class="line">key := pconn.cacheKey</span><br><span class="line"></span><br><span class="line">t.idleMu.Lock()</span><br><span class="line"><span class="keyword">defer</span> t.idleMu.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–connectMethodå¯¹åº”çš„ idleConnCh</span></span><br><span class="line">waitingDialer := t.idleConnCh[key]</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> waitingDialer &lt;- pconn:</span><br><span class="line">    <span class="comment">// åœ¨è¿™é‡Œå°è¯•å°† è¿æ¥ æ”¾åˆ° connectMethodå¯¹åº”çš„chané‡Œé¢ï¼Œå¦‚æœæ²¡æœ‰å¦ä¸€ä¸ªgoroutineæ¥æ”¶å°±ç®—äº†</span></span><br><span class="line"><span class="comment">// We're done with this pconn and somebody else is</span></span><br><span class="line"><span class="comment">// currently waiting for a conn of this type (they're</span></span><br><span class="line"><span class="comment">// actively dialing, but this conn is ready</span></span><br><span class="line"><span class="comment">// first). Chrome calls this socket late binding. See</span></span><br><span class="line"><span class="comment">// https://insouciant.org/tech/connection-management-in-chromium/</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// æ²¡æœ‰å¦ä¸€ä¸ªgoroutineæ¥æ”¶çš„chanï¼Œä»mapä¸­åˆ é™¤ï¼Œä¾¿äºåƒåœ¾å›æ”¶</span></span><br><span class="line"><span class="keyword">if</span> waitingDialer != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// They had populated this, but their dial won</span></span><br><span class="line"><span class="comment">// first, so we can clean up this map entry.</span></span><br><span class="line"><span class="built_in">delete</span>(t.idleConnCh, key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> t.wantIdle &#123;</span><br><span class="line"><span class="keyword">return</span> errWantIdle</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> t.idleConn == <span class="literal">nil</span> &#123;</span><br><span class="line">t.idleConn = <span class="built_in">make</span>(<span class="keyword">map</span>[connectMethodKey][]*persistConn)</span><br><span class="line">&#125;</span><br><span class="line">idles := t.idleConn[key]</span><br><span class="line">  <span class="comment">// è®¾å®šäº†æ¯ä¸ª connectMethodå¯¹åº”çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°ï¼Œè¶…è¿‡å°±ä¸å†å¾€é‡Œé¢å¡«å……</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(idles) &gt;= t.maxIdleConnsPerHost() &#123;</span><br><span class="line"><span class="keyword">return</span> errTooManyIdleHost</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, exist := <span class="keyword">range</span> idles &#123;</span><br><span class="line"><span class="keyword">if</span> exist == pconn &#123;</span><br><span class="line">log.Fatalf(<span class="string">"dup idle pconn %p in freelist"</span>, pconn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åé¢å°±æ˜¯æ¸…ç†å¤šæœ‰çš„è¿æ¥ï¼ŒåŠé‡ç½®timerç­‰æ“ä½œï¼Œä¸ä¸»æµç¨‹æ— å…³ï¼Œä¸å±•å¼€åˆ†æ</span></span><br><span class="line">t.idleConn[key] = <span class="built_in">append</span>(idles, pconn)</span><br><span class="line">t.idleLRU.add(pconn)</span><br><span class="line"><span class="keyword">if</span> t.MaxIdleConns != <span class="number">0</span> &amp;&amp; t.idleLRU.<span class="built_in">len</span>() &gt; t.MaxIdleConns &#123;</span><br><span class="line">oldest := t.idleLRU.removeOldest()</span><br><span class="line">oldest.<span class="built_in">close</span>(errTooManyIdle)</span><br><span class="line">t.removeIdleConnLocked(oldest)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> t.IdleConnTimeout &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">if</span> pconn.idleTimer != <span class="literal">nil</span> &#123;</span><br><span class="line">pconn.idleTimer.Reset(t.IdleConnTimeout)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">pconn.idleTimer = time.AfterFunc(t.IdleConnTimeout, pconn.closeConnIfStillIdle)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">pconn.idleAt = time.Now()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Transport-dialConn"><a href="#Transport-dialConn" class="headerlink" title="Transport.dialConn"></a>Transport.dialConn</h4><p>è·‘åäº†ä¸€ä¼šï¼Œç°åœ¨æ¥ç€ getConnåˆ†æ dialConn è¿™ä¸ªå‡½æ•°</p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª è¿æ¥ï¼Œç„¶å åˆ›å»ºäº†ä¸¤ä¸ªgoroutineï¼Œåˆ†åˆ«å»å¾€è¿™ä¸ªè¿æ¥å†™å…¥è¯·æ±‚(<code>writeLoop</code>å‡½æ•°)å’Œè¯»å–å“åº”(<code>readLoop</code>å‡½æ•°)</p><p>è€Œè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œåˆä¼šä¸ <code>persistConn.roundTrip</code> é€šè¿‡chanè¿›è¡Œå…³è”ï¼Œè¿™é‡Œå…ˆå¯¹å‡½æ•°è¿›è¡Œåˆ†æï¼Œåˆ†æå®Œæˆåï¼Œå†ç”»å‡ºå¯¹åº”çš„å…³è”å›¾ç¤º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Transport)</span> <span class="title">dialConn</span><span class="params">(ctx context.Context, cm connectMethod)</span> <span class="params">(*persistConn, error)</span></span> &#123;</span><br><span class="line">pconn := &amp;persistConn&#123;</span><br><span class="line">t:             t,</span><br><span class="line">cacheKey:      cm.key(),</span><br><span class="line">reqch:         <span class="built_in">make</span>(<span class="keyword">chan</span> requestAndChan, <span class="number">1</span>),</span><br><span class="line">writech:       <span class="built_in">make</span>(<span class="keyword">chan</span> writeRequest, <span class="number">1</span>),</span><br><span class="line">closech:       <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">writeErrCh:    <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>),</span><br><span class="line">writeLoopDone: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">&#125;</span><br><span class="line">trace := httptrace.ContextClientTrace(ctx)</span><br><span class="line">wrapErr := <span class="function"><span class="keyword">func</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> cm.proxyURL != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Return a typed error, per Issue 16997</span></span><br><span class="line"><span class="keyword">return</span> &amp;net.OpError&#123;Op: <span class="string">"proxyconnect"</span>, Net: <span class="string">"tcp"</span>, Err: err&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// æ„å»ºä¸€ä¸ª TLSçš„è¿æ¥</span></span><br><span class="line"><span class="keyword">if</span> cm.scheme() == <span class="string">"https"</span> &amp;&amp; t.DialTLS != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">pconn.conn, err = t.DialTLS(<span class="string">"tcp"</span>, cm.addr())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, wrapErr(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> pconn.conn == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, wrapErr(errors.New(<span class="string">"net/http: Transport.DialTLS returned (nil, nil)"</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> tc, ok := pconn.conn.(*tls.Conn); ok &#123;</span><br><span class="line"><span class="comment">// Handshake here, in case DialTLS didn't. TLSNextProto below</span></span><br><span class="line"><span class="comment">// depends on it for knowing the connection state.</span></span><br><span class="line"><span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.TLSHandshakeStart != <span class="literal">nil</span> &#123;</span><br><span class="line">trace.TLSHandshakeStart()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := tc.Handshake(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">go</span> pconn.conn.Close()</span><br><span class="line"><span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.TLSHandshakeDone != <span class="literal">nil</span> &#123;</span><br><span class="line">trace.TLSHandshakeDone(tls.ConnectionState&#123;&#125;, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">cs := tc.ConnectionState()</span><br><span class="line"><span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.TLSHandshakeDone != <span class="literal">nil</span> &#123;</span><br><span class="line">trace.TLSHandshakeDone(cs, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line">pconn.tlsState = &amp;cs</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ„å»ºä¸€ä¸ªæ™®é€šçš„tcpè¿æ¥</span></span><br><span class="line">conn, err := t.dial(ctx, <span class="string">"tcp"</span>, cm.addr())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, wrapErr(err)</span><br><span class="line">&#125;</span><br><span class="line">pconn.conn = conn</span><br><span class="line"><span class="keyword">if</span> cm.scheme() == <span class="string">"https"</span> &#123;</span><br><span class="line"><span class="keyword">var</span> firstTLSHost <span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> firstTLSHost, _, err = net.SplitHostPort(cm.addr()); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, wrapErr(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err = pconn.addTLS(firstTLSHost, trace); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, wrapErr(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// proxy è®¾ç½®ã€ åè®®è½¬æ¢ç­‰ï¼Œå¿½ç•¥...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> t.MaxConnsPerHost &gt; <span class="number">0</span> &#123;</span><br><span class="line">pconn.conn = &amp;connCloseListener&#123;Conn: pconn.conn, t: t, cmKey: pconn.cacheKey&#125;</span><br><span class="line">&#125;</span><br><span class="line">pconn.br = bufio.NewReader(pconn)</span><br><span class="line">pconn.bw = bufio.NewWriter(persistConnWriter&#123;pconn&#125;)</span><br><span class="line"><span class="keyword">go</span> pconn.readLoop()</span><br><span class="line"><span class="keyword">go</span> pconn.writeLoop()</span><br><span class="line"><span class="keyword">return</span> pconn, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="persistConn-readLoop"><a href="#persistConn-readLoop" class="headerlink" title="persistConn.readLoop"></a>persistConn.readLoop</h5><p>readLoop è¿™é‡Œä»è¿æ¥ä¸­è¯»å– responseï¼Œç„¶åé€šè¿‡chanå‘é€ç»™persistConn.roundTripï¼Œæœ€åç­‰å¾…ç»“æŸ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pc *persistConn)</span> <span class="title">readLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">   closeErr := errReadLoopExiting <span class="comment">// default value, if not changed below</span></span><br><span class="line">   <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">     <span class="comment">// å…³é—­è¿™ä¸ªé“¾æ¥ï¼Œè¿™é‡Œçš„å…³é—­å‡½æ•° ç›¸å½“äº close(pc.closech)ï¼Œç„¶å writeLoop çš„ &lt;-pc.closech å°±ä¸ä¼šé˜»å¡ï¼Œè€Œæ­£å¸¸é€€å‡ºäº†ï¼Œè¿™æ ·å°±å¯ä»¥ç†è§£ï¼Œä¸ºä»€ä¹ˆreadLoopå‡½æ•°é€€å‡ºåï¼ŒwriteLoopå‡½æ•°ä¹Ÿå°±é€€å‡ºäº†</span></span><br><span class="line">      pc.<span class="built_in">close</span>(closeErr)</span><br><span class="line">      pc.t.removeIdleConn(pc)</span><br><span class="line">   &#125;()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¿™ä¸ªå‡½æ•°åŒä¸Šé¢åˆ†æçš„ Transport.tryPutIdleConn</span></span><br><span class="line">   tryPutIdleConn := <span class="function"><span class="keyword">func</span><span class="params">(trace *httptrace.ClientTrace)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">      <span class="keyword">if</span> err := pc.t.tryPutIdleConn(pc); err != <span class="literal">nil</span> &#123;</span><br><span class="line">         closeErr = err</span><br><span class="line">         <span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.PutIdleConn != <span class="literal">nil</span> &amp;&amp; err != errKeepAlivesDisabled &#123;</span><br><span class="line">            trace.PutIdleConn(err)</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> trace != <span class="literal">nil</span> &amp;&amp; trace.PutIdleConn != <span class="literal">nil</span> &#123;</span><br><span class="line">         trace.PutIdleConn(<span class="literal">nil</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// eofc is used to block caller goroutines reading from Response.Body</span></span><br><span class="line">   <span class="comment">// at EOF until this goroutines has (potentially) added the connection</span></span><br><span class="line">   <span class="comment">// back to the idle pool.</span></span><br><span class="line">   eofc := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">   <span class="keyword">defer</span> <span class="built_in">close</span>(eofc) <span class="comment">// unblock reader on errors</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// çœç•¥éƒ¨åˆ†...</span></span><br><span class="line"></span><br><span class="line">   alive := <span class="literal">true</span></span><br><span class="line">   <span class="keyword">for</span> alive &#123;</span><br><span class="line">      pc.readLimit = pc.maxHeaderResponseSize()</span><br><span class="line">      _, err := pc.br.Peek(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      pc.mu.Lock()</span><br><span class="line">      <span class="keyword">if</span> pc.numExpectedResponses == <span class="number">0</span> &#123;</span><br><span class="line">         pc.readLoopPeekFailLocked(err)</span><br><span class="line">         pc.mu.Unlock()</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      pc.mu.Unlock()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä»å½“å‰è¿æ¥ä¸­è·å–request, è¿™é‡Œæ ‡è®°ä¸º m1</span></span><br><span class="line">      rc := &lt;-pc.reqch</span><br><span class="line">      trace := httptrace.ContextClientTrace(rc.req.Context())</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> resp *Response</span><br><span class="line">      <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="comment">// ä»è¯·æ±‚ä¸­è·å–responseï¼Œå°±æ˜¯é‚£ä¹ˆç®€å•</span></span><br><span class="line">         resp, err = pc.readResponse(rc, trace)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         err = transportReadFromServerError&#123;err&#125;</span><br><span class="line">         closeErr = err</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœè¯»å–responseå¤±è´¥ï¼Œåˆ™åŒ…è£…é”™è¯¯è¿”å›ç»™ ä¸Šå±‚ï¼Œå³ persistConn.roundTrip å‡½æ•°</span></span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> pc.readLimit &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            err = fmt.Errorf(<span class="string">"net/http: server response headers exceeded %d bytes; aborted"</span>, pc.maxHeaderResponseSize())</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">select</span> &#123;</span><br><span class="line">         <span class="keyword">case</span> rc.ch &lt;- responseAndError&#123;err: err&#125;:</span><br><span class="line">         <span class="keyword">case</span> &lt;-rc.callerGone:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      pc.readLimit = maxInt64 <span class="comment">// effictively no limit for response bodies</span></span><br><span class="line"></span><br><span class="line">      pc.mu.Lock()</span><br><span class="line">      pc.numExpectedResponses--</span><br><span class="line">      pc.mu.Unlock()</span><br><span class="line"></span><br><span class="line">      hasBody := rc.req.Method != <span class="string">"HEAD"</span> &amp;&amp; resp.ContentLength != <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> resp.Close || rc.req.Close || resp.StatusCode &lt;= <span class="number">199</span> &#123;</span><br><span class="line">         <span class="comment">// Don't do keep-alive on error if either party requested a close</span></span><br><span class="line">         <span class="comment">// or we get an unexpected informational (1xx) response.</span></span><br><span class="line">         <span class="comment">// StatusCode 100 is already handled above.</span></span><br><span class="line">         alive = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bodyä¸ºç©ºçš„å¤„ç†ï¼Œå¿½ç•¥....</span></span><br><span class="line"></span><br><span class="line">      waitForBodyRead := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">2</span>)</span><br><span class="line">      body := &amp;bodyEOFSignal&#123;</span><br><span class="line">         body: resp.Body,</span><br><span class="line">         <span class="comment">// resp.Body.Close() çš„æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°ï¼Œ Close()å½±å“readLoop å’Œ writeLoop ä¸¤ä¸ªgoroutine è¿™ä¸¤ä¸ªgoroutineçš„å…³é—­ï¼Œåœ¨åé¢è®²closeçš„æ—¶å€™å…·ä½“ä»‹ç»</span></span><br><span class="line">         earlyCloseFn: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">            waitForBodyRead &lt;- <span class="literal">false</span></span><br><span class="line">            &lt;-eofc <span class="comment">// will be closed by deferred call at the end of the function</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="comment">// ä¸Šé¢å‡½æ•°å‡ºé”™åï¼Œä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å½±å“readLoop å’Œ writeLoop ä¸¤ä¸ªgoroutineçš„å½¢å¼ï¼Œä¸ä¸Šé¢çš„é€»è¾‘å¤§è‡´ç›¸åŒ</span></span><br><span class="line">         fn: <span class="function"><span class="keyword">func</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">            isEOF := err == io.EOF</span><br><span class="line">            waitForBodyRead &lt;- isEOF</span><br><span class="line">            <span class="keyword">if</span> isEOF &#123;</span><br><span class="line">               &lt;-eofc <span class="comment">// see comment above eofc declaration</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> cerr := pc.canceled(); cerr != <span class="literal">nil</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> cerr</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">         &#125;,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç»„è£…resp</span></span><br><span class="line">      resp.Body = body</span><br><span class="line">      <span class="keyword">if</span> rc.addedGzip &amp;&amp; strings.EqualFold(resp.Header.Get(<span class="string">"Content-Encoding"</span>), <span class="string">"gzip"</span>) &#123;</span><br><span class="line">         resp.Body = &amp;gzipReader&#123;body: body&#125;</span><br><span class="line">         resp.Header.Del(<span class="string">"Content-Encoding"</span>)</span><br><span class="line">         resp.Header.Del(<span class="string">"Content-Length"</span>)</span><br><span class="line">         resp.ContentLength = <span class="number">-1</span></span><br><span class="line">         resp.Uncompressed = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å°†respé€šè¿‡chanè¿”å›ç»™ persistConn.roundTrip å‡½æ•°</span></span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> rc.ch &lt;- responseAndError&#123;res: resp&#125;:</span><br><span class="line">      <span class="keyword">case</span> &lt;-rc.callerGone:</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Before looping back to the top of this function and peeking on</span></span><br><span class="line">      <span class="comment">// the bufio.Reader, wait for the caller goroutine to finish</span></span><br><span class="line">      <span class="comment">// reading the response body. (or for cancelation or death)</span></span><br><span class="line">      <span class="comment">// é˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾… è¯·æ±‚ body close æˆ– è¯·æ±‚cancel æˆ– context done æˆ– pc.closech</span></span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> bodyEOF := &lt;-waitForBodyRead:</span><br><span class="line">         pc.t.setReqCanceler(rc.req, <span class="literal">nil</span>) <span class="comment">// before pc might return to idle pool</span></span><br><span class="line">         alive = alive &amp;&amp;</span><br><span class="line">            bodyEOF &amp;&amp;</span><br><span class="line">            !pc.sawEOF &amp;&amp;</span><br><span class="line">            pc.wroteRequest() &amp;&amp;</span><br><span class="line">            tryPutIdleConn(trace)</span><br><span class="line">         <span class="keyword">if</span> bodyEOF &#123;</span><br><span class="line">            eofc &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">         &#125;</span><br><span class="line">      <span class="keyword">case</span> &lt;-rc.req.Cancel:</span><br><span class="line">         alive = <span class="literal">false</span></span><br><span class="line">         pc.t.CancelRequest(rc.req)</span><br><span class="line">      <span class="keyword">case</span> &lt;-rc.req.Context().Done():</span><br><span class="line">         alive = <span class="literal">false</span></span><br><span class="line">         pc.t.cancelRequest(rc.req, rc.req.Context().Err())</span><br><span class="line">      <span class="keyword">case</span> &lt;-pc.closech:</span><br><span class="line">         alive = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      testHookReadLoopBeforeNextRead()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="persistConn-writeLoop"><a href="#persistConn-writeLoop" class="headerlink" title="persistConn.writeLoop"></a>persistConn.writeLoop</h5><p>ç›¸å¯¹äº<code>persistConn.readLoop</code>ï¼Œ è¿™ä¸ªå‡½æ•°å°±ç®€å•å¾ˆå¤šï¼Œå…¶ä¸»è¦åŠŸèƒ½ä¹Ÿå°±æ˜¯å¾€è¿æ¥é‡Œé¢å†™requestè¯·æ±‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pc *persistConn)</span> <span class="title">writeLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">defer</span> <span class="built_in">close</span>(pc.writeLoopDone)</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="comment">// é¦–å…ˆé€šè¿‡pc.writech chan ä» persistConn.roundTrip å‡½æ•°ä¸­è·å– writeRequest, å¯ä»¥ç®€å•ç†è§£ä¸º request</span></span><br><span class="line">      <span class="keyword">case</span> wr := &lt;-pc.writech:</span><br><span class="line">         startBytesWritten := pc.nwrite</span><br><span class="line">         err := wr.req.Request.write(pc.bw, pc.isProxy, wr.req.extra, pc.waitForContinue(wr.continueCh))</span><br><span class="line">         <span class="keyword">if</span> bre, ok := err.(requestBodyReadError); ok &#123;</span><br><span class="line">            err = bre.error</span><br><span class="line">            <span class="comment">// Errors reading from the user's</span></span><br><span class="line">            <span class="comment">// Request.Body are high priority.</span></span><br><span class="line">            <span class="comment">// Set it here before sending on the</span></span><br><span class="line">            <span class="comment">// channels below or calling</span></span><br><span class="line">            <span class="comment">// pc.close() which tears town</span></span><br><span class="line">            <span class="comment">// connections and causes other</span></span><br><span class="line">            <span class="comment">// errors.</span></span><br><span class="line">            wr.req.setError(err)</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">            err = pc.bw.Flush()</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            wr.req.Request.closeBody()</span><br><span class="line">            <span class="keyword">if</span> pc.nwrite == startBytesWritten &#123;</span><br><span class="line">               err = nothingWrittenError&#123;err&#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// æŠŠ err é€šè¿‡ chan è¿”å›ç»™ persistConn.roundTrip å‡½æ•°ï¼ŒpersistConn.roundTrip å‡½æ•°åˆ¤æ–­ erræ˜¯å¦ä¸º nilåŠç›¸åº”çš„å¤„ç†</span></span><br><span class="line">         pc.writeErrCh &lt;- err <span class="comment">// to the body reader, which might recycle us</span></span><br><span class="line">         wr.ch &lt;- err         <span class="comment">// to the roundTrip function</span></span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœ å†™å…¥è¯·æ±‚å‡ºç°é”™è¯¯ï¼Œè¿™é‡Œå…³é—­ï¼Œpc.closech chanï¼ŒreadLoopçš„ç¬¬151è¡Œå°±ä¼šåœæ­¢é˜»å¡ï¼Œå°†aliveè®¾ä¸ºfalseï¼Œè¿›è€Œç»“æŸå¾ªç¯ï¼Œç»ˆæ­¢ readLoopçš„goroutine</span></span><br><span class="line">            pc.<span class="built_in">close</span>(err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">      <span class="keyword">case</span> &lt;-pc.closech:</span><br><span class="line">         <span class="comment">// è¿™é‡Œç»“æŸé˜»å¡ï¼Œæ˜¯ç”± readLoop ç»“æŸæ˜¯ï¼Œè°ƒç”¨ ç¬¬3è¡Œçš„ deferå‡½æ•°ï¼Œå…³é—­ pc.closech chan å¯¼è‡´çš„</span></span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="persistConn-roundTrip"><a href="#persistConn-roundTrip" class="headerlink" title="persistConn.roundTrip"></a>persistConn.roundTrip</h3><p>æ— è®ºæ˜¯ <code>persistConn.readLoop</code> è¿˜æ˜¯ <code>persistConn.writeLoop</code> éƒ½é¿å…ä¸äº†å’Œè¿™ä¸ªå‡½æ•°äº¤äº’ï¼Œè¿™ä¸ªå‡½æ•°çš„é‡è¦æ€§ä¹Ÿå°±ä¸è¨€è€Œå–»äº†</p><p>ä½†æ˜¯ è¿™ä¸ªå‡½æ•°çš„ä¸»è¦é€»è¾‘å°±æ˜¯ åˆ›å»ºä¸ªè¿æ¥çš„ writeRequest chanï¼Œ ä¹Ÿå°±æ˜¯ writeLoop ç”¨åˆ°çš„chanï¼Œç„¶åæŠŠrequest é€šè¿‡è¿™ä¸ª chan ä¼ ç»™  <code>persistConn.writeLoop</code> ï¼Œç„¶å åœ¨åˆ›å»ºä¸€ä¸ª responseAndError chanï¼Œä¹Ÿå°±æ˜¯ readLoop ç”¨åˆ°çš„chanï¼Œä» è¿™ä¸ªchanä¸­è·å–  <code>persistConn.readLoop</code>  è·å–åˆ°çš„ responseï¼Œæœ€åæŠŠ responseè¿”å›ç»™ä¸Šå±‚å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pc *persistConn)</span> <span class="title">roundTrip</span><span class="params">(req *transportRequest)</span> <span class="params">(resp *Response, err error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½® requestçš„å¤´ä¿¡æ¯ï¼Œcancelå‡½æ•°ï¼Œçœç•¥....</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> continueCh <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> req.ProtoAtLeast(<span class="number">1</span>, <span class="number">1</span>) &amp;&amp; req.Body != <span class="literal">nil</span> &amp;&amp; req.expectsContinue() &#123;</span><br><span class="line">continueCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(gone)</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">pc.t.setReqCanceler(req.Request, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> debugRoundTrip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Write the request concurrently with waiting for a response,</span></span><br><span class="line"><span class="comment">// in case the server decides to reply before reading our full</span></span><br><span class="line"><span class="comment">// request body.</span></span><br><span class="line">startBytesWritten := pc.nwrite</span><br><span class="line">writeErrCh := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</span><br><span class="line">  <span class="comment">// æŠŠ request æ”¾å…¥ writech chan é‡Œé¢ï¼Œè¿™æ ·ï¼Œ `persistConn.writeLoop` çš„ç¬¬6è¡Œå°±å¯ä»¥æ‹¿åˆ° requestï¼Œå¾€ è¿æ¥ é‡Œé¢å†™å…¥è¯·æ±‚ä¿¡æ¯äº†</span></span><br><span class="line">pc.writech &lt;- writeRequest&#123;req, writeErrCh, continueCh&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å®šä¹‰responseAndError chanï¼Œå¹¶æ”¾å…¥ reqch chan é‡Œé¢ï¼Œè¿™æ ·  `persistConn.readLoop` çš„ç¬¬46è¡Œï¼Œä¹Ÿå°±æ˜¯ m1æ ‡è®°çš„åœ°æ–¹ï¼Œå°±å¯ä»¥è§£é™¤é˜»å¡ï¼Œå¼€å§‹è·å– responseçš„é€»è¾‘äº†</span></span><br><span class="line">resc := <span class="built_in">make</span>(<span class="keyword">chan</span> responseAndError)</span><br><span class="line">pc.reqch &lt;- requestAndChan&#123;</span><br><span class="line">req:        req.Request,</span><br><span class="line">ch:         resc,</span><br><span class="line">addedGzip:  requestedGzip,</span><br><span class="line">continueCh: continueCh,</span><br><span class="line">callerGone: gone,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> respHeaderTimer &lt;-<span class="keyword">chan</span> time.Time</span><br><span class="line">cancelChan := req.Request.Cancel</span><br><span class="line">ctxDoneChan := req.Context().Done()</span><br><span class="line">  <span class="comment">// é˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ° è·å– writeLoop è¿”å›çš„å†™å…¥é”™è¯¯æˆ– pc.closechçš„å…³é—­ä¿¡æ¯ï¼Œè¿æ¥è¶…æ—¶çš„ä¿¡æ¯æˆ– readLoopçš„ respæˆ–cancelæˆ–ctx doneçš„ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">testHookWaitResLoop()</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œè·å–åˆ° writeLoopçš„å†™å…¥ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯errï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯ï¼Œä¸‹é¢åšå¯¹åº”çš„å¤„ç†</span></span><br><span class="line"><span class="keyword">case</span> err := &lt;-writeErrCh:</span><br><span class="line"><span class="keyword">if</span> debugRoundTrip &#123;</span><br><span class="line">req.logf(<span class="string">"writeErrCh resv: %T/%#v"</span>, err, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">pc.<span class="built_in">close</span>(fmt.Errorf(<span class="string">"write error: %v"</span>, err))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, pc.mapRoundTripError(req, startBytesWritten, err)</span><br><span class="line">&#125;</span><br><span class="line">      <span class="comment">// å†™å…¥requestæ²¡æœ‰é—®é¢˜ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è¶…æ—¶</span></span><br><span class="line"><span class="keyword">if</span> d := pc.t.ResponseHeaderTimeout; d &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">if</span> debugRoundTrip &#123;</span><br><span class="line">req.logf(<span class="string">"starting timer for %v"</span>, d)</span><br><span class="line">&#125;</span><br><span class="line">timer := time.NewTimer(d)</span><br><span class="line"><span class="keyword">defer</span> timer.Stop() <span class="comment">// prevent leaks</span></span><br><span class="line">respHeaderTimer = timer.C</span><br><span class="line">&#125;</span><br><span class="line">      <span class="comment">// åˆ°æ­¤è·å–åˆ°äº† writeLoopçš„ä¿¡æ¯ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰returnï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯</span></span><br><span class="line"><span class="keyword">case</span> &lt;-pc.closech:</span><br><span class="line">      <span class="comment">// closechçš„å…³é—­ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">if</span> debugRoundTrip &#123;</span><br><span class="line">req.logf(<span class="string">"closech recv: %T %#v"</span>, pc.closed, pc.closed)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, pc.mapRoundTripError(req, startBytesWritten, pc.closed)</span><br><span class="line"><span class="keyword">case</span> &lt;-respHeaderTimer:</span><br><span class="line">      <span class="comment">// ç­‰å¾…è¶…æ—¶çš„ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">if</span> debugRoundTrip &#123;</span><br><span class="line">req.logf(<span class="string">"timeout waiting for response headers."</span>)</span><br><span class="line">&#125;</span><br><span class="line">pc.<span class="built_in">close</span>(errTimeout)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errTimeout</span><br><span class="line"><span class="keyword">case</span> re := &lt;-resc:</span><br><span class="line">      <span class="comment">// ä» readLoopè·å–åˆ° response</span></span><br><span class="line"><span class="keyword">if</span> (re.res == <span class="literal">nil</span>) == (re.err == <span class="literal">nil</span>) &#123;</span><br><span class="line"><span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"internal error: exactly one of res or err should be set; nil=%v"</span>, re.res == <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> debugRoundTrip &#123;</span><br><span class="line">req.logf(<span class="string">"resc recv: %p, %T/%#v"</span>, re.res, re.err, re.err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> re.err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, pc.mapRoundTripError(req, startBytesWritten, re.err)</span><br><span class="line">&#125;</span><br><span class="line">      <span class="comment">// è¿”å› responseï¼Œè¿™é‡Œç»“æŸå¾ªç¯</span></span><br><span class="line"><span class="keyword">return</span> re.res, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> &lt;-cancelChan:</span><br><span class="line">pc.t.CancelRequest(req.Request)</span><br><span class="line">cancelChan = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> &lt;-ctxDoneChan:</span><br><span class="line">pc.t.cancelRequest(req.Request, req.Context().Err())</span><br><span class="line">cancelChan = <span class="literal">nil</span></span><br><span class="line">ctxDoneChan = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº¤äº’å›¾ç¤º"><a href="#äº¤äº’å›¾ç¤º" class="headerlink" title="äº¤äº’å›¾ç¤º"></a>äº¤äº’å›¾ç¤º</h2><p>ä¸Šé¢ <code>persistConn.roundTrip</code> <code>persistConn.readLoop</code> <code>persistConn.writeLoop</code> ä¹‹é—´çš„æ•°æ®äº¤äº’ï¼Œå¯èƒ½é è¯­è¨€æ¯”è¾ƒè‹ç™½ï¼Œè¿™é‡Œç”»ä¸€ä¸‹å›¾ç¤º</p><p><img src="http://note-1253518569.cossh.myqcloud.com/20190717221524.png" alt></p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ç»¼ä¸Šåˆ†æï¼Œå¯ä»¥å‘ç°ï¼ŒreadLoopå’Œ writeLoop ä¸¤ä¸ªgoroutineåœ¨ å†™å…¥è¯·æ±‚å¹¶è·å–responseè¿”å›åï¼Œå¹¶æ²¡æœ‰è·³å‡ºforå¾ªç¯ï¼Œè€Œç»§ç»­é˜»å¡åœ¨ ä¸‹ä¸€æ¬¡forå¾ªç¯çš„select è¯­å¥é‡Œé¢ï¼Œæ‰€ä»¥ï¼Œä¸¤ä¸ªå‡½æ•°æ‰€åœ¨çš„goroutineå¹¶æ²¡æœ‰è¿è¡Œç»“æŸï¼Œå¯¼è‡´äº†æœ€å¼€çš„ç°è±¡: goroutineæŒç»­å¢åŠ å¯¼è‡´å†…å­˜æŒç»­å¢åŠ </p><h1 id="Closeæµç¨‹"><a href="#Closeæµç¨‹" class="headerlink" title="Closeæµç¨‹"></a>Closeæµç¨‹</h1><h2 id="close"><a href="#close" class="headerlink" title="close"></a>close</h2><p>closeçš„ä¸»è¦é€»è¾‘æ˜¯é€šè¿‡è°ƒç”¨ <code>readLoop</code> çš„ç¬¬89è¡Œå®šä¹‰çš„earlyCloseFn æ–¹æ³•ï¼Œ å‘ waitForBodyRead çš„chanå†™å…¥falseï¼Œè¿›è€Œè®© <code>readLoop</code> é€€å‡ºé˜»å¡ï¼Œç»ˆæ­¢ <code>readLoop</code> çš„ goroutine</p><p> <code>readLoop</code>  é€€å‡ºçš„æ—¶å€™ï¼Œå…³é—­ closech chanï¼Œè¿›è€Œè®© <code>writeLoop</code> é€€å‡ºé˜»å¡ï¼Œç»ˆæ­¢ <code>writeLoop</code> çš„goroutine</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(es *bodyEOFSignal)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">es.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> es.mu.Unlock()</span><br><span class="line"><span class="keyword">if</span> es.closed &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">es.closed = <span class="literal">true</span></span><br><span class="line"><span class="keyword">if</span> es.earlyCloseFn != <span class="literal">nil</span> &amp;&amp; es.rerr != io.EOF &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ readLoopå®šä¹‰çš„å‡½æ•°å¤„ç†</span></span><br><span class="line"><span class="keyword">return</span> es.earlyCloseFn()</span><br><span class="line">&#125;</span><br><span class="line">err := es.body.Close()</span><br><span class="line"><span class="keyword">return</span> es.condfn(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>##earlyCloseFn</p><p>å®šä¹‰çš„ earlyCloseFn æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">body := &amp;bodyEOFSignal&#123;</span><br><span class="line">   body: resp.Body,</span><br><span class="line">   earlyCloseFn: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">     <span class="comment">// å‘ waiForBody çš„chan ä¸­å†™å…¥ false</span></span><br><span class="line">      waitForBodyRead &lt;- <span class="literal">false</span></span><br><span class="line">      &lt;-eofc <span class="comment">// will be closed by deferred call at the end of the function</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">   &#125;,</span><br><span class="line">   fn: <span class="function"><span class="keyword">func</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">      isEOF := err == io.EOF</span><br><span class="line">      waitForBodyRead &lt;- isEOF</span><br><span class="line">      <span class="keyword">if</span> isEOF &#123;</span><br><span class="line">         &lt;-eofc <span class="comment">// see comment above eofc declaration</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> cerr := pc.canceled(); cerr != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> cerr</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">   &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»“æŸreadLoop"><a href="#ç»“æŸreadLoop" class="headerlink" title="ç»“æŸreadLoop"></a>ç»“æŸreadLoop</h2><p>å›è¿‡å¤´æ¥çœ‹ <code>readLoop</code> é˜»å¡çš„ä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> bodyEOF := &lt;-waitForBodyRead:</span><br><span class="line">  <span class="comment">// è¿™é‡Œçš„ waitForBodyRead æ¥æ”¶åˆ° earlyCloseFn ä¼ é€’è¿‡æ¥çš„ falseï¼Œå¹¶èµ‹å€¼ç»™ bodyEOF</span></span><br><span class="line">pc.t.setReqCanceler(rc.req, <span class="literal">nil</span>) <span class="comment">// before pc might return to idle pool</span></span><br><span class="line">  <span class="comment">// bodyEOF ä¸º falseï¼Œæ•´ä¸ªè¡¨è¾¾å¼çš„ å€¼ä¸º falseï¼Œä»è€Œé€€å‡ºæ•´ä¸ªforå¾ªç¯ï¼Œç»“æŸ å½“å‰goroutine</span></span><br><span class="line">alive = alive &amp;&amp;</span><br><span class="line">bodyEOF &amp;&amp;</span><br><span class="line">!pc.sawEOF &amp;&amp;</span><br><span class="line">pc.wroteRequest() &amp;&amp;</span><br><span class="line">tryPutIdleConn(trace)</span><br><span class="line"><span class="keyword">if</span> bodyEOF &#123;</span><br><span class="line">eofc &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> &lt;-rc.req.Cancel:</span><br><span class="line">alive = <span class="literal">false</span></span><br><span class="line">pc.t.CancelRequest(rc.req)</span><br><span class="line"><span class="keyword">case</span> &lt;-rc.req.Context().Done():</span><br><span class="line">alive = <span class="literal">false</span></span><br><span class="line">pc.t.cancelRequest(rc.req, rc.req.Context().Err())</span><br><span class="line"><span class="keyword">case</span> &lt;-pc.closech:</span><br><span class="line">alive = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ <code>readLoop</code> é€€å‡ºçš„æ—¶å€™ï¼Œè°ƒç”¨å‡½æ•°æœ€å¼€å§‹å®šä¹‰çš„ defer å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// è¿™é‡Œçš„ close æŠŠ pc.closech chan å…³é—­ ï¼ˆæœ‰å…´è¶£çš„å¯ä»¥è¿½ä¸€ä¸‹ï¼Œä¸éš¾ï¼‰ï¼Œè¿›è€Œå½±å“ writeLoop çš„é˜»å¡</span></span><br><span class="line">pc.<span class="built_in">close</span>(closeErr)</span><br><span class="line">pc.t.removeIdleConn(pc)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><h2 id="ç»“æŸwriteLoop"><a href="#ç»“æŸwriteLoop" class="headerlink" title="ç»“æŸwriteLoop"></a>ç»“æŸwriteLoop</h2><p>ç»§ç»­çœ‹ä¸€ä¸‹ <code>writeLoop</code> é˜»å¡çš„ä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> wr := &lt;-pc.writech:</span><br><span class="line">startBytesWritten := pc.nwrite</span><br><span class="line">err := wr.req.Request.write(pc.bw, pc.isProxy, wr.req.extra, pc.waitForContinue(wr.continueCh))</span><br><span class="line"><span class="keyword">if</span> bre, ok := err.(requestBodyReadError); ok &#123;</span><br><span class="line">err = bre.error</span><br><span class="line"><span class="comment">// Errors reading from the user's</span></span><br><span class="line"><span class="comment">// Request.Body are high priority.</span></span><br><span class="line"><span class="comment">// Set it here before sending on the</span></span><br><span class="line"><span class="comment">// channels below or calling</span></span><br><span class="line"><span class="comment">// pc.close() which tears town</span></span><br><span class="line"><span class="comment">// connections and causes other</span></span><br><span class="line"><span class="comment">// errors.</span></span><br><span class="line">wr.req.setError(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">err = pc.bw.Flush()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">wr.req.Request.closeBody()</span><br><span class="line"><span class="keyword">if</span> pc.nwrite == startBytesWritten &#123;</span><br><span class="line">err = nothingWrittenError&#123;err&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">pc.writeErrCh &lt;- err <span class="comment">// to the body reader, which might recycle us</span></span><br><span class="line">wr.ch &lt;- err         <span class="comment">// to the roundTrip function</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">pc.<span class="built_in">close</span>(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// åœ¨ ä¸Šé¢ readLoop å…³é—­ pc.closech chan åï¼Œè¿™é‡Œå°±ç›´æ¥returnäº†ï¼Œå¾ªç¯ç»ˆæ­¢ï¼Œç»“æŸå½“å‰goroutine</span></span><br><span class="line"><span class="keyword">case</span> &lt;-pc.closech:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£Go-å†…å­˜åˆ†é…</title>
      <link href="/posts/19281/"/>
      <url>/posts/19281/</url>
      
        <content type="html"><![CDATA[<p>Goè¯­è¨€å†…ç½®è¿è¡Œæ—¶ï¼ˆå°±æ˜¯runtimeï¼‰ï¼ŒæŠ›å¼ƒäº†ä¼ ç»Ÿçš„å†…å­˜åˆ†é…æ–¹å¼ï¼Œæ”¹ä¸ºè‡ªä¸»ç®¡ç†ï¼Œæœ€å¼€å§‹æ˜¯åŸºäºtcmallocï¼Œè™½ç„¶åé¢æ”¹åŠ¨ç›¸å¯¹å·²ç»å¾ˆå¤§äº†ã€‚ä½¿ç”¨è‡ªä¸»ç®¡ç†å¯ä»¥å®ç°æ›´å¥½çš„å†…å­˜ä½¿ç”¨æ¨¡å¼ï¼Œæ¯”å¦‚å†…å­˜æ± ã€é¢„åˆ†é…ç­‰ç­‰ï¼Œä»è€Œé¿å…äº†ç³»ç»Ÿè°ƒç”¨æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚</p><a id="more"></a><p>åœ¨äº†è§£Goçš„å†…å­˜åˆ†é…ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å†…å­˜åˆ†é…çš„åŸºæœ¬ç­–ç•¥ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬ç†è§£Goçš„å†…å­˜åˆ†é…</p><p>åŸºæœ¬ç­–ç•¥ï¼š</p><ol><li>æ¯æ¬¡ä»æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å¤§å—å†…å­˜ï¼Œä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨</li><li>å°†ç”³è¯·çš„å¤§å—å†…å­˜æŒ‰ç…§ç‰¹å®šå¤§å°é¢„å…ˆåˆ‡æˆå°å—ï¼Œæ„æˆé“¾è¡¨</li><li>ä¸ºå¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œä»å¤§å°åˆé€‚çš„é“¾è¡¨ä¸­æå–ä¸€å—å³å¯</li><li>å¦‚æœå¯¹è±¡é”€æ¯ï¼Œåˆ™å°†å¯¹è±¡å ç”¨çš„å†…å­˜ï¼Œå½’è¿˜åˆ°åŸé“¾è¡¨ï¼Œä»¥ä¾¿å¤ç”¨</li><li>å¦‚æœé™åˆ¶å†…å­˜è¿‡å¤šï¼Œåˆ™å°è¯•å½’è¿˜éƒ¨åˆ†ç»™æ“ä½œç³»ç»Ÿï¼Œé™ä½æ•´ä½“å¼€é”€</li></ol><p>ä¸‹é¢æˆ‘ä»¬ä»æºç è§’åº¦æ¥åˆ†æGoçš„å†…å­˜åˆ†é…ç­–ç•¥æœ‰ä½•å¼‚åŒ</p><h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><p>åœ¨è¿½è¸ªæºç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆäº†è§£ä¸€äº›æ¦‚å¿µå’Œç»“æ„ä½“</p><ul><li>span: åˆå¤šä¸ªåœ°å€è¿ç»­çš„é¡µï¼ˆpageï¼‰ç»„æˆçš„å¤§å—å†…å­˜</li><li>object: å°†spanæŒ‰ç‰¹å®šå¤§å°åˆ‡åˆ†æˆå¤šä¸ªå°å—ï¼Œæ¯ä¸ªå°å—å¯å­˜å‚¨ä¸€ä¸ªå¯¹è±¡</li></ul><h2 id="å¯¹è±¡åˆ†ç±»"><a href="#å¯¹è±¡åˆ†ç±»" class="headerlink" title="å¯¹è±¡åˆ†ç±»"></a>å¯¹è±¡åˆ†ç±»</h2><ul><li>å°å¯¹è±¡ï¼ˆtinyï¼‰: size &lt; 16byte</li><li>æ™®é€šå¯¹è±¡ï¼š 16byte ~ 32K</li><li>å¤§å¯¹è±¡ï¼ˆlargeï¼‰ï¼š size &gt; 32K</li></ul><h2 id="å¤§å°è½¬æ¢"><a href="#å¤§å°è½¬æ¢" class="headerlink" title="å¤§å°è½¬æ¢"></a>å¤§å°è½¬æ¢</h2><p><img src="http://note-1253518569.cossh.myqcloud.com/20190715112737.png" alt></p><h2 id="ç»“æ„ä½“"><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h2><h3 id="mHeap"><a href="#mHeap" class="headerlink" title="mHeap"></a>mHeap</h3><p>ä»£è¡¨Goç¨‹åºæŒæœ‰çš„æ‰€æœ‰å †ç©ºé—´ï¼ŒGoç¨‹åºä½¿ç”¨ä¸€ä¸ª<code>mheap</code>çš„å…¨å±€å¯¹è±¡<code>_mheap</code>æ¥ç®¡ç†å †å†…å­˜ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mheap <span class="keyword">struct</span> &#123;</span><br><span class="line">lock      mutex</span><br><span class="line">free      [_MaxMHeapList]mSpanList <span class="comment">// pageåœ¨127ä»¥å†…çš„é—²ç½®çš„spanåˆ—è¡¨</span></span><br><span class="line">freelarge mTreap                   <span class="comment">// pageæ•°å¤§äº127çš„å¤§spanç»„æˆçš„æ ‘çŠ¶ç»“æ„ä½“</span></span><br><span class="line">busy      [_MaxMHeapList]mSpanList <span class="comment">// pageåœ¨127ä»¥å†…çš„å·²åˆ†é…çš„spanåˆ—è¡¨</span></span><br><span class="line">busylarge mSpanList                <span class="comment">// pageæ•°å¤§äº127çš„å·²åˆ†é…çš„å¤§spanç»„æˆçš„åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// allspans is a slice of all mspans ever created. Each mspan</span></span><br><span class="line"><span class="comment">// appears exactly once.</span></span><br><span class="line"><span class="comment">// æ‰€æœ‰åˆ›å»ºè¿‡çš„mspançš„slice</span></span><br><span class="line">allspans []*mspan <span class="comment">// all spans out there</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// arenas is the heap arena map. It points to the metadata for</span></span><br><span class="line"><span class="comment">// the heap for every arena frame of the entire usable virtual</span></span><br><span class="line"><span class="comment">// address space.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Use arenaIndex to compute indexes into this array.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For regions of the address space that are not backed by the</span></span><br><span class="line"><span class="comment">// Go heap, the arena map contains nil.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Modifications are protected by mheap_.lock. Reads can be</span></span><br><span class="line"><span class="comment">// performed without locking; however, a given entry can</span></span><br><span class="line"><span class="comment">// transition from nil to non-nil at any time when the lock</span></span><br><span class="line"><span class="comment">// isn't held. (Entries never transitions back to nil.)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In general, this is a two-level mapping consisting of an L1</span></span><br><span class="line"><span class="comment">// map and possibly many L2 maps. This saves space when there</span></span><br><span class="line"><span class="comment">// are a huge number of arena frames. However, on many</span></span><br><span class="line"><span class="comment">// platforms (even 64-bit), arenaL1Bits is 0, making this</span></span><br><span class="line"><span class="comment">// effectively a single-level map. In this case, arenas[0]</span></span><br><span class="line"><span class="comment">// will never be nil.</span></span><br><span class="line"><span class="comment">// ä¸€ç»„heapArenaç»„æˆï¼Œæ¯ä¸€ä¸ªheapArenaéƒ½åŒ…å«äº†è¿ç»­çš„pagesPerArenaä¸ªspanï¼Œè¿™ä¸ªä¸»è¦æ˜¯ä¸ºmheapç®¡ç†spanå’Œåƒåœ¾å›æ”¶æœåŠ¡ï¼ŒheapArenaä¹Ÿæœ‰ä»‹ç»</span></span><br><span class="line">arenas [<span class="number">1</span> &lt;&lt; arenaL1Bits]*[<span class="number">1</span> &lt;&lt; arenaL2Bits]*heapArena</span><br><span class="line"></span><br><span class="line"><span class="comment">// heapArenaAlloc is pre-reserved space for allocating heapArena</span></span><br><span class="line"><span class="comment">// objects. This is only used on 32-bit, where we pre-reserve</span></span><br><span class="line"><span class="comment">// this space to avoid interleaving it with the heap itself.</span></span><br><span class="line"><span class="comment">// é¢„å…ˆåˆ†é…çš„ heapArena å¯¹è±¡çš„åœ°å€</span></span><br><span class="line">heapArenaAlloc linearAlloc</span><br><span class="line"></span><br><span class="line"><span class="comment">// arenaHints is a list of addresses at which to attempt to</span></span><br><span class="line"><span class="comment">// add more heap arenas. This is initially populated with a</span></span><br><span class="line"><span class="comment">// set of general hint addresses, and grown with the bounds of</span></span><br><span class="line"><span class="comment">// actual heap arena ranges.</span></span><br><span class="line">arenaHints *arenaHint</span><br><span class="line"></span><br><span class="line"><span class="comment">// arena is a pre-reserved space for allocating heap arenas</span></span><br><span class="line"><span class="comment">// (the actual arenas). This is only used on 32-bit.</span></span><br><span class="line"><span class="comment">// ä»…32ä½ä½¿ç”¨</span></span><br><span class="line">arena linearAlloc</span><br><span class="line"></span><br><span class="line"><span class="comment">//_ uint32 // ensure 64-bit alignment of central</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// central free lists for small size classes.</span></span><br><span class="line"><span class="comment">// the padding makes sure that the MCentrals are</span></span><br><span class="line"><span class="comment">// spaced CacheLineSize bytes apart, so that each MCentral.lock</span></span><br><span class="line"><span class="comment">// gets its own cache line.</span></span><br><span class="line"><span class="comment">// central is indexed by spanClass.</span></span><br><span class="line"><span class="comment">// mcentral å†…å­˜åˆ†é…ä¸­å¿ƒï¼Œmcacheæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œä¼šä»mcentralåˆ†é…</span></span><br><span class="line">central [numSpanClasses]<span class="keyword">struct</span> &#123;</span><br><span class="line">mcentral mcentral</span><br><span class="line">pad      [sys.CacheLineSize - unsafe.Sizeof(mcentral&#123;&#125;)%sys.CacheLineSize]<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spanalloc             fixalloc <span class="comment">// allocator for span*</span></span><br><span class="line">cachealloc            fixalloc <span class="comment">// allocator for mcache*</span></span><br><span class="line">treapalloc            fixalloc <span class="comment">// allocator for treapNodes* used by large objects</span></span><br><span class="line">specialfinalizeralloc fixalloc <span class="comment">// allocator for specialfinalizer*</span></span><br><span class="line">specialprofilealloc   fixalloc <span class="comment">// allocator for specialprofile*</span></span><br><span class="line">speciallock           mutex    <span class="comment">// lock for special record allocators.</span></span><br><span class="line">arenaHintAlloc        fixalloc <span class="comment">// allocator for arenaHints</span></span><br><span class="line"></span><br><span class="line">unused *specialfinalizer <span class="comment">// never set, just here to force the specialfinalizer type into DWARF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mSpanList"><a href="#mSpanList" class="headerlink" title="mSpanList"></a>mSpanList</h3><p>mSpançš„é“¾è¡¨ï¼Œ<code>free</code> <code>busy</code> <code>busyLarge</code> ä¸Šçš„mSpanéƒ½æ˜¯é€šè¿‡é“¾è¡¨ä¸²è”èµ·æ¥çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type mSpanList struct &#123;</span><br><span class="line">first *mspan // first span in list, or nil if none</span><br><span class="line">last  *mspan // last span in list, or nil if none</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mSpan"><a href="#mSpan" class="headerlink" title="mSpan"></a>mSpan</h3><p>Goä¸­å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒï¼Œæ˜¯ç”±ä¸€ç‰‡è¿ç»­çš„<code>8KB</code>çš„é¡µç»„æˆçš„å¤§å—å†…å­˜ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„é¡µå’Œæ“ä½œç³»ç»Ÿæœ¬èº«çš„é¡µå¹¶ä¸æ˜¯ä¸€å›äº‹ï¼Œå®ƒä¸€èˆ¬æ˜¯æ“ä½œç³»ç»Ÿé¡µå¤§å°çš„å‡ å€ã€‚ä¸€å¥è¯æ¦‚æ‹¬ï¼š<code>mspan</code>æ˜¯ä¸€ä¸ªåŒ…å«èµ·å§‹åœ°å€ã€<code>mspan</code>è§„æ ¼ã€é¡µçš„æ•°é‡ç­‰å†…å®¹çš„åŒç«¯é“¾è¡¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mspan <span class="keyword">struct</span> &#123;</span><br><span class="line">next *mspan     <span class="comment">// next span in list, or nil if none</span></span><br><span class="line">prev *mspan     <span class="comment">// previous span in list, or nil if none</span></span><br><span class="line">list *mSpanList <span class="comment">// For debugging. <span class="doctag">TODO:</span> Remove.</span></span><br><span class="line"></span><br><span class="line">startAddr <span class="keyword">uintptr</span> <span class="comment">// address of first byte of span aka s.base()</span></span><br><span class="line"><span class="comment">// è¯¥spané”åŒ…å«çš„é¡µæ•°</span></span><br><span class="line">npages    <span class="keyword">uintptr</span> <span class="comment">// number of pages in span</span></span><br><span class="line"></span><br><span class="line">manualFreeList gclinkptr <span class="comment">// list of free objects in _MSpanManual spans</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// freeindex is the slot index between 0 and nelems at which to begin scanning</span></span><br><span class="line"><span class="comment">// for the next free object in this span.</span></span><br><span class="line"><span class="comment">// Each allocation scans allocBits starting at freeindex until it encounters a 0</span></span><br><span class="line"><span class="comment">// indicating a free object. freeindex is then adjusted so that subsequent scans begin</span></span><br><span class="line"><span class="comment">// just past the newly discovered free object.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If freeindex == nelem, this span has no free objects.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// allocBits is a bitmap of objects in this span.</span></span><br><span class="line"><span class="comment">// If n &gt;= freeindex and allocBits[n/8] &amp; (1&lt;&lt;(n%8)) is 0</span></span><br><span class="line"><span class="comment">// then object n is free;</span></span><br><span class="line"><span class="comment">// otherwise, object n is allocated. Bits starting at nelem are</span></span><br><span class="line"><span class="comment">// undefined and should never be referenced.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Object n starts at address n*elemsize + (start &lt;&lt; pageShift).</span></span><br><span class="line"><span class="comment">// ç”¨äºå®šä½ä¸‹ä¸€ä¸ªå¯ç”¨çš„object, å¤§å°èŒƒå›´åœ¨ 0- nelems ä¹‹é—´</span></span><br><span class="line">freeindex <span class="keyword">uintptr</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Look up nelems from sizeclass and remove this field if it</span></span><br><span class="line"><span class="comment">// helps performance.</span></span><br><span class="line"><span class="comment">// spané‡Œobjectçš„æ•°é‡</span></span><br><span class="line">nelems <span class="keyword">uintptr</span> <span class="comment">// number of object in the span.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cache of the allocBits at freeindex. allocCache is shifted</span></span><br><span class="line"><span class="comment">// such that the lowest bit corresponds to the bit freeindex.</span></span><br><span class="line"><span class="comment">// allocCache holds the complement of allocBits, thus allowing</span></span><br><span class="line"><span class="comment">// ctz (count trailing zero) to use it directly.</span></span><br><span class="line"><span class="comment">// allocCache may contain bits beyond s.nelems; the caller must ignore</span></span><br><span class="line"><span class="comment">// these.</span></span><br><span class="line"><span class="comment">// ç”¨äºç¼“å­˜freeindexå¼€å§‹çš„bitmap, ç¼“å­˜çš„bitå€¼ä¸åŸå€¼ç›¸åï¼Œctzå‡½æ•°å¯ä»¥é€šè¿‡è¿™ä¸ªå€¼å¿«é€Ÿè®¡ç®—å‡ºä¸‹ä¸€ä¸ª free objectçš„index</span></span><br><span class="line">allocCache <span class="keyword">uint64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†é…ä½å›¾ï¼Œæ¯ä¸€ä½ä»£è¡¨æ¯ä¸€å—æ˜¯å¦å·²ç»åˆ†é…</span></span><br><span class="line">allocBits  *gcBits</span><br><span class="line"></span><br><span class="line"><span class="comment">// å·²ç»åˆ†é…çš„objectçš„æ•°é‡</span></span><br><span class="line">allocCount  <span class="keyword">uint16</span>     <span class="comment">// number of allocated objects</span></span><br><span class="line"></span><br><span class="line">elemsize    <span class="keyword">uintptr</span>    <span class="comment">// computed from sizeclass or from npages</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="spanClass"><a href="#spanClass" class="headerlink" title="spanClass"></a>spanClass</h3><p>classè¡¨ä¸­çš„class IDï¼Œå’ŒSize Classsç›¸å…³</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> spanClass <span class="keyword">uint8</span></span><br></pre></td></tr></table></figure><h3 id="mTreap"><a href="#mTreap" class="headerlink" title="mTreap"></a>mTreap</h3><p>è¿™ä¸ªç»“æ„æ˜¯åŒ…å«mspançš„æ ‘çŠ¶ç»“æ„ï¼Œä¸»è¦æ˜¯ç»™ freeLargeä½¿ç”¨ï¼Œåœ¨æŸ¥æ‰¾å¯¹åº”classsizeçš„å¤§å¯¹è±¡çš„æ—¶å€™ï¼Œä½¿ç”¨æ ‘çŠ¶ç»“æ„æŸ¥æ‰¾è¦æ¯”é“¾è¡¨æ›´å¿«</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mTreap <span class="keyword">struct</span> &#123;</span><br><span class="line">treap *treapNode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mtreapNode"><a href="#mtreapNode" class="headerlink" title="mtreapNode"></a>mtreapNode</h3><p>mTreapç»“æ„çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¿¡æ¯åŒ…å«mspanå’Œå·¦å³å­èŠ‚ç‚¹ç­‰ä¿¡æ¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> treapNode <span class="keyword">struct</span> &#123;</span><br><span class="line">right     *treapNode <span class="comment">// all treapNodes &gt; this treap node</span></span><br><span class="line">left      *treapNode <span class="comment">// all treapNodes &lt; this treap node</span></span><br><span class="line">parent    *treapNode <span class="comment">// direct parent of this node, nil if root</span></span><br><span class="line">npagesKey <span class="keyword">uintptr</span>    <span class="comment">// number of pages in spanKey, used as primary sort key</span></span><br><span class="line">spanKey   *mspan     <span class="comment">// span of size npagesKey, used as secondary sort key</span></span><br><span class="line">priority  <span class="keyword">uint32</span>     <span class="comment">// random number used by treap algorithm to keep tree probabilistically balanced</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="heapArena"><a href="#heapArena" class="headerlink" title="heapArena"></a>heapArena</h3><p>heapArenaå­˜å‚¨çš„æ˜¯arenaçš„å…ƒæ•°æ®ï¼Œ arenasæ˜¯ä¸€ç»„heapArenaæ„æˆï¼Œæ‰€æœ‰çš„åˆ†é…çš„å†…å­˜éƒ½åœ¨ <code>arenas</code> é‡Œé¢ï¼Œå¤§è‡´ arenas[L1][L2] = heapArenaï¼Œ è€Œå¯¹äº åˆ†é…å‡ºå»çš„å†…å­˜çš„ addressï¼Œé€šè¿‡ <code>arenaIndex</code> å¯ä»¥è®¡ç®—å‡º <code>L1 L2</code>ï¼Œ ä»è€Œæ‰¾åˆ°è¯¥å†…å­˜æ‰€å¯¹åº”çš„ arenas[L1][L2]ï¼Œå³ heapArena</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> heapArena <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// bitmap stores the pointer/scalar bitmap for the words in</span></span><br><span class="line"><span class="comment">// this arena. See mbitmap.go for a description. Use the</span></span><br><span class="line"><span class="comment">// heapBits type to access this.</span></span><br><span class="line">bitmap [heapArenaBitmapBytes]<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// spans maps from virtual address page ID within this arena to *mspan.</span></span><br><span class="line"><span class="comment">// For allocated spans, their pages map to the span itself.</span></span><br><span class="line"><span class="comment">// For free spans, only the lowest and highest pages map to the span itself.</span></span><br><span class="line"><span class="comment">// Internal pages map to an arbitrary span.</span></span><br><span class="line"><span class="comment">// For pages that have never been allocated, spans entries are nil.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Modifications are protected by mheap.lock. Reads can be</span></span><br><span class="line"><span class="comment">// performed without locking, but ONLY from indexes that are</span></span><br><span class="line"><span class="comment">// known to contain in-use or stack spans. This means there</span></span><br><span class="line"><span class="comment">// must not be a safe-point between establishing that an</span></span><br><span class="line"><span class="comment">// address is live and looking it up in the spans array.</span></span><br><span class="line">spans [pagesPerArena]*mspan</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="arenaHint"><a href="#arenaHint" class="headerlink" title="arenaHint"></a>arenaHint</h3><p>è¿™ä¸ªæ˜¯è®°å½•arenaå¯ä»¥å¢é•¿çš„åœ°å€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> arenaHint <span class="keyword">struct</span> &#123;</span><br><span class="line">addr <span class="keyword">uintptr</span></span><br><span class="line"><span class="comment">// down ä¸º trueï¼Œè¡¨ç¤ºå¯ä»¥æ‰©å±•arenaçš„å¤§å°</span></span><br><span class="line">down <span class="keyword">bool</span></span><br><span class="line">next *arenaHint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mcentral"><a href="#mcentral" class="headerlink" title="mcentral"></a>mcentral</h3><p>mcentralåˆ™æ˜¯å…¨å±€èµ„æºï¼Œä¸ºå¤šä¸ªçº¿ç¨‹æœåŠ¡ï¼Œå½“æŸä¸ªçº¿ç¨‹å†…å­˜ä¸è¶³æ—¶ä¼šå‘mcentralç”³è¯·ï¼Œå½“æŸä¸ªçº¿ç¨‹é‡Šæ”¾å†…å­˜æ—¶åˆä¼šå›æ”¶è¿›mcentral</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mcentral <span class="keyword">struct</span> &#123;</span><br><span class="line">lock      mutex</span><br><span class="line">spanclass spanClass</span><br><span class="line"><span class="comment">// free object çš„é“¾è¡¨</span></span><br><span class="line">nonempty  mSpanList <span class="comment">// list of spans with a free object, ie a nonempty free list</span></span><br><span class="line"><span class="comment">// no free object çš„é“¾è¡¨</span></span><br><span class="line">empty     mSpanList <span class="comment">// list of spans with no free objects (or cached in an mcache)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// nmalloc is the cumulative count of objects allocated from</span></span><br><span class="line"><span class="comment">// this mcentral, assuming all spans in mcaches are</span></span><br><span class="line"><span class="comment">// fully-allocated. Written atomically, read under STW.</span></span><br><span class="line">nmalloc <span class="keyword">uint64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»“æ„å›¾"><a href="#ç»“æ„å›¾" class="headerlink" title="ç»“æ„å›¾"></a>ç»“æ„å›¾</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»“åˆä¸€ä¸‹å®è§‚çš„å›¾ç¤ºæ¥ç†è§£ä¸€ä¸‹ä¸Šé¢çš„ç»“æ„ä½“ä¹‹é—´çš„å…³è”ï¼ŒåŒæ—¶å¯¹äºåé¢çš„å†…å­˜åˆ†é…æœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œç­‰åˆ°åé¢å…¨éƒ¨è®²å®Œåï¼Œåœ¨å›è¿‡å¤´æ¥çœ‹çœ‹è¿™å¹…å›¾ï¼Œå¯èƒ½ä¼šå¯¹Goçš„å†…å­˜åˆ†é…æœ‰æ›´æ¸…æ™°çš„è®¤çŸ¥</p><p><img src="http://note-1253518569.cossh.myqcloud.com/20190715112554.png" alt></p><h1 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocinit</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// Initialize the heap.</span></span><br><span class="line"><span class="comment">// åˆå§‹åŒ– mheap</span></span><br><span class="line">mheap_.init()</span><br><span class="line">_g_ := getg()</span><br><span class="line">  <span class="comment">// è·å–å½“å‰gæ‰€åœ¨çš„mçš„mcacheï¼Œå¹¶åˆå§‹åŒ–</span></span><br><span class="line">_g_.m.mcache = allocmcache()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0x7f</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">  <span class="keyword">var</span> p <span class="keyword">uintptr</span></span><br><span class="line">  <span class="keyword">switch</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> GOARCH == <span class="string">"arm64"</span> &amp;&amp; GOOS == <span class="string">"darwin"</span>:</span><br><span class="line">  p = <span class="keyword">uintptr</span>(i)&lt;&lt;<span class="number">40</span> | uintptrMask&amp;(<span class="number">0x0013</span>&lt;&lt;<span class="number">28</span>)</span><br><span class="line">  <span class="keyword">case</span> GOARCH == <span class="string">"arm64"</span>:</span><br><span class="line">  p = <span class="keyword">uintptr</span>(i)&lt;&lt;<span class="number">40</span> | uintptrMask&amp;(<span class="number">0x0040</span>&lt;&lt;<span class="number">32</span>)</span><br><span class="line">  <span class="keyword">case</span> raceenabled:</span><br><span class="line">    <span class="comment">// The TSAN runtime requires the heap</span></span><br><span class="line">    <span class="comment">// to be in the range [0x00c000000000,</span></span><br><span class="line">    <span class="comment">// 0x00e000000000).</span></span><br><span class="line">    p = <span class="keyword">uintptr</span>(i)&lt;&lt;<span class="number">32</span> | uintptrMask&amp;(<span class="number">0x00c0</span>&lt;&lt;<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">if</span> p &gt;= uintptrMask&amp;<span class="number">0x00e000000000</span> &#123;</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">  p = <span class="keyword">uintptr</span>(i)&lt;&lt;<span class="number">40</span> | uintptrMask&amp;(<span class="number">0x00c0</span>&lt;&lt;<span class="number">32</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¿å­˜ arenaç›¸å…³å±æ€§</span></span><br><span class="line">  hint := (*arenaHint)(mheap_.arenaHintAlloc.alloc())</span><br><span class="line">  hint.addr = p</span><br><span class="line">  hint.next, mheap_.arenaHints = mheap_.arenaHints, hint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mheap-init"><a href="#mheap-init" class="headerlink" title="mheap.init"></a>mheap.init</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *mheap)</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">h.treapalloc.init(unsafe.Sizeof(treapNode&#123;&#125;), <span class="literal">nil</span>, <span class="literal">nil</span>, &amp;memstats.other_sys)</span><br><span class="line">h.spanalloc.init(unsafe.Sizeof(mspan&#123;&#125;), recordspan, unsafe.Pointer(h), &amp;memstats.mspan_sys)</span><br><span class="line">h.cachealloc.init(unsafe.Sizeof(mcache&#123;&#125;), <span class="literal">nil</span>, <span class="literal">nil</span>, &amp;memstats.mcache_sys)</span><br><span class="line">h.specialfinalizeralloc.init(unsafe.Sizeof(specialfinalizer&#123;&#125;), <span class="literal">nil</span>, <span class="literal">nil</span>, &amp;memstats.other_sys)</span><br><span class="line">h.specialprofilealloc.init(unsafe.Sizeof(specialprofile&#123;&#125;), <span class="literal">nil</span>, <span class="literal">nil</span>, &amp;memstats.other_sys)</span><br><span class="line">h.arenaHintAlloc.init(unsafe.Sizeof(arenaHint&#123;&#125;), <span class="literal">nil</span>, <span class="literal">nil</span>, &amp;memstats.other_sys)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Don't zero mspan allocations. Background sweeping can</span></span><br><span class="line"><span class="comment">// inspect a span concurrently with allocating it, so it's</span></span><br><span class="line"><span class="comment">// important that the span's sweepgen survive across freeing</span></span><br><span class="line"><span class="comment">// and re-allocating a span to prevent background sweeping</span></span><br><span class="line"><span class="comment">// from improperly cas'ing it from 0.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This is safe because mspan contains no heap pointers.</span></span><br><span class="line">h.spanalloc.zero = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// h-&gt;mapcache needs no init</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> h.free &#123;</span><br><span class="line">h.free[i].init()</span><br><span class="line">h.busy[i].init()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">h.busylarge.init()</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> h.central &#123;</span><br><span class="line">h.central[i].mcentral.init(spanClass(i))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mcentral-init"><a href="#mcentral-init" class="headerlink" title="mcentral.init"></a>mcentral.init</h3><p>åˆå§‹åŒ–æŸä¸ªè§„æ ¼çš„mcentral</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize a single central free list.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mcentral)</span> <span class="title">init</span><span class="params">(spc spanClass)</span></span> &#123;</span><br><span class="line">c.spanclass = spc</span><br><span class="line">c.nonempty.init()</span><br><span class="line">c.empty.init()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="allocmcache"><a href="#allocmcache" class="headerlink" title="allocmcache"></a>allocmcache</h3><p>mcacheçš„åˆå§‹åŒ–</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">allocmcache</span><span class="params">()</span> *<span class="title">mcache</span></span> &#123;</span><br><span class="line">lock(&amp;mheap_.lock)</span><br><span class="line">c := (*mcache)(mheap_.cachealloc.alloc())</span><br><span class="line">unlock(&amp;mheap_.lock)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> c.alloc &#123;</span><br><span class="line">c.alloc[i] = &amp;emptymspan</span><br><span class="line">&#125;</span><br><span class="line">c.next_sample = nextSample()</span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="fixalloc-alloc"><a href="#fixalloc-alloc" class="headerlink" title="fixalloc.alloc"></a>fixalloc.alloc</h4><p>fixallocæ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„åˆ†é…å™¨ã€‚ä¸»è¦ç”¨æ¥åˆ†é…ä¸€äº›å¯¹å†…å­˜çš„åŒ…è£…çš„ç»“æ„,æ¯”å¦‚:mspan,mcache..ç­‰ç­‰,è™½ç„¶å¯åŠ¨åˆ†é…çš„å®é™…ä½¿ç”¨å†…å­˜æ˜¯ç”±å…¶ä»–å†…å­˜åˆ†é…å™¨åˆ†é…çš„ã€‚ ä¸»è¦åˆ†é…æ€è·¯ä¸º: å¼€å§‹çš„æ—¶å€™ä¸€æ¬¡æ€§åˆ†é…ä¸€å¤§å—å†…å­˜ï¼Œæ¯æ¬¡è¯·æ±‚åˆ†é…ä¸€å°å—ï¼Œé‡Šæ”¾æ—¶æ”¾åœ¨listé“¾è¡¨ä¸­ï¼Œç”±äºsizeæ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜ç¢ç‰‡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *fixalloc)</span> <span class="title">alloc</span><span class="params">()</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> f.size == <span class="number">0</span> &#123;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"runtime: use of FixAlloc_Alloc before FixAlloc_Init\n"</span>)</span><br><span class="line">throw(<span class="string">"runtime: internal error"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœlistä¸è¦ä¸ºç©ºï¼Œç›´æ¥æ‹¿</span></span><br><span class="line"><span class="keyword">if</span> f.list != <span class="literal">nil</span> &#123;</span><br><span class="line">v := unsafe.Pointer(f.list)</span><br><span class="line">f.list = f.list.next</span><br><span class="line">f.inuse += f.size</span><br><span class="line"><span class="keyword">if</span> f.zero &#123;</span><br><span class="line">memclrNoHeapPointers(v, f.size)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> v</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// å¦‚æœå—ä¸ºç©ºï¼Œåˆ™ä»ç³»ç»Ÿåˆ†é…ä¸­è°ƒç”¨ç³»ç»Ÿå†…å­˜åˆ†é…</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">uintptr</span>(f.nchunk) &lt; f.size &#123;</span><br><span class="line">f.chunk = <span class="keyword">uintptr</span>(persistentalloc(_FixAllocChunk, <span class="number">0</span>, f.stat))</span><br><span class="line">f.nchunk = _FixAllocChunk</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä»chunkä¸­åˆ†é…ä¸€ä¸ªå›ºå®šå¤§å°çš„sizeï¼Œé‡Šæ”¾çš„æ—¶å€™ï¼Œä¼šå›å½’åˆ°listä¸­</span></span><br><span class="line">v := unsafe.Pointer(f.chunk)</span><br><span class="line"><span class="keyword">if</span> f.first != <span class="literal">nil</span> &#123;</span><br><span class="line">f.first(f.arg, v)</span><br><span class="line">&#125;</span><br><span class="line">f.chunk = f.chunk + f.size</span><br><span class="line">f.nchunk -= <span class="keyword">uint32</span>(f.size)</span><br><span class="line">f.inuse += f.size</span><br><span class="line"><span class="keyword">return</span> v</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–çš„å·¥ä½œå¾ˆç®€å•ï¼š</p><ol><li>åˆå§‹åŒ–heapï¼Œåˆå§‹åŒ–free largeå¯¹åº”è§„æ ¼çš„é“¾è¡¨ï¼Œåˆå§‹åŒ–busyLargeé“¾è¡¨</li><li>åˆå§‹åŒ–æ¯ä¸ªè§„æ ¼å¯¹åº”çš„mcentral</li><li>åˆå§‹åŒ–mcacheï¼Œå¯¹mcacheé‡Œé¢æ¯ä¸ªå¯¹åº”çš„è§„æ ¼è¿›è¡Œåˆå§‹åŒ–</li><li>åˆå§‹åŒ– arenaHintsï¼Œå¡«å……ä¸€ç»„åœ°å€ï¼Œåé¢æ ¹æ®çœŸæ­£çš„arenaè¾¹ç•Œæ¥è¿›è¡Œæ‰©å¢</li></ol><h1 id="åˆ†é…"><a href="#åˆ†é…" class="headerlink" title="åˆ†é…"></a>åˆ†é…</h1><h2 id="newObject"><a href="#newObject" class="headerlink" title="newObject"></a>newObject</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newobject</span><span class="params">(typ *_type)</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> mallocgc(typ.size, typ, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mallocgc"><a href="#mallocgc" class="headerlink" title="mallocgc"></a>mallocgc</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgc</span><span class="params">(size <span class="keyword">uintptr</span>, typ *_type, needzero <span class="keyword">bool</span>)</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set mp.mallocing to keep from being preempted by GC.</span></span><br><span class="line"><span class="comment">// åŠ é”é˜²æ­¢è¢«GCæŠ¢å </span></span><br><span class="line">mp := acquirem()</span><br><span class="line"><span class="keyword">if</span> mp.mallocing != <span class="number">0</span> &#123;</span><br><span class="line">throw(<span class="string">"malloc deadlock"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> mp.gsignal == getg() &#123;</span><br><span class="line">throw(<span class="string">"malloc during signal"</span>)</span><br><span class="line">&#125;</span><br><span class="line">mp.mallocing = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">shouldhelpgc := <span class="literal">false</span></span><br><span class="line">dataSize := size</span><br><span class="line"><span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„mcache</span></span><br><span class="line">c := gomcache()</span><br><span class="line"><span class="keyword">var</span> x unsafe.Pointer</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­åˆ†é…çš„å¯¹è±¡æ˜¯å¦ æ˜¯nilæˆ–éæŒ‡é’ˆç±»å‹</span></span><br><span class="line">noscan := typ == <span class="literal">nil</span> || typ.kind&amp;kindNoPointers != <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> size &lt;= maxSmallSize &#123;</span><br><span class="line"><span class="keyword">if</span> noscan &amp;&amp; size &lt; maxTinySize &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œå¼€å§‹å°å¯¹è±¡çš„å†…å­˜åˆ†é…</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹é½ï¼Œè°ƒæ•´åç§»é‡</span></span><br><span class="line">off := c.tinyoffset</span><br><span class="line"><span class="comment">// Align tiny pointer for required (conservative) alignment.</span></span><br><span class="line"><span class="keyword">if</span> size&amp;<span class="number">7</span> == <span class="number">0</span> &#123;</span><br><span class="line">off = round(off, <span class="number">8</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> size&amp;<span class="number">3</span> == <span class="number">0</span> &#123;</span><br><span class="line">off = round(off, <span class="number">4</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> size&amp;<span class="number">1</span> == <span class="number">0</span> &#123;</span><br><span class="line">off = round(off, <span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰mcacheä¸Šç»‘å®šçš„tiny å—å†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œç›´æ¥åˆ†é…ï¼Œå¹¶è¿”å›</span></span><br><span class="line"><span class="keyword">if</span> off+size &lt;= maxTinySize &amp;&amp; c.tiny != <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// The object fits into existing tiny block.</span></span><br><span class="line">x = unsafe.Pointer(c.tiny + off)</span><br><span class="line">c.tinyoffset = off + size</span><br><span class="line">c.local_tinyallocs++</span><br><span class="line">mp.mallocing = <span class="number">0</span></span><br><span class="line">releasem(mp)</span><br><span class="line"><span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Allocate a new maxTinySize block.</span></span><br><span class="line"><span class="comment">// å½“å‰mcacheä¸Šçš„ tiny å—å†…å­˜ç©ºé—´ä¸è¶³ï¼Œé‡æ–°åˆ†é…ä¸€å— tiny å—å†…å­˜</span></span><br><span class="line">span := c.alloc[tinySpanClass]</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•ä» allocCache è·å–å†…å­˜ï¼Œè·å–ä¸åˆ°è¿”å›0</span></span><br><span class="line">v := nextFreeFast(span)</span><br><span class="line"><span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// æ²¡æœ‰ä» allocCache è·å–åˆ°å†…å­˜ï¼ŒnetxtFreeå‡½æ•° å°è¯•ä» mcentralè·å–ä¸€ä¸ªæ–°çš„å¯¹åº”è§„æ ¼çš„å¿«å†…å­˜ï¼Œæ›¿æ¢åŸå…ˆå†…å­˜ç©ºé—´ä¸è¶³çš„å†…å­˜å—ï¼Œå¹¶åˆ†é…å†…å­˜ï¼Œåé¢è§£æ nextFree å‡½æ•°</span></span><br><span class="line">v, _, shouldhelpgc = c.nextFree(tinySpanClass)</span><br><span class="line">&#125;</span><br><span class="line">x = unsafe.Pointer(v)</span><br><span class="line">(*[<span class="number">2</span>]<span class="keyword">uint64</span>)(x)[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">(*[<span class="number">2</span>]<span class="keyword">uint64</span>)(x)[<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line"><span class="comment">// See if we need to replace the existing tiny block with the new one</span></span><br><span class="line"><span class="comment">// based on amount of remaining free space.</span></span><br><span class="line"><span class="keyword">if</span> size &lt; c.tinyoffset || c.tiny == <span class="number">0</span> &#123;</span><br><span class="line">c.tiny = <span class="keyword">uintptr</span>(x)</span><br><span class="line">c.tinyoffset = size</span><br><span class="line">&#125;</span><br><span class="line">size = maxTinySize</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œå¼€å§‹ æ­£å¸¸å¯¹è±¡çš„ å†…å­˜åˆ†é…</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é¦–å…ˆæŸ¥è¡¨ï¼Œä»¥ç¡®å®š sizeclass</span></span><br><span class="line"><span class="keyword">var</span> sizeclass <span class="keyword">uint8</span></span><br><span class="line"><span class="keyword">if</span> size &lt;= smallSizeMax<span class="number">-8</span> &#123;</span><br><span class="line">sizeclass = size_to_class8[(size+smallSizeDiv<span class="number">-1</span>)/smallSizeDiv]</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">sizeclass = size_to_class128[(size-smallSizeMax+largeSizeDiv<span class="number">-1</span>)/largeSizeDiv]</span><br><span class="line">&#125;</span><br><span class="line">size = <span class="keyword">uintptr</span>(class_to_size[sizeclass])</span><br><span class="line">spc := makeSpanClass(sizeclass, noscan)</span><br><span class="line"><span class="comment">// æ‰¾åˆ°å¯¹åº” sizeclass(åé¢ `è§„æ ¼` æ¥ä»£æ›¿)çš„span</span></span><br><span class="line">span := c.alloc[spc]</span><br><span class="line"><span class="comment">// åŒå°å¯¹è±¡åˆ†é…ä¸€æ ·ï¼Œå°è¯•ä» allocCache è·å–å†…å­˜ï¼Œè·å–ä¸åˆ°è¿”å›0</span></span><br><span class="line">v := nextFreeFast(span)</span><br><span class="line"><span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line">v, span, shouldhelpgc = c.nextFree(spc)</span><br><span class="line">&#125;</span><br><span class="line">x = unsafe.Pointer(v)</span><br><span class="line"><span class="keyword">if</span> needzero &amp;&amp; span.needzero != <span class="number">0</span> &#123;</span><br><span class="line">memclrNoHeapPointers(unsafe.Pointer(v), size)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œå¼€å§‹å¤§å¯¹è±¡çš„åˆ†é…</span></span><br><span class="line"><span class="comment">// å¤§å¯¹è±¡çš„åˆ†é…ä¸ å°å¯¹è±¡ å’Œæ™®é€šå¯¹è±¡ çš„åˆ†é…æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå¤§å¯¹è±¡ç›´æ¥ä» mheap ä¸Šåˆ†é…</span></span><br><span class="line"><span class="keyword">var</span> s *mspan</span><br><span class="line">shouldhelpgc = <span class="literal">true</span></span><br><span class="line">systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">s = largeAlloc(size, needzero, noscan)</span><br><span class="line">&#125;)</span><br><span class="line">s.freeindex = <span class="number">1</span></span><br><span class="line">s.allocCount = <span class="number">1</span></span><br><span class="line">x = unsafe.Pointer(s.base())</span><br><span class="line">size = s.elemsize</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bitmapæ ‡è®°...</span></span><br><span class="line"><span class="comment">// æ£€æŸ¥å‡ºå‘æ¡ä»¶ï¼Œå¯åŠ¨åƒåœ¾å›æ”¶ ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ç†ä¸€ä¸‹ è¿™æ®µä»£ç çš„åŸºæœ¬æ€è·¯ï¼š</p><ol><li><p>é¦–å…ˆåˆ¤å®š å¯¹è±¡æ˜¯ å¤§å¯¹è±¡ è¿˜æ˜¯ æ™®é€šå¯¹è±¡è¿˜æ˜¯ å°å¯¹è±¡</p></li><li><p>å¦‚æœæ˜¯ å°å¯¹è±¡</p><ol><li>ä» mcache çš„alloc æ‰¾åˆ°å¯¹åº” classsize çš„ mspan</li><li><p>å¦‚æœå½“å‰mspanæœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ†é…å¹¶ä¿®æ”¹mspançš„ç›¸å…³å±æ€§ï¼ˆnextFreeFastå‡½æ•°ä¸­å®ç°ï¼‰</p></li><li><p>å¦‚æœå½“å‰mspanæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œä» mcentralé‡æ–°è·å–ä¸€å— å¯¹åº” classsizeçš„ mspanï¼Œæ›¿æ¢åŸå…ˆçš„mspanï¼Œç„¶å åˆ†é…å¹¶ä¿®æ”¹mspançš„ç›¸å…³å±æ€§</p></li></ol></li><li><p>å¦‚æœæ˜¯æ™®é€šå¯¹è±¡ï¼Œé€»è¾‘å¤§è‡´åŒå°å¯¹è±¡çš„ å†…å­˜åˆ†é…</p><ol><li><p>é¦–å…ˆæŸ¥è¡¨ï¼Œä»¥ç¡®å®š éœ€è¦åˆ†é…å†…å­˜çš„å¯¹è±¡çš„ sizeclassï¼Œå¹¶æ‰¾åˆ° å¯¹åº” classsizeçš„ mspan</p></li><li><p>å¦‚æœå½“å‰mspanæœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ†é…å¹¶ä¿®æ”¹mspançš„ç›¸å…³å±æ€§ï¼ˆnextFreeFastå‡½æ•°ä¸­å®ç°ï¼‰</p></li><li><p>å¦‚æœå½“å‰mspanæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œä» mcentralé‡æ–°è·å–ä¸€å— å¯¹åº” classsizeçš„ mspanï¼Œæ›¿æ¢åŸå…ˆçš„mspanï¼Œç„¶å åˆ†é…å¹¶ä¿®æ”¹mspançš„ç›¸å…³å±æ€§</p></li></ol></li><li><p>å¦‚æœæ˜¯å¤§å¯¹è±¡ï¼Œç›´æ¥ä»mheapè¿›è¡Œåˆ†é…ï¼Œè¿™é‡Œçš„å®ç°ä¾é  <code>largeAlloc</code> å‡½æ•°å®ç°ï¼Œæˆ‘ä»¬å…ˆè·Ÿä¸€ä¸‹è¿™ä¸ªå‡½æ•°</p></li></ol><h2 id="largeAlloc"><a href="#largeAlloc" class="headerlink" title="largeAlloc"></a>largeAlloc</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">largeAlloc</span><span class="params">(size <span class="keyword">uintptr</span>, needzero <span class="keyword">bool</span>, noscan <span class="keyword">bool</span>)</span> *<span class="title">mspan</span></span> &#123;</span><br><span class="line"><span class="comment">// print("largeAlloc size=", size, "\n")</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†…å­˜æº¢å‡ºåˆ¤æ–­</span></span><br><span class="line"><span class="keyword">if</span> size+_PageSize &lt; size &#123;</span><br><span class="line">throw(<span class="string">"out of memory"</span>)</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è®¡ç®—å‡ºå¯¹è±¡æ‰€éœ€çš„é¡µæ•°</span></span><br><span class="line">npages := size &gt;&gt; _PageShift</span><br><span class="line"><span class="keyword">if</span> size&amp;_PageMask != <span class="number">0</span> &#123;</span><br><span class="line">npages++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deduct credit for this span allocation and sweep if</span></span><br><span class="line"><span class="comment">// necessary. mHeap_Alloc will also sweep npages, so this only</span></span><br><span class="line"><span class="comment">// pays the debt down to npage pages.</span></span><br><span class="line">deductSweepCredit(npages*_PageSize, npages)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ†é…å‡½æ•°çš„å…·ä½“å®ç°</span></span><br><span class="line">s := mheap_.alloc(npages, makeSpanClass(<span class="number">0</span>, noscan), <span class="literal">true</span>, needzero)</span><br><span class="line"><span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line">throw(<span class="string">"out of memory"</span>)</span><br><span class="line">&#125;</span><br><span class="line">s.limit = s.base() + size</span><br><span class="line">  <span class="comment">// bitmap è®°å½•åˆ†é…çš„span</span></span><br><span class="line">heapBitsForAddr(s.base()).initSpan(s)</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mheap-alloc"><a href="#mheap-alloc" class="headerlink" title="mheap.alloc"></a>mheap.alloc</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *mheap)</span> <span class="title">alloc</span><span class="params">(npage <span class="keyword">uintptr</span>, spanclass spanClass, large <span class="keyword">bool</span>, needzero <span class="keyword">bool</span>)</span> *<span class="title">mspan</span></span> &#123;</span><br><span class="line"><span class="comment">// Don't do any operations that lock the heap on the G stack.</span></span><br><span class="line"><span class="comment">// It might trigger stack growth, and the stack growth code needs</span></span><br><span class="line"><span class="comment">// to be able to allocate heap.</span></span><br><span class="line"><span class="keyword">var</span> s *mspan</span><br><span class="line">systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">s = h.alloc_m(npage, spanclass, large)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> needzero &amp;&amp; s.needzero != <span class="number">0</span> &#123;</span><br><span class="line">memclrNoHeapPointers(unsafe.Pointer(s.base()), s.npages&lt;&lt;_PageShift)</span><br><span class="line">&#125;</span><br><span class="line">s.needzero = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="mheap-alloc-m"><a href="#mheap-alloc-m" class="headerlink" title="mheap.alloc_m"></a>mheap.alloc_m</h4><p>æ ¹æ®é¡µæ•°ä» heap ä¸Šé¢åˆ†é…ä¸€ä¸ªæ–°çš„spanï¼Œå¹¶ä¸”åœ¨ HeapMap å’Œ HeapMapCache ä¸Šè®°å½•å¯¹è±¡çš„sizeclass</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *mheap)</span> <span class="title">alloc_m</span><span class="params">(npage <span class="keyword">uintptr</span>, spanclass spanClass, large <span class="keyword">bool</span>)</span> *<span class="title">mspan</span></span> &#123;</span><br><span class="line">_g_ := getg()</span><br><span class="line"><span class="keyword">if</span> _g_ != _g_.m.g0 &#123;</span><br><span class="line">throw(<span class="string">"_mheap_alloc not on g0 stack"</span>)</span><br><span class="line">&#125;</span><br><span class="line">lock(&amp;h.lock)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†åƒåœ¾ï¼Œå†…å­˜å—çŠ¶æ€æ ‡è®° çœç•¥...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä» heapä¸­è·å–æŒ‡å®šé¡µæ•°çš„span</span></span><br><span class="line">s := h.allocSpanLocked(npage, &amp;memstats.heap_inuse)</span><br><span class="line"><span class="keyword">if</span> s != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Record span info, because gc needs to be</span></span><br><span class="line"><span class="comment">// able to map interior pointer to containing span.</span></span><br><span class="line">atomic.Store(&amp;s.sweepgen, h.sweepgen)</span><br><span class="line">h.sweepSpans[h.sweepgen/<span class="number">2</span>%<span class="number">2</span>].push(s) <span class="comment">// Add to swept in-use list.// å¿½ç•¥</span></span><br><span class="line">s.state = _MSpanInUse</span><br><span class="line">s.allocCount = <span class="number">0</span></span><br><span class="line">s.spanclass = spanclass</span><br><span class="line">    <span class="comment">// é‡ç½®spançš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">if</span> sizeclass := spanclass.sizeclass(); sizeclass == <span class="number">0</span> &#123;</span><br><span class="line">s.elemsize = s.npages &lt;&lt; _PageShift</span><br><span class="line">s.divShift = <span class="number">0</span></span><br><span class="line">s.divMul = <span class="number">0</span></span><br><span class="line">s.divShift2 = <span class="number">0</span></span><br><span class="line">s.baseMask = <span class="number">0</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">s.elemsize = <span class="keyword">uintptr</span>(class_to_size[sizeclass])</span><br><span class="line">m := &amp;class_to_divmagic[sizeclass]</span><br><span class="line">s.divShift = m.shift</span><br><span class="line">s.divMul = m.mul</span><br><span class="line">s.divShift2 = m.shift2</span><br><span class="line">s.baseMask = m.baseMask</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update stats, sweep lists</span></span><br><span class="line">h.pagesInUse += <span class="keyword">uint64</span>(npage)</span><br><span class="line"><span class="keyword">if</span> large &#123;</span><br><span class="line">      <span class="comment">// æ›´æ–° mheapä¸­å¤§å¯¹è±¡çš„ç›¸å…³å±æ€§</span></span><br><span class="line">memstats.heap_objects++</span><br><span class="line">mheap_.largealloc += <span class="keyword">uint64</span>(s.elemsize)</span><br><span class="line">mheap_.nlargealloc++</span><br><span class="line">atomic.Xadd64(&amp;memstats.heap_live, <span class="keyword">int64</span>(npage&lt;&lt;_PageShift))</span><br><span class="line"><span class="comment">// Swept spans are at the end of lists.</span></span><br><span class="line">      <span class="comment">// æ ¹æ®é¡µæ•°åˆ¤æ–­æ˜¯busyè¿˜æ˜¯ busylargeé“¾è¡¨ï¼Œå¹¶è¿½åŠ åˆ°æœ«å°¾</span></span><br><span class="line"><span class="keyword">if</span> s.npages &lt; <span class="keyword">uintptr</span>(<span class="built_in">len</span>(h.busy)) &#123;</span><br><span class="line">h.busy[s.npages].insertBack(s)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">h.busylarge.insertBack(s)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// gc trace æ ‡è®°ï¼Œçœç•¥...</span></span><br><span class="line">unlock(&amp;h.lock)</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="mheap-allocSpanLocked"><a href="#mheap-allocSpanLocked" class="headerlink" title="mheap.allocSpanLocked"></a>mheap.allocSpanLocked</h5><p>åˆ†é…ä¸€ä¸ªç»™å®šå¤§å°çš„spanï¼Œå¹¶å°†åˆ†é…çš„spanä»freelistä¸­ç§»é™¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *mheap)</span> <span class="title">allocSpanLocked</span><span class="params">(npage <span class="keyword">uintptr</span>, stat *<span class="keyword">uint64</span>)</span> *<span class="title">mspan</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> list *mSpanList</span><br><span class="line"><span class="keyword">var</span> s *mspan</span><br><span class="line"></span><br><span class="line"><span class="comment">// Try in fixed-size lists up to max.</span></span><br><span class="line">  <span class="comment">// å…ˆå°è¯•è·å–æŒ‡å®šé¡µæ•°çš„spanï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¯•è¯•é¡µæ•°æ›´å¤šçš„</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">int</span>(npage); i &lt; <span class="built_in">len</span>(h.free); i++ &#123;</span><br><span class="line">list = &amp;h.free[i]</span><br><span class="line"><span class="keyword">if</span> !list.isEmpty() &#123;</span><br><span class="line">s = list.first</span><br><span class="line">list.remove(s)</span><br><span class="line"><span class="keyword">goto</span> HaveSpan</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Best fit in list of large spans.</span></span><br><span class="line">  <span class="comment">// ä» freelarge ä¸Šæ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„spanèŠ‚ç‚¹è¿”å› ï¼Œä¸‹é¢ç»§ç»­åˆ†æè¿™ä¸ªå‡½æ•°</span></span><br><span class="line">s = h.allocLarge(npage) <span class="comment">// allocLarge removed s from h.freelarge for us</span></span><br><span class="line"><span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ freelargeä¸Šæ‰¾ä¸åˆ°åˆé€‚çš„spanèŠ‚ç‚¹ï¼Œå°±åªæœ‰ä» ç³»ç»Ÿ é‡æ–°åˆ†é…äº†</span></span><br><span class="line">    <span class="comment">// åé¢ç»§ç»­åˆ†æè¿™ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span> !h.grow(npage) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// ä»ç³»ç»Ÿåˆ†é…åï¼Œå†æ¬¡åˆ°freelarge ä¸Šå¯»æ‰¾åˆé€‚çš„èŠ‚ç‚¹</span></span><br><span class="line">s = h.allocLarge(npage)</span><br><span class="line"><span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HaveSpan:</span><br><span class="line">  <span class="comment">// ä» free ä¸Šé¢è·å–åˆ°äº† åˆé€‚é¡µæ•°çš„span</span></span><br><span class="line"><span class="comment">// Mark span in use. çœç•¥....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.npages &gt; npage &#123;</span><br><span class="line"><span class="comment">// Trim extra and put it back in the heap.</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª s.napges - npage å¤§å°çš„spanï¼Œå¹¶æ”¾å› heap</span></span><br><span class="line">t := (*mspan)(h.spanalloc.alloc())</span><br><span class="line">t.init(s.base()+npage&lt;&lt;_PageShift, s.npages-npage)</span><br><span class="line">    <span class="comment">// æ›´æ–°è·å–åˆ°çš„span s çš„å±æ€§</span></span><br><span class="line">s.npages = npage</span><br><span class="line">h.setSpan(t.base()<span class="number">-1</span>, s)</span><br><span class="line">h.setSpan(t.base(), t)</span><br><span class="line">h.setSpan(t.base()+t.npages*pageSize<span class="number">-1</span>, t)</span><br><span class="line">t.needzero = s.needzero</span><br><span class="line">s.state = _MSpanManual <span class="comment">// prevent coalescing with s</span></span><br><span class="line">t.state = _MSpanManual</span><br><span class="line">h.freeSpanLocked(t, <span class="literal">false</span>, <span class="literal">false</span>, s.unusedsince)</span><br><span class="line">s.state = _MSpanFree</span><br><span class="line">&#125;</span><br><span class="line">s.unusedsince = <span class="number">0</span></span><br><span class="line"><span class="comment">// å°†sæ”¾åˆ°spans å’Œ arenas æ•°ç»„é‡Œé¢</span></span><br><span class="line">h.setSpans(s.base(), npage, s)</span><br><span class="line"></span><br><span class="line">*stat += <span class="keyword">uint64</span>(npage &lt;&lt; _PageShift)</span><br><span class="line">memstats.heap_idle -= <span class="keyword">uint64</span>(npage &lt;&lt; _PageShift)</span><br><span class="line"></span><br><span class="line"><span class="comment">//println("spanalloc", hex(s.start&lt;&lt;_PageShift))</span></span><br><span class="line"><span class="keyword">if</span> s.inList() &#123;</span><br><span class="line">throw(<span class="string">"still in list"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="mheap-allocLarge"><a href="#mheap-allocLarge" class="headerlink" title="mheap.allocLarge"></a>mheap.allocLarge</h6><p>ä» mheap çš„ freeLarge æ ‘ä¸Šé¢æ‰¾åˆ°ä¸€ä¸ªæŒ‡å®špageæ•°é‡çš„spanï¼Œå¹¶å°†è¯¥spanä»æ ‘ä¸Šç§»é™¤ï¼Œæ‰¾ä¸åˆ°åˆ™è¿”å›nil</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *mheap)</span> <span class="title">allocLarge</span><span class="params">(npage <span class="keyword">uintptr</span>)</span> *<span class="title">mspan</span></span> &#123;</span><br><span class="line"><span class="comment">// Search treap for smallest span with &gt;= npage pages.</span></span><br><span class="line"><span class="keyword">return</span> h.freelarge.remove(npage)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šé¢çš„ h.freelarge.remove å³è°ƒç”¨è¿™ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="comment">// å…¸å‹çš„äºŒå‰æ ‘å¯»æ‰¾ç®—æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(root *mTreap)</span> <span class="title">remove</span><span class="params">(npages <span class="keyword">uintptr</span>)</span> *<span class="title">mspan</span></span> &#123;</span><br><span class="line">t := root.treap</span><br><span class="line"><span class="keyword">for</span> t != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> t.spanKey == <span class="literal">nil</span> &#123;</span><br><span class="line">throw(<span class="string">"treap node with nil spanKey found"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> t.npagesKey &lt; npages &#123;</span><br><span class="line">t = t.right</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> t.left != <span class="literal">nil</span> &amp;&amp; t.left.npagesKey &gt;= npages &#123;</span><br><span class="line">t = t.left</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">result := t.spanKey</span><br><span class="line">root.removeNode(t)</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨ï¼š åœ¨çœ‹ ã€ŠGoè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹çš„æ—¶å€™ï¼Œè¿™é‡Œçš„æŸ¥æ‰¾ç®—æ³•è¿˜æ˜¯ å¯¹é“¾è¡¨çš„ éå†æŸ¥æ‰¾</p><h6 id="mheap-grow"><a href="#mheap-grow" class="headerlink" title="mheap.grow"></a>mheap.grow</h6><p>åœ¨ mheap.allocSpanLocked è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå¦‚æœ freelargeä¸Šæ‰¾ä¸åˆ°åˆé€‚çš„spanèŠ‚ç‚¹ï¼Œå°±åªæœ‰ä» ç³»ç»Ÿ é‡æ–°åˆ†é…äº†ï¼Œé‚£æˆ‘ä»¬æ¥ä¸‹æ¥å°±ç»§ç»­åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *mheap)</span> <span class="title">grow</span><span class="params">(npage <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">ask := npage &lt;&lt; _PageShift</span><br><span class="line">  <span class="comment">// å‘ç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œåé¢ç»§ç»­è¿½è¸ª sysAlloc è¿™ä¸ªå‡½æ•°</span></span><br><span class="line">v, size := h.sysAlloc(ask)</span><br><span class="line"><span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"runtime: out of memory: cannot allocate "</span>, ask, <span class="string">"-byte block ("</span>, memstats.heap_sys, <span class="string">" in use)\n"</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a fake "in use" span and free it, so that the</span></span><br><span class="line"><span class="comment">// right coalescing happens.</span></span><br><span class="line">  <span class="comment">// åˆ›å»º span æ¥ç®¡ç†åˆšåˆšç”³è¯·çš„å†…å­˜</span></span><br><span class="line">s := (*mspan)(h.spanalloc.alloc())</span><br><span class="line">s.init(<span class="keyword">uintptr</span>(v), size/pageSize)</span><br><span class="line">h.setSpans(s.base(), s.npages, s)</span><br><span class="line">atomic.Store(&amp;s.sweepgen, h.sweepgen)</span><br><span class="line">s.state = _MSpanInUse</span><br><span class="line">h.pagesInUse += <span class="keyword">uint64</span>(s.npages)</span><br><span class="line">  <span class="comment">// å°†åˆšåˆšç”³è¯·çš„spanæ”¾åˆ° arenas å’Œ spans æ•°ç»„é‡Œé¢</span></span><br><span class="line">h.freeSpanLocked(s, <span class="literal">false</span>, <span class="literal">true</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="mheao-sysAlloc"><a href="#mheao-sysAlloc" class="headerlink" title="mheao.sysAlloc"></a>mheao.sysAlloc</h6> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *mheap)</span> <span class="title">sysAlloc</span><span class="params">(n <span class="keyword">uintptr</span>)</span> <span class="params">(v unsafe.Pointer, size <span class="keyword">uintptr</span>)</span></span> &#123;</span><br><span class="line">n = round(n, heapArenaBytes)</span><br><span class="line"></span><br><span class="line"><span class="comment">// First, try the arena pre-reservation.</span></span><br><span class="line">  <span class="comment">// ä» arena ä¸­ è·å–å¯¹åº”å¤§å°çš„å†…å­˜ï¼Œ è·å–ä¸åˆ°è¿”å›nil</span></span><br><span class="line">v = h.arena.alloc(n, heapArenaBytes, &amp;memstats.heap_sys)</span><br><span class="line"><span class="keyword">if</span> v != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// ä»arenaè·å–åˆ°éœ€è¦çš„å†…å­˜ï¼Œè·³è½¬åˆ° mappedæ“ä½œ</span></span><br><span class="line">size = n</span><br><span class="line"><span class="keyword">goto</span> mapped</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Try to grow the heap at a hint address.</span></span><br><span class="line">  <span class="comment">// å°è¯• ä» arenaHintå‘ä¸‹æ‰©å±•å†…å­˜</span></span><br><span class="line"><span class="keyword">for</span> h.arenaHints != <span class="literal">nil</span> &#123;</span><br><span class="line">hint := h.arenaHints</span><br><span class="line">p := hint.addr</span><br><span class="line"><span class="keyword">if</span> hint.down &#123;</span><br><span class="line">p -= n</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> p+n &lt; p &#123;</span><br><span class="line"><span class="comment">// We can't use this, so don't ask.</span></span><br><span class="line">      <span class="comment">// è¡¨å hint.down = false ä¸èƒ½å‘ä¸‹æ‰©å±•å†…å­˜</span></span><br><span class="line">v = <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> arenaIndex(p+n<span class="number">-1</span>) &gt;= <span class="number">1</span>&lt;&lt;arenaBits &#123;</span><br><span class="line">      <span class="comment">// è¶…å‡º heap å¯å¯»å€çš„å†…å­˜åœ°å€ï¼Œä¸èƒ½ä½¿ç”¨</span></span><br><span class="line"><span class="comment">// Outside addressable heap. Can't use.</span></span><br><span class="line">v = <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å½“å‰hintå¯ä»¥å‘ä¸‹æ‰©å±•å†…å­˜ï¼Œåˆ©ç”¨mmapå‘ç³»ç»Ÿç”³è¯·å†…å­˜</span></span><br><span class="line">v = sysReserve(unsafe.Pointer(p), n)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> p == <span class="keyword">uintptr</span>(v) &#123;</span><br><span class="line"><span class="comment">// Success. Update the hint.</span></span><br><span class="line"><span class="keyword">if</span> !hint.down &#123;</span><br><span class="line">p += n</span><br><span class="line">&#125;</span><br><span class="line">hint.addr = p</span><br><span class="line">size = n</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Failed. Discard this hint and try the next.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> This would be cleaner if sysReserve could be</span></span><br><span class="line"><span class="comment">// told to only return the requested address. In</span></span><br><span class="line"><span class="comment">// particular, this is already how Windows behaves, so</span></span><br><span class="line"><span class="comment">// it would simply things there.</span></span><br><span class="line"><span class="keyword">if</span> v != <span class="literal">nil</span> &#123;</span><br><span class="line">sysFree(v, n, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line">h.arenaHints = hint.next</span><br><span class="line">h.arenaHintAlloc.free(unsafe.Pointer(hint))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> size == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">if</span> raceenabled &#123;</span><br><span class="line"><span class="comment">// The race detector assumes the heap lives in</span></span><br><span class="line"><span class="comment">// [0x00c000000000, 0x00e000000000), but we</span></span><br><span class="line"><span class="comment">// just ran out of hints in this region. Give</span></span><br><span class="line"><span class="comment">// a nice failure.</span></span><br><span class="line">throw(<span class="string">"too many address space collisions for -race mode"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// All of the hints failed, so we'll take any</span></span><br><span class="line"><span class="comment">// (sufficiently aligned) address the kernel will give</span></span><br><span class="line"><span class="comment">// us.</span></span><br><span class="line">v, size = sysReserveAligned(<span class="literal">nil</span>, n, heapArenaBytes)</span><br><span class="line"><span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create new hints for extending this region.</span></span><br><span class="line">hint := (*arenaHint)(h.arenaHintAlloc.alloc())</span><br><span class="line">hint.addr, hint.down = <span class="keyword">uintptr</span>(v), <span class="literal">true</span></span><br><span class="line">hint.next, mheap_.arenaHints = mheap_.arenaHints, hint</span><br><span class="line">hint = (*arenaHint)(h.arenaHintAlloc.alloc())</span><br><span class="line">hint.addr = <span class="keyword">uintptr</span>(v) + size</span><br><span class="line">hint.next, mheap_.arenaHints = mheap_.arenaHints, hint</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for bad pointers or pointers we can't use.</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> bad <span class="keyword">string</span></span><br><span class="line">p := <span class="keyword">uintptr</span>(v)</span><br><span class="line"><span class="keyword">if</span> p+size &lt; p &#123;</span><br><span class="line">bad = <span class="string">"region exceeds uintptr range"</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> arenaIndex(p) &gt;= <span class="number">1</span>&lt;&lt;arenaBits &#123;</span><br><span class="line">bad = <span class="string">"base outside usable address space"</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> arenaIndex(p+size<span class="number">-1</span>) &gt;= <span class="number">1</span>&lt;&lt;arenaBits &#123;</span><br><span class="line">bad = <span class="string">"end outside usable address space"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> bad != <span class="string">""</span> &#123;</span><br><span class="line"><span class="comment">// This should be impossible on most architectures,</span></span><br><span class="line"><span class="comment">// but it would be really confusing to debug.</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"runtime: memory allocated by OS ["</span>, hex(p), <span class="string">", "</span>, hex(p+size), <span class="string">") not in usable address space: "</span>, bad, <span class="string">"\n"</span>)</span><br><span class="line">throw(<span class="string">"memory reservation exceeds address space limit"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">uintptr</span>(v)&amp;(heapArenaBytes<span class="number">-1</span>) != <span class="number">0</span> &#123;</span><br><span class="line">throw(<span class="string">"misrounded allocation in sysAlloc"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Back the reservation.</span></span><br><span class="line">sysMap(v, size, &amp;memstats.heap_sys)</span><br><span class="line"></span><br><span class="line">mapped:</span><br><span class="line"><span class="comment">// Create arena metadata.</span></span><br><span class="line">  <span class="comment">// æ ¹æ® v çš„addressï¼Œè®¡ç®—å‡º arenas çš„L1 L2</span></span><br><span class="line"><span class="keyword">for</span> ri := arenaIndex(<span class="keyword">uintptr</span>(v)); ri &lt;= arenaIndex(<span class="keyword">uintptr</span>(v)+size<span class="number">-1</span>); ri++ &#123;</span><br><span class="line">l2 := h.arenas[ri.l1()]</span><br><span class="line"><span class="keyword">if</span> l2 == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ L2 ä¸º nilï¼Œåˆ™åˆ†é… arenas[L1]</span></span><br><span class="line"><span class="comment">// Allocate an L2 arena map.</span></span><br><span class="line">l2 = (*[<span class="number">1</span> &lt;&lt; arenaL2Bits]*heapArena)(persistentalloc(unsafe.Sizeof(*l2), sys.PtrSize, <span class="literal">nil</span>))</span><br><span class="line"><span class="keyword">if</span> l2 == <span class="literal">nil</span> &#123;</span><br><span class="line">throw(<span class="string">"out of memory allocating heap arena map"</span>)</span><br><span class="line">&#125;</span><br><span class="line">atomic.StorepNoWB(unsafe.Pointer(&amp;h.arenas[ri.l1()]), unsafe.Pointer(l2))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ arenas[ri.L1()][ri.L2()] ä¸ä¸ºç©º è¯´æ˜å·²ç»å®ä¾‹åŒ–è¿‡äº†</span></span><br><span class="line"><span class="keyword">if</span> l2[ri.l2()] != <span class="literal">nil</span> &#123;</span><br><span class="line">throw(<span class="string">"arena already initialized"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> r *heapArena</span><br><span class="line">    <span class="comment">// ä» arena ä¸Šåˆ†é…å†…å­˜</span></span><br><span class="line">r = (*heapArena)(h.heapArenaAlloc.alloc(unsafe.Sizeof(*r), sys.PtrSize, &amp;memstats.gc_sys))</span><br><span class="line"><span class="keyword">if</span> r == <span class="literal">nil</span> &#123;</span><br><span class="line">r = (*heapArena)(persistentalloc(unsafe.Sizeof(*r), sys.PtrSize, &amp;memstats.gc_sys))</span><br><span class="line"><span class="keyword">if</span> r == <span class="literal">nil</span> &#123;</span><br><span class="line">throw(<span class="string">"out of memory allocating heap arena metadata"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store atomically just in case an object from the</span></span><br><span class="line"><span class="comment">// new heap arena becomes visible before the heap lock</span></span><br><span class="line"><span class="comment">// is released (which shouldn't happen, but there's</span></span><br><span class="line"><span class="comment">// little downside to this).</span></span><br><span class="line">atomic.StorepNoWB(unsafe.Pointer(&amp;l2[ri.l2()]), unsafe.Pointer(r))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç ...</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå¤§å¯¹è±¡çš„åˆ†é…æµç¨‹è‡³æ­¤ç»“æŸï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ï¼Œå°å¯¹è±¡å’Œæ™®é€šè¯å¯¹è±¡çš„åˆ†é…æµç¨‹</p><h2 id="å°å¯¹è±¡å’Œæ™®é€šå¯¹è±¡åˆ†é…"><a href="#å°å¯¹è±¡å’Œæ™®é€šå¯¹è±¡åˆ†é…" class="headerlink" title="å°å¯¹è±¡å’Œæ™®é€šå¯¹è±¡åˆ†é…"></a>å°å¯¹è±¡å’Œæ™®é€šå¯¹è±¡åˆ†é…</h2><p>ä¸‹é¢ä¸€æ®µæ˜¯ å°å¯¹è±¡å’Œæ™®é€šå¯¹è±¡çš„å†…å­˜æŸ¥æ‰¾å’Œåˆ†é…çš„ä¸»è¦å‡½æ•°ï¼Œåœ¨ä¸Šé¢çš„æ—¶å€™å·²ç»åˆ†æè¿‡äº†ï¼Œä¸‹é¢æˆ‘ä»¬å°±ç€é‡åˆ†æè¿™ä¸¤ä¸ªå‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">span := c.alloc[spc]</span><br><span class="line">v := nextFreeFast(span)</span><br><span class="line"><span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line">v, _, shouldhelpgc = c.nextFree(spc)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="nextFreeFast"><a href="#nextFreeFast" class="headerlink" title="nextFreeFast"></a>nextFreeFast</h3><p>è¿™ä¸ªå‡½æ•°è¿”å› span ä¸Šå¯ç”¨çš„åœ°å€ï¼Œå¦‚æœæ‰¾ä¸åˆ° åˆ™è¿”å›0</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nextFreeFast</span><span class="params">(s *mspan)</span> <span class="title">gclinkptr</span></span> &#123;</span><br><span class="line">  <span class="comment">// è®¡ç®—s.allocCacheä»ä½ä½èµ·æœ‰å¤šå°‘ä¸ª0</span></span><br><span class="line">theBit := sys.Ctz64(s.allocCache) <span class="comment">// Is there a free object in the allocCache?</span></span><br><span class="line"><span class="keyword">if</span> theBit &lt; <span class="number">64</span> &#123;</span><br><span class="line">    </span><br><span class="line">result := s.freeindex + <span class="keyword">uintptr</span>(theBit)</span><br><span class="line"><span class="keyword">if</span> result &lt; s.nelems &#123;</span><br><span class="line">freeidx := result + <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> freeidx%<span class="number">64</span> == <span class="number">0</span> &amp;&amp; freeidx != s.nelems &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°bitmapã€å¯ç”¨çš„ slotç´¢å¼•</span></span><br><span class="line">s.allocCache &gt;&gt;= <span class="keyword">uint</span>(theBit + <span class="number">1</span>)</span><br><span class="line">s.freeindex = freeidx</span><br><span class="line">s.allocCount++</span><br><span class="line">      <span class="comment">// è¿”å› æ‰¾åˆ°çš„å†…å­˜çš„åœ°å€</span></span><br><span class="line"><span class="keyword">return</span> gclinkptr(result*s.elemsize + s.base())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mcache-nextFree"><a href="#mcache-nextFree" class="headerlink" title="mcache.nextFree"></a>mcache.nextFree</h3><p>å¦‚æœ nextFreeFast æ‰¾ä¸åˆ° åˆé€‚çš„å†…å­˜ï¼Œå°±ä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°</p><p>nextFree å¦‚æœåœ¨cached span é‡Œé¢æ‰¾åˆ°æœªä½¿ç”¨çš„objectï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™ï¼Œè°ƒç”¨refill å‡½æ•°ï¼Œä» central ä¸­è·å–å¯¹åº”classsizeçš„spanï¼Œç„¶å ä»æ–°çš„spané‡Œé¢æ‰¾åˆ°æœªä½¿ç”¨çš„objectè¿”å›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mcache)</span> <span class="title">nextFree</span><span class="params">(spc spanClass)</span> <span class="params">(v gclinkptr, s *mspan, shouldhelpgc <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// å…ˆæ‰¾åˆ° mcache ä¸­ å¯¹åº” è§„æ ¼çš„ span</span></span><br><span class="line">  s = c.alloc[spc]</span><br><span class="line">shouldhelpgc = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// åœ¨ å½“å‰spanä¸­æ‰¾åˆ°åˆé€‚çš„ indexç´¢å¼•</span></span><br><span class="line">freeIndex := s.nextFreeIndex()</span><br><span class="line"><span class="keyword">if</span> freeIndex == s.nelems &#123;</span><br><span class="line"><span class="comment">// The span is full.</span></span><br><span class="line">    <span class="comment">// freeIndex == nelems æ—¶ï¼Œè¡¨ç¤ºå½“å‰spanå·²æ»¡</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">uintptr</span>(s.allocCount) != s.nelems &#123;</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"runtime: s.allocCount="</span>, s.allocCount, <span class="string">"s.nelems="</span>, s.nelems)</span><br><span class="line">throw(<span class="string">"s.allocCount != s.nelems &amp;&amp; freeIndex == s.nelems"</span>)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// è°ƒç”¨refillå‡½æ•°ï¼Œä» mcentral ä¸­è·å–å¯ç”¨çš„spanï¼Œå¹¶æ›¿æ¢æ‰å½“å‰ mcacheé‡Œé¢çš„span</span></span><br><span class="line">systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">c.refill(spc)</span><br><span class="line">&#125;)</span><br><span class="line">shouldhelpgc = <span class="literal">true</span></span><br><span class="line">s = c.alloc[spc]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†æ¬¡åˆ°æ–°çš„spané‡Œé¢æŸ¥æ‰¾åˆé€‚çš„index</span></span><br><span class="line">freeIndex = s.nextFreeIndex()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> freeIndex &gt;= s.nelems &#123;</span><br><span class="line">throw(<span class="string">"freeIndex is not valid"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¡ç®—å‡ºæ¥ å†…å­˜åœ°å€ï¼Œå¹¶æ›´æ–°spançš„å±æ€§</span></span><br><span class="line">v = gclinkptr(freeIndex*s.elemsize + s.base())</span><br><span class="line">s.allocCount++</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">uintptr</span>(s.allocCount) &gt; s.nelems &#123;</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"s.allocCount="</span>, s.allocCount, <span class="string">"s.nelems="</span>, s.nelems)</span><br><span class="line">throw(<span class="string">"s.allocCount &gt; s.nelems"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="mcache-refill"><a href="#mcache-refill" class="headerlink" title="mcache.refill"></a>mcache.refill</h4><p>Refill æ ¹æ®æŒ‡å®šçš„sizeclassè·å–å¯¹åº”çš„spanï¼Œå¹¶ä½œä¸º mcacheçš„æ–°çš„sizeclasså¯¹åº”çš„span</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mcache)</span> <span class="title">refill</span><span class="params">(spc spanClass)</span></span> &#123;</span><br><span class="line">_g_ := getg()</span><br><span class="line"></span><br><span class="line">_g_.m.locks++</span><br><span class="line"><span class="comment">// Return the current cached span to the central lists.</span></span><br><span class="line">s := c.alloc[spc]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">uintptr</span>(s.allocCount) != s.nelems &#123;</span><br><span class="line">throw(<span class="string">"refill of span with free space remaining"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­sæ˜¯ä¸æ˜¯ ç©ºçš„span</span></span><br><span class="line"><span class="keyword">if</span> s != &amp;emptymspan &#123;</span><br><span class="line">s.incache = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å°è¯•ä» mcentral è·å–ä¸€ä¸ªæ–°çš„spanæ¥ä»£æ›¿è€çš„span</span></span><br><span class="line"><span class="comment">// Get a new cached span from the central lists.</span></span><br><span class="line">s = mheap_.central[spc].mcentral.cacheSpan()</span><br><span class="line"><span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line">throw(<span class="string">"out of memory"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">uintptr</span>(s.allocCount) == s.nelems &#123;</span><br><span class="line">throw(<span class="string">"span has no free space"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ›´æ–°mcacheçš„span</span></span><br><span class="line">c.alloc[spc] = s</span><br><span class="line">_g_.m.locks--</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="mcentral-cacheSpan"><a href="#mcentral-cacheSpan" class="headerlink" title="mcentral.cacheSpan"></a>mcentral.cacheSpan</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mcentral)</span> <span class="title">cacheSpan</span><span class="params">()</span> *<span class="title">mspan</span></span> &#123;</span><br><span class="line"><span class="comment">// Deduct credit for this span allocation and sweep if necessary.</span></span><br><span class="line">spanBytes := <span class="keyword">uintptr</span>(class_to_allocnpages[c.spanclass.sizeclass()]) * _PageSize</span><br><span class="line"><span class="comment">// æ¸…ç†åƒåœ¾...</span></span><br><span class="line">lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">sg := mheap_.sweepgen</span><br><span class="line">retry:</span><br><span class="line"><span class="keyword">var</span> s *mspan</span><br><span class="line"><span class="keyword">for</span> s = c.nonempty.first; s != <span class="literal">nil</span>; s = s.next &#123;</span><br><span class="line">    <span class="comment">// if sweepgen == h-&gt;sweepgen - 2, the span needs sweeping</span></span><br><span class="line">    <span class="comment">// if sweepgen == h-&gt;sweepgen - 1, the span is currently being swept</span></span><br><span class="line">    <span class="comment">// if sweepgen == h-&gt;sweepgen, the span is swept and ready to use</span></span><br><span class="line">    <span class="comment">// h-&gt;sweepgen is incremented by 2 after every GC</span></span><br><span class="line">    <span class="comment">// éœ€è¦æ¸…ç†çš„span</span></span><br><span class="line"><span class="keyword">if</span> s.sweepgen == sg<span class="number">-2</span> &amp;&amp; atomic.Cas(&amp;s.sweepgen, sg<span class="number">-2</span>, sg<span class="number">-1</span>) &#123;</span><br><span class="line">c.nonempty.remove(s)</span><br><span class="line">c.empty.insertBack(s)</span><br><span class="line">unlock(&amp;c.lock)</span><br><span class="line">s.sweep(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">goto</span> havespan</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> s.sweepgen == sg<span class="number">-1</span> &#123;</span><br><span class="line"><span class="comment">// the span is being swept by background sweeper, skip</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// we have a nonempty span that does not require sweeping, allocate from it</span></span><br><span class="line">    <span class="comment">// æ‰¾åˆ°ç‰‡ æ²¡æœ‰è¢« æ¸…ç†çš„spanï¼Œåˆ†é…ï¼Œè·³è½¬åˆ° havespanæ ‡ç­¾ç»§ç»­å¤„ç†</span></span><br><span class="line">c.nonempty.remove(s)</span><br><span class="line">c.empty.insertBack(s)</span><br><span class="line">unlock(&amp;c.lock)</span><br><span class="line"><span class="keyword">goto</span> havespan</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹äº ä¸Šä¸€è½®å¾ªç¯ä¸­ï¼Œå¯èƒ½ æ­£åœ¨æ¸…æ‰«çš„spanï¼Œæ¸…æ‰«åçš„spanå¯èƒ½ä¼šæœ‰æœ‰ç”¨çš„spanï¼Œæ‰€ä»¥åœ¨è¿™é‡Œ åœ¨è¿›è¡Œä¸€æ¬¡éå†æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">for</span> s = c.empty.first; s != <span class="literal">nil</span>; s = s.next &#123;</span><br><span class="line"><span class="keyword">if</span> s.sweepgen == sg<span class="number">-2</span> &amp;&amp; atomic.Cas(&amp;s.sweepgen, sg<span class="number">-2</span>, sg<span class="number">-1</span>) &#123;</span><br><span class="line"><span class="comment">// we have an empty span that requires sweeping,</span></span><br><span class="line"><span class="comment">// sweep it and see if we can free some space in it</span></span><br><span class="line">c.empty.remove(s)</span><br><span class="line"><span class="comment">// swept spans are at the end of the list</span></span><br><span class="line">c.empty.insertBack(s)</span><br><span class="line">unlock(&amp;c.lock)</span><br><span class="line">s.sweep(<span class="literal">true</span>)</span><br><span class="line">freeIndex := s.nextFreeIndex()</span><br><span class="line"><span class="keyword">if</span> freeIndex != s.nelems &#123;</span><br><span class="line">s.freeindex = freeIndex</span><br><span class="line"><span class="keyword">goto</span> havespan</span><br><span class="line">&#125;</span><br><span class="line">lock(&amp;c.lock)</span><br><span class="line"><span class="comment">// the span is still empty after sweep</span></span><br><span class="line"><span class="comment">// it is already in the empty list, so just retry</span></span><br><span class="line"><span class="keyword">goto</span> retry</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> s.sweepgen == sg<span class="number">-1</span> &#123;</span><br><span class="line"><span class="comment">// the span is being swept by background sweeper, skip</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// already swept empty span,</span></span><br><span class="line"><span class="comment">// all subsequent ones must also be either swept or in process of sweeping</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unlock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Replenish central list if empty.</span></span><br><span class="line">  <span class="comment">// æ‰¾ä¸åˆ° åˆé€‚çš„spanï¼Œè¡¥å……å¯¹åº”classsizeçš„spanï¼Œgrowå‡½æ•°ä¼šè°ƒç”¨ mheap.alloc æ¥å¡«å……spanï¼Œä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œä¸å†èµ˜è¿°</span></span><br><span class="line">s = c.grow()</span><br><span class="line"><span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">lock(&amp;c.lock)</span><br><span class="line">  <span class="comment">// æ’å…¥åˆ°empty span liståé¢</span></span><br><span class="line">c.empty.insertBack(s)</span><br><span class="line">unlock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line"><span class="comment">// At this point s is a non-empty span, queued at the end of the empty list,</span></span><br><span class="line"><span class="comment">// c is unlocked.</span></span><br><span class="line">havespan:</span><br><span class="line"></span><br><span class="line"><span class="built_in">cap</span> := <span class="keyword">int32</span>((s.npages &lt;&lt; _PageShift) / s.elemsize)</span><br><span class="line">n := <span class="built_in">cap</span> - <span class="keyword">int32</span>(s.allocCount)</span><br><span class="line"><span class="keyword">if</span> n == <span class="number">0</span> || s.freeindex == s.nelems || <span class="keyword">uintptr</span>(s.allocCount) == s.nelems &#123;</span><br><span class="line">throw(<span class="string">"span has no free objects"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Assume all objects from this span will be allocated in the</span></span><br><span class="line"><span class="comment">// mcache. If it gets uncached, we'll adjust this.</span></span><br><span class="line">atomic.Xadd64(&amp;c.nmalloc, <span class="keyword">int64</span>(n))</span><br><span class="line">usedBytes := <span class="keyword">uintptr</span>(s.allocCount) * s.elemsize</span><br><span class="line">atomic.Xadd64(&amp;memstats.heap_live, <span class="keyword">int64</span>(spanBytes)-<span class="keyword">int64</span>(usedBytes))</span><br><span class="line"><span class="comment">// è¡¨ç¤º span ä¸ºæ­£åœ¨ä½¿ç”¨</span></span><br><span class="line">s.incache = <span class="literal">true</span></span><br><span class="line">freeByteBase := s.freeindex &amp;^ (<span class="number">64</span> - <span class="number">1</span>)</span><br><span class="line">whichByte := freeByteBase / <span class="number">8</span></span><br><span class="line">  <span class="comment">// æ›´æ–° bitmap</span></span><br><span class="line"><span class="comment">// Init alloc bits cache.</span></span><br><span class="line">s.refillAllocCache(whichByte)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Adjust the allocCache so that s.freeindex corresponds to the low bit in</span></span><br><span class="line"><span class="comment">// s.allocCache.</span></span><br><span class="line">s.allocCache &gt;&gt;= s.freeindex % <span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œå¦‚æœ ä» mcentral æ‰¾ä¸åˆ°å¯¹åº”çš„spanï¼Œå°±å¼€å§‹äº†å†…å­˜æ‰©å¼ ä¹‹æ—…äº†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢åˆ†æçš„ <code>mheap.alloc</code>ï¼Œåé¢çš„åˆ†æå°±åŒä¸Šäº†</p><h2 id="åˆ†é…å°ç»“"><a href="#åˆ†é…å°ç»“" class="headerlink" title="åˆ†é…å°ç»“"></a>åˆ†é…å°ç»“</h2><p>ç»¼ä¸Šï¼Œå¯ä»¥çœ‹å‡ºGoçš„å†…å­˜åˆ†é…çš„å¤§è‡´æµç¨‹å¦‚ä¸‹</p><ol><li>é¦–å…ˆåˆ¤å®š å¯¹è±¡æ˜¯ å¤§å¯¹è±¡ è¿˜æ˜¯ æ™®é€šå¯¹è±¡è¿˜æ˜¯ å°å¯¹è±¡</li><li>å¦‚æœæ˜¯ å°å¯¹è±¡<ol><li>ä» mcache çš„alloc æ‰¾åˆ°å¯¹åº” classsize çš„ mspan</li><li>å¦‚æœå½“å‰mspanæœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ†é…å¹¶ä¿®æ”¹mspançš„ç›¸å…³å±æ€§ï¼ˆnextFreeFastå‡½æ•°ä¸­å®ç°ï¼‰</li><li>å¦‚æœå½“å‰mspanæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œä» mcentralé‡æ–°è·å–ä¸€å— å¯¹åº” classsizeçš„ mspanï¼Œæ›¿æ¢åŸå…ˆçš„mspanï¼Œç„¶å åˆ†é…å¹¶ä¿®æ”¹mspançš„ç›¸å…³å±æ€§</li><li>å¦‚æœmcentralæ²¡æœ‰è¶³å¤Ÿçš„å¯¹åº”çš„classsizeçš„spanï¼Œåˆ™å»å‘mheapç”³è¯·</li><li>å¦‚æœ å¯¹åº”classsizeçš„spanæ²¡æœ‰äº†ï¼Œåˆ™æ‰¾ä¸€ä¸ªç›¸è¿‘çš„classsizeçš„spanï¼Œåˆ‡å‰²å¹¶åˆ†é…</li><li>å¦‚æœ æ‰¾ä¸åˆ°ç›¸è¿‘çš„classsizeçš„spanï¼Œåˆ™å»å‘ç³»ç»Ÿç”³è¯·ï¼Œå¹¶è¡¥å……åˆ°mheapä¸­</li></ol></li><li>å¦‚æœæ˜¯æ™®é€šå¯¹è±¡ï¼Œé€»è¾‘å¤§è‡´åŒå°å¯¹è±¡çš„ å†…å­˜åˆ†é…<ol><li>é¦–å…ˆæŸ¥è¡¨ï¼Œä»¥ç¡®å®š éœ€è¦åˆ†é…å†…å­˜çš„å¯¹è±¡çš„ sizeclassï¼Œå¹¶æ‰¾åˆ° å¯¹åº” classsizeçš„ mspan</li><li>å¦‚æœå½“å‰mspanæœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ†é…å¹¶ä¿®æ”¹mspançš„ç›¸å…³å±æ€§ï¼ˆnextFreeFastå‡½æ•°ä¸­å®ç°ï¼‰</li><li>å¦‚æœå½“å‰mspanæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œä» mcentralé‡æ–°è·å–ä¸€å— å¯¹åº” classsizeçš„ mspanï¼Œæ›¿æ¢åŸå…ˆçš„mspanï¼Œç„¶å åˆ†é…å¹¶ä¿®æ”¹mspançš„ç›¸å…³å±æ€§</li><li>å¦‚æœmcentralæ²¡æœ‰è¶³å¤Ÿçš„å¯¹åº”çš„classsizeçš„spanï¼Œåˆ™å»å‘mheapç”³è¯·</li><li>å¦‚æœ å¯¹åº”classsizeçš„spanæ²¡æœ‰äº†ï¼Œåˆ™æ‰¾ä¸€ä¸ªç›¸è¿‘çš„classsizeçš„spanï¼Œåˆ‡å‰²å¹¶åˆ†é…</li><li>å¦‚æœ æ‰¾ä¸åˆ°ç›¸è¿‘çš„classsizeçš„spanï¼Œåˆ™å»å‘ç³»ç»Ÿç”³è¯·ï¼Œå¹¶è¡¥å……åˆ°mheapä¸­</li></ol></li><li>å¦‚æœæ˜¯å¤§å¯¹è±¡ï¼Œç›´æ¥ä»mheapè¿›è¡Œåˆ†é…<ol><li>å¦‚æœ å¯¹åº”classsizeçš„spanæ²¡æœ‰äº†ï¼Œåˆ™æ‰¾ä¸€ä¸ªç›¸è¿‘çš„classsizeçš„spanï¼Œåˆ‡å‰²å¹¶åˆ†é…</li><li>å¦‚æœ æ‰¾ä¸åˆ°ç›¸è¿‘çš„classsizeçš„spanï¼Œåˆ™å»å‘ç³»ç»Ÿç”³è¯·ï¼Œå¹¶è¡¥å……åˆ°mheapä¸­</li></ol></li></ol><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>ã€ŠGoè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹</p><p><a href="https://studygolang.com/articles/20604" target="_blank" rel="noopener">ã€Šå›¾è§£Goè¯­è¨€å†…å­˜åˆ†é…ã€‹</a></p><p><a href="https://www.jianshu.com/p/47691d870756" target="_blank" rel="noopener">ã€Šæ¢ç´¢Goå†…å­˜ç®¡ç†(åˆ†é…)ã€‹</a></p><p><a href="http://legendtkl.com/2017/04/02/golang-alloc/" target="_blank" rel="noopener">ã€ŠGolang å†…å­˜ç®¡ç†ã€‹</a></p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£Go-é€ƒé€¸åˆ†æ</title>
      <link href="/posts/30194/"/>
      <url>/posts/30194/</url>
      
        <content type="html"><![CDATA[<blockquote><p>How do I know whether a variable is allocated on the heap or the stack?</p><p>From a correctness standpoint, you donâ€™t need to know. Each variable in Go exists as long as there are references to it. The storage location chosen by the implementation is irrelevant to the semantics of the language.</p><p>The storage location does have an effect on writing efficient programs. When possible, the Go compilers will allocate variables that are local to a function in that functionâ€™s stack frame. However, if the compiler cannot prove that the variable is not referenced after the function returns, then the compiler must allocate the variable on the garbage-collected heap to avoid dangling pointer errors. Also, if a local variable is very large, it might make more sense to store it on the heap rather than the stack.</p><p>In the current compilers, if a variable has its address taken, that variable is a candidate for allocation on the heap. However, a basic escape analysis recognizes some cases when such variables will not live past the return from the function and can reside on the stack.</p></blockquote><p>åœ¨Goé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œåˆ°åº•æ˜¯åˆ†é…åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Šï¼ŒGoå®˜æ–¹æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬ï¼Œä¸éœ€è¦ç®¡ï¼Œä»–ä»¬ä¼šåˆ†æï¼Œå…¶å®è¿™ä¸ªåˆ†æå°±æ˜¯é€ƒé€¸åˆ†æ</p><p>åœ¨ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘ä¼˜åŒ–åŸç†ä¸­ï¼Œåˆ†ææŒ‡é’ˆåŠ¨æ€èŒƒå›´çš„æ–¹æ³•ç§°ä¹‹ä¸ºé€ƒé€¸åˆ†æã€‚é€šä¿—æ¥è®²ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆè¢«å¤šä¸ªæ–¹æ³•æˆ–çº¿ç¨‹å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªæŒ‡é’ˆå‘ç”Ÿäº†é€ƒé€¸ã€‚</p><a id="more"></a><p>å‘ç”Ÿé€ƒé€¸è¡Œä¸ºçš„æƒ…å†µä¸»è¦æœ‰ä¸¤ç§ï¼š</p><ul><li>æ–¹æ³•é€ƒé€¸ï¼šå½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­å®šä¹‰ä¹‹åï¼Œä½œä¸ºå‚æ•°ä¼ é€’æˆ–è¿”å›å€¼åˆ°å…¶å®ƒæ–¹æ³•ä¸­</li><li>çº¿ç¨‹é€ƒé€¸ï¼šå¦‚ç±»å˜é‡æˆ–å®ä¾‹å˜é‡ï¼Œå¯èƒ½è¢«å…¶å®ƒçº¿ç¨‹è®¿é—®åˆ°</li></ul><p>è¿™é‡Œä¸»è¦å¯¹ <strong>æ–¹æ³•é€ƒé€¸</strong> è¿›è¡Œåˆ†æï¼Œé€šè¿‡é€ƒé€¸åˆ†ææ¥åˆ¤æ–­ä¸€ä¸ªå˜é‡åˆ°åº•æ˜¯åˆ†é…åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Š</p><h1 id="é€ƒé€¸ç­–ç•¥"><a href="#é€ƒé€¸ç­–ç•¥" class="headerlink" title="é€ƒé€¸ç­–ç•¥"></a>é€ƒé€¸ç­–ç•¥</h1><ul><li>å¦‚æœç¼–è¯‘å™¨ä¸èƒ½è¯æ˜æŸä¸ªå˜é‡åœ¨å‡½æ•°è¿”å›åä¸å†è¢«å¼•ç”¨ï¼Œåˆ™åˆ†é…åœ¨å †ä¸Š</li><li>å¦‚æœä¸€ä¸ªå˜é‡è¿‡å¤§ï¼Œåˆ™æœ‰å¯èƒ½åˆ†é…åœ¨å †ä¸Š</li></ul><h1 id="åˆ†æç›®çš„"><a href="#åˆ†æç›®çš„" class="headerlink" title="åˆ†æç›®çš„"></a>åˆ†æç›®çš„</h1><ul><li>ä¸é€ƒé€¸çš„å¯¹è±¡åˆ†é…åœ¨æ ˆä¸Šï¼Œåˆ™å˜é‡åœ¨ç”¨å®Œåå°±ä¼šè¢«ç¼–è¯‘å™¨å›æ”¶ï¼Œä»è€Œå‡å°‘GCçš„å‹åŠ›</li><li>æ ˆä¸Šçš„åˆ†é…è¦æ¯”å †ä¸Šçš„åˆ†é…æ›´åŠ é«˜æ•ˆ</li><li>åŒæ­¥æ¶ˆé™¤ï¼Œå¦‚æœå®šä¹‰çš„å¯¹è±¡ä¸Šæœ‰åŒæ­¥é”ï¼Œä½†æ˜¯æ ˆåœ¨è¿è¡Œæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œé€ƒé€¸åˆ†æåå¦‚æœåœ¨æ ˆä¸Šåˆ™ä¼šå°†åŒæ­¥é”å»é™¤</li></ul><h1 id="é€ƒé€¸åœºæ™¯"><a href="#é€ƒé€¸åœºæ™¯" class="headerlink" title="é€ƒé€¸åœºæ™¯"></a>é€ƒé€¸åœºæ™¯</h1><h2 id="æŒ‡é’ˆé€ƒé€¸"><a href="#æŒ‡é’ˆé€ƒé€¸" class="headerlink" title="æŒ‡é’ˆé€ƒé€¸"></a>æŒ‡é’ˆé€ƒé€¸</h2><blockquote><p>åœ¨ build çš„æ—¶å€™ï¼Œé€šè¿‡æ·»åŠ  -gcflags â€œ-mâ€ ç¼–è¯‘å‚æ•°å°±å¯ä»¥æŸ¥çœ‹ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é€ƒé€¸åˆ†æ</p></blockquote><p>åœ¨æœ‰äº›æ—¶å€™ï¼Œå› ä¸ºå˜é‡å¤ªå¤§ç­‰åŸå› ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©è¿”å›å˜é‡çš„æŒ‡é’ˆï¼Œè€Œéå˜é‡ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯é€ƒé€¸çš„ä¸€ä¸ªç»å…¸ç°è±¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">test()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span> *<span class="title">int</span></span> &#123;</span><br><span class="line">i := <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> &amp;i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€ƒé€¸åˆ†æç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># command-line-arguments</span><br><span class="line">./main.go:7:6: can inline test</span><br><span class="line">./main.go:3:6: can inline main</span><br><span class="line">./main.go:4:6: inlining call to test</span><br><span class="line">./main.go:4:6: main &amp;i does not escape</span><br><span class="line">./main.go:9:9: &amp;i escapes to heap</span><br><span class="line">./main.go:8:2: moved to heap: i</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åä¸¤è¡ŒæŒ‡å‡ºï¼Œå˜é‡ <code>i</code> é€ƒé€¸åˆ°äº† <code>heap</code> ä¸Š</p><h2 id="æ ˆç©ºé—´ä¸è¶³é€ƒé€¸"><a href="#æ ˆç©ºé—´ä¸è¶³é€ƒé€¸" class="headerlink" title="æ ˆç©ºé—´ä¸è¶³é€ƒé€¸"></a>æ ˆç©ºé—´ä¸è¶³é€ƒé€¸</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°è¯•åˆ›å»ºä¸€ä¸ª é•¿åº¦è¾ƒå°çš„ slice</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">stack()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stack</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">s[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€ƒé€¸åˆ†æç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./main.go:12:6: can inline stack</span><br><span class="line">./main.go:3:6: can inline main</span><br><span class="line">./main.go:4:7: inlining call to stack</span><br><span class="line">./main.go:4:7: main make([]int, 10, 10) does not escape</span><br><span class="line">./main.go:13:11: stack make([]int, 10, 10) does not escape</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¾ç¤ºæœªé€ƒé€¸</p><p>ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè¶…å¤§çš„slice</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">stack()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stack</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">100000</span>, <span class="number">100000</span>)</span><br><span class="line">s[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€ƒé€¸åˆ†æç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./main.go:12:6: can inline stack</span><br><span class="line">./main.go:3:6: can inline main</span><br><span class="line">./main.go:4:7: inlining call to stack</span><br><span class="line">./main.go:4:7: make([]int, 100000, 100000) escapes to heap</span><br><span class="line">./main.go:13:11: make([]int, 100000, 100000) escapes to heap</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™å°±é€ƒé€¸åˆ°äº†å †ä¸Šäº†</p><h2 id="åŠ¨æ€ç±»å‹é€ƒé€¸"><a href="#åŠ¨æ€ç±»å‹é€ƒé€¸" class="headerlink" title="åŠ¨æ€ç±»å‹é€ƒé€¸"></a>åŠ¨æ€ç±»å‹é€ƒé€¸</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">dynamic()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dynamic</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€ƒé€¸åˆ†æç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./main.go:18:6: can inline dynamic</span><br><span class="line">./main.go:3:6: can inline main</span><br><span class="line">./main.go:5:9: inlining call to dynamic</span><br><span class="line">./main.go:5:9: main i does not escape</span><br><span class="line">./main.go:20:2: i escapes to heap</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„åŠ¨æ€ç±»å‹é€ƒé€¸ï¼Œå…¶å®åœ¨ç†è§£äº†<code>interface{}</code>çš„å†…éƒ¨ç»“æ„åï¼Œè¿˜æ˜¯å¯ä»¥å½’å¹¶åˆ° <strong>æŒ‡é’ˆé€ƒé€¸</strong> è¿™ä¸€ç±»çš„ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹ <a href="https://tyloafer.github.io/posts/2647/">ã€Šæ·±å…¥ç†è§£Goçš„interfaceã€‹</a></p><h2 id="é—­åŒ…å¼•ç”¨é€ƒé€¸"><a href="#é—­åŒ…å¼•ç”¨é€ƒé€¸" class="headerlink" title="é—­åŒ…å¼•ç”¨é€ƒé€¸"></a>é—­åŒ…å¼•ç”¨é€ƒé€¸</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f := fibonacci()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">f()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">a, b := <span class="number">0</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">a, b = b, a+b</span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€ƒé€¸åˆ†æç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./main.go:11:9: can inline fibonacci.func1</span><br><span class="line">./main.go:11:9: func literal escapes to heap</span><br><span class="line">./main.go:11:9: func literal escapes to heap</span><br><span class="line">./main.go:12:10: &amp;b escapes to heap</span><br><span class="line">./main.go:10:5: moved to heap: b</span><br><span class="line">./main.go:12:13: &amp;a escapes to heap</span><br><span class="line">./main.go:10:2: moved to heap: a</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://my.oschina.net/renhc/blog/2222104" target="_blank" rel="noopener">ã€ŠGo é€ƒé€¸åˆ†æã€‹</a></p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Goå­¦ä¹ ä¹‹Channelçš„ä¸€äº›æ¨¡å¼</title>
      <link href="/posts/30113/"/>
      <url>/posts/30113/</url>
      
        <content type="html"><![CDATA[<p>é™¤äº†åœ¨goroutineä¹‹é—´å®‰å…¨çš„ä¼ é€’æ•°æ®ä¹‹å¤–ï¼Œåœ¨çœ‹äº†ã€ŠConcurrency in Goã€‹ä¹‹åï¼Œæ„Ÿæ…¨channelè¿˜æœ‰é‚£ä¹ˆå¤šæ¨¡å¼å¯ä¾›ä½¿ç”¨ï¼Œåœ¨ä¸ªäººçš„å­¦ä¹ ä¸­æ€»ç»“äº†ä»¥ä¸‹å‡ ç§å¸¸ç”¨çš„æ¨¡å¼</p><a id="more"></a><h1 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>æˆ‘ä»¬ä»¥çˆ¬è™«ä¸ºä¾‹ï¼Œä¸€èˆ¬çˆ¬è™«åˆ†ä¸ºå¦‚ä¸‹æ­¥éª¤ï¼š</p><p>æŠ“å–é¡µé¢ -&gt; è§£æé¡µé¢ -&gt; æ•´åˆæ•°æ®åˆ†æ -&gt; åˆ†æç»“æœå…¥åº“</p><p>å¦‚æœä½ æŠŠä¸Šé¢æ‰€æœ‰çš„æ­¥éª¤éƒ½æ”¾åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢å¤„ç†ï¼Œé‚£ä¼šæ˜¯å¤šéš¾çœ‹ï¼Œå¤šéš¾ä»¥ç»´æŠ¤ï¼Œä»è§£è€¦è§’åº¦è€ƒè™‘ï¼Œæˆ‘ä»¬å¯ä»¥èµ·å››ä¸ªè¿›ç¨‹ï¼Œåˆ†åˆ«æ‰¿æ‹…ä¸åŒçš„è§’è‰²ï¼Œä¾‹å¦‚ï¼Œè¿›ç¨‹1è´Ÿè´£æŠ“å–é¡µé¢ï¼Œ è¿›ç¨‹2è´Ÿè´£è§£æé¡µé¢ï¼Œç­‰ç­‰ï¼Œå„ä¸ªè¿›ç¨‹æ‹¿åˆ°ä¸€ä¸ªæ•°æ®åï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªè¿›ç¨‹æ¥å¤„ç†ï¼Œè¿™å°±æ˜¯pipelineçš„åŸºæœ¬æ€æƒ³ï¼Œæ¯ä¸ªè§’è‰²åªè´Ÿè´£å…³å¿ƒè‡ªå·±çš„ä¸œè¥¿</p><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p>ç»™å®šä¸€ä¸ªæ•°nï¼Œæ‰§è¡Œ (n<em>2 + 1) </em> 2çš„æ“ä½œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pipeline</span><span class="params">()</span></span> &#123;</span><br><span class="line">generator := <span class="function"><span class="keyword">func</span><span class="params">(done <span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, intergers ...<span class="keyword">int</span>)</span> &lt;-<span class="title">chan</span> <span class="title">int</span></span> &#123;</span><br><span class="line">inStream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(inStream)</span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> intergers &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-done:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">case</span> inStream &lt;- i:</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> inStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add := <span class="function"><span class="keyword">func</span><span class="params">(done &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, inStream &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, increment <span class="keyword">int</span>)</span> &lt;-<span class="title">chan</span> <span class="title">int</span></span> &#123;</span><br><span class="line">addInStream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(addInStream)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> inStream &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-done:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">case</span> addInStream &lt;- i + increment:</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> addInStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">multiply := <span class="function"><span class="keyword">func</span><span class="params">(done &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, inStream &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, increment <span class="keyword">int</span>)</span> &lt;-<span class="title">chan</span> <span class="title">int</span></span> &#123;</span><br><span class="line">multiplyInStream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(multiplyInStream)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> inStream &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-done:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">case</span> multiplyInStream &lt;- i * increment:</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> multiplyInStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(done)</span><br><span class="line">inStream := generator(done, []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;...)</span><br><span class="line">pipeline := multiply(done, add(done, multiply(done, inStream, <span class="number">2</span>), <span class="number">1</span>), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> pipeline &#123;</span><br><span class="line">fmt.Println(v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ‰‡å…¥æ‰‡å‡º"><a href="#æ‰‡å…¥æ‰‡å‡º" class="headerlink" title="æ‰‡å…¥æ‰‡å‡º"></a>æ‰‡å…¥æ‰‡å‡º</h1><p>åœ¨pipelineæ¨¡å‹ä¸­ï¼Œæ˜¯ä¸€ç§é«˜æ•ˆçš„æµå¼å¤„ç†ï¼Œä½†æ˜¯å‡å¦‚pipelineä¸­æœ‰a,b,cä¸‰ä¸ªç¯èŠ‚ï¼Œbç¯èŠ‚å¤„ç†çš„ç‰¹åˆ«æ…¢ï¼Œè¿™æ—¶å€™å°±ä¼šå½±å“åˆ°cç¯èŠ‚çš„å¤„ç†ï¼Œå¦‚æœå¢åŠ bç¯èŠ‚è¿›ç¨‹å¤„ç†çš„æ•°é‡ï¼Œä¹Ÿå°±å¯ä»¥å‡å¼±bç¯èŠ‚çš„æ…¢å¤„ç†å¯¹æ•´ä¸ªpipelineçš„å½±å“ï¼Œé‚£ä¹ˆa-&gt;å¤šä¸ªbçš„è¿‡ç¨‹å°±æ˜¯ <strong>æ‰‡å…¥</strong>ï¼Œ å¤šä¸ªbç¯èŠ‚è¾“å‡ºæ•°æ®åˆ°cç¯èŠ‚ï¼Œå°±æ˜¯<strong>æ‰‡å‡º</strong></p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FanInFanOut</span><span class="params">()</span></span> &#123;</span><br><span class="line">producer := <span class="function"><span class="keyword">func</span><span class="params">(intergers ...<span class="keyword">int</span>)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">inStream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(inStream)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> intergers &#123;</span><br><span class="line">time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">inStream &lt;- v</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> inStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fanIn := <span class="function"><span class="keyword">func</span><span class="params">(channels ...&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">multiplexStream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">multiplex := <span class="function"><span class="keyword">func</span><span class="params">(c &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> c &#123;</span><br><span class="line">multiplexStream &lt;- i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wg.Add(<span class="built_in">len</span>(channels))</span><br><span class="line"><span class="keyword">for</span> _, c := <span class="keyword">range</span> channels &#123;</span><br><span class="line"><span class="keyword">go</span> multiplex(c)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="built_in">close</span>(multiplexStream)</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> multiplexStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">consumer := <span class="function"><span class="keyword">func</span><span class="params">(inStream &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> inStream &#123;</span><br><span class="line">fmt.Println(v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nums := runtime.NumCPU()</span><br><span class="line">producerStreams := <span class="built_in">make</span>([]&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, nums)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; nums; i++ &#123;</span><br><span class="line">producerStreams[i] = producer(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">consumer(fanIn(producerStreams...))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="tee-channel"><a href="#tee-channel" class="headerlink" title="tee- channel"></a>tee- channel</h1><h2 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>å‡å¦‚ä½ ä»channelä¸­æ‹¿åˆ°äº†ä¸€æ¡sqlè¯­å¥ï¼Œè¿™æ—¶å€™ï¼Œä½ æƒ³å¯¹è¿™æ¡sqlè®°å½•ï¼Œåˆ†æå¹¶æ‰§è¡Œï¼Œé‚£ä½ å°±éœ€è¦å°†è¿™æ¡sqlåˆ†åˆ«è½¬å‘ç»™è¿™ä¸‰ä¸ªä»»åŠ¡å¯¹åº”çš„channelï¼Œtee-channel å°±æ˜¯åšè¿™ä¸ªäº‹æƒ…çš„</p><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">teeChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">producer := <span class="function"><span class="keyword">func</span><span class="params">(intergers ...<span class="keyword">int</span>)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">inStream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(inStream)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> intergers &#123;</span><br><span class="line">inStream &lt;- v</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> inStream</span><br><span class="line">&#125;</span><br><span class="line">tee := <span class="function"><span class="keyword">func</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(_, _ &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">out1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">out2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(out1)</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(out2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> val := <span class="keyword">range</span> in &#123;</span><br><span class="line">out1, out2 := out1, out2</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> out1 &lt;- val:</span><br><span class="line">out1 = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> out2 &lt;- val:</span><br><span class="line">out2 = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> out1, out2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out1, out2 := tee(producer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line"><span class="keyword">for</span> val1 := <span class="keyword">range</span> out1 &#123;</span><br><span class="line">fmt.Printf(<span class="string">"out1: %v, out2: %v"</span>, val1, &lt;-out2)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ¡¥æ¥channel"><a href="#æ¡¥æ¥channel" class="headerlink" title="æ¡¥æ¥channel"></a>æ¡¥æ¥channel</h1><h2 id="æ¦‚å¿µ-2"><a href="#æ¦‚å¿µ-2" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>æ— è®ºæ˜¯å‰é¢æåˆ°çš„<strong>pipeline</strong>è¿˜æ˜¯<strong>æ‰‡å…¥æ‰‡å‡º</strong>ï¼Œæ¯ä¸ªgoroutineéƒ½æ˜¯å¯¹ä¸€ä¸ªchannelè¿›è¡Œæ¶ˆè´¹ï¼Œä½†æ˜¯å®é™…åœºæ™¯ä¸­ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªchannelæ¥ä¾›ç»™æˆ‘ä»¬æ¶ˆè´¹ï¼Œè€Œä½œä¸ºæ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒè¿™äº›å€¼æ˜¯æ¥è‡ªäºå“ªä¸ªchannelï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¤„ç†ä¸€ä¸ªå……æ»¡channelçš„channelå¯èƒ½ä¼šå¾ˆå¤šã€‚å¦‚æœæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥å°†å……æ»¡channelçš„channelæ‹†è§£ä¸ºä¸€ä¸ªç®€å•çš„channelï¼Œè¿™å°†ä½¿æ¶ˆè´¹è€…æ›´ä¸“æ³¨äºæ‰‹å¤´çš„å·¥ä½œï¼Œè¿™å°±æ˜¯<strong>æ¡¥æ¥channel</strong>çš„æ€æƒ³</p><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bridge</span><span class="params">()</span></span> &#123;</span><br><span class="line">gen := <span class="function"><span class="keyword">func</span><span class="params">()</span> &lt;-<span class="title">chan</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">in := <span class="built_in">make</span>(<span class="keyword">chan</span> (&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;))</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(in)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">stream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">stream &lt;- i</span><br><span class="line"><span class="built_in">close</span>(stream)</span><br><span class="line">in &lt;- stream</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> in</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bridge := <span class="function"><span class="keyword">func</span><span class="params">(in &lt;-<span class="keyword">chan</span> (&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span>) &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">valStream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(valStream)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">stream := <span class="built_in">make</span>(&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> maybeStream, ok := &lt;-in:</span><br><span class="line"><span class="keyword">if</span> ok == <span class="literal">false</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">stream = maybeStream</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> val := <span class="keyword">range</span> stream &#123;</span><br><span class="line">valStream &lt;- val</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> valStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> val := <span class="keyword">range</span> bridge(gen()) &#123;</span><br><span class="line">fmt.Println(val)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Goå­¦ä¹ ä¹‹Channelæ€»ç»“</title>
      <link href="/posts/30283/"/>
      <url>/posts/30283/</url>
      
        <content type="html"><![CDATA[<p>Channelæ˜¯Goä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç±»å‹ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ä¸ªç®¡é“ï¼Œé€šè¿‡å®ƒå¹¶å‘æ ¸å¿ƒå•å…ƒå°±å¯ä»¥å‘é€æˆ–è€…æ¥æ”¶æ•°æ®è¿›è¡Œé€šè®¯(communication)ã€‚</p><a id="more"></a><h1 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h1><p>Tè¡¨ç¤ºä»»æ„çš„ä¸€ç§ç±»å‹</p><ul><li>åŒå‘: chan T</li><li>å•å‘ä»…å‘é€ï¼š chan &lt;-</li><li>å•å‘ä»…æ¥å—ï¼š &lt;- chan</li></ul><p>å•å‘çš„channelï¼Œä¸ä»…å¯ä»¥é€šè¿‡å£°æ˜<code>make(chan &lt;- interface{})</code> æ¥åˆ›å»ºï¼Œè¿˜å¯ä»¥é€šè¿‡éšèº«æˆ–æ˜¾ç¤ºçš„é€šè¿‡ <code>chan</code> æ¥è½¬æ¢ï¼Œå¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">convert(channel)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">convert</span><span class="params">(channel <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>convertå‡½æ•°ä¸­ï¼Œå°±å¯ä»¥å§channelå½“æˆå•å‘è¾“å…¥ç®¡é“æ¥ä½¿ç”¨äº†</code></p><p>æ—¢ç„¶ åŒå‘ chanï¼Œæ—¢å¯ä»¥æ¥æ”¶ï¼Œä¹Ÿå¯ä»¥å‘é€ï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šæœ‰å•å‘chançš„å­˜åœ¨ï¼Ÿ æˆ‘çš„ä¸€ä¸ªç†è§£ä¾¿æ˜¯ <strong>æƒé™æ”¶æ•›</strong>ï¼Œä¾‹å¦‚ä¸€ä¸ªçˆ¬è™«ç³»ç»Ÿä¸­ï¼Œæœ‰äº›è¿›ç¨‹aä»…ä»…è´Ÿè´£æŠ“å–é¡µé¢å†…å®¹ï¼Œå¹¶è½¬å‘ç»™è¿›ç¨‹bï¼Œé‚£è¿›ç¨‹aä»…éœ€è¦ <code>å•å‘å‘é€çš„chan</code> å³å¯</p><h1 id="Blocking"><a href="#Blocking" class="headerlink" title="Blocking"></a>Blocking</h1><p>ç¼ºçœæƒ…å†µä¸‹ï¼Œå‘é€chanæˆ–æ¥æ”¶chanä¼šä¸€ç›´é˜»å¡ç€ï¼Œç›´åˆ°å¦ä¸€æ–¹å‡†å¤‡å¥½ã€‚è¿™ç§æ–¹å¼å¯ä»¥ç”¨æ¥åœ¨gororutineä¸­è¿›è¡ŒåŒæ­¥ï¼Œè€Œä¸å¿…ä½¿ç”¨æ˜¾ç¤ºçš„é”æˆ–è€…æ¡ä»¶å˜é‡ã€‚</p><p>å¦‚å®˜æ–¹çš„ä¾‹å­ä¸­<code>x, y := &lt;-c, &lt;-c</code>è¿™å¥ä¼šä¸€ç›´ç­‰å¾…è®¡ç®—ç»“æœå‘é€åˆ°channelä¸­ã€‚ä»¥ä¸‹é¢ä¾‹å­çœ‹ä¸€ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bufferChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"start goroutine %d\n"</span>, i)â‘ </span><br><span class="line">channel &lt;- i</span><br><span class="line">fmt.Printf(<span class="string">"send %d to channel\n"</span>, i)â‘¡</span><br><span class="line">&#125;(i)</span><br><span class="line">time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">fmt.Println(<span class="string">"sleep 2 second"</span>)</span><br><span class="line">value := &lt;-channelâ‘¢</span><br><span class="line">fmt.Println(<span class="string">"got "</span>, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start goroutine 0</span><br><span class="line">sleep 2 second</span><br><span class="line">got  0</span><br><span class="line">send 0 to channel</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œ<code>go func</code> æ‰§è¡Œåˆ°äº†â‘ åå¹¶æ²¡æœ‰ç»§ç»­æ‰§è¡Œâ‘¡ï¼Œè€Œæ˜¯ç­‰å¾…â‘¢æ‰§è¡Œå®Œæˆåï¼Œå†å»æ‰§è¡Œâ‘¡ï¼Œä¹Ÿå°±å¯ä»¥è¯´æ˜ <code>channel &lt;- i</code> é˜»å¡äº†<code>goroutine</code>çš„ç»§ç»­æ‰§è¡Œ</p><p>å¦‚æœï¼Œæˆ‘ä¸æƒ³åœ¨è¿™é‡Œé˜»å¡ï¼Œè€Œæ˜¯æˆ‘ç›´æ¥æŠŠæ•°æ®æ”¾åˆ°<code>channel</code>é‡Œï¼Œç­‰æ¥æ”¶æ–¹å‡†å¤‡å¥½åï¼Œåˆ°<code>channel</code>ä¸­è‡ªå–è‡ªç”¨å¦‚ä½•å¤„ç†ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°äº†å¦ä¸€ä¸ªæ¦‚å¿µ <strong>buffered channel</strong></p><h1 id="buffered-channel"><a href="#buffered-channel" class="headerlink" title="buffered channel"></a>buffered channel</h1><p>æˆ‘ä»¬æŠŠç¨‹åºä¿®æ”¹ä¸€ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bufferChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>) <span class="comment">// è¿™é‡ŒåŠ äº†ä¸ªå‚æ•°</span></span><br><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"start goroutine %d\n"</span>, i)â‘ </span><br><span class="line">channel &lt;- i</span><br><span class="line">fmt.Printf(<span class="string">"send %d to channel\n"</span>, i)â‘¡</span><br><span class="line">&#125;(i)</span><br><span class="line">time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">fmt.Println(<span class="string">"sleep 2 second"</span>)</span><br><span class="line">value := &lt;-channelâ‘¢</span><br><span class="line">fmt.Println(<span class="string">"got "</span>, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start goroutine 0</span><br><span class="line">send 0 to channel</span><br><span class="line">sleep 2 second</span><br><span class="line">got  0</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°<code>go func</code>æ‰§è¡Œå®Œâ‘ ä¹‹åå°±æ‰§è¡Œäº†â‘¡ï¼Œå¹¶æ²¡æœ‰ç­‰å¾…â‘¢çš„æ‰§è¡Œç»“æŸï¼Œè¿™å°±æ˜¯<strong>buffered channel</strong>çš„æ•ˆæœäº†</p><p>æˆ‘ä»¬åªéœ€è¦åœ¨makeçš„æ—¶å€™ï¼Œå£°æ˜åº•2ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯chançš„ç¼“å†²åŒºå¤§å°å³å¯</p><p>é€šè¿‡ä¸Šé¢çš„ç¨‹åºå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨â‘¢çš„å½¢æˆï¼Œå³<code>&lt;- chan</code>æ¥è¯»å–chanä¸­çš„æ•°æ®ï¼Œä½†æ˜¯å¦‚æœæœ‰å¤šä¸ªgoroutineåœ¨åŒæ—¶åƒä¸€ä¸ªchanå†™æ•°æ®ï¼Œæˆ‘ä»¬é™¤äº†ä½¿ç”¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">value &lt;- <span class="keyword">chan</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä»€ä¹ˆæ›´ä¼˜é›…çš„æ–¹å¼å—</p><h1 id="for-â€¦-range"><a href="#for-â€¦-range" class="headerlink" title="for â€¦ range"></a>for â€¦ range</h1><p>è¿˜æ˜¯ä¸Šé¢é‚£ä¸ªç¨‹åºï¼Œæˆ‘ä»¬ä½¿ç”¨ <em>for â€¦ range</em> è¿›è¡Œä¸€ä¸‹æ”¹é€ </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bufferChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">   channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">   i := <span class="number">0</span></span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">"start goroutine %d\n"</span>, i)</span><br><span class="line">      channel &lt;- i</span><br><span class="line">      fmt.Printf(<span class="string">"send %d to channel\n"</span>, i)</span><br><span class="line">   &#125;(i)</span><br><span class="line">   time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">   fmt.Println(<span class="string">"sleep 2 second"</span>)</span><br><span class="line">   <span class="keyword">for</span> value := <span class="keyword">range</span> channel &#123;</span><br><span class="line">      fmt.Println(<span class="string">"got "</span>, value)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> è¿™æ ·å°±å¯ä»¥éå† <code>channel</code> ä¸­çš„æ•°æ®äº†ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¿è¡Œçš„æ—¶å€™å°±ä¼šå‘ç°ï¼Œå“ è¿™ä¸ªç¨‹åºæ€ä¹ˆåœä¸ä¸‹æ¥äº†ï¼Ÿ<code>range channel</code>äº§ç”Ÿçš„è¿­ä»£å€¼ä¸ºChannelä¸­å‘é€çš„å€¼ï¼Œå®ƒä¼šä¸€ç›´è¿­ä»£ç›´åˆ°channelè¢«å…³é—­ï¼Œæ‰€ä»¥ æˆ‘ä»¬<code>goroutine</code>å‘é€å®Œæ•°æ®åï¼ŒæŠŠ<code>channel</code>å…³é—­ä¸€ä¸‹è¯•è¯•ï¼Œè¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬ä¸å†è¿›è¡Œ<code>time.Sleep(2 * time.Second)</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bufferChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">   channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">   i := <span class="number">0</span></span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">"start goroutine %d\n"</span>, i)</span><br><span class="line">      channel &lt;- i</span><br><span class="line">      fmt.Printf(<span class="string">"send %d to channel\n"</span>, i)</span><br><span class="line">      <span class="built_in">close</span>(channel)</span><br><span class="line">   &#125;(i)</span><br><span class="line">   <span class="keyword">for</span> value := <span class="keyword">range</span> channel &#123;</span><br><span class="line">      fmt.Println(<span class="string">"got "</span>, value)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæ•´ä¸ªç¨‹åºå°±å¯ä»¥æ­£å¸¸é€€å‡ºäº†ï¼Œæ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨<code>range</code>çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œå¦‚æœ<code>channel</code>ä¸å…³é—­ï¼Œåˆ™<code>range</code>ä¼šä¸€ç›´é˜»å¡åœ¨è¿™é‡Œçš„</p><h1 id="select"><a href="#select" class="headerlink" title="select"></a>select</h1><p>æˆ‘ä»¬ä¸Šé¢è®²çš„ä¸€ç›´éƒ½æ˜¯åªæœ‰ä¸€ä¸ª<code>channel</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»åšï¼ŒåŠ å…¥æœ‰ä¸¤ä¸ª<code>channel</code>æˆ–è€…æ›´å¤šçš„<code>channel</code>ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»åšï¼Œè¿™é‡Œå°±ä»‹ç»ä¸€ä¸‹ goé‡Œé¢çš„å¤šè·¯å¤ç”¨ <code>select</code>ï¼Œä»¥ä¸‹é¢ç¨‹åºä¸ºä¾‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">example</span><span class="params">()</span></span> &#123;</span><br><span class="line">tick := time.Tick(time.Second)</span><br><span class="line">after := time.After(<span class="number">3</span> * time.Second)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-tick:</span><br><span class="line">fmt.Println(<span class="string">"tick 1 second"</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-after:</span><br><span class="line">fmt.Println(<span class="string">"after 3 second"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">"come into default"</span>)</span><br><span class="line">time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>time.Tick</code>æ˜¯goçš„timeåŒ…æä¾›çš„ä¸€ä¸ªå®šæ—¶å™¨çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ª<code>channel</code>ï¼Œå¹¶åœ¨æŒ‡å®šæ—¶é—´é—´éš”å†…ï¼Œå‘channelå‘é€ä¸€æ¡æ•°æ®,<code>time.Tick(time.Second)</code>å°±æ˜¯æ¯ç§’é’Ÿå‘è¿™ä¸ªchannelå‘é€ä¸€ä¸ªæ•°æ®</p><p><code>time.After</code>æ˜¯goçš„timeåŒ…æä¾›çš„ä¸€ä¸ªå®šæ—¶å™¨çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ª<code>channel</code>ï¼Œå¹¶åœ¨æŒ‡å®šæ—¶é—´é—´éš”åï¼Œå‘channelå‘é€ä¸€æ¡æ•°æ®ï¼Œ<code>time.After(3 * time.Second)</code>å°±æ˜¯3såå‘è¿™ä¸ªchannelå‘é€ä¸€ä¸ªæ•°æ®</p><p>è¾“å‡ºç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">come into default</span><br><span class="line">come into default</span><br><span class="line">tick 1 second</span><br><span class="line">come into default</span><br><span class="line">come into default</span><br><span class="line">tick 1 second</span><br><span class="line">come into default</span><br><span class="line">come into default</span><br><span class="line">tick 1 second</span><br><span class="line">after 3 second</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>select</code>ä¼šé€‰æ‹©ä¸€ä¸ªæ²¡æœ‰é˜»å¡çš„ <code>channel</code>ï¼Œå¹¶æ‰§è¡Œå“åº” <code>case</code>ä¸‹çš„é€»è¾‘ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ç”±äºä¸€ä¸ª <code>channel</code>é˜»å¡è€Œå¯¼è‡´åç»­çš„é€»è¾‘é˜»å¡çš„æƒ…å†µäº†</p><p>æˆ‘ä»¬ç»§ç»­åšä¸ªå°å®éªŒï¼ŒæŠŠä¸Šé¢å…³é—­çš„<code>channel</code>æ”¾åˆ° <code>select</code>é‡Œé¢è¯•ä¸€ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">example</span><span class="params">()</span></span> &#123;</span><br><span class="line">tick := time.Tick(time.Second)</span><br><span class="line">after := time.After(<span class="number">3</span> * time.Second)</span><br><span class="line">channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">channel &lt;- <span class="number">1</span></span><br><span class="line"><span class="built_in">close</span>(channel)</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-tick:</span><br><span class="line">fmt.Println(<span class="string">"tick 1 second"</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-after:</span><br><span class="line">fmt.Println(<span class="string">"after 3 second"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">case</span> value := &lt;- channel:</span><br><span class="line">fmt.Println(<span class="string">"got"</span>, value)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">"come into default"</span>)</span><br><span class="line">time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">got 0</span><br><span class="line">got 0</span><br><span class="line">got 0</span><br><span class="line">got 0</span><br><span class="line">got 0</span><br><span class="line">after 3 second</span><br></pre></td></tr></table></figure><p>ç®€ç›´æ˜¯è½¦ç¥¸ç°åœºï¼Œå¹¸å¥½è®¾ç½®äº†3sä¸»åŠ¨é€€å‡ºï¼Œé‚£caseçš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰åŠæ³•åˆ¤æ–­è¿™ä¸ªchannelæ˜¯å¦å…³é—­äº†å‘¢ï¼Œå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œçœ‹ä¸‹é¢çš„ç¨‹åº</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">example</span><span class="params">()</span></span> &#123;</span><br><span class="line">tick := time.Tick(time.Second)</span><br><span class="line">after := time.After(<span class="number">3</span> * time.Second)</span><br><span class="line">channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">channel &lt;- <span class="number">1</span></span><br><span class="line"><span class="built_in">close</span>(channel)</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-tick:</span><br><span class="line">fmt.Println(<span class="string">"tick 1 second"</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-after:</span><br><span class="line">fmt.Println(<span class="string">"after 3 second"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">case</span> value, ok := &lt;- channel:</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">fmt.Println(<span class="string">"got"</span>, value)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"channel is closed"</span>)</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">"come into default"</span>)</span><br><span class="line">time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">come into default</span><br><span class="line">got 1</span><br><span class="line">channel is closed</span><br><span class="line">tick 1 second</span><br><span class="line">channel is closed</span><br><span class="line">channel is closed</span><br><span class="line">after 3 second</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šå¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡ <code>value, ok := &lt;- channel</code> è¿™ç§å½¢å¼ï¼Œokè·å–çš„å°±æ˜¯ç”¨æ¥åˆ¤æ–­channel</p><p>æ˜¯å¦å…³é—­çš„ï¼Œokä¸º trueï¼Œè¡¨ç¤ºchannelæ­£å¸¸ï¼Œå¦åˆ™ï¼Œchannelå°±æ˜¯å…³é—­çš„</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨Vultrï¼ˆcentos7ï¼‰ä¸Šå®‰è£…V2ray æ›´ç§‘å­¦çš„ä¸Šç½‘</title>
      <link href="/posts/57533/"/>
      <url>/posts/57533/</url>
      
        <content type="html"><![CDATA[<p>è¿‘æœŸssçš„å­˜æ´»å‘¨æœŸè¶Šæ¥è¶ŠçŸ­äº†ï¼Œå…·ä½“ä»€ä¹ˆåŸå› ï¼Œå’±ä¹Ÿä¸çŸ¥é“ï¼Œå’±ä¹Ÿä¸æ•¢é—®ï¼Œå’±åªèƒ½é€‰æ‹©å¦ä¸€ç§æ›´åŠ ç§‘å­¦çš„ä¸Šç½‘æ–¹å¼äº†ï¼Œè¿™é‡Œè¿˜æ˜¯æ¨èä¸€ä¸‹  <a href="https://www.vultr.com/?ref=7290537" target="_blank" rel="noopener">Vultrå®¶çš„VPS</a> ï¼Œæ¢IPæ–¹ä¾¿</p><a id="more"></a><h1 id="æœåŠ¡ç«¯å®‰è£…"><a href="#æœåŠ¡ç«¯å®‰è£…" class="headerlink" title="æœåŠ¡ç«¯å®‰è£…"></a>æœåŠ¡ç«¯å®‰è£…</h1><blockquote><p>Bash &lt;(curl -L -s <a href="https://install.direct/go.sh" target="_blank" rel="noopener">https://install.direct/go.sh</a>)</p></blockquote><p>æ‰§è¡Œå®Œä¸Šé¢çš„è„šæœ¬ï¼Œå°±ä¼šè¾“å‡ºå¦‚ä¸‹å®‰è£…çš„æç¤ºä¿¡æ¯äº†ï¼Œå…¶ä¸­<code>PORT</code>å’Œ<code>UUID</code> ä½¿æˆ‘ä»¬åé¢éœ€è¦ç”¨åˆ°çš„é…ç½®ä¿¡æ¯</p><p><img src="http://note-1253518569.cossh.myqcloud.com/20190613145405.png" alt="v2rayå®‰è£…"></p><p>ç„¶åé€šè¿‡<code>service v2ray start / stop /status</code>ï¼Œå°±å¯ä»¥è¿›è¡Œv2rayçš„å¯åœäº†</p><p>æ¥ä¸‹æ¥æ‰§è¡Œä»¥ä¸‹ä¸‹é¢å‘½ä»¤ï¼Œå¯ä»¥çœ‹å‡ºé…ç½®æ–‡ä»¶ä¸º <code>/etc/v2ray/config.json</code>ï¼Œ é‡Œé¢ä¹ŸåŒ…å«äº† <code>UUID</code>å’Œ<code>PORT</code>ç­‰ä¿¡æ¯</p><blockquote><p>ps aux | grep v2ray</p></blockquote><p><img src="http://note-1253518569.cossh.myqcloud.com/20190620190741.png" alt></p><h1 id="å®¢æˆ·ç«¯é…ç½®"><a href="#å®¢æˆ·ç«¯é…ç½®" class="headerlink" title="å®¢æˆ·ç«¯é…ç½®"></a>å®¢æˆ·ç«¯é…ç½®</h1><table><thead><tr><th style="text-align:center">é¡¹ç›®</th><th style="text-align:center">å€¼</th></tr></thead><tbody><tr><td style="text-align:center">ä¸»æœº/æœåŠ¡å™¨/åœ°å€</td><td style="text-align:center">æœåŠ¡å™¨ip</td></tr><tr><td style="text-align:center">ç«¯å£ port</td><td style="text-align:center">å›¾ä¸­çš„PORT</td></tr><tr><td style="text-align:center">ç”¨æˆ·ID</td><td style="text-align:center">å›¾ä¸­çš„UUID</td></tr><tr><td style="text-align:center">é¢å¤–ID AlterId</td><td style="text-align:center">64</td></tr><tr><td style="text-align:center">åŠ å¯†æ–¹å¼ security</td><td style="text-align:center">auto</td></tr><tr><td style="text-align:center">ç”¨æˆ·ç­‰çº§</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">ç½‘ç»œ/ä¼ è¾“åè®® network</td><td style="text-align:center">Tcp</td></tr><tr><td style="text-align:center">åŠ å¯†æ–¹å¼</td><td style="text-align:center">none</td></tr><tr><td style="text-align:center">Mux</td><td style="text-align:center">å¼€å¯</td></tr><tr><td style="text-align:center">è¿œç¨‹è·¯ç”±/DNS (å¯é€‰)</td><td style="text-align:center">1.1.1.1</td></tr><tr><td style="text-align:center">è·¯ç”±</td><td style="text-align:center">BifrsotV:ç»•è¿‡å±€åŸŸç½‘å’Œä¸­å›½å¤§é™†åœ°å€ä¸ç½‘ç«™;V2RayN:å‚æ•°è®¾ç½®-ç»•è¿‡ä¸­å›½å¤§é™†åœ°å€å’Œip(è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ç›´è¿å›½å†…ç½‘ç«™ï¼Œé™ä½å»¶è¿Ÿ)</td></tr></tbody></table><h1 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h1><h2 id="å®‰å“"><a href="#å®‰å“" class="headerlink" title="å®‰å“"></a>å®‰å“</h2><ul><li><a href="https://play.google.com/store/apps/details?id=com.github.dawndiy.bifrostv" target="_blank" rel="noopener">birfrostV</a>   æ¨èè¿™ä¸ªï¼Œv2rayNGå¯¹äºå¾ˆå¤šå›½å†…çš„ç½‘å€ï¼Œè¿˜æ˜¯ä¼šèµ°ä»£ç†</li><li><a href="https://play.google.com/store/apps/details?id=com.v2ray.ang" target="_blank" rel="noopener">v2rayNG</a></li></ul><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><p>ä»¥ä¸‹ä¸¤ä¸ªéƒ½éœ€è¦ä¸‹è½½</p><ul><li><a href="https://github.com/v2ray/v2ray-core/releases" target="_blank" rel="noopener">v2ray-core</a> ï¼Œç‚¹å‡»é“¾æ¥ï¼Œåˆ°githubä¸Šé€‰æ‹©è‡ªå·±çš„å¹³å°ç‰ˆæœ¬å³å¯</li><li><a href="https://github.com/2dust/v2rayN/releases/" target="_blank" rel="noopener">v2rayN</a> ç‚¹å‡»é“¾æ¥ï¼Œä¸‹è½½é‡Œé¢çš„<a href="https://github.com/2dust/v2rayN/releases/download/2.29/v2rayN.zip" target="_blank" rel="noopener">v2rayN.zip</a>å³å¯</li><li><a href="https://github.com/Cenmrev/V2RayW/releases" target="_blank" rel="noopener">v2rayW</a> ä¸‹è½½å‹ç¼©åŒ…å³å¯ï¼Œè¿™ä¸ªç¨‹åºä¼šä¸»åŠ¨å¸®åŠ©ä¸‹è½½ v2ray-core æ‰€ä»¥æ›´æ–¹ä¾¿ç‚¹ï¼Œç•Œé¢ä¹Ÿæ¯” v2rayN çœ‹ç€èˆ’æœ</li></ul><h1 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h1><ul><li><a href="https://github.com/v2ray/v2ray-core/releases" target="_blank" rel="noopener">v2ray-core</a> ï¼Œç‚¹å‡»é“¾æ¥ï¼Œåˆ°githubä¸Šé€‰æ‹©Macçš„å‹ç¼©åŒ…ï¼Œä¸‹è½½è§£å‹å°±å¯ä»¥äº†</li></ul>]]></content>
      
      
      <categories>
          
          <category> ç§‘å­¦ä¸Šç½‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç§‘å­¦ä¸Šç½‘ </tag>
            
            <tag> V2ray </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenTSDBæ¦‚è¿°</title>
      <link href="/posts/44478/"/>
      <url>/posts/44478/</url>
      
        <content type="html"><![CDATA[<p>OpenTSDB æ˜¯ä¸€ä¸ªæ—¶ç³»åˆ—æ•°æ®ï¼ˆåº“ï¼‰ï¼Œå®ƒåŸºäºHBaseå­˜å‚¨æ•°æ®ï¼Œå……åˆ†å‘æŒ¥äº†HBaseçš„åˆ†å¸ƒå¼åˆ—å­˜å‚¨ç‰¹æ€§ï¼Œæ”¯æŒæ•°ç™¾ä¸‡æ¯ç§’çš„è¯»å†™ï¼Œå®ƒçš„ç‰¹ç‚¹å°±æ˜¯å®¹æ˜“æ‰©å±•ï¼Œçµæ´»çš„tagæœºåˆ¶ã€‚</p><a id="more"></a><h2 id="å­˜å‚¨ç›¸å…³æ¦‚å¿µ"><a href="#å­˜å‚¨ç›¸å…³æ¦‚å¿µ" class="headerlink" title="å­˜å‚¨ç›¸å…³æ¦‚å¿µ"></a>å­˜å‚¨ç›¸å…³æ¦‚å¿µ</h2><p>ä¾‹ï¼šå‡è®¾æˆ‘ä»¬é‡‡é›†1ä¸ªæœåŠ¡å™¨ï¼ˆhostname=qatestï¼‰çš„CPUä½¿ç”¨ç‡ï¼Œå‘ç°è¯¥æœåŠ¡å™¨åœ¨21:00çš„æ—¶å€™ï¼ŒCPUä½¿ç”¨ç‡è¾¾åˆ°99%</p><ul><li><p>Metricï¼šå³å¹³æ—¶æˆ‘ä»¬æ‰€è¯´çš„ç›‘æ§é¡¹ã€‚è­¬å¦‚ä¸Šé¢çš„CPUä½¿ç”¨ç‡</p></li><li><p>Tagsï¼šå°±æ˜¯ä¸€äº›æ ‡ç­¾ï¼Œåœ¨OpenTSDBé‡Œé¢ï¼ŒTagsç”±tagkå’Œtagvç»„æˆï¼Œå³tagk=takvã€‚æ ‡ç­¾æ˜¯ç”¨æ¥æè¿°Metricçš„ï¼Œè­¬å¦‚ä¸Šé¢ä¸ºäº†æ ‡è®°æ˜¯æœåŠ¡å™¨Açš„CpuUsageï¼Œtagså¯ä¸ºhostname=qatest</p></li><li><p>Valueï¼šä¸€ä¸ªValueè¡¨ç¤ºä¸€ä¸ªmetricçš„å®é™…æ•°å€¼ï¼Œè­¬å¦‚ä¸Šé¢çš„99%</p></li><li><p>Timestampï¼šå³æ—¶é—´æˆ³ï¼Œç”¨æ¥æè¿°Valueæ˜¯ä»€ä¹ˆæ—¶å€™çš„ï¼Œè­¬å¦‚ä¸Šé¢çš„21:00</p></li><li><p>Data Pointï¼šå³æŸä¸ªMetricåœ¨æŸä¸ªæ—¶é—´ç‚¹çš„æ•°å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Data PointåŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼šMetricã€Tagsã€Valueã€Timestamp</span><br></pre></td></tr></table></figure><p>   ä¸Šé¢æè¿°çš„æœåŠ¡å™¨åœ¨21:00æ—¶å€™çš„cpuä½¿ç”¨ç‡ï¼Œå°±æ˜¯1ä¸ªDataPoint</p></li></ul><h2 id="æŸ¥è¯¢ç»„ä»¶"><a href="#æŸ¥è¯¢ç»„ä»¶" class="headerlink" title="æŸ¥è¯¢ç»„ä»¶"></a>æŸ¥è¯¢ç»„ä»¶</h2><table><thead><tr><th>å‚æ•°</th><th>æ•°æ®ç±»å‹</th><th>Required</th><th>æè¿°</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>Start Time</td><td>Stringæˆ–Integer</td><td>Required</td><td>æŸ¥è¯¢çš„å¼€å§‹æ—¶é—´ã€‚å¯ä»¥æ˜¯ç»å¯¹æ—¶é—´æˆ–ç›¸å¯¹æ—¶é—´</td><td>24h-ago</td></tr><tr><td>End Time</td><td>Stringæˆ–Integer</td><td>Optional</td><td>æŸ¥è¯¢çš„ç»“æŸæ—¶é—´ã€‚å¦‚æœæœªæä¾›ç»“æŸæ—¶é—´ï¼Œåˆ™å½“å‰æ—¶é—´å³ç»“æŸæ—¶é—´</td><td>1h-ago</td></tr><tr><td>Metric</td><td>String</td><td>Required</td><td>ç³»ç»Ÿä¸­çš„metricå…¨åã€‚å¿…é¡»æ˜¯å…¨åå¹¶ä¸”å¤§å°å†™æ•æ„Ÿ</td><td>sys.cpu.user</td></tr><tr><td>Aggregation Function</td><td>String</td><td>Required</td><td>ç”¨äºç»„åˆå¤šä¸ªæ—¶é—´åºåˆ—çš„æ•°å­¦å‡½æ•°ï¼ˆå³å¦‚ä½•åˆå¹¶ä¸€ä¸ªç»„ä¸­çš„æ—¶é—´åºåˆ—å€¼ï¼‰</td><td>sum</td></tr><tr><td>Filter</td><td>String</td><td>Optional</td><td>è¿‡æ»¤æ ‡ç­¾å€¼ä»¥å‡å°‘æŸ¥è¯¢æˆ–ç»„ä¸­æŒ‘é€‰å‡ºçš„æ—¶é—´åºåˆ—çš„æ•°é‡ï¼Œå¹¶èšåˆå„ä¸ªæ ‡ç­¾</td><td>host=*,dc=lax</td></tr><tr><td>Downsampler</td><td>String</td><td>Optional</td><td>å¯é€‰çš„æ—¶é—´é—´éš”å’Œå‡½æ•°ï¼Œç”¨äºå‡å°‘éšæ—¶é—´è¿”å›çš„æ•°æ®ç‚¹çš„æ•°é‡</td><td>1h-avg</td></tr><tr><td>Rate</td><td>String</td><td>Optional</td><td>ç”¨äºè®¡ç®—ç»“æœçš„æ¯ç§’å˜åŒ–ç‡</td><td>rate</td></tr><tr><td>Functions</td><td>String</td><td>Optional</td><td>æ•°æ®å¤„ç†å‡½æ•°ï¼Œå¦‚é™„åŠ è¿‡æ»¤ã€æ—¶é—´åˆ‡æ¢ç­‰</td><td>highestMax(â€¦)</td></tr><tr><td>Expressions</td><td>String</td><td>Optional</td><td>æ•°æ®å¤„ç†å‡½æ•°ï¼Œä¾‹å¦‚å°†ä¸€ä¸ªåºåˆ—åˆ†åŒ–æˆå¦ä¸€ä¸ªåºåˆ—</td><td>(m2/(m1 + m2))*100</td></tr></tbody></table><h3 id="Aggregation-èšåˆ"><a href="#Aggregation-èšåˆ" class="headerlink" title="Aggregation(èšåˆ)"></a>Aggregation(èšåˆ)</h3><table><thead><tr><th>èšåˆå™¨</th><th>TSDç‰ˆæœ¬</th><th>æè¿°</th><th>æ’å€¼</th></tr></thead><tbody><tr><td>avg</td><td>1.0</td><td>æ•°æ®ç‚¹å¹³å‡å€¼</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>count</td><td>2.2</td><td>é›†åˆä¸­åŸå§‹æ•°æ®ç‚¹çš„æ•°é‡</td><td>0æ›¿æ¢ç¼ºå¤±å€¼</td></tr><tr><td>dev</td><td>1.0</td><td>è®¡ç®—æ ‡å‡†å·®</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep50r3</td><td>2.2</td><td>ä½¿ç”¨R-3æ–¹æ³•è®¡ç®—ä¼°è®¡çš„50%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep50r7</td><td>2.2</td><td>ä½¿ç”¨R-7æ–¹æ³•è®¡ç®—ä¼°è®¡çš„50%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep75r3</td><td>2.2</td><td>ä½¿ç”¨R-3æ–¹æ³•è®¡ç®—ä¼°è®¡çš„75%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep75r7</td><td>2.2</td><td>ä½¿ç”¨R-7æ–¹æ³•è®¡ç®—ä¼°è®¡çš„75%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep90r3</td><td>2.2</td><td>ä½¿ç”¨R-3æ–¹æ³•è®¡ç®—ä¼°è®¡çš„90%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep90r7</td><td>2.2</td><td>ä½¿ç”¨R-7æ–¹æ³•è®¡ç®—ä¼°è®¡çš„90%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep95r3</td><td>2.2</td><td>ä½¿ç”¨R-3æ–¹æ³•è®¡ç®—ä¼°è®¡çš„95%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep95r7</td><td>2.2</td><td>ä½¿ç”¨R-7æ–¹æ³•è®¡ç®—ä¼°è®¡çš„95%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep99r3</td><td>2.2</td><td>ä½¿ç”¨R-3æ–¹æ³•è®¡ç®—ä¼°è®¡çš„99%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep99r7</td><td>2.2</td><td>ä½¿ç”¨R-7æ–¹æ³•è®¡ç®—ä¼°è®¡çš„99%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep999r3</td><td>2.2</td><td>ä½¿ç”¨R-3æ–¹æ³•è®¡ç®—ä¼°è®¡çš„999%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>Ep999r7</td><td>2.2</td><td>ä½¿ç”¨R-7æ–¹æ³•è®¡ç®—ä¼°è®¡çš„999%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>first</td><td>2.3</td><td>è¿”å›é›†åˆä¸­çš„ç¬¬ä¸€ä¸ªæ•°æ®ç‚¹ã€‚ä»…ä»…å¯¹é™é‡‡æ ·æœ‰ç”¨ï¼Œå¯¹èšåˆæ— ç”¨</td><td>ä¸å®š</td></tr><tr><td>last</td><td>2.3</td><td>è¿”å›é›†åˆä¸­çš„æœ€åä¸€ä¸ªæ•°æ®ç‚¹ã€‚ä»…ä»…å¯¹é™é‡‡æ ·æœ‰ç”¨ï¼Œå¯¹èšåˆæ— ç”¨</td><td>ä¸å®š</td></tr><tr><td>mimmin</td><td>2.0</td><td>ç­›é€‰æœ€å°çš„æ•°æ®ç‚¹</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>mimmax</td><td>2.0</td><td>ç­›é€‰æœ€å¤§çš„æ•°æ®ç‚¹</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>min</td><td>1.0</td><td>ç­›é€‰æœ€å°çš„æ•°æ®ç‚¹</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>max</td><td>1.0</td><td>ç­›é€‰æœ€å¤§çš„æ•°æ®ç‚¹</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>none</td><td>2.3</td><td>é€šè¿‡æ‰€æœ‰æ—¶é—´åºåˆ—çš„èšåˆè·³è¿‡ç»„</td><td>0æ›¿æ¢ç¼ºå¤±å€¼</td></tr><tr><td>p50</td><td>2.3</td><td>è®¡ç®—50%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>p75</td><td>2.3</td><td>è®¡ç®—75%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>p90</td><td>2.3</td><td>è®¡ç®—90%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>p95</td><td>2.3</td><td>è®¡ç®—95%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>p99</td><td>2.3</td><td>è®¡ç®—99%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>p999</td><td>2.3</td><td>è®¡ç®—999%</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>sum</td><td>1.0</td><td>å°†æ•°æ®ç‚¹ä¸€èµ·æ±‚å’Œ</td><td>çº¿æ€§æ’å€¼</td></tr><tr><td>zimsum</td><td>1.0</td><td>å°†æ•°æ®ç‚¹ä¸€èµ·æ±‚å’Œ</td><td>0æ›¿æ¢ç¼ºå¤±å€¼</td></tr></tbody></table><h3 id="Functions-å‡½æ•°"><a href="#Functions-å‡½æ•°" class="headerlink" title="Functions(å‡½æ•°)"></a>Functions(å‡½æ•°)</h3><h4 id="Bosunè¯­æ³•"><a href="#Bosunè¯­æ³•" class="headerlink" title="Bosunè¯­æ³•"></a>Bosunè¯­æ³•</h4><ul><li><p>q(query string, startDuration string, endDuration string) seriesSet *</p></li><li><p>band(query string, duration string, period string, num scalar) seriesSet *</p></li><li><p>over(query string, duration string, period string, num scalar) seriesSet *</p></li><li><p>change(query string, startDuration string, endDuration string) numberSet *</p></li><li><p>count(query string, startDuration string, endDuration string) scalar *</p></li><li><p>window(query string, duration string, period string, num scalar, funcName string) seriesSet *</p></li><li><p>avg(seriesSet) numberSet<br>å–æ•°æ®é›†çš„å¹³å‡å€¼</p></li><li><p>sum(seriesSet) numberSet<br>æ±‚å’Œ</p></li><li><p>cCount(seriesSet) numberSet<br>æ•°æ®é›†çš„å˜åŒ–ç¨‹åº¦ï¼Œæ ¹æ®æ¯ä¸ªæ•°æ®ä¸å®ƒå‰ä¸€ä¸ªæ•°æ®çš„æ¯”è¾ƒå¾—å‡ºã€‚ä¾‹å¦‚ï¼Œæ•°æ®é›†cCount([0,1,0,1])è¿”å›3</p></li><li><p>dev(seriesSet) numberSet<br>æ ‡å‡†å·®</p></li><li><p>diff(seriesSet) numberSet<br>æœ€åä¸€ä¸ªæ•°å‡å»ç¬¬ä¸€ä¸ªæ•°çš„å·®å€¼</p></li><li><p>first(seriesSet) numberSet<br>æ•°æ®é›†çš„ç¬¬ä¸€ä¸ªæ•°æ®</p></li><li><p>last(seriesSet) numberSet<br>æ•°æ®é›†çš„æœ€åä¸€ä¸ªæ•°æ®</p></li><li><p>len(seriesSet) numberSet<br>æ•°æ®é›†çš„é•¿åº¦</p></li><li><p>max(seriesSet) numberSet<br>æœ€å¤§å€¼</p></li><li><p>median(seriesSet) numberSet<br>ä¸­é—´å€¼</p></li><li><p>min(seriesSet) numberSet<br>æœ€å°å€¼</p></li><li><p>percentile(seriesSet, p numberSet|scalar) numberSet<br>è¿”å›æ•°æ®é›†å‰ç™¾åˆ†æ¯”ä¸ºpçš„æ•°æ®ï¼Œä¾‹å¦‚æœ€å¤§å€¼maxç›¸å½“äºp&gt;=1, ä¸­é—´å€¼ç›¸å½“äºp==0.5</p></li><li><p>since(seriesSet) numberSet</p></li><li><p>Returns the number of seconds since the most recent data point in each series.</p></li><li><p>streak(seriesSet) numberSet<br>è¿ç»­éé›¶æ•°æ®çš„æœ€å¤§é•¿åº¦</p></li><li><p>t(numberSet, group string) seriesSet</p><p>Transposes N series of length 1 to 1 series of length N. If the group parameter is not the empty string, the number of series returned is equal to the number of tagks passed. This is useful for performing scalar aggregation across multiple results from a query. For example, to get the total memory used on the web tier: sum(t(avg(q(â€œavg:os.mem.used{host=-web}â€, â€œ5mâ€, â€œâ€)), â€œâ€)).</p></li><li><p>alert(name string, key string) numberSet *</p></li><li><p>abs(numberSet) numberSet<br>è¿”å›æ•°æ®é›†ä¸­æ¯ä¸ªå…ƒç´ çš„ç»å¯¹å€¼</p></li><li><p>d(string) scalar<br>è¿”å›ä¸€ä¸ªæ—¶é—´æ®µçš„ç§’æ•°ï¼Œä¾‹å¦‚d(â€œ1hâ€)è¿”å›60</p></li><li><p>tod(scalar) string<br>Returns an OpenTSDB duration string that represents the given number of seconds. This lets you do math on durations and then pass it to the duration arguments in functions like q()<br>des(series, alpha scalar, beta scalar) series<br>Returns series smoothed using Holt-Winters double exponential smoothing. Alpha (scalar) is the data smoothing factor. Beta (scalar) is the trend smoothing factor.</p></li><li><p>dropg(seriesSet, threshold numberSet|scalar) seriesSet<br>ç§»é™¤æ•°æ®é›†ä¸­å¤§äºæŒ‡å®šé˜€å€¼çš„å…ƒç´ </p></li><li><p>dropge(seriesSet, threshold numberSet|scalar) seriesSet<br>ç§»é™¤æ•°æ®é›†ä¸­å¤§äºç­‰äºæŒ‡å®šé˜€å€¼çš„å…ƒç´ </p></li><li><p>dropl(seriesSet, threshold numberSet|scalar) seriesSet<br>ç§»é™¤æ•°æ®é›†ä¸­å°äºç­‰äºæŒ‡å®šé˜€å€¼çš„å…ƒç´ </p></li><li><p>drople(seriesSet, threshold numberSet|scalar) seriesSet<br>ç§»é™¤æ•°æ®é›†ä¸­å°äºç­‰äºæŒ‡å®šé˜€å€¼çš„å…ƒç´ </p></li><li><p>dropna(seriesSet) seriesSet<br>ç§»é™¤æ•°æ®é›†ä¸­ç±»å‹æ˜¯NaNæ˜¯Infçš„å…ƒç´ </p></li><li><p>dropbool(seriesSet, seriesSet) seriesSet</p></li><li><p>epoch() scalar<br>è¿”å›å½“å‰çš„Unixæ—¶é—´æˆ³</p></li><li><p>filter(seriesSet, numberSet) seriesSet</p></li><li><p>limit(numberSet, count scalar) numberSet</p></li><li><p>lookup(table string, key string) numberSet</p></li><li><p>shift(seriesSet, dur string) seriesSet</p></li><li><p>merge(SeriesSetâ€¦) seriesSet</p></li><li><p>nv(numberSet, scalar) numberSet</p></li></ul><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><h3 id="ç®€å•èšåˆæµ‹è¯•"><a href="#ç®€å•èšåˆæµ‹è¯•" class="headerlink" title="ç®€å•èšåˆæµ‹è¯•"></a>ç®€å•èšåˆæµ‹è¯•</h3><table><thead><tr><th>åºå·</th><th>metric</th><th>tag</th><th>value</th></tr></thead><tbody><tr><td>1</td><td>test.host.2</td><td>dc=dal host=web01</td><td>3</td></tr><tr><td>2</td><td>test.host.2</td><td>dc=dal host=web02</td><td>2</td></tr><tr><td>3</td><td>test.host.2</td><td>dc=dal host=web03</td><td>10</td></tr><tr><td>4</td><td>test.host.2</td><td>host=web01</td><td>1</td></tr><tr><td>5</td><td>test.host.2</td><td>host=web01 owner=jdoe</td><td>4</td></tr><tr><td>6</td><td>test.host.2</td><td>dc=lax host=web01</td><td>8</td></tr><tr><td>7</td><td>test.host.2</td><td>dc=lax host=web02</td><td>4</td></tr></tbody></table><ol><li><p>å•tagæŸ¥è¯¢</p><blockquote><p>q(â€œsum:test.host.2{host=web01}â€, â€œ24hâ€, â€œâ€)</p></blockquote><blockquote><p>åŒ¹é…ç»“æœï¼š1ï¼Œ4ï¼Œ5ï¼Œ6</p></blockquote><p>| group          | result                | computations |<br>| :â€”â€”â€”â€”- | :â€”â€”â€”â€”â€”â€”â€“ | :â€”â€”â€”â€“ |<br>| { host=web01 } | <code>{&quot;1557327756&quot;: 16 }</code> |              |</p><blockquote><p>q(â€œavg:test.host.2{host=web01}â€, â€œ24hâ€, â€œâ€)</p></blockquote><p>| group          | result                 | computations |<br>| :â€”â€”â€”â€”- | :â€”â€”â€”â€”â€”â€”â€” | :â€”â€”â€”â€“ |<br>| { host=web01 } | <code>{   &quot;1557327756&quot;: 4}</code> |              |</p><blockquote><p>q(â€œcount:test.host.2{host=web01}â€, â€œ24hâ€, â€œâ€)</p></blockquote><p>|                |                         |              |<br>| :â€”â€”â€”â€”- | :â€”â€”â€”â€”â€”â€”â€”- | :â€”â€”â€”â€“ |<br>| group          | result                  | computations |<br>| { host=web01 } | <code>{   &quot;1557327756&quot;: 4 }</code> |              |</p></li><li><p>å¤štagæŸ¥è¯¢</p><blockquote><p>q(â€œsum:test.host.2{dc=dal,host=web01}â€, â€œ24hâ€, â€œâ€)</p></blockquote><blockquote><p>åŒ¹é…ç»“æœï¼š1</p></blockquote><p>| group                  | result                  | computations |<br>| :â€”â€”â€”â€”â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”- | :â€”â€”â€”â€“ |<br>| { dc=dal, host=web01 } | <code>{   &quot;1557327756&quot;: 3 }</code> |              |</p><blockquote><p>q(â€œavg:test.host.2{dc=dal,host=web01}â€, â€œ24hâ€, â€œâ€)</p></blockquote><p>| group                  | result                  | computations |<br>| :â€”â€”â€”â€”â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”- | :â€”â€”â€”â€“ |<br>| { dc=dal, host=web01 } | <code>{   &quot;1557327756&quot;: 3 }</code> |              |</p><blockquote><p>q(â€œcount:test.host.2{dc=dal,host=web01}â€, â€œ24hâ€, â€œâ€)</p></blockquote><p>| group                  | result                  | computations |<br>| :â€”â€”â€”â€”â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”- | :â€”â€”â€”â€“ |<br>| { dc=dal, host=web01 } | <code>{   &quot;1557327756&quot;: 1 }</code> |              |</p></li><li><p>æ­£åˆ™*æŸ¥è¯¢</p><blockquote><p>q(â€œsum:test.host.2{dc=dal,host=*}â€, â€œ24hâ€, â€œâ€)</p></blockquote><blockquote><p>åŒ¹é…ç»“æœï¼š1ï¼Œ2ï¼Œ3</p><p>åŒ¹é…ç»“æœä¼šä»¥ æŸ¥è¯¢ä¸­çš„å”¯ä¸€tagä¸ºä¸€ä¸ªèšç±»</p></blockquote><p>| group                  | result                   | computations |<br>| :â€”â€”â€”â€”â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”â€“ | :â€”â€”â€”â€“ |<br>| { dc=dal, host=web01 } | <code>{   &quot;1557327756&quot;: 3 }</code>  |              |<br>| { dc=dal, host=web02 } | <code>{   &quot;1557327756&quot;: 2 }</code>  |              |<br>| { dc=dal, host=web03 } | <code>{   &quot;1557327756&quot;: 10 }</code> |              |</p><blockquote><p>q(â€œavg:test.host.2{dc=dal,host=*}â€, â€œ24hâ€, â€œâ€)</p></blockquote><p>| group                  | result                   | computations |<br>| :â€”â€”â€”â€”â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”â€“ | :â€”â€”â€”â€“ |<br>| { dc=dal, host=web01 } | <code>{   &quot;1557327756&quot;: 3 }</code>  |              |<br>| { dc=dal, host=web02 } | <code>{   &quot;1557327756&quot;: 2 }</code>  |              |<br>| { dc=dal, host=web03 } | <code>{   &quot;1557327756&quot;: 10 }</code> |              |</p><blockquote><p>q(â€œcount:test.host.2{dc=dal,host=*}â€, â€œ24hâ€, â€œâ€)</p></blockquote><p>| group                  | result                  | computations |<br>| :â€”â€”â€”â€”â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”- | :â€”â€”â€”â€“ |<br>| { dc=dal, host=web01 } | <code>{   &quot;1557327756&quot;: 1 }</code> |              |<br>| { dc=dal, host=web02 } | <code>{   &quot;1557327756&quot;: 1 }</code> |              |<br>| { dc=dal, host=web03 } | <code>{   &quot;1557327756&quot;: 1 }</code> |              |</p></li><li><p>æ­£åˆ™|æŸ¥è¯¢</p><blockquote><p>q(â€œsum:test.host.2{dc=dal|lax}â€, â€œ24hâ€, â€œâ€)</p></blockquote><blockquote><p>åŒ¹é…ç»“æœï¼š1ï¼Œ2ï¼Œ3ï¼Œ6ï¼Œ7</p></blockquote><p>| group      | result                   | computations |<br>| :â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”â€“ | :â€”â€”â€”â€“ |<br>| { dc=dal } | <code>{   &quot;1557327756&quot;: 15 }</code> |              |<br>| { dc=lax } | <code>{   &quot;1557327756&quot;: 12 }</code> |              |</p><blockquote><p>q(â€œavg:test.host.2{dc=dal|lax}â€, â€œ24hâ€, â€œâ€)</p></blockquote><p>| group      | result                  | computations |<br>| :â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”- | :â€”â€”â€”â€“ |<br>| { dc=dal } | <code>{   &quot;1557327756&quot;: 5 }</code> |              |<br>| { dc=lax } | <code>{   &quot;1557327756&quot;: 6 }</code> |              |</p><blockquote><p>q(â€œcount:test.host.2{dc=dal|lax}â€, â€œ24hâ€, â€œâ€)</p></blockquote><p>| group      | result                  | computations |<br>| :â€”â€”â€” | :â€”â€”â€”â€”â€”â€”â€”- | :â€”â€”â€”â€“ |<br>| { dc=dal } | <code>{   &quot;1557327756&quot;: 3 }</code> |              |<br>| { dc=lax } | <code>{   &quot;1557327756&quot;: 2 }</code> |              |</p></li></ol><h3 id="rateæµ‹è¯•"><a href="#rateæµ‹è¯•" class="headerlink" title="rateæµ‹è¯•"></a>rateæµ‹è¯•</h3><table><thead><tr><th>åºå·</th><th>metric</th><th>tag</th><th>value</th><th>Time</th></tr></thead><tbody><tr><td>1</td><td>test.host.3</td><td>host=host1</td><td>4</td><td>1557327757</td></tr><tr><td>2</td><td>test.host.3</td><td>host=host1</td><td>8</td><td>1557327758</td></tr><tr><td>3</td><td>test.host.3</td><td>host=host1</td><td>12</td><td>1557327759</td></tr><tr><td>4</td><td>test.host.3</td><td>host=host1</td><td>16</td><td>1557327760</td></tr><tr><td>5</td><td>test.host.3</td><td>host=host1</td><td>16</td><td>1557327761</td></tr><tr><td>6</td><td>test.host.3</td><td>host=host1</td><td>17</td><td>1557327763</td></tr></tbody></table><blockquote><p>q(â€œavg:rate:test.host.3{host=host1}â€, â€œ24hâ€, â€œâ€)</p></blockquote><table><thead><tr><th style="text-align:left">group</th><th style="text-align:left">result</th><th style="text-align:left">computations</th></tr></thead><tbody><tr><td style="text-align:left">{ host=host1 }</td><td style="text-align:left"><code>{   &quot;1557327757&quot;: 4,   &quot;1557327758&quot;: 4,   &quot;1557327759&quot;: 4,   &quot;1557327760&quot;: 4,   &quot;1557327761&quot;: 0,   &quot;1557327763&quot;: 0.5 }</code></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> OpenTSDB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenTSDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sync.Poolæµ…æ</title>
      <link href="/posts/61660/"/>
      <url>/posts/61660/</url>
      
        <content type="html"><![CDATA[<p>sync poolä½¿ç”¨æ¥å­˜æ”¾ä¸´æ—¶å˜é‡çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œä½†æ˜¯è¿™ä¸ªç¼“å†²åŒºå¹¶ä¸å¯é ï¼Œæ¯æ¬¡gcçš„æ—¶å€™ï¼Œéƒ½ä¼šé¦–å…ˆæ¸…é™¤ç¼“å†²åŒºï¼Œæ‰€ä»¥ï¼Œå‡å¦‚ä¸€ä¸ªsliceä»…ä»…å­˜æ”¾åœ¨ Pool ä¸­ï¼Œè€Œæ²¡æœ‰å…¶ä»–åœ°æ–¹å¼•ç”¨ï¼Œåˆ™ä¼šè¢«å½“æˆåƒåœ¾æ¸…ç†æ‰ã€‚</p><a id="more"></a><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><blockquote><p>A Pool is a set of temporary objects that may be individually saved and retrieved.</p><p>Any item stored in the Pool may be removed automatically at any time without notification. If the Pool holds the only reference when this happens, the item might be deallocated.</p><p>A Pool is safe for use by multiple goroutines simultaneously.</p><p>Poolâ€™s purpose is to cache allocated but unused items for later reuse, relieving pressure on the garbage collector. That is, it makes it easy to build efficient, thread-safe free lists. However, it is not suitable for all free lists.</p><p>An appropriate use of a Pool is to manage a group of temporary items silently shared among and potentially reused by concurrent independent clients of a package. Pool provides a way to amortize allocation overhead across many clients.</p><p>An example of good use of a Pool is in the fmt package, which maintains a dynamically-sized store of temporary output buffers. The store scales under load (when many goroutines are actively printing) and shrinks when quiescent.</p></blockquote><h2 id="å›¾ç¤º"><a href="#å›¾ç¤º" class="headerlink" title="å›¾ç¤º"></a>å›¾ç¤º</h2><p><img src="http://note-1253518569.cossh.myqcloud.com/20190519203029.png" alt></p><p>sync.poolçš„ç»“æ„ç»„æˆå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜</p><ol><li>æˆ‘ä»¬å®ä¾‹åŒ– Sync.Poolçš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆå®ä¾‹åŒ–äº†ä¸€ä¸ªLocalPoolæ•°ç»„ï¼Œæ€ä¹ˆç¡®å®šæˆ‘çš„æ•°æ®åº”è¯¥å­˜å‚¨åœ¨LocalPoolæ•°ç»„çš„å“ªä¸ªå•å…ƒï¼Ÿ</li><li>PoolLocalInternal é‡Œé¢çš„æˆå‘˜æœ‰privateå’Œsharedï¼Œä¸ºä»€ä¹ˆè¦åšè¿™ä¸¤ç§åŒºåˆ†ï¼Ÿ</li></ol><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="Put"><a href="#Put" class="headerlink" title="Put"></a>Put</h3><h4 id="Put-1"><a href="#Put-1" class="headerlink" title="Put()"></a>Put()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">func (p *Pool) Put(x interface&#123;&#125;) &#123;</span><br><span class="line">if x == nil &#123;</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">// raceæ£€æµ‹ å…ˆå¿½ç•¥è¿™ä¸€å—</span><br><span class="line">if race.Enabled &#123;</span><br><span class="line">if fastrand()%4 == 0 &#123;</span><br><span class="line">// Randomly drop x on floor.</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">race.ReleaseMerge(poolRaceAddr(x))</span><br><span class="line">race.Disable()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ ¹æ®è‡ªèº«çš„goroutineçš„idï¼Œè·å–å¯¹åº”çš„PoolLocalçš„åœ°å€ï¼Œåé¢å…·ä½“åˆ†æ</span><br><span class="line">l := p.pin()</span><br><span class="line">// å¦‚æœprivateå­—æ®µä¸ºç©ºçš„è¯ï¼Œé¦–å…ˆç»™privateå­—æ®µèµ‹å€¼</span><br><span class="line">if l.private == nil &#123;</span><br><span class="line">l.private = x</span><br><span class="line">x = nil</span><br><span class="line">&#125;</span><br><span class="line">runtime_procUnpin()</span><br><span class="line">// å¦‚æœprivateå­—æ®µ, åˆ™æ·»åŠ åˆ°sharedå­—æ®µï¼Œå› ä¸º sharedå­—æ®µå¯ä»¥è¢«å…¶ä»–goroutineè·å–ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦åŠ é”</span><br><span class="line">if x != nil &#123;</span><br><span class="line">l.Lock()</span><br><span class="line">l.shared = append(l.shared, x)</span><br><span class="line">l.Unlock()</span><br><span class="line">&#125;</span><br><span class="line">if race.Enabled &#123;</span><br><span class="line">race.Enable()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="pin"><a href="#pin" class="headerlink" title="pin()"></a>pin()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func (p *Pool) pin() *poolLocal &#123;</span><br><span class="line">   // è·å–å½“å‰çš„Pid/Pï¼Œæ•°é‡ç”±</span><br><span class="line">pid := runtime_procPin()</span><br><span class="line">// LocalPoolçš„æ•°é‡</span><br><span class="line">s := atomic.LoadUintptr(&amp;p.localSize) // load-acquire</span><br><span class="line">l := p.local                          // load-consume</span><br><span class="line">// å¦‚æœè·å–åˆ°çš„pidæ¯”LocalPoolæ•°ç»„çš„é•¿åº¦å°ï¼Œè¿”å›å¯¹åº”çš„LocalPool</span><br><span class="line">if uintptr(pid) &lt; s &#123;</span><br><span class="line">return indexLocal(l, pid)</span><br><span class="line">&#125;</span><br><span class="line">// å¦‚æœpidæ¯”LocalPoolæ•°ç»„çš„é•¿åº¦å¤§ï¼Œè¿›ä¸€æ­¥ç¡®è®¤ï¼Œè¿™ä¸ªå‡½æ•°åé¢è®¨è®º</span><br><span class="line">return p.pinSlow()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>runtime_procPin()</code> è¿™ä¸ªæ˜¯è·å–å½“å‰è¿è¡Œçš„pidï¼Œå…·ä½“å®ç°æ²¡æœ‰æŸ¥åˆ°ï¼Œ ä½†æ˜¯<code>runtime_procPin()</code>è¿”å›çš„æ•°å€¼èŒƒå›´æ˜¯ç”± <code>runtime.GOMAXPROCS(0)</code> å†³å®šçš„ã€‚ç½‘ä¸Šæœ‰ç¯‡æ–‡ç« å¯ä»¥å‚è€ƒä¸€ä¸‹<a href="https://juejin.im/post/5b7678f451882533110e8948" target="_blank" rel="noopener">ã€ŠGolang çš„ åç¨‹è°ƒåº¦æœºåˆ¶ ä¸ GOMAXPROCS æ€§èƒ½è°ƒä¼˜ã€‹</a>ï¼Œè¿™é‡Œæš‚ä¸æ·±å…¥</p><h4 id="PinSlow"><a href="#PinSlow" class="headerlink" title="PinSlow()"></a>PinSlow()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">func (p *Pool) pinSlow() *poolLocal &#123;</span><br><span class="line">// Retry under the mutex.</span><br><span class="line">// Can not lock the mutex while pinned.</span><br><span class="line">runtime_procUnpin()</span><br><span class="line">allPoolsMu.Lock()</span><br><span class="line">defer allPoolsMu.Unlock()</span><br><span class="line">pid := runtime_procPin()</span><br><span class="line">// poolCleanup won&apos;t be called while we are pinned.</span><br><span class="line">// å†æ¬¡æ£€æŸ¥æ˜¯å¦LocalPoolæ˜¯å¦æœ‰å¯¹åº”çš„ç´¢å¼•ï¼Œé¿å…å…¶ä»–çš„çº¿ç¨‹é€ æˆå½±å“</span><br><span class="line">s := p.localSize</span><br><span class="line">l := p.local</span><br><span class="line">if uintptr(pid) &lt; s &#123;</span><br><span class="line">return indexLocal(l, pid)</span><br><span class="line">&#125;</span><br><span class="line">// å¦‚æœlocalä¸ºnilï¼Œè¯´æ˜æ˜¯æ–°æ„å»ºçš„Poolç»“æ„ä½“ï¼ŒåŠ ç´§allPools sliceé‡Œé¢</span><br><span class="line">if p.local == nil &#123;</span><br><span class="line">allPools = append(allPools, p)</span><br><span class="line">&#125;</span><br><span class="line">// If GOMAXPROCS changes between GCs, we re-allocate the array and lose the old one.</span><br><span class="line">// é‡æ–°è·å– GOMAXPROCSï¼Œå¹¶æ ¹æ®è¿™ä¸ªè®¾ç½®PoolLocalçš„å¤§å°</span><br><span class="line">size := runtime.GOMAXPROCS(0)</span><br><span class="line">local := make([]poolLocal, size)</span><br><span class="line">atomic.StorePointer(&amp;p.local, unsafe.Pointer(&amp;local[0])) // store-release</span><br><span class="line">atomic.StoreUintptr(&amp;p.localSize, uintptr(size))         // store-release</span><br><span class="line">// æ‰¾åˆ°å½“å‰goroutineå¯¹åº”çš„åœ°å€ï¼Œå¹¶è¿”å›</span><br><span class="line">return &amp;local[pid]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Put-é€»è¾‘"><a href="#Put-é€»è¾‘" class="headerlink" title="Put é€»è¾‘"></a>Put é€»è¾‘</h4><p>ç»¼ä¸Šï¼ŒPutçš„åŸºæœ¬æ“ä½œé€»è¾‘å°±æ˜¯</p><ul><li>è·å–å½“å‰æ‰§è¡Œçš„<code>Pid</code></li><li>æ ¹æ®Pidï¼Œæ‰¾åˆ°å¯¹åº”çš„<code>PoolLocal</code>ï¼Œæ¥ç€ä½¿ç”¨é‡Œé¢<code>PoolLocalInternal</code></li><li>ä¼˜å…ˆå­˜å…¥ <code>PoolLocalInternal</code> çš„ <code>private</code>å±æ€§ï¼Œå…¶æ¬¡ç²—å¦‚ <code>PoolLocalInternal</code> çš„ <code>shared</code> è¿™ä¸ªsliceé‡Œé¢</li></ul><h3 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h3><h4 id="Get-1"><a href="#Get-1" class="headerlink" title="Get()"></a>Get()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">func (p *Pool) Get() interface&#123;&#125; &#123;</span><br><span class="line">if race.Enabled &#123;</span><br><span class="line">race.Disable()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è·å–åˆ°LocalPool</span><br><span class="line">l := p.pin()</span><br><span class="line"></span><br><span class="line">// æŠŠprivateæ•°æ®å€¼æ‹·è´ä¸€ä»½ï¼Œç„¶åæŠŠprivateè®¾ç½®ä¸ºnilï¼Œå› ä¸ºå¦‚æœprivateæœ‰æ•°æ®ï¼ŒæŠŠprivateæ•°æ®è¿”å›åï¼Œè¦æŠŠprivateè®¾ç½®ä¸ºnilï¼Œå¦‚æœprivateæ²¡æœ‰æ•°æ®ï¼Œåˆ™åŸå…ˆå°±æ˜¯nilï¼Œæ·»åŠ è¿™ä¸€æ­¥ä¹Ÿæ²¡æœ‰å…³ç³»</span><br><span class="line">x := l.private</span><br><span class="line">l.private = nil</span><br><span class="line">runtime_procUnpin()</span><br><span class="line">// å¦‚æœprivateé‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œåˆ™ä»sharedé‡Œé¢å»æ‰¾</span><br><span class="line">if x == nil &#123;</span><br><span class="line">l.Lock()</span><br><span class="line">last := len(l.shared) - 1</span><br><span class="line">if last &gt;= 0 &#123;</span><br><span class="line">x = l.shared[last]</span><br><span class="line">l.shared = l.shared[:last]</span><br><span class="line">&#125;</span><br><span class="line">l.Unlock()</span><br><span class="line">// å¦‚æœå½“å‰çº¿ç¨‹ä¸‹å¯¹åº”çš„LocalPoolï¼Œæ²¡æœ‰æ•°æ®ï¼Œåˆ™è°ƒç”¨getSlow()ï¼Œä»å…¶ä»–çš„LocalPoolçš„sharedé‡Œé¢è·å–æ•°æ®ï¼Œåé¢è§£æ getSlow</span><br><span class="line">if x == nil &#123;</span><br><span class="line">x = p.getSlow()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if race.Enabled &#123;</span><br><span class="line">race.Enable()</span><br><span class="line">if x != nil &#123;</span><br><span class="line">race.Acquire(poolRaceAddr(x))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">// å¦‚æœ ä»private sharedåŠå…¶ä»–çš„LocalPoolçš„sharedé‡Œé¢éƒ½è·å–ä¸åˆ°æ•°æ®ï¼Œä¸”æ³¨å†Œçš„Newå‡½æ•°ä¸ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œæ³¨å†Œçš„Newå‡½æ•°</span><br><span class="line">if x == nil &amp;&amp; p.New != nil &#123;</span><br><span class="line">x = p.New()</span><br><span class="line">&#125;</span><br><span class="line">return x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="getSlow"><a href="#getSlow" class="headerlink" title="getSlow()"></a>getSlow()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func (p *Pool) getSlow() (x interface&#123;&#125;) &#123;</span><br><span class="line">// See the comment in pin regarding ordering of the loads.</span><br><span class="line">// è·å–LocalPoolçš„size</span><br><span class="line">size := atomic.LoadUintptr(&amp;p.localSize) // load-acquire</span><br><span class="line">local := p.local                         // load-consume</span><br><span class="line">// Try to steal one element from other procs.</span><br><span class="line">pid := runtime_procPin()</span><br><span class="line">runtime_procUnpin()</span><br><span class="line">// ä¾¿åˆ©LocalPoolï¼Œè·å–sharedé‡Œé¢çš„æ•°æ®ï¼Œæ‰¾åˆ°å°±è¿”å›</span><br><span class="line">for i := 0; i &lt; int(size); i++ &#123;</span><br><span class="line">l := indexLocal(local, (pid+i+1)%int(size))</span><br><span class="line">l.Lock()</span><br><span class="line">last := len(l.shared) - 1</span><br><span class="line">if last &gt;= 0 &#123;</span><br><span class="line">x = l.shared[last]</span><br><span class="line">l.shared = l.shared[:last]</span><br><span class="line">l.Unlock()</span><br><span class="line">break</span><br><span class="line">&#125;</span><br><span class="line">l.Unlock()</span><br><span class="line">&#125;</span><br><span class="line">return x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œ<code>shared</code> é‡Œé¢çš„æ•°æ®æ˜¯ä¼šè¢«å…¶ä»–çš„Pæ£€ç´¢åˆ°çš„ï¼Œè€Œ <code>private</code>é‡Œé¢çš„æ•°æ®æ˜¯ä¸ä¼šçš„ï¼Œæ‰€ä»¥åœ¨è·å–<code>shared</code>é‡Œé¢æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦åŠ é”</p><h3 id="poolCleanup"><a href="#poolCleanup" class="headerlink" title="poolCleanup"></a>poolCleanup</h3><p>è¿™ä¸ªå‡½æ•°æ˜¯PoolåŒ…é‡Œé¢æä¾›çš„ï¼Œç”¨æ¥æ¸…ç†Poolçš„ï¼Œä½†æ˜¯å®˜æ–¹çš„å®ç°ç•¥æ˜¾ç²—æš´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">func poolCleanup() &#123;</span><br><span class="line">// This function is called with the world stopped, at the beginning of a garbage collection.</span><br><span class="line">// It must not allocate and probably should not call any runtime functions.</span><br><span class="line">// Defensively zero out everything, 2 reasons:</span><br><span class="line">// 1. To prevent false retention of whole Pools.</span><br><span class="line">// 2. If GC happens while a goroutine works with l.shared in Put/Get,</span><br><span class="line">//    it will retain whole Pool. So next cycle memory consumption would be doubled.</span><br><span class="line">// ä¾¿åˆ©æ‰€æœ‰çš„Sync.Pool</span><br><span class="line">for i, p := range allPools &#123;</span><br><span class="line">allPools[i] = nil</span><br><span class="line">// éå†Poolé‡Œé¢çš„LocalPoolï¼Œå¹¶æ¸…ç©ºé‡Œé¢çš„æ•°æ®</span><br><span class="line">for i := 0; i &lt; int(p.localSize); i++ &#123;</span><br><span class="line">l := indexLocal(p.local, i)</span><br><span class="line">l.private = nil</span><br><span class="line">for j := range l.shared &#123;</span><br><span class="line">l.shared[j] = nil</span><br><span class="line">&#125;</span><br><span class="line">l.shared = nil</span><br><span class="line">&#125;</span><br><span class="line">p.local = nil</span><br><span class="line">p.localSize = 0</span><br><span class="line">&#125;</span><br><span class="line">// æ¸…ç©ºallPools</span><br><span class="line">allPools = []*Pool&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼šåœ¨GCä¹‹å‰è°ƒç”¨ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†å®˜æ–¹çš„ä¸‹é¢ä¸€å¥è¯</p><blockquote><p>Any item stored in the Pool may be removed automatically at any time without<br>notification. If the Pool holds the only reference when this happens, the<br>item might be deallocated.</p></blockquote><p>å¦‚æœä¸€ä¸ªæ•°æ®ä»…ä»…åœ¨Poolä¸­æœ‰å¼•ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦æ‹…å¿ƒè¿™ä¸ªæ•°æ®è¢«GCæ¸…ç†æ‰</p><h3 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h3><p>é’ˆå¯¹äºä¸Šé¢æå‡ºçš„ä¸¤ä¸ªé—®é¢˜ï¼Œåšä¸€ä¸‹ç®€å•çš„åˆ†æ</p><blockquote><p>æˆ‘ä»¬å®ä¾‹åŒ– Sync.Poolçš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆå®ä¾‹åŒ–äº†ä¸€ä¸ªLocalPoolæ•°ç»„ï¼Œæ€ä¹ˆç¡®å®šæˆ‘çš„æ•°æ®åº”è¯¥å­˜å‚¨åœ¨LocalPoolæ•°ç»„çš„å“ªä¸ªå•å…ƒï¼Ÿ</p></blockquote><p>è¿™é‡Œçš„LocalPoolæ˜¯æ ¹æ®ä¸åŒçš„pidæ¥åŒºåˆ†çš„ï¼Œä¿è¯privateæ•°æ®çš„çº¿ç¨‹å®‰å…¨ï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™å¯ä»¥è·å–åˆ°pidï¼Œç„¶åä½¿ç”¨pidä½œä¸ºLocalPoolçš„ç´¢å¼•ï¼Œæ‰¾åˆ°å¯¹åº”çš„åœ°å€å³å¯</p><blockquote><p>PoolLocalInternal é‡Œé¢çš„æˆå‘˜æœ‰privateå’Œsharedï¼Œä¸ºä»€ä¹ˆè¦åšè¿™ä¸¤ç§åŒºåˆ†ï¼Ÿ</p></blockquote><p><code>private</code> æ˜¯ P ä¸“å±çš„ï¼Œ <code>shared</code>æ˜¯å¯ä»¥è¢«å…¶ä»–çš„Pè·å–åˆ°çš„</p><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><p><a href="http://www.mckee.cn/golang/pkg/syncpool" target="_blank" rel="noopener">ã€Šsync.Poolæºç å®ç°ã€‹</a><br>ã€ŠGo è¯­è¨€å­¦ä¹ ç¬”è®° - é›¨ç—•ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GraphQLå­¦ä¹ </title>
      <link href="/posts/42393/"/>
      <url>/posts/42393/</url>
      
        <content type="html"><![CDATA[<p>GraphQL æ—¢æ˜¯ä¸€ç§ç”¨äº API çš„æŸ¥è¯¢è¯­è¨€ä¹Ÿæ˜¯ä¸€ä¸ªæ»¡è¶³ä½ æ•°æ®æŸ¥è¯¢çš„è¿è¡Œæ—¶ã€‚ GraphQL å¯¹ä½ çš„ API ä¸­çš„æ•°æ®æä¾›äº†ä¸€å¥—æ˜“äºç†è§£çš„å®Œæ•´æè¿°ï¼Œä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤Ÿå‡†ç¡®åœ°è·å¾—å®ƒéœ€è¦çš„æ•°æ®ï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•å†—ä½™ï¼Œä¹Ÿè®© API æ›´å®¹æ˜“åœ°éšç€æ—¶é—´æ¨ç§»è€Œæ¼”è¿›ï¼Œè¿˜èƒ½ç”¨äºæ„å»ºå¼ºå¤§çš„å¼€å‘è€…å·¥å…·ã€‚</p><a id="more"></a><h2 id="å¯¹è±¡ç±»å‹å’Œå­—æ®µ"><a href="#å¯¹è±¡ç±»å‹å’Œå­—æ®µ" class="headerlink" title="å¯¹è±¡ç±»å‹å’Œå­—æ®µ"></a>å¯¹è±¡ç±»å‹å’Œå­—æ®µ</h2><pre><code>type Character {  name: String!  appearsIn: [Episode!]!}</code></pre><ul><li><strong>Character</strong> æ˜¯ä¸€ä¸ª GraphQL å¯¹è±¡ç±»å‹ï¼Œè¡¨ç¤ºå…¶æ˜¯ä¸€ä¸ªæ‹¥æœ‰ä¸€äº›å­—æ®µçš„ç±»å‹ã€‚ä½ çš„ schema ä¸­çš„å¤§å¤šæ•°ç±»å‹éƒ½ä¼šæ˜¯å¯¹è±¡ç±»å‹ã€‚<br>name å’Œ appearsIn æ˜¯ Character ç±»å‹ä¸Šçš„å­—æ®µã€‚è¿™æ„å‘³ç€åœ¨ä¸€ä¸ªæ“ä½œ Character ç±»å‹çš„ GraphQL æŸ¥è¯¢ä¸­çš„ä»»ä½•éƒ¨åˆ†ï¼Œéƒ½åªèƒ½å‡ºç° name å’Œ appearsIn å­—æ®µã€‚</li><li><strong>String</strong> æ˜¯å†…ç½®çš„æ ‡é‡ç±»å‹ä¹‹ä¸€ â€”â€” æ ‡é‡ç±»å‹æ˜¯è§£æåˆ°å•ä¸ªæ ‡é‡å¯¹è±¡çš„ç±»å‹ï¼Œæ— æ³•åœ¨æŸ¥è¯¢ä¸­å¯¹å®ƒè¿›è¡Œæ¬¡çº§é€‰æ‹©ã€‚åé¢æˆ‘ä»¬å°†ç»†è¿°æ ‡é‡ç±»å‹ã€‚</li><li><strong>String!</strong> è¡¨ç¤ºè¿™ä¸ªå­—æ®µæ˜¯éç©ºçš„ï¼ŒGraphQL æœåŠ¡ä¿è¯å½“ä½ æŸ¥è¯¢è¿™ä¸ªå­—æ®µåæ€»ä¼šç»™ä½ è¿”å›ä¸€ä¸ªå€¼ã€‚åœ¨ç±»å‹è¯­è¨€é‡Œé¢ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªæ„Ÿå¹å·æ¥è¡¨ç¤ºè¿™ä¸ªç‰¹æ€§ã€‚</li><li><strong>[Episode!]!</strong> è¡¨ç¤ºä¸€ä¸ª Episode æ•°ç»„ã€‚å› ä¸ºå®ƒä¹Ÿæ˜¯éç©ºçš„ï¼Œæ‰€ä»¥å½“ä½ æŸ¥è¯¢ appearsIn å­—æ®µçš„æ—¶å€™ï¼Œä½ ä¹Ÿæ€»èƒ½å¾—åˆ°ä¸€ä¸ªæ•°ç»„ï¼ˆé›¶ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ ï¼‰ã€‚ä¸”ç”±äº Episode! ä¹Ÿæ˜¯éç©ºçš„ï¼Œä½ æ€»æ˜¯å¯ä»¥é¢„æœŸåˆ°æ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹ç›®éƒ½æ˜¯ä¸€ä¸ª Episode å¯¹è±¡ã€‚</li></ul><h2 id="æ ‡é‡ç±»å‹"><a href="#æ ‡é‡ç±»å‹" class="headerlink" title="æ ‡é‡ç±»å‹"></a>æ ‡é‡ç±»å‹</h2><ul><li><strong>Int</strong>ï¼šæœ‰ç¬¦å· 32 ä½æ•´æ•°ã€‚</li><li><strong>Float</strong>ï¼šæœ‰ç¬¦å·åŒç²¾åº¦æµ®ç‚¹å€¼ã€‚</li><li><strong>String</strong>ï¼šUTFâ€8 å­—ç¬¦åºåˆ—ã€‚</li><li><strong>Boolean</strong>ï¼štrue æˆ–è€… falseã€‚</li><li><strong>ID</strong>ï¼šID æ ‡é‡ç±»å‹è¡¨ç¤ºä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œé€šå¸¸ç”¨ä»¥é‡æ–°è·å–å¯¹è±¡æˆ–è€…ä½œä¸ºç¼“å­˜ä¸­çš„é”®ã€‚ID ç±»å‹ä½¿ç”¨å’Œ String ä¸€æ ·çš„æ–¹å¼åºåˆ—åŒ–ï¼›ç„¶è€Œå°†å…¶å®šä¹‰ä¸º ID æ„å‘³ç€å¹¶ä¸éœ€è¦äººç±»å¯è¯»å‹ã€‚</li></ul><h2 id="åŸºæœ¬æŸ¥è¯¢"><a href="#åŸºæœ¬æŸ¥è¯¢" class="headerlink" title="åŸºæœ¬æŸ¥è¯¢"></a>åŸºæœ¬æŸ¥è¯¢</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">type Account &#123;   // å®šä¹‰ä¸€ä¸ªæ¥æ”¶è¿”å›çš„ç±»å‹ï¼ŒåŒ…å«è¿”å›çš„æ‰€éœ€è¦çš„å­—æ®µ</span><br><span class="line">    name: String // è¿”å›çš„å­—æ®µåç§°åŠç±»å‹</span><br><span class="line">    age: Int</span><br><span class="line">    sex: String</span><br><span class="line">    department: String</span><br><span class="line">&#125;</span><br><span class="line">type Query &#123;   // å®šä¹‰æŸ¥è¯¢å‡½æ•°åŠè¿”å›ç±»å‹</span><br><span class="line">    hello: String  // keyæ˜¯å‡½æ•°ï¼Œ valueæ˜¯æ ‡å‡†ç±»å‹æˆ–è€…ä¸Šè¿°å®šä¹‰çš„ç±»å‹</span><br><span class="line">    accountName: String</span><br><span class="line">    age: Int</span><br><span class="line">    account: Account  // æ­¤æ—¶è¿”å›æ˜¯ä¸Šè¿°å®šä¹‰çš„ç±»å‹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚æ•°ä¼ é€’"><a href="#å‚æ•°ä¼ é€’" class="headerlink" title="å‚æ•°ä¼ é€’"></a>å‚æ•°ä¼ é€’</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type Account &#123;</span><br><span class="line">    name: String</span><br><span class="line">    age: Int</span><br><span class="line">    sex: String</span><br><span class="line">    department: String</span><br><span class="line">    salary(city: String): Int  // å·¦ä¾§å¯ä»¥è¿˜æ˜¯å‡½æ•°</span><br><span class="line">&#125;</span><br><span class="line">type Query &#123;</span><br><span class="line">    getClassMates(classNo: Int!): [String] // classNoæ˜¯å‚æ•°åï¼Œ Intæ˜¯å‚æ•°ç±»å‹ !è¡¨ç¤ºå¿…ä¼ å‚æ•° [string]è¡¨ç¤ºè¿”å›çš„æ˜¯stringæ•°ç»„</span><br><span class="line">    account(username: String): Account</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æŸ¥è¯¢ç¤ºä¾‹"><a href="#æŸ¥è¯¢ç¤ºä¾‹" class="headerlink" title="æŸ¥è¯¢ç¤ºä¾‹"></a>æŸ¥è¯¢ç¤ºä¾‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;operationName&quot;:&quot;getuserid&quot;,  // å»æ‰ä¹Ÿæ˜¯okçš„</span><br><span class="line">&quot;variables&quot;:&#123;   // è¿™é‡Œæ˜¯å˜é‡çš„key valueï¼Œ keyå¯ä»¥ä¸ç”¨ï¼Œä½†æ˜¯queryä¸­ç»„è¦çš„keyå¿…é¡»å­˜åœ¨</span><br><span class="line">    &quot;id&quot;:&quot;1&quot;,</span><br><span class="line">    &quot;date&quot;:&quot;2019.03.26&quot;,</span><br><span class="line">    &quot;start&quot;:&quot;1553563272&quot;,</span><br><span class="line">    &quot;end&quot;:&quot;1553566872&quot;,</span><br><span class="line">    &quot;limit&quot;:20 // å¤šä½™çš„å­—æ®µä¸å½±å“</span><br><span class="line">&#125;,</span><br><span class="line">&quot;query&quot;:&quot;query getuserid($id: ID!)&#123;  // æ‰§è¡Œä¸€ä¸ªquery è¿™é‡Œçš„ getuserid å¯ä»¥æ˜¯ä»»æ„åå­—ï¼Œæ²¡æœ‰é™åˆ¶ï¼Œ å‚æ•°é‡Œé¢åˆ¶å®šç±»å‹</span><br><span class="line">    getUser(id : $id) &#123; // è¿™ä¸ªæ˜¯queryé‡Œé¢å£°æ˜çš„å‡½æ•°åŠå‚æ•°å½¢å¼</span><br><span class="line">        id,  // è¿™é‡Œæ˜¯éœ€è¦çš„è¿”å›å­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å£°æ˜çš„typeï¼Œä½†æ˜¯å­—æ®µå¿…é¡»è¢«åŒ…å«åœ¨Accountä¸­</span><br><span class="line">        name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Mutation-å˜æ›´"><a href="#Mutation-å˜æ›´" class="headerlink" title="Mutation(å˜æ›´)"></a>Mutation(å˜æ›´)</h2><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">input AccountInput &#123; // è¿™æ˜¯è¾“å…¥ç±»å‹, ä½¿ç”¨inputå®šä¹‰</span><br><span class="line">    name: String</span><br><span class="line">    age: Int</span><br><span class="line">    sex: String</span><br><span class="line">    department: String</span><br><span class="line">&#125;</span><br><span class="line">type Account &#123;  // å®šä¹‰è¾“å‡ºç±»å‹</span><br><span class="line">    name: String</span><br><span class="line">    age: Int</span><br><span class="line">    sex: String</span><br><span class="line">    department: String</span><br><span class="line">&#125;</span><br><span class="line">type Mutation &#123;</span><br><span class="line">    createAccount(input: AccountInput): Account</span><br><span class="line">    updateAccount(id: ID!, input: AccountInput): Account</span><br><span class="line">&#125;</span><br><span class="line">type Query &#123;</span><br><span class="line">    accounts: [Account]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¯·æ±‚ç¤ºä¾‹"><a href="#è¯·æ±‚ç¤ºä¾‹" class="headerlink" title="è¯·æ±‚ç¤ºä¾‹"></a>è¯·æ±‚ç¤ºä¾‹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;variables&quot;:&#123;   // è¿™é‡Œæ˜¯å˜é‡çš„key valueï¼Œ keyå¯ä»¥ä¸ç”¨ï¼Œä½†æ˜¯queryä¸­ç»„è¦çš„keyå¿…é¡»å­˜åœ¨</span><br><span class="line">    &quot;name&quot;:&quot;test&quot;,</span><br><span class="line">    &quot;age&quot;:18,</span><br><span class="line">    &quot;sex&quot;:&quot;male&quot;,</span><br><span class="line">    &quot;department&quot;:&quot;luban&quot;,</span><br><span class="line">&#125;,</span><br><span class="line">&quot;mutation&quot;:&quot;mutation createAccount($input: AccountInput)&#123;  // æ‰§è¡Œä¸€ä¸ªquery è¿™é‡Œçš„ getuserid å¯ä»¥æ˜¯ä»»æ„åå­—ï¼Œæ²¡æœ‰é™åˆ¶ï¼Œ å‚æ•°é‡Œé¢åˆ¶å®šç±»å‹</span><br><span class="line">    createAccount(input : $input) &#123;</span><br><span class="line">        age,</span><br><span class="line">        name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> GraphQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GraphQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£Goçš„interface</title>
      <link href="/posts/2647/"/>
      <url>/posts/2647/</url>
      
        <content type="html"><![CDATA[<p>ç®€å•ä»‹ç»ä¸€ä¸‹æˆ‘å¯¹interfaceçš„ç†è§£ï¼Œæ¶‰åŠæŒ‡é’ˆç±»å‹è½¬æ¢ï¼ŒæŒ‡é’ˆè¿ç®—ï¼Œinterfaceç»“æ„åŠåå°„ç­‰</p><a id="more"></a><h2 id="Unsafe-Pointer-å’Œ-uintptr"><a href="#Unsafe-Pointer-å’Œ-uintptr" class="headerlink" title="Unsafe.Pointer å’Œ uintptr"></a>Unsafe.Pointer å’Œ uintptr</h2><h3 id="æŒ‡é’ˆç±»å‹è½¬æ¢"><a href="#æŒ‡é’ˆç±»å‹è½¬æ¢" class="headerlink" title="æŒ‡é’ˆç±»å‹è½¬æ¢"></a>æŒ‡é’ˆç±»å‹è½¬æ¢</h3><p>æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ <code>*T</code> æ¥è¡¨ç¤ºä¸€ä¸ªæŒ‡å‘ç±»å‹Tå˜é‡çš„æŒ‡é’ˆï¼Œ ç±»ä¼¼äº <code>*int</code> è¡¨ç¤º intå‹æŒ‡é’ˆã€‚ä½†æ˜¯æŒ‡é’ˆç±»å‹å¹¶ä¸èƒ½è¿›è¡Œç±»å‹è½¬æ¢<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">var i *int</span><br><span class="line">p := 10</span><br><span class="line">i = &amp;p</span><br><span class="line"></span><br><span class="line">m := (*float64)(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cannot convert i (type *int) to type *float64</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œåœ¨è¿›è¡Œç±»å‹è½¬æ¢çš„æ—¶å€™å°±ä¼šæŠ¥ä¸Šè¿°çš„é”™è¯¯</p><h3 id="unsafe-Pointer"><a href="#unsafe-Pointer" class="headerlink" title="unsafe.Pointer"></a>unsafe.Pointer</h3><p>unsafe.Pointer æ˜¯ç‰¹åˆ«å®šä¹‰çš„ä¸€ç§æŒ‡é’ˆç±»å‹ï¼ˆè¯‘æ³¨ï¼šç±»ä¼¼Cè¯­è¨€ä¸­çš„voidç±»å‹çš„æŒ‡é’ˆï¼‰ï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹å˜é‡çš„åœ°å€ï¼Œæ˜¯å„ä¸ªæŒ‡é’ˆç±»å‹è½¬æ¢çš„æ¡¥æ¢ï¼Œæ‰€ä»¥ä¸Šè¿°çš„æŒ‡é’ˆç±»å‹è½¬æ¢å°±å¯ä»¥é€šè¿‡ unsafe.Pointer å®ç°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">var i *int</span><br><span class="line">p := 10</span><br><span class="line">i = &amp;p</span><br><span class="line"></span><br><span class="line">m := (*float64)(unsafe.Pointer(i))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>unsafe.Pointerçš„æœ€ç»ˆå®ç°å…¶å®å°±æ˜¯ä¸€ä¸ª *int<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type ArbitraryType int</span><br><span class="line"></span><br><span class="line">type Pointer *ArbitraryType</span><br></pre></td></tr></table></figure></p><p>å½“ç„¶ï¼Œpointerçš„è½¬æ¢ä¹Ÿæ˜¯æœ‰è§„åˆ™çš„</p><blockquote><p>A safe pointer can be explicitly converted to an unsafe pointer, and vice versa.ï¼ˆå®‰å…¨æŒ‡é’ˆå¯ä»¥æ˜¾å¼è½¬æ¢ä¸ºä¸å®‰å…¨æŒ‡é’ˆï¼Œåä¹‹äº¦ç„¶ã€‚ï¼‰<br>An uintptr value can be explicitly converted to an unsafe pointer, and vice versa. But please note, a nil unsafe.Pointer shouldnâ€™t be converted to uintptr and back with arithmetic.ï¼ˆuintptrå€¼å¯ä»¥æ˜¾å¼è½¬æ¢ä¸ºä¸å®‰å…¨æŒ‡é’ˆï¼Œåä¹‹äº¦ç„¶ã€‚ï¼‰</p></blockquote><h3 id="uintptr"><a href="#uintptr" class="headerlink" title="uintptr"></a>uintptr</h3><p>ä¸€ä¸ªå¯ä»¥å®¹çº³ä»»ä½•æŒ‡é’ˆç±»å‹çš„æ•´å‹ï¼Œå¯ä»¥è¿›è¡ŒæŒ‡é’ˆè¿ç®—ï¼Œè€ŒGoçš„æŒ‡é’ˆæ˜¯ä¸æ”¯æŒè¿ç®—çš„ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸Šè¿°è½¬æ¢çš„ç¬¬äºŒæ¡è§„åˆ™çš„æ„ä¹‰ï¼Œè½¬æ¢æˆ unintptr è¿›è¡ŒæŒ‡é’ˆè¿ç®—ï¼Œç„¶åå†è½¬æ¢ä¸ºå¯¹åº”çš„ ç±»å‹çš„æŒ‡é’ˆï¼Œä»¥æ˜¾ç¤ºå˜é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">type User struct &#123;</span><br><span class="line">Name string</span><br><span class="line">Age int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">u := new(User)</span><br><span class="line">name :=(*string)(unsafe.Pointer(u))</span><br><span class="line">*name = &quot;test&quot;</span><br><span class="line"></span><br><span class="line">age := (*int)(unsafe.Pointer(uintptr(unsafe.Pointer(u)) + unsafe.Offsetof(u.Age)))</span><br><span class="line">*age = 18</span><br><span class="line">fmt.Println(u)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€è·¯: å¦‚æœæƒ³å¯¹Nameå’Œ Ageè¿›è¡Œèµ‹å€¼ï¼Œé‚£é¦–å…ˆåº”è¯¥å…ˆæ‹¿åˆ°ç›¸åº”çš„åœ°å€ï¼Œç„¶åå¯¹åœ°å€å†…å®¹ä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ†åˆ«å®šä¹‰ä¸€ä¸ª <em>string å’Œ </em>int åˆ†åˆ«æŒ‡å‘ Name å’Œ Ageçš„åœ°å€<br>å¯¹äº uè¿™ä¸ªç»“æ„ä½“ï¼Œuçš„é¦–åœ°å€å°±æ˜¯Nameçš„åœ°å€ï¼Œä½†æ˜¯uæ˜¯ç»“æ„ä½“æŒ‡é’ˆï¼Œæ‰€ä»¥åªéœ€è¦å°†uè½¬æ¢æˆ *string å³å¯<br>å¯¹äº Ageï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†Nameçš„åœ°å€ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œåç§»å³å¯ï¼Œä¹Ÿå°±æ˜¯ unsafe.Offsetof(u.Age) çš„åç§»é‡ï¼Œ ä½†æ˜¯ <code>Pointer</code>ä¸èƒ½è¿›è¡ŒæŒ‡é’ˆè¿ç®—ï¼Œéšæ„éœ€è¦å°† <code>Pointer</code> è½¬æ¢æˆ <code>uintptr</code></p><h2 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h2><h3 id="interfaceçš„å‘"><a href="#interfaceçš„å‘" class="headerlink" title="interfaceçš„å‘"></a>interfaceçš„å‘</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type Err struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">func (err *Err) Error() string &#123;</span><br><span class="line">return &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">var i interface&#123;&#125;</span><br><span class="line">i = nil</span><br><span class="line">if i == nil &#123;</span><br><span class="line">fmt.Println(&quot;i is nil&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var a *int</span><br><span class="line">a = nil</span><br><span class="line">if a == nil &#123;</span><br><span class="line">fmt.Println(&quot;a is nil&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a1 := testInterface()</span><br><span class="line">if a1 == nil &#123;</span><br><span class="line">fmt.Println(&quot;test interface return nil&quot;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">fmt.Println(&quot;test interface return not nil&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a2 := testInterfacePointer()</span><br><span class="line">if a2 == nil &#123;</span><br><span class="line">fmt.Println(&quot;test interface pointer return nil&quot;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">fmt.Println(&quot;test interface pointer return not nil&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func testInterface() error &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func testInterfacePointer() error &#123;</span><br><span class="line">var p *Err = nil</span><br><span class="line">return p</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé¢ä¸€ä¸ªä»£ç ä¸ºä¾‹ï¼Œæ‰“å°ç»“æœå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i is nil</span><br><span class="line">a is nil</span><br><span class="line">test interface return nil</span><br><span class="line">test interface pointer return not nil</span><br></pre></td></tr></table></figure><p>å‰é¢ä¸‰ä¸ªç»“æœæ¯”è¾ƒå¥½ç†è§£ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆ <code>testInterfacePointer</code> è¿”å›ç»“æœä¸æ˜¯ <code>nil</code><br>æˆ‘ä»¬ç”¨gdbè°ƒè¯•ï¼Œçœ‹ä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i = &#123;_type = 0x0, data = 0x0&#125;</span><br><span class="line">a = 0x0</span><br><span class="line">a1 = &#123;tab = 0x0, data = 0x0&#125;</span><br><span class="line">a2 = &#123;tab = 0x4c8c40 &lt;*main.Err,error&gt;, data = 0x0&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œa2 ç»“æ„ä½“ä¸­çš„ <code>tab</code> ä¸æ˜¯ <code>0x0</code>ï¼Œ æ‰€ä»¥ï¼Œè¿è¡Œç»“æœåˆ¤æ–­ <code>a2 != nil</code></p><p>ä¸ºä»€ä¹ˆiçš„ç»“æ„ä½“åŒ…å«çš„æ˜¯ <code>_type</code> <code>data</code>, ä½†æ˜¯ a1 å’Œ a2åŒ…å«çš„ç»“æ„ä½“å†…å®¹æ˜¯ <code>tab</code> <code>data</code></p><h3 id="interfaceç»“æ„ä½“"><a href="#interfaceç»“æ„ä½“" class="headerlink" title="interfaceç»“æ„ä½“"></a>interfaceç»“æ„ä½“</h3><h4 id="eface-empty-interface"><a href="#eface-empty-interface" class="headerlink" title="eface (empty interface)"></a>eface (empty interface)</h4><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç©ºçš„interfae, ä½¿ç”¨ <code>interface{}</code> å£°æ˜çš„éƒ½æ˜¯ empty interface<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type eface struct &#123;</span><br><span class="line">_type *_type</span><br><span class="line">data  unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type _type struct &#123;</span><br><span class="line">size       uintptr // Size returns the number of bytes needed to store a value of the given typeï¼Œit is analogous to unsafe.Sizeof.å¯é€šè¿‡ reflec</span><br><span class="line">ptrdata    uintptr // size of memory prefix holding all pointers</span><br><span class="line">hash       uint32 // ç±»å‹çš„hashå€¼ï¼Œæ‰€æœ‰çš„typeä¼šå­˜æ”¾åœ¨hashTypeè¡¨ä¸­ï¼Œä»¥hashä¸ºç´¢å¼•</span><br><span class="line">tflag      tflag //  é¢å¤–ç±»å‹ä¿¡æ¯æ ‡å¿—</span><br><span class="line">align      uint8 // æ­¤ç±»å‹typeçš„å¯¹é½</span><br><span class="line">fieldalign uint8 // è¿™ä¸ªtypeçš„ç»“æ„ä½“å­—æ®µçš„å¯¹é½</span><br><span class="line">kind       uint8 // ç±»å‹ç¼–å· å®šä¹‰äºruntime/typekind.go</span><br><span class="line">alg        *typeAlg</span><br><span class="line">// gcdata stores the GC type data for the garbage collector.</span><br><span class="line">// If the KindGCProg bit is set in kind, gcdata is a GC program.</span><br><span class="line">// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.</span><br><span class="line">gcdata    *byte</span><br><span class="line">str       nameOff // ç±»å‹åå­—çš„åç§»</span><br><span class="line">ptrToThis typeOff</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="iface-å¸¦å‡½æ•°çš„interface"><a href="#iface-å¸¦å‡½æ•°çš„interface" class="headerlink" title="iface (å¸¦å‡½æ•°çš„interface)"></a>iface (å¸¦å‡½æ•°çš„interface)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">type iface struct &#123;</span><br><span class="line">tab  *itab</span><br><span class="line">data unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type itab struct &#123;</span><br><span class="line">inter *interfacetype // interfaceçš„ç±»å‹</span><br><span class="line">_type *_type // åŒä¸Šçš„type</span><br><span class="line">hash  uint32 // copy of _type.hash. Used for type switches.</span><br><span class="line">_     [4]byte</span><br><span class="line">fun   [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter.ï¼Œ funåœ¨æ ˆä¸Šåç§»åœ°å€ï¼Œå› ä¸º funéƒ½æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥é•¿åº¦éƒ½æ˜¯4ä¸ªå­—èŠ‚ï¼Œ æ‰¾åˆ°funçš„é¦–åœ°å€åï¼Œæ¯åç§»4ä¸ªåœ°å€ä¾¿å­˜å‚¨ä¸€ä¸ªå‡½æ•°åœ°å€</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type interfacetype struct &#123;</span><br><span class="line">typ     _type</span><br><span class="line">pkgpath name // åŒ…ä¿¡æ¯</span><br><span class="line">mhdr    []imethod // method sliceï¼Œè¿™é‡Œæ˜¯æ’åºåçš„ï¼Œæ–¹ä¾¿æ£€æµ‹ structæ˜¯å¦ç»§æ‰¿äº† interface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type imethod struct &#123;</span><br><span class="line">name nameOff // å‡½æ•°åå­—çš„åç§»ï¼Œè¿™é‡Œæ˜¯int32,åé¢æŸ¥æ‰¾çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªæ•°å€¼ï¼Œè®¡ç®—å‡ºåç§»é‡ï¼Œ å­˜æ”¾åœ¨ firstmoduledata è¿™ä¸ªç¬¦å·è¡¨ä¸­</span><br><span class="line">ityp typeOff // typeç±»å‹çš„åç§»é‡ï¼Œå¯¹åº”interfaceçš„_type</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>size</code>: å­˜å‚¨ä¸€ä¸ªæŒ‡å®šç±»å‹çš„å€¼éœ€è¦çš„bytesï¼Œ å¯é€šè¿‡ reflect.TypeOf(int8(1)).Size() æˆ– unsafe.Sizeof(x interface{})æ¥è·å–</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">So(unsafe.Sizeof(true), ShouldEqual, 1)</span><br><span class="line">So(unsafe.Sizeof(int8(0)), ShouldEqual, 1)</span><br><span class="line">So(unsafe.Sizeof(int16(0)), ShouldEqual, 2)</span><br><span class="line">So(unsafe.Sizeof(int32(0)), ShouldEqual, 4)</span><br><span class="line">So(unsafe.Sizeof(int64(0)), ShouldEqual, 8)</span><br><span class="line">So(unsafe.Sizeof(int(0)), ShouldEqual, 8)</span><br><span class="line">So(unsafe.Sizeof(float32(0)), ShouldEqual, 4)</span><br><span class="line">So(unsafe.Sizeof(float64(0)), ShouldEqual, 8)</span><br><span class="line">So(unsafe.Sizeof(&quot;&quot;), ShouldEqual, 16)</span><br><span class="line">So(unsafe.Sizeof(&quot;hello world&quot;), ShouldEqual, 16)</span><br><span class="line">So(unsafe.Sizeof([]int&#123;&#125;), ShouldEqual, 24)</span><br><span class="line">So(unsafe.Sizeof([]int&#123;1, 2, 3&#125;), ShouldEqual, 24)</span><br><span class="line">So(unsafe.Sizeof([3]int&#123;1, 2, 3&#125;), ShouldEqual, 24)</span><br><span class="line">So(unsafe.Sizeof(map[string]string&#123;&#125;), ShouldEqual, 8)</span><br><span class="line">So(unsafe.Sizeof(map[string]string&#123;&quot;1&quot;: &quot;one&quot;, &quot;2&quot;: &quot;two&quot;&#125;), ShouldEqual, 8)</span><br><span class="line">So(unsafe.Sizeof(struct&#123;&#125;&#123;&#125;), ShouldEqual, 0)</span><br></pre></td></tr></table></figure></li><li><p><code>_type</code>: å°±æ˜¯è¡¨ç¤ºç»“æ„ä½“çš„ç±»å‹ï¼Œè¿™äº›ç±»å‹ä¼šè¢«å­˜æ”¾åœ¨ firstmoduledata è¿™ä¸ªç¬¦å·è¡¨ä¸­ï¼Œåå°„å…¶å®å°±æ˜¯æ ¹æ® _type é‡Œé¢åç§»é‡æˆ–è€…ç´¢å¼•ï¼Œåˆ°å¯¹åº”åœ°æ–¹è·å–æˆ‘ä»¬è®¤çŸ¥çš„æ•°æ®å¹¶è¿”å›</p></li><li><code>data</code>: å°±æ˜¯æŒ‡å‘ æ•°æ®å­˜æ”¾çš„åœ°å€çš„æŒ‡é’ˆï¼Œä¾‹å¦‚ä¸Šé¢çš„ i interface{} = 3, å…¶å®å°±æ˜¯åœ¨å †æˆ–æ ˆä¸Šåˆ†é…ä¸€ä¸ªç©ºé—´å­˜æ”¾è¿™äº›æ•°æ®ï¼Œç„¶å dataä¸­å­˜æ”¾è¿™ä¸ªåœ°å€ï¼ˆè¿™é‡Œå¯ä»¥ä¼˜åŒ–ï¼Œå¦‚æœ æ•°æ®å ç”¨ç©ºé—´æ¯”æŒ‡é’ˆè¿˜å°çš„è¯ï¼Œå¯ä»¥ç›´æ¥å­˜æ”¾åœ¨dataé‡Œé¢ï¼Œä»¥èŠ‚çº¦ç©ºé—´ï¼‰</li><li><code>iface:inter</code>: å…¶å®æ˜¯å®šä¹‰çš„interfaceçš„ç±»å‹</li><li><code>iface:inter:mhdr</code>: è¿™é‡Œæ˜¯interfaceé‡Œé¢å®šä¹‰çš„å‡½æ•°ï¼ŒæŸä¸ªstructæ˜¯å¦ç»§æ‰¿äº†è¿™ä¸ªinterfaceï¼Œå°±æ˜¯é€šè¿‡ structçš„å‡½æ•°ä¸ mhdré‡Œé¢çš„å‡½æ•°è¿›è¡Œå¯¹æ¯”ï¼Œï¼ˆè¿™é‡Œä¸ºäº†æé«˜æ¯”å¯¹çš„æ•ˆç‡ï¼Œè¿™ä¸ªsliceä¼šè¿›è¡Œæ’åºï¼Œå°†åŸæœ¬ m*n çš„æ•ˆç‡æå‡è‡³ m + nï¼‰</li><li><p><code>fun</code>:<br>  è¿™é‡Œæ˜¯ ç»“æ„ä½“å‡½æ•°çš„å¹³é“ºï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œé¦–å…ˆæˆ‘ä»¬å­˜å‚¨å¥½å‡½æ•°åï¼ŒæŠŠå‡½æ•°çš„åœ°å€ï¼Œè¿½åŠ åˆ° <code>fun[0]</code> çš„åœ°å€æŒ‡å‘çš„ç©ºé—´åé¢</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ifn := typ.textOff(t.ifn)</span><br><span class="line"></span><br><span class="line">*(*unsafe.Pointer)(add(unsafe.Pointer(&amp;m.fun[0]), uintptr(k)*sys.PtrSize)) = ifn</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>  åŒæ—¶ï¼Œæˆ‘ä»¬ä¸ä¼šç”¨åˆ° funçš„é•¿åº¦ï¼Œè€Œæ˜¯æ ¹æ®æŒ‡å®šçš„ç´¢å¼•å»è·å–æˆ‘ä»¬éœ€è¦çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹ä½¿ç”¨</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fn = unsafe.Pointer(&amp;iface.itab.fun[i])</span><br></pre></td></tr></table></figure><p>  æ‰€ä»¥åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸éœ€è¦çŸ¥é“ fun çš„é•¿åº¦ï¼ŒåŠfunçš„ç»“æŸåœ°å€</p></li></ul><h3 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">type Err struct &#123;</span><br><span class="line">Msg string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (err *Err) Error() string &#123;</span><br><span class="line">return &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">err := &amp;Err&#123;&quot;error&quot;&#125;</span><br><span class="line"></span><br><span class="line">// get method</span><br><span class="line">method, _ := reflect.TypeOf(err).MethodByName(&quot;Error&quot;)</span><br><span class="line">fmt.Println(method)</span><br><span class="line"></span><br><span class="line">// get method by method index</span><br><span class="line">method0 := reflect.TypeOf(err).Method(0)</span><br><span class="line">fmt.Println(method0)</span><br><span class="line"></span><br><span class="line">// get kind</span><br><span class="line">kind := reflect.TypeOf(err).Kind()</span><br><span class="line">fmt.Println(&quot;unknow kind &quot;, kind)</span><br><span class="line"></span><br><span class="line">// change value</span><br><span class="line">reflect.ValueOf(err).Elem().Field(0).SetString(&quot;test&quot;)</span><br><span class="line">fmt.Println(*err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;Error  func(*main.Err) string &lt;func(*main.Err) string Value&gt; 0&#125;</span><br><span class="line">&#123;Error  func(*main.Err) string &lt;func(*main.Err) string Value&gt; 0&#125;</span><br><span class="line">unknow kind  ptr</span><br><span class="line">&#123;test&#125;</span><br></pre></td></tr></table></figure></p><p>æ¥ä¸‹æ¥ï¼Œæ ¹æ®ä¸Šé¢çš„ä¾‹å­ï¼Œåˆ†åˆ«è¿½è¸ªä¸€ä¸‹ <code>TypeOf</code> <code>MethodByName</code> <code>Method</code> <code>Method</code> <code>Elem</code> <code>Field</code> <code>SetString</code> è¿™äº›å‡½æ•°åœ¨æˆ‘ä»¬çš„æ‰§è¡Œæµç¨‹ä¸­åï¼Œéƒ½åšäº†äº›ä»€ä¹ˆï¼ŒåŠ æ·±ä¸€ä¸‹å¯¹interfaceçš„ç†è§£</p><h4 id="ç›¸å…³ç»“æ„ä½“"><a href="#ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ç›¸å…³ç»“æ„ä½“"></a>ç›¸å…³ç»“æ„ä½“</h4><p>è¿™é‡Œæ˜¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">type Value struct &#123;</span><br><span class="line">// typ holds the type of the value represented by a Value.</span><br><span class="line">typ *rtype</span><br><span class="line"></span><br><span class="line">// Pointer-valued data or, if flagIndir is set, pointer to data.</span><br><span class="line">// Valid when either flagIndir is set or typ.pointers() is true.</span><br><span class="line">ptr unsafe.Pointer</span><br><span class="line"></span><br><span class="line">// flag holds metadata about the value.</span><br><span class="line">// The lowest bits are flag bits:</span><br><span class="line">//- flagStickyRO: obtained via unexported not embedded field, so read-only</span><br><span class="line">//- flagEmbedRO: obtained via unexported embedded field, so read-only</span><br><span class="line">//- flagIndir: val holds a pointer to the data</span><br><span class="line">//- flagAddr: v.CanAddr is true (implies flagIndir)</span><br><span class="line">//- flagMethod: v is a method value.</span><br><span class="line">// The next five bits give the Kind of the value.</span><br><span class="line">// This repeats typ.Kind() except for method values.</span><br><span class="line">// The remaining 23+ bits give a method number for method values.</span><br><span class="line">// If flag.kind() != Func, code can assume that flagMethod is unset.</span><br><span class="line">// If ifaceIndir(typ), code can assume that flagIndir is set.</span><br><span class="line">flag</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Type interface &#123;</span><br><span class="line">Align() int</span><br><span class="line">FieldAlign() int</span><br><span class="line">Method(int) Method</span><br><span class="line">NumMethod() int</span><br><span class="line">Name() string</span><br><span class="line">PkgPath() string</span><br><span class="line">Size() uintptr</span><br><span class="line">String() string</span><br><span class="line">Kind() Kind</span><br><span class="line">Implements(u Type) bool</span><br><span class="line">AssignableTo(u Type) bool</span><br><span class="line">ConvertibleTo(u Type) bool</span><br><span class="line">Comparable() bool</span><br><span class="line">Bits() int</span><br><span class="line">ChanDir() ChanDir</span><br><span class="line">IsVariadic() boolElem() Type</span><br><span class="line">Field(i int) StructField</span><br><span class="line">FieldByIndex(index []int) StructField</span><br><span class="line">FieldByName(name string) (StructField, bool)</span><br><span class="line">FieldByNameFunc(match func(string) bool) (StructField, bool)</span><br><span class="line">In(i int) Type</span><br><span class="line">Key() Type</span><br><span class="line">Len() int</span><br><span class="line">NumField() int</span><br><span class="line">NumIn() int</span><br><span class="line">NumOut() int</span><br><span class="line">common() *rtype</span><br><span class="line">uncommon() *uncommonType</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type emptyInterface struct &#123;</span><br><span class="line">typ  *rtype</span><br><span class="line">word unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type interfaceType struct &#123;</span><br><span class="line">rtype</span><br><span class="line">pkgPath name      // import path</span><br><span class="line">methods []imethod // sorted by hash</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type rtype struct &#123;</span><br><span class="line">size       uintptr</span><br><span class="line">ptrdata    uintptr  // number of bytes in the type that can contain pointers</span><br><span class="line">hash       uint32   // hash of type; avoids computation in hash tables</span><br><span class="line">tflag      tflag    // extra type information flags</span><br><span class="line">align      uint8    // alignment of variable with this type</span><br><span class="line">fieldAlign uint8    // alignment of struct field with this type</span><br><span class="line">kind       uint8    // enumeration for C</span><br><span class="line">alg        *typeAlg // algorithm table</span><br><span class="line">gcdata     *byte    // garbage collection data</span><br><span class="line">str        nameOff  // string form</span><br><span class="line">ptrToThis  typeOff  // type for pointer to this type, may be zero</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type name struct &#123;</span><br><span class="line">bytes *byte</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="TypeOf-err-MethodByName-â€œErrorâ€"><a href="#TypeOf-err-MethodByName-â€œErrorâ€" class="headerlink" title="TypeOf(err).MethodByName(â€œErrorâ€)"></a>TypeOf(err).MethodByName(â€œErrorâ€)</h4><p><strong>TypeOf</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func TypeOf(i interface&#123;&#125;) Type &#123;</span><br><span class="line">eface := *(*emptyInterface)(unsafe.Pointer(&amp;i))</span><br><span class="line">return toType(eface.typ)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func toType(t *rtype) Type &#123;</span><br><span class="line">if t == nil &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line">return t</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ ¹æ®ä¸Šé¢çš„é€»è¾‘ï¼Œ<code>TypeOf</code> å°±æ˜¯æŠŠ interface{} è½¬æˆäº† emptyInterfaceï¼Œ ç„¶å è¿”å›äº† <code>rtype</code>ç»“æ„ï¼Œ åœ¨ <code>func toType(t *rtype) Type</code> ä¸­ï¼Œè¦æ±‚è¿”å›çš„æ˜¯ <code>Type</code> æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>rtype</code> ç»§æ‰¿äº† <code>Type</code>ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ç»§ç»­ä½¿ç”¨<code>Type</code>ä¸­çš„å‡½æ•°äº†</p><p><strong>MethodByName</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">func (t *rtype) MethodByName(name string) (m Method, ok bool) &#123;</span><br><span class="line">if t.Kind() == Interface &#123;</span><br><span class="line">tt := (*interfaceType)(unsafe.Pointer(t))</span><br><span class="line">return tt.MethodByName(name)</span><br><span class="line">&#125;</span><br><span class="line">ut := t.uncommon()</span><br><span class="line">if ut == nil &#123;</span><br><span class="line">return Method&#123;&#125;, false</span><br><span class="line">&#125;</span><br><span class="line">// TODO(mdempsky): Binary search.</span><br><span class="line">for i, p := range ut.exportedMethods() &#123;</span><br><span class="line">if t.nameOff(p.name).name() == name &#123;</span><br><span class="line">return t.Method(i), true</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return Method&#123;&#125;, false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>interfaceType</code> åœ¨ä¸Šé¢å·²ç»è´´å‡ºæ¥äº†</p><ul><li>åœ¨ç¬¬3è¡Œåˆ¤æ–­æ˜¯å¦æ˜¯ interface ç±»å‹ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œç»§ç»­è°ƒç”¨ interfaceçš„ tt.MethodByNameï¼Œåé¢ç»§ç»­è¿½è¸ª</li><li>å¦‚æœä¸æ˜¯interfaceï¼Œåˆ™æ‹¿åˆ°å­˜å‚¨çš„å‡½æ•°åœ°å€çš„sliceï¼Œéå†è¿™ä¸ªsliceï¼Œå¹¶è·Ÿnameçš„åœ°å€è·å–å‡½æ•°çš„ nameï¼ŒåŒ¹é…æ˜¯å¦ç›¸åŒ</li></ul><p><strong>interfaceType.MethodByName</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func (t *interfaceType) MethodByName(name string) (m Method, ok bool) &#123;</span><br><span class="line">if t == nil &#123;</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">var p *imethod</span><br><span class="line">for i := range t.methods &#123;</span><br><span class="line">p = &amp;t.methods[i]</span><br><span class="line">if t.nameOff(p.name).name() == name &#123;</span><br><span class="line">return t.Method(i), true</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè·Ÿä¸Šé¢çš„é€»è¾‘ä¸€æ ·ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª<code>nameOff</code>çš„å‡½æ•°ï¼Œè¿™é‡Œæ˜¯æ ¹æ®åœ°å€åŠåç§»é‡è®¡ç®—å‡ºç›®æ ‡åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿›è¡ŒæŒ‡é’ˆè¿ç®—</p><h4 id="TypeOf-err-Method-0"><a href="#TypeOf-err-Method-0" class="headerlink" title="TypeOf(err).Method(0)"></a>TypeOf(err).Method(0)</h4><p><code>TypeOf(err).Method()</code>è·Ÿ<code>MethodByName</code>ä¸€æ ·ï¼Œå¦‚æœæ˜¯interfaceï¼Œåˆ™è½¬åˆ° <code>interfaceType.MethodByName</code>ï¼Œå¦‚æ­¤ï¼Œç›´æ¥è¿½è¸ªå³å¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func (t *interfaceType) Method(i int) (m Method) &#123;</span><br><span class="line">if i &lt; 0 || i &gt;= len(t.methods) &#123;</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">p := &amp;t.methods[i]</span><br><span class="line">pname := t.nameOff(p.name)</span><br><span class="line">m.Name = pname.name()</span><br><span class="line">if !pname.isExported() &#123;</span><br><span class="line">m.PkgPath = pname.pkgPath()</span><br><span class="line">if m.PkgPath == &quot;&quot; &#123;</span><br><span class="line">m.PkgPath = t.pkgPath.name()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">m.Type = toType(t.typeOff(p.typ))</span><br><span class="line">m.Index = i</span><br><span class="line">return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>ç›´æ¥æ ¹æ®ç´¢å¼•ï¼Œæ‰¾åˆ°å¯¹åº”çš„<code>imethod</code>çš„ç»“æ„ä½“</li><li>ç„¶åæ ¹æ®<code>imethod</code>ç»“æ„ä½“ä¸­çš„<code>nameOff</code>åç§»æŒ‡é’ˆï¼Œæ‰¾åˆ°<code>name</code>ç»“æ„ä½“</li><li>ç„¶åè°ƒç”¨ <code>name</code> çš„  <code>name()</code> æ–¹æ³•è·å–åå­—</li><li>isExportedæš‚æ—¶å¿½ç•¥ï¼Œè®¾è®¡ <code>name</code>ä¸‹<code>bytes</code>å±æ€§çš„è®¾è®¡</li><li>è½¬æ¢m.Type</li><li>æ·»åŠ m.Index</li><li>è¿”å›<br>æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨ <code>MethodByName</code> å’Œ <code>Method</code> éƒ½æ˜¯åœ¨ <code>methods</code> ä¸­æŸ¥æ‰¾ï¼Œä¸ä¸€æ ·çš„æ˜¯ï¼Œ<code>MethodByName</code>éœ€è¦éå† <code>methods</code> è¿™ä¸ªslice<br>æˆ‘ä»¬åœ¨ä¸Šé¢è¯´è¿‡ï¼Œ <code>methods</code>è¿™é‡Œsliceæ˜¯ä¼šè¿›è¡Œhashæ’åºçš„ï¼Œæ‰€ä»¥<strong>è¿™é‡Œé¢çš„ç´¢å¼•å¹¶ä¸æ˜¯æŒ‰ç…§å‡½æ•°çš„å£°æ˜é¡ºåºæ¥æ’åˆ—çš„ï¼ï¼ï¼</strong></li></ul><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><ul><li><a href="http://legendtkl.com/2017/07/01/golang-interface-implement/" target="_blank" rel="noopener">ã€ŠGo Interface æºç å‰–æã€‹</a></li><li><a href="https://research.swtch.com/interfaces" target="_blank" rel="noopener">ã€ŠGo Data Structures: Interfacesã€‹</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Goå€¼æ‹·è´çš„ä¸€äº›æ€è€ƒ</title>
      <link href="/posts/50287/"/>
      <url>/posts/50287/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="æ–‡æ¡£åœ°å€ï¼šhttps://golang.org/ref/spec#Calls">In a function call, the function value and arguments are evaluated in the usual order. After they are evaluated, the parameters of the call are passed by value to the function and the called function begins execution.</a></p></blockquote><p>å®˜æ–¹æ–‡æ¡£å·²ç»æ˜ç¡®è¯´æ˜ï¼šGoé‡Œè¾¹å‡½æ•°ä¼ å‚åªæœ‰å€¼ä¼ é€’ä¸€ç§æ–¹å¼: å€¼ä¼ é€’<br>é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå¼•å‘Goçš„å€¼æ‹·è´çš„è®¨è®ºï¼Ÿ<br><a id="more"></a></p><h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>ç”¨ä¸‹é¢çš„ä»£ç åšä¸€ä¸‹å±•ç¤º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">arr := [5]int&#123;0, 1, 2, 3, 4&#125;</span><br><span class="line">s := arr[1:]</span><br><span class="line">changeSlice(s)</span><br><span class="line">fmt.Println(s)</span><br><span class="line">fmt.Println(arr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func changeSlice(arr []int) &#123;</span><br><span class="line">for i := range arr &#123;</span><br><span class="line">arr[i] = 10</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¾“å‡ºç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[10 10 10 10]</span><br><span class="line">[0 10 10 10 10]</span><br></pre></td></tr></table></figure><p>å¦‚æœGoæ˜¯å€¼æ‹·è´çš„ï¼Œé‚£ä¹ˆæˆ‘ä¿®æ”¹äº†å‡½æ•° <code>changeSlice</code> é‡Œé¢çš„<code>slice s</code> çš„å€¼ï¼Œä¸ºä»€ä¹ˆmainå‡½æ•°é‡Œé¢çš„<code>slice</code>å’Œ <code>array</code>ä¹Ÿè¢«ä¿®æ”¹äº†</p><h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/address.jpg" alt></p><p>ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œa æ˜¯åˆå§‹å˜é‡ï¼Œb æ˜¯å¼•ç”¨å˜é‡(Goä¸­å¹¶ä¸å­˜åœ¨)ï¼Œp æ˜¯æŒ‡é’ˆå˜é‡<br>å˜é‡aè¢«æ‹·è´åï¼Œåœ°å€å‘ç”Ÿäº†å˜åŒ–ï¼Œåœ°å€ä¸Šå­˜å‚¨çš„æ˜¯åŸå…ˆåœ°å€å­˜å‚¨çš„å€¼ 10<br>å˜é‡pè¢«æ‹·è´åï¼Œåœ°å€å‘ç”Ÿäº†å˜åŒ–ï¼Œåœ°å€ä¸Šå­˜å‚¨çš„è¿˜æ˜¯åŸå…ˆåœ°å€å­˜å‚¨çš„å€¼ ï¼‰0X001, ç„¶åæŒ‰ç…§è¿™ä¸ªåœ°å€å»æŸ¥æ‰¾ï¼Œæ‰¾åˆ°çš„æ˜¯ 0X001 ä¸Šé¢å­˜å‚¨çš„å€¼</p><p>æ‰€ä»¥ï¼Œå½“ä½ å»ä¿®æ”¹æ‹·è´åçš„*pçš„å€¼ï¼Œå…¶å®ä¿®æ”¹çš„è¿˜æ˜¯0X001åœ°å€ä¸Šçš„å€¼ï¼Œè€Œä¸æ˜¯ æ‹·è´åaçš„å€¼</p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/slice-array.jpg" alt></p><p>é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹sliceï¼Œsliceåœ¨å®ç°çš„æ—¶å€™ï¼Œå…¶å®æ˜¯å¯¹arrayçš„æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯è¯´sliceå­˜å¯¹åº”çš„æ˜¯åŸarrayçš„åœ°å€ï¼Œå°±ç±»ä¼¼äºpä¸açš„å…³ç³»ï¼Œé‚£ä¹ˆæ•´ä¸ªsliceæ‹·è´åï¼Œæ‹·è´åçš„sliceä¸­å­˜å‚¨çš„è¿˜æ˜¯arrayçš„åœ°å€ï¼Œå»ä¿®æ”¹æ‹·è´åçš„sliceï¼Œå…¶å®è·Ÿä¿®æ”¹sliceï¼Œå’ŒåŸarrayæ˜¯ä¸€æ ·çš„</p><h2 id="è¯•éªŒ"><a href="#è¯•éªŒ" class="headerlink" title="è¯•éªŒ"></a>è¯•éªŒ</h2><p>æˆ‘ä»¬ç”¨ä¸‹é¢ä¸€ä¸ªä¾‹å­ï¼Œå®ç°ä»¥ä¸‹æˆ‘ä»¬ä¸Šé¢çš„æƒ³æ³•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">var a *int</span><br><span class="line">b := 10</span><br><span class="line">a = &amp;b</span><br><span class="line">change(a)</span><br><span class="line">fmt.Println(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func change(a *int) &#123;</span><br><span class="line">*a = 30</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ‰“å°ç»“æœ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xc000096000 30</span><br></pre></td></tr></table></figure></p><p>ç¬¦åˆçŒœæƒ³</p><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>è¿™é‡Œçš„ä¸œè¥¿ï¼Œå…¶å®ç”¨dlvè°ƒè¯•ä¼šçœ‹çš„å¾ˆæ–¹ä¾¿ï¼Œæœ‰å…´è¶£å¯ä»¥åŠ¨ä¸€ä¸‹æ‰‹</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>Goçš„æ‹·è´éƒ½æ˜¯å€¼æ‹·è´ï¼Œåªæ˜¯sliceä¸­å­˜å‚¨çš„æ˜¯åŸarrayçš„åœ°å€ï¼Œæ‰€ä»¥åœ¨æ‹·è´çš„æ—¶å€™ï¼Œå…¶å®æ˜¯æŠŠåœ°å€æ‹·è´çš„æ–°çš„sliceï¼Œé‚£ä¹ˆæ­¤æ—¶ä¿®æ”¹sliceçš„æ—¶å€™ï¼Œè¿˜æ˜¯æ ¹æ®sliceä¸­å­˜å‚¨çš„åœ°å€ï¼Œæ‰¾åˆ°è¦ä¿®æ”¹çš„å†…å®¹</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Goçš„è°ƒè¯•å·¥å…·:gdb vs dlv</title>
      <link href="/posts/8063/"/>
      <url>/posts/8063/</url>
      
        <content type="html"><![CDATA[<p>GoLandç¼–è¾‘å™¨è™½ç„¶å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯åœ¨å±•ç¤ºå†…å­˜åŠå †æ ˆä¿¡æ¯è¿™ä¸€å—è¿˜æ˜¯æ¯”è¾ƒçš„å¼±ï¼Œæœ‰å¯èƒ½æ˜¯æˆ‘çš„å§¿åŠ¿ä¸å¯¹ï¼Œæ‰€ä»¥ï¼Œå¼€å§‹åˆ‡å…¥äº†gdbè°ƒè¯•ï¼Œä½†æ˜¯gdbè¸©åˆ°äº†å‘ï¼Œå¹¶æ²¡æœ‰è§£å†³ï¼Œä¹Ÿå°±å¼•å‘äº†gdbä¸dlvçš„å¯¹æ¯”äº†</p><a id="more"></a><h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install ncures-devel</span><br><span class="line">wget http://ftp.gnu.org/gnu/gdb/gdb-8.2.tar.gz</span><br><span class="line">tar zxf gdb-8.2.tar.gz</span><br><span class="line">cd gdb-8.2</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="è¿›å…¥è°ƒè¯•"><a href="#è¿›å…¥è°ƒè¯•" class="headerlink" title="è¿›å…¥è°ƒè¯•"></a>è¿›å…¥è°ƒè¯•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go build -gcflags &apos;-N -l&apos; main.go</span><br><span class="line">gdb main</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><ol><li><p>å¯åŠ¨è°ƒè¯•ç¨‹åºï¼ˆ<code>gdb</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lday@alex GoDbg]$ gdb ./GoDbg</span><br></pre></td></tr></table></figure></li><li><p>åœ¨mainå‡½æ•°ä¸Šè®¾ç½®æ–­ç‚¹ï¼ˆ<code>b</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b main.main</span><br><span class="line">Breakpoint 1 at 0x401000: file /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go, line 9.</span><br></pre></td></tr></table></figure></li><li><p>å¸¦å‚æ•°å¯åŠ¨ç¨‹åºï¼ˆ<code>r</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) r arg1 arg2</span><br><span class="line">Starting program: /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/GoDbg arg1 arg2</span><br><span class="line">[New LWP 8412]</span><br><span class="line">[New LWP 8413]</span><br><span class="line">[New LWP 8414]</span><br><span class="line">[New LWP 8415]</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main.main () at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9</span><br><span class="line">9    func main() &#123;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ–‡ä»¶dbgTest.goä¸Šé€šè¿‡è¡Œå·è®¾ç½®æ–­ç‚¹ï¼ˆ<code>b</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b dbgTest.go:16</span><br><span class="line">Breakpoint 3 at 0x457960: file /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go, line 16.</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ–­ç‚¹è®¾ç½®æƒ…å†µï¼ˆ<code>info b</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x0000000000401000 in main.main </span><br><span class="line">                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9</span><br><span class="line">    breakpoint already hit 1 time</span><br><span class="line">2       breakpoint     keep y   0x0000000000401000 in main.main </span><br><span class="line">                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9</span><br><span class="line">    breakpoint already hit 1 time</span><br><span class="line">3       breakpoint     keep y   0x0000000000457960 in GoWorks/GoDbg/mylib.DBGTestRun </span><br><span class="line">                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:16</span><br></pre></td></tr></table></figure></li><li><p>ç¦ç”¨æ–­ç‚¹ï¼ˆ<code>dis n</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) dis 1   </span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep n   0x0000000000401000 in main.main </span><br><span class="line">                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9</span><br><span class="line">    breakpoint already hit 1 time</span><br><span class="line">2       breakpoint     keep y   0x0000000000401000 in main.main </span><br><span class="line">                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9</span><br><span class="line">    breakpoint already hit 1 time</span><br><span class="line">3       breakpoint     keep y   0x0000000000457960 in GoWorks/GoDbg/mylib.DBGTestRun </span><br><span class="line">                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:16</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤æ–­ç‚¹ï¼ˆ<code>del n</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) del 1</span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">2       breakpoint     keep y   0x0000000000401000 in main.main </span><br><span class="line">                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9</span><br><span class="line">    breakpoint already hit 1 time</span><br><span class="line">3       breakpoint     keep y   0x0000000000457960 in GoWorks/GoDbg/mylib.DBGTestRun </span><br><span class="line">                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:16</span><br></pre></td></tr></table></figure></li><li><p>æ–­ç‚¹åç»§ç»­æ‰§è¡Œï¼ˆ<code>c</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">Golang dbg test...</span><br><span class="line">argc:3</span><br><span class="line">argv:[/home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/GoDbg arg1 arg2]</span><br><span class="line"></span><br><span class="line">Breakpoint 3, GoWorks/GoDbg/mylib.DBGTestRun (var1=1, var2=&quot;golang dbg test&quot;)</span><br><span class="line">    at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:16</span><br><span class="line">16    func DBGTestRun(var1 int, var2 string, var3 []int, var4 MyStruct) &#123;</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure></li><li><p>æ˜¾ç¤ºä»£ç ï¼ˆ<code>l</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) l</span><br><span class="line">11        B string</span><br><span class="line">12        C map[int]string</span><br><span class="line">13        D []string</span><br><span class="line">14    &#125;</span><br><span class="line">15    </span><br><span class="line">16    func DBGTestRun(var1 int, var2 string, var3 []int, var4 MyStruct) &#123;</span><br><span class="line">17        fmt.Println(&quot;DBGTestRun Begin!\n&quot;)</span><br><span class="line">18        waiter := &amp;sync.WaitGroup&#123;&#125;</span><br><span class="line">19    </span><br><span class="line">20        waiter.Add(1)</span><br></pre></td></tr></table></figure></li><li><p>å•æ­¥æ‰§è¡Œï¼ˆ<code>n</code>ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">DBGTestRun Begin!</span><br><span class="line"></span><br><span class="line">18        waiter := &amp;sync.WaitGroup&#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ‰“å°å˜é‡ä¿¡æ¯ï¼ˆ<code>print/p</code>ï¼‰<br>åœ¨è¿›å…¥DBGTestRunçš„åœ°æ–¹è®¾ç½®æ–­ç‚¹(<code>b dbgTest.go:16</code>)ï¼Œè¿›å…¥è¯¥å‡½æ•°åï¼Œé€šè¿‡på‘½ä»¤æ˜¾ç¤ºå¯¹åº”å˜é‡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) l 17</span><br><span class="line">12        C map[int]string</span><br><span class="line">13        D []string</span><br><span class="line">14    &#125;</span><br><span class="line">15    </span><br><span class="line">16    func DBGTestRun(var1 int, var2 string, var3 []int, var4 MyStruct) &#123;</span><br><span class="line">17        fmt.Println(&quot;DBGTestRun Begin!\n&quot;)</span><br><span class="line">18        waiter := &amp;sync.WaitGroup&#123;&#125;</span><br><span class="line">19    </span><br><span class="line">20        waiter.Add(1)</span><br><span class="line">21        go RunFunc1(var1, waiter)</span><br><span class="line">(gdb) p var1 </span><br><span class="line">$3 = 1</span><br><span class="line">(gdb) p var2</span><br><span class="line">$4 = &quot;golang dbg test&quot;</span><br><span class="line">(gdb) p var3</span><br><span class="line">No symbol &quot;var3&quot; in current context.</span><br></pre></td></tr></table></figure><p><strong>ä»ä¸Šé¢çš„è¾“å‡ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„äº‹æƒ…ï¼Œè™½ç„¶DBGTestRunæœ‰4ä¸ªå‚æ•°ä¼ å…¥ï¼Œä½†æ˜¯ï¼Œä¼¼ä¹var3å’Œvar4 gdbæ— æ³•è¯†åˆ«ï¼Œåœ¨åç»­å¯¹dlvçš„å®éªŒæ“ä½œä¸­ï¼Œæˆ‘ä»¬å‘ç°ï¼Œdlvèƒ½å¤Ÿè¯†åˆ«var3ï¼Œ var4.</strong></p></li><li><p>æŸ¥çœ‹è°ƒç”¨æ ˆï¼ˆ<code>bt</code>ï¼‰ï¼Œåˆ‡æ¢è°ƒç”¨æ ˆï¼ˆ<code>f n</code>ï¼‰ï¼Œæ˜¾ç¤ºå½“å‰æ ˆå˜é‡ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  GoWorks/GoDbg/mylib.DBGTestRun (var1=1, var2=&quot;golang dbg test&quot;)</span><br><span class="line">    at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:17</span><br><span class="line">#1  0x00000000004018c2 in main.main () at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:27</span><br><span class="line">(gdb) f 1</span><br><span class="line">#1  0x00000000004018c2 in main.main () at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:27</span><br><span class="line">27        mylib.DBGTestRun(var1, var2, var3, var4)</span><br><span class="line">(gdb) l</span><br><span class="line">22        var4.A = 1</span><br><span class="line">23        var4.B = &quot;golang dbg my struct field B&quot;</span><br><span class="line">24        var4.C = map[int]string&#123;1: &quot;value1&quot;, 2: &quot;value2&quot;, 3: &quot;value3&quot;&#125;</span><br><span class="line">25        var4.D = []string&#123;&quot;D1&quot;, &quot;D2&quot;, &quot;D3&quot;&#125;</span><br><span class="line">26    </span><br><span class="line">27        mylib.DBGTestRun(var1, var2, var3, var4)</span><br><span class="line">28        fmt.Println(&quot;Golang dbg test over&quot;)</span><br><span class="line">29    &#125;</span><br><span class="line">(gdb) print var1 </span><br><span class="line">$5 = 1</span><br><span class="line">(gdb) print var2</span><br><span class="line">$6 = &quot;golang dbg test&quot;</span><br><span class="line">(gdb) print var3</span><br><span class="line">$7 =  []int = &#123;1, 2, 3&#125;</span><br><span class="line"></span><br><span class="line">(gdb) print var4</span><br><span class="line">$8 = &#123;A = 1, B = &quot;golang dbg my struct field B&quot;, C = map[int]string = &#123;[1] = &quot;value1&quot;, [2] = &quot;value2&quot;, [3] = &quot;value3&quot;&#125;, </span><br><span class="line">D =  []string = &#123;&quot;D1&quot;, &quot;D2&quot;, &quot;D3&quot;&#125;&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="dlv-æ¨è"><a href="#dlv-æ¨è" class="headerlink" title="dlv(æ¨è)"></a>dlv(æ¨è)</h2><h3 id="å®‰è£…-1"><a href="#å®‰è£…-1" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/go-delve/delve/cmd/dlv</span><br></pre></td></tr></table></figure><h3 id="è¿›å…¥è°ƒè¯•-1"><a href="#è¿›å…¥è°ƒè¯•-1" class="headerlink" title="è¿›å…¥è°ƒè¯•"></a>è¿›å…¥è°ƒè¯•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dlv debug main.go</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-1"><a href="#ä½¿ç”¨-1" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">args ------------------------ Print function arguments.</span><br><span class="line">break (alias: b) ------------ Sets a breakpoint.</span><br><span class="line">breakpoints (alias: bp) ----- Print out info for active breakpoints.</span><br><span class="line">call ------------------------ Resumes process, injecting a function call (EXPERIMENTAL!!!)</span><br><span class="line">clear ----------------------- Deletes breakpoint.</span><br><span class="line">clearall -------------------- Deletes multiple breakpoints.</span><br><span class="line">condition (alias: cond) ----- Set breakpoint condition.</span><br><span class="line">config ---------------------- Changes configuration parameters.</span><br><span class="line">continue (alias: c) --------- Run until breakpoint or program termination.</span><br><span class="line">deferred -------------------- Executes command in the context of a deferred call.</span><br><span class="line">disassemble (alias: disass) - Disassembler.</span><br><span class="line">down ------------------------ Move the current frame down.</span><br><span class="line">edit (alias: ed) ------------ Open where you are in $DELVE_EDITOR or $EDITOR</span><br><span class="line">exit (alias: quit | q) ------ Exit the debugger.</span><br><span class="line">frame ----------------------- Set the current frame, or execute command on a different frame.</span><br><span class="line">funcs ----------------------- Print list of functions.</span><br><span class="line">goroutine ------------------- Shows or changes current goroutine</span><br><span class="line">goroutines ------------------ List program goroutines.</span><br><span class="line">help (alias: h) ------------- Prints the help message.</span><br><span class="line">libraries ------------------- List loaded dynamic libraries</span><br><span class="line">list (alias: ls | l) -------- Show source code.</span><br><span class="line">locals ---------------------- Print local variables.</span><br><span class="line">next (alias: n) ------------- Step over to next source line.</span><br><span class="line">on -------------------------- Executes a command when a breakpoint is hit.</span><br><span class="line">print (alias: p) ------------ Evaluate an expression.</span><br><span class="line">regs ------------------------ Print contents of CPU registers.</span><br><span class="line">restart (alias: r) ---------- Restart process.</span><br><span class="line">set ------------------------- Changes the value of a variable.</span><br><span class="line">source ---------------------- Executes a file containing a list of delve commands</span><br><span class="line">sources --------------------- Print list of source files.</span><br><span class="line">stack (alias: bt) ----------- Print stack trace.</span><br><span class="line">step (alias: s) ------------- Single step through program.</span><br><span class="line">step-instruction (alias: si)  Single step a single cpu instruction.</span><br><span class="line">stepout --------------------- Step out of the current function.</span><br><span class="line">thread (alias: tr) ---------- Switch to the specified thread.</span><br><span class="line">threads --------------------- Print out info for every traced thread.</span><br><span class="line">trace (alias: t) ------------ Set tracepoint.</span><br><span class="line">types ----------------------- Print list of types</span><br><span class="line">up -------------------------- Move the current frame up.</span><br><span class="line">vars ------------------------ Print package variables.</span><br><span class="line">whatis ---------------------- Prints type of an expression.</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li><p>dlvå¯¹goroutineçš„æ”¯æŒæ›´å¥½ï¼Œæˆ‘ä½¿ç”¨gdbçš„æ²¡æœ‰æ‰¾åˆ°goroutineçš„è°ƒè¯•æ–¹æ³•ï¼Œå¯èƒ½å§¿åŠ¿ä¸å¯¹</p></li><li><p>gdbå¯¹äºå±€éƒ¨å¼•ç”¨å˜é‡æ— æ³•è°ƒè¯•ï¼Œdlvä¸ä¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  i := <span class="number">10</span></span><br><span class="line">  j := &amp;i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç ï¼Œgdb ä½¿ç”¨ <code>p j</code> æ‰“å°å˜é‡jçš„æ—¶å€™æŠ¥é”™ï¼Œdlvå´å¯ä»¥</p></li><li><p>dlvæ— æ³•è°ƒè¯•interfaceç­‰Goå†…éƒ¨å®ç°çš„ä¸€äº›ç»“æ„ï¼Œgdbæ˜¯å¯ä»¥çš„</p></li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://lday.me/2017/02/27/0005_gdb-vs-dlv/" target="_blank" rel="noopener">ã€ŠGolangç¨‹åºè°ƒè¯•å·¥å…·ä»‹ç»(gdb vs dlv)ã€‹</a></p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golangå¸¸è§é”™è¯¯ä¹‹goroutineä½¿ç”¨å˜é‡é—®é¢˜</title>
      <link href="/posts/22138/"/>
      <url>/posts/22138/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.jb51.net/article/128539.htm" target="_blank" rel="noopener">https://www.jb51.net/article/128539.htm</a><br>é’ˆå¯¹è¿™ç¯‡æ–‡ç« å¼•å‘çš„ä¸€äº›å®éªŒ<br><a id="more"></a></p><p>åœ¨çœ‹è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæ€»æ„Ÿè§‰ç”¨æ–‡ç« ä¸­çš„ä¾‹å­è¯´æ˜å€¼æ‹·è´å’ŒæŒ‡é’ˆæ‹·è´æ˜¯æœ‰é—®é¢˜çš„ï¼Œè€Œä¸”goå®˜æ–¹è¯´ï¼Œä»–ä»¬çš„æ‹·è´åªæœ‰å€¼æ‹·è´ä¸€ç§ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä½¿ç”¨æŒ‡é’ˆç±»å‹å’ŒéæŒ‡é’ˆç±»å‹ï¼Œä¼šå‡ºç°ä¸åŒçš„ç°è±¡ï¼Œåœ¨è¿½è¸ªçš„è¿‡ç¨‹äº†å°±å‘ç°äº†ä¸‹é¢çš„å¥‡è‘©å®ä¾‹</p><h2 id="è¯•éªŒä»£ç "><a href="#è¯•éªŒä»£ç " class="headerlink" title="è¯•éªŒä»£ç "></a>è¯•éªŒä»£ç </h2><pre><code>package mainimport (    &quot;fmt&quot;    &quot;time&quot;)type fieldNoPointer struct {    name string}func (p fieldNoPointer) Print() {    fmt.Println(p.name)}type fieldPointer struct {    name string}func (p *fieldPointer) Print() {    fmt.Println(p.name)}func main() {    printDataWithPointerUseFieldPointerWithFunc()    printDataWithPointerUseFieldPointerWithNoFunc()    printDataWithNoPointerUseFieldPointerWithFunc()    printDataWithNoPointerUseFieldPointerWithNoFunc()    printDataWithPointerUseFieldNoPointerWithFunc()    printDataWithPointerUseFieldNoPointerWithNoFunc()    printDataWithNoPointerUseFieldNoPointerWithFunc()    printDataWithNoPointerUseFieldNoPointerWithNoFunc()    time.Sleep(1)}func printDataWithPointerUseFieldPointerWithFunc()  {    fmt.Println(&quot;print by get printDataWithPointerUseFieldPointerWithFunc&quot;)    data := []*fieldPointer{{"one"},{"two"},{"three"}}    for _,v := range data {        go func() {            v.Print()        }()    }    time.Sleep(time.Second)}func printDataWithPointerUseFieldPointerWithNoFunc()  {    fmt.Println(&quot;print by get printDataWithPointerUseFieldPointerWithNoFunc&quot;)    data := []*fieldPointer{{"one"},{"two"},{"three"}}    for _,v := range data {        go v.Print()    }    time.Sleep(time.Second)}func printDataWithNoPointerUseFieldPointerWithFunc()  {    fmt.Println(&quot;print by get printDataWithNoPointerUseFieldPointerWithFunc&quot;)    data := []fieldPointer{{"one"},{"two"},{"three"}}    for _,v := range data {        go func() {            v.Print()        }()    }    time.Sleep(time.Second)}func printDataWithNoPointerUseFieldPointerWithNoFunc()  {    fmt.Println(&quot;print by get printDataWithNoPointerUseFieldPointerWithNoFunc&quot;)    data := []fieldPointer{{"one"},{"two"},{"three"}}    for _,v := range data {        go v.Print()    }    time.Sleep(time.Second)}func printDataWithPointerUseFieldNoPointerWithFunc()  {    fmt.Println(&quot;print by get printDataWithPointerUseFieldNoPointerWithFunc&quot;)    data := []*fieldNoPointer{{"one"},{"two"},{"three"}}    for _,v := range data {        go func() {            v.Print()        }()    }    time.Sleep(time.Second)}func printDataWithPointerUseFieldNoPointerWithNoFunc()  {    fmt.Println(&quot;print by get printDataWithPointerUseFieldNoPointerWithNoFunc&quot;)    data := []*fieldNoPointer{{"one"},{"two"},{"three"}}    for _,v := range data {        go v.Print()    }    time.Sleep(time.Second)}func printDataWithNoPointerUseFieldNoPointerWithFunc()  {    fmt.Println(&quot;print by get printDataWithNoPointerUseFieldNoPointerWithFunc&quot;)    data := []fieldNoPointer{{"one"},{"two"},{"three"}}    for _,v := range data {        go func() {            v.Print()        }()    }    time.Sleep(time.Second)}func printDataWithNoPointerUseFieldNoPointerWithNoFunc()  {    fmt.Println(&quot;print by get printDataWithNoPointerUseFieldNoPointerWithNoFunc&quot;)    data := []fieldNoPointer{{"one"},{"two"},{"three"}}    for _,v := range data {        go v.Print()    }    time.Sleep(time.Second)}</code></pre><h2 id="å®éªŒç»“æœ"><a href="#å®éªŒç»“æœ" class="headerlink" title="å®éªŒç»“æœ"></a>å®éªŒç»“æœ</h2><pre><code>print by get printDataWithPointerUseFieldPointerWithFuncthreethreethreeprint by get printDataWithPointerUseFieldPointerWithNoFunconetwothreeprint by get printDataWithNoPointerUseFieldPointerWithFuncthreethreethreeprint by get printDataWithNoPointerUseFieldPointerWithNoFuncthreethreethreeprint by get printDataWithPointerUseFieldNoPointerWithFuncthreethreethreeprint by get printDataWithPointerUseFieldNoPointerWithNoFuncthreeonetwoprint by get printDataWithNoPointerUseFieldNoPointerWithFuncthreethreethreeprint by get printDataWithNoPointerUseFieldNoPointerWithNoFuncthreeonetwo</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¥ æˆ‘ä»¥ <code>structçš„funcæ˜¯å¦æŒ‡é’ˆç±»å‹</code> <code>strucçš„æ•°æ®æ˜¯å¦æ˜¯æŒ‡é’ˆç±»å‹</code> ä»¥åŠ <code>goroutine æ˜¯å¦ä½¿ç”¨åŒ¿åå‡½æ•°</code> ä¸ºä¾‹ä½œä¸ºæµ‹è¯•çš„ï¼Œä¸Šé¢çš„æµ‹è¯•ä¾‹å­éƒ½æ˜¯æ— æ„ä¸­å‘ç°çš„</p><p>å›¾è¡¨</p><table><thead><tr><th></th><th>Goroutine func ä¸” structæ•°æ®æ˜¯æŒ‡é’ˆç±»å‹</th><th>Goroutineä¸” structæ•°æ®æ˜¯æŒ‡é’ˆç±»å‹</th><th>Goroutine func ä¸” structæ•°æ®ä¸æ˜¯æŒ‡é’ˆç±»å‹</th><th>Goroutineä¸” structæ•°æ®ä¸æ˜¯æŒ‡é’ˆç±»å‹</th></tr></thead><tbody><tr><td>Struct funcæŒ‡é’ˆç±»å‹</td><td>å¼‚å¸¸</td><td>æ­£å¸¸</td><td>å¼‚å¸¸</td><td>å¼‚å¸¸</td></tr><tr><td>Struct funcéæŒ‡é’ˆç±»å‹</td><td>å¼‚å¸¸</td><td>å¼‚å¸¸</td><td>å¼‚å¸¸</td><td>æ­£å¸¸</td></tr></tbody></table><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>åœ¨goroutineé‡Œé¢ä½¿ç”¨å˜é‡çš„æ—¶å€™ï¼Œéœ€è¦ä¼ é€’ï¼Œä¸Šé¢æ¡ˆä¾‹ä¸­ä¸ä¼ é€’å˜é‡ç›´æ¥ä½¿ç”¨çš„æ–¹æ³•éƒ½æ˜¯é”™è¯¯çš„</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤´æ¡é¢ç»-PHP/Golang</title>
      <link href="/posts/55859/"/>
      <url>/posts/55859/</url>
      
        <content type="html"><![CDATA[<p>å¥½åƒè¿™é‡Œå¿…é¡»è¦å†™ç‚¹ä»€ä¹ˆï¼Œä»¥ä¸‹æ˜¯ä»Šæ—¥å¤´æ¡æ­å·ç ”å‘å²—ä½ï¼ˆPHP/Golangï¼‰çš„é¢è¯•è®°å½•</p><a id="more"></a><h1 id="ä¸€é¢ï¼ˆçº¦1hï¼‰"><a href="#ä¸€é¢ï¼ˆçº¦1hï¼‰" class="headerlink" title="ä¸€é¢ï¼ˆçº¦1hï¼‰"></a>ä¸€é¢ï¼ˆçº¦1hï¼‰</h1><ol><li>åœ¨é¢å¯¹æœªçŸ¥çš„æµé‡æš´å¢ï¼Œå¯ä»¥é¢„å…ˆæ€ä¹ˆå¤„ç†</li><li>å¦‚ä½•é™æµï¼Œé™æµç®—æ³•ï¼Œå¯¹äºddosæ”»å‡»æ€ä¹ˆå¤„ç†</li><li>PHPæ•°ç»„çš„åº•å±‚å®ç°</li><li>åˆ†å¸ƒå¼äº‹åŠ¡</li><li>RPCç›¸å¯¹äºä¼ ç»Ÿçš„APIè°ƒç”¨çš„ä¼˜ç‚¹</li><li>æœåŠ¡è°ƒåº¦ä¸­å¿ƒçš„æ„ŸçŸ¥ä¸åŠ¨æ€ä¸Šä¸‹çº¿</li><li>MySQLçš„ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆæ˜¯B+è€Œä¸æ˜¯å¹³è¡¡äºŒå‰æ ‘</li><li>ç´¢å¼•æŸ¥æ‰¾åœ¨Linuxçš„ç£ç›˜ä¸Šæ˜¯æ€ä¹ˆæ“ä½œçš„</li><li>èšç°‡ç´¢å¼•ç›¸å¯¹äºB+ç´¢å¼•çš„ä¼˜ç‚¹</li><li>å¦‚ä½•åˆ†æSQLæ‰§è¡Œæ…¢çš„åŸå› </li><li>Redisè¿æ¥æ—¶çš„connectä¸pconnectçš„åŒºåˆ«</li><li>Redisæœ‰å“ªäº›ç»“æ„æ—¶é—´å¤æ‚åº¦è¾ƒé«˜</li><li>Redis hashçš„å®ç°</li><li>ç®—æ³•é¢˜ï¼š åœ¨1ä¸ª10Gå¤§å°çš„æ–‡ä»¶ä¸­ï¼Œå­˜å‚¨çš„éƒ½æ˜¯intå‹çš„æ•°æ®ï¼Œå¦‚ä½•åœ¨å†…å­˜ä½¿ç”¨å°äº8Mçš„æƒ…å†µä¸‹è¿›è¡Œæ’åº</li><li>è®¾è®¡é¢˜ï¼š ä»¥å¾®åšä¸ºä¾‹ï¼Œæœ‰1ä¸ªäº¿çš„ç”¨æˆ·ï¼ŒåŒæ—¶ç”¨æˆ·ä¹‹é—´æœ‰å…³æ³¨å’Œç²‰ä¸ï¼Œç”¨æˆ·çš„å…³æ³¨å’Œå–å…³æ“ä½œæ¯”è¾ƒé¢‘ç¹ï¼Œå¦‚ä½•è®¾è®¡æ¶æ„å’ŒAPIæ¥å£</li></ol><h1 id="äºŒé¢ï¼ˆçº¦1-5hï¼‰"><a href="#äºŒé¢ï¼ˆçº¦1-5hï¼‰" class="headerlink" title="äºŒé¢ï¼ˆçº¦1.5hï¼‰"></a>äºŒé¢ï¼ˆçº¦1.5hï¼‰</h1><p>äºŒé¢ä¸»è¦ä»¥è‡ªå·±çš„é¡¹ç›®ä¸ºåˆ‡å…¥ç‚¹ï¼Œè¿›ä¸€æ­¥è€ƒå¯Ÿä½ å¯¹é¡¹ç›®ä¸­çŸ¥è¯†ç‚¹çš„æŠŠæ¡ç¨‹åº¦ï¼Œæˆ‘è¿™é‡Œæ˜¯ä»¥ä¸€ä¸ª è‡ªå·±æ’¸çš„å°é¡¹ç›® <a href="https://github.com/tyloafer/ProcessManager" target="_blank" rel="noopener">è¿›ç¨‹ç®¡ç†å·¥å…·</a> ä¸ºé¡¹ç›®èƒŒæ™¯</p><ol><li>å®ˆæŠ¤è¿›ç¨‹æ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆå®ç°</li><li>PHPæ˜¯å¦é€‚åˆåšå®ˆæŠ¤è¿›ç¨‹ï¼Œä¸ºä»€ä¹ˆï¼ˆå†…å­˜ç®¡ç†è¿™ä¸€å—ï¼‰</li><li>PHPçš„åƒåœ¾å›æ”¶æœºåˆ¶</li><li>è¿›ç¨‹é—´é€šä¿¡æ–¹å¼</li><li>å…±äº«å†…å­˜æ˜¯æ€ä¹ˆå®ç°çš„</li><li>æ€ä¹ˆæŸ¥çœ‹LinuxæœåŠ¡å™¨çš„è´Ÿè½½ï¼ŒåŠåˆ¤æ–­å“ªäº›æ“ä½œå¼•èµ·çš„è´Ÿè½½è¿‡é«˜</li><li>MySQLçš„IOè¿‡é«˜æ€ä¹ˆä¼˜åŒ–ï¼Œåˆ†åº“åˆ†è¡¨åŠåˆ†åŒº</li><li>MySQLçš„ç´¢å¼•ç»“æ„ï¼Œmyisamçš„ç´¢å¼•ç»“æ„ï¼Œ innodbçš„ç´¢å¼•ç»“æ„ï¼Œinnodbä¸ºä»€ä¹ˆå¿…é¡»è¦æœ‰ä¸»é”®ç´¢å¼•</li><li>æ·»åŠ ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆå¯ä»¥å‡å°‘ioæ“ä½œï¼ˆç£ç›˜é¡µï¼‰</li><li>nginxçš„è´Ÿè½½å‡è¡¡ç®—æ³•</li><li>ç®—æ³•é¢˜ï¼š å¿˜äº†</li><li>ç®—æ³•é¢˜ï¼šæŸ¥æ‰¾ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­æœ€é•¿çš„æ— é‡å¤å­—ä¸²</li></ol><p>ä¸Šé¢æ˜¯æˆ‘åŸºæœ¬è¿˜è®°å¾—çš„ä¸€äº›é¢˜ç›®ï¼Œè€ƒå¯Ÿçš„åŠ›åº¦ç›¸å¯¹æ¯”è¾ƒæ·±ï¼Œæ‰€ä»¥ï¼Œè¯·é€‰æ‹©ä¸€ä¸ªè‡ªå·±æ¯”è¾ƒç†Ÿæ‚‰çš„é¡¹ç›®ï¼Œå› ä¸ºé¢è¯•å®˜æ˜¯ä¼šå‰–æåˆ°åº•å±‚çš„</p><h1 id="ä¸‰é¢ï¼ˆçº¦0-6hï¼‰"><a href="#ä¸‰é¢ï¼ˆçº¦0-6hï¼‰" class="headerlink" title="ä¸‰é¢ï¼ˆçº¦0.6hï¼‰"></a>ä¸‰é¢ï¼ˆçº¦0.6hï¼‰</h1><p>ä¸‰é¢ä¸äºŒé¢çš„å†…å®¹å·®ä¸å¤šï¼Œæ²¡æœ‰æ›´æ·±çš„é—®é¢˜ï¼Œä½†æ˜¯ï¼Œéœ€è¦æ³¨é‡ç»†èŠ‚ï¼ŒåŒæ—¶ä¸‰é¢é¢è¯•å®˜æœ‰æ—¶é—´ä¼šæ”¾çƒŸé›¾å¼¹ï¼Œåšå®šè‡ªå·±çš„ç«‹åœºå°±å¥½</p><ol><li>é¢è¯•é¢˜ï¼š åœ¨ä¸€ä¸ªæ¨ªå‘å’Œçºµå‘éƒ½æ˜¯é€’å¢çš„æœ‰ç•ŒäºŒç»´åæ ‡è½´ä¸­ï¼Œå¦‚ä½•å¿«é€Ÿåˆ¤æ–­æŸä¸ªæ•°æ˜¯å¦å­˜åœ¨äºè¿™ä¸ªäºŒç»´åæ ‡ä¸­</li></ol><h1 id="Hré¢ï¼ˆçº¦0-5hï¼‰"><a href="#Hré¢ï¼ˆçº¦0-5hï¼‰" class="headerlink" title="Hré¢ï¼ˆçº¦0.5hï¼‰"></a>Hré¢ï¼ˆçº¦0.5hï¼‰</h1><p>hrå°å§å§ï¼šä½ æœ‰ä»€ä¹ˆå¿ƒä»ªçš„å…¬å¸å—</p><p>æˆ‘ï¼š å¤§å‚ï¼Œç±»ä¼¼äºBATè¿™ç§</p><p>hrå°å§å§ï¼šä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>æˆ‘ï¼š æˆ‘æ„Ÿè§‰ é˜¿é‡Œçš„æ¶æ„ä¸é”™ï¼Œå¾®åšé¸Ÿå“¥å¾…è¿‡ï¼ŒæŠ€æœ¯æ¶æ„è‚¯å®šåŠåŠçš„ã€‚ã€‚ã€‚</p><p>hrå°å§å§ï¼šä½ è·Ÿæˆ‘åœ¨åŒ—äº¬é¢çš„å…¶ä»–å€™é€‰äººéƒ½ä¸å¤ªä¸€æ ·å•Šï¼Œä»–ä»¬éƒ½ä¸å±‘äºå»è¿™äº›å…¬å¸ï¼Œæ„Ÿè§‰æƒ³è¿›å°±è¿›ï¼Œä»–ä»¬æ¯”è¾ƒå€¾å‘äºæ»´æ»´ï¼Œå¤´æ¡è¿™äº›å¹´è½»ï¼Œå‘å±•æ¯”è¾ƒå¿«é€Ÿçš„å…¬å¸</p><p>æˆ‘ï¼šå’ã€‚ã€‚ã€‚ï¼ˆæ¯•ç«Ÿæˆ‘æ¯•ä¸šæ‰ä¸€å¹´åŠå•Š-_-ï¼Œæ ¡æ‹›è¿˜å› ä¸ºè‡ªå·±ä¸åœ¨æ„ï¼Œå®Œç¾é”™è¿‡äº†æ‰€æœ‰å¤§å‚çš„æ‹›è˜ï¼‰</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¤´æ¡é¢è¯•ï¼Œç®—æ³•æ˜¯å¿…è€ƒé¡¹ï¼Œä½†æ˜¯é¢è¯•å®˜éƒ½æ˜¯è®©æˆ‘ç»™å‡ºæ€è·¯ï¼Œä¹Ÿæ²¡å†™å¤šå°‘è¡Œä»£ç </p><p>æ¶‰çŒèŒƒå›´ä¸€èˆ¬ï¼ŒåŸºæœ¬å°±æ˜¯Redis MySQL ï¼ŒNginxæ¯”è¾ƒå°‘ï¼Œå¯èƒ½é…ç½®ç®€å•å§</p><p>æ·±åº¦è¾ƒæ·±ï¼Œå¾ˆå°‘äººä¼šå»å…³æ³¨PHPçš„åƒåœ¾å›æ”¶ï¼Œä½•ä¸ºåƒåœ¾ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œarrayçš„HashTableå®ç°è¿™äº›å†…å®¹, Redis Hashè¡¨ç­‰</p>]]></content>
      
      
      <categories>
          
          <category> é¢ç» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¢ç» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç»ˆç«¯ç§‘å­¦ä¸Šç½‘</title>
      <link href="/posts/31170/"/>
      <url>/posts/31170/</url>
      
        <content type="html"><![CDATA[<p>å¯¹äºç»å¸¸åœ¨æœåŠ¡å•†ä½¿ç”¨git å’Œ composer çš„æˆ‘æ¥è¯´ï¼Œå®åœ¨å—ä¸äº†é‚£å‡ kçš„ç½‘é€Ÿï¼Œä½†æ˜¯æ¯•ç«Ÿä½¿ç”¨è¾ƒå°‘ï¼Œè€Œä¸”ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›½å†…é•œåƒæºï¼Œä½†æ˜¯è¿‘æœŸè¦ä½¿ç”¨Google APIï¼Œè¿™ä¸ªå°±æœ‰ç‚¹å¤´ç–¼äº†ã€‚æ‰€ä»¥ï¼ŒåºŸè¯ä¸å¤šè¯ï¼Œç›´æ¥ä¸Šæ­¥éª¤ï¼Œæ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡ã€‚</p><a id="more"></a><h1 id="Proxychains4ç‰ˆæœ¬"><a href="#Proxychains4ç‰ˆæœ¬" class="headerlink" title="Proxychains4ç‰ˆæœ¬"></a>Proxychains4ç‰ˆæœ¬</h1><h2 id="å®‰è£…é…ç½®shadowsocks"><a href="#å®‰è£…é…ç½®shadowsocks" class="headerlink" title="å®‰è£…é…ç½®shadowsocks"></a>å®‰è£…é…ç½®shadowsocks</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>ç¼–è¾‘é…ç½®æ–‡ä»¶ <code>/etc/sslocal.json</code>ï¼Œé…ç½®æ–‡ä»¶å¯ä»¥æ”¾åœ¨ä»»æ„ä½ç½®ï¼Œå¯åŠ¨çš„æ—¶å€™ æŒ‡å®šå¯¹åº”ä½ç½®å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;xxx.xxx.xxx.xxx&quot;, // ss æœåŠ¡å™¨ip</span><br><span class="line">    &quot;server_port&quot;:xxx,  // ss ç«¯å£</span><br><span class="line">    &quot;local_address&quot;: &quot;127.0.0.1&quot;, // æœ¬æœºä»£ç†</span><br><span class="line">    &quot;local_port&quot;:1080, // æœ¬æœºä»£ç†ç«¯å£</span><br><span class="line">    &quot;password&quot;:&quot;*******&quot;, // ss å¯†ç </span><br><span class="line">    &quot;timeout&quot;:300,</span><br><span class="line">    &quot;method&quot;:&quot;rc4-md5&quot; // ss åŠ å¯†æ–¹å¼</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ—¶è¯·æŠŠåé¢çš„æ³¨é‡Šå»æ‰</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¯åŠ¨ï¼šsslocal -c /etc/sslocal.json -d start</span><br><span class="line"></span><br><span class="line">åœæ­¢ï¼šsslocal -c /etc/sslocal.json -d stop</span><br><span class="line"></span><br><span class="line">é‡å¯ï¼šsslocal -c /etc/sslocal.json -d restart</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…é…ç½®-Proxychains4"><a href="#å®‰è£…é…ç½®-Proxychains4" class="headerlink" title="å®‰è£…é…ç½® Proxychains4"></a>å®‰è£…é…ç½® Proxychains4</h2><p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/rofl0r/proxychains-ng" target="_blank" rel="noopener">https://github.com/rofl0r/proxychains-ng</a></p><p>ç¼–è¯‘å®‰è£…å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/rofl0r/proxychains-ng.git</span><br><span class="line">cd proxychains-ng</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cp ./src/proxychains.conf /etc/proxychains.conf</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>/etc/proxychains.conf</code> å°† <strong>socks4 127.0.0.1 9095</strong> æ”¹æˆ <strong>socks5 127.0.0.1 1080</strong> </p><p>è¿™é‡Œ<strong>127.0.0.1</strong> ä¸ shadowsocké…ç½®æ–‡ä»¶ä¸­ <strong>local_address</strong> å¯¹åº” <strong>1080</strong> ä¸ <strong>local_port</strong> å¯¹åº”å³å¯</p><p>è‡³æ­¤ï¼Œå®‰è£…å®Œæˆï¼Œåªè¦åœ¨ä½¿ç”¨çš„å‘½ä»¤å‰ åŠ ä¸Š <code>proxychains4</code> å³å¯å®ç°ç§‘å­¦ä¸Šç½‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 wget https://www.google.com</span><br></pre></td></tr></table></figure><h1 id="HTTP-PROXY-æ¨è"><a href="#HTTP-PROXY-æ¨è" class="headerlink" title="HTTP_PROXY(æ¨è)"></a>HTTP_PROXY(æ¨è)</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http:</span><br><span class="line">export http_proxy=http://proxyAddress:port</span><br><span class="line">export http_proxy=socks5://127.0.0.1:1087</span><br><span class="line"></span><br><span class="line">https:</span><br><span class="line">export https_proxy=https://proxyAddress:port</span><br><span class="line">export https_proxy=socks5://127.0.0.1:1087</span><br><span class="line"></span><br><span class="line">http &amp;&amp; https</span><br><span class="line">export all_proxy=http://proxyAddress:port</span><br><span class="line">export all_proxy=socks5://127.0.0.1:1087</span><br></pre></td></tr></table></figure><p>å¦‚æœhttpä»£ç†éœ€è¦éªŒè¯çš„è¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_proxy=http://userName:password@proxyAddress:port</span><br></pre></td></tr></table></figure><p>å…¶ä»–ä»£ç†æ–¹å¼ç›¸åŒ</p>]]></content>
      
      
      <categories>
          
          <category> ShadowSock </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç§‘å­¦ä¸Šç½‘ </tag>
            
            <tag> ShadowSock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SeLinuxå¼•å‘çš„é—®é¢˜å°è®°</title>
      <link href="/posts/15998/"/>
      <url>/posts/15998/</url>
      
        <content type="html"><![CDATA[<p>ä»¥å‰è‡ªå·±åœ¨éƒ¨ç½²æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¿˜äº†é‡åˆ°äº†ä»€ä¹ˆå‘ï¼Œå¯¼è‡´åæ¥ä¹ æƒ¯æ€§æŠŠæ–°æœåŠ¡å™¨ä¸Šçš„ <strong>SeLinux</strong> æœåŠ¡ç›´æ¥å…³é—­ï¼Œä»Šå¤©å¤„ç†äº†ä¸€å°ä¸æ˜¯æˆ‘éƒ¨ç½²çš„æœåŠ¡å™¨ï¼Œåˆè¸©äº†ä¸¤ä¸ªå‘ï¼Œè¿™é‡Œåšä¸€ä¸‹è®°å½•ï¼Œåé¢æœ‰æ—¶é—´è¿˜æ˜¯è¦å¥½å¥½äº†è§£ä¸€ä¸‹è¿™å—ã€‚</p><h1 id="FastCGI-sent-in-stderr-â€œPrimary-script-unknownâ€-while-reading-response-header-from-upstream"><a href="#FastCGI-sent-in-stderr-â€œPrimary-script-unknownâ€-while-reading-response-header-from-upstream" class="headerlink" title="FastCGI sent in stderr: â€œPrimary script unknownâ€ while reading response header from upstream"></a>FastCGI sent in stderr: â€œPrimary script unknownâ€ while reading response header from upstream</h1><blockquote><p> è¿™ä¸ªé—®é¢˜ä¸€èˆ¬æ˜¯ <strong>SCRIPT_FILENAME</strong>   è¿™ä¸ªå˜é‡æ²¡æœ‰è®¾ç½®å¥½ï¼Œä½†æ˜¯æ‰“å°å‡ºæ¥å…¶å®æ˜¯æ­£ç¡®çš„ï¼Œä¹Ÿå°±æ˜¯è¯æ˜nginxçš„é…ç½®æ—¶æ²¡æœ‰é—®é¢˜çš„ï¼Œå¯ä»¥è€ƒè™‘æ˜¯ <strong>SeLinux</strong> çš„åŸå› </p></blockquote><p>å¤„ç†ï¼š chcon -R -t httpd_sys_content_t /path/to/webroot</p><h1 id="chmod-777-åä¾æ—§-failed-to-open-stream-Permission-denied"><a href="#chmod-777-åä¾æ—§-failed-to-open-stream-Permission-denied" class="headerlink" title="chmod 777 åä¾æ—§ failed to open stream: Permission denied"></a>chmod 777 åä¾æ—§ failed to open stream: Permission denied</h1><p>å¤„ç†ï¼š </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce Permissive</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£PHPç³»åˆ—ä¹‹çº¿ç¨‹å®‰å…¨</title>
      <link href="/posts/56229/"/>
      <url>/posts/56229/</url>
      
        <content type="html"><![CDATA[<p>è¿›ç¨‹: è¿›ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å †å’Œæ ˆï¼Œæ—¢ä¸å…±äº«å †ï¼Œäº¦ä¸å…±äº«æ ˆï¼Œè¿›ç¨‹ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦ã€‚</p><p>çº¿ç¨‹: çº¿ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆå’Œå…±äº«çš„å †ï¼Œå…±äº«å †ï¼Œä¸å…±äº«æ ˆï¼Œçº¿ç¨‹äº¦ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦(æ ‡å‡†çº¿ç¨‹æ˜¯çš„)ã€‚</p><p>æ ¹æ®å‰é¢ä¸‰ç¯‡æ–‡ç« ã€Š<a href="https://tyloafer.github.io/posts/30726/">æµ…æå †æ ˆå’Œå†…å­˜æº¢å‡º</a>ã€‹ ã€Š<a href="https://tyloafer.github.io/posts/17570/">æ·±å…¥PHPç³»åˆ—ä¹‹PHPæ•°ç»„åº•å±‚çš„å®ç°</a>ã€‹ã€Š<a href="https://tyloafer.github.io/posts/47934/">æ·±å…¥PHPç³»åˆ—-å˜é‡åˆ†ç¦»ä¸å¼•ç”¨</a>ã€‹å¯ä»¥å¾—çŸ¥ï¼ŒPHPçš„å˜é‡æ˜¯ç”±zvalç»“æ„ä½“æ„æˆçš„ï¼Œæ•°ç»„åˆ™æ˜¯hashè¡¨å’Œé“¾è¡¨æ„æˆçš„ï¼Œè¿™äº›ï¼Œéƒ½æ˜¯ç¨‹åºå‘˜è¿›è¡Œåˆ†é…é”€æ¯çš„å†…å­˜ï¼Œä¹Ÿå³å †å†…å­˜ã€‚ç”±æ­¤å¯å¾—ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼ŒPHPå…¶å®æ˜¯å…±äº«å˜é‡çš„ï¼Œå¦‚æœçº¿ç¨‹1ä¿®æ”¹äº†å˜é‡aï¼Œ åˆ™çº¿ç¨‹2ä½¿ç”¨å˜é‡açš„æ—¶å€™ï¼Œå°±æ˜¯çº¿ç¨‹1ä¿®æ”¹åçš„ç»“æœï¼Œæ‰€è°“çº¿ç¨‹å®‰å…¨ä¹Ÿå°±æ˜¯ï¼Œå¦‚ä½•ä¿éšœï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å®‰å…¨çš„ä½¿ç”¨å…¬å…±çš„èµ„æºï¼Œä¸å—å½±å“ä¸”ä¸å½±å“å…¶ä»–çº¿ç¨‹ã€‚å› æ­¤ï¼ŒPHPå®ç°äº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨èµ„æºç®¡ç†å™¨ï¼ˆThread Safe Resource Manager, TSRMï¼‰ï¼Œç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ç°çº¿ç¨‹ä¹‹é—´å®‰å…¨çš„æ“ä½œå…¬å…±èµ„æºã€‚</p><a id="more"></a><h1 id="æ ¸å¿ƒæ€æƒ³"><a href="#æ ¸å¿ƒæ€æƒ³" class="headerlink" title="æ ¸å¿ƒæ€æƒ³"></a>æ ¸å¿ƒæ€æƒ³</h1><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/thread_1.png" alt="thread_1"></p><p>å¦‚å›¾ï¼Œå¦‚æœä¸‰ä¸ªçº¿ç¨‹çš„å†…å­˜åœ°å€ä¸åŒï¼Œé‚£ä¹ˆåœ¨ Thread1 é‡Œé¢æ“ä½œçš„æ˜¯Thread1å¯¹åº”çš„å†…å­˜åœ°å€ï¼Œå°±ä¸ä¼šå½±å“ Thread2 å’Œ Thread3 å¯¹åº”çš„å†…å­˜åœ°å€çš„å€¼ã€‚</p><p>TSRMçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ä¸ºä¸åŒçš„çº¿ç¨‹åˆ†é…ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœä¸€ä¸ªèµ„æºä¼šè¢«å¤šçº¿ç¨‹ä½¿ç”¨ï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦é¢„å…ˆå‘TSRMæ³¨å†Œèµ„æºï¼Œç„¶åTSRMä¸ºè¿™ä¸ªèµ„æºåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œå¹¶æŠŠè¿™ç§èµ„æºçš„å¤§å°ã€åˆå§‹åŒ–å‡½æ•°ç­‰ä¿å­˜åˆ°ä¸€ä¸ª<code>tsrm_resource_type</code>ç»“æ„ä¸­ï¼Œå„çº¿ç¨‹åªèƒ½é€šè¿‡TSRMåˆ†é…çš„é‚£ä¸ªç¼–å·è®¿é—®è¿™ä¸ªèµ„æºï¼›ç„¶åå½“çº¿ç¨‹æ‹¿ç€è¿™ä¸ªç¼–å·è·å–èµ„æºæ—¶TSRMå¦‚æœå‘ç°æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ™ä¼šæ ¹æ®æ³¨å†Œæ—¶çš„èµ„æºå¤§å°åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶åè°ƒç”¨åˆå§‹åŒ–å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶æŠŠè¿™å—èµ„æºä¿å­˜ä¸‹æ¥ä¾›è¿™ä¸ªçº¿ç¨‹åç»­ä½¿ç”¨ã€‚</p><h1 id="åŸºæœ¬å®ç°"><a href="#åŸºæœ¬å®ç°" class="headerlink" title="åŸºæœ¬å®ç°"></a>åŸºæœ¬å®ç°</h1><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/thread_safe.png" alt="çº¿ç¨‹å®‰å…¨ç»“æ„"></p><p>TSRMçš„æ•´ä½“ç»“æ„ä¸»è¦å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç°ä»å·¦å‘å³å¼€å§‹æ¢³ç†</p><h2 id="tsrm-tls-table"><a href="#tsrm-tls-table" class="headerlink" title="tsrm_tls_table"></a>tsrm_tls_table</h2><p>å·¦ä¾§ç¬¬ä¸€ä¸ªç»“æ„æ˜¯ <code>tsrm_tls_table</code>, tsrm_tls_table æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„æ¯ä¸ªç´¢å¼•å¯¹åº”çš„å€¼æ˜¯ä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¸ºçº¿ç¨‹ç”³è¯·å†…å­˜åœ°å€ã€‚é‚£ä¹ˆå¦‚ä½•ç¡®å®šçº¿ç¨‹åœ¨ tsrm_tls_table  çš„å“ªä¸ªç´¢å¼•ä¸‹é¢å‘¢ï¼Œåœ¨PHPçš„æ•°ç»„çš„å®ç°ä¸­ï¼Œé€šè¿‡hashæ•£åˆ—å–æ¨¡æ¥ç¡®å®šç´¢å¼•ï¼Œè¿™é‡Œä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªæ˜¯ç®€åŒ–äº†ï¼Œç›´æ¥é€šè¿‡çº¿ç¨‹id % tsrm_tls_table_size æ¥ç¡®å®šç´¢å¼•ã€‚</p><p>æˆ‘ä»¬ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œ tsrm_tls_table_size ä¸º 2ï¼Œ å¦‚æœæ–°çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œ çº¿ç¨‹idï¼ˆåé¢ç”¨ thread_idæ¥æ›¿ä»£ï¼‰ï¼Œ 3 % 2 = 1ï¼Œ æ‰€ä»¥ æˆ‘ä»¬åœ¨ tsrm_tls_table[1] ä¸‹é¢å»å¯»æ‰¾è¿™ä¸ªçº¿ç¨‹å†…å­˜åœ°å€ã€‚è¿›è€Œï¼Œè¿™é‡Œå°±ä¼šå¼•å‘ä¸€ä¸ªé—®é¢˜ï¼Œ 5 % 2 = 1ï¼Œé‚£æ˜¯ä¸æ˜¯å°±å†²çªäº†?</p><h2 id="tsrm-tls-entry"><a href="#tsrm-tls-entry" class="headerlink" title="tsrm_tls_entry"></a>tsrm_tls_entry</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct _tsrm_tls_entry &#123;</span><br><span class="line">    void **storage; //èµ„æºæ•°ç»„</span><br><span class="line">    int count; //æ‹¥æœ‰çš„èµ„æºæ•°:storageæ•°ç»„å¤§å°</span><br><span class="line">    THREAD_T thread_id; //æ‰€å±çº¿ç¨‹id</span><br><span class="line">    tsrm_tls_entry *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ä¸Šé¢çš„æƒ…å†µæ¥è€ƒè™‘ï¼Œè‚¯å®šä¼šå­˜åœ¨å†²çªçš„æƒ…å†µï¼Œé™¤éè¿™ä¸ªæ•°ç»„ç‰¹åˆ«å¤§ï¼Œä½†æ˜¯é‚£æ ·å†…å­˜è€—è´¹å°±å¾—ä¸å¿å¤±äº†ã€‚</p><p>æ‰€ä»¥ï¼Œ<code>tsrm_tls_entry</code> çš„ç»“æ„ä½“ æœ‰ä¸€ä¸ªè¿™æ ·çš„ å±æ€§ <code>tsrm_tls_entry *next;</code>ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠå„ä¸ªå†²çªçš„ <code>tsrm_tls_entry</code> ä¸²æˆé“¾è¡¨æ¥è§£å†³å†²çªäº†ï¼Œè¿™ä¹Ÿæ˜¯hashå†²çªæ—¶ï¼Œå¸¸ç”¨çš„è§£å†³æ–¹æ³•ã€‚</p><h3 id="tsrm-resource-type"><a href="#tsrm-resource-type" class="headerlink" title="tsrm_resource_type"></a>tsrm_resource_type</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    size_t size; //èµ„æºçš„å¤§å°</span><br><span class="line">    ts_allocate_ctor ctor; //åˆå§‹åŒ–å‡½æ•°</span><br><span class="line">    ts_allocate_dtor dtor;</span><br><span class="line">    int done;</span><br><span class="line">&#125; tsrm_resource_type;</span><br></pre></td></tr></table></figure><p><code>tsrm_resource_type</code> è¿™ä¸ªç»“æ„ä½“å¥½åƒåœ¨ä¸Šå›¾ä¸­å¹¶æ²¡æœ‰ä½“ç°å‡ºæ¥å…·ä½“æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæ¥ä¸‹æ¥ï¼Œå…ˆçœ‹ä¸€ä¸‹ï¼ŒTSRMçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåº”è¯¥å°±èƒ½çŸ¥é“è¿™ä¸ªç»“æ„ä½“çš„ä½œç”¨äº†</p><p><strong>åˆå§‹åŒ–</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TSRM_API int tsrm_startup(int expected_threads, int expected_resources, int debug_level, char *debug_filename)</span><br><span class="line">&#123;</span><br><span class="line">    pthread_key_create( &amp;tls_key, 0 );</span><br><span class="line"></span><br><span class="line">    //åˆ†é…tsrm_tls_table</span><br><span class="line">    tsrm_tls_table_size = expected_threads;</span><br><span class="line">    tsrm_tls_table = (tsrm_tls_entry **) calloc(tsrm_tls_table_size, sizeof(tsrm_tls_entry *));</span><br><span class="line">    ...</span><br><span class="line">    //åˆå§‹åŒ–èµ„æºçš„é€’å¢idï¼Œæ³¨å†Œèµ„æºæ—¶å°±æ˜¯ç”¨çš„è¿™ä¸ªå€¼</span><br><span class="line">    id_count=0;</span><br><span class="line"></span><br><span class="line">    //åˆ†é…èµ„æºç±»å‹æ•°ç»„ï¼šresource_types_table</span><br><span class="line">    resource_types_table_size = expected_resources;</span><br><span class="line">    resource_types_table = (tsrm_resource_type *) calloc(resource_types_table_size, sizeof(tsrm_resource_type));</span><br><span class="line">    ...</span><br><span class="line">    //åˆ›å»ºé”</span><br><span class="line">    tsmm_mutex = tsrm_mutex_alloc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨å†Œèµ„æº</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#ifdef ZTS</span><br><span class="line">ZEND_API int executor_globals_id;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">int zend_startup(zend_utility_functions *utility_functions, char **extensions)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">#ifdef ZTS</span><br><span class="line">    ts_allocate_id(&amp;executor_globals_id, sizeof(zend_executor_globals), (ts_allocate_ctor) executor_globals_ctor, (ts_allocate_dtor) executor_globals_dtor);</span><br><span class="line">    </span><br><span class="line">    executor_globals = ts_resource(executor_globals_id);</span><br><span class="line">    ...</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">TSRM_API ts_rsrc_id ts_allocate_id(ts_rsrc_id *rsrc_id, size_t size, ts_allocate_ctor ctor, ts_allocate_dtor dtor)</span><br><span class="line">&#123;</span><br><span class="line">    //åŠ é”ï¼Œä¿è¯å„çº¿ç¨‹ä¸²è¡Œè°ƒç”¨æ­¤å‡½æ•°</span><br><span class="line">    tsrm_mutex_lock(tsmm_mutex);</span><br><span class="line"></span><br><span class="line">    //åˆ†é…idï¼Œå³id_countå½“å‰å€¼ï¼Œç„¶åæŠŠid_countåŠ 1</span><br><span class="line">    *rsrc_id = TSRM_SHUFFLE_RSRC_ID(id_count++);</span><br><span class="line"></span><br><span class="line">    //æ£€æŸ¥resource_types_tableæ•°ç»„å½“å‰å¤§å°æ˜¯å¦å·²æ»¡</span><br><span class="line">    if (resource_types_table_size &lt; id_count) &#123;</span><br><span class="line">        //éœ€è¦å¯¹resource_types_tableæ‰©å®¹</span><br><span class="line">        resource_types_table = (tsrm_resource_type *) realloc(resource_types_table, sizeof(tsrm_resource_type)*id_count);</span><br><span class="line">        ...</span><br><span class="line">        //æŠŠæ•°ç»„å¤§å°ä¿®æ”¹æ–°çš„å¤§å°</span><br><span class="line">        resource_types_table_size = id_count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //å°†æ–°æ³¨å†Œçš„èµ„æºæ’å…¥resource_types_tableæ•°ç»„ï¼Œä¸‹æ ‡å°±æ˜¯åˆ†é…çš„èµ„æºid</span><br><span class="line">    resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(*rsrc_id)].size = size;</span><br><span class="line">    resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(*rsrc_id)].ctor = ctor;</span><br><span class="line">    resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(*rsrc_id)].dtor = dtor;</span><br><span class="line">    resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(*rsrc_id)].done = 0;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢çš„åˆå§‹åŒ–å’Œæ³¨å†Œèµ„æºæµç¨‹å¯ä»¥çœ‹å‡ºï¼Œ <code>tsrm_tls_entry</code>  ç»“æ„æ˜¯ <code>resource_types_table</code> çš„åŸºæœ¬ç»„æˆå•ä½ï¼Œ<code>resource_types_table</code> å°±æ˜¯çº¿ç¨‹çš„èµ„æºèšé›†åœ°ï¼Œ åœ¨æ³¨å†Œèµ„æºçš„æ—¶å€™ï¼Œtsrmä¼šç»™èµ„æºåˆ†é…ä¸€ä¸ªidï¼Œç„¶åçº¿ç¨‹å†å»ä½¿ç”¨è¿™ä¸ªèµ„æºçš„æ—¶å€™ï¼Œé¦–å…ˆæ ¹æ®tread_idæ‰¾åˆ° åˆ†é…çš„çº¿ç¨‹å†…å­˜åœ°å€ï¼Œç„¶åå†æ ¹æ® èµ„æºidï¼Œæ‰¾åˆ°èµ„æºåœ¨çº¿ç¨‹å†…å­˜åœ°å€é‡Œé¢çš„åœ°å€</p><h1 id="æµç¨‹ä¼˜åŒ–"><a href="#æµç¨‹ä¼˜åŒ–" class="headerlink" title="æµç¨‹ä¼˜åŒ–"></a>æµç¨‹ä¼˜åŒ–</h1><p>æ¢³ç†ä¸€ä¸‹ï¼Œçº¿ç¨‹é‡Œé¢æŸ¥æ‰¾ä¸€ä¸ªèµ„æºå¯ä»¥åˆ†ä¸ºä¸‰æ­¥</p><ol><li>è·å–å½“å‰çº¿ç¨‹çš„thread_id</li><li>æ ¹æ®thread_idè·å–tsrm_tls_entryï¼Œè¿™ä¸ªè¿‡ç¨‹éœ€è¦å¯¹tsrm_tls_tableåŠ é”ï¼Œéå†é“¾è¡¨</li><li>æ ¹æ®èµ„æºidï¼Œè·å–tsrm_tls_entryé‡Œé¢çš„å¯¹åº”çš„èµ„æº</li></ol><p>çº¿ç¨‹å¯¹èµ„æºçš„æ“ä½œæ˜¯é¢‘ç¹çš„ï¼Œæ¯æ¬¡éƒ½è¦è¿›è¡Œä¸Šé¢ä¸‰æ­¥æ“ä½œæ˜¯å¾ˆè´¹æ—¶çš„ï¼Œè€Œä¸”ç¬¬äºŒæ­¥è¿˜éœ€è¦åŠ é”ï¼Œè¿™ä¸ªå°†ä¸¥é‡çš„å½±å“æ€§èƒ½ã€‚</p><p>TSRMé€šè¿‡çº¿ç¨‹ç§æœ‰æ•°æ®ï¼ˆThread-Specific Data, TSDï¼‰ä¼˜åŒ–äº†è¿™ä¸ªé—®é¢˜ï¼ŒTSDæ˜¯ç”±POSIXæ•°æ®åº“ç»´æŠ¤çš„ï¼Œä½¿ç”¨åŒä¸€åç§°ä¸ºä¸åŒçº¿ç¨‹ä¿å­˜æ•°æ®çš„ä¸€ç§å­˜å‚¨å½¢å¼ï¼Œå³å„çº¿ç¨‹æ ¹æ®åŒåçš„keyå¯ä»¥è·å–åˆ°ä¸åŒçš„å˜é‡åœ°å€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// åˆ›å»ºåä¸ºkeyçš„TSD</span><br><span class="line">int pthread_key_create(pthread_key_t* keyp, void (*destructor)(void*) );</span><br><span class="line">// é”€æ¯åä¸ºkeyçš„TSD</span><br><span class="line">int pthread_key_delete(pthread_key_t* key);</span><br><span class="line">// æ ¹æ®keyè®¾ç½®TSD</span><br><span class="line">int pthread_setspecific(pthread_key_t key, const void* value);</span><br><span class="line">// æ ¹æ®keyè·å–</span><br><span class="line">int pthread_setspecific(pthread_key_t key, const void* value);</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ï¼Œä¾¿å¯ä»¥å°†ä¸Šé¢ä¸‰æ­¥ä¼˜åŒ–ä¸ºä¸‹é¢ä¸¤æ­¥</p><ol><li>æ ¹æ®èµ„æºidè·å–èµ„æºçš„åœ°å€</li><li>æ ¹æ®èµ„æºåœ°å€ï¼Œè·å–èµ„æºå†…å®¹</li></ol>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµ…æå †æ ˆå’Œå†…å­˜æº¢å‡º</title>
      <link href="/posts/30726/"/>
      <url>/posts/30726/</url>
      
        <content type="html"><![CDATA[<p>å¯¹äºä¸€ä¸ªPHPeræ¥è¯´ï¼ŒPHPå·²ç»å¸®æˆ‘ä»¬å¤„ç†å¥½äº†GCï¼Œçº¿ç¨‹å®‰å…¨ç­‰å†…å­˜ç›¸å…³çš„æ“ä½œï¼Œå®Œå…¨ä¸éœ€è¦æˆ‘ä»¬å»è€ƒè™‘ï¼Œè®©æˆ‘ä»¬æ›´åŠ æ³¨é‡äºä»£ç çš„å®ç°ã€‚å†åŠ ä¸Šå¤§å­¦åŸæœ¬å°±æ˜¯æ··çš„å—¨çš®ï¼Œå­¦çš„å¿ƒå¡ï¼Œä¹Ÿå¯¹è¿™äº›æ¦‚å¿µæ²¡ä»€ä¹ˆäº†è§£ï¼Œä½†æ˜¯è¿‘æœŸåœ¨çœ‹PHPçš„æºç çš„æ—¶å€™ï¼Œæ„Ÿæ…¨è¿˜æ˜¯é€ƒä¸æ‰è¿™äº›æ¦‚å¿µã€‚</p><a id="more"></a><h1 id="å†…å­˜åˆ†å¸ƒ"><a href="#å†…å­˜åˆ†å¸ƒ" class="headerlink" title="å†…å­˜åˆ†å¸ƒ"></a>å†…å­˜åˆ†å¸ƒ</h1><p>ä¸€ä¸ªCè¯­è¨€çš„å†…å­˜å¸ƒå±€ï¼š</p><ol><li>æ ˆåŒºï¼ˆstackï¼‰: ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…é‡Šæ”¾ ï¼Œå­˜æ”¾å‡½æ•°çš„å‚æ•°å€¼ï¼Œå±€éƒ¨å˜é‡çš„å€¼ç­‰ã€‚å…¶æ“ä½œæ–¹å¼ç±»ä¼¼äºæ•°æ®ç»“æ„ä¸­çš„æ ˆã€‚</li><li>å †åŒºï¼ˆheapï¼‰ : ä¸€èˆ¬ç”±ç¨‹åºå‘˜åˆ†é…é‡Šæ”¾ï¼Œ è‹¥ç¨‹åºå‘˜ä¸é‡Šæ”¾ï¼Œç¨‹åºç»“æŸæ—¶å¯èƒ½ç”±OSå›æ”¶ ã€‚æ³¨æ„å®ƒä¸æ•°æ®ç»“æ„ä¸­çš„å †æ˜¯ä¸¤å›äº‹ï¼Œåˆ†é…æ–¹å¼å€’æ˜¯ç±»ä¼¼äºé“¾è¡¨ã€‚</li><li>å…¨å±€åŒºï¼ˆé™æ€åŒºï¼‰ï¼ˆstaticï¼‰: å…¨å±€å˜é‡å’Œé™æ€å˜é‡çš„å­˜å‚¨æ˜¯æ”¾åœ¨ä¸€å—çš„ï¼Œåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡åœ¨ä¸€å—åŒºåŸŸï¼Œ æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œæœªåˆå§‹åŒ–çš„é™æ€å˜é‡åœ¨ç›¸é‚»çš„å¦ä¸€å—åŒºåŸŸã€‚ - ç¨‹åºç»“æŸåç”±ç³»ç»Ÿé‡Šæ”¾ã€‚</li><li>æ–‡å­—å¸¸é‡åŒº : å¸¸é‡å­—ç¬¦ä¸²å°±æ˜¯æ”¾åœ¨è¿™é‡Œçš„ã€‚ ç¨‹åºç»“æŸåç”±ç³»ç»Ÿé‡Šæ”¾</li><li>ç¨‹åºä»£ç åŒº : å­˜æ”¾å‡½æ•°ä½“çš„äºŒè¿›åˆ¶ä»£ç ã€‚</li></ol><p>å†…å­˜åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/1609713-eaa6e0729938352f.webp" alt="img"></p><p>ä¸Šå›¾æ˜¯ç½‘ä¸Šæœç´¢å †æ ˆå¾ˆå¸¸è§çš„ä¸€ä¸ªå›¾ï¼Œåœ¨è¿™ä¸ªå›¾é‡Œé¢ï¼Œæ ˆåŒºå’Œå †åŒºå°±æ˜¯å¯¹åº”å†…å­˜åˆ†é…ä¸­çš„æ ˆåŒºå’Œå †åŒºï¼Œå…¶ä½™çš„å¯å‚ç…§ä¸‹é¢å¯¹åº”</p><p>å¯è¯»å†™å– =&gt; å…¨å±€åŒº</p><p>æ–‡å­—å¸¸é‡åŒº =&gt; åªè¯»åŒº</p><p>ç¨‹åºä»£ç å» =&gt; åªè¯»åŒº</p><h1 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h1><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ç»“åˆç½‘ä¸Šéå¸¸ç»å…¸çš„ä¸€ä¸ªä¾‹å­æ¥åˆ†æ</p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/1470646448_1244.PNG" alt="https://github-1253518569.cos.ap-shanghai.myqcloud.com/1470646448_1244.PNG"></p><ul><li>int a = 0 : è¿™é‡Œæ˜¯å†™åœ¨mainå‡½æ•°å¤–é¢çš„å…¨å±€å˜é‡ï¼Œå±äºåˆå§‹åŒ–è¿‡çš„å…¨å±€å˜é‡ï¼Œæ‰€ä»¥åº”è¯¥å­˜åœ¨åœ¨ <code>å…¨å±€åŒº</code></li><li>char *p1 : è¿™é‡ŒåŒä¸Šï¼ŒåŒºåˆ«æ˜¯æ²¡æœ‰ç»è¿‡åˆå§‹åŒ–ï¼Œæ‰€ä»¥å±äºæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œæ‰€ä»¥åº”è¯¥ä¹Ÿå­˜åœ¨ <code>å…¨å±€åŒº</code></li><li>int b : è¿™ä¸€è¡Œæ˜¯åœ¨mainå‡½æ•°é‡Œé¢ï¼Œä¹Ÿæ²¡æœ‰å£°æ˜å…¨å±€å˜é‡ï¼Œå±äºå±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯å­˜æ”¾åœ¨ <code>æ ˆåŒº</code> ä¸Šé¢</li><li>char s[] = â€œabcâ€ : åŒä¸Šï¼Œs å˜é‡æ˜¯ å±€éƒ¨å˜é‡ï¼Œä¹Ÿå°±æ˜¯å­˜æ”¾åœ¨ <code>æ ˆåŒº</code> ä¸Šé¢ï¼Œåˆ†é…çš„å†…å­˜é‡Œé¢å­˜å‚¨çš„å°±æ˜¯ â€œabcâ€</li><li>char *p2 : åŒ <code>int b</code> åˆ†æå¯å¾—ï¼Œå­˜æ”¾åœ¨ <code>æ ˆåŒº</code> ä¸Šé¢</li><li>char *p3 :  åŒä¸Šåˆ†æå¯å¾—ï¼Œ p3 æ˜¯å­˜æ”¾åœ¨ <code>æ ˆåŒº</code> ä¸Šé¢ï¼Œp3æ‰€åœ¨çš„å†…å­˜å°±å­˜å‚¨äº†å®ƒæ‰€æŒ‡å‘çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¶ä¸æ˜¯å­˜å‚¨çš„â€123456â€ï¼Œè¿™æ—¶å€™ â€œ123456â€ å°±å¯ä»¥çœ‹æˆä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²ï¼Œåº”è¯¥æ˜¯å­˜æ”¾åœ¨ <code>æ–‡å­—å¸¸é‡åŒº</code></li><li>static int c = 0 : åˆå§‹åŒ–çš„é™æ€å˜é‡åº”è¯¥å­˜æ”¾åœ¨ <code>å…¨å±€åŒº</code></li><li>p1 = (char * )malloc(10) : p1 è¿™ä¸ªå˜é‡è‚¯å®šæ˜¯è¢«å‹å…¥ <code>æ ˆå†…</code> çš„ï¼Œå…¶å€¼ä¹Ÿå°±æ˜¯ç”³è¯·çš„å†…å­˜çš„é¦–åœ°å€ï¼Œ é‚£ malloc åˆ†é…çš„åœ°å€å‘¢ï¼Œ è¿™ä¸ªåœ°å€æ˜¯ç”±ç¨‹åºå‘˜åˆ†é…çš„ï¼Œæ‰€ä»¥æ˜¯å­˜æ”¾åœ¨ <code>å †åŒº</code> ä¸Šçš„ä¸€å—å†…å­˜</li><li>p2 = (char *) malloc(20) : åŒä¸Šåˆ†æ</li><li>strcpy(p1, â€œ123456â€) : å¯¹äºç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œä¸ªäººå¹¶ä¸æ¸…æ¥šï¼Œæ‰€ä»¥å¯ä¾æ®å›¾ä¸­çš„æ³¨é‡Š </li></ul><h1 id="å†…å­˜æ³„æ¼"><a href="#å†…å­˜æ³„æ¼" class="headerlink" title="å†…å­˜æ³„æ¼"></a>å†…å­˜æ³„æ¼</h1><p>åœ¨ä¸Šé¢çš„å†…å­˜åˆ†å¸ƒä¸­ä¼šå‘ç°ï¼Œé™¤äº†<code>å †åŒº</code>ä»¥å¤–ï¼Œå…¶ä»–åŒºçš„å†…å­˜åŒºä¼šåœ¨ç¨‹åºç»“æŸæ—¶ï¼Œç”±ç³»ç»Ÿé‡Šæ”¾ï¼Œæ‰€ä»¥å†… <strong>å†…å­˜æ³„æ¼</strong>æ˜¯æŒ‡ç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„<a href="https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98" target="_blank" rel="noopener">å†…å­˜</a>ã€‚å†…å­˜æ³„æ¼å¹¶éæŒ‡å†…å­˜åœ¨ç‰©ç†ä¸Šçš„æ¶ˆå¤±ï¼Œè€Œæ˜¯åº”ç”¨ç¨‹åºåˆ†é…æŸæ®µå†…å­˜åï¼Œç”±äºè®¾è®¡é”™è¯¯ï¼Œå¯¼è‡´åœ¨é‡Šæ”¾è¯¥æ®µå†…å­˜ä¹‹å‰å°±å¤±å»äº†å¯¹è¯¥æ®µå†…å­˜çš„æ§åˆ¶ï¼Œä»è€Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨Cè¯­è¨€ä¸­ï¼Œå†…å­˜çš„é‡Šæ”¾æ˜¯ç”± <strong>free()</strong> æ¥å¤„ç†å®Œæˆçš„ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void free(void *ptr)  </span><br><span class="line">&#123; </span><br><span class="line">    struct mem_control_block *free; </span><br><span class="line">    free = ptr - sizeof(struct mem_control_block); </span><br><span class="line">    free-&gt;is_available = 1; </span><br><span class="line">    return; </span><br><span class="line">&#125;</span><br><span class="line">struct mem_control_block &#123; </span><br><span class="line">int is_available;    //è¿™æ˜¯ä¸€ä¸ªæ ‡è®°ï¼Ÿ </span><br><span class="line">int size;            //è¿™æ˜¯å®é™…ç©ºé—´çš„å¤§å° </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ <strong>free()</strong>ï¼Œ å…¶å®æ˜¯æŠŠå¯¹åº”å†…å­˜å—è®¾ç½®ä¸ºå¯ç”¨ï¼ŒåŒæ—¶æŠŠæŒ‡é’ˆå†å‘å‰åç§» <strong>å†…å­˜å—æ§åˆ¶å¤´</strong> çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯å®é™…åˆ†é…çš„å†…å­˜å—é¦–åœ°å€ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œå¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬ç»™ <strong>free()</strong> çš„ä¸æ˜¯<strong>malloc()</strong> è¿”å›ç»™æˆ‘ä»¬çš„åœ°å€ï¼Œè¿™æ—¶å€™å»é‡Šæ”¾å†…å­˜æ˜¯ä¸æ—¶ä¼šå­˜åœ¨é—®é¢˜ ï¼Œæ‰€ä»¥ï¼Œç»¼ä¸Šï¼Œå†…å­˜æ³„æ¼å¯ä»¥æ€»ç»“å‡ºä¸¤ç§åŸå› </p><ol><li>malloc ä¹‹å æ²¡æœ‰ free</li><li>free æ˜¯ ç»™çš„åœ°å€ä¸æ˜¯ malloc è¿”å›ç»™æˆ‘ä»¬çš„é¦–åœ°å€</li></ol>]]></content>
      
      
      <categories>
          
          <category> å†…å­˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥PHPç³»åˆ—ä¹‹PHPæ•°ç»„åº•å±‚çš„å®ç°</title>
      <link href="/posts/17570/"/>
      <url>/posts/17570/</url>
      
        <content type="html"><![CDATA[<p>æ•°ç»„æ˜¯PHPä¸­éå¸¸å¼ºå¤§ã€çµæ´»çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œå®ƒçš„åº•å±‚å®ç°ä¸ºæ•£åˆ—è¡¨(HashTableï¼Œä¹Ÿç§°ä½œï¼šå“ˆå¸Œè¡¨)ï¼Œé™¤äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„PHPç”¨æˆ·ç©ºé—´çš„Arrayç±»å‹ä¹‹å¤–ï¼Œå†…æ ¸ä¸­ä¹Ÿéšå¤„ç”¨åˆ°æ•£åˆ—è¡¨ï¼Œæ¯”å¦‚å‡½æ•°ã€ç±»ã€å¸¸é‡ã€å·²includeæ–‡ä»¶çš„ç´¢å¼•è¡¨ã€å…¨å±€ç¬¦å·è¡¨ç­‰éƒ½ç”¨çš„HashTableå­˜å‚¨ã€‚</p><p>æ•£åˆ—è¡¨æ˜¯æ ¹æ®å…³é”®ç å€¼(Key value)è€Œç›´æ¥è¿›è¡Œè®¿é—®çš„æ•°æ®ç»“æ„ï¼Œå®ƒçš„key - valueä¹‹é—´å­˜åœ¨ä¸€ä¸ªæ˜ å°„å‡½æ•°ï¼Œå¯ä»¥æ ¹æ®keyé€šè¿‡æ˜ å°„å‡½æ•°ç›´æ¥ç´¢å¼•åˆ°å¯¹åº”çš„valueå€¼ï¼Œå®ƒä¸ä»¥å…³é”®å­—çš„æ¯”è¾ƒä¸ºåŸºæœ¬æ“ä½œï¼Œé‡‡ç”¨ç›´æ¥å¯»å€æŠ€æœ¯ï¼ˆå°±æ˜¯è¯´ï¼Œå®ƒæ˜¯ç›´æ¥é€šè¿‡keyæ˜ å°„åˆ°å†…å­˜åœ°å€ä¸Šå»çš„ï¼‰ï¼Œä»è€ŒåŠ å¿«æŸ¥æ‰¾é€Ÿåº¦ï¼Œåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œæ— é¡»ä»»ä½•æ¯”è¾ƒå°±å¯ä»¥æ‰¾åˆ°å¾…æŸ¥å…³é”®å­—ï¼ŒæŸ¥æ‰¾çš„æœŸæœ›æ—¶é—´ä¸ºO(1)ã€‚</p><a id="more"></a><h1 id="æ•°ç»„ç»“æ„"><a href="#æ•°ç»„ç»“æ„" class="headerlink" title="æ•°ç»„ç»“æ„"></a>æ•°ç»„ç»“æ„</h1><h2 id="Array-ç»“æ„ä½“ï¼ˆzend-type-hï¼‰"><a href="#Array-ç»“æ„ä½“ï¼ˆzend-type-hï¼‰" class="headerlink" title="Array ç»“æ„ä½“ï¼ˆzend_type.hï¼‰"></a>Array ç»“æ„ä½“ï¼ˆ<strong>zend_type.h</strong>ï¼‰</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">struct _zend_array &#123;</span><br><span class="line">    zend_refcounted_h gc;</span><br><span class="line">    union &#123;</span><br><span class="line">        struct &#123;</span><br><span class="line">            ZEND_ENDIAN_LOHI_4(</span><br><span class="line">                zend_uchar    flags,</span><br><span class="line">                zend_uchar    _unused,</span><br><span class="line">                zend_uchar    nIteratorsCount,</span><br><span class="line">                zend_uchar    _unused2)</span><br><span class="line">        &#125; v;</span><br><span class="line">        uint32_t flags;</span><br><span class="line">    &#125; u;</span><br><span class="line">    uint32_t          nTableMask; // å“ˆå¸Œå€¼è®¡ç®—æ©ç  ç­‰äº -nTableSize</span><br><span class="line">    Bucket           *arData;  // å­˜å‚¨å…ƒç´ æ•°ç»„ï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªbucket</span><br><span class="line">    uint32_t          nNumUsed; // å·²ç”¨çš„bucketæ•°é‡</span><br><span class="line">    uint32_t          nNumOfElements; // å“ˆå¸Œè¡¨ä¸­å…¨éƒ¨å…ƒç´ æ•°</span><br><span class="line">    uint32_t          nTableSize;  // å“ˆå¸Œè¡¨çš„æ€»å¤§å°</span><br><span class="line">    uint32_t          nInternalPointer;</span><br><span class="line">    zend_long         nNextFreeElement; // ä¸‹ä¸€ä¸ªå¯ç”¨çš„æ•°å€¼ç´¢å¼•ï¼Œ ä¾‹ arr[] = 1; è¿™é‡Œå°±æ˜¯1</span><br><span class="line">    dtor_func_t       pDestructor;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªäº†ç»“æ„ä½“é‡Œé¢ åœ¨ç¬¬2è¡Œ å¼•å…¥äº† <strong>zend_refcounted_h</strong> ç»“æ„ä½“ï¼Œè¿™ä¸ªæ˜¯åƒåœ¾å›æ”¶æ—¶ç”¨åˆ°çš„</p><p>åœ¨ç¬¬14è¡Œçš„æ—¶å€™ å¼•å…¥äº† <strong>Bucket</strong> ç»“æ„ä½“ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ <strong>Bucket</strong> ç»“æ„ä½“</p><h2 id="Bucketç»“æ„ä½“-ï¼ˆzend-type-hï¼‰"><a href="#Bucketç»“æ„ä½“-ï¼ˆzend-type-hï¼‰" class="headerlink" title="Bucketç»“æ„ä½“ ï¼ˆzend_type.hï¼‰"></a>Bucketç»“æ„ä½“ ï¼ˆzend_type.hï¼‰</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _Bucket &#123;</span><br><span class="line">zval              val;</span><br><span class="line">zend_ulong        h;                /* hash value (or numeric index)   */</span><br><span class="line">zend_string      *key;              /* string key or NULL for numerics */</span><br><span class="line">&#125; Bucket;</span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬2è¡Œçš„æ—¶å€™ï¼Œå¼•å…¥äº† zval ç»“æ„ä½“ï¼Œ</p><h2 id="zvalç»“æ„ä½“ï¼ˆzend-type-hï¼‰"><a href="#zvalç»“æ„ä½“ï¼ˆzend-type-hï¼‰" class="headerlink" title="zvalç»“æ„ä½“ï¼ˆzend_type.hï¼‰"></a>zvalç»“æ„ä½“ï¼ˆzend_type.hï¼‰</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">struct _zval_struct &#123;</span><br><span class="line">    zend_value        value;            /* value */</span><br><span class="line">    union &#123;</span><br><span class="line">        struct &#123;</span><br><span class="line">            ZEND_ENDIAN_LOHI_3(</span><br><span class="line">                zend_uchar    type,         /* active type */</span><br><span class="line">                zend_uchar    type_flags,</span><br><span class="line">                union &#123;</span><br><span class="line">                    uint16_t  call_info;    /* call info for EX(This) */</span><br><span class="line">                    uint16_t  extra;        /* not further specified */</span><br><span class="line">                &#125; u)</span><br><span class="line">        &#125; v;</span><br><span class="line">        uint32_t type_info;</span><br><span class="line">    &#125; u1;</span><br><span class="line">    union &#123;</span><br><span class="line">        uint32_t     next;                 /* hash collision chain */</span><br><span class="line">        uint32_t     cache_slot;           /* cache slot (for RECV_INIT) */</span><br><span class="line">        uint32_t     opline_num;           /* opline number (for FAST_CALL) */</span><br><span class="line">        uint32_t     lineno;               /* line number (for ast nodes) */</span><br><span class="line">        uint32_t     num_args;             /* arguments number for EX(This) */</span><br><span class="line">        uint32_t     fe_pos;               /* foreach position */</span><br><span class="line">        uint32_t     fe_iter_idx;          /* foreach iterator index */</span><br><span class="line">        uint32_t     access_flags;         /* class constant access flags */</span><br><span class="line">        uint32_t     property_guard;       /* single property guard */</span><br><span class="line">        uint32_t     constant_flags;       /* constant flags */</span><br><span class="line">        uint32_t     extra;                /* not further specified */</span><br><span class="line">    &#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="å­—æ®µè§£é‡Š"><a href="#å­—æ®µè§£é‡Š" class="headerlink" title="å­—æ®µè§£é‡Š"></a>å­—æ®µè§£é‡Š</h2><p>é¦–å…ˆä» arrayç»“æ„ä½“å¼€å§‹è¯´èµ·</p><ul><li>nTableMask : å“ˆå¸Œå€¼è®¡ç®—æ©ç ï¼Œ æ•°ç»„çš„ç´¢å¼•è®¡ç®—å‡ºæ¥çš„long ä¸è¿™ä¸ªå€¼è¿›è¡Œä½è¿ç®—ï¼Œä»è€Œè®¡ç®—å‡ºè¿™ä¸ªæ•°æ®åº”è¯¥å­˜æ”¾åœ¨ç´¢å¼•è¡¨çš„ä½ç½®</li><li>arData: æ•°ç»„ä¸­çš„å€¼éƒ½å­˜æ”¾åœ¨è¿™é‡Œï¼Œè¿™ä¸ªä¹Ÿæ˜¯æ•°ç»„hashè¡¨çš„å®ç°çš„åœ°æ–¹</li><li>nNumUsed: ä½¿ç”¨çš„bucketçš„æ€»æ•°</li><li>nNumOfElements: hashè¡¨ä¸­çš„æœ‰æ•ˆæ•°æ®ï¼Œåœ¨PHPä¸­ï¼Œåˆ é™¤æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸ä¼šç›´æ¥å°†è¿™ä¸ªå…ƒç´ ä»hashè¡¨é‡Œé¢åˆ é™¤ï¼Œè€Œæ˜¯åœ¨bucketé‡Œé¢çš„zvalç»“æ„ä½“é‡Œé¢ä¿®æ”¹ä¸º <code>IS_UNDEF</code>ï¼Œ åœ¨ <code>ht-&gt;nNumUsed &gt; ht-&gt;nNumOfElements + (ht-&gt;nNumOfElements &gt;&gt; 5)</code> çš„æ—¶å€™è¿›è¡Œæ•´ç†</li><li>nTableSize: åˆ†é…çš„hashè¡¨çš„å¤§å°</li><li>nNextFreeElement: ä¸‹ä¸€ä¸ªå¯ç”¨çš„hashæ•°å€¼ç´¢å¼•</li><li>pDestructor: ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“è¦†ç›–/åˆ é™¤ä¸€ä¸ªkeyæˆ–è€…é‡Šæ”¾zend_arrayæ—¶ï¼Œç”¨äºé‡Šæ”¾Bucketä¸­çš„valã€‚</li></ul><p>Bucket</p><ul><li>valï¼šå­˜å‚¨çš„zvalæ•°æ®ã€‚</li><li>hï¼šå½“å…ƒç´ ä¿å­˜åœ¨æ•´å½¢ä¸‹æ ‡æ—¶ï¼Œä¸‹æ ‡ä¿å­˜åœ¨è¯¥å­—æ®µï¼Œå¹¶ä¸”æœ¬èº«å……å½“hashå€¼ï¼Œå¯¹å…¶å–æ¨¡å¾—åˆ°å“ˆå¸Œè¡¨çš„æ§½ä½ã€‚</li><li>keyï¼šå½“ä¿å­˜çš„keyæ˜¯å­—ç¬¦ä¸²æ—¶ï¼Œä¿å­˜åœ¨è¯¥å­—æ®µï¼Œé€šè¿‡æŸä¸ªå“ˆå¸Œç®—æ³•ç”Ÿæˆhashå€¼ä¿å­˜åˆ°hå­—æ®µï¼Œå¯¹hå–æ¨¡å¾—åˆ°å“ˆå¸Œè¡¨çš„æ§½ä½ã€‚</li></ul><h1 id="hashè¡¨"><a href="#hashè¡¨" class="headerlink" title="hashè¡¨"></a>hashè¡¨</h1><h2 id="hashè¡¨å›¾ç¤º"><a href="#hashè¡¨å›¾ç¤º" class="headerlink" title="hashè¡¨å›¾ç¤º"></a>hashè¡¨å›¾ç¤º</h2><p>é¦–å…ˆåœ¨è¿™é‡Œå±•ç¤ºä¸€ä¸‹ï¼Œæ•°ç»„çš„hashè¡¨å¤§è‡´çš„å®ç°å›¾ç¤ºï¼Œç„¶åç»“åˆæ’å…¥æ“ä½œæ¥å…·ä½“åˆ†æ</p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/php-hash-table.png" alt="hashè¡¨å›¾ç¤º"></p><h2 id="hashè¡¨å®ç°ï¼ˆzend-hash-cï¼‰"><a href="#hashè¡¨å®ç°ï¼ˆzend-hash-cï¼‰" class="headerlink" title="hashè¡¨å®ç°ï¼ˆzend_hash.cï¼‰"></a>hashè¡¨å®ç°ï¼ˆzend_hash.cï¼‰</h2><p>è¿™é‡Œé¦–è¦åˆ†æäº† æ•°ç»„çš„æ’å…¥æ“ä½œï¼Œæ’å…¥çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•åˆ›å»ºä½¿ç”¨hashè¡¨çš„ç´¢å¼•åŠé€‰æ‹©bucketçš„ä½ç½®çš„ï¼Œæ’å…¥æ“ä½œä¸»è¦é€šè¿‡ <code>_zend_hash_add_or_update_i</code> å®ç°çš„ï¼Œå¦‚ä¸‹ï¼š</p><p>é¦–å…ˆå…ˆå°†ä¸€äº›å¯èƒ½ä¼šç”¨ç”¨åˆ°çš„å¸¸é‡å’Œå‡½æ•°å…ˆåœ¨è¿™é‡Œå£°æ˜ä¸€ä¸‹ï¼Œåé¢æŸ¥çœ‹æºç çš„æ—¶å€™ä¼šç”¨åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#define Z_NEXT(zval)                (zval).u2.next</span><br><span class="line">#define Z_NEXT_P(zval_p)            Z_NEXT(*(zval_p))</span><br><span class="line"></span><br><span class="line">#define HT_HASH_EX(data, idx) \</span><br><span class="line">    ((uint32_t*)(data))[(int32_t)(idx)]</span><br><span class="line">#define HT_HASH(ht, idx) \</span><br><span class="line">    HT_HASH_EX((ht)-&gt;arData, idx)</span><br><span class="line"># define HT_IDX_TO_HASH(idx) \</span><br><span class="line">    ((idx) * sizeof(Bucket))</span><br><span class="line"></span><br><span class="line">#define HT_FLAGS(ht) (ht)-&gt;u.flags</span><br><span class="line"></span><br><span class="line">#define HT_IS_PACKED(ht) \</span><br><span class="line">    ((HT_FLAGS(ht) &amp; HASH_FLAG_PACKED) != 0)</span><br><span class="line"></span><br><span class="line">#define HASH_UPDATE (1&lt;&lt;0)</span><br><span class="line">#define HASH_ADD(1&lt;&lt;1)</span><br><span class="line">#define HASH_UPDATE_INDIRECT(1&lt;&lt;2)</span><br><span class="line">#define HASH_ADD_NEW(1&lt;&lt;3)</span><br><span class="line">#define HASH_ADD_NEXT(1&lt;&lt;4)</span><br><span class="line"></span><br><span class="line">#define HASH_FLAG_CONSISTENCY      ((1&lt;&lt;0) | (1&lt;&lt;1))</span><br><span class="line">#define HASH_FLAG_PACKED           (1&lt;&lt;2)</span><br><span class="line">#define HASH_FLAG_INITIALIZED      (1&lt;&lt;3)</span><br><span class="line">#define HASH_FLAG_STATIC_KEYS      (1&lt;&lt;4) /* long and interned strings */</span><br><span class="line">#define HASH_FLAG_HAS_EMPTY_IND    (1&lt;&lt;5)</span><br><span class="line">#define HASH_FLAG_ALLOW_COW_VIOLATION (1&lt;&lt;6)</span><br></pre></td></tr></table></figure><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">static zend_always_inline zval *_zend_hash_add_or_update_i(HashTable *ht, zend_string *key, zval *pData, uint32_t flag)</span><br><span class="line">&#123;</span><br><span class="line">zend_ulong h;</span><br><span class="line">uint32_t nIndex;</span><br><span class="line">uint32_t idx;</span><br><span class="line">Bucket *p, *arData;</span><br><span class="line"></span><br><span class="line">IS_CONSISTENT(ht);</span><br><span class="line">HT_ASSERT_RC1(ht);</span><br><span class="line">// æ£€æŸ¥hashtableæ˜¯å¦åˆå§‹åŒ–</span><br><span class="line">if (UNEXPECTED(!(HT_FLAGS(ht) &amp; HASH_FLAG_INITIALIZED))) &#123;</span><br><span class="line">    // å¦‚æœæ•°ç»„è¿˜æ²¡æœ‰åˆ†é…ardataå†…å­˜ï¼Œ è¿™æ—¶éœ€è¦åˆ†é…å†…å­˜ï¼ŒåŒ…æ‹¬ä¸­é—´æ˜ å°„è¡¨å’Œå…ƒç´ æ•°ç»„</span><br><span class="line">zend_hash_real_init_mixed(ht);</span><br><span class="line">if (!ZSTR_IS_INTERNED(key)) &#123;</span><br><span class="line">zend_string_addref(key);</span><br><span class="line">HT_FLAGS(ht) &amp;= ~HASH_FLAG_STATIC_KEYS;</span><br><span class="line">zend_string_hash_val(key);</span><br><span class="line">&#125;</span><br><span class="line">goto add_to_hash;</span><br><span class="line">&#125; else if (HT_FLAGS(ht) &amp; HASH_FLAG_PACKED) &#123;</span><br><span class="line">    // è¿™é‡Œå°†packed arrayè½¬æ¢æˆç­‰æ•ˆçš„hash array</span><br><span class="line">zend_hash_packed_to_hash(ht);</span><br><span class="line">if (!ZSTR_IS_INTERNED(key)) &#123;</span><br><span class="line">zend_string_addref(key);</span><br><span class="line">HT_FLAGS(ht) &amp;= ~HASH_FLAG_STATIC_KEYS;</span><br><span class="line">zend_string_hash_val(key);</span><br><span class="line">&#125;</span><br><span class="line">&#125; else if ((flag &amp; HASH_ADD_NEW) == 0) &#123;</span><br><span class="line">p = zend_hash_find_bucket(ht, key, 0);</span><br><span class="line"></span><br><span class="line">if (p) &#123;</span><br><span class="line">zval *data;</span><br><span class="line">// keyå·²ç»å­˜åœ¨çš„æƒ…å†µï¼Œä¸”æ ‡å¿—ä½ æ˜¯HASH_ADD</span><br><span class="line">if (flag &amp; HASH_ADD) &#123;</span><br><span class="line">if (!(flag &amp; HASH_UPDATE_INDIRECT)) &#123;</span><br><span class="line">return NULL;</span><br><span class="line">&#125;</span><br><span class="line">// æ–°æ›´æ–°çš„å€¼ä¸ä¸åŸå…ˆç›¸åŒï¼Œç»§ç»­æ‰§è¡Œ</span><br><span class="line">ZEND_ASSERT(&amp;p-&gt;val != pData);</span><br><span class="line">data = &amp;p-&gt;val;</span><br><span class="line">// IS_INDIRECTæ˜¯é—´æ¥zvalï¼Œä¸æ˜ç™½ä»€ä¹ˆæ„æ€ï¼Œç»§ç»­å­¦ä¹ </span><br><span class="line">if (Z_TYPE_P(data) == IS_INDIRECT) &#123;</span><br><span class="line">data = Z_INDIRECT_P(data);</span><br><span class="line">if (Z_TYPE_P(data) != IS_UNDEF) &#123;</span><br><span class="line">return NULL;</span><br><span class="line">&#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">return NULL;</span><br><span class="line">&#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">ZEND_ASSERT(&amp;p-&gt;val != pData);</span><br><span class="line">data = &amp;p-&gt;val;</span><br><span class="line">if ((flag &amp; HASH_UPDATE_INDIRECT) &amp;&amp; Z_TYPE_P(data) == IS_INDIRECT) &#123;</span><br><span class="line">data = Z_INDIRECT_P(data);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">// é‡Šæ”¾æ‰åŸæ¥çš„data</span><br><span class="line">if (ht-&gt;pDestructor) &#123;</span><br><span class="line">ht-&gt;pDestructor(data);</span><br><span class="line">&#125;</span><br><span class="line">// å°†æ–°çš„pDataå€¼å¤åˆ¶ç»™åŸæ¥çš„data</span><br><span class="line">ZVAL_COPY_VALUE(data, pData);</span><br><span class="line">return data;</span><br><span class="line">&#125;</span><br><span class="line">if (!ZSTR_IS_INTERNED(key)) &#123;</span><br><span class="line">zend_string_addref(key);</span><br><span class="line">HT_FLAGS(ht) &amp;= ~HASH_FLAG_STATIC_KEYS;</span><br><span class="line">&#125;</span><br><span class="line">&#125; else if (!ZSTR_IS_INTERNED(key)) &#123;</span><br><span class="line">zend_string_addref(key);</span><br><span class="line">HT_FLAGS(ht) &amp;= ~HASH_FLAG_STATIC_KEYS;</span><br><span class="line">zend_string_hash_val(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¦‚æœhashè¡¨æ»¡äº†ï¼Œå¯¹hashè¡¨è¿›è¡Œæ‰©å®¹</span><br><span class="line">ZEND_HASH_IF_FULL_DO_RESIZE(ht);/* If the Hash table is full, resize it */</span><br><span class="line"></span><br><span class="line">// æ·»åŠ hashè¡¨</span><br><span class="line">add_to_hash:</span><br><span class="line">    // ardataæ•°ç»„çš„é¡ºåºç´¢å¼•</span><br><span class="line">idx = ht-&gt;nNumUsed++;</span><br><span class="line">ht-&gt;nNumOfElements++;</span><br><span class="line">arData = ht-&gt;arData;</span><br><span class="line">// arDataçš„æŒ‡é’ˆåç§»åˆ° idx</span><br><span class="line">p = arData + idx;</span><br><span class="line">// è®¾ç½® hashè¡¨é‡Œé¢çš„bucketç»“æ„ä½“çš„ keyå’Œ h</span><br><span class="line">p-&gt;key = key;</span><br><span class="line">p-&gt;h = h = ZSTR_H(key);</span><br><span class="line">// ä¸tablemaskè¿›è¡Œè®¡ç®—å¾—å‡ºhashç´¢å¼•</span><br><span class="line">nIndex = h | ht-&gt;nTableMask;</span><br><span class="line">Z_NEXT(p-&gt;val) = HT_HASH_EX(arData, nIndex);</span><br><span class="line">// æ–°çš„å…ƒç´ æ”¾åˆ°å½“å‰hashå†²çªé“¾è¡¨çš„å¤´éƒ¨</span><br><span class="line">HT_HASH_EX(arData, nIndex) = HT_IDX_TO_HASH(idx);</span><br><span class="line">ZVAL_COPY_VALUE(&amp;p-&gt;val, pData);</span><br><span class="line"></span><br><span class="line">return &amp;p-&gt;val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„<code>api _zend_hash_add_or_update_i</code>å¯ä»¥çœ‹å‡ºï¼Œå…¶å®æ›´æ–°æ“ä½œå¾ˆç®€å•çš„ï¼ŒéªŒè¯keyæ˜¯å¦å­˜åœ¨ï¼Œkeyå­˜åœ¨çš„æƒ…å†µä¸‹å¦‚æœå€¼ç›¸ç­‰çš„è¯ä¸åšä»»ä½•çš„æ“ä½œï¼Œå€¼ä¸ç›¸åŒåšæ›´æ–°æ“ä½œã€‚<br>è¿™é‡Œæ¯”è¾ƒé‡è¦çš„æ˜¯hashè¡¨çš„æ–°å¢ï¼Œè¿™é‡Œä¼šæ¶‰åŠhashç´¢å¼•ä»¥åŠhashå†²çªé“¾è¡¨ã€‚</p><p><code>nIndex = h | ht-&gt;nTableMask;</code> </p><p>è¿™é‡Œç”±äº <strong>nTableMask</strong> æ˜¯ <strong>-TableSize</strong>ï¼Œ æ‰€ä»¥ <strong>nIndex</strong> çš„è®¡ç®—ç»“æœèŒƒå›´ï¼Œä¹Ÿå°±è½åˆ°äº†-2^0 - -2^(tableSize-1)èŒƒå›´é‡Œä»è€Œå°†æ•´ä¸ª <strong>arData</strong> åˆ†æˆä¸Šå›¾æ‰€ç¤ºçš„å·¦å³ä¸¤éƒ¨åˆ†ï¼Œå·¦è¾¹æ˜¯ç´¢å¼•è¡¨ï¼Œå³è¾¹æ˜¯å…ƒç´ æ•°ç»„ï¼Œæ¯æ¬¡æ–°å¢æ•°æ®ï¼ˆéæ›´æ–°ï¼‰çš„æ—¶å€™ï¼Œé¦–å…ˆæŠŠè¿™ä¸ªæ•°æ®ï¼Œé¡ºåºçš„æ’å…¥åˆ°<strong>arData</strong> å³ä¾§çš„å…ƒç´ æ•°ç»„é‡Œé¢ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ•°ç»„çš„é¡ºåºæ€§ï¼Œåœ¨foreachçš„æ—¶å€™ï¼Œåªéœ€è¦é¡ºåºéå† <strong>arData</strong> å³ä¾§çš„æ•°ç»„å³å¯ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ æŸ¥æ‰¾æ€ä¹ˆåŠï¼Œ æ‰€ä»¥å°±å¼•å…¥äº†<strong>arData</strong> å·¦ä¾§çš„ç´¢å¼•è¡¨ï¼Œè®¡ç®—å‡ºkeyçš„hashç´¢å¼•ï¼Œç„¶åå†æŒ‡å‘ åˆšåˆšæ’å…¥çš„<strong>arData</strong>å³ä¾§å…ƒç´ æ•°ç»„çš„åœ°å€</p><p>æ—¢ç„¶ä½¿ç”¨äº†hashè¡¨ï¼Œå°±é¿å…ä¸äº†hashå†²çªçš„é—®é¢˜</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Z_NEXT(p-&gt;val) = HT_HASH_EX(arData, nIndex);</span><br><span class="line">HT_HASH_EX(arData, nIndex) = HT_IDX_TO_HASH(idx);</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸Šé¢å¯èƒ½ç”¨åˆ°çš„ä¸€äº›å®šä¹‰ï¼Œè¿™è¡Œå°±å¯ä»¥ç¿»è¯‘æˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;val.u2.next = *arData[nIndex]</span><br><span class="line">*arData[nIndex] = arData[idx]</span><br></pre></td></tr></table></figure><p>ç´¢å¼•bucketæŒ‡å‘æ–°æ’å…¥çš„å…ƒç´ ï¼Œæ–°æ’å…¥çš„å…ƒç´ é‡Œé˜¿ç±³ä½ çš„zvalç»“æ„ä½“é‡Œé¢çš„nextæŒ‡é’ˆå†æŒ‡å‘åŸå…ˆ ç´¢å¼•bucketæŒ‡å‘çš„ä½ç½®ï¼Œè¿™æ ·å°±æŠŠæ–°æ’å…¥çš„å…ƒç´ æ”¾åœ¨äº†å†²çªé“¾è¡¨çš„å¤´ä½ç½®äº†</p><h1 id="æ‰©å±•-éå†"><a href="#æ‰©å±•-éå†" class="headerlink" title="æ‰©å±•-éå†"></a>æ‰©å±•-éå†</h1><p>æ ¹æ®ä¸Šé¢çš„æ’å…¥æ€è·¯ï¼Œå¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ï¼Œæ•°ç»„åœ¨å†…å­˜ä¸­æ˜¯ä¸ªæœ‰åºçš„æ•°ç»„ï¼Œhashè¡¨å®ç°äº†ä½ç½®çš„ç´¢å¼•ï¼Œzvalçš„u2ç»“æ„ä½“å¸®åŠ©å®ç°äº† hashå†²çªçš„é“¾è¡¨è§£å†³æ–¹æ¡ˆ</p><p>å¦‚æœæ­¤æ—¶å»éå†æ•°ç»„ï¼Œå°±åªéœ€è¦é¡ºåºéå†<code>arData</code>çš„å³ä¾§å…ƒç´ æ•°æ®å³å¯ï¼Œè¿˜æ˜¯æœ‰åºçš„</p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥PHPç³»åˆ—ä¹‹PHPæ’åºsortå‡½æ•°å®ç°</title>
      <link href="/posts/30174/"/>
      <url>/posts/30174/</url>
      
        <content type="html"><![CDATA[<p>PHPçš„æ•°ç»„æ˜¯ä¸ªå¾ˆå¼ºå¤§çš„å­˜åœ¨ï¼Œè€Œä¸”ä½¿ç”¨PHPçš„æ•°ç»„çš„æ—¶å€™ï¼Œåªè¦ä½ èƒ½æƒ³åˆ°ï¼ŒåŸºæœ¬éƒ½å·²å®ç°ï¼Œæ‰€ä»¥ä¹Ÿè®©æˆ‘æ…¢æ…¢å¿˜è®°äº†æ’åºç®—æ³•çš„å­˜åœ¨ã€‚è¿‘æœŸï¼Œæœ‰ä¸ªäººé—®æˆ‘ï¼ŒPHPçš„sortå‡½æ•°æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå°´å°¬ï¼Œåœ¨é‡æ¸©äº†ä¸€éç®—æ³•ä¹‹åï¼Œæ ¹æ®æˆ‘å¤§å­¦ä¾ç¨€å­˜åœ¨çš„Cè¯­è¨€åŸºç¡€ï¼Œå°è¯•é˜…è¯»äº†ä¸€ä¸‹PHPçš„sortå‡½æ•°å®ç°çš„æºç ï¼Œä»¥ä¸‹æ˜¯ä»¥PHP7.3æºç ä¸ºä¾‹ï¼Œä¸ªäººæŠ€æœ¯æ°´å¹³æœ‰é™ï¼Œä»…ä¾›å‚è€ƒ</p><a id="more"></a><h1 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h1><blockquote><p>bool <strong>sort</strong>    ( array <code>&amp;$array</code>   [, int <code>$sort_flags</code> = SORT_REGULAR  ] )</p></blockquote><p>é¦–å…ˆæˆ‘ä»¬åœ¨ <code>php_srray.h</code> ä¸­å¯ä»¥çœ‹åˆ°array ä¸­ ç›¸å…³ æ’åºå‡½æ•°çš„å®šä¹‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(ksort);</span><br><span class="line">PHP_FUNCTION(krsort);</span><br><span class="line">PHP_FUNCTION(natsort);</span><br><span class="line">PHP_FUNCTION(natcasesort);</span><br><span class="line">PHP_FUNCTION(asort);</span><br><span class="line">PHP_FUNCTION(arsort);</span><br><span class="line">PHP_FUNCTION(sort);</span><br><span class="line">PHP_FUNCTION(rsort);</span><br><span class="line">PHP_FUNCTION(usort);</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>ç„¶åè¿›å…¥<code>array.c</code> æ‰¾åˆ° <code>PHP_FUNCTION(sort)</code> çš„å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(sort)</span><br><span class="line">&#123;</span><br><span class="line">    zval *array;</span><br><span class="line">    zend_long sort_type = PHP_SORT_REGULAR;</span><br><span class="line">    compare_func_t cmp;</span><br><span class="line"></span><br><span class="line">    ZEND_PARSE_PARAMETERS_START(1, 2)</span><br><span class="line">        Z_PARAM_ARRAY_EX(array, 0, 1)</span><br><span class="line">        Z_PARAM_OPTIONAL</span><br><span class="line">        Z_PARAM_LONG(sort_type)</span><br><span class="line">    ZEND_PARSE_PARAMETERS_END_EX(RETURN_FALSE);</span><br><span class="line"></span><br><span class="line">    cmp = php_get_data_compare_func(sort_type, 0);</span><br><span class="line"></span><br><span class="line">    if (zend_hash_sort(Z_ARRVAL_P(array), cmp, 1) == FAILURE) &#123;</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    RETURN_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>ZEND_PARSE_PARAMETERS_START</code>  <code>ZEND_PARSE_PARAMETERS_END_EX</code> ï¼Œåœ¨ <code>zend_api.h</code> ä¸­æœ‰å®šä¹‰åŠå®ç°ï¼Œ ä¸»è¦æ˜¯è¿›è¡Œå‚æ•°çš„æ ¡éªŒè½¬æ¢ç­‰æ“ä½œ</li><li><code>php_get_data_compare_func</code> è®¾ç½®æ¯”è¾ƒå‡½æ•°ï¼Œ ä¹Ÿå°±æ˜¯æ ¹æ® sort_flag æ¥å†³å®š</li><li><code>zend_hash_sort</code> è¿™é‡Œå¼€å§‹äº†æ­£å¼çš„æ’åº</li></ol><h1 id="zend-hash-sort"><a href="#zend-hash-sort" class="headerlink" title="zend_hash_sort"></a>zend_hash_sort</h1><p>è¿™ä¸ªå®šä¹‰åœ¨ <code>zend_hash.h</code> ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define zend_hash_sort(ht, compare_func, renumber) \</span><br><span class="line">    zend_hash_sort_ex(ht, zend_sort, compare_func, renumber)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°† <code>zend_hash_sort</code>  çš„æ–¹æ³•è½¬åˆ°äº† <code>zend_hash_sort_ex</code> çš„æ–¹æ³•ï¼Œæ¥ä¸‹æ¥ç»§ç»­æŸ¥çœ‹ <code>zend_hash_sort_ex</code> å³å¯</p><h1 id="zend-hash-sort-ex"><a href="#zend-hash-sort-ex" class="headerlink" title="zend_hash_sort_ex"></a>zend_hash_sort_ex</h1><p>è¿™ä¸ªå®šä¹‰åœ¨ <code>zend_hash.h</code> ä¸­ï¼Œåœ¨<code>zend_hash.c</code> ä¸­å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API int ZEND_FASTCALL zend_hash_sort_ex(HashTable *ht, sort_func_t sort, compare_func_t compar, zend_bool renumber)</span><br><span class="line">&#123;</span><br><span class="line">    Bucket *p;</span><br><span class="line">    uint32_t i, j;</span><br><span class="line"></span><br><span class="line">    IS_CONSISTENT(ht);</span><br><span class="line">    HT_ASSERT_RC1(ht);</span><br><span class="line"></span><br><span class="line">    if (!(ht-&gt;nNumOfElements&gt;1) &amp;&amp; !(renumber &amp;&amp; ht-&gt;nNumOfElements&gt;0)) &#123; /* Doesn&apos;t require sorting */</span><br><span class="line">        return SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (HT_IS_WITHOUT_HOLES(ht)) &#123;</span><br><span class="line">        i = ht-&gt;nNumUsed;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        for (j = 0, i = 0; j &lt; ht-&gt;nNumUsed; j++) &#123;</span><br><span class="line">            p = ht-&gt;arData + j;</span><br><span class="line">            if (UNEXPECTED(Z_TYPE(p-&gt;val) == IS_UNDEF)) continue;</span><br><span class="line">            if (i != j) &#123;</span><br><span class="line">                ht-&gt;arData[i] = *p;</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sort((void *)ht-&gt;arData, i, sizeof(Bucket), compar,</span><br><span class="line">            (swap_func_t)(renumber? zend_hash_bucket_renum_swap :</span><br><span class="line">                ((HT_FLAGS(ht) &amp; HASH_FLAG_PACKED) ? zend_hash_bucket_packed_swap : zend_hash_bucket_swap)));</span><br><span class="line"></span><br><span class="line">    ht-&gt;nNumUsed = i;</span><br><span class="line">    ht-&gt;nInternalPointer = 0;</span><br><span class="line"></span><br><span class="line">    if (renumber) &#123;</span><br><span class="line">        for (j = 0; j &lt; i; j++) &#123;</span><br><span class="line">            p = ht-&gt;arData + j;</span><br><span class="line">            p-&gt;h = j;</span><br><span class="line">            if (p-&gt;key) &#123;</span><br><span class="line">                zend_string_release(p-&gt;key);</span><br><span class="line">                p-&gt;key = NULL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ht-&gt;nNextFreeElement = i;</span><br><span class="line">    &#125;</span><br><span class="line">    if (HT_FLAGS(ht) &amp; HASH_FLAG_PACKED) &#123;</span><br><span class="line">        if (!renumber) &#123;</span><br><span class="line">            zend_hash_packed_to_hash(ht);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (renumber) &#123;</span><br><span class="line">            void *new_data, *old_data = HT_GET_DATA_ADDR(ht);</span><br><span class="line">            Bucket *old_buckets = ht-&gt;arData;</span><br><span class="line"></span><br><span class="line">            new_data = pemalloc(HT_SIZE_EX(ht-&gt;nTableSize, HT_MIN_MASK), (GC_FLAGS(ht) &amp; IS_ARRAY_PERSISTENT));</span><br><span class="line">            HT_FLAGS(ht) |= HASH_FLAG_PACKED | HASH_FLAG_STATIC_KEYS;</span><br><span class="line">            ht-&gt;nTableMask = HT_MIN_MASK;</span><br><span class="line">            HT_SET_DATA_ADDR(ht, new_data);</span><br><span class="line">            memcpy(ht-&gt;arData, old_buckets, sizeof(Bucket) * ht-&gt;nNumUsed);</span><br><span class="line">            pefree(old_data, GC_FLAGS(ht) &amp; IS_ARRAY_PERSISTENT);</span><br><span class="line">            HT_HASH_RESET_PACKED(ht);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            zend_hash_rehash(ht);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ç¬¬13è¡Œå¼€å§‹ï¼Œåˆ¤æ–­è¿™ä¸ªhashè¡¨æ˜¯å¦æœ‰ç©ºæ´ï¼Œ å¦‚æœæœ‰çš„è¯ï¼Œéå†æ•´ä¸ªhashè¡¨å¹¶å¡«è¡¥ç©ºæ´</li><li>ä½¿ç”¨sortæ–¹æ³•æ¥è¿›è¡Œ è¿™ä¸ªhashè¡¨çš„æ’åºï¼Œ è¿™é‡Œçš„sortå…¶å®æ˜¯ä¸ªæŒ‡é’ˆï¼Œç”±<code>zend_hash_sort_ex</code> çš„ç¬¬äºŒä¸ªå‚æ•° <strong>sort_func_t sort</strong> ä¼ é€’è¿‡æ¥ï¼Œæ ¹æ®ä¸Šä¸€éƒ¨åˆ† <code>zend_hash_sort</code> çš„å®ç°ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œçš„sortï¼Œå…¶å®æ˜¯æŒ‡å‘äº† <strong>zend_sort</strong> è¿™ä¸ªæ–¹æ³•</li><li>30è¡Œä»¥åå°±æ˜¯æ’åºå®Œæˆåçš„æ“ä½œäº†ï¼Œä¸æ˜¯ä¸»è¦ï¼Œå°±ä¸å¤šåºŸè¯äº†</li></ol><h1 id="zend-sort"><a href="#zend-sort" class="headerlink" title="zend_sort"></a>zend_sort</h1><p>è¿™ä¸ªåœ¨<code>zend_sort.h</code>ä¸­å®šä¹‰ï¼Œåœ¨ <code>zend_sort.c</code> ä¸­å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API void zend_sort(void *base, size_t nmemb, size_t siz, compare_func_t cmp, swap_func_t swp)</span><br><span class="line">&#123;</span><br><span class="line">while (1) &#123;</span><br><span class="line">if (nmemb &lt;= 16) &#123;</span><br><span class="line">zend_insert_sort(base, nmemb, siz, cmp, swp);</span><br><span class="line">return;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">char *i, *j;</span><br><span class="line">char *start = (char *)base;</span><br><span class="line">char *end = start + (nmemb * siz);</span><br><span class="line">size_t offset = (nmemb &gt;&gt; Z_L(1));</span><br><span class="line">char *pivot = start + (offset * siz);</span><br><span class="line"></span><br><span class="line">if ((nmemb &gt;&gt; Z_L(10))) &#123;</span><br><span class="line">size_t delta = (offset &gt;&gt; Z_L(1)) * siz;</span><br><span class="line">zend_sort_5(start, start + delta, pivot, pivot + delta, end - siz, cmp, swp);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">zend_sort_3(start, pivot, end - siz, cmp, swp);</span><br><span class="line">&#125;</span><br><span class="line">swp(start + siz, pivot);</span><br><span class="line">pivot = start + siz;</span><br><span class="line">i = pivot + siz;</span><br><span class="line">j = end - siz;</span><br><span class="line">while (1) &#123;</span><br><span class="line">while (cmp(pivot, i) &gt; 0) &#123;</span><br><span class="line">i += siz;</span><br><span class="line">if (UNEXPECTED(i == j)) &#123;</span><br><span class="line">goto done;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">j -= siz;</span><br><span class="line">if (UNEXPECTED(j == i)) &#123;</span><br><span class="line">goto done;</span><br><span class="line">&#125;</span><br><span class="line">while (cmp(j, pivot) &gt; 0) &#123;</span><br><span class="line">j -= siz;</span><br><span class="line">if (UNEXPECTED(j == i)) &#123;</span><br><span class="line">goto done;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">swp(i, j);</span><br><span class="line">i += siz;</span><br><span class="line">if (UNEXPECTED(i == j)) &#123;</span><br><span class="line">goto done;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">done:</span><br><span class="line">swp(pivot, i - siz);</span><br><span class="line">if ((i - siz) - start &lt; end - i) &#123;</span><br><span class="line">zend_sort(start, (i - start)/siz - 1, siz, cmp, swp);</span><br><span class="line">base = i;</span><br><span class="line">nmemb = (end - i)/siz;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">zend_sort(i, (end - i)/siz, siz, cmp, swp);</span><br><span class="line">nmemb = (i - start)/siz - 1;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>4-7è¡Œè¿›è¡Œäº†åˆ¤æ–­ï¼Œ å¦‚æœå…ƒç´ æ€»æ•° &lt;= 16 ï¼Œåˆ™è¿›è¡Œæ’å…¥æ’åºï¼Œè¿™æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œå› ä¸ºæ’å…¥æ’åºåœ¨æœ€å¥½çš„æƒ…å†µä¸‹æ—¶O(n) çº§çš„ç®—æ³•ï¼Œè€Œæ•°æ®é‡å°çš„æƒ…å†µä¸‹ï¼Œæ•°æ®æœ‰åºçš„å¯èƒ½æ€§å°±è¶Šé«˜ï¼Œä¹Ÿå°±ç¬¦åˆäº†æœ€å¥½çš„æƒ…å†µ</li><li>åé¢å°±æ˜¯ å¦‚æœå…ƒç´ æ€»æ•°  &gt; 16ï¼Œ åˆ™å¼€å§‹äº†å¦å¤–ä¸€ç§æ’åºï¼Œé¦–å…ˆç¡®å®šäº†å¤´å…ƒç´ å’Œå°¾å…ƒç´ ï¼Œå¹¶è®©å…ƒç´ æ€»æ•°å³ç§»ä¸€ä½ä½œä¸ºåŸºå‡†ï¼Œ è¿™é‡Œæ¶‰åŠä¸€ä¸ªå‡½æ•° <code>Z_L</code> ï¼Œåé¢åšè¡¥å……è§£é‡Š</li><li>ç»§ç»­åˆ¤æ–­ <code>nmemb &gt;&gt; Z_L(10)</code> å¦‚æœ å…ƒç´ æ€»æ•° å³ç§» 10ä½ï¼Œä¾ç„¶å¤§äº 0çš„è¯ï¼Œé€‰å–çš„åç§»æ•° å†å‘å³åç§» 1ä½ ä½œä¸º deltaï¼Œ ç„¶å  <code>zend_sort_5(start, start + delta, pivot, pivot + delta, end - siz, cmp, swp);</code> è¿›è¡Œäº¤æ¢ï¼Œå¦åˆ™ æ‰§è¡Œ <code>zend_sort_3(start, pivot, end - siz, cmp, swp);</code> æ‰§è¡Œæ’åº</li><li>ä¸‹é¢å°±æ˜¯æ ‡å‡†çš„å¿«é€Ÿæ’åºçš„æ“ä½œæ€è·¯äº†ï¼Œåªæ˜¯ä¸€èˆ¬æˆ‘ä»¬ä¼šä½¿ç”¨é€’å½’æ¥å¤„ç†ï¼Œä½†æ˜¯é€’å½’ä¼šæ¶ˆè€—ç©ºé—´ï¼Œæ‰€ä»¥ PHPæºç é‡Œé¢é€‰æ‹©äº†éé€’å½’çš„æ–¹å¼</li></ol><h1 id="Z-L"><a href="#Z-L" class="headerlink" title="Z_L"></a>Z_L</h1><p>è¿™é‡Œåœ¨ <code>zend_long.h</code> ä¸­æœ‰å®šä¹‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># define Z_L(i) INT64_C(i)</span><br></pre></td></tr></table></figure><p>ç„¶åç»§ç»­çœ‹ <code>INT64_C</code> </p><h1 id="INI64-C"><a href="#INI64-C" class="headerlink" title="INI64_C"></a>INI64_C</h1><p>è¿™ä¸ªåœ¨ <code>php_stdint.h</code> ä¸­æœ‰å®šä¹‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#ifndef INT64_C</span><br><span class="line"># if SIZEOF_INT &gt;= 8</span><br><span class="line">#  define INT64_C(c) c</span><br><span class="line"># elif SIZEOF_LONG &gt;= 8</span><br><span class="line">#  define INT64_C(c) c ## L</span><br><span class="line"># elif SIZEOF_LONG_LONG &gt;= 8</span><br><span class="line">#  define INT64_C(c) c ## LL</span><br><span class="line"># endif</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><h1 id="zend-sort-3"><a href="#zend-sort-3" class="headerlink" title="zend_sort_3"></a>zend_sort_3</h1><p>è¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯åœ¨ <code>zend_sort.c</code>ä¸­å®ç°çš„ï¼Œä¸»è¦å°±æ˜¯åˆ¤æ–­ï¼Œç„¶åäº¤æ¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static inline void zend_sort_3(void *a, void *b, void *c, compare_func_t cmp, swap_func_t swp) /* &#123;&#123;&#123; */ &#123;</span><br><span class="line">if (!(cmp(a, b) &gt; 0)) &#123;</span><br><span class="line">if (!(cmp(b, c) &gt; 0)) &#123;</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">swp(b, c);</span><br><span class="line">if (cmp(a, b) &gt; 0) &#123;</span><br><span class="line">swp(a, b);</span><br><span class="line">&#125;</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">if (!(cmp(c, b) &gt; 0)) &#123;</span><br><span class="line">swp(a, c);</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">swp(a, b);</span><br><span class="line">if (cmp(b, c) &gt; 0) &#123;</span><br><span class="line">swp(b, c);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç»¼ä¸Šåˆ†æï¼Œphpçš„sortå‡½æ•°åœ¨å…ƒç´ æ•° è¾ƒå°(16ä¸ªåŠä»¥ä¸‹)çš„æ—¶å€™ï¼Œä½¿ç”¨æ’å…¥æ’åºï¼Œå¦åˆ™ä½¿ç”¨éé€’å½’çš„å¿«é€Ÿæ’åºæ¥è¿›è¡Œæ’åºã€‚</p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥PHPç³»åˆ—-å˜é‡åˆ†ç¦»ä¸å¼•ç”¨</title>
      <link href="/posts/47934/"/>
      <url>/posts/47934/</url>
      
        <content type="html"><![CDATA[<p>è¿‘æœŸåœ¨çœ‹é¸Ÿå“¥çš„åšå®¢çš„æ—¶å€™ï¼Œå‘ç°è‡ªå·±å¯¹PHPå†…æ ¸æ–¹é¢è¿˜çœŸæ˜¯ä¸€çªä¸é€šï¼Œå°±ä»¥PHPå˜é‡æ¥è¯´ï¼Œä¸€ç›´éƒ½çŸ¥é“PHPå˜é‡æ˜¯å†™æ—¶å¤åˆ¶ï¼Œä½†æ˜¯çœŸçš„å»åˆ†æè¿™ä¸ªå˜é‡çš„refcountå’Œis_refçš„æ—¶å€™ï¼Œåˆæ˜¯ä¸€è„¸æ‡µé€¼ï¼Œå­¦ä¹ é“è·¯æ¼«æ¼«ï¼Œæˆ’éª„æˆ’èºã€‚</p><a id="more"></a><p>PHP7å’ŒPHP5çš„zvalç»“æ„å…·æœ‰ä¸åŒï¼Œè¿™é‡Œåˆ†å¼€æ¥ç†è§£</p><h1 id="PHP5"><a href="#PHP5" class="headerlink" title="PHP5"></a>PHP5</h1><h2 id="zvalç»“æ„"><a href="#zvalç»“æ„" class="headerlink" title="zvalç»“æ„"></a>zvalç»“æ„</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct _zval_struct &#123;</span><br><span class="line">        /* Variable information */</span><br><span class="line">        zvalue_value value;             /* value */</span><br><span class="line">        zend_uint refcount;</span><br><span class="line">        zend_uchar type;        /* active type */</span><br><span class="line">        zend_uchar is_ref;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå˜é‡åœ¨åˆ›å»ºçš„æ—¶å€™åˆ›å»ºäº†ä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“é‡Œé¢çš„</p><ul><li><strong>value</strong> ä»£è¡¨çš„è¿™ä¸ªå˜é‡çš„å€¼ï¼Œ</li></ul><ul><li><strong>refcount</strong>ç”¨äºæ ‡è¯†æ­¤zvalè¢«å¤šå°‘ä¸ªå˜é‡å¼•ç”¨ï¼Œå½“å€¼ä¸º0çš„æ—¶å€™ä¼šè¢«é”€æ¯</li><li><strong>is_ref</strong>æ ‡è¯†æ˜¯ä¸æ˜¯ç”¨æˆ·ä½¿ç”¨ &amp; çš„å¼ºåˆ¶å¼•ç”¨</li></ul><h3 id="èµ‹å€¼"><a href="#èµ‹å€¼" class="headerlink" title="èµ‹å€¼"></a>èµ‹å€¼</h3><p>æˆ‘ä»¬ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   $val = &apos;tyloafer&apos;;</span><br><span class="line">   $ref = $val;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ ç¬¬ä¸€è¡Œä»£ç åˆ›å»ºäº†ä¸€ä¸ªå˜é‡ï¼Œå¹¶ç”³è¯·äº†8ä¸ªå­—èŠ‚å¤§å°çš„å†…å­˜ï¼Œï¼ˆè¿™é‡Œæš‚ä¸è€ƒè™‘ç»“æ„ä½“çš„å…¶ä»–å ç”¨ï¼‰</p><p>ç¬¬äºŒè¡Œåˆåˆ›å»ºäº†ä¸€ä¸ªå˜é‡ï¼Œä¸ç¬¬ä¸€ä¸ªå˜é‡ $val ç›¸åŒï¼Œåˆ™æ­¤æ—¶æ˜¯å¦åº”è¯¥å ç”¨16ä¸ªå­—èŠ‚å‘¢</p><p>å®é™…æƒ…å†µå¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ ç»“æ„ä½“ä¸­çš„ <strong>refcount</strong> å’Œ <strong>is_ref</strong> çš„ä½œç”¨</p><p>æˆ‘ä»¬ä½¿ç”¨ <code>xdebug_debug_zval</code> è°ƒè¯•ä¸€ä¸‹å˜é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$val = &apos;tyloafer&apos;</span><br><span class="line">$val : val: (refcount=1, is_ref=0)=&apos;tyloafer&apos;</span><br><span class="line"></span><br><span class="line">$ref = $val</span><br><span class="line">$val : val: (refcount=2, is_ref=0)=&apos;tyloafer&apos;</span><br><span class="line">$ref : ref: (refcount=2, is_ref=0)=&apos;tyloafer&apos;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¹¶æ²¡æœ‰æ–°ç”³è¯·ä¸€å—å†…å­˜ï¼Œå¤åˆ¶ç»“æ„ä½“ï¼Œè€Œæ˜¯å°†åŸæœ‰çš„refcount è¿›è¡Œäº† +1 æ“ä½œï¼Œé‚£å¦‚æœæ­¤æ—¶å¯¹å˜é‡è¿›è¡Œunsetæ“ä½œï¼Œå…¶å®å°±æ˜¯å¯¹refcount è¿›è¡Œ -1 æ“ä½œäº†</p><h3 id="å¼•ç”¨èµ‹å€¼"><a href="#å¼•ç”¨èµ‹å€¼" class="headerlink" title="å¼•ç”¨èµ‹å€¼"></a>å¼•ç”¨èµ‹å€¼</h3><p>åœ¨PHPé‡Œé¢ï¼Œè¿˜æœ‰ä¸€ç§èµ‹å€¼æ–¹å¼ï¼Œå³å¼•ç”¨èµ‹å€¼ï¼Œæˆ‘ä»¬ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   $val = &apos;tyloafer&apos;;</span><br><span class="line">   $ref = &amp;$val;</span><br></pre></td></tr></table></figure><p>è°ƒè¯•å˜é‡ç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$val = &apos;tyloafer&apos;</span><br><span class="line">$val : val: (refcount=1, is_ref=0)=&apos;tyloafer&apos;</span><br><span class="line"></span><br><span class="line">$ref = &amp;$val</span><br><span class="line">$val : val: (refcount=2, is_ref=1)=&apos;tyloafer&apos;</span><br><span class="line">$ref : ref: (refcount=2, is_ref=1)=&apos;tyloafer&apos;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸ä»… <strong>refcount</strong> è¿›è¡Œäº† +1 æ“ä½œï¼Œ <strong>is_ref</strong> ä¹Ÿè¿›è¡Œäº† +1 æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº† <strong>&amp;</strong> æ“ä½œ </p><p>é’ˆå¯¹äº èµ‹å€¼ æ“ä½œï¼Œval å’Œ ref ä¸¤ä¸ªå˜é‡å‡æ˜¯æŒ‡å‘åŒä¸€ä¸ª zval ç»“æ„ä½“ï¼Œå½“æˆ‘ä»¬å¯¹ ref è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œè¿™æ—¶å€™ä¸¤ä¸ªå˜é‡çš„å€¼å°±ä¼šä¸ä¸€æ ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   $val = &apos;tyloafer&apos;;</span><br><span class="line">   $ref = $val;</span><br><span class="line">   $ref = 1;</span><br></pre></td></tr></table></figure><p>ä»è€Œå¯ä»¥æ¨æ–­ï¼Œå½“æ‰§è¡Œåˆ° <code>$ref = 1</code> çš„æ—¶å€™ï¼Œ ref å’Œ val ä¸¤ä¸ªå˜é‡æŒ‡å‘çš„å°±ä¸æ˜¯åŒä¸€ä¸ª zval ç»“æ„ä½“äº†ï¼Œæ­¤æ—¶ debug ç»“æœå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$val = &apos;tyloafer&apos;</span><br><span class="line">$val : val: (refcount=1, is_ref=0)=&apos;tyloafer&apos;</span><br><span class="line"></span><br><span class="line">$ref = $val</span><br><span class="line">$val : val: (refcount=1, is_ref=0)=&apos;tyloafer&apos;</span><br><span class="line">$ref : ref: (refcount=1, is_ref=0)=1</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¿‡ç¨‹å°±è¢«ç§°ä½œ å†™æ—¶å¤åˆ¶ (Copy On Write)</p><h2 id="å†™æ—¶å¤åˆ¶-Copy-On-Write"><a href="#å†™æ—¶å¤åˆ¶-Copy-On-Write" class="headerlink" title="å†™æ—¶å¤åˆ¶(Copy On Write)"></a>å†™æ—¶å¤åˆ¶(Copy On Write)</h2><p>PHPåœ¨ä¿®æ”¹ä¸€ä¸ªå˜é‡ä»¥å‰ï¼Œä¼šé¦–å…ˆæŸ¥çœ‹è¿™ä¸ªå˜é‡çš„refcountï¼Œå¦‚æœrefcountå¤§äº1ï¼ŒPHPå°±ä¼šæ‰§è¡Œä¸€ä¸ªåˆ†ç¦»çš„ä¾‹ç¨‹ã€‚è¿™ä¸ªæœºåˆ¶å°±æ˜¯æ‰€è°“çš„copy on write(å†™æ—¶å¤åˆ¶)ã€‚</p><p>å…¶ä¸­èµ‹å€¼å‡½æ•°å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">static inline zval* zend_assign_to_variable(zval **variable_ptr_ptr, zval *value TSRMLS_DC)</span><br><span class="line">&#123;</span><br><span class="line">zval *variable_ptr = *variable_ptr_ptr;</span><br><span class="line">zval garbage;</span><br><span class="line"></span><br><span class="line">if (Z_TYPE_P(variable_ptr) == IS_OBJECT &amp;&amp;</span><br><span class="line">    UNEXPECTED(Z_OBJ_HANDLER_P(variable_ptr, set) != NULL)) &#123;</span><br><span class="line">Z_OBJ_HANDLER_P(variable_ptr, set)(variable_ptr_ptr, value TSRMLS_CC);</span><br><span class="line">return variable_ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> if (EXPECTED(!PZVAL_IS_REF(variable_ptr))) &#123;  // éå¼•ç”¨èµ‹å€¼é€»è¾‘</span><br><span class="line">if (Z_REFCOUNT_P(variable_ptr)==1) &#123;</span><br><span class="line">if (UNEXPECTED(variable_ptr == value)) &#123;</span><br><span class="line">return variable_ptr;</span><br><span class="line">&#125; else if (EXPECTED(!PZVAL_IS_REF(value))) &#123;</span><br><span class="line">Z_ADDREF_P(value);</span><br><span class="line">*variable_ptr_ptr = value;</span><br><span class="line">ZEND_ASSERT(variable_ptr != &amp;EG(uninitialized_zval));</span><br><span class="line">GC_REMOVE_ZVAL_FROM_BUFFER(variable_ptr);</span><br><span class="line">zval_dtor(variable_ptr);</span><br><span class="line">efree(variable_ptr);</span><br><span class="line">return value;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">goto copy_value;</span><br><span class="line">&#125;</span><br><span class="line">&#125; else &#123; /* we need to split */  // è¿™é‡Œæ˜¯å¼•ç”¨çš„ç›¸å…³èµ‹å€¼é€»è¾‘</span><br><span class="line">Z_DELREF_P(variable_ptr);</span><br><span class="line">GC_ZVAL_CHECK_POSSIBLE_ROOT(variable_ptr);</span><br><span class="line">if (PZVAL_IS_REF(value)) &#123;</span><br><span class="line">ALLOC_ZVAL(variable_ptr);</span><br><span class="line">*variable_ptr_ptr = variable_ptr;</span><br><span class="line">INIT_PZVAL_COPY(variable_ptr, value);</span><br><span class="line">zval_copy_ctor(variable_ptr);</span><br><span class="line">return variable_ptr;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">*variable_ptr_ptr = value;</span><br><span class="line">Z_ADDREF_P(value);</span><br><span class="line">return value;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> &#125; else &#123;</span><br><span class="line">if (EXPECTED(variable_ptr != value)) &#123;</span><br><span class="line">copy_value:</span><br><span class="line">if (EXPECTED(Z_TYPE_P(variable_ptr) &lt;= IS_BOOL)) &#123;</span><br><span class="line">/* nothing to destroy */</span><br><span class="line">ZVAL_COPY_VALUE(variable_ptr, value);</span><br><span class="line">zendi_zval_copy_ctor(*variable_ptr);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">ZVAL_COPY_VALUE(&amp;garbage, variable_ptr);</span><br><span class="line">ZVAL_COPY_VALUE(variable_ptr, value);</span><br><span class="line">zendi_zval_copy_ctor(*variable_ptr);</span><br><span class="line">_zval_dtor_func(&amp;garbage ZEND_FILE_LINE_CC);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return variable_ptr;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>EXPECTED(var)</code> å°±ç›¸å½“äº <code>val == 1</code></p><p>æˆ‘ä»¬æ ¹æ®è¿™ä¸ªç‰¹æ€§ï¼Œåšä¸€ä¸‹ ä¸‹é¢çš„ä»£ç çš„åˆ†æ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $val = &apos;tyloafer&apos;;</span><br><span class="line">    $ref = &amp;$val;</span><br><span class="line">    $copy = $val;</span><br><span class="line">    $copy = &apos;1111&apos;;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä»£ç æ‰§è¡Œåˆ°ç¬¬ä¸€è¡Œ <code>$val = &#39;tyloafer&#39;;</code> ï¼Œ è¿™æ—¶å€™ PHPä¼šåˆ›å»ºä¸€ä¸ªzvalç»“æ„ä½“ï¼Œæ­¤æ—¶ä»–çš„å€¼åº”è¯¥æ˜¯ </p><blockquote><p> refcount = 1, is_ref = 0</p></blockquote><p>æ‰§è¡Œåˆ°ç¬¬äºŒè¡Œçš„æ—¶å€™ï¼Œæ ¹æ®ä¸Šé¢ç»“æœå¯ä»¥çŸ¥é“ </p><blockquote><p>$val : val: (refcount=2, is_ref=1)=â€™tyloaferâ€™<br>$ref : ref: (refcount=2, is_ref=1)=â€™tyloaferâ€™</p></blockquote><p>æ¥ä¸‹æ¥æ‰§è¡Œç¬¬ä¸‰è¡Œï¼Œæ­¤æ—¶val çš„ refcount = 2ï¼Œ is_ref = 1ï¼Œ æ»¡è¶³äº†<strong>å†™æ—¶å¤åˆ¶</strong>çš„æ¡ä»¶ï¼Œ ä½†æ˜¯è¿™é‡Œæ˜¯ä½¿ç”¨val çš„å˜é‡ï¼Œèµ‹å€¼ç»™æ–°çš„å˜é‡ï¼Œæ˜¯å¦ä¼š è§¦å‘ <strong>COW</strong> å‘¢ï¼Œå…¶å®æ˜¯ä¼šè§¦å‘çš„ï¼Œæˆ‘ä»¬ç…§æ­¤æ€è·¯å¤„ç†ä¸‹å»çš„è¯</p><p>å¦‚æœè¿™ä¸ªè„šæœ¬å°± <code>$copy = $val;</code> ä¸€è¡Œçš„è¯ï¼Œ è¿™ä¸¤ä¸ªå˜é‡ val copy æ˜¯ä¼šå…±ç”¨ä¸€ä¸ª ç»“æ„ä½“çš„ï¼Œä½†æ˜¯æ­¤æ—¶ val ç»“æ„æ»¡è¶³äº† åˆ†ç¦»çš„æ¡ä»¶ï¼Œæ‰€ä»¥ è¿™ä¸¤ä¸ªå˜é‡å°±éœ€è¦è¿›è¡Œåˆ†ç¦»ï¼Œä¹Ÿå°±æ˜¯ copy ä¸èƒ½å…±ç”¨ val çš„ç»“æ„ä½“ åˆ†ç¦»å‡ºå»ï¼Œä½†æ˜¯åŸå…ˆçš„ val å’Œ ref æ²¡æœ‰ä¿®æ”¹ï¼Œ æ‰€ä»¥ä¸ä¼šè§¦å‘åˆ†ç¦»çš„æ¡ä»¶ï¼Œæ‰€ä»¥ æ­¤æ—¶çš„ç»“æœå°±æ˜¯</p><blockquote><p>$val : val: (refcount=2, is_ref=1)=â€™tyloaferâ€™<br>$ref : ref: (refcount=2, is_ref=1)=â€™tyloaferâ€™<br>$copy : copy: (refcount=1, is_ref=0)=â€™tyloaferâ€™</p></blockquote><p>æœ€åä¸€æ­¥ï¼Œ <code>$copy = 111;</code>  ï¼Œæ­¤æ—¶çš„copy å·²ç»åˆ†ç¦»å‡ºæ¥äº†ï¼Œæ˜¯ä¸ªç‹¬ç«‹çš„ç»“æ„ä½“ï¼Œä¹Ÿä¸æ»¡è¶³åˆ†ç¦»æ¡ä»¶ï¼Œç›´æ¥ä¿®æ”¹ ç»“æ„ä½“é‡Œé¢çš„ valueå³å¯</p><blockquote><p>$copy : copy: (refcount=1, is_ref=0)=â€™1111â€™<br>$val : val: (refcount=2, is_ref=1)=â€™tyloaferâ€™</p></blockquote><h3 id="ç»å…¸æ€§èƒ½é—®é¢˜"><a href="#ç»å…¸æ€§èƒ½é—®é¢˜" class="headerlink" title="ç»å…¸æ€§èƒ½é—®é¢˜"></a>ç»å…¸æ€§èƒ½é—®é¢˜</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$array = range(1, 100000);</span><br><span class="line">function dummy($array) &#123;&#125;</span><br><span class="line"></span><br><span class="line">function test(&amp;$arr)</span><br><span class="line">&#123;</span><br><span class="line">    dummy($arr);</span><br><span class="line">&#125;</span><br><span class="line">function test1($arr)</span><br><span class="line">&#123;</span><br><span class="line">    dummy($arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$array = range(1, 100000);</span><br><span class="line">$start = microtime(true);</span><br><span class="line">$i     = 0;</span><br><span class="line">while ($i++ &lt; 100) &#123;</span><br><span class="line">    test1($array);</span><br><span class="line">&#125;</span><br><span class="line">printf(&quot;Used %s s\n&quot;, microtime(true) - $start);</span><br><span class="line"></span><br><span class="line">$start = microtime(true);</span><br><span class="line">$i     = 0;</span><br><span class="line">while ($i++ &lt; 100) &#123;</span><br><span class="line">    test($array);</span><br><span class="line">&#125;</span><br><span class="line">printf(&quot;Used %s s\n&quot;, microtime(true) - $start);</span><br></pre></td></tr></table></figure><p>é¸Ÿå“¥çš„åšå®¢é‡Œï¼Œé’ˆå¯¹è¿™ä¸ªå†™ä¸ªä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ä¾‹å­ï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰ç”¨çš„æœ€å¤šçš„åœºæ™¯è¿˜æ˜¯ å‡½æ•°å¥—å‡½æ•° çš„åœºæ™¯ï¼Œæ‰€ä»¥è‡ªå·±ä¿®æ”¹äº†ä¸€ä¸‹ æ¡ˆä¾‹</p><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¼•ç”¨ä¼ å€¼å…±æ¶ˆè€—ï¼š 1.7663018703461 s</span><br><span class="line">ä¼ å€¼å…±æ¶ˆè€—ï¼š 0.00076103210449219 s</span><br></pre></td></tr></table></figure><p>æ ¹æ® <code>zend_assign_to_variable</code> çš„å‡½æ•°é€»è¾‘åŠä¸Šé¢çš„åˆ†æï¼Œå°±å¯ä»¥çœ‹å‡ºæ¥æ˜¯å› ä¸ºå¤å‘äº† åˆ†ç¦» çš„æ“ä½œï¼Œæ‰€ä»¥ä¼š æ‹·è´ $i æ¬¡æ•°ç»„ï¼Œè¿™ä¸ªé—®é¢˜åœ¨PHP7çš„æ—¶å€™å·²ç»åšäº†ä¿®æ”¹ã€‚</p><h1 id="PHP7"><a href="#PHP7" class="headerlink" title="PHP7"></a>PHP7</h1><h2 id="zvalç»“æ„-1"><a href="#zvalç»“æ„-1" class="headerlink" title="zvalç»“æ„"></a>zvalç»“æ„</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">struct _zval_struct &#123;</span><br><span class="line">     union &#123;</span><br><span class="line">          zend_long         lval;             /* long value */</span><br><span class="line">          double            dval;             /* double value */</span><br><span class="line">          zend_refcounted  *counted;</span><br><span class="line">          zend_string      *str;</span><br><span class="line">          zend_array       *arr;</span><br><span class="line">          zend_object      *obj;</span><br><span class="line">          zend_resource    *res;</span><br><span class="line">          zend_reference   *ref;</span><br><span class="line">          zend_ast_ref     *ast;</span><br><span class="line">          zval             *zv;</span><br><span class="line">          void             *ptr;</span><br><span class="line">          zend_class_entry *ce;</span><br><span class="line">          zend_function    *func;</span><br><span class="line">          struct &#123;</span><br><span class="line">               uint32_t w1;</span><br><span class="line">               uint32_t w2;</span><br><span class="line">          &#125; ww;</span><br><span class="line">     &#125; value;</span><br><span class="line">    union &#123;</span><br><span class="line">        struct &#123;</span><br><span class="line">            ZEND_ENDIAN_LOHI_4(</span><br><span class="line">                zend_uchar    type,         /* active type */</span><br><span class="line">                zend_uchar    type_flags,</span><br><span class="line">                zend_uchar    const_flags,</span><br><span class="line">                zend_uchar    reserved)     /* call info for EX(This) */</span><br><span class="line">        &#125; v;</span><br><span class="line">        uint32_t type_info;</span><br><span class="line">    &#125; u1;</span><br><span class="line">    union &#123;</span><br><span class="line">        uint32_t     var_flags;</span><br><span class="line">        uint32_t     next;                 /* hash collision chain */</span><br><span class="line">        uint32_t     cache_slot;           /* literal cache slot */</span><br><span class="line">        uint32_t     lineno;               /* line number (for ast nodes) */</span><br><span class="line">        uint32_t     num_args;             /* arguments number for EX(This) */</span><br><span class="line">        uint32_t     fe_pos;               /* foreach position */</span><br><span class="line">        uint32_t     fe_iter_idx;          /* foreach iterator index */</span><br><span class="line">    &#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œå¼•ç”¨è®¡æ•°éƒ¨åˆ†ä¿å­˜åœ¨ <code>zend_refcounted_h</code> çš„ç»“æ„ä½“ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _zend_refcounted_h &#123;</span><br><span class="line">    uint32_t         refcount;          /* reference counter 32-bit */</span><br><span class="line">    union &#123;</span><br><span class="line">        struct &#123;</span><br><span class="line">            ZEND_ENDIAN_LOHI_3(</span><br><span class="line">                zend_uchar    type,</span><br><span class="line">                zend_uchar    flags,    /* used for strings &amp; objects */</span><br><span class="line">                uint16_t      gc_info)  /* keeps GC root number (or 0) and color */</span><br><span class="line">        &#125; v;</span><br><span class="line">        uint32_t type_info;</span><br><span class="line">    &#125; u;</span><br><span class="line">&#125; zend_refcounted_h;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå³å¦‚å›¾æ‰€ç¤º</p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/zval1.png" alt="https://github-1253518569.cos.ap-shanghai.myqcloud.com/zval1.png"></p><h2 id="å†™æ—¶æ”¹å˜-Change-On-Write"><a href="#å†™æ—¶æ”¹å˜-Change-On-Write" class="headerlink" title="å†™æ—¶æ”¹å˜(Change On Write)"></a>å†™æ—¶æ”¹å˜(Change On Write)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$val = &quot;laruence&quot;;</span><br><span class="line">$ref = &amp;$val;</span><br><span class="line">$copy = $val;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé¢ä»£ç ä¸ºä¾‹</p><p>å½“ä»£ç æ‰§è¡Œåˆ°ç¬¬äºŒè¡Œ <code>$ref = &amp;$val;</code> çš„æ—¶å€™ï¼Œ ç”Ÿæˆä¸€ä¸ª IS_REFERNCE ç±»å‹ï¼Œç„¶åå› ä¸ºæ­¤æ—¶æœ‰ä¿©ä¸ªå˜é‡å¼•ç”¨å®ƒæ‰€ä»¥zend_referenceè¿™ä¸ªç»“æ„çš„å¼•ç”¨è®¡æ•°zval.value.ref-&gt;gc.refcountä¸º2.</p><p>å½“ä»£ç æ‰§è¡Œåˆ° <code>$copy = $val;</code> çš„æ—¶å€™ï¼Œ å‘ç° <code>$val</code> æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œ äºæ˜¯ï¼Œç›´æ¥è®© <code>$copy</code> æŒ‡å‘çš„æ˜¯zval.value.ref-&gt;val, ä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²å€¼ä¸ºlaruenceçš„zval, ç„¶åæŠŠzvalçš„å¼•ç”¨è®¡æ•°+1, ä¹Ÿå°±æ˜¯zval.value.ref-&gt;val.value.str.gc.refcountä¸º2. å¹¶æ²¡æœ‰äº§ç”Ÿå¤åˆ¶.</p><p>xdebugç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$val = &apos;laruence&apos;</span><br><span class="line">$val : val: (refcount=0, is_ref=0)=&apos;laruence&apos;</span><br><span class="line">$ref = &amp;$val</span><br><span class="line">$val : val: (refcount=2, is_ref=1)=&apos;laruence&apos;</span><br><span class="line">$ref : ref: (refcount=2, is_ref=1)=&apos;laruence&apos;</span><br><span class="line">$copy = $val</span><br><span class="line">$val : val: (refcount=2, is_ref=1)=&apos;laruence&apos;</span><br><span class="line">$ref : ref: (refcount=2, is_ref=1)=&apos;laruence&apos;</span><br><span class="line">$copy : copy: (refcount=0, is_ref=0)=&apos;laruence&apos;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPå®ç°åŸºäºSwooleçš„MySQLè¿æ¥æ± </title>
      <link href="/posts/55187/"/>
      <url>/posts/55187/</url>
      
        <content type="html"><![CDATA[<p>å¯¹äºå…±äº«èµ„æºï¼Œæœ‰ä¸€ä¸ªå¾ˆè‘—åçš„è®¾è®¡æ¨¡å¼ï¼šèµ„æºæ± ï¼ˆResource Poolï¼‰ã€‚è¯¥æ¨¡å¼æ­£æ˜¯ä¸ºäº†è§£å†³èµ„æºçš„é¢‘ç¹åˆ†é…ï¹‘é‡Šæ”¾æ‰€é€ æˆçš„é—®é¢˜ã€‚æ•°æ®åº“è¿æ¥æ± çš„åŸºæœ¬æ€æƒ³å°±æ˜¯ä¸ºæ•°æ®åº“è¿æ¥å»ºç«‹ä¸€ä¸ªâ€œæ± â€å­ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä»â€œæ± å­â€ä¸­è·å–èµ„æºï¼Œç”¨å®Œåå°†è¿æ¥æ”¾å›â€œæ± å­â€ï¼Œå‡å°‘äº†æ•°æ®åº“è¿æ¥å»ºç«‹ä¸é‡Šæ”¾é€ æˆçš„æŸè€—ã€‚</p><a id="more"></a><p>è€Œå¯¹äºPHPè€Œè¨€ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚è¿‡æ¥éƒ½æ˜¯ç”±php-fpmè°ƒèµ·æ¥ä¸€ä¸ªcgiæ¥å¤„ç†ï¼Œå¤„ç†å®Œåå°±ä¼šè¢«é‡Šæ”¾ï¼Œæ‰€ä»¥å¹¶æ²¡åŠæ³•åœ¨ä»£ç ä¸­å®ç°è¿æ¥æ± çš„ï¼Œä½†æ˜¯ç”±è¿è¡Œæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç„¶è€Œç„¶çš„æ¨æƒ³ï¼Œæ—¢ç„¶php-fpmæ˜¯å¸¸é©»å†…å­˜çš„ï¼Œé‚£æˆ‘ä»¬å°†æ•°æ®åº“è¿æ¥äº¤ç»™php-fpmæ‰˜ç®¡ï¼Œä¹Ÿå°±å®ç°äº†ç†è®ºä¸Šçš„æ•°æ®åº“è¿æ¥æ± ï¼Œè€Œè¿™ç§å®ç°æ–¹å¼ä¹Ÿå°±æ˜¯MySQLçš„<strong>pconnect</strong>çš„å®ç°æ–¹å¼ï¼Œè€Œä¸”ç»æµ‹è¯•ï¼Œæ•ˆæœå¹¶æ²¡æœ‰æ˜¾è‘—çš„æå‡ã€‚é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥ä¾¿å¯ä»¥è€ƒè™‘åŸºäº<strong>Swoole</strong>çš„å¸¸é©»å†…å­˜çš„ç‰¹æ€§æ¥å¸®å¿™å®ç°äº†</p><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><ol><li>é¦–å…ˆåŸºäºSwooleçš„channelå®ç°ä¸€ä¸ª<strong>å†…å­˜é˜Ÿåˆ—</strong> <strong>quene</strong>ï¼Œï¼ˆä¹Ÿå¯ä»¥é€šè¿‡phpçš„å…±äº«å†…å­˜å®ç°ï¼Œè¿™é‡Œä¸è®¨è®ºè¿™ç§æ–¹å¼ï¼‰ï¼Œç”¨äºå­˜æ”¾MySQLè¿æ¥çš„çº¿ç¨‹idï¼Œ<strong>thread_id</strong></li><li>å»ºç«‹ä¸€å®šæ•°é‡çš„MySQLè¿æ¥å­˜æ”¾åœ¨æ•°ç»„ä¸­ï¼Œç„¶åå°† <strong>thread_id</strong>ï¼ˆmysqli::$thread_idï¼‰æ¨è¿›<strong>å†…å­˜é˜Ÿåˆ—</strong> <strong>quene</strong>,</li><li>æ¯ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œä»<strong>quene</strong>ä¸­ pop å‡ºä¸€ä¸ª <strong>thread_id</strong>ï¼Œ æ ¹æ®<strong>thread_id</strong>æ‰¾åˆ°å¯¹åº”æ•°ç»„ä¸­å¯¹åº”çš„æ•°æ®åº“è¿æ¥</li><li>è¯·æ±‚ç»“æŸåï¼Œå°†<strong>thread_id</strong>å†pushè¿›<strong>quene</strong></li></ol><h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><h2 id="æ•°æ®åº“è¿æ¥ç®¡ç†è€…"><a href="#æ•°æ®åº“è¿æ¥ç®¡ç†è€…" class="headerlink" title="æ•°æ®åº“è¿æ¥ç®¡ç†è€…"></a>æ•°æ®åº“è¿æ¥ç®¡ç†è€…</h2><blockquote><p>è¿™ä¸ªç±»æ˜¯ç”¨æ¥ç®¡ç†è¿æ¥çš„ï¼Œå¢åŠ å’Œåˆ é™¤ä»¥åŠè·å–é“¾æ¥ä½¿ç”¨</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">class MysqlConnections &#123;</span><br><span class="line">    private $config = [</span><br><span class="line">        &apos;host&apos; =&gt; &apos;127.0.0.1&apos;,</span><br><span class="line">        &apos;username&apos; =&gt; &apos;root&apos;,</span><br><span class="line">        &apos;password&apos; =&gt; &apos;ifind@13579&apos;,</span><br><span class="line">        &apos;dbname&apos; =&gt; &apos;test&apos;,</span><br><span class="line">        &apos;charset&apos; =&gt; &apos;utf8&apos;,</span><br><span class="line">    ];</span><br><span class="line">    private $connectionsNum = 0;</span><br><span class="line"></span><br><span class="line">    private $connections = [];</span><br><span class="line">    function __construct($config = []) &#123;</span><br><span class="line">        $this-&gt;config = array_merge($this-&gt;config, $config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å¢åŠ ä¸€ä¸ªmysqlè¿æ¥åˆ°è¿æ¥æ± </span><br><span class="line">     */</span><br><span class="line">    public function addConnection()</span><br><span class="line">    &#123;</span><br><span class="line">        $mysql = new Mysqli($this-&gt;config[&apos;host&apos;], $this-&gt;config[&apos;username&apos;], $this-&gt;config[&apos;password&apos;], $this-&gt;config[&apos;dbname&apos;]);</span><br><span class="line">        $this-&gt;connections[$mysql-&gt;thread_id] = $mysql;</span><br><span class="line">        echo &apos;add &apos; . $mysql-&gt;thread_id . &apos; into pool &apos; . PHP_EOL;</span><br><span class="line">        $this-&gt;connectionsNum ++;</span><br><span class="line">        return $mysql-&gt;thread_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getConnection($id = 0)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($id == 0) &#123;</span><br><span class="line">            $id = $this-&gt;addConnection();</span><br><span class="line">        &#125;</span><br><span class="line">        return $this-&gt;connections[$id];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function releaseConnection($id)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;connectionsNum--;</span><br><span class="line">        unset($this-&gt;connections[$id]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($name)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($name == &apos;connectionsNum&apos;) &#123;</span><br><span class="line">            return $this-&gt;connectionsNum;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å†…å­˜é˜Ÿåˆ—"><a href="#å†…å­˜é˜Ÿåˆ—" class="headerlink" title="å†…å­˜é˜Ÿåˆ—"></a>å†…å­˜é˜Ÿåˆ—</h2><blockquote><p>è¿™é‡Œæ˜¯ä»¥æ•°æ®åº“è¿æ¥å±æ€§çš„thread_id ç»„æˆçš„å†…å­˜é˜Ÿåˆ—</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">class Quene &#123;</span><br><span class="line">    private $length; // é˜Ÿé•¿</span><br><span class="line">    private $size;</span><br><span class="line"></span><br><span class="line">    private $chan;</span><br><span class="line">    /**</span><br><span class="line">     * æ„é€ å‡½æ•°</span><br><span class="line">     */</span><br><span class="line">    public function __construct($size = 64 * 1024) </span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;chan = new \Swoole\Channel($size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å…¥é˜Ÿæ“ä½œ</span><br><span class="line">     * @param  [type] $id [description]</span><br><span class="line">     * @return [type]     [description]</span><br><span class="line">     */</span><br><span class="line">    public function push($id)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;length ++;</span><br><span class="line">        $this-&gt;chan-&gt;push($id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * å‡ºé˜Ÿæ“ä½œ</span><br><span class="line">     * @return [type] [description]</span><br><span class="line">     */</span><br><span class="line">    public function pop()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;length --;</span><br><span class="line">        $id = $this-&gt;chanpop();</span><br><span class="line">        return $id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($name)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($name == &apos;length&apos;) &#123;</span><br><span class="line">            return $this-&gt;length;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®åº“è¿æ¥æ± "><a href="#æ•°æ®åº“è¿æ¥æ± " class="headerlink" title="æ•°æ®åº“è¿æ¥æ± "></a>æ•°æ®åº“è¿æ¥æ± </h2><blockquote><p>ç»“åˆä¸Šé¢çš„è¿æ¥ç®¡ç†è€…å’Œé˜Ÿåˆ—ï¼Œå®ç°å¯¹è¿æ¥çš„åˆ†å‘å’Œå½’è¿˜</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">class DbPool &#123;</span><br><span class="line">    private $max; // æœ€å¤§çš„mysqlè¿æ¥æ•°</span><br><span class="line">    private $min = 0; // å»ºç«‹æœ€å°çš„mysqlè¿æ¥æ•°</span><br><span class="line">    private $connections;</span><br><span class="line">    private $quene;</span><br><span class="line"></span><br><span class="line">    public function __construct($max, $min = 0)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!empty($max)) &#123;</span><br><span class="line">            $this-&gt;max = $max;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new Exception(&apos;please set max connnections&apos;, &apos;-1&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">        $this-&gt;min = $min;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function setConnection(MysqlConnections $connections)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;connections = $connections;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function setQuene(Quene $quene)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;quene = $quene;</span><br><span class="line">        $this-&gt;initQuene();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function initQuene($min = 0, $max = 0)</span><br><span class="line">    &#123;</span><br><span class="line">        for ($i = 0; $i &lt; $this-&gt;min; $i++) &#123;</span><br><span class="line">            $this-&gt;quene-&gt;push($this-&gt;connections-&gt;addConnection());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function obtain()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($this-&gt;connections-&gt;connectionsNum &gt;= $this-&gt;max) &#123;</span><br><span class="line">            // è¶…å‡ºé“¾æ¥æœ€å¤§é™åˆ¶ï¼Œç­‰å¾…mysqlé“¾æ¥é‡Šæ”¾</span><br><span class="line">            $id = !$this-&gt;quene-&gt;pop();</span><br><span class="line">            while (!$id) &#123;</span><br><span class="line">                usleep(200000);</span><br><span class="line">                $id = $this-&gt;quene-&gt;pop();</span><br><span class="line">            &#125;</span><br><span class="line">            return $this-&gt;connections-&gt;getConnection($id);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $id = $this-&gt;quene-&gt;pop();</span><br><span class="line">            return $this-&gt;connections-&gt;getConnection($id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function restitute(Mysqli $db)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &apos;restitute thread_id : &apos; . $db-&gt;thread_id . PHP_EOL;</span><br><span class="line">        $this-&gt;quene-&gt;push($db-&gt;thread_id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Swoole-Http-Server"><a href="#Swoole-Http-Server" class="headerlink" title="Swoole Http Server"></a>Swoole Http Server</h2><blockquote><p>åŸºäºswooleå¼€å¯ä¸€ä¸ªhttp serverï¼Œè·å–ç›¸åº”çš„æ•°æ®åº“è¿æ¥ï¼Œå¹¶ç›¸åº”</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class SwooleServer</span><br><span class="line">&#123;</span><br><span class="line">    private $config = [</span><br><span class="line">        &apos;Connections&apos; =&gt; [</span><br><span class="line">            &apos;min&apos; =&gt; 5,</span><br><span class="line">            &apos;max&apos; =&gt; 10,</span><br><span class="line">        ],</span><br><span class="line">        &apos;Db&apos; =&gt; [</span><br><span class="line">            &apos;host&apos; =&gt; &apos;127.0.0.1&apos;,</span><br><span class="line">            &apos;username&apos; =&gt; &apos;test&apos;,</span><br><span class="line">            &apos;password&apos; =&gt; &apos;123456&apos;,</span><br><span class="line">            &apos;dbname&apos; =&gt; &apos;test&apos;,</span><br><span class="line">            &apos;charset&apos; =&gt; &apos;utf8&apos;,</span><br><span class="line">        ],</span><br><span class="line">        &apos;Swoole&apos; =&gt; [</span><br><span class="line">            &apos;enable_static_handler&apos; =&gt; true,</span><br><span class="line">            &apos;document_root&apos; =&gt; &quot;/home/lixy/basic/web/&quot;,</span><br><span class="line">            &apos;worker_num&apos; =&gt; 5,</span><br><span class="line">            &apos;task_worker_num&apos; =&gt; 5,</span><br><span class="line">            &apos;log_level&apos; =&gt; 3,</span><br><span class="line">        ],</span><br><span class="line">        &apos;Channel&apos; =&gt; [</span><br><span class="line">            &apos;size&apos; =&gt; 256 * 1024,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line">    private $db_pool;   // mysqlé“¾æ¥å†…å­˜é˜Ÿåˆ—</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;swoole = new \Swoole\Http\Server(&apos;0.0.0.0&apos;, 9502);</span><br><span class="line">        $this-&gt;swoole-&gt;set($this-&gt;config[&apos;Swoole&apos;]);</span><br><span class="line">        $this-&gt;swoole-&gt;on(&apos;task&apos;, [$this, &apos;task&apos;]);</span><br><span class="line">        $this-&gt;swoole-&gt;on(&apos;finish&apos;, [$this, &apos;finish&apos;]);</span><br><span class="line">        $this-&gt;swoole-&gt;on(&apos;request&apos;, [$this, &apos;request&apos;]);</span><br><span class="line">        $this-&gt;getDbPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getDbPool()</span><br><span class="line">    &#123;</span><br><span class="line">        $connections = new MysqlConnections($this-&gt;config[&apos;Db&apos;]);</span><br><span class="line">        $quene = new Quene();</span><br><span class="line">        $this-&gt;db_pool = new DbPool($this-&gt;config[&apos;Connections&apos;][&apos;max&apos;], $this-&gt;config[&apos;Connections&apos;][&apos;min&apos;]);</span><br><span class="line">        $this-&gt;db_pool-&gt;setConnection($connections);</span><br><span class="line">        $this-&gt;db_pool-&gt;setQuene($quene);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($name, $args)</span><br><span class="line">    &#123;</span><br><span class="line">        return call_user_func_array([$this-&gt;swoole, $name], $args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * onrequestäº‹ä»¶</span><br><span class="line">     * @param  [type] $request  è¯·æ±‚å¯¹è±¡</span><br><span class="line">     * @param  [type] $response ç›¸åº”å¯¹è±¡</span><br><span class="line">     * @return [type]</span><br><span class="line">     */</span><br><span class="line">    public function request($request, $response)</span><br><span class="line">    &#123;</span><br><span class="line">        $db = $this-&gt;db_pool-&gt;obtain();</span><br><span class="line">        echo &apos;get thread id : &apos; . $db-&gt;thread_id . PHP_EOL;</span><br><span class="line">        $sql = &apos;select * from test&apos;;</span><br><span class="line">        $result = $db-&gt;query($sql);</span><br><span class="line">        $this-&gt;db_pool-&gt;restitute($db);</span><br><span class="line">        $response-&gt;end(&apos;hello, response from swoole server&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function task($serv, $task_id, $from_id, $data)</span><br><span class="line">    &#123;</span><br><span class="line">        echo $task_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function finish($serv, $task_id, $data)</span><br><span class="line">    &#123;</span><br><span class="line">        echo $task_id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$swoole_index = new SwooleServer();</span><br><span class="line">$swoole_index-&gt;start();</span><br></pre></td></tr></table></figure><h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><blockquote><p>ab -n 10 -c 5 <a href="http://127.0.0.1:9502/" target="_blank" rel="noopener">http://127.0.0.1:9502/</a></p></blockquote><p>ç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">add 6879 into pool </span><br><span class="line">add 6880 into pool </span><br><span class="line">add 6881 into pool </span><br><span class="line">add 6882 into pool </span><br><span class="line">add 6883 into pool </span><br><span class="line"></span><br><span class="line">get thread id : 6879</span><br><span class="line">restitute thread_id : 6879</span><br><span class="line">get thread id : 6880</span><br><span class="line">get thread id : 6881</span><br><span class="line">restitute thread_id : 6880</span><br><span class="line">get thread id : 6882</span><br><span class="line">restitute thread_id : 6881</span><br><span class="line">restitute thread_id : 6882</span><br><span class="line">get thread id : 6883</span><br><span class="line">get thread id : 6879</span><br><span class="line">restitute thread_id : 6879</span><br><span class="line">get thread id : 6881</span><br><span class="line">get thread id : 6880</span><br><span class="line">restitute thread_id : 6881</span><br><span class="line">restitute thread_id : 6880</span><br><span class="line">restitute thread_id : 6883</span><br><span class="line">get thread id : 6882</span><br><span class="line">get thread id : 6879</span><br><span class="line">restitute thread_id : 6882</span><br><span class="line">restitute thread_id : 6879</span><br><span class="line">get thread id : 6881</span><br><span class="line">restitute thread_id : 6881</span><br></pre></td></tr></table></figure><p>å®Œç¾ç¬¦åˆé¢„æœŸ</p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Swoole </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyISAMä¸InnoDBæ€§èƒ½æµ‹è¯•å¯¹æ¯”</title>
      <link href="/posts/51443/"/>
      <url>/posts/51443/</url>
      
        <content type="html"><![CDATA[<p>MyISAMä¸InnoDBçš„ä¼˜ç¼ºç‚¹åœ¨æ­¤å°±ä¸å†å¤šè¯´äº†ï¼Œç½‘ä¸Šå¯ä»¥æœå‡ºä¸€å †ï¼Œè€Œè¿™ç§æ–‡ç« çš„æœ€åä¸€èˆ¬éƒ½æ˜¯æ¨èï¼Œè¯»çš„å¤šçš„ä½¿ç”¨MyISAMï¼Œå†™ä¸æ›´æ–°å¤šçš„æ¨èInnoDBï¼Œä½†æ˜¯ï¼Œäº†è§£è¿‡ä¸¤ç§å­˜å‚¨å¼•æ“ä¹‹åï¼Œå°±ä¼šäº§ç”Ÿä¸€ç§ç–‘æƒ‘ï¼ŒInnoDBé‡‡ç”¨çš„æ˜¯èšç°‡ç´¢å¼•ï¼Œæ— è®ºæ˜¯ç´¢å¼•è¿˜æ˜¯æ•°æ®éƒ½æ˜¯å­˜æ”¾åœ¨å†…å­˜ä¸­çš„ï¼ŒMyISAMå¼•æ“ä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¶èŠ‚ç‚¹çš„dataåŸŸå­˜æ”¾çš„æ˜¯æ•°æ®è®°å½•çš„åœ°å€ï¼Œæ‰¾åˆ°äº†ä¹‹åè¿˜è¦åˆ°ç¡¬ç›˜ä¸Šå»è·å–æ•°æ®ï¼Œè¿™æ ·è‚¯å®šä¼šé€ æˆæ—¶é—´æŸè€—çš„ï¼Œæ‰€ä»¥ï¼Œè¿˜æ˜¯å‡†å¤‡ç”¨å®éªŒæ•°æ®æ¥è§£å†³ç–‘æƒ‘</p><a id="more"></a><p>æˆ‘çš„MySQLçš„ç‰ˆæœ¬æ˜¯ 5.7.22ï¼Œ æœåŠ¡å™¨æ˜¯1G1æ ¸</p><h1 id="å•è¿›ç¨‹å†™"><a href="#å•è¿›ç¨‹å†™" class="headerlink" title="å•è¿›ç¨‹å†™"></a>å•è¿›ç¨‹å†™</h1><blockquote><p>commit = 0 è¡¨ç¤º my.cnf ä¸­ <strong>innodb_flush_log_at_trx_commit</strong> çš„å±æ€§å€¼ä¸º0</p><p>no index  è¡¨ç¤ºé™¤ä¸»é”®ç´¢å¼•ä¸ºæ— å…¶ä»–ç´¢å¼• è¿™é‡Œæœ‰å››ä¸ªç´¢å¼•</p><p>index è¡¨ç¤ºåªæœ‰ä¸»é”®ç´¢å¼•</p></blockquote><table><thead><tr><th>æ•°æ®ï¼ˆwï¼‰</th><th>MyISAM (index)</th><th>MyISAM  (no index)</th><th>InnoDB (commit=0) (index)</th><th>InnoDB (commit=0) (no index)</th></tr></thead><tbody><tr><td>1</td><td>6.39</td><td>3.90</td><td>4.99</td><td>4.89</td></tr><tr><td>5</td><td>26.89</td><td>22.73</td><td>29.80</td><td>22.33</td></tr><tr><td>10</td><td>49.55</td><td>34.96</td><td>53.40</td><td>33.21</td></tr><tr><td>50</td><td>189.20</td><td>139.93</td><td>260.78</td><td>200.74</td></tr></tbody></table><p>ç»¼ä¸Šå¯ä»¥çœ‹å‡ºï¼Œå•è¿›ç¨‹ä¸€æ¡ä¸€æ¡çš„æ’å…¥çš„æ—¶é—´ï¼ŒMyISAMçš„æ€§èƒ½ç•¥å ä¼˜åŠ¿ï¼Œä½†æ˜¯å¹¶ä¸å¤ªæ˜æ˜¾ï¼Œ è€Œæ— ç´¢å¼•æ¯”æœ‰ç´¢å¼•çš„åˆç•¥å ä¼˜åŠ¿ï¼Œè¿™ä¹Ÿæ˜¯å› ä¸ºæ’å…¥çš„æ—¶å€™åŒæ—¶è¿˜è¦æ³¨æ„ç»´æŠ¤ç´¢å¼•æ ‘å¯¼è‡´çš„ï¼Œæ‰€ä»¥ï¼Œç´¢å¼•è™½å¥½ï¼Œå¯ä¸è¦å¤ªè´ªäº†ã€‚</p><table><thead><tr><th>æ•°æ®ï¼ˆwï¼‰</th><th>MyISAM (index)</th><th>MyISAM  (no index)</th><th>InnoDB (commit=0) (index)</th><th>InnoDB (commit=0) (no index)</th></tr></thead><tbody><tr><td>1</td><td>9.70</td><td>4.91</td><td>60.9</td><td>49.8</td></tr><tr><td>5</td><td>32.01</td><td>18.33</td><td>306.55</td><td>243.17</td></tr></tbody></table><p>è¿˜æœ‰10wå’Œ50wçš„æ•°æ®å°±ä¸å†æ¯”è¾ƒäº†ï¼Œå› ä¸ºæ€§èƒ½å·®è·å¤ªæ˜æ˜¾äº†ï¼Œé‚£è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œ <strong>innodb_flush_log_at_trx_commit</strong>  è¿™ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆæ„æ€ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰é‚£ä¹ˆå¤§çš„å½±å“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit=0 ï¼ˆå»¶è¿Ÿå†™ã€å®æ—¶åˆ·ï¼‰ï¼šlog_buffer --æ¯éš”1ç§’--&gt; log_file --å®æ—¶--&gt; disk</span><br><span class="line">innodb_flush_log_at_trx_commit=1 ï¼ˆå®æ—¶å†™ã€å®æ—¶åˆ·ï¼‰ï¼šlog_buffer --å®æ—¶--&gt; log_file --å®æ—¶--&gt; disk</span><br><span class="line">innodb_flush_log_at_trx_commit=2 ï¼ˆå®æ—¶å†™ã€å»¶è¿Ÿåˆ·ï¼‰ï¼šlog_buffer --å®æ—¶--&gt; log_file --æ¯éš”1ç§’ --&gt; disk</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œè¿™é‡Œå…¶å®æ˜¯åˆ·æ—¥å¿—åˆ°ç¡¬ç›˜å¯¼è‡´çš„æ€§èƒ½ä¸‹é™ï¼Œè¿™é‡Œè¿˜æ˜¯éœ€è¦æ³¨æ„çš„ï¼Œæ€§èƒ½å½±å“è¿˜æ˜¯å¾ˆå¤§çš„</p><h1 id="å¤šè¿›ç¨‹å†™"><a href="#å¤šè¿›ç¨‹å†™" class="headerlink" title="å¤šè¿›ç¨‹å†™"></a>å¤šè¿›ç¨‹å†™</h1><p>è¿™é‡Œä»¥æ¯ä¸ªè¿›ç¨‹å†™1wæ¡æ•°æ®ä¸ºä¾‹</p><table><thead><tr><th>è¿›ç¨‹æ•°</th><th>MyISAM(s/è¿›ç¨‹)</th><th>InnoDB(s/è¿›ç¨‹)</th></tr></thead><tbody><tr><td>20</td><td>90.00</td><td>29.66</td></tr><tr><td>50</td><td>255.89</td><td>74.52</td></tr><tr><td>100</td><td>545.385</td><td>201.94</td></tr></tbody></table><p>ä¸Šé¢å……åˆ†å¯ä»¥å±•ç¤ºå‡ºæ¥<strong>InnoDB</strong> å¼•æ“åœ¨å¤šè¿›ç¨‹ä¸‹çš„ä¼˜åŠ¿</p><h1 id="å•è¿›ç¨‹è¯»"><a href="#å•è¿›ç¨‹è¯»" class="headerlink" title="å•è¿›ç¨‹è¯»"></a>å•è¿›ç¨‹è¯»</h1><table><thead><tr><th>æ€»æ¬¡æ•°(w)</th><th>MyISAM(æ€»æ—¶é—´ s)</th><th>InnoDB(æ€»æ—¶é—´ s)</th></tr></thead><tbody><tr><td>1</td><td>67.14</td><td>77.15</td></tr><tr><td>5</td><td>110.58</td><td>104.21</td></tr><tr><td>10</td><td>136.02</td><td>146.26</td></tr></tbody></table><h1 id="å¤šè¿›ç¨‹è¯»"><a href="#å¤šè¿›ç¨‹è¯»" class="headerlink" title="å¤šè¿›ç¨‹è¯»"></a>å¤šè¿›ç¨‹è¯»</h1><p>è¿™é‡Œä»¥æ¯ä¸ªè¿›ç¨‹è¯»5kæ¡æ•°æ®ä¸ºä¾‹</p><table><thead><tr><th>è¿›ç¨‹æ•°</th><th>MyISAM(s/è¿›ç¨‹)</th><th>InnoDB(s/è¿›ç¨‹)</th></tr></thead><tbody><tr><td>20</td><td>140.89</td><td>140.37</td></tr><tr><td>50</td><td>366.32</td><td>308.76</td></tr><tr><td>100</td><td>766.37</td><td>615.50</td></tr></tbody></table><p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨å•è¿›ç¨‹çš„è¯»ä¸­ï¼ŒMyISAMæˆ˜å‹å¾®å¼±çš„ä¼˜åŠ¿ï¼Œä½†è¿™ç§å¾®å¼±çš„ä¼˜åŠ¿åœ¨å¤šè¿›ç¨‹ä¸­ä¹Ÿè¡ç„¶æ— å­˜äº†</p><p>å†è€ƒè™‘<strong>InnoDB</strong> æ”¯æŒ <strong>äº‹åŠ¡</strong>ï¼Œ <strong>å¤–é”®</strong>ï¼Œ <strong>å´©æºƒæ¢å¤</strong> ä¸€ç³»åˆ—é«˜çº§ç‰¹æ€§ï¼Œè¿˜æœ‰ä»€ä¹ˆçŠ¹è±«çš„å—ï¼Ÿ</p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆä¸ƒï¼‰ï¼šNginxé™åˆ¶è®¿é—®é¢‘ç‡</title>
      <link href="/posts/34870/"/>
      <url>/posts/34870/</url>
      
        <content type="html"><![CDATA[<p>é¢å¯¹è€Œå·²çš„DDOSæ”»å‡»æ˜¯ä¸€ç§å¾ˆè®©äººå¤´ç–¼çš„é—®é¢˜ï¼Œå…¶ä¸­CCæ”»å‡»æ˜¯DDOSçš„ä¸€ç§ï¼Œä¹Ÿæ˜¯ä¸€ç§å¸¸è§çš„ç½‘ç«™æ”»å‡»æ–¹æ³•ï¼Œé€šè¿‡æœ‰é™çš„IPä¸æ–­çš„å»è¯·æ±‚å¯¹æ–¹æœåŠ¡å™¨ï¼Œé€ æˆå¯¹æ–¹æœåŠ¡å™¨èµ„æºè€—å°½ç›´è‡³å®•æœºã€‚</p><p>è€Œé€šè¿‡Nginxçš„<strong>HttpLimitReqModul</strong>å’Œ<strong>HttpLimitZoneModule</strong> æ¥é™åˆ¶åŒä¸€IPåœ¨åŒä¸€æ—¶é—´æ®µå†…çš„è®¿é—®æ¬¡æ•°æ¥é™ä½CCæ”»å‡»å¸¦æ¥çš„å±å®³</p><a id="more"></a><p>ä¸‹é¢æ˜¯ä¸€ç§ç®€å•çš„é¢‘ç‡é™åˆ¶åœ¨nginxé‡Œé¢çš„é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        location /search/ &#123;</span><br><span class="line">            limit_req zone=one burst=5;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h1 id="limit-req-zone"><a href="#limit-req-zone" class="headerlink" title="limit_req_zone"></a>limit_req_zone</h1><p>limit_req_zoneçš„ä½¿ç”¨è§„åˆ™æ˜¯ </p><p><strong>limit_req_zone</strong> <em>key</em> zone=<em>name</em>:<em>size</em> rate=<em>rate</em></p><p><code>limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</code></p><p>è¿™ä¸€æ®µæ˜¯å®šä¹‰äº†ä¸€ä¸ªåä¸º<em>one</em> çš„zoneç©ºé—´ï¼Œç©ºé—´å¤§å°ä¸º10mï¼Œ ä»¥$binary_remote_addr ä¸ºkey,é™åˆ¶å¹³å‡æ¯ç§’çš„è¯·æ±‚ä¸º1ä¸ªï¼Œ1Mèƒ½å­˜å‚¨16000ä¸ªçŠ¶æ€ï¼Œrateçš„å€¼å¿…é¡»ä¸ºæ•´æ•°</p><h1 id="limit-req"><a href="#limit-req" class="headerlink" title="limit_req"></a>limit_req</h1><p>limit_reqçš„ä½¿ç”¨è§„åˆ™æ˜¯</p><p><strong>limit_req</strong> zone=<em>name</em> [burst=<em>number</em>] [nodelay];</p><p><code>limit_req zone=one burst=5;</code></p><p>zone: zoneæ˜¯æŒ‡ä½¿ç”¨æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„zoneï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£</p><p>burst: burstå…¶å®æ˜¯ä¸€ä¸ªæ¡¶çš„æ¦‚å¿µï¼Œä»¥æˆ‘ä»¬çš„è®¾ç½®ä¸ºä¾‹ï¼Œæˆ‘ä»¬è®¾ç½®çš„æ˜¯1request/sï¼Œå¦‚æœä¸€æ¬¡æ€§æ¥äº†3ä¸ªrequestï¼Œnginxä¼šåœ¨ç¬¬ä¸€ç§’å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå¦å¤–ä¸¤ä¸ªè¯·æ±‚æ”¾åˆ°è¿™ä¸ª<strong>burst</strong>æ¡¶é‡Œï¼Œç„¶åä¸‹ä¸€ç§’å…ˆå¤„ç†æ¡¶é‡Œçš„è¯·æ±‚ï¼Œåé¢æ¥çš„è¯·æ±‚ç»§ç»­æ”¾è¿›æ¡¶é‡Œï¼Œå¦‚æœæ¡¶æ»¡äº†ï¼Œè¿™æ—¶å€™çš„è¯·æ±‚å°±ä¼šè¿”å›503äº†</p><p>nodelay: å¦‚æœä¸å¸Œæœ›åœ¨è¯·æ±‚å—é™çš„æƒ…å†µä¸‹å»¶è¿Ÿè¿‡å¤šçš„è¯·æ±‚ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼ŒåŒæ—¶é…åˆburstï¼Œä»–ä¼šåœ¨ç¬¬ä¸€ç§’çš„æ—¶å€™ï¼Œå¤„ç†é™åˆ¶çš„è¯·æ±‚æ•°å’Œbursté‡Œé¢çš„è¯·æ±‚æ•°</p>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTPåè®®ï¼šHTTP1.0ã€HTTP1.1ã€HTTP2.0å¯¹æ¯”</title>
      <link href="/posts/43499/"/>
      <url>/posts/43499/</url>
      
        <content type="html"><![CDATA[<p>æ—©åœ¨HTTPå»ºç«‹ä¹‹åˆï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†å°†è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€(HTML)æ–‡æ¡£ä»WebæœåŠ¡å™¨ä¼ é€åˆ°å®¢æˆ·ç«¯çš„æµè§ˆå™¨ã€‚ä¹Ÿæ˜¯è¯´å¯¹äºå‰ç«¯æ¥è¯´ï¼Œæˆ‘ä»¬æ‰€å†™çš„HTMLé¡µé¢å°†è¦æ”¾åœ¨æˆ‘ä»¬çš„webæœåŠ¡å™¨ä¸Šï¼Œç”¨æˆ·ç«¯é€šè¿‡æµè§ˆå™¨è®¿é—®urlåœ°å€æ¥è·å–ç½‘é¡µçš„æ˜¾ç¤ºå†…å®¹ï¼Œä½†æ˜¯åˆ°äº†WEB2.0ä»¥æ¥ï¼Œæˆ‘ä»¬çš„é¡µé¢å˜å¾—å¤æ‚ï¼Œä¸ä»…ä»…å•çº¯çš„æ˜¯ä¸€äº›ç®€å•çš„æ–‡å­—å’Œå›¾ç‰‡ï¼ŒåŒæ—¶æˆ‘ä»¬çš„HTMLé¡µé¢æœ‰äº†CSSï¼ŒJavascriptï¼Œæ¥ä¸°å¯Œæˆ‘ä»¬çš„é¡µé¢å±•ç¤ºï¼Œå½“ajaxçš„å‡ºç°ï¼Œæˆ‘ä»¬åˆå¤šäº†ä¸€ç§å‘æœåŠ¡å™¨ç«¯è·å–æ•°æ®çš„æ–¹æ³•ï¼Œè¿™äº›å…¶å®éƒ½æ˜¯åŸºäºHTTPåè®®çš„ã€‚åŒæ ·åˆ°äº†ç§»åŠ¨äº’è”ç½‘æ—¶ä»£ï¼Œæˆ‘ä»¬é¡µé¢å¯ä»¥è·‘åœ¨æ‰‹æœºç«¯æµè§ˆå™¨é‡Œé¢ï¼Œä½†æ˜¯å’ŒPCç›¸æ¯”ï¼Œæ‰‹æœºç«¯çš„ç½‘ç»œæƒ…å†µæ›´åŠ å¤æ‚ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¼€å§‹äº†ä¸å¾—ä¸å¯¹HTTPè¿›è¡Œæ·±å…¥ç†è§£å¹¶ä¸æ–­ä¼˜åŒ–è¿‡ç¨‹ä¸­ã€‚</p><a id="more"></a><p>#å¯¹æ¯”</p><table><thead><tr><th></th><th>HTTP1.0</th><th>HTTP1.1</th><th>HTTP2.0</th></tr></thead><tbody><tr><td>Hostå¤´</td><td>âœ—</td><td>âœ”</td><td>âœ”</td></tr><tr><td>Rangeå¤´</td><td>âœ—</td><td>âœ”</td><td>âœ”</td></tr><tr><td>é•¿è¿æ¥</td><td>âœ—</td><td>âœ”</td><td>âœ”</td></tr><tr><td>request method</td><td>GET  HEAD POST</td><td>ä»¥ä¸Š+ OPTIONS  PUT  DELETE TRACE CONNECT</td><td>ä»¥ä¸Šå…¨éƒ¨</td></tr><tr><td>cache</td><td>Expire  Last-Modefied  Pragma</td><td>ä»¥ä¸Š+ETag   Cache-Control</td><td>ä»¥ä¸Šå…¨éƒ¨</td></tr><tr><td>headerå‹ç¼©</td><td>âœ—</td><td>âœ—</td><td>âœ”</td></tr><tr><td>å¤šè·¯å¤ç”¨</td><td>âœ—</td><td>âœ—</td><td>âœ”</td></tr><tr><td>æœåŠ¡å™¨æ¨é€</td><td>âœ—</td><td>âœ—</td><td>âœ”</td></tr></tbody></table><h1 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h1><p>æˆ‘ä»¬è¿™é‡Œä¸»è¦é€‰å–äº†å‡ ä¸ªç‚¹æ¥è¿›è¡Œåˆ†æ</p><h2 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h2><p>è¿™é‡Œçš„<strong>Range</strong> å’Œ <strong>Content-Range</strong> æ˜¯é’ˆå¯¹äºHTTP1.0çš„å®½å¸¦æµªè´¹ç°è±¡è€Œæå‡ºæ¥çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚</p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ¥è§¦çš„æœ€å¤šçš„ä¾¿æ˜¯æ–­ç‚¹ç»­ä¼ äº†ï¼Œ æˆ‘ä»¬åœ¨è¯·æ±‚ä¸‹è½½æŸä¸€ä¸ªè¾ƒå¤§æ–‡ä»¶çš„æ—¶å€™ï¼Œç§‰ç€è€å¿ƒç»ˆäºç­‰åˆ°äº†99%äº†ï¼Œä½†æ˜¯è¿™æ—¶å€™å´çªç„¶æ–­ç½‘äº†ï¼Œå¦‚æœå†è®©ä½ ç­‰å¾…å‡ ååˆ†é’Ÿå»ç­‰å¾…ä»–é‡æ–°ä¸‹è½½å®Œæˆï¼Œæˆ‘ä»¬ä¼°è®¡éƒ½è¦çˆ†å‘äº†ï¼Œè€Œå¦‚æœå®¢æˆ·ç«¯ï¼ŒçŸ¥é“æœ¬åœ°å·²ç»ä¸‹äº†99%ï¼Œåªå»è¯·æ±‚æœåŠ¡ç«¯å‰©ä½™çš„éƒ¨åˆ†ï¼Œè¿™æ ·ä¸ä»…èŠ‚çº¦äº†ç”¨æˆ·çš„æ—¶é—´ï¼Œè¿˜è§£å†³äº†æœåŠ¡å™¨ä¼ è¾“å¤šä½™çš„é‡å¤æ•°æ®è€Œå¯¼è‡´çš„å®½å¸¦æµªè´¹</p><h2 id="é•¿è¿æ¥"><a href="#é•¿è¿æ¥" class="headerlink" title="é•¿è¿æ¥"></a>é•¿è¿æ¥</h2><p>ä¸€ä¸ªwebé¡µé¢ä¸Šé¢å¯èƒ½åŒ…å«å‡ åä¸ªå›¾ç‰‡æ–‡ä»¶æˆ–jsã€cssæ–‡ä»¶ï¼Œåœ¨HTTP1.0çš„æ—¶ä»£ï¼Œè§„å®šäº†æµè§ˆå™¨ä¸æœåŠ¡å™¨åªèƒ½ä¿æŒçŸ­æš‚çš„è¿æ¥ï¼Œæµè§ˆå™¨çš„æ¯ä¸ªè¯·æ±‚éƒ½è¦ä¸æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªæ–°çš„TCPè¿æ¥ï¼ŒTCPçš„è¿æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œhttpsè¿˜éœ€è¦æ ¡éªŒè¯ä¹¦ï¼Œé‚£ä¹ˆé—®é¢˜å°±æš´æ¼å‡ºæ¥äº†ï¼Œè¿™å‡ åæ¬¡å›¾ç‰‡ã€jsã€cssæ–‡ä»¶å…¶å®æ˜¯åœ¨åŒä¸€ä¸ªwebé¡µé¢é‡Œé¢çš„ï¼Œå¦‚æœæˆ‘ä»¬å»é™¤å¤šä½™çš„å‡ åæ¬¡ä¸‰æ¬¡æ¡æ‰‹ï¼Œé‚£ä¹ˆè®¿é—®é€Ÿåº¦å°±ä¼šæå‡ä¸Šæ¥ï¼ŒHTTP1.1ä½¿ç”¨äº†<strong>é•¿è¿æ¥</strong>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®åå°æœåŠ¡å™¨çš„é•¿è¿æ¥çš„æ—¶é—´ï¼Œè¶…æ—¶æ— å†…å®¹ä¼ è¾“æ‰ä¼šæ–­å¼€è¿æ¥ï¼Œä»è€Œï¼Œåœ¨ä¸€å®šæ—¶é—´å†…çš„æµè§ˆå™¨çš„è¯·æ±‚å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªTCPè¿æ¥æˆ–è€…å‡ ä¸ªTCPè¿æ¥ï¼Œå‡å°‘äº†æ¡æ‰‹å¸¦æ¥çš„æ—¶é—´æŸè€—</p><h2 id="å¤šè·¯å¤ç”¨"><a href="#å¤šè·¯å¤ç”¨" class="headerlink" title="å¤šè·¯å¤ç”¨"></a>å¤šè·¯å¤ç”¨</h2><p>æ—¢ç„¶ä¸Šé¢è§£æäº†é•¿è¿æ¥ï¼Œè¿™é‡Œå°±æŠŠå¤šè·¯å¤ç”¨æä¸Šæ¥å§ã€‚HTTP2.0ä½¿ç”¨äº†å¤šè·¯å¤ç”¨çš„æŠ€æœ¯ï¼Œåšåˆ°åŒä¸€ä¸ªè¿æ¥å¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œè€Œä¸”å¹¶å‘è¯·æ±‚çš„æ•°é‡æ¯”HTTP1.1å¤§äº†å¥½å‡ ä¸ªæ•°é‡çº§ã€‚</p><p>ä»¥chromeä¸ºä¾‹ï¼Œæ¯ä¸ªé¡µé¢ï¼Œæµè§ˆå™¨æœ€å¤šå…è®¸å»ºç«‹6ä¸ªTCPè¿æ¥ï¼Œå‘èµ·è¯·æ±‚-&gt;æœåŠ¡ç«¯å¤„ç†-&gt;å“åº”è¯·æ±‚ è¿™æ ·ç®—æ˜¯å®Œæˆäº†ä¸€ä¸ªæµè§ˆå™¨è¯·æ±‚ã€‚ä½†æ˜¯å¦‚æœä¸€ä¸ªé¡µé¢åŒæ—¶å‘èµ·å‡ ç™¾ä¸ªè¯·æ±‚ï¼Œå…¶ä¸­å‰å‡ ä¸ªè¯·æ±‚åˆæ¯”è¾ƒè€—æ—¶ï¼Œåˆ™ä¼šæŠŠè¿™6ä¸ªTCPè¿æ¥å…¨éƒ¨å ç”¨ï¼ŒåŒæ—¶é˜»å¡äº†åé¢çš„è¯·æ±‚ï¼Œè¿™æ ·æ•´ä½“è¯·æ±‚éƒ½ä¼šæ…¢ä¸‹æ¥äº†ã€‚</p><p>HTTP2é‡‡ç”¨å¤šè·¯å¤ç”¨æ˜¯æŒ‡ï¼Œåœ¨åŒä¸€ä¸ªåŸŸåä¸‹ï¼Œå¼€å¯ä¸€ä¸ªTCPçš„connectionï¼Œæ¯ä¸ªè¯·æ±‚ä»¥streamçš„æ–¹å¼ä¼ è¾“ï¼Œæ¯ä¸ªstreamæœ‰å”¯ä¸€æ ‡è¯†ï¼Œconnectionä¸€æ—¦å»ºç«‹ï¼Œåç»­çš„è¯·æ±‚éƒ½å¯ä»¥å¤ç”¨è¿™ä¸ªconnectionå¹¶ä¸”å¯ä»¥åŒæ—¶å‘é€ï¼Œserverç«¯å¯ä»¥æ ¹æ®streamçš„å”¯ä¸€æ ‡è¯†æ¥ç›¸åº”å¯¹åº”çš„è¯·æ±‚ã€‚è¿™æ ·ä¸Šé¢è¯·æ±‚é˜»å¡çš„é—®é¢˜å°±å¯ä»¥å¾—åˆ°è§£å†³ã€‚</p><p>##æœåŠ¡å™¨æ¨é€</p><p>æ„æ€æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬å¯¹æ”¯æŒHTTP2.0çš„web serverè¯·æ±‚æ•°æ®çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¼šé¡ºä¾¿æŠŠä¸€äº›å®¢æˆ·ç«¯éœ€è¦çš„èµ„æºä¸€èµ·æ¨é€åˆ°å®¢æˆ·ç«¯ï¼Œå…å¾—å®¢æˆ·ç«¯å†æ¬¡åˆ›å»ºè¿æ¥å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ç«¯è·å–ã€‚è¿™ç§æ–¹å¼éå¸¸åˆé€‚åŠ è½½é™æ€èµ„æºã€‚</p><h2 id="headerå‹ç¼©"><a href="#headerå‹ç¼©" class="headerlink" title="headerå‹ç¼©"></a>headerå‹ç¼©</h2><p>æˆ‘ä»¬åœ¨ä¼ è¾“æ–‡æœ¬ç­‰é™æ€èµ„æºçš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šå¼€å¯å‹ç¼©ï¼Œgzipç­‰ï¼Œè¿™æ ·ä¼šå‡å°‘å®½å¸¦çš„å ç”¨ï¼Œå¯¹äºä¸€äº›è¾ƒå¤§çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå‹ç¼©åä¼šå‡å°‘çš„ç‰¹åˆ«æ˜æ˜¾ï¼Œç›¸åº”ä¹Ÿä¼šæ„Ÿè§‰æå‡äº†å¾ˆå¤šã€‚è€Œheaderå¤´ä¿¡æ¯çš„ä¼ è¾“å´ä¸€ç›´ä½¿ç”¨å­—ç¬¦ä¸²æ¥ä¼ è¾“ï¼ŒHTTP2.0ä½¿ç”¨HPACKç®—æ³•å¯¹headerçš„æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œè¿™æ ·æ•°æ®ä½“ç§¯å°äº†ï¼Œåœ¨ç½‘ç»œä¸Šä¼ è¾“å°±ä¼šæ›´å¿«ã€‚</p><h1 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h1><p><a href="https://http2.akamai.com/demo" target="_blank" rel="noopener">https://http2.akamai.com/demo</a> æ˜¯Akamaiå…¬å¸å»ºç«‹çš„ä¸€ä¸ªå®˜æ–¹æ¼”ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºHTTP2.0å¯¹HTTP1.1ä¸Šçš„æ€§èƒ½æå‡</p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/http_beyond_http1.png" alt="httpé€Ÿåº¦å¯¹æ¯”å›¾"></p><h1 id="å…¨ç«™å¯ç”¨HTTP2"><a href="#å…¨ç«™å¯ç”¨HTTP2" class="headerlink" title="å…¨ç«™å¯ç”¨HTTP2"></a>å…¨ç«™å¯ç”¨HTTP2</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 83 http2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä½ çš„nginxé…ç½®æ–‡ä»¶çš„ <code>listen</code> åé¢åŠ ä¸Š <code>http2</code> å°±å¯ä»¥å¯ç”¨HTTP2.0äº†ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ï¼ŒHTTP2.0å·²ç»å…¼å®¹äº†HTTP1.1ï¼Œå¦‚æœä½ çš„æµè§ˆå™¨ä¸æ”¯æŒHTTP2.0çš„è¯ï¼ŒæœåŠ¡å™¨ä½¿ç”¨HTTP1.1çš„åè®®è¿›è¡Œä¼ è¾“</p>]]></content>
      
      
      <categories>
          
          <category> HTTP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPå®ç°æ–­ç‚¹ç»­ä¼ </title>
      <link href="/posts/13685/"/>
      <url>/posts/13685/</url>
      
        <content type="html"><![CDATA[<p>æ–­ç‚¹ç»­ä¼ æŒ‡çš„æ˜¯åœ¨ä¸Šä¼ /ä¸‹è½½æ—¶ï¼Œå°†ä»»åŠ¡ï¼ˆä¸€ä¸ªæ–‡ä»¶æˆ–å‹ç¼©åŒ…ï¼‰äººä¸ºçš„åˆ’åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸€ä¸ªéƒ¨åˆ†é‡‡ç”¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œä¸Šä¼ /ä¸‹è½½ï¼Œå¦‚æœç¢°åˆ°ç½‘ç»œæ•…éšœï¼Œå¯ä»¥ä»å·²ç»ä¸Šä¼ /ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸Šä¼ /ä¸‹è½½æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ä¸Šä¼ /ä¸‹è½½ã€‚å¯ä»¥èŠ‚çœæ—¶é—´ï¼Œæé«˜é€Ÿåº¦ã€‚</p><a id="more"></a><h1 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h1><p>HTTP1.1 åè®®ï¼ˆRFC2616ï¼‰å¼€å§‹æ”¯æŒè·å–æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹ï¼Œè¿™ä¸ºå¹¶è¡Œä¸‹è½½ä»¥åŠæ–­ç‚¹ç»­ä¼ æä¾›äº†æŠ€æœ¯æ”¯æŒã€‚å®ƒé€šè¿‡åœ¨ Header é‡Œä¸¤ä¸ªå‚æ•°å®ç°çš„ï¼Œå®¢æˆ·ç«¯å‘è¯·æ±‚æ—¶å¯¹åº”çš„æ˜¯ Range ï¼ŒæœåŠ¡å™¨ç«¯å“åº”æ—¶å¯¹åº”çš„æ˜¯ Content-Rangeã€‚</p><p><strong>Range</strong></p><p>ç”¨äºè¯·æ±‚å¤´ä¸­ï¼ŒæŒ‡å®šç¬¬ä¸€ä¸ªå­—èŠ‚çš„ä½ç½®å’Œæœ€åä¸€ä¸ªå­—èŠ‚çš„ä½ç½®ï¼Œä¸€èˆ¬æ ¼å¼ï¼š</p><blockquote><p>Range:(unit=first byte pos)-[last byte pos]</p></blockquote><p>Range å¤´éƒ¨çš„æ ¼å¼æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><blockquote><p>Range: bytes=0-499 è¡¨ç¤ºç¬¬ 0-499 å­—èŠ‚èŒƒå›´çš„å†…å®¹<br>Range: bytes=500-999 è¡¨ç¤ºç¬¬ 500-999 å­—èŠ‚èŒƒå›´çš„å†…å®¹<br>Range: bytes=-500 è¡¨ç¤ºæœ€å 500 å­—èŠ‚çš„å†…å®¹<br>Range: bytes=500- è¡¨ç¤ºä»ç¬¬ 500 å­—èŠ‚å¼€å§‹åˆ°æ–‡ä»¶ç»“æŸéƒ¨åˆ†çš„å†…å®¹<br>Range: bytes=0-0,-1 è¡¨ç¤ºç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå­—èŠ‚<br>Range: bytes=500-600,601-999 åŒæ—¶æŒ‡å®šå‡ ä¸ªèŒƒå›´</p></blockquote><p><strong>Content-Range</strong></p><p>ç”¨äºå“åº”å¤´ä¸­ï¼Œåœ¨å‘å‡ºå¸¦ Range çš„è¯·æ±‚åï¼ŒæœåŠ¡å™¨ä¼šåœ¨ Content-Range å¤´éƒ¨è¿”å›å½“å‰æ¥å—çš„èŒƒå›´å’Œæ–‡ä»¶æ€»å¤§å°ã€‚ä¸€èˆ¬æ ¼å¼ï¼š</p><blockquote><p>Content-Range: bytes (unit first byte pos) - [last byte pos]/[entity legth]</p></blockquote><p>ä¾‹å¦‚ï¼š</p><blockquote><p>Content-Range: bytes 0-499/22400</p></blockquote><p>0ï¼499 æ˜¯æŒ‡å½“å‰å‘é€çš„æ•°æ®çš„èŒƒå›´ï¼Œè€Œ 22400 åˆ™æ˜¯æ–‡ä»¶çš„æ€»å¤§å°ã€‚</p><p>è€Œåœ¨å“åº”å®Œæˆåï¼Œè¿”å›çš„å“åº”å¤´å†…å®¹ä¹Ÿä¸åŒï¼š</p><blockquote><p>HTTP/1.1 200 Okï¼ˆä¸ä½¿ç”¨æ–­ç‚¹ç»­ä¼ æ–¹å¼ï¼‰<br>HTTP/1.1 206 Partial Contentï¼ˆä½¿ç”¨æ–­ç‚¹ç»­ä¼ æ–¹å¼ï¼‰</p></blockquote><h1 id="å¢å¼ºæ ¡éªŒ"><a href="#å¢å¼ºæ ¡éªŒ" class="headerlink" title="å¢å¼ºæ ¡éªŒ"></a>å¢å¼ºæ ¡éªŒ</h1><p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼Œå³åœ¨ç»ˆç«¯å‘èµ·ç»­ä¼ è¯·æ±‚æ—¶ï¼ŒURL å¯¹åº”çš„æ–‡ä»¶å†…å®¹åœ¨æœåŠ¡å™¨ç«¯å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œæ­¤æ—¶ç»­ä¼ çš„æ•°æ®è‚¯å®šæ˜¯é”™è¯¯çš„ã€‚å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜äº†ï¼Ÿæ˜¾ç„¶æ­¤æ—¶éœ€è¦æœ‰ä¸€ä¸ªæ ‡è¯†æ–‡ä»¶å”¯ä¸€æ€§çš„æ–¹æ³•ã€‚</p><p>åœ¨ RFC2616 ä¸­ä¹Ÿæœ‰ç›¸åº”çš„å®šä¹‰ï¼Œæ¯”å¦‚å®ç° Last-Modified æ¥æ ‡è¯†æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œè¿™æ ·å³å¯åˆ¤æ–­å‡ºç»­ä¼ æ–‡ä»¶æ—¶æ˜¯å¦å·²ç»å‘ç”Ÿè¿‡æ”¹åŠ¨ã€‚åŒæ—¶ FC2616 ä¸­è¿˜å®šä¹‰æœ‰ä¸€ä¸ª ETag çš„å¤´ï¼Œå¯ä»¥ä½¿ç”¨ ETag å¤´æ¥æ”¾ç½®æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ã€‚</p><h2 id="Last-Modified"><a href="#Last-Modified" class="headerlink" title="Last-Modified"></a>Last-Modified</h2><p>If-Modified-Sinceï¼Œå’Œ Last-Modified ä¸€æ ·éƒ½æ˜¯ç”¨äºè®°å½•é¡µé¢æœ€åä¿®æ”¹æ—¶é—´çš„ HTTP å¤´ä¿¡æ¯ï¼Œåªæ˜¯ Last-Modified æ˜¯ç”±æœåŠ¡å™¨å¾€å®¢æˆ·ç«¯å‘é€çš„ HTTP å¤´ï¼Œè€Œ If-Modified-Since åˆ™æ˜¯ç”±å®¢æˆ·ç«¯å¾€æœåŠ¡å™¨å‘é€çš„å¤´ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå†æ¬¡è¯·æ±‚æœ¬åœ°å­˜åœ¨çš„ cache é¡µé¢æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šé€šè¿‡ If-Modified-Since å¤´å°†å…ˆå‰æœåŠ¡å™¨ç«¯å‘è¿‡æ¥çš„ Last-Modified æœ€åä¿®æ”¹æ—¶é—´æˆ³å‘é€å›å»ï¼Œè¿™æ˜¯ä¸ºäº†è®©æœåŠ¡å™¨ç«¯è¿›è¡ŒéªŒè¯ï¼Œé€šè¿‡è¿™ä¸ªæ—¶é—´æˆ³åˆ¤æ–­å®¢æˆ·ç«¯çš„é¡µé¢æ˜¯å¦æ˜¯æœ€æ–°çš„ï¼Œå¦‚æœä¸æ˜¯æœ€æ–°çš„ï¼Œåˆ™è¿”å›æ–°çš„å†…å®¹ï¼Œå¦‚æœæ˜¯æœ€æ–°çš„ï¼Œåˆ™è¿”å› 304 å‘Šè¯‰å®¢æˆ·ç«¯å…¶æœ¬åœ° cache çš„é¡µé¢æ˜¯æœ€æ–°çš„ï¼Œäºæ˜¯å®¢æˆ·ç«¯å°±å¯ä»¥ç›´æ¥ä»æœ¬åœ°åŠ è½½é¡µé¢äº†ï¼Œè¿™æ ·åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„æ•°æ®å°±ä¼šå¤§å¤§å‡å°‘ï¼ŒåŒæ—¶ä¹Ÿå‡è½»äº†æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚</p><h2 id="Etag"><a href="#Etag" class="headerlink" title="Etag"></a>Etag</h2><p>Etagï¼ˆEntity Tagsï¼‰ä¸»è¦ä¸ºäº†è§£å†³ Last-Modified æ— æ³•è§£å†³çš„ä¸€äº›é—®é¢˜ã€‚</p><ol><li>ä¸€äº›æ–‡ä»¶ä¹Ÿè®¸ä¼šå‘¨æœŸæ€§çš„æ›´æ”¹ï¼Œä½†æ˜¯å†…å®¹å¹¶ä¸æ”¹å˜ï¼ˆä»…æ”¹å˜ä¿®æ”¹æ—¶é—´ï¼‰ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¹¶ä¸å¸Œæœ›å®¢æˆ·ç«¯è®¤ä¸ºè¿™ä¸ªæ–‡ä»¶è¢«ä¿®æ”¹äº†ï¼Œè€Œé‡æ–° GETã€‚</li><li>æŸäº›æ–‡ä»¶ä¿®æ”¹éå¸¸é¢‘ç¹ï¼Œä¾‹å¦‚ï¼šåœ¨ç§’ä»¥ä¸‹çš„æ—¶é—´å†…è¿›è¡Œä¿®æ”¹ï¼ˆ1s å†…ä¿®æ”¹äº† N æ¬¡ï¼‰ï¼ŒIf-Modified-Since èƒ½æ£€æŸ¥åˆ°çš„ç²’åº¦æ˜¯ s çº§çš„ï¼Œè¿™ç§ä¿®æ”¹æ— æ³•åˆ¤æ–­ï¼ˆæˆ–è€…è¯´ UNIX è®°å½• MTIME åªèƒ½ç²¾ç¡®åˆ°ç§’ï¼‰ã€‚</li><li>æŸäº›æœåŠ¡å™¨ä¸èƒ½ç²¾ç¡®çš„å¾—åˆ°æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ã€‚</li></ol><p>ä¸ºæ­¤ï¼ŒHTTP/1.1 å¼•å…¥äº† Etagã€‚Etag ä»…ä»…æ˜¯ä¸€ä¸ªå’Œæ–‡ä»¶ç›¸å…³çš„æ ‡è®°ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªç‰ˆæœ¬æ ‡è®°ï¼Œä¾‹å¦‚ï¼šv1.0.0ï¼›æˆ–è€…è¯´ â€œ627-4d648041f6b80â€ è¿™ä¹ˆä¸€ä¸²çœ‹èµ·æ¥å¾ˆç¥ç§˜çš„ç¼–ç ã€‚ä½†æ˜¯ HTTP/1.1 æ ‡å‡†å¹¶æ²¡æœ‰è§„å®š Etag çš„å†…å®¹æ˜¯ä»€ä¹ˆæˆ–è€…è¯´è¦æ€ä¹ˆå®ç°ï¼Œå”¯ä¸€è§„å®šçš„æ˜¯ Etag éœ€è¦æ”¾åœ¨ â€œâ€ å†…ã€‚</p><h2 id="If-Range"><a href="#If-Range" class="headerlink" title="If-Range"></a>If-Range</h2><p>ç”¨äºåˆ¤æ–­å®ä½“æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœå®ä½“æœªæ”¹å˜ï¼ŒæœåŠ¡å™¨å‘é€å®¢æˆ·ç«¯ä¸¢å¤±çš„éƒ¨åˆ†ï¼Œå¦åˆ™å‘é€æ•´ä¸ªå®ä½“ã€‚ä¸€èˆ¬æ ¼å¼ï¼š</p><blockquote><p>If-Range: Etag | HTTP-Date</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒIf-Range å¯ä»¥ä½¿ç”¨ Etag æˆ–è€… Last-Modified è¿”å›çš„å€¼ã€‚å½“æ²¡æœ‰ ETage å´æœ‰ Last-modified æ—¶ï¼Œå¯ä»¥æŠŠ Last-modified ä½œä¸º If-Range å­—æ®µçš„å€¼ã€‚</p><p>ä¾‹å¦‚ï¼š</p><blockquote><p>If-Range: â€œ627-4d648041f6b80â€<br>If-Range: Fri, 22 Feb 2013 03:45:02 GMT</p></blockquote><p>If-Range å¿…é¡»ä¸ Range é…å¥—ä½¿ç”¨ã€‚å¦‚æœè¯·æ±‚æŠ¥æ–‡ä¸­æ²¡æœ‰ Rangeï¼Œé‚£ä¹ˆ If-Range å°±ä¼šè¢«å¿½ç•¥ã€‚å¦‚æœæœåŠ¡å™¨ä¸æ”¯æŒ If-Rangeï¼Œé‚£ä¹ˆ Range ä¹Ÿä¼šè¢«å¿½ç•¥ã€‚</p><p>å¦‚æœè¯·æ±‚æŠ¥æ–‡ä¸­çš„ Etag ä¸æœåŠ¡å™¨ç›®æ ‡å†…å®¹çš„ Etag ç›¸ç­‰ï¼Œå³æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆåº”ç­”æŠ¥æ–‡çš„çŠ¶æ€ç ä¸º 206ã€‚å¦‚æœæœåŠ¡å™¨ç›®æ ‡å†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆåº”ç­”æŠ¥æ–‡çš„çŠ¶æ€ç ä¸º 200ã€‚</p><p>ç”¨äºæ ¡éªŒçš„å…¶ä»– HTTP å¤´ä¿¡æ¯ï¼šIf-Match/If-None-Matchã€If-Modified-Since/If-Unmodified-Sinceã€‚</p><h2 id="å·¥ä½œåŸç†"><a href="#å·¥ä½œåŸç†" class="headerlink" title="å·¥ä½œåŸç†"></a>å·¥ä½œåŸç†</h2><p>Etag ç”±æœåŠ¡å™¨ç«¯ç”Ÿæˆï¼Œå®¢æˆ·ç«¯é€šè¿‡ If-Range æ¡ä»¶åˆ¤æ–­è¯·æ±‚æ¥éªŒè¯èµ„æºæ˜¯å¦ä¿®æ”¹ã€‚è¯·æ±‚ä¸€ä¸ªæ–‡ä»¶çš„æµç¨‹å¦‚ä¸‹ï¼š</p><p>ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼š</p><ol><li>å®¢æˆ·ç«¯å‘èµ· HTTP GET è¯·æ±‚ä¸€ä¸ªæ–‡ä»¶ã€‚</li><li>æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œè¿”å›æ–‡ä»¶å†…å®¹ä»¥åŠç›¸åº”çš„ Headerï¼Œå…¶ä¸­åŒ…æ‹¬ Etagï¼ˆä¾‹å¦‚ï¼š627-4d648041f6b80ï¼‰ï¼ˆå‡è®¾æœåŠ¡å™¨æ”¯æŒ Etag ç”Ÿæˆå¹¶å·²å¼€å¯äº† Etagï¼‰çŠ¶æ€ç ä¸º 200ã€‚</li></ol><p>ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰ï¼š</p><ol><li>å®¢æˆ·ç«¯å‘èµ· HTTP GET è¯·æ±‚ä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶å‘é€ If-Rangeï¼ˆè¯¥å¤´çš„å†…å®¹å°±æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶æœåŠ¡å™¨è¿”å›çš„ Etagï¼š627-4d648041f6b80ï¼‰ã€‚</li><li>æœåŠ¡å™¨åˆ¤æ–­æ¥æ”¶åˆ°çš„ Etag å’Œè®¡ç®—å‡ºæ¥çš„ Etag æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œè¿”å›rangeè¿”å›çš„å†…å®¹ï¼Œå“åº”çš„çŠ¶æ€ç ä¸º 206ï¼›å¦åˆ™ï¼ŒçŠ¶æ€ç ä¸º 200ã€‚</li></ol><h1 id="PHPå®ç°"><a href="#PHPå®ç°" class="headerlink" title="PHPå®ç°"></a>PHPå®ç°</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$filename = &apos;1.txt&apos;;</span><br><span class="line">$file = fopen($filename, &apos;r&apos;);</span><br><span class="line">$output = fopen(&apos;php://stdout&apos;, &apos;w&apos;);</span><br><span class="line">$size = filesize($filename);</span><br><span class="line"></span><br><span class="line">if (isset($_SERVER[&apos;HTTP_RANGE&apos;])) &#123;</span><br><span class="line">    // æ–­ç‚¹ç»­ä¼ ï¼Œè·å–ç»­ä¼ çš„å¼€å¤´å’Œç»“å°¾</span><br><span class="line">    $range = str_replace(&apos;bytes=&apos;, &apos;&apos;, $_SERVER[&apos;HTTP_RANGE&apos;]);</span><br><span class="line">    list($start, $end) = explode(&apos;-&apos;, $range);</span><br><span class="line">    $start = empty($start) ? 0 : $start;</span><br><span class="line">    $end = empty($end) ? ($size - 1) : $end;</span><br><span class="line">    $length = $end - $start + 1;</span><br><span class="line">    if ($length &gt;= 0) &#123;</span><br><span class="line">        // è¿”å›æ–­ç‚¹ç»­ä¼ codeåŠç›¸å…³å¤´ä¿¡æ¯</span><br><span class="line">        header(&apos;HTTP/1.1 206 Partial Content&apos;);</span><br><span class="line">        header(&apos;Accept-Ranges: bytes&apos;);</span><br><span class="line">        header(&apos;Last-Modified: &apos;.gmdate(&apos;D, d M Y 01:01:01&apos;, filemtime($filename)).&apos; GMT&apos;);</span><br><span class="line">        header(&apos;Etags: &apos; . fileinode($filename));</span><br><span class="line">        header(&apos;Content-Length:&apos; . $length);</span><br><span class="line">        header(&apos;Content-Range: bytes &apos; . $length . &apos;/&apos; . $size);</span><br><span class="line">        // åç§»æ–‡ä»¶æŒ‡é’ˆè¯»å–å›ºå®šé•¿åº¦è¿”å›</span><br><span class="line">        fseek($file, $start);</span><br><span class="line">        echo fread($file, $length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // éæ–­ç‚¹ç»­ä¼ </span><br><span class="line">    header(&apos;cache-control:public&apos;);</span><br><span class="line">    header(&apos;content-type:application/octet-stream&apos;);</span><br><span class="line">    header(&apos;Content-Length: &apos; . $size);</span><br><span class="line">    header(&apos;Etags: &apos; . fileinode($filename));</span><br><span class="line">    header(&apos;Last-Modified: &apos;.gmdate(&apos;D, d M Y 01:01:01&apos;, filemtime($filename)).&apos; GMT&apos;);</span><br><span class="line">    header(&apos;content-disposition:attachment; filename=&apos; . $filename);</span><br><span class="line">    echo fread($file, $size);</span><br><span class="line">&#125;</span><br><span class="line">fclose($file);</span><br><span class="line">fclose($output);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
          <category> HTTP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> HTTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…è´¹SSLè¯ä¹¦åˆ¶ä½œ-Lets Encrypt</title>
      <link href="/posts/28158/"/>
      <url>/posts/28158/</url>
      
        <content type="html"><![CDATA[<p>è…¾è®¯äº‘ä¸€å¹´çš„å…è´¹SSLè¯ä¹¦åˆ°æœŸäº†ï¼Œåœ¨è€å¤§çš„æ¨èä¸‹çœ‹äº†ä¸€ä¸‹<code>Let&#39;s Encrypt</code> å®¶çš„å…è´¹è¯ä¹¦ï¼Œè™½ç„¶åªæœ‰ä¸‰ä¸ªæœˆï¼Œä½†æ˜¯æ”¯æŒå…è´¹ç»­æœŸï¼Œè€Œä¸”æ”¯æŒé€šé…ç¬¦è¯ä¹¦ï¼Œè¿™å€’æ˜¯å¾ˆå¤§çš„ç¦åˆ©äº†</p><a id="more"></a><p>é¦–å…ˆå£°æ˜ï¼Œæˆ‘çš„ç³»ç»Ÿæ˜¯<code>CentOS7</code> ï¼Œç³»ç»Ÿä¸ä¸€è‡´ï¼Œå¯è‡ªè¡ŒGoogleå…¶ä»–æˆ–ç›´æ¥å®˜ç½‘æ•™ç¨‹<a href="https://certbot.eff.org/lets-encrypt/centosrhel7-nginx" target="_blank" rel="noopener">https://certbot.eff.org/lets-encrypt/centosrhel7-nginx</a></p><h1 id="ä¸‹è½½certbot"><a href="#ä¸‹è½½certbot" class="headerlink" title="ä¸‹è½½certbot"></a>ä¸‹è½½certbot</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://dl.eff.org/certbot-auto</span><br><span class="line">$ chmod +x certbot-auto</span><br></pre></td></tr></table></figure><h1 id="åˆ¶ä½œé€šé…ç¬¦è¯ä¹¦"><a href="#åˆ¶ä½œé€šé…ç¬¦è¯ä¹¦" class="headerlink" title="åˆ¶ä½œé€šé…ç¬¦è¯ä¹¦"></a>åˆ¶ä½œé€šé…ç¬¦è¯ä¹¦</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./certbot-auto certonly  -d &quot;*.example.com&quot; -d &quot;example.com&quot;  --manual --preferred-challenges dns-01  --server https://acme-v02.api.letsencrypt.org/directory</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè‡ªåŠ¨è¿è¡Œyumå®‰è£…å¿…è¦çš„åŒ…ï¼Œç„¶åä¼šæç¤ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Please choose an account</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">1: dev_test@2016-04-18T23:21:19Z (911e)</span><br><span class="line">2: ip-10-164-131-233.ap-southeast-1.compute.internal@2016-06-13T11:02:16Z (5c1b)</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Select the appropriate number [1-2] then [enter] (press &apos;c&apos; to cancel): 1</span><br><span class="line">Obtaining a new certificate</span><br><span class="line">Performing the following challenges:</span><br><span class="line">dns-01 challenge for example.com</span><br><span class="line">dns-01 challenge for example.com</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">NOTE: The IP of this machine will be publicly logged as having requested this</span><br><span class="line">certificate. If you&apos;re running certbot in manual mode on a machine that is not</span><br><span class="line">your server, please ensure you&apos;re okay with that.</span><br><span class="line"></span><br><span class="line">Are you OK with your IP being logged?</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">(Y)es/(N)o: Y</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Please deploy a DNS TXT record under the name</span><br><span class="line">_acme-challenge.example.com with the following value:</span><br><span class="line"></span><br><span class="line">e35fqmCZcB8L56ID4801hlA3aLx3viXtZo1yA3WVSmg</span><br><span class="line"></span><br><span class="line">Before continuing, verify the record is deployed.</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Press Enter to Continue</span><br></pre></td></tr></table></figure><p>éœ€è¦åœ¨åå°åŸŸåè§£æä¹‹åå†æŒ‰Enter</p><p>åˆ¶ä½œå®Œæˆåï¼Œå°†åˆ¶ä½œåçš„è¯ä¹¦æ‹¿è¿‡ç”¨å³å¯</p><p>é…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssl_certificate cert/fullchain1.pem;</span><br><span class="line">ssl_certificate_key cert/privkey1.pem;</span><br><span class="line">ssl_trusted_certificate cert/chain1.pem;</span><br></pre></td></tr></table></figure><p>é‡å¯åå°±èƒ½çœ‹åˆ°HTTPSçš„å®‰å…¨ç»¿è‰²å°çƒäº†</p><h1 id="ç»­æœŸ"><a href="#ç»­æœŸ" class="headerlink" title="ç»­æœŸ"></a>ç»­æœŸ</h1><p>ä¸Šé¢æåˆ°äº†ï¼Œè¿™ä¸ªè¯ä¹¦æœ‰æ•ˆæœŸåªæœ‰ä¸‰ä¸ªæœˆï¼Œæ‰€ä»¥éœ€è¦å®šæ—¶é‡æ–°ç”Ÿæˆæ–°çš„è¯ä¹¦ï¼Œç„¶åå®Œæˆåé‡å¯nginx</p><p>å®Œæ•´å‘½ä»¤ï¼š<code>certbot-auto renew [--cert-name CERTNAME] [options]</code><br>å¯é€‰å‚æ•°ï¼š</p><ul><li><code>--cert-name CERTNAME</code>ï¼šæŒ‡å®šè¦æ›´æ–°çš„è¯ä¹¦ã€‚Certbot ç”¨è¿™ä¸ªåç§°æ¥ç®¡ç†è¯ä¹¦æ–‡ä»¶ã€‚åç§°ä¸å½±å“è¯ä¹¦å†…å®¹ã€‚å¯ä»¥ç”¨ <code>certbot certificates</code> å‘½ä»¤æŸ¥çœ‹è¯ä¹¦åã€‚</li><li><code>--dry-run</code>ï¼šç”¨äºæµ‹è¯•ï¼Œåªè·å–æµ‹è¯•è¯ä¹¦ï¼Œä¸ä¿å­˜è‡³ç£ç›˜ã€‚åªæœ‰ certonly å’Œ renew ä¸¤ä¸ªå­å‘½ä»¤å¯ä»¥ç”¨è¿™ä¸ªå‚æ•°ã€‚ä»ç„¶ä¼šä¼šæ”¹å†™ Apache æˆ– Nginx æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶å¹¶é‡å¯æœåŠ¡å™¨ã€‚ä»ç„¶ä¼šè°ƒç”¨ <code>--pre-hook</code> å’Œ <code>--post-hook</code> å‘½ä»¤ï¼ˆåªè¦å®šä¹‰è¿‡ï¼‰ã€‚åªæ˜¯ä¸å†è°ƒç”¨ <code>--deploy-hook</code> å‘½ä»¤ã€‚</li><li><code>--force-renewal, --renew-by-default</code>ï¼šå¼ºåˆ¶æ›´æ–°åŸŸåçš„è¯ä¹¦ï¼Œå³ä½¿ç¦»è¿‡æœŸæ—¶é—´è¿˜è¿œå¾—å¾ˆã€‚</li><li><code>--allow-subset-of-names</code>ï¼šåœ¨åŸŸåæ‰€æœ‰æƒè®¤è¯æ—¶ï¼Œå³ä½¿è®¤è¯å¤±è´¥ï¼Œä¹Ÿäº§ç”Ÿè¯ä¹¦ã€‚åœ¨æ›´æ–°å¤šä¸ªåŸŸåæ—¶æœ‰æ•ˆï¼Œå› ä¸ºæœ‰å¯èƒ½éƒ¨åˆ†åŸŸåä¸å†æŒ‡å‘å½“å‰ä¸»æœºã€‚æ³¨æ„ï¼šä¸èƒ½å’Œå‚æ•° <code>--csr</code> åŒæ—¶ä½¿ç”¨ã€‚</li><li><code>-q, --quiet</code>ï¼šé™é»˜æ‰§è¡Œã€‚</li><li><code>--debug-challenges</code>ï¼šè°ƒè¯•æ¨¡å¼ï¼Œæäº¤è‡³ CA å‰éœ€è¦ç”¨æˆ·ç¡®è®¤ã€‚</li><li><code>--preferred-challenges</code>ï¼šéªŒè¯åŸŸåæ‰€æœ‰æƒçš„æ–¹å¼ï¼Œâ€dnsâ€ æˆ– â€œtls-sni-01,http,dnsâ€ ç­‰ã€‚æ¯ä¸ªæœåŠ¡å™¨æ’ä»¶æ”¯æŒæœ‰é™ç§ç±»çš„æ–¹å¼ã€‚</li><li><code>--pre-hook PRE_HOOK</code>ï¼šåœ¨è·å–è¯ä¹¦å‰è¦æ‰§è¡Œçš„ shell å‘½ä»¤ã€‚æ¯”å¦‚æš‚æ—¶å…³é—­æœåŠ¡å™¨è½¯ä»¶ä»¥é˜²æ­¢å¯èƒ½çš„å†²çªã€‚åªæœ‰åœ¨è‡ªåŠ¨è·å–/æ›´æ–°è¯ä¹¦æ—¶æ‰ä¼šæ‰§è¡Œã€‚å¦‚æœæ›´æ–°å¤šä¸ªè¯ä¹¦æ—¶ï¼Œåªæ‰§è¡Œç¬¬ä¸€ä¸ªå‘½ä»¤ã€‚</li><li><code>--post-hook POST_HOOK</code>ï¼šåœ¨è·å–è¯ä¹¦åè¦æ‰§è¡Œçš„ shell å‘½ä»¤ã€‚æ¯”å¦‚<strong>éƒ¨ç½²æ–°è¯ä¹¦ï¼Œæˆ–é‡å¯æœåŠ¡å™¨è½¯ä»¶ã€‚</strong>å¦‚æœæ›´æ–°å¤šä¸ªè¯ä¹¦æ—¶ï¼Œåªæ‰§è¡Œç¬¬ä¸€ä¸ªå‘½ä»¤ã€‚</li><li><code>--deploy-hook DEPLOY_HOOK</code>ï¼šæ¯ä¸ªæœ‰æ•ˆçš„è®¤è¯éƒ½ä¼šè§¦å‘ä¸€æ¬¡çš„ shell å‘½ä»¤ã€‚å¯¹è¿™ä¸ªå‘½ä»¤ï¼Œshell å˜é‡ <code>$RENEWED_LINEAGE</code> è¡¨ç¤ºåŒ…å«åŸŸåè¯ä¹¦å’Œç§é’¥çš„é…ç½®ç›®å½•ï¼Œæ¯”å¦‚ <code>/etc/letsencrypt/live/example.com</code>ã€‚<code>$RENEWED_DOMAINS</code> è¡¨ç¤ºç©ºæ ¼åˆ†éš”çš„åˆšæ›´æ–°çš„åŸŸååˆ—è¡¨ï¼Œæ¯”å¦‚ <code>example.com www.example.com</code>ã€‚</li><li><code>--disable-hook-validation</code>ï¼šéªŒè¯ <code>--pre-hook/--post-hook/--deploy-hook</code> çš„ shell å‘½ä»¤æ˜¯å¦æœ‰æ•ˆï¼Œæå‰å‘ç°é”™è¯¯ã€‚</li><li><code>--no-directory-hooks</code>ï¼šæ›´æ–°è¯ä¹¦æ—¶ä¸æ‰§è¡Œ hook ç›®å½•ä¸­çš„å‘½ä»¤ã€‚</li></ul><p>å†™ä¸ªè„šæœ¬åŠ å…¥åˆ°å®šæ—¶ä»»åŠ¡é‡Œé¢å³å¯</p>]]></content>
      
      
      <categories>
          
          <category> SSL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPæ€§èƒ½åˆ†æå·¥å…·xhgui+tidewayså®è·µ</title>
      <link href="/posts/7748/"/>
      <url>/posts/7748/</url>
      
        <content type="html"><![CDATA[<p>è‡ªä»çº¿ä¸Šæ¥å£æŠ¥å†…å­˜æº¢å‡ºçš„é—®é¢˜åï¼Œå°±ä¸€ç›´æƒ³æ­å»ºä¸€ä¸ªæ€§èƒ½åˆ†æçš„å¹³å°ï¼Œä½†åæ¥ä¸€ç›´æ²¡æœ‰æ—¶é—´ï¼ŒçŸ¥é“åæ¥å‡ºç°äº†æ¥å£è°ƒç”¨æ—¶é—´è¿‡é•¿ï¼Œæ‰å°†è¿™ä¸ªä»»åŠ¡æä¸Šè®®ç¨‹ã€‚</p><p>æˆ‘åŒäº‹å…ˆå‰æ‰€åœ¨çš„éƒ¨é—¨ä½¿ç”¨äº†<code>xhprof</code>  + <code>xhgui</code> çš„å¤„ç†æ–¹å¼ï¼Œä½†æ˜¯ç ”ç©¶åå‘ç° <code>xhprof</code> åªæ”¯æŒåˆ°php5.6ï¼Œæ— å¥ˆæ”¾å¼ƒäº†ï¼ŒåŒæ—¶ï¼Œè™½ç„¶ <code>tideways</code> è‡ªå·±ä¹Ÿæä¾›äº†UIï¼Œä½†æ˜¯ç‚«é…·çš„éƒ½æ˜¯è¦æ”¶è´¹çš„ï¼Œç»¼åˆè€ƒè™‘åï¼Œé€‰ç”¨äº† <code>tideways</code> + <code>xhgui</code>  çš„è§£å†³æ–¹æ¡ˆ</p><a id="more"></a><h1 id="å®‰è£…Tideways"><a href="#å®‰è£…Tideways" class="headerlink" title="å®‰è£…Tideways"></a>å®‰è£…Tideways</h1><h2 id="å®‰è£…PHPåŠæ‰©å±•"><a href="#å®‰è£…PHPåŠæ‰©å±•" class="headerlink" title="å®‰è£…PHPåŠæ‰©å±•"></a>å®‰è£…PHPåŠæ‰©å±•</h2><p>åœ¨<code>https://webtatic.com/</code> æœ‰æ¯ä¸ªç‰ˆæœ¬çš„phpçš„æºï¼Œè¿™é‡Œå°±ç®€å•è¿‡ä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class="line">yum install php72w* --skip-broken</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…Tideways-1"><a href="#å®‰è£…Tideways-1" class="headerlink" title="å®‰è£…Tideways"></a>å®‰è£…Tideways</h2><p>æˆ‘è¿™é‡Œå­˜æ”¾æºç çš„ç›®å½•æ˜¯ <code>/data/local/</code> ä¸‹ï¼Œç›®å½•æ˜¯ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“çš„ï¼Œphpizeç¼–è¯‘å®Œæ‰©å±•åä¼šè‡ªåŠ¨æ‹·è´åˆ°phpçš„moduleså¯¹åº”çš„ç›®å½•çš„ï¼Œ æ‹·è´å‘½ä»¤è¯·å»é™¤æ³¨é‡Š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/tideways/php-xhprof-extension.git   // å…‹éš†ä¸‹gitæ–‡ä»¶</span><br><span class="line">cd php-xhprof-extension </span><br><span class="line">phpize  // ç”Ÿæˆconfigureæ–‡ä»¶</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install  // å®‰è£…</span><br><span class="line"></span><br><span class="line">// å¼€å¯phpæ‰©å±•</span><br><span class="line">echo &apos;</span><br><span class="line">; enable tideways_xhprof</span><br><span class="line">extension=tideways_xhprof.so</span><br><span class="line">tideways.auto_prepend_library=0&apos; &gt; /etc/php.d/tideways_xhprof.ini</span><br><span class="line"></span><br><span class="line">// é‡å¯php-fpm</span><br><span class="line">service php-fpm restart</span><br></pre></td></tr></table></figure><h1 id="å®‰è£…xhgui"><a href="#å®‰è£…xhgui" class="headerlink" title="å®‰è£…xhgui"></a>å®‰è£…xhgui</h1><p>è¿™ä¸ªé¡¹ç›®æ”¾åˆ°ä¸€ä¸ªwebå¯è®¿é—®çš„è·¯å¾„ï¼Œè¿™ä¸ªæœ€ç»ˆæ˜¯é€šè¿‡æµè§ˆå™¨å±•ç¤ºçš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/laynefyc/xhgui-branch.git // æ±‰åŒ–ç‰ˆ</span><br><span class="line">// git clone https://github.com/perftools/xhgui.git  // åŸç‰ˆ</span><br><span class="line">mv xhgui-branch xhgui</span><br><span class="line">cd xhgui</span><br><span class="line">chmod 777 cache // æŠŠcacheç›®å½•ç»™ä¸ä»£ç å¯è¯»å†™çš„æƒé™</span><br><span class="line">php install.php  // å®‰è£…xhgui</span><br></pre></td></tr></table></figure><h1 id="å®‰è£…MongoDB"><a href="#å®‰è£…MongoDB" class="headerlink" title="å®‰è£…MongoDB"></a>å®‰è£…MongoDB</h1><h2 id="å®‰è£…MongoDB-1"><a href="#å®‰è£…MongoDB-1" class="headerlink" title="å®‰è£…MongoDB"></a>å®‰è£…MongoDB</h2><p>åˆ›å»º <code>/etc/yum.repos.d/mongo.repo</code> æ–‡ä»¶ï¼Œ å†…å®¹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mongodb-org-4.0]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨yumå®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mongodb-org</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mongod start</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ ç´¢å¼•"><a href="#æ·»åŠ ç´¢å¼•" class="headerlink" title="æ·»åŠ ç´¢å¼•"></a>æ·»åŠ ç´¢å¼•</h2><p>tidewaysä¼šå°†ç»“æœé›†å­˜æ”¾åœ¨MongoDBä¸­ï¼Œå½“ç„¶æ˜¯å¯ä»¥é€‰æ‹©çš„ï¼Œæƒè¡¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨MongoDB</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br><span class="line">&gt; use xhprof</span><br><span class="line">&gt; db.results.ensureIndex( &#123; &apos;meta.SERVER.REQUEST_TIME&apos; : -1 &#125; )</span><br><span class="line">&gt; db.results.ensureIndex( &#123; &apos;profile.main().wt&apos; : -1 &#125; )</span><br><span class="line">&gt; db.results.ensureIndex( &#123; &apos;profile.main().mu&apos; : -1 &#125; )</span><br><span class="line">&gt; db.results.ensureIndex( &#123; &apos;profile.main().cpu&apos; : -1 &#125; )</span><br><span class="line">&gt; db.results.ensureIndex( &#123; &apos;meta.url&apos; : 1 &#125; )</span><br><span class="line">&gt; db.results.ensureIndex( &#123; &apos;meta.simple_url&apos; : 1 &#125; )</span><br></pre></td></tr></table></figure><h1 id="æ•´åˆTidewayså’ŒXhguiåˆ°é¡¹ç›®"><a href="#æ•´åˆTidewayså’ŒXhguiåˆ°é¡¹ç›®" class="headerlink" title="æ•´åˆTidewayså’ŒXhguiåˆ°é¡¹ç›®"></a>æ•´åˆTidewayså’ŒXhguiåˆ°é¡¹ç›®</h1><h2 id="æ•´åˆä»£ç "><a href="#æ•´åˆä»£ç " class="headerlink" title="æ•´åˆä»£ç "></a>æ•´åˆä»£ç </h2><p>æ±‰åŒ–ç‰ˆxhguiçš„ä½œè€…æ˜¯å»ºè®®å¦‚ä¸‹ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name site.localhost;</span><br><span class="line">  root /Users/markstory/Sites/awesome-thing/app/webroot/;  // æ±‰åŒ–xhguiä½œè€…çš„ç›®å½•ï¼Œä»…æ‹·è´</span><br><span class="line">  fastcgi_param PHP_VALUE &quot;auto_prepend_file=/Users/markstory/Sites/xhgui/external/header.php&quot;; // æ±‰åŒ–xhguiä½œè€…çš„ç›®å½•ï¼Œä»…æ‹·è´</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ä½ çš„éœ€è¦åšæ€§èƒ½ç›‘æ§çš„webæœåŠ¡çš„nginxçš„é…ç½®</p><p>ä½†æ˜¯ï¼Œæˆ‘åœ¨è¿™æ ·ä½¿ç”¨çš„æ—¶å€™ï¼Œphp-fpmåœ¨æˆ‘è°ƒç”¨çš„æ¥å£çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨æŒ‚æ‰ï¼Œç„¶åçœ‹äº†ä¸€ä¸‹æ–‡ä»¶ <code>xhgui/external/header.php</code> ï¼Œ åœ¨è¿™ä¸ªé‡Œé¢ï¼Œä½œè€…æ³¨å†Œäº†<code>register_shutdown_function</code> å‡½æ•°ï¼Œæˆ‘ä½¿ç”¨çš„æ¡†æ¶æ˜¯Yii2ï¼Œå…¶æ¬¡ï¼Œé‡Œé¢è¿˜ä¼šåšåˆ¤æ–­å„ç§æ‰©å±•åŠå­˜å‚¨æ–¹æ¡ˆï¼Œè¿™ä¸ªå¯¹äºæˆ‘å·²ç»ç¡®å®šäº†æ–¹æ¡ˆçš„ç”¨æˆ·æ¥è¯´ï¼Œè¿™ç§åˆ¤æ–­æ˜¯æ²¡ç”¨çš„ï¼Œç›¸å¯¹è¿˜è¦æ¶ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥è¿™é‡Œæ ¹æ®header.phpçš„é€»è¾‘ï¼Œç›´æ¥å†™å…¥ä»£ç </p><p>åœ¨beforeActionä¸­åŠ å…¥ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">private function startXhprof()</span><br><span class="line">&#123;</span><br><span class="line">    $dir = &apos;/data/www/html/xhgui&apos;;</span><br><span class="line">    // Use the callbacks defined in the configuration file</span><br><span class="line">    // to determine whether or not XHgui should enable profiling.</span><br><span class="line">    //</span><br><span class="line">    // Only load the config class so we don&apos;t pollute the host application&apos;s</span><br><span class="line">    // autoloaders.</span><br><span class="line">    require_once $dir . &apos;/src/Xhgui/Config.php&apos;;</span><br><span class="line">    \Xhgui_Config::load($dir . &apos;/config/config.default.php&apos;);</span><br><span class="line">    if (file_exists($dir . &apos;/config/config.php&apos;)) &#123;</span><br><span class="line">        \Xhgui_Config::load($dir . &apos;/config/config.php&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filterPath = \Xhgui_Config::read(&apos;profiler.filter_path&apos;);</span><br><span class="line">    if(is_array($filterPath)&amp;&amp;in_array($_SERVER[&apos;DOCUMENT_ROOT&apos;],$filterPath))&#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!isset($_SERVER[&apos;REQUEST_TIME_FLOAT&apos;])) &#123;</span><br><span class="line">        $_SERVER[&apos;REQUEST_TIME_FLOAT&apos;] = microtime(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tideways_xhprof_enable(TIDEWAYS_XHPROF_FLAGS_MEMORY | TIDEWAYS_XHPROF_FLAGS_MEMORY_MU | TIDEWAYS_XHPROF_FLAGS_MEMORY_PMU | TIDEWAYS_XHPROF_FLAGS_CPU);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function beforeAction($action)</span><br><span class="line">&#123;</span><br><span class="line">  $this-&gt;startXhprof();</span><br><span class="line">  return parent::beforeAction($action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>afterAction</code> ä¸­è·å–åˆ†ææ•°æ®å¹¶å­˜å…¥MongoDB</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">private function stopXhprof()</span><br><span class="line">&#123;</span><br><span class="line">    $data[&apos;profile&apos;] = tideways_xhprof_disable();</span><br><span class="line">    </span><br><span class="line">    // ignore_user_abort(true) allows your PHP script to continue executing, even if the user has terminated their request.</span><br><span class="line">    // Further Reading: http://blog.preinheimer.com/index.php?/archives/248-When-does-a-user-abort.html</span><br><span class="line">    // flush() asks PHP to send any data remaining in the output buffers. This is normally done when the script completes, but</span><br><span class="line">    // since we&apos;re delaying that a bit by dealing with the xhprof stuff, we&apos;ll do it now to avoid making the user wait.</span><br><span class="line">    ignore_user_abort(true);</span><br><span class="line">    flush();</span><br><span class="line">    </span><br><span class="line">    if (!defined(&apos;XHGUI_ROOT_DIR&apos;)) &#123;</span><br><span class="line">        require &apos;/data/www/html/xhgui/src/bootstrap.php&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $uri = array_key_exists(&apos;REQUEST_URI&apos;, $_SERVER)</span><br><span class="line">        ? $_SERVER[&apos;REQUEST_URI&apos;]</span><br><span class="line">        : null;</span><br><span class="line">    if (empty($uri) &amp;&amp; isset($_SERVER[&apos;argv&apos;])) &#123;</span><br><span class="line">        $cmd = basename($_SERVER[&apos;argv&apos;][0]);</span><br><span class="line">        $uri = $cmd . &apos; &apos; . implode(&apos; &apos;, array_slice($_SERVER[&apos;argv&apos;], 1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $time = array_key_exists(&apos;REQUEST_TIME&apos;, $_SERVER)</span><br><span class="line">        ? $_SERVER[&apos;REQUEST_TIME&apos;]</span><br><span class="line">        : time();</span><br><span class="line">    $requestTimeFloat = explode(&apos;.&apos;, $_SERVER[&apos;REQUEST_TIME_FLOAT&apos;]);</span><br><span class="line">    if (!isset($requestTimeFloat[1])) &#123;</span><br><span class="line">        $requestTimeFloat[1] = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $requestTs = new \MongoDate($time);</span><br><span class="line">    $requestTsMicro = new \MongoDate($requestTimeFloat[0], $requestTimeFloat[1]);</span><br><span class="line"></span><br><span class="line">    $data[&apos;meta&apos;] = array(</span><br><span class="line">        &apos;url&apos; =&gt; $uri,</span><br><span class="line">        &apos;SERVER&apos; =&gt; $_SERVER,</span><br><span class="line">        &apos;get&apos; =&gt; $_GET,</span><br><span class="line">        &apos;env&apos; =&gt; $_ENV,</span><br><span class="line">        &apos;simple_url&apos; =&gt; \Xhgui_Util::simpleUrl($uri),</span><br><span class="line">        &apos;request_ts&apos; =&gt; $requestTs,</span><br><span class="line">        &apos;request_ts_micro&apos; =&gt; $requestTsMicro,</span><br><span class="line">        &apos;request_date&apos; =&gt; date(&apos;Y-m-d&apos;, $time),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        $config = \Xhgui_Config::all();</span><br><span class="line">        $config += array(&apos;db.options&apos; =&gt; array());</span><br><span class="line">        $saver = \Xhgui_Saver::factory($config);</span><br><span class="line">        $saver-&gt;save($data);</span><br><span class="line">    &#125; catch (\Exception $e) &#123;</span><br><span class="line">        error_log(&apos;xhgui - &apos; . $e-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function afterAction($action, $result)</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;stopXhprof();</span><br><span class="line">    return parent::afterAction($action, $result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•´ç†nginx"><a href="#æ•´ç†nginx" class="headerlink" title="æ•´ç†nginx"></a>æ•´ç†nginx</h2><p>æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªserverï¼ŒæŒ‡å‘<code>xhgui/webroot/</code> ç›®å½•ï¼Œç”¨äºå±•ç¤º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  xx.xxx.com;</span><br><span class="line">    root  /data/www/html/xhgui/webroot;   //æŒ‡å‘è‡ªèº«çš„ç›®å½•</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index  index.php;</span><br><span class="line">        if (!-e $request_filename) &#123;</span><br><span class="line">            rewrite . /index.php last;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"># ä¸‹é¢è¿™æ®µå¯æ ¹æ®è‡ªèº«é…ç½®çš„phpè§£æè¿›è¡Œç›¸åº”çš„ä¿®æ”¹</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œè®¿é—®é…ç½®çš„åŸŸåå°±å¯ä»¥çœ‹åˆ°æ€§èƒ½åˆ†æå¹³å°äº†</p><h1 id="å¼‚å¸¸"><a href="#å¼‚å¸¸" class="headerlink" title="å¼‚å¸¸"></a>å¼‚å¸¸</h1><p>æœ‰å¯èƒ½ä½ ä¼šé‡åˆ°å¦‚ä¸‹çš„é—®é¢˜</p><p><img src="http://github-1253518569.cossh.myqcloud.com/mongo-exception.png" alt="mongoå¼‚å¸¸"></p><p>ä¿®æ”¹ <code>/path/to/xhgui/src/Xhgui/Profiles.php</code> çš„<strong>aggregate</strong> çš„ä¼ å‚ï¼Œçº¦172è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">137         $results = $this-&gt;_collection-&gt;aggregate(array(</span><br><span class="line">138             array(&apos;$match&apos; =&gt; $match),</span><br><span class="line">139             array(</span><br><span class="line">140                 &apos;$project&apos; =&gt; array(</span><br><span class="line">141                     &apos;date&apos; =&gt; $col,</span><br><span class="line">142                     &apos;profile.main()&apos; =&gt; 1</span><br><span class="line">143                 )</span><br><span class="line">144             ),</span><br><span class="line">145             array(</span><br><span class="line">146                 &apos;$group&apos; =&gt; array(</span><br><span class="line">147                     &apos;_id&apos; =&gt; &apos;$date&apos;,</span><br><span class="line">148                     &apos;row_count&apos; =&gt; array(&apos;$sum&apos; =&gt; 1),</span><br><span class="line">149                     &apos;wall_times&apos; =&gt; array(&apos;$push&apos; =&gt; &apos;$profile.main().wt&apos;),</span><br><span class="line">150                     &apos;cpu_times&apos; =&gt; array(&apos;$push&apos; =&gt; &apos;$profile.main().cpu&apos;),</span><br><span class="line">151                     &apos;mu_times&apos; =&gt; array(&apos;$push&apos; =&gt; &apos;$profile.main().mu&apos;),</span><br><span class="line">152                     &apos;pmu_times&apos; =&gt; array(&apos;$push&apos; =&gt; &apos;$profile.main().pmu&apos;),</span><br><span class="line">153                 )</span><br><span class="line">154             ),</span><br><span class="line">155             array(</span><br><span class="line">156                 &apos;$project&apos; =&gt; array(</span><br><span class="line">157                     &apos;date&apos; =&gt; &apos;$date&apos;,</span><br><span class="line">158                     &apos;row_count&apos; =&gt; &apos;$row_count&apos;,</span><br><span class="line">159                     &apos;raw_index&apos; =&gt; array(</span><br><span class="line">160                         &apos;$multiply&apos; =&gt; array(</span><br><span class="line">161                             &apos;$row_count&apos;,</span><br><span class="line">162                             $percentile / 100</span><br><span class="line">163                         )</span><br><span class="line">164                     ),</span><br><span class="line">165                     &apos;wall_times&apos; =&gt; &apos;$wall_times&apos;,</span><br><span class="line">166                     &apos;cpu_times&apos; =&gt; &apos;$cpu_times&apos;,</span><br><span class="line">167                     &apos;mu_times&apos; =&gt; &apos;$mu_times&apos;,</span><br><span class="line">168                     &apos;pmu_times&apos; =&gt; &apos;$pmu_times&apos;,</span><br><span class="line">169                 )</span><br><span class="line">170             ),</span><br><span class="line">171             array(&apos;$sort&apos; =&gt; array(&apos;_id&apos; =&gt; 1)),</span><br><span class="line">172         )</span><br><span class="line">173,array(&apos;cursor&apos; =&gt; array(&apos;batchSize&apos; =&gt; 0)));</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git mergeå’Œgit merge --no-ffçš„åŒºåˆ«</title>
      <link href="/posts/132/"/>
      <url>/posts/132/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å¾ˆå¤šä»‹ç»GItFlowå·¥ä½œæµçš„æ–‡ç« é‡Œé¢ï¼Œéƒ½ä¼šæ¨èåœ¨åˆå¹¶åˆ†æ”¯çš„æ—¶å€™åŠ ä¸Š<code>--no-ff</code>å‚æ•°ï¼Œ è€Œæˆ‘ä»¬åœ¨åˆå¹¶çš„æ—¶å€™ï¼Œæœ‰æ—¶gitä¹Ÿä¼šæç¤º ä½¿ç”¨äº† <strong>fast-forward</strong>ï¼Œ è¿™é‡Œæˆ‘å°†ä»‹ç»ä¸€ä¸‹<code>merge</code>çš„ä¸‰ç§çŠ¶æ€åŠ <code>git merge</code> å’Œ <code>git merge --no-ff</code> çš„åŒºåˆ«</p><a id="more"></a><p>Git mergeçš„æ—¶å€™ï¼Œæœ‰å‡ ç§åˆå¹¶æ–¹å¼å¯ä»¥é€‰æ‹©</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--ff</span><br><span class="line">When the merge resolves as a fast-forward, only update the branch pointer, without creating a merge commit. This is the default behavior.</span><br><span class="line"></span><br><span class="line">--no-ff</span><br><span class="line">Create a merge commit even when the merge resolves as a fast-forward. This is the default behaviour when merging an annotated (and possibly signed) tag.</span><br><span class="line"></span><br><span class="line">--squash</span><br><span class="line">--no-squash</span><br><span class="line">Produce the working tree and index state as if a real merge happened (except for the merge information), but do not actually make a commit, move the HEAD, or record $GIT_DIR/MERGE_HEAD (to cause the next git commit command to create a merge commit). This allows you to create a single commit on top of the current branch whose effect is the same as merging another branch (or more in case of an octopus).</span><br><span class="line"></span><br><span class="line">With --no-squash perform the merge and commit the result. This option can be used to override --squash.</span><br></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬å¹³å¸¸ä»€ä¹ˆéƒ½ä¸åŠ çš„æ—¶å€™ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ <code>--ff</code> ï¼Œ å³ <strong>fast-forward</strong> æ–¹å¼</p><p>çœ‹è¿‡å®˜æ–¹æ³¨é‡Šåï¼Œæˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥ç®€å•æç”»ä¸€ä¸‹ç›¸åº”çš„è¡Œä¸º</p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/2018-09-18_200521.png" alt="merge"></p><ol><li><p>fast-forward</p><p><strong>Git åˆå¹¶ä¸¤ä¸ªåˆ†æ”¯æ—¶ï¼Œå¦‚æœé¡ºç€ä¸€ä¸ªåˆ†æ”¯èµ°ä¸‹å»å¯ä»¥åˆ°è¾¾å¦ä¸€ä¸ªåˆ†æ”¯çš„è¯ï¼Œé‚£ä¹ˆ Git åœ¨åˆå¹¶ä¸¤è€…æ—¶ï¼Œåªä¼šç®€å•åœ°æŠŠæŒ‡é’ˆå³ç§»ï¼Œå«åšâ€œå¿«è¿›â€ï¼ˆfast-forwardï¼‰ä¸è¿‡è¿™ç§æƒ…å†µå¦‚æœåˆ é™¤åˆ†æ”¯ï¼Œåˆ™ä¼šä¸¢å¤±mergeåˆ†æ”¯ä¿¡æ¯ã€‚</strong></p></li><li><p>â€“squash</p><p><strong>æŠŠä¸€äº›ä¸å¿…è¦commitè¿›è¡Œå‹ç¼©ï¼Œæ¯”å¦‚è¯´ï¼Œä½ çš„featureåœ¨å¼€å‘çš„æ—¶å€™å†™çš„commitå¾ˆä¹±ï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆå¹¶çš„æ—¶å€™ä¸å¸Œæœ›æŠŠè¿™äº›å†å²commitå¸¦è¿‡æ¥ï¼Œäºæ˜¯ä½¿ç”¨â€“squashè¿›è¡Œåˆå¹¶ï¼Œæ­¤æ—¶æ–‡ä»¶å·²ç»åŒåˆå¹¶åä¸€æ ·äº†ï¼Œä½†ä¸ç§»åŠ¨HEADï¼Œä¸æäº¤ã€‚éœ€è¦è¿›è¡Œä¸€æ¬¡é¢å¤–çš„commitæ¥â€œæ€»ç»“â€ä¸€ä¸‹ï¼Œç„¶åå®Œæˆæœ€ç»ˆçš„åˆå¹¶ã€‚</strong></p></li><li><p>â€“no-ff</p><p><strong>å…³é—­fast-forwardæ¨¡å¼ï¼Œåœ¨æäº¤çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªmergeçš„commitä¿¡æ¯ï¼Œç„¶ååˆå¹¶çš„å’Œmasteråˆ†æ”¯</strong></p></li></ol><p>mergeçš„ä¸åŒè¡Œä¸ºï¼Œå‘åçœ‹ï¼Œå…¶å®æœ€ç»ˆéƒ½ä¼šå°†ä»£ç åˆå¹¶åˆ°masteråˆ†æ”¯ï¼Œè€ŒåŒºåˆ«ä»…ä»…åªæ˜¯åˆ†æ”¯ä¸Šçš„ç®€æ´æ¸…æ™°çš„é—®é¢˜ï¼Œç„¶åï¼Œå‘å‰çœ‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨<code>reset</code> çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°ï¼Œä¸åŒçš„è¡Œä¸ºå°±å¸¦æ¥äº†ä¸åŒçš„å½±å“</p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/2018-09-18_201744.png" alt="https://github-1253518569.cos.ap-shanghai.myqcloud.com/2018-09-18_201744.png"></p><p>ä¸Šå›¾æ˜¯ä½¿ç”¨ <code>merge --no-ff</code>çš„æ—¶å€™çš„æ•ˆæœï¼Œæ­¤æ—¶<code>git reset HEAD^ --hard</code> çš„æ—¶å€™ï¼Œæ•´ä¸ªåˆ†æ”¯ä¼šå›é€€åˆ°  <strong>dev2-commit-2</strong></p><p><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/2018-09-18_201755.png" alt=" dev3-commit-1"></p><p>ä¸Šå›¾æ˜¯ä½¿ç”¨ <strong>fast-forward</strong> æ¨¡å¼çš„æ—¶å€™ï¼Œå³ <code>git merge</code> ï¼Œè¿™æ—¶å€™ <code>git reset HEAD^ --hard</code>ï¼Œæ•´ä¸ªåˆ†æ”¯ä¼šå›é€€åˆ° <strong>dev1-commit-3</strong></p><p>é€šå¸¸æˆ‘ä»¬æŠŠ master ä½œä¸ºä¸»åˆ†æ”¯ï¼Œä¸Šé¢å­˜æ”¾çš„éƒ½æ˜¯æ¯”è¾ƒç¨³å®šçš„ä»£ç ï¼Œæäº¤é¢‘ç‡ä¹Ÿå¾ˆä½ï¼Œè€Œ develop æ˜¯ç”¨æ¥å¼€å‘ç‰¹æ€§çš„ï¼Œä¸Šé¢ä¼šå­˜åœ¨è®¸å¤šé›¶ç¢çš„æäº¤ï¼Œå¿«è¿›å¼åˆå¹¶ä¼šæŠŠ develop çš„æäº¤å†å²æ··å…¥åˆ° master ä¸­ï¼Œæ…ä¹± master çš„æäº¤å†å²ã€‚æ‰€ä»¥å¦‚æœä½ æ ¹æœ¬ä¸åœ¨æ„æäº¤å†å²ï¼Œä¹Ÿä¸çˆ±ç®¡ master å¹²ä¸å¹²å‡€ï¼Œé‚£ä¹ˆ â€“no-ff å…¶å®æ²¡ä»€ä¹ˆç”¨ã€‚ä¸è¿‡ï¼Œå¦‚æœæŸä¸€æ¬¡ master å‡ºç°äº†é—®é¢˜ï¼Œä½ éœ€è¦å›é€€åˆ°ä¸Šä¸ªç‰ˆæœ¬çš„æ—¶å€™ï¼Œæ¯”å¦‚ä¸Šä¾‹ï¼Œä½ å°±ä¼šå‘ç°é€€ä¸€ä¸ªç‰ˆæœ¬åˆ°äº† commint-3ï¼Œè€Œä¸æ˜¯æƒ³è¦çš„ commit-2ï¼Œå› ä¸º feature çš„å†å²åˆå¹¶è¿›äº† master é‡Œã€‚è¿™ä¹Ÿå°±æ˜¯å¾ˆå¤šäººéƒ½ä¼šæ¨è â€“no-ff çš„åŸå› äº†å§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> GIT </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GIT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpçš„åƒåœ¾å›æ”¶æœºåˆ¶</title>
      <link href="/posts/13507/"/>
      <url>/posts/13507/</url>
      
        <content type="html"><![CDATA[<p>æ¯ä¸ªphpå˜é‡å­˜åœ¨ä¸€ä¸ªå«â€zvalâ€çš„å˜é‡å®¹å™¨ä¸­ã€‚ä¸€ä¸ªzvalå˜é‡å®¹å™¨ï¼Œé™¤äº†åŒ…å«å˜é‡çš„ç±»å‹å’Œå€¼ï¼Œè¿˜åŒ…æ‹¬ä¸¤ä¸ªå­—èŠ‚çš„é¢å¤–ä¿¡æ¯ã€‚ç¬¬ä¸€ä¸ªæ˜¯â€is_refâ€ï¼Œæ˜¯ä¸ªboolå€¼ï¼Œç”¨æ¥æ ‡è¯†è¿™ä¸ªå˜é‡æ˜¯å¦æ˜¯å±äºå¼•ç”¨é›†åˆ(reference set)ã€‚é€šè¿‡è¿™ä¸ªå­—èŠ‚ï¼Œphpå¼•æ“æ‰èƒ½æŠŠæ™®é€šå˜é‡å’Œå¼•ç”¨å˜é‡åŒºåˆ†å¼€æ¥ï¼Œç”±äºphpå…è®¸ç”¨æˆ·é€šè¿‡ä½¿ç”¨&amp;æ¥ä½¿ç”¨è‡ªå®šä¹‰å¼•ç”¨ï¼Œzvalå˜é‡å®¹å™¨ä¸­è¿˜æœ‰ä¸€ä¸ªå†…éƒ¨å¼•ç”¨è®¡æ•°æœºåˆ¶ï¼Œæ¥ä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚ç¬¬äºŒä¸ªé¢å¤–å­—èŠ‚æ˜¯â€refcountâ€ï¼Œç”¨ä»¥è¡¨ç¤ºæŒ‡å‘è¿™ä¸ªzvalå˜é‡å®¹å™¨çš„å˜é‡(ä¹Ÿç§°ç¬¦å·å³symbol)ä¸ªæ•°ã€‚æ‰€æœ‰çš„ç¬¦å·å­˜åœ¨ä¸€ä¸ªç¬¦å·è¡¨ä¸­ï¼Œå…¶ä¸­æ¯ä¸ªç¬¦å·éƒ½æœ‰ä½œç”¨åŸŸ(scope)ï¼Œé‚£äº›ä¸»è„šæœ¬(æ¯”å¦‚ï¼šé€šè¿‡æµè§ˆå™¨è¯·æ±‚çš„çš„è„šæœ¬)å’Œæ¯ä¸ªå‡½æ•°æˆ–è€…æ–¹æ³•ä¹Ÿéƒ½æœ‰ä½œç”¨åŸŸã€‚ </p><a id="more"></a><p>PHPæ˜¯ä¸€ç§å¼±ç±»å‹çš„è„šæœ¬è¯­è¨€ï¼Œå¼±ç±»å‹ä¸è¡¨ç¤ºPHPå˜é‡æ²¡æœ‰ç±»å‹çš„åŒºåˆ«ï¼ŒPHPå˜é‡æœ‰8ç§åŸå§‹ç±»å‹ï¼š<br>å››ç§æ ‡é‡ç±»å‹ï¼š</p><ul><li>booleanï¼ˆå¸ƒå°”å€¼ï¼‰</li><li>integerï¼ˆæ•´å‹ï¼‰</li><li>floatï¼ˆæµ®ç‚¹å‹ï¼‰</li><li>string ï¼ˆå­—ç¬¦ä¸²ï¼‰</li></ul><p>ä¸¤ç§å¤åˆç±»å‹ï¼š</p><ul><li>arrayï¼ˆæ•°ç»„ï¼‰</li><li>objectï¼ˆå¯¹è±¡ï¼‰</li></ul><p>ä¸¤ç§ç‰¹æ®Šç±»å‹ï¼š</p><ul><li>resourceï¼ˆèµ„æºï¼‰</li><li>NULL</li></ul><hr><p>åœ¨å¼•æ“å†…éƒ¨ï¼Œå˜é‡éƒ½æ˜¯ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥è¡¨ç¤ºçš„ã€‚è¿™ä¸ªç»“æ„ä½“å¯ä»¥åœ¨{PHPSRC}/Zend/zend.hä¸­æ‰¾åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct _zval_struct &#123;  </span><br><span class="line">     /* Variable information */  </span><br><span class="line">     zvalue_value value;     /* value */  </span><br><span class="line">     zend_uint refcount__gc;  //ä»£è¡¨ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè¡¨ç¤ºæœ‰å¤šå°‘ä¸ªå˜é‡åæŒ‡å‘è¿™ä¸ªzvalå®¹å™¨</span><br><span class="line">     zend_uchar type;    /* active type */  </span><br><span class="line">     zend_uchar is_ref__gc;  //æ­¤å­—æ®µæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨æ¥æ ‡è¯†å˜é‡æ˜¯å¦æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œé€šè¿‡è¿™ä¸ªå­—æ®µï¼ŒPHPå¼•æ“å¯ä»¥åŒºåˆ†ä¸€èˆ¬å˜é‡å’Œå¼•ç”¨å˜é‡</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><h2 id="copy-on-writeï¼ˆå†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼‰"><a href="#copy-on-writeï¼ˆå†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼‰" class="headerlink" title="copy on writeï¼ˆå†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼‰"></a>copy on writeï¼ˆå†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼‰</h2><blockquote><p>çˆ¶è¿›ç¨‹forkå­è¿›ç¨‹ä¹‹åï¼Œå­è¿›ç¨‹çš„åœ°å€ç©ºé—´è¿˜æ˜¯ç®€å•çš„æŒ‡å‘çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œåªæœ‰å½“å­è¿›ç¨‹éœ€è¦å†™åœ°å€ç©ºé—´ä¸­çš„å†…å®¹çš„æ—¶å€™ï¼Œæ‰ä¼šå•ç‹¬åˆ†ç¦»ä¸€ä»½ç»™å­è¿›ç¨‹ï¼Œè¿™æ ·å°±ç®—å­è¿›ç¨‹é©¬ä¸Šè°ƒç”¨execå‡½æ•°ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºæ ¹æœ¬å°±ä¸éœ€è¦ä»çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­æ‹·è´å†…å®¹ï¼Œè¿™æ ·å°±èŠ‚çœäº†å†…å­˜åŒæ—¶åˆæé«˜äº†é€Ÿåº¦ã€‚</p><p>è¿™ä¸ªé€»è¾‘å¯ä»¥å™è¿°ä¸ºï¼šå¯¹ä¸€ä¸ªä¸€èˆ¬å˜é‡aï¼ˆisref=0ï¼‰è¿›è¡Œä¸€èˆ¬çš„èµ‹å€¼æ“ä½œï¼Œå¦‚æœaæ‰€æŒ‡å‘çš„zvalçš„è®¡æ•°refcountå¤§äº1ï¼Œé‚£ä¹ˆéœ€è¦ä¸ºaé‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„zvalï¼Œå¹¶ä¸”æŠŠä¹‹å‰çš„zvalçš„è®¡æ•°refcountå‡å°‘1ã€‚</p></blockquote><h2 id="PHP5-3ç‰ˆæœ¬ä¸­å¯¹äºæ–°çš„GCç®—æ³•ï¼ˆConcurrent-Cycle-Collection-in-Reference-Counted-Systemsï¼‰"><a href="#PHP5-3ç‰ˆæœ¬ä¸­å¯¹äºæ–°çš„GCç®—æ³•ï¼ˆConcurrent-Cycle-Collection-in-Reference-Counted-Systemsï¼‰" class="headerlink" title="PHP5.3ç‰ˆæœ¬ä¸­å¯¹äºæ–°çš„GCç®—æ³•ï¼ˆConcurrent Cycle Collection in Reference Counted Systemsï¼‰"></a>PHP5.3ç‰ˆæœ¬ä¸­å¯¹äºæ–°çš„GCç®—æ³•ï¼ˆConcurrent Cycle Collection in Reference Counted Systemsï¼‰</h2><p>å‡ ä¸ªåŸºæœ¬å‡†åˆ™ï¼š</p><ol><li>å¦‚æœä¸€ä¸ªzvalçš„refcountå¢åŠ ï¼Œé‚£ä¹ˆæ­¤zvalè¿˜åœ¨ä½¿ç”¨ï¼Œä¸å±äºåƒåœ¾</li><li>å¦‚æœä¸€ä¸ªzvalçš„refcountå‡å°‘åˆ°0ï¼Œé‚£ä¹ˆzvalå¯ä»¥è¢«é‡Šæ”¾æ‰ï¼Œä¸å±äºåƒåœ¾</li><li>å¦‚æœä¸€ä¸ªzvalçš„refcountå‡å°‘ä¹‹åå¤§äº0ï¼Œé‚£ä¹ˆæ­¤zvalè¿˜ä¸èƒ½è¢«é‡Šæ”¾ï¼Œæ­¤zvalå¯èƒ½æˆä¸ºä¸€ä¸ªåƒåœ¾ã€‚</li></ol><p>æ–°çš„GCç®—æ³•ç›®çš„å°±æ˜¯é˜²æ­¢å¾ªç¯å¼•ç”¨çš„å˜é‡å¼•èµ·å†…å­˜æ³„éœ²é—®é¢˜ã€‚åœ¨PHPä¸­GCç®—æ³•ï¼Œå½“èŠ‚ç‚¹ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œåƒåœ¾åˆ†æç®—æ³•å°±ä¼šå¯åŠ¨ï¼Œå¹¶ä¸”ä¼šé‡Šæ”¾æ‰å‘ç°çš„åƒåœ¾ï¼Œä»è€Œå›æ”¶å†…å­˜ã€‚</p><p>ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è¯•ä¸€ä¸‹ï¼Œå°†æ•°ç»„çš„å¼•ç”¨èµ‹å€¼ç»™æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œæœ‰æ„æ€çš„äº‹æƒ…å‘ç”Ÿäº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = array(&quot;one&quot;);</span><br><span class="line">$a[] = &amp;$a;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·$aæ•°ç»„å°±æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œä¸€ä¸ªç´¢å¼•ä¸º0ï¼Œå€¼ä¸ºå­—ç¬¦oneï¼Œå¦ä¸€ä¸ªç´¢å¼•ä¸º1ï¼Œä¸º$aè‡ªèº«çš„å¼•ç”¨ï¼Œå†…éƒ¨å­˜å‚¨å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a: (refcount=2, is_ref=1)=array (</span><br><span class="line">   0 =&gt; (refcount=1, is_ref=0)=&apos;one&apos;,</span><br><span class="line">   1 =&gt; (refcount=2, is_ref=1)=...</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>â€œâ€¦â€è¡¨ç¤º1æŒ‡å‘aè‡ªèº«ï¼Œæ˜¯ä¸€ä¸ªç¯å½¢å¼•ç”¨ï¼ˆå¾ªç¯å¼•ç”¨ï¼‰ï¼š<br><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/242899734-5ab22a29174e9_articlex.png" alt="å›¾ç‰‡æè¿°"></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯¹$aè¿›è¡Œunsetï¼Œé‚£ä¹ˆ$aä¼šä»ç¬¦å·è¡¨ä¸­åˆ é™¤ï¼ŒåŒæ—¶$aæŒ‡å‘çš„zvalçš„refcountå‡å°‘1ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = array(&apos;one&apos;);</span><br><span class="line">$a[] = &amp;$a;</span><br><span class="line">unset($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆé—®é¢˜äº§ç”Ÿäº†ï¼Œ$aå·²ç»ä¸å†ç¬¦å·è¡¨ä¸­äº†ï¼Œç”¨æˆ·æ— æ³•å†è®¿é—®æ­¤å˜é‡ï¼Œä½†æ˜¯$aä¹‹å‰æŒ‡å‘çš„zvalçš„refcountå˜ä¸º1è€Œä¸æ˜¯0ï¼Œå› æ­¤ä¸èƒ½è¢«å›æ”¶ï¼Œè¿™æ ·äº§ç”Ÿäº†å†…å­˜æ³„éœ²ï¼š<br><img src="https://github-1253518569.cos.ap-shanghai.myqcloud.com/1915931556-5ab22afde99e3_articlex.png" alt="å›¾ç‰‡æè¿°"></p><p>è¿™æ ·zvalå°±æˆä¸ºä¸€ä¸ªåƒåœ¾äº†ï¼Œæ–°çš„GCè¦åšçš„å·¥ä½œå°±æ˜¯æ¸…ç†è¿™ç§åƒåœ¾ã€‚</p><blockquote><p>åœ¨PHPç¼–ç¨‹ä¸­ç¨‹åºå‘˜ä¸éœ€è¦æ‰‹åŠ¨å¤„ç†å†…å­˜èµ„æºåˆ†é…ä¸é‡Šæ”¾ï¼Œæ„å‘³ç€PHPæœ¬èº«å®ç°äº†åƒåœ¾å›æ”¶å¤„ç†æœºåˆ¶ã€‚</p></blockquote><h2 id="PHP5-2ä¸­çš„åƒåœ¾å›æ”¶ç®—æ³•â€”Reference-Counting"><a href="#PHP5-2ä¸­çš„åƒåœ¾å›æ”¶ç®—æ³•â€”Reference-Counting" class="headerlink" title="PHP5.2ä¸­çš„åƒåœ¾å›æ”¶ç®—æ³•â€”Reference Counting"></a>PHP5.2ä¸­çš„åƒåœ¾å›æ”¶ç®—æ³•â€”Reference Counting</h2><blockquote><p>è¿™ä¸ªç®—æ³•å«åšâ€œå¼•ç”¨è®¡æ•°â€ï¼Œå…¶æ€æƒ³éå¸¸ç›´è§‚å’Œç®€æ´ï¼šä¸ºæ¯ä¸ªå†…å­˜å¯¹è±¡åˆ†é…ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“ä¸€ä¸ªå†…å­˜å¯¹è±¡å»ºç«‹æ—¶è®¡æ•°å™¨åˆå§‹åŒ–ä¸º1ï¼ˆå› æ­¤æ­¤æ—¶æ€»æ˜¯æœ‰ä¸€ä¸ªå˜é‡å¼•ç”¨æ­¤å¯¹è±¡ï¼‰ï¼Œä»¥åæ¯æœ‰ä¸€ä¸ªæ–°å˜é‡å¼•ç”¨æ­¤å†…å­˜å¯¹è±¡ï¼Œåˆ™è®¡æ•°å™¨åŠ 1ï¼Œè€Œæ¯å½“å‡å°‘ä¸€ä¸ªå¼•ç”¨æ­¤å†…å­˜å¯¹è±¡çš„å˜é‡åˆ™è®¡æ•°å™¨å‡1ï¼Œå½“åƒåœ¾å›æ”¶æœºåˆ¶è¿ä½œæ—¶ï¼Œå°†æ‰€æœ‰è®¡æ•°å™¨ä¸º0çš„å†…å­˜å¯¹è±¡é”€æ¯å¹¶å›æ”¶å…¶å ç”¨çš„å†…å­˜ã€‚è€Œphpä¸­å†…å­˜å¯¹è±¡å°±æ˜¯zvalï¼Œè€Œè®¡æ•°å™¨å°±æ˜¯refcount__gcã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆå…­ï¼‰ï¼šSSL_do_handshake() failed</title>
      <link href="/posts/34556/"/>
      <url>/posts/34556/</url>
      
        <content type="html"><![CDATA[<p>å‰å‡ å¤©åœ¨å€’è…¾é•œåƒç«™çš„æ—¶å€™ï¼Œåœ¨ä»£ç†ipv4çš„ç«™ç‚¹æ˜¯okçš„ï¼Œä½†æ˜¯ä»£ç†ipv6çš„httpsç«™ç‚¹çš„æ—¶å€™ï¼Œå‘ç°ä¸€ç›´è¿”å›502ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜ï¼Œnginxä»£ç†äº†ï¼Œä½†æ˜¯ä»£ç†çš„æ—¶å€™ï¼Œä¸‹æ¸¸æœåŠ¡å™¨æ²¡æœ‰ç»™ä½ æ­£ç¡®çš„å“åº”</p><a id="more"></a><p>é¦–å…ˆçœ‹ä¸€ä¸‹åŸå§‹é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">        proxy_cache my_cache;</span><br><span class="line">        proxy_set_header Accept-Encoding &quot;none&quot;;</span><br><span class="line">        proxy_pass https://m.cn.nytimes.com/;</span><br><span class="line">        sub_filter &apos;https://m.cn.nytimes.com&apos; &apos;https://www.xxx.com/&apos;;</span><br><span class="line">        sub_filter &apos;d1f1eryiqyjs0r.cloudfront.net&apos; &apos;www.xxx.com/d1f1eryiqyjs0r&apos;;</span><br><span class="line">        sub_filter_once  off;</span><br><span class="line">&#125;</span><br><span class="line">location ~ /d1f1eryiqyjs0r/(.*)$ &#123;</span><br><span class="line">        proxy_cache my_cache;</span><br><span class="line">        proxy_set_header referer &quot;https://cn.nytimes.com&quot;;</span><br><span class="line">        proxy_pass https://d1f1eryiqyjs0r.cloudfront.net/$1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡proxy_passæ¥ä»£ç†åˆ°ç›®æ ‡ç«™ç‚¹ï¼Œè·å–å†…å®¹åï¼Œå°†ä¸èƒ½å›½å†…è®¿é—®çš„å†…å®¹çš„åŸŸåæ›¿æ¢æˆè‡ªå·±çš„åŸŸåï¼Œåé¢åŠ ä¸Šä¸åŒçš„åç¼€æ¥æ ‡è¯†ï¼Œç„¶åå†é€šè¿‡æˆ‘ä»¬çš„æœåŠ¡å™¨ä»£ç†å†…å®¹é‡Œé¢çš„è¶…é“¾ï¼Œç†è®ºä¸Šå‡ºäº†ç¹çå¤–ï¼Œæ²¡æœ‰ä»€ä¹ˆæŠ€æœ¯éš¾åº¦ï¼Œç„¶è€Œè¿”å›äº†502ï¼Œè¿™å°±æœ‰ç‚¹ä¸å¤Ÿæ„æ€äº†ã€‚</p><p>æŸ¥çœ‹error.logåå‘ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018/09/01 07:55:24 [error] 485#485: *6372 SSL_do_handshake() failed (SSL: error:14077410:SSL routines:SSL23_GET_SERVER_HELLO:sslv3 alert handshake failure) while SSL handshaking to upstream, client: 122.224.106.25, server: www.xxx.com, request: &quot;GET / HTTP/1.1&quot;, upstream: &quot;https://52.85.131.45:443/&quot;, host: &quot;www.xxx.com&quot;</span><br></pre></td></tr></table></figure><p>SSLçš„é—®é¢˜ï¼Œä»£ç†çš„æ—¶å€™åŠ ä¸€ä¸‹SSLå¤„ç†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">        proxy_ssl_server_name on;</span><br><span class="line">        proxy_ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        proxy_cache my_cache;</span><br><span class="line">        proxy_set_header Accept-Encoding &quot;none&quot;;</span><br><span class="line">        proxy_pass https://m.cn.nytimes.com/;</span><br><span class="line">        sub_filter &apos;https://m.cn.nytimes.com&apos; &apos;https://www.xxx.com/&apos;;</span><br><span class="line">        sub_filter &apos;d1f1eryiqyjs0r.cloudfront.net&apos; &apos;www.xxx.com/d1f1eryiqyjs0r&apos;;</span><br><span class="line">        sub_filter_once  off;</span><br><span class="line">&#125;</span><br><span class="line">location ~ /d1f1eryiqyjs0r/(.*)$ &#123;</span><br><span class="line">proxy_ssl_server_name on;</span><br><span class="line">        proxy_ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        proxy_cache my_cache;</span><br><span class="line">        proxy_set_header referer &quot;https://cn.nytimes.com&quot;;</span><br><span class="line">        proxy_pass https://d1f1eryiqyjs0r.cloudfront.net/$1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œå†æ¬¡æ‰“å¼€å·²ç»OKäº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpé…ç½®xdebugå®ç°å†…ç½‘æœ¬åœ°è°ƒè¯•è¿œç¨‹æœåŠ¡å™¨</title>
      <link href="/posts/15205/"/>
      <url>/posts/15205/</url>
      
        <content type="html"><![CDATA[<p>å¯¹äºä¸€èˆ¬çš„é¡¹ç›®æ¥è¯´ï¼Œ<code>print_r() echo file_put_contents() exit</code> è¿™äº›å‡½æ•°è°ƒè¯•å°±è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å¦‚æœä½ è°ƒè¯•çš„ç¯å¢ƒè¿˜æœ‰å…¶ä»–äººï¼Œé‚£å°±ç•¥èƒƒç–¼äº†</p><p>æœåŠ¡å™¨ç¯å¢ƒï¼šcentos7 php7.0</p><p>æœ¬åœ°ç¯å¢ƒï¼šwindows php7.2ï¼ˆå‹ç¼©åŒ…ï¼‰</p><p>æœ¬åœ°ç¯å¢ƒæ˜¯å…¬å¸å†…ç½‘ï¼Œæ‰€ä»¥ä¸­é—´ä¼šå€ŸåŠ©xshellåšä¸€æ¬¡tcpçš„è½¬å‘</p><a id="more"></a><h1 id="æœåŠ¡å™¨é…ç½®"><a href="#æœåŠ¡å™¨é…ç½®" class="headerlink" title="æœåŠ¡å™¨é…ç½®"></a>æœåŠ¡å™¨é…ç½®</h1><h2 id="å®‰è£…xdebug"><a href="#å®‰è£…xdebug" class="headerlink" title="å®‰è£…xdebug"></a>å®‰è£…xdebug</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install php70w* --skip-broken</span><br><span class="line">yum install php70w-pecl-xdebug</span><br></pre></td></tr></table></figure><h2 id="é…ç½®xdebug"><a href="#é…ç½®xdebug" class="headerlink" title="é…ç½®xdebug"></a>é…ç½®xdebug</h2><p>ä¿®æ”¹xdebugçš„é…ç½®æ–‡ä»¶ <code>/etc/php.d/xdebug.ini</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">; Enable xdebug extension module</span><br><span class="line">zend_extension=/usr/lib64/php/modules/xdebug.so</span><br><span class="line">xdebug.idekey = &quot;PHPSTORM&quot;</span><br><span class="line">; å› ä¸ºDBGpè°ƒè¯•ä»£ç†æ˜¯å¯ä»¥åšè°ƒè¯•åˆ†å‘çš„ï¼Œæ‰€ä»¥ï¼Œå®šä¹‰ä¸€ä¸ªIDEKEYï¼Œç›®çš„æ˜¯è®©è°ƒè¯•å™¨çŸ¥é“ï¼Œæ˜¯ä¸æ˜¯å‘ç»™è‡ªå·±çš„è¯·æ±‚</span><br><span class="line"></span><br><span class="line">xdebug.remote_enable = 1</span><br><span class="line">; è®¾ç½®ä¸º1çš„æ—¶å€™ï¼Œä¼šå…ˆå‚æ•°é“¾æ¥åˆ°remote_hostå’Œremote_portæŒ‡å®šçš„è°ƒè¯•å™¨ç«¯å£ï¼Œå¦‚æœè¿æ¥ä¸ä¸Šï¼Œå°±ç»§ç»­æ‰§è¡Œï¼Œç±»ä¼¼è®¾ç½®&gt;äº†0</span><br><span class="line"></span><br><span class="line">xdebug.remote_mode = &quot;req&quot;</span><br><span class="line">xdebug.remote_handler = &quot;dbgp&quot;</span><br><span class="line">; ä¹Ÿå°±æ˜¯è°ƒè¯•èµ°å“ªç§åè®®ï¼Œæœ‰è€çš„PHP3åè®®ï¼Œä¹Ÿæœ‰GDBåè®®ï¼ŒDBGPæ˜¯å½“å‰çš„é»˜è®¤åè®®ï¼Œä¹Ÿæ˜¯å½“å‰ä¸»æµæ”¯æŒçš„åè®®</span><br><span class="line"></span><br><span class="line">xdebug.remote_connect_back = 0</span><br><span class="line">; å¦‚æœä¸º1ï¼Œxdebugä¼šé€šè¿‡$_SERVER[â€˜REMOTE_ADDRâ€™]å˜é‡ï¼Œå‘å‘èµ·HTTPè¯·æ±‚çš„å®¢æˆ·ç«¯å‘èµ·é“¾æ¥ï¼Œå’Œremote_hoståŠŸèƒ½ç±»ä¼¼&gt;ï¼Œä½†æ˜¯ä¼˜å…ˆçº§æ¯”remote_hosté«˜ï¼Œæ‰€ä»¥ï¼Œè®¾ç½®äº†è¿™ä¸ªé€‰é¡¹å°±ä¼šå¿½ç•¥remote_hostï¼Œç”±äºæˆ‘çš„è¿è¡Œæ—¶æœåŠ¡å™¨ä¸èƒ½ä¸»åŠ¨é“¾æ¥IDEæ‰€&gt;åœ¨PCï¼Œæ‰€ä»¥ä¸èƒ½å¼€å¯è‡ªåŠ¨å›è¿æ¨¡å¼(å†…ç½‘è®¿é—®å¤–ç½‘çš„ç½‘é¡µï¼Œä¹Ÿä¸èƒ½å¼€å¯)</span><br><span class="line"></span><br><span class="line">xdebug.remote_host = &quot;127.0.0.1&quot;</span><br><span class="line">; é»˜è®¤æ˜¯ä¸»æœºï¼Œå¦‚æœæœåŠ¡å™¨å¯ä»¥ç›´æ¥ä½ çš„æœ¬åœ°ç”µè„‘ï¼Œå¯ä»¥ç›´æ¥å¡«å†™æœ¬æœºipï¼Œæˆ‘è¿™é‡Œä½¿ç”¨xshellåštcpè½¬å‘</span><br><span class="line"></span><br><span class="line">xdebug.remote_port = 9909</span><br><span class="line">; é»˜è®¤ç«¯å£æ˜¯9000ï¼Œç”±äºæ‹…å¿ƒæœåŠ¡å™¨ç«¯å£å†²çªï¼Œæˆ‘ä¿®æ”¹ä¸º9909ï¼Œå»ºè®®ä½ æ²¡æœ‰ç«¯å£å†²çªæ—¶ä¸ä¿®æ”¹</span><br><span class="line"></span><br><span class="line">xdebug.remote_autostart = 0</span><br><span class="line">; è¿™ä¸ªä¸º1ï¼Œä¼šå¿½ç•¥COOKIEæˆ–è€…POST/GETä¸­å¸¦çš„XDEBUG_SESSIONå‚æ•°ï¼Œä¸ç®¡æœ‰æ²¡æœ‰ï¼Œéƒ½ä¼šå¯åŠ¨è°ƒè¯•ï¼Œæ‰€ä»¥ï¼Œè¿˜æ˜¯è®¾ç½®ä¸º0æ¯”è¾ƒå¥½ï¼Œé»˜è®¤0</span><br></pre></td></tr></table></figure><p>é‡å¯php-fpm</p><h1 id="Xshell-TCPè½¬å‘"><a href="#Xshell-TCPè½¬å‘" class="headerlink" title="Xshell TCPè½¬å‘"></a>Xshell TCPè½¬å‘</h1><p>é¦–å…ˆè¿ä¸Šä½ éœ€è¦é…ç½®çš„æœåŠ¡å™¨æˆ–è€…æ‰¾åˆ°ç›®æ ‡æœåŠ¡å™¨çš„ä¼šè¯è®¾ç½®ï¼Œç„¶åå³é”®æ‰¾åˆ°<code>å±æ€§</code> ï¼Œç„¶åæ‰¾åˆ°<code>è¿æ¥ -&gt; ssh -&gt; éš§é“ -&gt; æ·»åŠ </code>ï¼ŒæŒ‰å¦‚å›¾æ‰€ç¤ºæ·»åŠ ï¼Œä¸Šé¢é…ç½®ç›®æ ‡æœåŠ¡å™¨ï¼Œä¸‹é¢é…ç½®æœ¬æœº</p><p><img src="http://github-1253518569.cossh.myqcloud.com/xshell-1.png" alt="é…ç½®å±æ€§"></p><p><img src="http://github-1253518569.cossh.myqcloud.com/xshell-2.png" alt="é…ç½®å±æ€§"></p><p><img src="http://github-1253518569.cossh.myqcloud.com/xshell-3.png" alt="tcpè½¬å‘é…ç½®"></p><p>é…ç½®å®Œæˆååˆ†åˆ«æŸ¥çœ‹ä¸€ä¸‹ ç›®æ ‡æœåŠ¡å™¨çš„9909 æ˜¯å¦è¢«ç›‘å¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano | grep 9909</span><br></pre></td></tr></table></figure><h1 id="Sublimeé…ç½®"><a href="#Sublimeé…ç½®" class="headerlink" title="Sublimeé…ç½®"></a>Sublimeé…ç½®</h1><h2 id="Xdebugé…ç½®"><a href="#Xdebugé…ç½®" class="headerlink" title="Xdebugé…ç½®"></a>Xdebugé…ç½®</h2><p>é¦–å…ˆé€šè¿‡ <code>package controller</code>å®‰è£… <code>xdebug client</code></p><p>ç„¶åé€šè¿‡èœå•æ çš„ <code>tool -&gt; Xdebug-&gt; Settings-default</code>ï¼Œ å¯ä»¥æ‰¾åˆ°xdebugçš„é»˜è®¤é…ç½®ï¼ˆç®€å•æ‘˜å–ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;path_mapping&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // Determine which URL to launch in the default web browser</span><br><span class="line">    // when starting/stopping a session.</span><br><span class="line">    &quot;url&quot;: &quot;&quot;,</span><br><span class="line">    &quot;ide_key&quot;: &quot;sublime.xdebug&quot;,</span><br><span class="line">    &quot;host&quot;: &quot;&quot;,</span><br><span class="line"></span><br><span class="line">    // Which port number Sublime Text should listen</span><br><span class="line">    // to connect with debugger engine.</span><br><span class="line">    &quot;port&quot;: 9000,</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">    &quot;python_path&quot; : &quot;&quot;,</span><br><span class="line"></span><br><span class="line">    // Show detailed log information about communication</span><br><span class="line">    // between debugger engine and Sublime Text.</span><br><span class="line">    // Log can be found at Packages/User/Xdebug.log</span><br><span class="line">    &quot;debug&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒç³»ç»Ÿçš„é…ç½®åŠè§£é‡Šï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œå®šä¹‰ <code>tool -&gt; Xdebug-&gt; Settings-User</code> ï¼Œä½†æ˜¯ç”¨æˆ·ä¸€èˆ¬ä¸æ˜¯åªæœ‰ä¸€ä¸ªé¡¹ç›®ï¼Œæ‰€ä»¥ä¸ªäººè¿˜æ˜¯å»ºè®®é’ˆå¯¹äºæ¯ä¸ª project è¿›è¡Œè®¾ç½®ï¼Œå¯ä»¥é€šè¿‡èœå•æ  <code>Project -&gt; Edit Project</code>ï¼Œ å½“ç„¶ï¼Œä½ éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªprojectï¼Œè¿™éƒ½æ˜¯å°äº‹äº†ã€‚</p><p>é™„ä¸Šä¸ªäººprojecté…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;folders&quot;:</span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line">&quot;path&quot;: &quot;.&quot;</span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line">&quot;settings&quot;: &#123;</span><br><span class="line">&quot;xdebug&quot;: &#123;</span><br><span class="line">&quot;path_mapping&quot;: &#123;</span><br><span class="line">    &quot;/data/www/html/httpserver&quot; : &quot;D:/workplace/cloudserver&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;url&quot;: &quot;http://121.xx.xx.xxx/httpserver/&quot;,</span><br><span class="line">&quot;ide_key&quot;: &quot;PHPSTORM&quot;,</span><br><span class="line">&quot;host&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">&quot;port&quot;: 9050,</span><br><span class="line">&quot;close_on_stop&quot;: true,</span><br><span class="line">&quot;debug_layout&quot; : &#123;</span><br><span class="line">    &quot;cols&quot;: [0.0, 0.5, 1.0],</span><br><span class="line">    &quot;rows&quot;: [0.0, 0.7, 1.0],</span><br><span class="line">    &quot;cells&quot;: [[0, 0, 2, 1], [0, 1, 1, 2], [1, 1, 2, 2]]</span><br><span class="line">&#125;,</span><br><span class="line">&quot;python_path&quot; : &quot;C:\\Program Files\\Python35\\python.exe&quot;,</span><br><span class="line">&quot;debug&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SFTPé…ç½®"><a href="#SFTPé…ç½®" class="headerlink" title="SFTPé…ç½®"></a>SFTPé…ç½®</h2><p>sftpé…ç½®å°±ä¸å¤šåºŸè¯äº†ï¼Œå‚è€ƒå¦ä¸€ç¯‡åšå®¢<a href="https://tyloafer.github.io/posts/45096/">Sublimeå€’è…¾ç³»åˆ—ï¼šé…ç½®sftpå®ç°æ–‡ä»¶ä¸Šä¼ ä¸‹è½½</a></p><h1 id="PHPStromé…ç½®"><a href="#PHPStromé…ç½®" class="headerlink" title="PHPStromé…ç½®"></a>PHPStromé…ç½®</h1><h2 id="SFTPé…ç½®-1"><a href="#SFTPé…ç½®-1" class="headerlink" title="SFTPé…ç½®"></a>SFTPé…ç½®</h2><p><code>Tools-&gt;Deployment-&gt;Configuration</code>ï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†é‡Œä¸€æ¬¡å¡«å…¥ç”¨æˆ·åï¼Œå¯†ç ï¼Œ</p><p><img src="http://github-1253518569.cossh.myqcloud.com/phpstrome-1.png" alt="phpstrom sfté…ç½®"></p><p>ç„¶åå³è¾¹æ—è¾¹ä¸€ä¸ªæ ‡ç­¾é¡µ <code>Mappings</code></p><p><img src="http://github-1253518569.cossh.myqcloud.com/phpstrome-29.png" alt="phpstrom-mapping"></p><p>é…ç½®å®Œæˆåï¼Œé€šè¿‡ <code>Toolsâ€”&gt;Deploymentâ€”&gt;Browse Remote Host</code> çœ‹ä¸€ä¸‹å³ä¾§æ˜¯å¦ä¼šåˆ—å‡ºè¿œç¨‹æ–‡ä»¶ï¼Œæ˜¾ç¤ºç»¿è‰²è¡¨åæ˜¯å¯¹åº”ä¸Šäº†</p><h2 id="Serveré…ç½®"><a href="#Serveré…ç½®" class="headerlink" title="Serveré…ç½®"></a>Serveré…ç½®</h2><p>é€šè¿‡ <code>File -&gt; Settings -&gt; Languages &amp; Frameworks -&gt; PHP -&gt; Servers</code>   æ–°å»ºä¸€ä¸ªServer,è¾“å…¥æœåŠ¡å™¨çš„IPå’Œç«¯å£ï¼Œæœ€å…³é”®çš„æ˜¯ï¼Œå°†æœ¬åœ°å·¥ç¨‹æ–‡ä»¶å¤¹å’ŒæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶å¤¹å¯¹åº”èµ·æ¥ï¼Œæ–¹ä¾¿è°ƒè¯•çš„æ—¶å€™æ‰¾åˆ°æºç ï¼š</p><p><img src="http://github-1253518569.cossh.myqcloud.com/phpstrome-3.png" alt="phpstrome serveré…ç½®"></p><h2 id="é…ç½®Debug"><a href="#é…ç½®Debug" class="headerlink" title="é…ç½®Debug"></a>é…ç½®Debug</h2><p>é€šè¿‡<code>Run -&gt; Edit Configurations -&gt; PHP Remote Debug</code>ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®ï¼ŒServerså°±é€‰æ‹©åˆšæ‰é…ç½®çš„ï¼ŒIde Keyè®¾ç½®ä¸ºphp.inié‡Œé¢xdebug.idekeyè®¾ç½®çš„ï¼Œ è¿™é‡Œå°±æ˜¯ <strong>PHPSTROME</strong></p><p><img src="http://github-1253518569.cossh.myqcloud.com/phpstrom-4.png" alt="phpstrom remote debug"></p><h2 id="è°ƒè¯•ï¼ˆå…¨éƒ¨é…ç½®ç»“æŸåæµ‹è¯•ï¼‰"><a href="#è°ƒè¯•ï¼ˆå…¨éƒ¨é…ç½®ç»“æŸåæµ‹è¯•ï¼‰" class="headerlink" title="è°ƒè¯•ï¼ˆå…¨éƒ¨é…ç½®ç»“æŸåæµ‹è¯•ï¼‰"></a>è°ƒè¯•ï¼ˆå…¨éƒ¨é…ç½®ç»“æŸåæµ‹è¯•ï¼‰</h2><p><img src="http://github-1253518569.cossh.myqcloud.com/phpstrom-5.png" alt="è°ƒè¯•"></p><h1 id="Postmané…ç½®"><a href="#Postmané…ç½®" class="headerlink" title="Postmané…ç½®"></a>Postmané…ç½®</h1><p>Postman åœ°å€ï¼š <a href="https://chrome.google.com/webstore/detail/postman/agkicnjkbankpckaomnhfjglafjcegkk?hl=zh-CN" target="_blank" rel="noopener">è°·æ­Œå•†åº—</a></p><p>Postman Interceptor åœ°å€ï¼š <a href="https://chrome.google.com/webstore/detail/postman-interceptor/aicmkgpgakddgnaphhhpliifpcfhicfo?hl=zh-CN" target="_blank" rel="noopener">è°·æ­Œå•†åº—</a></p><p>å®‰è£…å®Œæˆåï¼Œæ‰“å¼€<strong>Postman</strong>ï¼Œ åœ¨å³ä¸Šè§’å¼€å¯ <strong>Postman Interceptor</strong> å³å¯è®¾ç½®cookie è¿›è¡Œè¯·æ±‚äº†</p><p><img src="http://github-1253518569.cossh.myqcloud.com/postman-1.png" alt="postman"></p><p>è¿™æ—¶å€™ï¼Œåªè¦åœ¨æ¨¡æ‹Ÿè¯·æ±‚çš„æ—¶å€™è®¾ç½®ä¸€ä¸‹cookieï¼Œåœ¨ <strong>phpstrom</strong> æˆ– <strong>sublime</strong> è®¾ç½®ä¸€ä¸‹æ–­ç‚¹å°±okäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie:XDEBUG_SESSION=PHPSTORM</span><br></pre></td></tr></table></figure><p><img src="http://github-1253518569.cossh.myqcloud.com/postman-2.png" alt="postman cookieè®¾ç½®"></p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Xdebug </tag>
            
            <tag> Sublime </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxæƒé™æ§åˆ¶-ACL</title>
      <link href="/posts/45399/"/>
      <url>/posts/45399/</url>
      
        <content type="html"><![CDATA[<p>åœ¨Linuxè¿›è¡Œæƒé™ç®¡ç†æ¥è§¦æœ€å¤šçš„åº”è¯¥å°±æ˜¯ <code>chmod</code> <code>chown</code> ï¼Œä½†æ˜¯ç”¨çš„æ—¶é—´é•¿äº†å°±ä¼šå‘ç°å¾ˆå¤šå¼Šç«¯ï¼Œå¾ˆæ˜æ˜¾çš„å°±æ˜¯rootç”¨æˆ·ç”¨çš„è¶Šæ¥è¶Šå¤šï¼Œ 777æƒé™çš„æ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼Œéƒ¨åˆ†åŸå› æ˜¯å¼€å‘è€…è¿‡æ‡’å¯¼è‡´çš„ï¼Œä½†æ˜¯ç®€å•çš„<code>chmod</code> <code>chown</code> ä¼šè¯¯æ€å¾ˆå¤šç”¨æˆ·ä¹Ÿæ˜¯ä¸€éƒ¨åˆ†åŸå› ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±ä»‹ç»ä¸€ä¸‹æ›´ä¸ºèªæ˜å’Œç‰›é€¼çš„æƒé™æ§åˆ¶â€”-ACL</p><a id="more"></a><p><strong>è®¿é—®æ§åˆ¶è¡¨</strong>ï¼ˆAccess Control Listï¼ŒACLï¼‰ï¼Œåˆç§°<strong>å­˜å–æ§åˆ¶ä¸²åˆ—</strong>ï¼Œæ˜¯ä½¿ç”¨ä»¥<a href="https://zh.wikipedia.org/wiki/%E5%AD%98%E5%8F%96%E6%8E%A7%E5%88%B6%E7%9F%A9%E9%99%A3" target="_blank" rel="noopener">è®¿é—®æ§åˆ¶çŸ©é˜µ</a>ä¸ºåŸºç¡€çš„è®¿é—®æ§åˆ¶æ–¹æ³•ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡å¯¹åº”ä¸€ä¸ªä¸²åˆ—ä¸»ä½“<br>ã€‚è®¿é—®æ§åˆ¶è¡¨æè¿°æ¯ä¸€ä¸ªå¯¹è±¡å„è‡ªçš„è®¿é—®æ§åˆ¶ï¼Œå¹¶è®°å½•å¯å¯¹æ­¤å¯¹è±¡è¿›è¡Œè®¿é—®çš„æ‰€æœ‰ä¸»ä½“å¯¹å¯¹è±¡çš„æƒé™ã€‚</p><ul><li><p>Linuxæ–‡ä»¶ç³»ç»ŸACLåŠŸèƒ½</p><p>ä¸»è¦çš„ç›®çš„æ˜¯åœ¨æä¾›ä¼ ç»Ÿçš„ owner,group,others çš„ read,write,execute æƒé™ä¹‹å¤–çš„ç»†éƒ¨æƒé™è®¾ç½®ã€‚ACL å¯ä»¥é’ˆå¯¹å•ä¸€ä½¿ç”¨è€…ï¼Œå•ä¸€æ–‡ä»¶æˆ–ç›®å½•æ¥è¿›è¡Œ r,w,x çš„æƒé™è§„èŒƒï¼Œå¯¹äºéœ€è¦ç‰¹æ®Šæƒé™çš„ä½¿ç”¨çŠ¶å†µéå¸¸æœ‰å¸®åŠ©ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼ŒACLåŠŸèƒ½æ˜¯ä¸ºäº†åŠ å¼ºLinuxç³»ç»Ÿæ–‡ä»¶æƒé™ç®¡ç†ã€‚</p></li></ul><h1 id="å¼€å¯-ACL-æƒé™"><a href="#å¼€å¯-ACL-æƒé™" class="headerlink" title="å¼€å¯ ACL æƒé™"></a>å¼€å¯ ACL æƒé™</h1><p>å¯¹äºCentOS6ï¼Œç³»ç»Ÿå®‰è£…æ—¶çš„åˆ†åŒºæ”¯æŒacl,é¢å¤–çš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æ—¶éœ€æ·»åŠ aclé€‰é¡¹ã€‚</p><blockquote><p>mount -o remount, acl [mount point]</p></blockquote><p>å¯¹äºCentOS7ï¼Œé»˜è®¤æ”¯æŒaclåŠŸèƒ½ã€‚</p><h1 id="æŸ¥çœ‹å’Œè®¾ç½®æ–‡ä»¶-ACL-æƒé™"><a href="#æŸ¥çœ‹å’Œè®¾ç½®æ–‡ä»¶-ACL-æƒé™" class="headerlink" title="æŸ¥çœ‹å’Œè®¾ç½®æ–‡ä»¶ ACL æƒé™"></a>æŸ¥çœ‹å’Œè®¾ç½®æ–‡ä»¶ ACL æƒé™</h1><p>è®¾ç½® ACL æƒé™ç”¨<code>setfacl -m [u|g]:[ç”¨æˆ·å|ç»„å]:æƒé™ æ–‡ä»¶å</code>å‘½ä»¤ã€‚<br>æŸ¥çœ‹ ACL æƒé™ç”¨<code>getfacl æ–‡ä»¶å</code></p><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>ä½¿ç”¨</th></tr></thead><tbody><tr><td>m</td><td>è®¾ç½® ACL æƒé™</td><td>setfacl -m [u\</td><td>g]:[ç”¨æˆ·å \</td><td>ç»„å]: æƒé™ æ–‡ä»¶å</td></tr><tr><td>x</td><td>åˆ é™¤æŒ‡å®š ACL æƒé™</td><td>setfacl -x [u\</td><td>g]:[ç”¨æˆ·å \</td><td>ç»„å] æ–‡ä»¶å</td></tr><tr><td>b</td><td>åˆ é™¤å…¨éƒ¨ ACL æƒé™</td><td>setfacl -b æ–‡ä»¶å</td></tr><tr><td>d</td><td>è®¾å®šé»˜è®¤ ACL æƒé™ (å­æ–‡ä»¶ç»§æ‰¿ç›®å½• ACL æƒé™)</td><td>setfacl -m d:[u\</td><td>g]:[ç”¨æˆ·å \</td><td>ç»„å]: æƒé™ æ–‡ä»¶å</td></tr><tr><td>k</td><td>åˆ é™¤é»˜è®¤ ACL æƒé™ (å­æ–‡ä»¶ç»§æ‰¿ç›®å½• ACL æƒé™)</td><td>setfacl -m</td></tr><tr><td>R</td><td>é€’å½’è®¾ç½® ACL æƒé™ (å®¹æ˜“ç»™æ–‡ä»¶ x æƒé™)</td><td>setfacl -m [u\</td><td>g]:[ç”¨æˆ·å \</td><td>ç»„å]: æƒé™ -R ç›®å½•å</td></tr></tbody></table><p>eg:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 1. åˆ›å»ºæƒé™ä¸ºdrwxrwx---, ç”¨æˆ·å’Œç”¨æˆ·ç»„ä¸ºrootçš„dirç›®å½•</span><br><span class="line">[root@localhost ~]# mkdir ~ahao/dir </span><br><span class="line">[root@localhost ~]# chmod 770 ~ahao/dir</span><br><span class="line">[root@localhost ~]# ll ~ahao</span><br><span class="line">æ€»ç”¨é‡ 0</span><br><span class="line">drwxrwx---. 2 root root 6 11æœˆ  4 22:32 dir</span><br><span class="line"></span><br><span class="line"># 2. æ“ä½œ1: ahaoç”¨æˆ·å°è¯•è¿›å…¥dirç›®å½•å¤±è´¥, æƒé™ä¸è¶³</span><br><span class="line">[ahao@localhost ~]$ cd dir</span><br><span class="line">-bash: cd: dir: æƒé™ä¸å¤Ÿ</span><br><span class="line"></span><br><span class="line"># 3. rootç”¨æˆ·è®¾ç½®ACLæƒé™, ç»™ahaoç”¨æˆ·èµ‹äºˆrxæƒé™</span><br><span class="line">[root@localhost ~]# setfacl -m u:ahao:rx ~ahao/dir</span><br><span class="line">[ahao@localhost ~]$ ll</span><br><span class="line">æ€»ç”¨é‡ 0</span><br><span class="line">drwxrwx---+ 2 root root 6 11æœˆ  4 22:32 dir</span><br><span class="line"></span><br><span class="line"># 4. æ“ä½œ2: ahaoç”¨æˆ·å°è¯•è¿›å…¥dirç›®å½•æˆåŠŸ, dirçš„+æƒé™ä½ä»£è¡¨ACLæƒé™</span><br><span class="line">[ahao@localhost ~]$ cd dir</span><br><span class="line">[ahao@localhost dir]$ # æˆåŠŸè¿›å…¥dirç›®å½• </span><br><span class="line"></span><br><span class="line"># 5. æ“ä½œ3: æŸ¥çœ‹ACLæƒé™</span><br><span class="line">[ahao@localhost dir]$ getfacl ~ahao/dir/ </span><br><span class="line">getfacl: Removing leading &apos;/&apos; from absolute path names</span><br><span class="line"># file: home/ahao/dir/</span><br><span class="line"># owner: root</span><br><span class="line"># group: root</span><br><span class="line">user::rwx</span><br><span class="line">user:ahao:r-x # ACLæƒé™</span><br><span class="line">group::rwx</span><br><span class="line">mask::rwx</span><br><span class="line">other::---</span><br></pre></td></tr></table></figure><h1 id="mask-æ©ç "><a href="#mask-æ©ç " class="headerlink" title="mask æ©ç "></a>mask æ©ç </h1><p>ä¸Šé¢çš„ä¾‹å­åœ¨ä½¿ç”¨<code>getfacl dir</code>ä¹‹å, å¯ä»¥çœ‹åˆ°æœ‰ä¸€é¡¹æ˜¯<code>mask</code>ã€‚<br>è¿™ä¸ªå’Œé»˜è®¤æƒé™<code>umask</code>å·®ä¸å¤š, ä¹Ÿæ˜¯ä¸€ä¸ªæƒé™æ©ç , è¡¨ç¤ºæ‰€èƒ½èµ‹äºˆçš„æƒé™æœ€å¤§å€¼ã€‚<br>è¿™é‡Œçš„<code>mask</code>å’Œ<code>ACLæƒé™</code>è¿›è¡Œ<code>&amp;ä¸</code>è¿ç®—, å¾—åˆ°çš„æ‰æ˜¯çœŸæ­£çš„<code>ACLæƒé™</code>ã€‚<br>ç”¨äººè¯è®², å°±æ˜¯</p><blockquote><p>ä½ è€ƒä¸€ç™¾åˆ†æ˜¯å› ä¸ºå®åŠ›åªæœ‰ä¸€ç™¾åˆ†<br>æˆ‘è€ƒä¸€ç™¾åˆ†æ˜¯å› ä¸ºæ€»åˆ†åªæœ‰ä¸€ç™¾åˆ†</p></blockquote><p><code>mask</code>é™åˆ¶äº†æƒé™çš„æœ€é«˜å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 1. ä¿®æ”¹ACLæƒé™maskä¸ºr-x</span><br><span class="line">[root@localhost ~]# setfacl -m m:rx ~ahao/tmp/av </span><br><span class="line">[root@localhost ~]# getfacl ~ahao/tmp/av</span><br><span class="line">getfacl: Removing leading &apos;/&apos; from absolute path names</span><br><span class="line"># file: home/ahao/tmp/av</span><br><span class="line"># owner: root</span><br><span class="line"># group: root</span><br><span class="line">user::rwx</span><br><span class="line">group::r-x</span><br><span class="line">mask::r-x # ä¿®æ”¹ACLæƒé™maskä¸ºr-x</span><br><span class="line">other::---</span><br><span class="line"></span><br><span class="line"># 2. ä¸ºç”¨æˆ·ahaoæ·»åŠ ACLæƒé™rwx</span><br><span class="line">[root@localhost ~]# setfacl -m u:ahao:rwx ~ahao/tmp/av/ </span><br><span class="line">[root@localhost ~]# getfacl ~ahao/tmp/av</span><br><span class="line">getfacl: Removing leading &apos;/&apos; from absolute path names</span><br><span class="line"># file: home/ahao/tmp/av</span><br><span class="line"># owner: root</span><br><span class="line"># group: root</span><br><span class="line">user::rwx</span><br><span class="line">user:ahao:rwx</span><br><span class="line">group::r-x</span><br><span class="line">mask::rwx # æ³¨æ„, è¿™é‡Œçš„maskæ©ç ä¼šæ”¹å˜, å› ä¸ºèµ‹äºˆçš„ACLæƒé™å¤§äºmask</span><br><span class="line">other::---</span><br><span class="line"></span><br><span class="line"># 3. ä¿®æ”¹ACLæƒé™maskä¸ºr-x</span><br><span class="line">[root@localhost ~]# setfacl -m m:rx ~ahao/tmp/av</span><br><span class="line">[root@localhost ~]# getfacl ~ahao/tmp/av</span><br><span class="line">getfacl: Removing leading &apos;/&apos; from absolute path names</span><br><span class="line"># file: home/ahao/tmp/av</span><br><span class="line"># owner: root</span><br><span class="line"># group: root</span><br><span class="line">user::rwx</span><br><span class="line">user:ahao:rwx#effective:r-x # è¿™é‡Œä¼šæç¤ºçœŸå®çš„ACLæƒé™ä¸ºr-x</span><br><span class="line">group::r-x</span><br><span class="line">mask::r-x # è¿™é‡Œmaskä¸ä¼šå†æ”¹å˜</span><br><span class="line">other::---</span><br></pre></td></tr></table></figure><ol><li><code>mask</code> ä¼šé™åˆ¶ <code>ACL</code> æƒé™çš„æœ€å¤§å€¼ã€‚</li><li>èµ‹äºˆ<code>ACL</code> æƒé™å¤§äº <code>mask</code> çš„æ—¶å€™, ä¼šå°† <code>mask</code> <strong>æ’‘å¤§</strong>ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆå…­ï¼‰ï¼šNginx tcp/udpè½¬å‘</title>
      <link href="/posts/27510/"/>
      <url>/posts/27510/</url>
      
        <content type="html"><![CDATA[<p>å‰ä¸¤å¤©ç»™éƒ¨é—¨åšäº†ä¸ªæ•°æ®åº“çš„ä¸»å¤‡ç”¨äºæ•°æ®åˆ†æï¼Œä½†æ˜¯åæ¥è¿ç»´ä¸å»ºè®®ç›´è¿å¤‡ä»½æœåŠ¡å™¨çš„3306ç«¯å£ï¼Œç„¶åå°±å¾ˆå°´å°¬äº†ï¼Œç„¶åä»–ä»¬å°±ä»ç¨‹åºå¼€å§‹å…¥æ‰‹ï¼Œè„šæœ¬å¤„ç†binlogï¼Œå¯¼å…¥å¯¼å‡ºand so onï¼Œä»æˆ‘ä¸ªäººè§’åº¦æ¥è¯´ï¼Œæˆ‘æ˜¯ä¸å–œæ¬¢è¿™ç§æ–¹å¼æåº¦æ›²çº¿æ•‘å›½çš„æ–¹å¼çš„ï¼Œç„¶åæˆ‘å°±æ²¡äº‹æµ‹è¯•äº†ä¸€ä¸‹Nginxåˆ°tcpè½¬å‘ï¼Œå½“ç„¶ä¹Ÿåªèƒ½åšä¸ªäººçš„å°å®éªŒäº†ã€‚</p><a id="more"></a><h1 id="é…ç½®Nginx"><a href="#é…ç½®Nginx" class="headerlink" title="é…ç½®Nginx"></a>é…ç½®Nginx</h1><p>Nginxçš„streamæ¨¡å—ä¸ä»…æ”¯æŒTCPè½¬å‘ï¼Œä¹Ÿæ”¯æŒUDPï¼ŒåŒæ—¶è¿˜å¯ä»¥é€šè¿‡socketè½¬å‘ï¼Œä¹Ÿæ˜¯å¾ˆå¼ºå¤§çš„äº†ã€‚</p><p>é…ç½®æ–‡ä»¶é…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">server &#123;</span><br><span class="line">listen 1008;</span><br><span class="line"># listen 1008 udp; é€šè¿‡åé¢æ·»åŠ udpï¼Œå¯ä»¥è¿›è¡Œudpçš„è½¬å‘</span><br><span class="line">proxy_pass 127.0.0.1:3306;</span><br><span class="line"># proxy_pass unix:/var/lib/mysql/mysql.sock; å°†æ•°æ®è½¬å‘ç»™socketå¤„ç†</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>æˆ‘ä»¬é€šè¿‡<code>1008</code> ç«¯å£è¿›è¡Œè¿æ¥æ•°æ®åº“å°è¯•ä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">âœ  httpserver master âœ— mysql -uxxxx -pxxxxx -P1008 </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5399</span><br><span class="line">Server version: 5.7.22-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure><p>å°è¯•ok</p><h1 id="è¿›é˜¶"><a href="#è¿›é˜¶" class="headerlink" title="è¿›é˜¶"></a>è¿›é˜¶</h1><p>æ—¢ç„¶nginxå¯ä»¥è¿›è¡Œtcpå’Œudpçš„è½¬å‘ï¼Œé‚£æˆ‘æ˜¯å¦å¯ä»¥ä»£ç†shadowsockå‘¢ï¼Ÿ</p><p>é…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        listen 80 udp;</span><br><span class="line">        proxy_pass 127.0.0.1:xxxx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆï¼Œå¹¶æ²¡æœ‰å°è¯•æˆåŠŸï¼ŒåæœŸæœ‰æ—¶é—´æ‰¾æœ‹å‹ä¸€èµ·æŠ“ä¸‹åŒ…åˆ†æä¸€ä¸‹ï¼Œæš‚æ—¶å°±å…ˆå€’è…¾åˆ°è¿™äº†</p>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆäº”ï¼‰ï¼šNginxåˆ¶ä½œé•œåƒç«™</title>
      <link href="/posts/42698/"/>
      <url>/posts/42698/</url>
      
        <content type="html"><![CDATA[<p>æœ€å¼€å§‹æ¥è§¦é•œåƒç«™è¿˜æ˜¯å½“åˆåœ¨å®éªŒå®¤çš„æ—¶å€™ï¼Œå½“æ—¶è¿˜æ˜¯ä¸€æšå°èœé¸Ÿï¼Œä¸æ‡‚ç§‘å­¦ä¸Šç½‘ï¼Œç„¶ååœ¨å­¦å§çš„å¸¦é¢†ä¸‹ï¼ŒçŸ¥é“äº†é•œåƒç«™çš„å­˜åœ¨ï¼Œç°åœ¨è™½ç„¶å·²ç»ç”¨ä¸ä¸Šé•œåƒç«™äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æƒ³å€’è…¾ä¸€ä¸‹ï¼Œè€ŒNginxçš„åå‘ä»£ç†æ­£å¥½ä¹Ÿå¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½</p><a id="more"></a><h1 id="ä»£ç†å®ç°é•œåƒç«™"><a href="#ä»£ç†å®ç°é•œåƒç«™" class="headerlink" title="ä»£ç†å®ç°é•œåƒç«™"></a>ä»£ç†å®ç°é•œåƒç«™</h1><p>å…¶å®ï¼Œnginxçš„ <em>proxy_pass</em> æ¨¡å—å°±å¯ä»¥å®ç°ï¼Œé…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    proxy_pass https://www.google.com/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå°†æ‰€æœ‰ç½‘ç«™çš„è¯·æ±‚éƒ½ä»£ç†åˆ°è°·æ­Œï¼Œç„¶åç­‰å¾…è°·æ­Œè¿”å›ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬å†å±•ç¤ºå°±okäº†ï¼Œæ•ˆæœå¦‚ä¸‹</p><p><img src="http://github-1253518569.cossh.myqcloud.com/mirror-google.png" alt="mirror-google"></p><h1 id="è¿›é˜¶-å°å·ç«™"><a href="#è¿›é˜¶-å°å·ç«™" class="headerlink" title="è¿›é˜¶-å°å·ç«™"></a>è¿›é˜¶-å°å·ç«™</h1><p>å¯¹äºé•œåƒç«™çš„å®ç°åŸç†å…¶å®æ˜¯è¿™æ ·çš„</p><pre class="mermaid">graph TDst(å¼€å§‹)-->op1(ç”¨æˆ·)    op1--æ•°æ®-->op2(æˆ‘çš„æœåŠ¡å™¨)    op2--ç”¨æˆ·çš„ä¿¡æ¯-->op3(googleæœåŠ¡å™¨)    op3--è°·æ­Œè¿”å›æ•°æ®-->op2    op2--è°·æ­Œè¿”å›çš„æ•°æ®-->op1</pre><p>é‚£ä¹ˆï¼Œæ—¢ç„¶æ•°æ®æ˜¯ä»æˆ‘çš„æœåŠ¡å™¨ä¸Šç»è¿‡çš„ï¼Œæˆ‘èƒ½ä¸èƒ½å°†æ•°æ®ä¿®æ”¹ä¸€ä¸‹ï¼Œä¼ªè£…æˆæˆ‘è‡ªå·±çš„ç«™å‘¢ï¼Œè¿æ•°æ®åº“éƒ½çœçš„è£…äº†ï¼Œç­”æ¡ˆå½“ç„¶æ˜¯å¯ä»¥çš„</p><p>æˆ‘ä»¬è¿™é‡Œå¯ä»¥å€ŸåŠ©Nginxè‡ªå¸¦çš„æ¨¡å— <em>ngx_http_sub_module</em> ï¼Œä½†æ˜¯è¿™ä¸ªæœ‰ç‚¹å¼±ï¼Œä¹Ÿå¯ä»¥é€‰ç”¨ githubä¸Šçš„ç¬¬ä¸‰æ–¹æ¨¡å—  <a href="https://github.com/yaoweibin/ngx_http_substitutions_filter_module" target="_blank" rel="noopener"><em>ngx_http_substitutions_filter_module</em></a>  æ¥å¤„ç†ï¼Œå®‰è£…è¿‡ç¨‹å°±ä¸èµ˜è¿°äº†</p><p>é…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    proxy_pass https://www.baidu.com/;</span><br><span class="line">    proxy_set_header Accept-Encoding &quot;none&quot;;  # é˜²æ­¢gzipå¯¼è‡´çš„æ›¿æ¢å¤±è´¥</span><br><span class="line">    subs_filter_types text/plain text/css text/xml; #æ›¿æ¢htmlã€cssã€xmlå†…å®¹</span><br><span class="line">    subs_filter &apos;ç™¾åº¦ä¸€ä¸‹&apos; &apos;tyloafer&apos; g;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹</p><p><img src="http://github-1253518569.cossh.myqcloud.com/baidu_sub_filter.png" alt="ç™¾åº¦æ›¿æ¢ç»“æœ"></p>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨binlogè¿˜åŸMySQLä¸­çš„è¯¯æ“ä½œ</title>
      <link href="/posts/39337/"/>
      <url>/posts/39337/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æ“ä½œæ•°æ®åº“çš„æ—¶å€™ï¼Œæ€»ä¼šæœ‰äº›æ—¶å€™é‚£ä¹ˆçš„æ‰‹è´±ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œå¦‚æœæ˜¯æµ‹è¯•ç¯å¢ƒè¿˜å¥½ï¼Œä½†æ˜¯è¦æ˜¯æ­£å¼ç¯å¢ƒï¼Œé‚£å°±åˆ åº“è·‘è·¯å§ã€‚å…¶å®ï¼Œå¦‚æœä½ æ‰“å¼€çš„bin-logï¼Œè¿™äº›æ“ä½œè¿˜æ˜¯å¯ä»¥è¢«è¿˜åŸçš„ã€‚</p><a id="more"></a><h1 id="å¼€å¯bin-log"><a href="#å¼€å¯bin-log" class="headerlink" title="å¼€å¯bin-log"></a>å¼€å¯bin-log</h1><p>bin-logæ˜¯MySQLçš„ä¸»ä»å¤åˆ¶ä¸­å¼€å¯çš„ä¸€ä¸ªé€‰é¡¹ï¼Œåœ¨ <code>/etc/my.cnf</code> ä¸­æœ‰ä¸¤ä¸ªé…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Remove leading # to turn on a very important data integrity option: logging</span><br><span class="line"># changes to the binary log between backups.</span><br><span class="line"># log_bin</span><br><span class="line"></span><br><span class="line"># These are commonly set, remove the # and set as required.</span><br><span class="line"># basedir = .....</span><br><span class="line">#datadir = .....</span><br><span class="line"># port = .....</span><br><span class="line"># server_id = .....</span><br><span class="line"># socket = .....</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ æˆ‘ä»¬éœ€è¦å…³æ³¨çš„ <code>log_bin</code>  <code>server_id</code> è¿™ä¸¤ä¸ªï¼Œé…ç½®åˆ°ä½ éœ€è¦çš„åœ°æ–¹å³å¯ï¼Œ<code>server_id</code> å¯ä»¥éšæ„ï¼Œä¸»ä»ä¸è¦å†²çªå³å¯ï¼Œä¸ªäººé…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log_bin=/data/logs/mysql/mysql-bin.log   # binlogæ—¥å¿—æ–‡ä»¶</span><br><span class="line">server_id=1</span><br></pre></td></tr></table></figure><p>é‡å¯ä¸€ä¸‹MySQLï¼Œç„¶åè¿›å…¥æ•°æ®åº“ï¼ŒæŸ¥çœ‹ä¸€ä¸‹bin-logçš„çŠ¶æ€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;log_bin%&apos;;</span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line">| Variable_name                   | Value                       |</span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line">| log_bin                         | ON                          |</span><br><span class="line">| log_bin_basename                | /data/mysql/mysql-bin       |</span><br><span class="line">| log_bin_index                   | /data/mysql/mysql-bin.index |</span><br><span class="line">| log_bin_trust_function_creators | OFF                         |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                         |</span><br><span class="line">+---------------------------------+-----------------------------+</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>log_bin</code> çš„å€¼ä¸º<code>On</code> å³è¡¨æ˜å·²ç»å¼€å¯äº† <code>log_bin</code> </p><h1 id="å¼€å§‹æ‰‹è´±å§"><a href="#å¼€å§‹æ‰‹è´±å§" class="headerlink" title="å¼€å§‹æ‰‹è´±å§"></a>å¼€å§‹æ‰‹è´±å§</h1><h2 id="åˆ¶ä½œç‚¹å‡æ•°æ®"><a href="#åˆ¶ä½œç‚¹å‡æ•°æ®" class="headerlink" title="åˆ¶ä½œç‚¹å‡æ•°æ®"></a>åˆ¶ä½œç‚¹å‡æ•°æ®</h2><p>æˆ‘ä»¬å¼€å§‹åˆ›å»ºç‚¹å‡æ•°æ®ï¼Œç”¨äºæˆ‘ä»¬çš„æµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database test;</span><br><span class="line">mysql&gt; use test;</span><br><span class="line">mysql&gt; create table binlog_test (id int unsigned not null);</span><br><span class="line">mysql&gt; insert into binlog_test values (1), (2), (3), (4), (5);</span><br></pre></td></tr></table></figure><p>å…ˆæ¥5æ¡æ•°æ®ï¼Œç„¶åæˆ‘ä»¬å¤‡ä»½ä¸€ä¸‹è¿™ä¸ªè¡¨ï¼Œå¤‡ä»½ä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸€ä¸‹<code>--master-data</code>è¿™ä¸ªå‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--master-data[=#]   This causes the binary log position and filename to be</span><br><span class="line">                    appended to the output. If equal to 1, will print it as a</span><br><span class="line">                    CHANGE MASTER command; if equal to 2, that command will</span><br><span class="line">                    be prefixed with a comment symbol. </span><br><span class="line">                    è¿™ä¸ªå‚æ•°ä¼šåœ¨å¯¼å‡ºçš„æ–‡ä»¶ä¸­åŠ å…¥æ­¤æ—¶bin-logçš„åç§»æ–‡ä»¶å’Œåç§»é‡ï¼Œ</span><br><span class="line">                    å¦‚æœè¿™ä¸ªå€¼æ˜¯1çš„ï¼Œä¼šæ‰“å°å‡ºè¿™æ¡å‘½ä»¤ï¼Œå¦‚æœç­‰äº2çš„è¯ï¼Œè¿™æ¡å‘½ä»¤</span><br><span class="line">                    å°†è¢«æ³¨é‡Šæ‰</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨å¤‡ä»½çš„æ—¶å€™ï¼Œéœ€è¦åŠ ä¸Šè¿™æ¡å‚æ•°ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º2ï¼Œä»¥æ–¹ä¾¿æˆ‘ä»¬æŸ¥æ‰¾æˆ‘ä»¬ä¸¢å¤±çš„é‚£éƒ¨åˆ†æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p --master-data=2 test &gt; test.sql</span><br></pre></td></tr></table></figure><p>å¤‡ä»½å®Œæˆäº†ï¼Œæˆ‘ä»¬å†åŠ ç‚¹å‡æ•°æ®ï¼Œæœ€åçœ‹ä¸€ä¸‹è¿™äº›æ•°æ®ä¼šä¸ä¼šè¿˜åœ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into binlog_test values (6), (7), (8), (9), (10);</span><br></pre></td></tr></table></figure><h2 id="æ‰‹è´±å§"><a href="#æ‰‹è´±å§" class="headerlink" title="æ‰‹è´±å§"></a>æ‰‹è´±å§</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from binlog_test;</span><br><span class="line">mysql&gt; drop table binlog_test;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œbinlog_testè¡¨çš„æ•°æ®åº”è¯¥å…¨éƒ¨éƒ½æ²¡æœ‰äº†ã€‚</p><h1 id="å¼€å§‹æ­£æ–‡äº†-æ¢å¤æ•°æ®"><a href="#å¼€å§‹æ­£æ–‡äº†-æ¢å¤æ•°æ®" class="headerlink" title="å¼€å§‹æ­£æ–‡äº†-æ¢å¤æ•°æ®"></a>å¼€å§‹æ­£æ–‡äº†-æ¢å¤æ•°æ®</h1><ol><li><p>å…ˆæŸ¥çœ‹ä¸€ä¸‹ å¤‡ä»½çš„åç§»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Î»  /data/mysql  more test.sql </span><br><span class="line">-- MySQL dump 10.13  Distrib 5.7.18, for Linux (x86_64)</span><br><span class="line">--</span><br><span class="line">-- Host: localhost    Database: test</span><br><span class="line">-- ------------------------------------------------------</span><br><span class="line">-- Server version5.7.18-log</span><br><span class="line"></span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;</span><br><span class="line">/*!40101 SET NAMES utf8 */;</span><br><span class="line">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;</span><br><span class="line">/*!40103 SET TIME_ZONE=&apos;+00:00&apos; */;</span><br><span class="line">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;</span><br><span class="line">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&apos;NO_AUTO_VALUE_ON_ZERO&apos; */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Position to start replication or point-in-time recovery from</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql-bin.000002&apos;, MASTER_LOG_POS=627;</span><br></pre></td></tr></table></figure><p>ä»å¤‡ä»½çš„sqlæ–‡ä»¶å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¤‡ä»½çš„åç§»æ–‡ä»¶æ˜¯ <em>mysql-bin.000002</em> ï¼Œåç§»é‡æ˜¯ <em>627</em></p></li><li><p>æŸ¥çœ‹æ‰‹è´±å‘½ä»¤çš„åç§»</p><p>æˆ‘ä»¬è¿™æ—¶å€™åº”è¯¥å°±æ˜¯æŸ¥æ‰¾ä¸€ä¸‹ æˆ‘ä»¬æ‰§è¡Œçš„deleteæ“ä½œçš„åç§»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Î»  /data/mysql  mysqlbinlog --base64-output=decode-rows mysql-bin.000002 | grep Delete -8</span><br><span class="line"># at 974</span><br><span class="line">#180717 16:37:59 server id 1  end_log_pos 1046 CRC32 0x19b80686 Querythread_id=6exec_time=0error_code=0</span><br><span class="line">SET TIMESTAMP=1531816679/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 1046</span><br><span class="line">#180717 16:37:59 server id 1  end_log_pos 1100 CRC32 0x2daa51e1 Table_map: `test`.`binlog_test` mapped to number 514</span><br><span class="line"># at 1100</span><br><span class="line">#180717 16:37:59 server id 1  end_log_pos 1185 CRC32 0x05ebafa5 Delete_rows: table id 514 flags: STMT_END_F</span><br><span class="line"># at 1185</span><br><span class="line">#180717 16:37:59 server id 1  end_log_pos 1216 CRC32 0x56c7fe9e Xid = 80</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"># at 1216</span><br><span class="line">#180717 16:44:14 server id 1  end_log_pos 1281 CRC32 0xa285c84c Anonymous_GTIDlast_committed=4sequence_number=5</span><br><span class="line">SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;/*!*/;</span><br><span class="line"># at 1281</span><br><span class="line">#180717 16:44:14 server id 1  end_log_pos 1405 CRC32 0x4474e0a7 Querythread_id=10exec_time=0error_code=0</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¬¬10è¡Œçš„æ—¶å€™è¿›è¡Œäº†åˆ é™¤æ“ä½œï¼Œåœ¨ç¬¬8è¡Œè¿›è¡Œäº†è¡¨çš„mapæ˜ å°„æŸ¥æ‰¾ï¼Œé‚£æˆ‘ä»¬è¿™æ—¶å€™ï¼Œå°†ç»“æŸçš„åç§»å°±å¯ä»¥å®šä½åˆ° <em>mysql-bin.000002</em> çš„ <em>1100</em> position</p></li><li><p>ç”Ÿæˆå¤‡ä»½åˆ°æ‰‹è´±è¿™æ®µæ—¶é—´çš„æ•°æ®</p><p>ç”±äºï¼Œæˆ‘ä»¬ä»…ä»…å¯¹teståº“è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä½¿ç”¨<code>mysqbinlog</code> å¤„ç†çš„æ—¶å€™æŒ‡å®š<code>test</code> åº“å³å¯ï¼Œä¸»è¦ç”¨åˆ°äº†ä»¥ä¸‹å‡ ä¸ªå‚æ•°ï¼Œå¯å‚è€ƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Î»  /data/mysql  mysqlbinlog --help | grep position -8</span><br><span class="line"> -j, --start-position=# </span><br><span class="line">                      Start reading the binlog at position N. Applies to the</span><br><span class="line">                      first binlog passed on the command line.</span><br><span class="line"> --stop-position=#   Stop reading the binlog at position N. Applies to the</span><br><span class="line">                      last binlog passed on the command line.</span><br><span class="line"> -d, --database=name List entries for just this database (local log only).</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --start-position=627 --stop-position=1100 --database=test  mysql-bin.000002 &gt; binlog_test_drop.sql</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬éœ€è¦çš„åŸå§‹å¤‡ä»½æ–‡ä»¶ï¼Œå’Œä¸­é—´ç¼ºå¤±çš„æ—¶é—´æ®µçš„å¤‡ä»½æ–‡ä»¶å°±éƒ½ç”Ÿæˆå¥½äº†ï¼Œä¸‹ä¸€æ­¥å°±å¯ä»¥æ¢å¤äº†</p></li><li><p>æ¢å¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p test &lt; test.sql</span><br><span class="line"> mysql -uroot -p test &lt; binlog_test_drop.sql</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ä¸€ä¸‹å§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from binlog_test;</span><br><span class="line">+----+</span><br><span class="line">| id |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">|  6 |</span><br><span class="line">|  7 |</span><br><span class="line">|  8 |</span><br><span class="line">|  9 |</span><br><span class="line">| 10 |</span><br><span class="line">+----+</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒåŸºæœ¬å¤§åŠŸå‘Šæˆäº†ï¼Œå½“ç„¶bin-logä¸ä»…ä»…æ˜¯ç”¨æ¥æ¢å¤æ•°æ®çš„ï¼Œä¸Šæ–‡ä¹Ÿè®²è¿‡äº†ï¼ŒMySQLçš„ä¸»ä»å°±æ˜¯è¦ä¾é ä»–æ¥å®Œæˆçš„ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« <a href="http://tyloafer.github.io/posts/42030/">ã€ŠMySQLä¸»ä»é…ç½®ã€‹</a>å°†ä¼šç®€å•çš„ä»‹ç»ä¸€ä¸‹</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> DataBase </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> DataBase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLä¸»ä»é…ç½®</title>
      <link href="/posts/42030/"/>
      <url>/posts/42030/</url>
      
        <content type="html"><![CDATA[<p><strong>MySQLä¸»ä»å¤åˆ¶åŸç†ï¼š</strong>masteræœåŠ¡å™¨å°†æ•°æ®çš„æ”¹å˜è®°å½•äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå½“masterä¸Šçš„æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œåˆ™å°†å…¶æ”¹å˜å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ä¸­ï¼ŒsalveæœåŠ¡å™¨ä¼šåœ¨ä¸€å®šæ—¶é—´é—´éš”å†…å¯¹masteräºŒè¿›åˆ¶æ—¥å¿—è¿›è¡Œæ¢æµ‹å…¶æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœå‘ç”Ÿæ”¹å˜ï¼Œåˆ™å¼€å§‹ä¸€ä¸ªI/OThreadè¯·æ±‚masteräºŒè¿›åˆ¶äº‹ä»¶ï¼ŒåŒæ—¶ä¸»èŠ‚ç‚¹ä¸ºæ¯ä¸ªI/Oçº¿ç¨‹å¯åŠ¨ä¸€ä¸ªdumpçº¿ç¨‹ï¼Œç”¨äºå‘å…¶å‘é€äºŒè¿›åˆ¶äº‹ä»¶ï¼Œå¹¶ä¿å­˜è‡³ä»èŠ‚ç‚¹æœ¬åœ°çš„ä¸­ç»§æ—¥å¿—ä¸­ï¼Œä»èŠ‚ç‚¹å°†å¯åŠ¨SQLçº¿ç¨‹ä»ä¸­ç»§æ—¥å¿—ä¸­è¯»å–äºŒè¿›åˆ¶æ—¥å¿—ï¼Œåœ¨æœ¬åœ°é‡æ”¾ï¼Œä½¿å¾—å…¶æ•°æ®å’Œä¸»èŠ‚ç‚¹çš„ä¿æŒä¸€è‡´ï¼Œæœ€åI/OThreadå’ŒSQLThreadå°†è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«å”¤é†’ã€‚</p><p>æ¥ä¸‹æ¥å°†ä¼šè®°å½•ä¸€ä¸‹å…·ä½“å®ç°</p><a id="more"></a><h1 id="Masterè®¾ç½®"><a href="#Masterè®¾ç½®" class="headerlink" title="Masterè®¾ç½®"></a>Masterè®¾ç½®</h1><ol><li><p>å¼€å¯mysqlçš„bin-logï¼Œä¸»å¤‡æ˜¯åŸºäºäºŒè¿›åˆ¶æ—¥å¿—çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># master</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line">server-id=1</span><br></pre></td></tr></table></figure><p>é…ç½®é‡Œé¢çš„<em>server-id</em> æ˜¯å¯ä»¥éšæ„è®¾ç½®çš„ï¼Œä½†æ˜¯è¦ä¿è¯åœ¨é›†ç¾¤ä¸­çš„å”¯ä¸€æ€§ï¼Œ</p></li><li><p>é‡å¯mysqlï¼Œè®©è®¾ç½®ç”Ÿæ•ˆ</p></li><li><p>åˆ›å»ºä¸€ä¸ªå¤‡ä»½è´¦å·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION SLAVE ON *.* to &apos;username&apos;@&apos;ip&apos; identified by &apos;password&apos;;</span><br></pre></td></tr></table></figure></li><li><p>å¯¼å‡ºmasterçš„æ•°æ®ï¼Œå¹¶ä¸”è®°å½•å¯¼å‡ºæ—¶çš„bin-logåç§»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p --master-data=2  --all-databases &gt; all_databases.sql</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  /data/www/html  âœ— more httpserver.sql</span><br><span class="line">--</span><br><span class="line">-- Position to start replication or point-in-time recovery from</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql-bin.000001&apos;, MASTER_LOG_POS=750663;</span><br></pre></td></tr></table></figure><p>å‘½ä»¤ä¸­çš„ <em>â€“master-data=2</em> æ˜¯ä¸ºäº†å°† <em>CHANGE MASTER TO MASTER_LOG_FILE=â€™mysql-bin.000001â€™, MASTER_LOG_POS=750663;</em>  è¿›è¡Œæ³¨é‡Šï¼Œè¿™é‡Œè®°å½•çš„ log_fileå’Œ log_pos å°†ä¼šåœ¨å¤‡ä»½æœåŠ¡å™¨çš„è®¾ç½®ä¸Šä½¿ç”¨</p></li></ol><h1 id="Slaveè®¾ç½®"><a href="#Slaveè®¾ç½®" class="headerlink" title="Slaveè®¾ç½®"></a>Slaveè®¾ç½®</h1><ol><li><p>é¦–å…ˆè®¾ç½®server-idï¼Œåœ¨ <code>my.cnf</code> ä¸­åŠ å…¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># replicate</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin   // å¯ä»¥ä¸å¼€å¯</span><br><span class="line">server-id=2    // è¿™ä¸ªå€¼ä¸å¯ä¸masterç›¸åŒ</span><br><span class="line">replicate-do-db = db1,db2///   // é€‰æ‹©éœ€è¦åŒæ­¥çš„æ•°æ®åº“ï¼Œä¸å†™åˆ™å…¨éƒ¨åŒæ­¥</span><br></pre></td></tr></table></figure></li><li><p>é‡å¯mysql</p></li><li><p>å¯¼å…¥æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p &lt; all_databases.sql</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®masterä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql root@localhost:(none)&gt;  change master to master_host=&apos;ip&apos;,master_user=&apos;user&apos;,master_password=&apos;password&apos;, master_log_file=&apos;mysql-bin.000001&apos;,master_log_pos=750663;</span><br></pre></td></tr></table></figure><p>è¿™å¤©å‘½ä»¤ä¸­çš„ <em>master_log_file=â€™mysql-bin.000001â€™,master_log_pos=750663;</em>  ä¾¿æ˜¯ä¸Šé¢sqlæ–‡ä»¶ä¸­æ³¨é‡Šçš„å†…å®¹</p></li><li><p>å¼€å¯åŒæ­¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql root@localhost:(none)&gt;  start slave</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹slaveçŠ¶æ€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql root@localhost:(none)&gt; show slave status\G</span><br><span class="line"></span><br><span class="line">   *************************** 1. row ***************************</span><br><span class="line"></span><br><span class="line">              Slave_IO_State: Waiting for master to send event</span><br><span class="line">              Master_Host: ip  //ä¸»æœåŠ¡å™¨åœ°å€</span><br><span class="line">              Master_User: user   //æˆæƒå¸æˆ·åï¼Œå°½é‡é¿å…ä½¿ç”¨root</span><br><span class="line">              Master_Port: 3306    //æ•°æ®åº“ç«¯å£ï¼Œéƒ¨åˆ†ç‰ˆæœ¬æ²¡æœ‰æ­¤è¡Œ</span><br><span class="line">              Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000004</span><br><span class="line">              Read_Master_Log_Pos: 600     //#åŒæ­¥è¯»å–äºŒè¿›åˆ¶æ—¥å¿—çš„ä½ç½®ï¼Œå¤§äºç­‰äºExec_Master_Log_Pos</span><br><span class="line">              Relay_Log_File: ddte-relay-bin.000003</span><br><span class="line">              Relay_Log_Pos: 251</span><br><span class="line">              Relay_Master_Log_File: mysql-bin.000004</span><br><span class="line">              Slave_IO_Running: Yes    //æ­¤çŠ¶æ€å¿…é¡»YES</span><br><span class="line">              Slave_SQL_Running: Yes     //æ­¤çŠ¶æ€å¿…é¡»YES</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> DataBase </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> DataBase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆå››ï¼‰ï¼šrewriteä½¿ç”¨ä»‹ç»</title>
      <link href="/posts/25652/"/>
      <url>/posts/25652/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><table><thead><tr><th>key</th><th>value</th></tr></thead><tbody><tr><td>è¯­æ³•:</td><td><code>rewrite regex replacement [flag];</code></td></tr><tr><td>é»˜è®¤å€¼:</td><td>â€”</td></tr><tr><td>ä¸Šä¸‹æ–‡:</td><td><code>server</code>, <code>location</code>, <code>if</code></td></tr></tbody></table><a id="more"></a><h2 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h2><ul><li><code>last</code>       # åœæ­¢æ‰§è¡Œå½“å‰è¿™ä¸€è½®çš„<code>ngx_http_rewrite_module</code>æŒ‡ä»¤é›†ï¼Œç„¶åæŸ¥æ‰¾åŒ¹é…æ”¹å˜åURIçš„æ–°locationï¼›</li><li><code>break</code>      # åœæ­¢æ‰§è¡Œå½“å‰è¿™ä¸€è½®çš„<code>ngx_http_rewrite_module</code>æŒ‡ä»¤é›†ï¼›</li><li><code>redirect</code>         # åœ¨replacementå­—ç¬¦ä¸²æœªä»¥â€œ<code>http://</code>â€æˆ–â€œ<code>https://</code>â€å¼€å¤´æ—¶ï¼Œä½¿ç”¨è¿”å›çŠ¶æ€ç ä¸º302çš„ä¸´æ—¶é‡å®šå‘ï¼›</li><li><code>permanent</code>        # è¿”å›çŠ¶æ€ç ä¸º301çš„æ°¸ä¹…é‡å®šå‘ã€‚</li></ul><h2 id="ä¾‹"><a href="#ä¾‹" class="headerlink" title="ä¾‹"></a>ä¾‹</h2><p>é’ˆå¯¹äº<code>last</code> å’Œ <code>break</code> ä¸¾ä¾‹</p><ol><li><p>å…ˆæµ‹è¯•last</p><p>nginxé…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ /rewrite/last &#123;</span><br><span class="line">    rewrite .* /rewrite/break.html last;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line">location ~ /rewrite/break &#123;</span><br><span class="line">retorn 200 &apos;break&apos;;</span><br><span class="line">    rewrite .* /last.html break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>GET <a href="http://test.tyloafer.cn/rewrite/last" target="_blank" rel="noopener">http://test.tyloafer.cn/rewrite/last</a></p><p>ç»“æœï¼š break</p></blockquote><p>ä¸Šé¢ç»“æœè¡¨æ˜ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¯·æ±‚åŒ¹é…åˆ° <code>/rewrite/last</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ­¤æ—¶åº”è¯¥æŠŠuri é‡å†™æˆäº† <code>http://test.tyloafer.cn/rewrite/break.html</code>, ç„¶åæ‹¿ç€è¿™ä¸ªuriåæ‰¾ nginxè§£æï¼Œä»è€ŒåŒ¹é…åˆ°äº† ç¬¬äºŒä¸ªlocation</p><p>å³ï¼Œ å½“æˆ‘ä»¬ä½¿ç”¨ <code>last</code> çš„æ—¶å€™ï¼Œnginxä¼šæ‹¿ç€è§£æåçš„uriå†æ¬¡è¿›è¡Œè§£æ</p></li><li><p>å†æµ‹è¯•last</p><p>nginxé…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ /rewrite/last &#123;</span><br><span class="line">return 200 'last';</span><br><span class="line">    rewrite .* /rewrite/break.html last;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line">location ~ /rewrite/break &#123;</span><br><span class="line">    rewrite .* /last.html break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>last.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this is last.html</span><br></pre></td></tr></table></figure><blockquote><p>GET <a href="http://test.tyloafer.cn/rewrite/break" target="_blank" rel="noopener">http://test.tyloafer.cn/rewrite/break</a></p><p>ç»“æœï¼š this is last.html</p></blockquote><p>ä¸Šé¢ç»“æœè¡¨æ˜ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¯·æ±‚åŒ¹é…åˆ° <code>/rewrite/breakçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ­¤æ—¶åº”è¯¥æŠŠuri é‡å†™æˆäº†</code><a href="http://test.tyloafer.cn/rewrite/blast.html`" target="_blank" rel="noopener">http://test.tyloafer.cn/rewrite/blast.html`</a>, ç„¶åæ‹¿ç€è¿™ä¸ªuriåï¼Œ ç›´æ¥å»æ‰¾ç›¸åº”çš„æ–‡ä»¶äº†</p><p>å³ï¼Œ å½“æˆ‘ä»¬ä½¿ç”¨ <code>break</code> çš„æ—¶å€™ï¼Œnginxä¼šæ‹¿ç€è§£æåçš„uriä¸åœ¨è§£æï¼Œå°±éšä»–å»å§</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨Vultrï¼ˆcentos7ï¼‰ä¸Šå®‰è£…shadowsockåŠGoogle BBRå®ç°å…¨é€Ÿç¿»å¢™</title>
      <link href="/posts/561/"/>
      <url>/posts/561/</url>
      
        <content type="html"><![CDATA[<p>å¯¹äºç¨‹åºçŒ¿æ¥è¯´ï¼Œç™¾åº¦å°±æ˜¯ä¸€ä¸ªå‘çš„å­˜åœ¨ï¼Œæ‰¾ä¸€ä¸ªé—®é¢˜ï¼Œå‰é¢å‡ é¡µéƒ½æ˜¯æŠ„è¢­ã€é›·åŒçš„é—®é¢˜ï¼Œè¿˜æœ‰è‹¥å¹²çš„ç™¾åº¦ç»éªŒï¼Œä½†æ˜¯ï¼Œå¯¹äºè¿‘æœŸçš„å¢™æ˜¯è¶Šæ¥è¶Šåšäº†ï¼Œå„ç§ssè´¦å·éƒ½å¤±æ•ˆäº†ï¼Œæ— å¥ˆå¼€å§‹è‡ªå·±åŠ¨æ‰‹æ­æ¢¯å­å§ã€‚é€šè¿‡ç½‘ä¸Šå„ç§å¯¹æ¯”åï¼Œæœ€åé€‰äº†äº†<a href="https://www.vultr.com/?ref=7290537" target="_blank" rel="noopener"> Vultr</a> , å®‰è£…Google BBRååŸºæœ¬å¯ä»¥æ»¡é€Ÿç¿»å¢™ï¼Œè€Œä¸”ï¼Œæœ€å¼ºå¤§çš„æ˜¯ï¼Œå¯ä»¥æ›´æ¢IPï¼Œç°åœ¨æœ€ä¾¿å®œçš„å¥—é¤ 2.5$æ¯æœˆï¼Œ500Gçš„æµé‡ï¼Œä¹Ÿæ˜¯è¶³å¤Ÿäº†</p><blockquote><p><a href="https://www.vultr.com/?ref=7540935" target="_blank" rel="noopener">Vultrå®˜ç½‘æ³¨å†Œåœ°å€</a></p></blockquote><a id="more"></a><p>ä¸‹é¢å¼€å§‹ä»‹ç»å®‰è£…é…ç½®è¿‡ç¨‹ï¼Œå½“ç„¶ä¸ä»…å±€é™äº Vultrçš„æœåŠ¡å™¨ï¼ŒCentOS7çš„éƒ½å¯ä»¥å‚è€ƒã€‚</p><h1 id="å®‰è£…pip"><a href="#å®‰è£…pip" class="headerlink" title="å®‰è£…pip"></a>å®‰è£…pip</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install python python-pip</span><br><span class="line">pip install --upgrade pip</span><br></pre></td></tr></table></figure><h1 id="å®‰è£…é…ç½®shadowsock"><a href="#å®‰è£…é…ç½®shadowsock" class="headerlink" title="å®‰è£…é…ç½®shadowsock"></a>å®‰è£…é…ç½®shadowsock</h1><h2 id="å®‰è£…shadowsock"><a href="#å®‰è£…shadowsock" class="headerlink" title="å®‰è£…shadowsock"></a>å®‰è£…shadowsock</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å®‰è£…å®Œæˆäº†shadowsock</p><h2 id="é…ç½®shadowsock"><a href="#é…ç½®shadowsock" class="headerlink" title="é…ç½®shadowsock"></a>é…ç½®shadowsock</h2><p>é¦–å…ˆè¦åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œç„¶åshadowsockç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶å¯åŠ¨å³å¯</p><p>ä¸ªäººä¹ æƒ¯å°†é…ç½®æ–‡ä»¶æ”¾åœ¨ <code>/etc</code> ç›®å½•ä¸‹</p><p>æ‰€ä»¥ï¼Œè¿™é‡Œé¦–å…ˆåˆ›å»ºæ–‡ä»¶ <code>/etc/shadowsocks.json</code> ï¼Œå¹¶æ·»åŠ ä¸€ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      &quot;server&quot;:&quot;0.0.0.0&quot;,</span><br><span class="line">      &quot;server_port&quot;:2082,</span><br><span class="line">      &quot;local_port&quot;:1080,</span><br><span class="line">      &quot;password&quot;:&quot;yourpass&quot;,</span><br><span class="line">      &quot;timeout&quot;:600,</span><br><span class="line">      &quot;method&quot;:&quot;rc4-md5&quot;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦åˆ›å»ºå¤šç”¨æˆ·çš„ï¼Œ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„é…ç½®æ–‡ä»¶æ ¼å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#### å¤šç”¨æˆ·ç‰ˆæœ¬</span><br><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;0.0.0.0&quot;,</span><br><span class="line">    &quot;local_port&quot;:1080,</span><br><span class="line">    &quot;port_password&quot;:&#123;</span><br><span class="line">         &quot;8989&quot;:&quot;password0&quot;,</span><br><span class="line">         &quot;9001&quot;:&quot;password1&quot;,</span><br><span class="line">         &quot;9002&quot;:&quot;password2&quot;,</span><br><span class="line">         &quot;9003&quot;:&quot;password3&quot;,</span><br><span class="line">         &quot;9004&quot;:&quot;password4&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;timeout&quot;:300,</span><br><span class="line">    &quot;method&quot;:&quot;aes-256-cfb&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š</p><ul><li><code>method</code>ä¸ºåŠ å¯†æ–¹æ³•ï¼Œå¯é€‰<code>aes-128-cfb, aes-192-cfb, aes-256-cfb, bf-cfb, cast5-cfb, des-cfb, rc4-md5, chacha20, salsa20, rc4, table</code></li><li><code>server_port</code>  ä¸ºæœåŠ¡ç›‘å¬ç«¯å£ï¼Œ è¿™ä¸ªéœ€è¦åœ¨ vultræˆ–è€…æœåŠ¡å™¨ç®¡ç†ç•Œé¢å¼€å¯</li><li><code>port_password</code> ä¸ºå¤šç”¨æˆ·çš„æ—¶å€™ï¼Œé…ç½®çš„ port: pass çš„jsonä¸²</li></ul><h2 id="é…ç½®è‡ªå¯åŠ¨"><a href="#é…ç½®è‡ªå¯åŠ¨" class="headerlink" title="é…ç½®è‡ªå¯åŠ¨"></a>é…ç½®è‡ªå¯åŠ¨</h2><p>æ–°å»ºå¯åŠ¨è„šæœ¬æ–‡ä»¶<code>/etc/systemd/system/shadowsocks.service</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Shadowsocks</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStart=/usr/bin/ssserver -c /etc/shadowsocks.json</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ shadowsocks æœåŠ¡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable shadowsocks  # å¯ç”¨æœåŠ¡</span><br><span class="line">systemctl start shadowsocks   # å¯åŠ¨æœåŠ¡</span><br><span class="line">systemctl stop shadowsocks   # åœæ­¢æœåŠ¡</span><br></pre></td></tr></table></figure><p>æ³¨ï¼š å¦‚æœä½¿ç”¨å¤šç”¨æˆ·çš„æ¨¡å¼ï¼Œæœ‰å¯èƒ½æ— æ³•ä½¿ç”¨ system æ¥å¯åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ssserver -c /etc/shadowsocks.json -d start # å¯åŠ¨</span><br><span class="line">/usr/bin/ssserver -c /etc/shadowsocks.json -d stop  # åœæ­¢</span><br><span class="line">echo &quot;/usr/bin/ssserver -c /etc/shadowsocks.json -d start&quot; &gt;&gt; /etc/rc.local # æ·»åŠ åˆ°å¼€æœºè‡ªå¯åŠ¨</span><br></pre></td></tr></table></figure><h1 id="å®‰è£…BBRåŠ é€Ÿ"><a href="#å®‰è£…BBRåŠ é€Ÿ" class="headerlink" title="å®‰è£…BBRåŠ é€Ÿ"></a>å®‰è£…BBRåŠ é€Ÿ</h1><blockquote><p><strong>æ³¨æ„: </strong>éœ€è¦å†…æ ¸4.9åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä½¿ç”¨<code>uname -r</code>æŸ¥çœ‹ã€‚</p></blockquote><p>æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨Google BBRä¸€é”®å®‰è£…è„šæœ¬ã€‚</p><ol><li><p>è·å–è„šæœ¬å¹¶æ‰§è¡Œ(root)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://github.com/teddysun/across/raw/master/bbr.sh</span><br><span class="line">sh ./bbr.sh</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬æ˜¯å¦ &gt; 4.9 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œ <code>sysctl net.ipv4.tcp_available_congestion_control</code> ï¼Œ æŸ¥çœ‹æ˜¯å¦è¿”å›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_available_congestion_control = reno cubic bbr</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œ<code>sysctl net.core.default_qdisc</code> ï¼Œ æŸ¥çœ‹æ˜¯å¦è¿”å›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.core.default_qdisc = fq</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œ <code>lsmod | grep bbr</code>ï¼Œ è¿”å›å€¼æœ‰tcp_bbr å³å·²å¯åŠ¨</p></li></ol><p>å®‰è£…å®Œæˆåï¼Œè„šæœ¬ä¼šæç¤ºéœ€è¦é‡å¯ VPSï¼Œè¾“å…¥ y å¹¶å›è½¦åé‡å¯ã€‚</p><h1 id="é™„"><a href="#é™„" class="headerlink" title="é™„"></a>é™„</h1><p>è¿‘æœŸçš„æœåŠ¡å™¨è€æ˜¯è¢«å°è¯•æš´åŠ›ç ´è§£ï¼Œç„¶åipè¢«å°ï¼Œæä¾›ä¸€ä¸‹è„šæœ¬è¿›è¡Œå¤„ç†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">cat /var/log/secure|awk &apos;/Failed/&#123;print $(NF-3)&#125;&apos;|sort|uniq -c|awk &apos;&#123;print $2&quot;=&quot;$1;&#125;&apos; &gt; /home/sxdgy/lastb</span><br><span class="line">for i in `cat  /home/sxdgy/lastb`</span><br><span class="line">do</span><br><span class="line">  IP=`echo $i |awk -F= &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">  NUM=`echo $i|awk -F= &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">  if [ $&#123;#NUM&#125; -gt 1 ]; then</span><br><span class="line">    grep $IP /etc/hosts.deny &gt; /dev/null</span><br><span class="line">    if [ $? -gt 0 ];then</span><br><span class="line">      echo &quot;sshd:$IP:deny&quot; &gt;&gt; /etc/hosts.deny</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç§‘å­¦ä¸Šç½‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç§‘å­¦ä¸Šç½‘ </tag>
            
            <tag> ShadowSock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šæ¡ä»¶åˆ¤æ–­åŠè¿ç®—ç¬¦</title>
      <link href="/posts/211/"/>
      <url>/posts/211/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><table><thead><tr><th>key</th><th>value</th></tr></thead><tbody><tr><td>è¯­æ³•:</td><td><code>if (condition) { ... }</code></td></tr><tr><td>é»˜è®¤å€¼:</td><td>â€”</td></tr><tr><td>ä¸Šä¸‹æ–‡:</td><td><code>server</code>, <code>location</code></td></tr></tbody></table><a id="more"></a><h2 id="condition"><a href="#condition" class="headerlink" title="condition"></a>condition</h2><ul><li>å˜é‡åï¼›å¦‚æœå˜é‡å€¼ä¸ºç©ºæˆ–è€…æ˜¯ä»¥â€œ<code>0</code>â€å¼€å§‹çš„å­—ç¬¦ä¸²ï¼Œåˆ™æ¡ä»¶ä¸ºå‡ï¼›</li><li>ä½¿ç”¨â€œ<code>=</code>â€å’Œâ€œ<code>!=</code>â€è¿ç®—ç¬¦æ¯”è¾ƒå˜é‡å’Œå­—ç¬¦ä¸²ï¼›</li><li>ä½¿ç”¨â€œ<code>~</code>â€ï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰å’Œâ€œ<code>~*</code>â€ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰è¿ç®—ç¬¦åŒ¹é…å˜é‡å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥åŒ…å«åŒ¹é…ç»„ï¼ŒåŒ¹é…ç»“æœåç»­å¯ä»¥ä½¿ç”¨å˜é‡<code>$1</code>..<code>$9</code>å¼•ç”¨ã€‚å¦‚æœæ­£åˆ™è¡¨è¾¾å¼ä¸­åŒ…å«å­—ç¬¦â€œ<code>}</code>â€æˆ–è€…â€œ<code>;</code>â€ï¼Œæ•´ä¸ªè¡¨è¾¾å¼åº”è¯¥è¢«åŒ…å«åœ¨å•å¼•å·æˆ–åŒå¼•å·çš„å¼•ç”¨ä¸­ã€‚</li><li>ä½¿ç”¨â€œ<code>-f</code>â€å’Œâ€œ<code>!-f</code>â€è¿ç®—ç¬¦æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼›</li><li>ä½¿ç”¨â€œ<code>-d</code>â€å’Œâ€œ<code>!-d</code>â€è¿ç®—ç¬¦æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ï¼›</li><li>ä½¿ç”¨â€œ<code>-e</code>â€å’Œâ€œ<code>!-e</code>â€è¿ç®—ç¬¦æ£€æŸ¥æ–‡ä»¶ã€ç›®å½•æˆ–ç¬¦å·é“¾æ¥æ˜¯å¦å­˜åœ¨ï¼›</li><li>ä½¿ç”¨â€œ<code>-x</code>â€å’Œâ€œ<code>!-x</code>â€è¿ç®—ç¬¦æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶ï¼›</li></ul><h2 id="ä¾‹"><a href="#ä¾‹" class="headerlink" title="ä¾‹"></a>ä¾‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~ MSIE) &#123;</span><br><span class="line">    return 200 'IE &gt;_&gt;';</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($http_cookie ~* "id=([^;]+)(?:;|$)") &#123;</span><br><span class="line">    set $id $1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($http_refer != 'test.tyloafer.cn') &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($vip) &#123;</span><br><span class="line">    limit_rate 10k;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!-e $request_uri) &#123;</span><br><span class="line">    rewrite /(.*)$ /index.php?r=$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ‰©å±•ï¼ˆé€»è¾‘è¿ç®—å®ç°ï¼‰"><a href="#æ‰©å±•ï¼ˆé€»è¾‘è¿ç®—å®ç°ï¼‰" class="headerlink" title="æ‰©å±•ï¼ˆé€»è¾‘è¿ç®—å®ç°ï¼‰"></a>æ‰©å±•ï¼ˆé€»è¾‘è¿ç®—å®ç°ï¼‰</h2><p>æœ‰æ—¶é—´ä¸ºäº†å®ç°éœ€æ±‚ï¼Œæˆ‘ä»¬å¯èƒ½é¿å…ä¸äº†è¦ä½¿ç”¨é€»è¾‘è¿ç®—ï¼Œ ä½†æ˜¯nginxå¹¶æœªæä¾›ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è¿™æ—¶å€™åªæœ‰é€šè¿‡ è®¾ç½®å˜é‡çš„å€¼ æ¥å˜ç›¸çš„å®ç°é€»è¾‘è¿ç®—äº†</p><p>éœ€æ±‚</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> (!-e <span class="variable">$request_uri</span> &amp;&amp; !-d <span class="variable">$request_uri</span>) &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">404</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">set</span> <span class="variable">$flag</span>  <span class="number">0</span>;</span><br><span class="line"><span class="attribute">if</span> (!-e <span class="variable">$request_uri</span>) &#123;</span><br><span class="line">    <span class="attribute">set</span> set <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (!-d <span class="variable">$request_uri</span>) &#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$flag</span> = <span class="string">'011'</span>) &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">404</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆäºŒï¼‰ï¼šçŠ¶æ€ç </title>
      <link href="/posts/48459/"/>
      <url>/posts/48459/</url>
      
        <content type="html"><![CDATA[<p>è¿™é‡Œè®°å½•äº†ä¸€ä¸‹Nginxä½¿ç”¨è¿‡ç¨‹ä¸­å¸¸è§çš„çŠ¶æ€ç ï¼Œä»…ä»…æ˜¯åšäº†ä¸€ä¸‹è§£é‡Šï¼Œå¦‚æœé‡åˆ°ä¸‹é¢çš„é—®é¢˜ï¼Œå¯ä»¥åˆ°æ ¹æ®æ‰€ä»£è¡¨çš„æ„ä¹‰ï¼Œå»ç›¸åº”çš„åº”ç”¨ç¨‹åºæŸ¥çœ‹ error logï¼Œä»¥æ­¤æ¥æ‰¾å‡ºå¯¹åº”çš„è§£å†³æ–¹æ¡ˆ</p><a id="more"></a><table><thead><tr><th>ç±»åˆ«</th><th>çŠ¶æ€ç </th><th>çŠ¶æ€æ„ä¹‰</th></tr></thead><tbody><tr><td><strong>æ¶ˆæ¯ç±»(1å­—å¤´)</strong></td><td></td><td></td></tr><tr><td><strong>æˆåŠŸç±»ï¼ˆ2å­—å¤´ï¼‰</strong></td><td>200</td><td>æˆåŠŸå¤„ç†è¯·æ±‚</td></tr><tr><td><strong>é‡å®šå‘ç´¯ï¼ˆ3å­—å¤´ï¼‰</strong></td><td>301</td><td>æ°¸ä¹…é‡å®šå‘</td></tr><tr><td></td><td>302</td><td>ä¸´æ—¶é‡å®šå‘</td></tr><tr><td></td><td>304</td><td>æœªä¿®æ”¹ï¼Œèµ°ç¼“å­˜</td></tr><tr><td><strong>è¯·æ±‚é”™è¯¯ç±»ï¼ˆ4å­—å¤´ï¼‰</strong></td><td>400</td><td>æœåŠ¡å™¨ä¸ç†è§£è¯·æ±‚çš„è¯­æ³•ã€‚</td></tr><tr><td></td><td>401</td><td>è¯·æ±‚è¦æ±‚èº«ä»½éªŒè¯ã€‚ å¯¹äºéœ€è¦ç™»å½•çš„ç½‘é¡µï¼ŒæœåŠ¡å™¨å¯èƒ½è¿”å›æ­¤å“åº”ã€‚</td></tr><tr><td></td><td>403</td><td>æœåŠ¡å™¨æ‹’ç»è¯·æ±‚</td></tr><tr><td></td><td>404</td><td>æ²¡æœ‰æ‰¾åˆ°èµ„æº</td></tr><tr><td></td><td>499</td><td>å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥</td></tr><tr><td><strong>æœåŠ¡å™¨é”™è¯¯ç±»ï¼ˆ5å­—å¤´ï¼‰</strong></td><td>500</td><td>æœåŠ¡å™¨é‡åˆ°é”™è¯¯ï¼Œæ— æ³•å®Œæˆè¯·æ±‚</td></tr><tr><td></td><td>502</td><td>ç½‘å…³å‡ºé”™</td></tr><tr><td></td><td>504</td><td>æœåŠ¡ç«¯å¤„ç†è¯·æ±‚è¶…æ—¶</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šå˜é‡</title>
      <link href="/posts/62480/"/>
      <url>/posts/62480/</url>
      
        <content type="html"><![CDATA[<p>nginxåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æœ€åŸºç¡€çš„åº”è¯¥å°±æ˜¯ å˜é‡äº†ï¼Œ ä¸ç„¶åœ¨rewiteæˆ–locationåŒ¹é…çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½å°±æ— ä»ä¸‹æ‰‹äº†ï¼Œåœ¨è¿™é‡Œï¼Œä¸ªäººæ•´ç†äº†ä¸€ä¸‹nginxçš„å˜é‡ï¼Œå¹¶åšäº†ä¸€ä¸‹ç®€å•çš„æµ‹è¯•ï¼Œä»…ä¾›å‚è€ƒ</p><a id="more"></a><h1 id="å†…ç½®å˜é‡"><a href="#å†…ç½®å˜é‡" class="headerlink" title="å†…ç½®å˜é‡"></a>å†…ç½®å˜é‡</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><ul><li><p>$args ï¼š è¿™ä¸ªå˜é‡ç­‰äºè¯·æ±‚è¡Œä¸­çš„å‚æ•°ï¼ŒåŒ\$query_string</p></li><li><p>$content_length ï¼š è¯·æ±‚å¤´ä¸­çš„Content-lengthå­—æ®µã€‚</p></li><li><p>$content_type ï¼š è¯·æ±‚å¤´ä¸­çš„Content-Typeå­—æ®µã€‚</p></li><li><p>$document_root ï¼š å½“å‰è¯·æ±‚åœ¨rootæŒ‡ä»¤ä¸­æŒ‡å®šçš„å€¼ã€‚</p></li><li><p>$host ï¼š è¯·æ±‚ä¸»æœºå¤´å­—æ®µï¼Œå¦åˆ™ä¸ºæœåŠ¡å™¨åç§°ã€‚</p></li><li><p>$http_user_agent ï¼š å®¢æˆ·ç«¯agentä¿¡æ¯</p></li><li><p>$http_cookie ï¼š å®¢æˆ·ç«¯cookieä¿¡æ¯</p></li><li><p>$limit_rate ï¼š è¿™ä¸ªå˜é‡å¯ä»¥é™åˆ¶è¿æ¥é€Ÿç‡ã€‚</p></li><li><p>$request_method ï¼š å®¢æˆ·ç«¯è¯·æ±‚çš„åŠ¨ä½œï¼Œé€šå¸¸ä¸ºGETæˆ–POSTã€‚</p></li><li><p>$remote_addr ï¼š å®¢æˆ·ç«¯çš„IPåœ°å€ã€‚</p></li><li><p>$remote_port ï¼š å®¢æˆ·ç«¯çš„ç«¯å£ã€‚</p></li><li><p>$remote_user ï¼š å·²ç»ç»è¿‡Auth Basic ModuleéªŒè¯çš„ç”¨æˆ·åã€‚</p></li><li><p>$request_filename ï¼š å½“å‰è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç”±rootæˆ–aliasæŒ‡ä»¤ä¸URIè¯·æ±‚ç”Ÿæˆã€‚</p></li><li><p>$scheme ï¼š HTTPæ–¹æ³•ï¼ˆå¦‚httpï¼Œhttpsï¼‰ã€‚</p></li><li><p>$server_protocol ï¼š è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼Œé€šå¸¸æ˜¯HTTP/1.0æˆ–HTTP/1.1ã€‚</p></li><li><p>$server_addr ï¼š æœåŠ¡å™¨åœ°å€ï¼Œåœ¨å®Œæˆä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨åå¯ä»¥ç¡®å®šè¿™ä¸ªå€¼ã€‚</p></li><li><p>$server_name ï¼š æœåŠ¡å™¨åç§°ã€‚</p></li><li><p>$server_port ï¼š è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨çš„ç«¯å£å·ã€‚</p></li><li><p>$request_uri ï¼š åŒ…å«è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œå¦‚ï¼šâ€/foo/bar.php?arg=bazâ€ã€‚</p></li><li><p>$uri ï¼š ä¸å¸¦è¯·æ±‚å‚æ•°çš„å½“å‰URIï¼Œ\$uriä¸åŒ…å«ä¸»æœºåï¼Œå¦‚â€/foo/bar.htmlâ€ã€‚</p></li><li><p>\$document_uri ï¼š ä¸$uriç›¸åŒã€‚</p></li></ul><h2 id="ä¾‹"><a href="#ä¾‹" class="headerlink" title="ä¾‹"></a>ä¾‹</h2><p>æˆ‘ä»¬ä»¥GETæ–¹å¼è¯·æ±‚ <code>http://test.tyloafer.cn/variable?a=1&amp;b=2&amp;c=3</code> ä¸ºä¾‹</p><p>nginxé…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">location = /variable &#123;</span><br><span class="line">    add_header  Content-Type &apos;text/html; charset=utf-8&apos;;</span><br><span class="line">    return 200 &quot;</span><br><span class="line">        args = $args&lt;br /&gt;</span><br><span class="line">        binary_remote_addr = $binary_remote_addr&lt;br /&gt;</span><br><span class="line">        body_bytes_sent = $body_bytes_sent&lt;br /&gt;</span><br><span class="line">        content_length = $content_length&lt;br /&gt;</span><br><span class="line">        content_type= $content_type&lt;br /&gt;</span><br><span class="line">        document_root = $document_root&lt;br /&gt;</span><br><span class="line">        document_uri = $document_uri&lt;br /&gt;</span><br><span class="line">        host = $host&lt;br /&gt;</span><br><span class="line">        hostname   = $hostname&lt;br /&gt;</span><br><span class="line">        http_user_agent = $http_user_agent&lt;br /&gt;</span><br><span class="line">        is_args = $is_args&lt;br /&gt;</span><br><span class="line">        limit_rate  = $limit_rate&lt;br /&gt;</span><br><span class="line">        nginx_version  = $nginx_version&lt;br /&gt;</span><br><span class="line">        query_string  = $query_string&lt;br /&gt;</span><br><span class="line">        remote_addr  = $remote_addr&lt;br /&gt;</span><br><span class="line">        remote_port  = $remote_port&lt;br /&gt;</span><br><span class="line">        request_filename = $request_filename&lt;br /&gt;</span><br><span class="line">        request_body  = $request_body&lt;br /&gt;</span><br><span class="line">        request_body_file  = $request_body_file&lt;br /&gt;</span><br><span class="line">        request_completion  = $request_completion&lt;br /&gt;</span><br><span class="line">        request_method  = $request_method&lt;br /&gt;</span><br><span class="line">        request_uri  = $request_uri&lt;br /&gt;</span><br><span class="line">        scheme  = $scheme&lt;br /&gt;</span><br><span class="line">        server_addr  = $server_addr&lt;br /&gt;</span><br><span class="line">        server_name  = $server_name&lt;br /&gt;</span><br><span class="line">        server_port  = $server_port&lt;br /&gt;</span><br><span class="line">        server_protocol  = $server_protocol&lt;br /&gt;&quot;;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>GET <a href="http://test.tyloafer.cn/variable?a=1&amp;b=2&amp;c=3" target="_blank" rel="noopener">http://test.tyloafer.cn/variable?a=1&amp;b=2&amp;c=3</a></p></blockquote><p>è¿”å›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">args = a=1&amp;b=2&amp;c=3</span><br><span class="line">binary_remote_addr = sï¿½iï¿½</span><br><span class="line">body_bytes_sent = 0</span><br><span class="line">content_length = </span><br><span class="line">content_type= </span><br><span class="line">document_root = /usr/share/nginx/html</span><br><span class="line">document_uri = /variable</span><br><span class="line">host = test.tyloafer.cn</span><br><span class="line">hostname = vm_248_128_centos</span><br><span class="line">http_user_agent = Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.170 Safari/537.36</span><br><span class="line">is_args = ?</span><br><span class="line">limit_rate = 0</span><br><span class="line">nginx_version = 1.12.2</span><br><span class="line">query_string = a=1&amp;b=2&amp;c=3</span><br><span class="line">remote_addr = 115.216.105.144</span><br><span class="line">remote_port = 10212</span><br><span class="line">request_filename = /usr/share/nginx/html/variable</span><br><span class="line">request_body = </span><br><span class="line">request_body_file = </span><br><span class="line">request_completion = </span><br><span class="line">request_method = GET</span><br><span class="line">request_uri = /variable?a=1&amp;b=2&amp;c=3</span><br><span class="line">scheme = http</span><br><span class="line">server_addr = 10.105.248.128</span><br><span class="line">server_name = test.tyloafer.cn</span><br><span class="line">server_port = 80</span><br><span class="line">server_protocol = HTTP/1.1</span><br></pre></td></tr></table></figure><h1 id="è‡ªå®šä¹‰å˜é‡"><a href="#è‡ªå®šä¹‰å˜é‡" class="headerlink" title="è‡ªå®šä¹‰å˜é‡"></a>è‡ªå®šä¹‰å˜é‡</h1><p>nginxé…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ~ /self-variable &#123;</span><br><span class="line">    set $path &apos;tyloafer&apos;;</span><br><span class="line">    return 200 $path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>GET <a href="http://test.tyloafer.cn/self-variable" target="_blank" rel="noopener">http://test.tyloafer.cn/self-variable</a></p></blockquote><p>è¿”å›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tyloafer</span><br></pre></td></tr></table></figure><p>æ³¨ï¼šnginxçš„å˜é‡èµ‹å€¼è·Ÿ <em>shell</em> æ˜¯ä¸€æ ·çš„ï¼Œä¸€æ ·ä¹Ÿå¯ä»¥ä½¿ç”¨ <em>{}</em> ï¼Œä¾‹ï¼š ${path} </p><h1 id="è‡ªåŠ¨è®¾ç½®çš„å˜é‡"><a href="#è‡ªåŠ¨è®¾ç½®çš„å˜é‡" class="headerlink" title="è‡ªåŠ¨è®¾ç½®çš„å˜é‡"></a>è‡ªåŠ¨è®¾ç½®çš„å˜é‡</h1><p>æˆ‘ä»¬åœ¨ä½¿ç”¨æ­£åˆ™åŒ¹é…çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å°†åŒ¹é…ç»“æœ èµ‹å€¼ç»™ \$1 \$2 è¿™æ ·çš„ \${<em>num</em>} è¿™æ ·ç±»å‹çš„å˜é‡</p><p>nginxé…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ~ /self-variable(/)(.*)$ &#123;            </span><br><span class="line">     set $path &apos;tyloafer&apos;;                      </span><br><span class="line">     return 200 &quot;path = $path , 1 = $1 , 2 = $2&quot;;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote><p>GET <a href="http://test.tyloafer.cn/self-variable/haha" target="_blank" rel="noopener">http://test.tyloafer.cn/self-variable/haha</a></p></blockquote><p>è¿”å›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path = tyloafer , 1 = / , 2 = haha</span><br></pre></td></tr></table></figure><p>ä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~ /self-variable(/)(.*)$ &#123;            </span><br><span class="line">    set $path &apos;tyloafer&apos;;</span><br><span class="line">    if ($request_uri ~ &apos;haha&apos;) &#123;</span><br><span class="line">        return 200 $1;</span><br><span class="line">    &#125; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ åœ¨è¿›è¡Œç¬¬ä¸€æ¬¡locationæ­£åˆ™åŒ¹é…æ˜¯äº§ç”Ÿçš„\$1ï¼Œ åœ¨è¿›è¡Œç¬¬äºŒæ¬¡ <code>$request_uri ~ &#39;haha&#39;</code> æ­£åˆ™åŒ¹é…çš„æ—¶å€™ä¼šè¢«è¦†ç›–ï¼Œæ‰€ä»¥è¿™æ—¶å€™ï¼Œè¿”å›çš„æ˜¯ç©ºç™½çš„ï¼Œå¹¶ä¸æ˜¯ä¸Šé¢çš„ <code>/</code></p>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®°ä¸€æ¬¡è¢«é»‘çš„ç»å†</title>
      <link href="/posts/52665/"/>
      <url>/posts/52665/</url>
      
        <content type="html"><![CDATA[<p>æŸå¤©çš„æŸæ—¶æŸåˆ»ï¼Œæˆ‘æ”¶åˆ°äº†æœåŠ¡å•†çš„é‚®ä»¶ï¼Œå‘ŠçŸ¥æˆ‘å‡ºç½‘æµé‡è¿‡å¤§ï¼Œæˆ‘æ¬¡å¥¥ï¼Œæˆ‘çš„åšå®¢ç«™ï¼ˆå¦ä¸€ä¸ªï¼Œégithubï¼‰å·²ç»å¥½ä¹…æ²¡æœ‰ç»´æŠ¤äº†ï¼Œæ›´ä½•å†µä¸Šé¢ä¹Ÿå°±å‡ ç¯‡åˆšå…¥é—¨çš„æ—¶å€™å†™çš„å‡ ç¯‡å°æ‰“å°é—¹çš„æ–‡ç« ï¼Œæ€ä¹ˆä¼šé‚£ä¹ˆç«çˆ†ï¼Ÿ</p><p>å½“ç„¶æ²¡æœ‰é‚£ä¹ˆç«çˆ†äº†ï¼Œç™»ä¸Šå»åå‘ç°æœ‰ä¸ªç¨‹åºèµ„æºåŸºæœ¬å ç”¨100%ï¼Œå¥½å—ï¼Œæ¯«æ— å‹åŠ›çš„è¢«é»‘äº†ã€‚ã€‚ã€‚</p><a id="more"></a><h1 id="å¤„ç†"><a href="#å¤„ç†" class="headerlink" title="å¤„ç†"></a>å¤„ç†</h1><p>å¹¸å¥½è¿™ä¸ªç¨‹åºå¹¶ä¸æ˜¯ä»€ä¹ˆå¤æ‚çš„ç¨‹åºï¼Œä¹Ÿä»…ä»…å°±æ˜¯ä¸€ä¸ªè„šæœ¬ï¼ŒæŠŠæˆ‘çš„æœåŠ¡å™¨å½“æˆäº†è‚‰é¸¡ï¼Œæ”»å‡»åˆ«äººçš„æœåŠ¡å™¨ï¼ŒæŠŠè¿™ä¸ªè„šæœ¬killå¹¶åˆ é™¤åï¼ŒæœåŠ¡å™¨çš„loadå’Œcpuä¹Ÿå°±ä¸‹æ¥äº†ï¼Œå¹¸å¥½ä¸æ˜¯ä»€ä¹ˆç‰›é€¼æˆ–æ¶æ„ç‚¹çš„ç—…æ¯’</p><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p>é€šè¿‡<code>last</code> å’Œ <code>lastb</code> è¿™ä¸¤ä¸ªå‘½ä»¤ï¼Œå‘ç°è¿‘æœŸæœ‰å¾ˆå¤šå°è¯•ç™»é™†ï¼Œé‚£ä¹ˆæ”»å‡»æ‰‹æ®µä¹Ÿå°±æ˜äº†äº†ï¼Œè‚‰é¸¡çš„æš´åŠ›ç ´è§£</p><h1 id="å¤„ç†-1"><a href="#å¤„ç†-1" class="headerlink" title="å¤„ç†"></a>å¤„ç†</h1><h1 id="ä¿®æ”¹å¯†ç å¹¶ä»…å…è®¸é€šè¿‡ç§é’¥ç™»é™†"><a href="#ä¿®æ”¹å¯†ç å¹¶ä»…å…è®¸é€šè¿‡ç§é’¥ç™»é™†" class="headerlink" title="ä¿®æ”¹å¯†ç å¹¶ä»…å…è®¸é€šè¿‡ç§é’¥ç™»é™†"></a>ä¿®æ”¹å¯†ç å¹¶ä»…å…è®¸é€šè¿‡ç§é’¥ç™»é™†</h1><p>å…¶å®ï¼ŒLinuxæœåŠ¡å™¨çš„å¯†ç ç™»å½•å¹¶ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥æŠŠç”¨æˆ·åå¯†ç ç™»å½•ç»™å…³äº†ï¼Œç„¶åé€šè¿‡ç§é’¥ç™»é™†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢æœ‰ä¸¤ä¸ªé…ç½®ï¼Œåˆ†åˆ«æŒ‰ç…§å¦‚ä¸‹è®¾ç½®å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RSAAuthentication yes      # RSA éªŒè¯</span><br><span class="line">PubkeyAuthentication yes   # å…¬é’¥éªŒè¯</span><br><span class="line">PasswordAuthentication no  # ä¸å…è®¸å¯†ç ç™»å½•</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦å°†è‡ªå·±çš„å…¬é’¥æ·»åŠ åˆ° å…¬é’¥éªŒè¯åˆ—è¡¨æ–‡ä»¶é‡Œé¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ IPé»‘åå•"><a href="#æ·»åŠ IPé»‘åå•" class="headerlink" title="æ·»åŠ IPé»‘åå•"></a>æ·»åŠ IPé»‘åå•</h2><p>ä¸Šè¿°çš„æ”»å‡»ä¸»è¦å°±æ˜¯æ‰¾å¾ˆå¤šè‚‰é¸¡æ¥å®é¸¡ç ´è§£å¯†ç ï¼Œè€Œè¿™äº›IPå¤§éƒ¨åˆ†éƒ½æ˜¯é»‘åå•é‡Œé¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ—¶åˆ»æ›´æ–°æœ€æ–°çš„IPé»‘åå•ï¼Œé‚£ä¹ˆå°±å¯ä»¥å†åŠ ä¸Šä¸€å±‚é˜²å¾¡</p><p>Linuxä¸Šé»‘åå•å¯ä»¥ç›´æ¥æ·»åŠ åˆ° <code>/etc/hosts.deny</code> é‡Œé¢ï¼Œè¿™æ ·å°±å¯ä»¥æ‹¦æˆªäº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¯èƒ½æ¯å¤©å»æ›´æ–°å•Šï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªè„šæœ¬ï¼Œæ”¾åœ¨crontabé‡Œé¢æ‰§è¡Œä¸€ä¸‹ï¼Œè¿™æ ·å°±å¯ä»¥ç»§ç»­æ‡’ä¸‹å»äº†ï¼Œè¿™é‡Œåˆ†äº«ä¸€ä¸ªä¸œåŒ—å¤§å­¦ç½‘ç»œä¸­å¿ƒçš„è„šæœ¬<code>fetch_neusshbl.sh</code></p><p>ç›´æ¥é™„ä¸Šä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># Fetch NEU SSH Black list to /etc/hosts.deny</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/<span class="built_in">local</span>/bin:/usr/<span class="built_in">local</span>/sbin</span><br><span class="line"></span><br><span class="line">URL=http://antivirus.neu.edu.cn/ssh/lists/neu_sshbl_hosts.deny.gz</span><br><span class="line">HOSTSDENY=/etc/hosts.deny</span><br><span class="line">TMP_DIR=/dev/shm</span><br><span class="line">FILE=hosts.deny</span><br><span class="line"></span><br><span class="line">[ -d <span class="variable">$TMP_DIR</span> ] || TMP_DIR=/tmp</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$TMP_DIR</span></span><br><span class="line"></span><br><span class="line">curl --connect-timeout 60 <span class="variable">$URL</span> 2&gt; /dev/null | gzip -dc &gt; <span class="variable">$FILE</span> 2&gt; /dev/null</span><br><span class="line"></span><br><span class="line">LINES=`grep <span class="string">"^sshd:"</span> <span class="variable">$FILE</span> | wc -l`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$LINES</span> -gt 10 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    sed -i <span class="string">'/^####SSH BlackList START####/,/^####SSH BlackList END####/d'</span> <span class="variable">$HOSTSDENY</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"####SSH BlackList START####"</span> &gt;&gt; <span class="variable">$HOSTSDENY</span></span><br><span class="line">    cat <span class="variable">$FILE</span> &gt;&gt; <span class="variable">$HOSTSDENY</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"####SSH BlackList END####"</span> &gt;&gt; <span class="variable">$HOSTSDENY</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°†è¿™ä¸ªè„šæœ¬æ”¾åœ¨<code>/etc/cron.daily/</code> ç›®å½•ä¸‹é¢ï¼Œæ¯å¤©æ‰§è¡Œå³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp fetch_neusshbl.sh /etc/cron.daily/</span><br><span class="line">chmod +x fetch_neusshbl.sh</span><br></pre></td></tr></table></figure><h2 id="ç™»å½•é‚®ä»¶é€šçŸ¥"><a href="#ç™»å½•é‚®ä»¶é€šçŸ¥" class="headerlink" title="ç™»å½•é‚®ä»¶é€šçŸ¥"></a>ç™»å½•é‚®ä»¶é€šçŸ¥</h2><p>ä¸Šé¢çš„ä¸¤ä¸ªæ­¥éª¤å®Œæˆåï¼Œé¢å¯¹è¿™ç§æš´åŠ›æ”»å‡»ï¼Œä¹Ÿå°±å®‰å…¨å¾ˆå¤šäº†ï¼Œä½†æ˜¯è¿”å›å¿§åˆ™ç”Ÿï¼Œæ‰€ä»¥æˆ‘åˆåŠ äº†æœ€åä¸€é“é˜²çº¿ï¼Œå¦‚æœæœ‰äººç™»å½•äº†æˆ‘çš„æœåŠ¡å™¨ï¼Œå°±è‡ªåŠ¨ç»™æˆ‘çš„é‚®ç®±å‘é€ä¸€æ¡é‚®ä»¶</p><p>é‚®ä»¶å‘é€çš„æœåŠ¡å™¨é…ç½®å¯å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://tyloafer.github.io/posts/47206/">ã€ŠLinuxä¸‹ä½¿ç”¨mailå‘é€é‚®ä»¶ã€‹</a></p><p><em>æœ¬æ–‡è¿˜æ˜¯ç€é‡ä»é˜²å¾¡æ–¹é¢åšäº†ä¸€ç‚¹å¤„ç†ï¼Œå¯èƒ½ç›¸å¯¹æ¥è¯´ï¼Œæ–¹æ³•éƒ½æ¯”è¾ƒçš„lowï¼Œè¿˜è¯·è°…è§£ï¼Œå­¦æµ·æ— æ¶¯ï¼Œç»§ç»­è‹¦ä½œèˆŸå§ï¼</em></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mail </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rediså“¨å…µ</title>
      <link href="/posts/51207/"/>
      <url>/posts/51207/</url>
      
        <content type="html"><![CDATA[<p>Sentinelï¼ˆå“¨å…µï¼‰æ˜¯Redis çš„é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆï¼šç”±ä¸€ä¸ªæˆ–å¤šä¸ªSentinel å®ä¾‹ ç»„æˆçš„Sentinel ç³»ç»Ÿå¯ä»¥ç›‘è§†ä»»æ„å¤šä¸ªä¸»æœåŠ¡å™¨ï¼Œä»¥åŠè¿™äº›ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå¹¶åœ¨è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨è¿›å…¥ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œè‡ªåŠ¨å°†ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æŸä¸ªä»æœåŠ¡å™¨å‡çº§ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ã€‚</p><a id="more"></a><p>åœ¨ä»‹ç»å“¨å…µä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸€äº›ä¸­å°å‹çš„Redisçš„ä¸€ä¸ªç®€å•çš„ä¸»ä»æ¶æ„</p><p><img src="http://github-1253518569.cossh.myqcloud.com/redis-master-slave.png" alt="http://github-1253518569.cossh.myqcloud.com/redis-master-slave.png"></p><p>æˆ‘ä»¬çš„ç¨‹åºï¼Œåœ¨è¿›ç¨‹å†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šç›´è¿Masterï¼Œä½†æ˜¯ï¼Œå¦‚æœè¿™æ—¶å€™Masterå®•äº†ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®å†™å…¥ä¸è¿›å»ï¼Œè€Œç­‰æˆ‘ä»¬ååº”è¿‡æ¥å¹¶å¤„ç†å¥½ï¼Œè¯´ä¸å®šåå‡ åˆ†é’Ÿç”šè‡³æ›´é•¿æ—¶é—´å°±è¿‡å»äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¼•å…¥å“¨å…µï¼Œé‡‡ç”¨ä¸‹é¢çš„æ¶æ„</p><p><img src="http://github-1253518569.cossh.myqcloud.com/redis-sentinal2.png" alt="http://github-1253518569.cossh.myqcloud.com/redis-sentinal2.png"></p><p>æˆ‘ä»¬è®¾ç½®å¤šå°å“¨å…µï¼Œæˆ‘ä»¬çš„ç¨‹åºå»è¿æ¥å“¨å…µï¼ŒåŠ å…¥Masterå®•æ‰äº†ï¼Œå“¨å…µä»¬å»å¸®æˆ‘ä»¬é€‰ä¸€å°Slaveå½“æ–°çš„Masterï¼Œè¿™æ ·ä¹Ÿå°±èƒ½å®ç°å¿«é€Ÿçš„æ•…éšœè½¬ç§»åŠå¤„ç†äº†ï¼Œæ¯•ç«Ÿçº¿ä¸Šæ˜¯è€½è¯¯ä¸èµ·æ¯åˆ†æ¯ç§’çš„ã€‚</p><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Redis-Sentinelæ˜¯ç”¨äºç®¡ç†Redisé›†ç¾¤,è¯¥ç³»ç»Ÿæ‰§è¡Œä»¥ä¸‹ä¸‰ä¸ªä»»åŠ¡:</p><ol><li>ç›‘æ§(Monitoring):Sentinelä¼šä¸æ–­åœ°æ£€æŸ¥ä½ çš„ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨æ˜¯å¦è¿ä½œæ­£å¸¸</li><li>æé†’(Notification):å½“è¢«ç›‘æ§çš„æŸä¸ªRedisæœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶,Sentinelå¯ä»¥é€šè¿‡APIå‘ç®¡ç†å‘˜æˆ–è€…å…¶ä»–åº”ç”¨ç¨‹åºå‘é€é€šçŸ¥</li><li>è‡ªåŠ¨æ•…éšœè¿ç§»(Automatic failover):å½“ä¸€ä¸ªä¸»æœåŠ¡å™¨ä¸èƒ½æ­£å¸¸å·¥ä½œæ—¶,Sentinel ä¼šå¼€å§‹ä¸€æ¬¡è‡ªåŠ¨æ•…éšœè¿ç§»æ“ä½œ,å®ƒä¼šå°†å¤±æ•ˆä¸»</li></ol><p>æœåŠ¡å™¨çš„å…¶ä¸­ä¸€ä¸ªä»æœåŠ¡å™¨å‡çº§ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨,å¹¶è®©å¤±æ•ˆä¸»æœåŠ¡å™¨çš„å…¶ä»–ä»æœåŠ¡å™¨æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨;å½“å®¢æˆ·ç«¯è¯•å›¾è¿æ¥å¤±æ•ˆçš„ä¸»æœåŠ¡å™¨æ—¶,é›†ç¾¤ä¹Ÿä¼šå‘å®¢æˆ·ç«¯è¿”å›æ–°ä¸»æœåŠ¡å™¨çš„åœ°å€,ä½¿å¾—é›†ç¾¤å¯ä»¥ä½¿ç”¨æ–°ä¸»æœåŠ¡å™¨ä»£æ›¿å¤±æ•ˆæœåŠ¡å™¨</p><h1 id="æ­å»º"><a href="#æ­å»º" class="headerlink" title="æ­å»º"></a>æ­å»º</h1><p>Redis2.8å’Œ3.0å·²ç»é™„å¸¦äº†ç¨³å®šç‰ˆæœ¬çš„å“¨å…µï¼Œé€šè¿‡yumå®‰è£…åï¼Œåœ¨<code>redis-server</code>çš„åŒä¸€ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ª<code>redis-sentinel</code>çš„å¯æ‰§è¡Œè„šæœ¬ï¼Œè¿™ä¸ªå°±æ˜¯Redisçš„å“¨å…µäº†ï¼Œåé¢ç”¨<code>sentinel</code>æ¥ä»£æ›¿å“¨å…µè¿™ä¸ªåè¯ï¼Œå› ä¸ºè¿™æ˜¯äººå®¶çš„æ­£å¼çš„åå­—ã€‚</p><h1 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h1><p>åœ¨<code>/etc/</code>ç›®å½•ä¸‹ï¼Œä¹Ÿå°±æ˜¯redis.confçš„åŒçº§ç›®å½•ä¸‹ï¼Œä¼šæœ‰ä¸€ä¸ª<code>redis-sentinel.conf</code> , è¿™ä¸ªå°±æ˜¯ sentinel çš„é…ç½®æ–‡ä»¶</p><p>æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹ä»–çš„ä¸»è¦å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat sentinel-26379.conf | grep -v &quot;#&quot; | grep -v &quot;^$&quot;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼ˆ# ä¸ºæˆ‘çš„æ³¨é‡Šï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># å“¨å…µç›‘å¬çš„ç«¯å£</span><br><span class="line">port 26379</span><br><span class="line"># å·¥ä½œç›®å½•</span><br><span class="line">dir /tmp</span><br><span class="line"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span><br><span class="line"># åé¢çš„å‚æ•°åˆ†åˆ«æ˜¯masterçš„åå­—ï¼Œè¿™ä¸ªåœ¨redisçš„confæ–‡ä»¶é‡Œé¢æœ‰è®¾ç½®çš„</span><br><span class="line"># redisçš„ip</span><br><span class="line"># redisç›‘å¬çš„ç«¯å£</span><br><span class="line"># quorum æ˜¯æŒ‡ï¼Œæœ‰å‡ ä¸ªå“¨å…µè®¤ä¸ºmaster downäº†ï¼Œæ‰ä¼šè®¤ä¸ºè¿™ä¸ªmasterçœŸæ­£çš„downäº†ï¼Œä»è€Œæ‰§è¡Œåé¢çš„ç¾å¤‡æ–¹æ¡ˆï¼Œä¸€# èˆ¬è¿™é‡Œè®¾ç½®çš„æ˜¯æ€»å…± sentinel-num/2 + 1</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"># è¿™ä¸ªæ˜¯æŒ‡ sentinel å¤šå°‘æ¯«ç§’è¿æ¥ä¸ä¸Š masterï¼Œå°±ä¼šè®¤ä¸ºå®ƒ downäº†</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"></span><br><span class="line"># è¡¨ç¤ºå¦‚æœmasteré‡æ–°é€‰å‡ºæ¥åï¼Œå…¶å®ƒslaveèŠ‚ç‚¹èƒ½åŒæ—¶å¹¶è¡Œä»æ–°masteråŒæ­¥ç¼“å­˜çš„å°æ•°æœ‰å¤šå°‘ä¸ªï¼Œæ˜¾ç„¶è¯¥å€¼è¶Šå¤§ï¼Œæ‰€æœ‰slaveèŠ‚ç‚¹å®ŒæˆåŒæ­¥åˆ‡æ¢çš„æ•´ä½“é€Ÿåº¦è¶Šå¿«ï¼Œä½†å¦‚æœæ­¤æ—¶æ­£å¥½æœ‰äººåœ¨è®¿é—®è¿™äº›slaveï¼Œå¯èƒ½é€ æˆè¯»å–å¤±è´¥ï¼Œå½±å“é¢ä¼šæ›´å¹¿ã€‚æœ€ä¿å®šçš„è®¾ç½®ä¸º1ï¼ŒåªåŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰ä¸€å°å¹²è¿™ä»¶äº‹ï¼Œè¿™æ ·å…¶å®ƒslaveè¿˜èƒ½ç»§ç»­æœåŠ¡ï¼Œä½†æ˜¯æ‰€æœ‰slaveå…¨éƒ¨å®Œæˆç¼“å­˜æ›´æ–°åŒæ­¥çš„è¿›ç¨‹å°†å˜æ…¢</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line"># è¡¨ç¤ºå¤šé•¿æ—¶é—´å, masterä»æ²¡æ´»è¿‡æ¥ï¼Œåˆ™å¯åŠ¨failoverï¼Œä»å‰©ä¸‹çš„slaveä¸­é€‰ä¸€ä¸ªå‡çº§ä¸ºmaster</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"># sentinelçš„æ—¥å¿—</span><br><span class="line">logfile /var/log/redis/sentinel.log</span><br></pre></td></tr></table></figure><p>æ³¨ï¼š</p><p>æˆ‘ä»¬ä¸€èˆ¬ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å¼€å¯å“¨å…µï¼Œä½†æ˜¯é…ç½®æ–‡ä»¶é‡Œé¢æ²¡æœ‰å†™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶çš„å¼€å§‹åŠ ä¸Š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br></pre></td></tr></table></figure><h1 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h1><h2 id="ä¸»ä»é…ç½®"><a href="#ä¸»ä»é…ç½®" class="headerlink" title="ä¸»ä»é…ç½®"></a>ä¸»ä»é…ç½®</h2><p>äº†è§£äº†ä¸Šé¢çš„é…ç½®åï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ’˜ä¸€ä¸ªä¸»ä»æœåŠ¡å™¨</p><blockquote><p>æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>å¼€å¯ä¸‰å°æœåŠ¡å™¨ï¼Œåˆ†åˆ«ç›‘å¬ 6379 6380 6381 ç«¯å£</li><li>å°†6379 è®¾ç½®ä¸ºmasterï¼Œ 6380å’Œ6381 åˆ†åˆ«slaveof 6379</li></ol></blockquote><p>6379.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile &quot;/var/run/redis_6379-6379.pid&quot;</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/var/log/redis/redis-6379.log&quot;</span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename &quot;dump-6379.rdb&quot;</span><br><span class="line">dir &quot;/var/lib/redis&quot;</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">slave-priority 100</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly-6379.aof&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events &quot;&quot;</span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure><p>6380çš„é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6381</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile &quot;/var/run/redis_6381-6381.pid&quot;</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/var/log/redis/redis-6381.log&quot;</span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename &quot;dump-6381.rdb&quot;</span><br><span class="line">dir &quot;/var/lib/redis&quot;</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">slave-priority 100</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly-6381.aof&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events &quot;&quot;</span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure><p>6381çš„é…ç½®ä¸6380åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯ä¿®æ”¹ä¸€ä¸‹ç«¯å£å’Œlogï¼Œrdbï¼Œaofçš„åå­—è€Œå·²</p><p>ç„¶åæˆ‘ä»¬å¼€å¯äº†ä¸‰å°redisï¼Œå¹¶ä¸”è®¾ç½®å¥½äº†ä¸»ä»å…³ç³»</p><blockquote><p>redis-server /path/to/6379.conf</p><p>redis-server  /path/to/6380.conf</p><p>redis-server  /path/to/6381.conf</p></blockquote><h1 id="å“¨å…µé…ç½®"><a href="#å“¨å…µé…ç½®" class="headerlink" title="å“¨å…µé…ç½®"></a>å“¨å…µé…ç½®</h1><blockquote><p>æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>æˆ‘ä»¬ä¸€æ ·å¼€å¯ä¸‰å° sentinel åˆ†åˆ«ç›‘å¬ 26379 26380 26381</li><li>å°†è¿™ä¸‰å° sentinel å…¨éƒ¨ç›‘æ§æˆ‘ä»¬çš„master 6379ç«¯å£çš„Redis</li></ol></blockquote><p>26379.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">dir /tmp</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">logfile /var/log/redis/sentinel-26379.log</span><br></pre></td></tr></table></figure><p>å…¶ä½™ä¸¤ä¸ªé…ç½®ï¼Œé™¤ç«¯å£å’Œlogfileå¤–ï¼Œå‡ä¸€æ ·ï¼Œå¯å‚è€ƒç€å†™</p><p>ç„¶åæˆ‘ä»¬å¼€å¯è¿™ä¸‰å°å“¨å…µ</p><blockquote><p>redis-sentinel /path/to/26379.conf</p><p>redis-sentinel  /path/to/26380.conf</p><p>redis-sentinel  /path/to/26381.conf</p></blockquote><h1 id="åˆ†ææ—¥å¿—"><a href="#åˆ†ææ—¥å¿—" class="headerlink" title="åˆ†ææ—¥å¿—"></a>åˆ†ææ—¥å¿—</h1><p>æˆ‘ä»¬æŸ¥çœ‹ä»»ä¸€ä¸ªå“¨å…µçš„æ—¥å¿—ï¼Œå¯åŠ¨åå¯ä»¥å‘ç°ï¼Œæ—¥å¿—é‡Œé¢è¾“å…¥äº†ä¸€ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2739:X 23 May 09:00:15.188 # Sentinel ID is 41b05827fdb8f7f8e88e74aa7070190c3c8f84f6</span><br><span class="line">2739:X 23 May 09:00:15.188 # +monitor master mymaster 127.0.0.1 6379 quorum 2</span><br><span class="line">2739:X 23 May 09:00:22.026 * +sentinel sentinel 50c453e7f9fa3acbab3f685621dabf26c02b53e3 127.0.0.1 26380 @ mymaster 127.0.0.1 6379</span><br><span class="line">2739:X 23 May 09:00:24.191 * +sentinel sentinel 3d8d577704e9c0f6ac4cde7febab25180b7d7cc5 127.0.0.1 26381 @ mymaster 127.0.0.1 6379</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´sentinel è·Ÿæˆ‘æˆ‘ä»¬é…ç½®çš„ æ‰¾åˆ°äº†master ï¼Œå¹¶ä¸”æ‰¾åˆ°äº†å¦å¤–çš„ä¸¤å° Sentinel ï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å»çœ‹ æˆ‘ä»¬åŸå…ˆé…ç½®çš„ sentinel çš„é…ç½®æ–‡ä»¶ï¼Œåº”è¯¥ä¹Ÿå‘ç”Ÿäº†å˜åŒ–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Generated by CONFIG REWRITE</span><br><span class="line">sentinel known-slave mymaster 127.0.0.1 6379</span><br><span class="line">sentinel known-slave mymaster 127.0.0.1 6380</span><br><span class="line">sentinel known-sentinel mymaster 127.0.0.1 26381 3d8d577704e9c0f6ac4cde7febab25180b7d7cc5</span><br><span class="line">sentinel known-sentinel mymaster 127.0.0.1 26380 50c453e7f9fa3acbab3f685621dabf26c02b53e3</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ï¼ŒSentinel é›†ç¾¤ç›‘æ§å·²ç»å¼€å¯å¹¶ä¸”å¼€å§‹ç›‘æ§äº†ã€‚</p><p>é‚£ä¹ˆï¼ŒSentinel æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Œåˆæ˜¯æ€ä¹ˆæŠ•ç¥¨é€‰ä¸¾æ–°çš„masterçš„å‘¢ï¼Œå…¶å®è¿˜æ˜¯è¦ç»§ç»­ä¾èµ–ä»–é”æ‰“å°çš„æ—¥å¿—</p><p>æˆ‘ä»¬è¿™æ—¶å€™ï¼Œä¸»åŠ¨ä¸‹çº¿ä¸€å°ï¼Œç„¶åç»§ç»­åˆ†æä¸€ä¸‹ Sentinel çš„æ—¥å¿—</p><blockquote><p>redis-cli -p 6379 shutdown</p></blockquote><p>è¿™æ—¶å€™ï¼Œæ—¥å¿—åˆä¼šç»§ç»­æ‰“å°å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2739:X 23 May 09:05:02.978 # +sdown master mymaster 127.0.0.1 6379</span><br><span class="line">2739:X 23 May 09:05:03.108 # +new-epoch 1</span><br><span class="line">2739:X 23 May 09:05:03.116 # +vote-for-leader 3d8d577704e9c0f6ac4cde7febab25180b7d7cc5 1</span><br><span class="line">2739:X 23 May 09:05:04.077 # +odown master mymaster 127.0.0.1 6379 #quorum 3/2</span><br><span class="line">2739:X 23 May 09:05:04.078 # Next failover delay: I will not start a failover before Wed May 23 09:11:03 2018</span><br><span class="line">2739:X 23 May 09:05:04.208 # +config-update-from sentinel 3d8d577704e9c0f6ac4cde7febab25180b7d7cc5 127.0.0.1 26381 @ mymaster 127.0.0.1 6379</span><br><span class="line">2739:X 23 May 09:05:04.208 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6381</span><br></pre></td></tr></table></figure><p>æµç¨‹å¯å‚è€ƒï¼š</p><ol><li>Sentinel å‘ç°äº†masterå®•æ‰äº†</li><li>ç„¶åç»™å¦ä¸€å° slave æŠ•ç¥¨äº†</li><li>å¦å¤–ä¸€ä¸ªåˆå‘ç° master å®•äº†ï¼Œè¶…è¿‡æˆ‘ä»¬çš„è®¾å®šäº†</li><li>å¼€å§‹åå•†ï¼šæŸä¸ªæ—¶é—´ç‚¹ä¹‹å masterè¿˜æ²¡æœ‰èµ·ï¼Œæˆ‘ä»¬å°±å¦ç«‹æ–°ä¸»å§</li><li>å“å“Ÿæ­ªï¼Œæ—¶é—´åˆ°äº†ï¼Œæˆ‘ä»¬æŠŠå…¶ä»–çš„é…ç½®æ–‡ä»¶éƒ½æ›´æ–°ä¸€ä¸‹å§ï¼Œä¸ç„¶é‡å¯äº†æˆ‘ä»¬çš„å†³è®®åˆå¤±æ•ˆäº†å’‹åŠ</li><li>æœ€åï¼Œæˆ‘ä»¬æ¬¢è¿æ–°ä¸»é™ä¸´</li></ol><p>æˆ‘ä»¬è¿™æ—¶å€™æŠŠ6379å†å¼€å¯ï¼Œåˆä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2739:X 23 May 09:05:04.209 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381</span><br><span class="line">2739:X 23 May 09:05:04.209 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6381</span><br></pre></td></tr></table></figure><p>å…¶å®ï¼Œåœ¨ä¸Šé¢çš„å®•æœºå¹¶å¦ç«‹masterçš„æ—¶å€™ 6379 çš„é…ç½®å·²ç»è¢« Sentinel ä¿®æ”¹äº†ï¼Œè¿™æ—¶å€™ï¼Œå°±åªæœ‰ä¹–ä¹–çš„å½“ slaveäº†</p>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPåŸºäºå…±äº«å†…å­˜å®ç°singleä¿¡å·é‡æ§åˆ¶è„šæœ¬å¯åœ</title>
      <link href="/posts/41236/"/>
      <url>/posts/41236/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨ä½¿ç”¨nginxçš„æ—¶å€™ï¼Œæœ‰<code>-s reload</code>å®ç°é…ç½®çš„é‡è½½ï¼Œåˆ«çš„åº”ç”¨ä¹Ÿæœ‰<code>kill -USR1</code> å®ç°é…ç½®çš„é‡è½½ï¼Œä½†æ˜¯åœ¨phpçš„è„šæœ¬åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±åªæœ‰ç®€å•ç²—æš´çš„<code>kill</code> æ¥æ€æ­»ï¼Œå†å¯åŠ¨ã€‚æ‰€ä»¥ï¼Œæ˜¯å¦å¯ä»¥å®ç° ç±»ä¼¼äº nginxçš„<code>-s</code>ä¸€æ ·ï¼Œç»™ä¸ä¸€ä¸ªä¿¡å·é‡ï¼Œæ¥è¿›è¡Œå¹³æ»‘é‡å¯æˆ–æ€æ­»ï¼Ÿ</p><a id="more"></a><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>æˆ‘ä»¬åœ¨å†™æ­»å¾ªç¯çš„æ—¶å€™ä¸€èˆ¬æ˜¯<code>while(true)</code>, é‚£ä¹ˆåªè¦åœ¨<code>while(true)</code>ç´§æ¥ç€ç»™ä»–ä¸€ä¸ªå˜é‡ï¼Œç„¶ååœ¨æ ¹æ®è¿™ä¸ªå˜é‡çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ç»“æŸä¸ä¹…å¯ä»¥å®ç°ç¨‹åºçš„è‡ªåŠ¨ç»“æŸäº†å—ï¼Ÿ</p><p>è¿™æ ·çš„è¯ï¼Œphpç¨‹åºå†…è‡ªå®šä¹‰å˜é‡è‚¯å®šæ˜¯ä¸è¡Œäº†ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ä¸€ä¸ªæ–‡ä»¶æˆ–redisæˆ–mysqlç­‰æ¥å®ç°ï¼Œä¾‹å¦‚ï¼Œaè„šæœ¬åœ¨æ‰§è¡Œå¼€å§‹çš„æ—¶å€™ï¼Œåœ¨redisé‡Œé¢è®¾ç½®ä¸€ä¸ªkey aï¼Œç„¶åæ¯æ¬¡whileçš„æ—¶å€™ï¼Œè¯»å–redisé‡Œé¢açš„å€¼ï¼Œå¦‚æœæ”¹å˜äº†ï¼Œä¾¿æ‰§è¡Œç›¸å…³çš„æ“ä½œ</p><p>è¿™å½“ç„¶æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œä½ å°±ä¼šå‘ç°ï¼Œcpuä¼šå ç”¨å¾ˆé«˜ï¼Œæ‰€ä»¥è¿™ä¸ªå°±è¢«killäº†</p><h1 id="å…±äº«å†…å­˜"><a href="#å…±äº«å†…å­˜" class="headerlink" title="å…±äº«å†…å­˜"></a>å…±äº«å†…å­˜</h1><p>æ—¢ç„¶phpçš„æ‰€æœ‰å˜é‡éƒ½æ˜¯æ”¾åœ¨å†…å­˜é‡Œé¢çš„ï¼Œé‚£ä¸€ä¸ªphpè„šæœ¬aåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªå˜é‡$flag, ç„¶åå…¶ä»–è„šæœ¬å¯ä»¥è®¿é—®è¿™ä¸ªå˜é‡å¹¶ä¿®æ”¹å˜é‡çš„å€¼ï¼Œè¿™æ ·çš„è¯ï¼Œèµ„æºçš„æ¶ˆè€—å°±æ˜¯å‡ ä¹ä¸º0äº†ï¼Œè¿™ä¹Ÿå°±å¼•è¿›äº†ä¸€ä¸ªæ¦‚å¿µï¼š<strong>å…±äº«å†…å­˜</strong></p><p>å…±äº«å†…å­˜çš„ä½¿ç”¨ä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨åŒä¸€å°æœºå™¨ä¸åŒçš„è¿›ç¨‹ä¸­å…±äº«ä¸€äº›æ•°æ®ï¼Œæ¯”å¦‚åœ¨å¤šä¸ª php-fpm è¿›ç¨‹ä¸­å…±äº«å½“å‰è¿›ç¨‹çš„ä½¿ç”¨æƒ…å†µã€‚è¿™ç§é€šä¿¡ä¹Ÿç§°ä¸ºè¿›ç¨‹é—´é€šä¿¡ï¼ˆInter-Process Communicationï¼‰ï¼Œç®€ç§° IPCã€‚</p><p>PHP å†…ç½®çš„ <a href="http://php.net/manual/zh/book.shmop.php" target="_blank" rel="noopener">shmop æ‰©å±•</a> (Shared Memory Operations) æä¾›äº†ä¸€ç³»åˆ—å…±äº«å†…å­˜æ“ä½œçš„å‡½æ•°ã€‚å½“ç„¶è¿™ä¹Ÿæ˜¯åŸºäºLinuxå…±äº«å†…å­˜å®ç°çš„ï¼Œå…·ä½“çš„å°±è‡ªè¡Œgoogleå§ã€‚</p><h2 id="å‡½æ•°åˆ—è¡¨åŠç®€ä»‹"><a href="#å‡½æ•°åˆ—è¡¨åŠç®€ä»‹" class="headerlink" title="å‡½æ•°åˆ—è¡¨åŠç®€ä»‹"></a>å‡½æ•°åˆ—è¡¨åŠç®€ä»‹</h2><ol><li>int <strong>ftok</strong> ( string <code>$pathname</code> , string <code>$proj</code> )  æŠŠä¸€ä¸ªæ‰§è¡Œçš„æ–‡ä»¶æˆ–é¡¹ç›®è½¬æ¢æˆä¸€ä¸ªç³»ç»Ÿä¸Šçš„IPC keyï¼ŒåŒä¸€ä¸ªç³»ç»Ÿä¸Šï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”çš„IPC keyæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä¹Ÿå°±è®©ä¿¡å·é‡æ§åˆ¶æˆä¸ºäº†å¯èƒ½</li><li>resource <strong>shmop_open</strong> ( int <code>$key</code> , string <code>$flags</code> , int <code>$mode</code> , int <code>$size</code> ) åˆ›å»ºä¸€ä¸ªæŒ‡å®šå¤§å°çš„å†…å­˜å—</li><li>string <strong>shmop_read</strong> ( resource <code>$shmid</code> , int <code>$start</code> , int <code>$count</code> ) ä»ä¸€ä¸ªå…±äº«å†…å­˜å—ä¸­è¯»å–æ•°æ® å¦‚æœå¡«å……çš„æ•°æ®æ¯”å…±äº«å†…å­˜çš„sizeå°çš„è¯ï¼Œä¼šè‡ªåŠ¨ç»™æ•°æ®å¡«å……ç©ºç™½ç¬¦ï¼Œæ‰€ä»¥è®°å¾—å¥—trim()</li><li>int <strong>shmop_size</strong> ( resource <code>$shmid</code> ) è·å–ä¸€ä¸ªå…±äº«å†…å­˜çš„å¤§å° ï¼Œå‚æ•°æ˜¯ <strong>shmop_open</strong>è¿”å›çš„å†…å®¹</li><li>int <strong>shmop_write</strong> ( resource <code>$shmid</code> , string <code>$data</code> , int <code>$offset</code> ) å‘å…±äº«å†…å­˜ä¸­å†™å…¥æ•°æ®</li><li>bool <strong>shmop_delete</strong> ( resource <code>$shmid</code> ) åˆ é™¤ä¸€ä¸ªå…±äº«å†…å­˜å—</li><li>void <strong>shmop_close</strong> ( resource <code>$shmid</code> ) å…³é—­ä¸€ä¸ªå…±äº«å†…å­˜å—ï¼Œå¹¶ä¸åˆ é™¤</li></ol><h2 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2><ol><li><p><strong>ftok()</strong> å‡½æ•°çš„ç¬¬ä¸€ä¸ª<code>pathname</code> å¯ä»¥ä½¿ä¸€ä¸ªæ–‡ä»¶çš„å…¨è·¯å¾„ï¼Œ ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥éšæ„ç»™ï¼Œä½†å¿…é¡»æ˜¯<strong>é•¿åº¦ä¸º1</strong>çš„å­—ç¬¦</p></li><li><p>åœ¨ä½¿ç”¨<strong>shmop_open</strong>çš„æ—¶å€™ï¼Œä¼šæ³¨æ„åˆ° ç¬¬ä¸€ä¸ªå‚æ•° int <code>$key</code> æœ‰å¯èƒ½ä¼šä¸€è„¸è¿·èŒ«ï¼Œè¿™é‡Œå…¶å®æ˜¯ <strong>fotk()</strong>å‡½æ•°çš„è¿”å›å€¼ï¼Œ æˆ‘ä»¬å‰é¢è¯´è¿‡ <strong>fotk()</strong> æ˜¯å°†æ–‡ä»¶è½¬æ¢æˆ IPC keyï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„key</p></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;a&quot; for access (sets SHM_RDONLY for shmat) use this flag when you need to open an existing shared memory segment for read only</span><br><span class="line">&quot;c&quot; for create (sets IPC_CREATE) use this flag when you need to create a new shared memory segment or if a segment with the same key exists, try to open it for read and write</span><br><span class="line">&quot;w&quot; for read &amp; write access use this flag when you need to read and write to a shared memory segment, use this flag in most cases.</span><br><span class="line">&quot;n&quot; create a new memory segment (sets IPC_CREATE|IPC_EXCL) use this flag when you want to create a new shared memory segment but if one already exists with the same flag, fail. This is useful for security purposes, using this you can prevent race condition exploits.</span><br></pre></td></tr></table></figure><p>æˆ‘åœ¨è¿™é‡Œä½¿ç”¨â€nâ€çš„æ—¶å€™ï¼Œä¼šæŠ¥é”™ï¼Œä½¿ç”¨â€œcâ€ä¾¿ä¸ä¼šï¼Œå„ä½å¯è‡ªè¡Œæµ‹è¯•</p></li></ol><h1 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h1><p>è„šæœ¬a.php </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// ç”ŸæˆIPC key</span></span><br><span class="line">$shm_key = ftok(<span class="keyword">__FILE__</span>, <span class="string">'t'</span>);</span><br><span class="line"><span class="comment">// ä¿¡å·é‡çš„è¯ 0-9ä¹Ÿè¶³å¤Ÿäº†ï¼Œæ‰€ä»¥è¿™é‡Œåˆ†é…1byteçš„å¤§å°å³å¯ï¼ŒåŒæ—¶è¿™æ ·ä¹Ÿä¸ä¼šäº§ç”Ÿç©ºç™½ç¬¦ï¼Œçœå»äº†ä½¿ç”¨trim()</span></span><br><span class="line">$shm_id = shmop_open($shm_key, <span class="string">'c'</span>, <span class="number">0644</span>, <span class="number">1</span>);</span><br><span class="line">shmop_write($shm_id, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">while</span> (shmop_read($shm_id, <span class="number">0</span>, shmop_size($shm_id)) == <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// to do</span></span><br><span class="line">&#125;</span><br><span class="line">shmop_close($shm_id);</span><br><span class="line">shmop_delete($shm_id);</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å¯åœçš„è„šæœ¬ single.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php single.php a.php /data/</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// è·å–éœ€è¦æ§åˆ¶çš„è„šæœ¬</span></span><br><span class="line">$args = $_SERVER[<span class="string">'argv'</span>];</span><br><span class="line">array_shift($args);</span><br><span class="line">$file = $args[<span class="number">1</span>] . <span class="string">'/'</span> . $args[<span class="number">0</span>];</span><br><span class="line">$shm_key = ftok(<span class="keyword">__FILE__</span>, <span class="string">'t'</span>);</span><br><span class="line"><span class="comment">// ä¿¡å·é‡çš„è¯ 0-9ä¹Ÿè¶³å¤Ÿäº†ï¼Œæ‰€ä»¥è¿™é‡Œåˆ†é…1byteçš„å¤§å°å³å¯ï¼ŒåŒæ—¶è¿™æ ·ä¹Ÿä¸ä¼šäº§ç”Ÿç©ºç™½ç¬¦ï¼Œçœå»äº†ä½¿ç”¨trim()</span></span><br><span class="line">$shm_id = shmop_open($shm_key, <span class="string">'c'</span>, <span class="number">0644</span>, <span class="number">1</span>);</span><br><span class="line">shmop_write($shm_id, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"[åœæ­¢] "</span>;</span><br><span class="line"><span class="keyword">while</span> (@shmop_read($shm_id, <span class="number">0</span>, shmop_size($shm_id)) === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'.'</span>;</span><br><span class="line">&#125;</span><br><span class="line">shmop_close($shm_id);</span><br><span class="line">shmop_delete($shm_id);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"æˆåŠŸ"</span>;</span><br></pre></td></tr></table></figure><h1 id="è¿›é˜¶-å†…å­˜é”"><a href="#è¿›é˜¶-å†…å­˜é”" class="headerlink" title="è¿›é˜¶-å†…å­˜é”"></a>è¿›é˜¶-å†…å­˜é”</h1><h2 id="å‡½æ•°åŠåˆ—è¡¨"><a href="#å‡½æ•°åŠåˆ—è¡¨" class="headerlink" title="å‡½æ•°åŠåˆ—è¡¨"></a>å‡½æ•°åŠåˆ—è¡¨</h2><p><strong>ftok</strong> æ˜¯å¿…é¡»è¦ç”¨åˆ°çš„</p><ol><li>resource <strong>sem_get</strong> ( int <code>$key</code> [, int <code>$max_acquire</code> = 1 [, int <code>$perm</code> = 0666 [, int <code>$auto_release</code> = 1 ]]] ) åˆ›å»ºä¸€ä¸ªä¿¡å·èµ„æº</li><li>bool <strong>sem_acquire</strong> ( resource <code>$sem_identifier</code> [, bool <code>$nowait</code> = FALSE ] )  æ ¹æ®ä¿¡å·èµ„æºï¼Œè·å¾—ä¸€ä¸ªä¿¡å·ä½¿ç”¨æƒé™</li><li>bool <strong>sem_release</strong> ( resource <code>$sem_identifier</code> ) é‡Šæ”¾ä¸€ä¸ªè·å–çš„ä¿¡å·ä½¿ç”¨æƒé™</li></ol><p>ä¸Šé¢ä¸‰ä¸ªæ˜¯æˆ‘ä½¿ç”¨åˆ°çš„ï¼Œæ›´å¤šçš„å¯ä»¥å‚è€ƒPHPæ‰‹å†Œä¸Šçš„<a href="http://php.net/manual/zh/book.sem.php" target="_blank" rel="noopener">Semaphore</a>ï¼Œä¼šæœ‰æ›´å¤šç›¸å…³çš„ä»‹ç»ï¼Œä½†æ˜¯è¿™é‡Œç»“åˆä¸Šé¢çš„å…±äº«å†…å­˜çš„å‡½æ•°ï¼Œå°±å®Œå…¨å¤Ÿç”¨äº†ã€‚</p><h2 id="æ³¨æ„-1"><a href="#æ³¨æ„-1" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2><ol><li><strong>sem_get</strong> çš„keyä¹Ÿæ˜¯ <strong>ftok</strong>å‡½æ•°äº§ç”Ÿçš„ï¼Œæ‰€ä»¥å¯ä»¥ä¸å…±äº«å†…å­˜çš„å…±ç”¨ä¸€ä¸ªkeyï¼Œ ç¬¬äºŒä¸ªå‚æ•° <code>$max_acquire</code> è®¾ç½®äº†ï¼Œè¿™ä¸ªä¿¡å·èµ„æºï¼Œæœ€å¤šä¸€æ¬¡å¯ä»¥è¢«å¤šå°‘ä¸ªè¿›ç¨‹è®¿é—®ï¼Œå½“è®¾ç½®ä¸º1çš„æ—¶å€™ï¼Œä¹Ÿå°±å®ç°äº†é”çš„æœºåˆ¶</li><li><strong>sem_acquire</strong> æ˜¯è·å–ä¸€ä¸ªä¿¡å·èµ„æºçš„ä½¿ç”¨æƒï¼Œå½“è¿™ä¸ªä¿¡å·èµ„æºè¢«å ç”¨ï¼Œä¸”è¾¾åˆ°æœ€å¤§çš„è¯·æ±‚æ•°çš„æ—¶å€™ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>$nowait</code> å†³å®šäº†æ¥ä¸‹æ¥çš„è¡Œä¸ºï¼Œå¦‚æœä¸ºè®¾ç½®trueçš„è¯ï¼Œåˆ™å‡½æ•°ç›´æ¥è¿”å› falseï¼Œè€Œå¦‚æœ<code>$nowait</code>è®¾ç½®ä¸ºfalseçš„æ—¶å€™ï¼Œåˆ™ä¼šé˜»å¡è¿›ç¨‹ï¼ŒçŸ¥é“è·å–èµ„æºçš„ä½¿ç”¨æƒé™</li></ol><h1 id="è¿›é˜¶-ä¸ºè„šæœ¬åŠ ä¸Šé”"><a href="#è¿›é˜¶-ä¸ºè„šæœ¬åŠ ä¸Šé”" class="headerlink" title="è¿›é˜¶-ä¸ºè„šæœ¬åŠ ä¸Šé”"></a>è¿›é˜¶-ä¸ºè„šæœ¬åŠ ä¸Šé”</h1><p>æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šé¢çš„å‡½æ•°ï¼Œä¸ºè„šæœ¬åŠ ä¸Šé”ï¼Œå®ç°ä¸€ä¸ªè„šæœ¬çš„å•ä¸€æ‰§è¡Œï¼ˆå½“ç„¶linuxä¸‹çš„<strong>flock</strong>å’Œphpçš„<strong>flock()</strong>ä¹Ÿå¯ä»¥å®ç°ï¼‰</p><p>è„šæœ¬a.php </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// ç”ŸæˆIPC key</span></span><br><span class="line">$shm_key = ftok(<span class="keyword">__FILE__</span>, <span class="string">'t'</span>);</span><br><span class="line"><span class="comment">// ä¿¡å·é‡çš„è¯ 0-9ä¹Ÿè¶³å¤Ÿäº†ï¼Œæ‰€ä»¥è¿™é‡Œåˆ†é…1byteçš„å¤§å°å³å¯ï¼ŒåŒæ—¶è¿™æ ·ä¹Ÿä¸ä¼šäº§ç”Ÿç©ºç™½ç¬¦ï¼Œçœå»äº†ä½¿ç”¨trim()</span></span><br><span class="line">$shm_id = shmop_open($shm_key, <span class="string">'c'</span>, <span class="number">0644</span>, <span class="number">1</span>);</span><br><span class="line">shmop_write($shm_id, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">$sem_id = sem_get($shm_key);</span><br><span class="line"><span class="keyword">if</span> (!sem_acquire($sem_id, <span class="keyword">true</span>)) &#123;</span><br><span class="line">    <span class="comment">// æœ‰å¦ä¸€ä¸ªè„šæœ¬æ­£åœ¨æ‰§è¡Œï¼Œç»“æŸå½“å‰æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"another is running..."</span>;</span><br><span class="line">  <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (shmop_read($shm_id, <span class="number">0</span>, shmop_size($shm_id)) == <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// to do</span></span><br><span class="line">&#125;</span><br><span class="line">sem_release($sem_id);</span><br><span class="line">shmop_close($shm_id);</span><br><span class="line">shmop_delete($shm_id);</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å¯åœçš„è„šæœ¬ single.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php single.php a.php /data/</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// è·å–éœ€è¦æ§åˆ¶çš„è„šæœ¬</span></span><br><span class="line">$args = $_SERVER[<span class="string">'argv'</span>];</span><br><span class="line">array_shift($args);</span><br><span class="line">$file = $args[<span class="number">1</span>] . <span class="string">'/'</span> . $args[<span class="number">0</span>];</span><br><span class="line">$shm_key = ftok(<span class="keyword">__FILE__</span>, <span class="string">'t'</span>);</span><br><span class="line"><span class="comment">// ä¿¡å·é‡çš„è¯ 0-9ä¹Ÿè¶³å¤Ÿäº†ï¼Œæ‰€ä»¥è¿™é‡Œåˆ†é…1byteçš„å¤§å°å³å¯ï¼ŒåŒæ—¶è¿™æ ·ä¹Ÿä¸ä¼šäº§ç”Ÿç©ºç™½ç¬¦ï¼Œçœå»äº†ä½¿ç”¨trim()</span></span><br><span class="line">$shm_id = shmop_open($shm_key, <span class="string">'c'</span>, <span class="number">0644</span>, <span class="number">1</span>);</span><br><span class="line">shmop_write($shm_id, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"[åœæ­¢] "</span>;</span><br><span class="line">$sem_id = sem_get($shm_key);</span><br><span class="line"><span class="comment">// è„šæœ¬åœ¨æ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾ä¿¡å·èµ„æºï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥é€šè¿‡èƒ½å¦è·å¾—ä¿¡å·èµ„æºæ¥åˆ¤æ–­è„šæœ¬æ˜¯å¦ç»“æŸ</span></span><br><span class="line"><span class="keyword">if</span> (!sem_acquire($sem_id, <span class="keyword">true</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'.'</span>;</span><br><span class="line">&#125;</span><br><span class="line">sem_release($sem_id);</span><br><span class="line">shmop_close($shm_id);</span><br><span class="line">shmop_delete($shm_id);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"æˆåŠŸ"</span>;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç©ç©Swooleï¼ˆä¸€ï¼‰ï¼šSwooleæ•´åˆYii</title>
      <link href="/posts/13311/"/>
      <url>/posts/13311/</url>
      
        <content type="html"><![CDATA[<p>PHPæ˜¯ä¸ªå•çº¿ç¨‹çš„è„šæœ¬çš„è¯­è¨€ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡<em>pcntl-fork</em>å®ç°ç®€å•çš„å¤šçº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªè‚¯å®šä¸æ˜¯æœ€ä¼˜è§£ï¼Œæ‰€ä»¥ä¹Ÿå°±å¼€å§‹æ¥è§¦äº†Swooleï¼Œä½†æ˜¯å…¬å¸è¿˜æ²¡æœ‰ç›¸å…³çš„é¡¹ç›®ï¼Œæ‰€ä»¥ä¹Ÿå°±ç©ç©è€Œå·²</p><a id="more"></a><h1 id="å…¥å£æ–‡ä»¶"><a href="#å…¥å£æ–‡ä»¶" class="headerlink" title="å…¥å£æ–‡ä»¶"></a>å…¥å£æ–‡ä»¶</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * @wooleæ•´åˆyii </span><br><span class="line"> * @authors Tyloafer (tyloafer@gmail.com)</span><br><span class="line"> * @date    2018-05-09 08:22:21</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">class SwooleIndex</span><br><span class="line">&#123;</span><br><span class="line">private $swoole;</span><br><span class="line">private $config;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">    $option = [</span><br><span class="line">    &apos;enable_static_handler&apos; =&gt; true,</span><br><span class="line">    &apos;document_root&apos; =&gt; &quot;/home/lixy/basic/&quot;,</span><br><span class="line">    &apos;worker_num&apos; =&gt; 5,</span><br><span class="line">    &apos;log_level&apos; =&gt; 3,</span><br><span class="line">    ];</span><br><span class="line">    $this-&gt;swoole = new \Swoole\Http\Server(&apos;0.0.0.0&apos;, 9502);</span><br><span class="line">    $this-&gt;swoole-&gt;set($option);</span><br><span class="line">    $this-&gt;swoole-&gt;on(&apos;workerstart&apos;, [$this, &apos;workerStart&apos;]);</span><br><span class="line">    $this-&gt;swoole-&gt;on(&apos;request&apos;, [$this, &apos;request&apos;]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($name, $args)</span><br><span class="line">    &#123;</span><br><span class="line">    return call_user_func_array([$this, $name], $args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function workerStart($server, $id)</span><br><span class="line">    &#123;</span><br><span class="line">    defined(&apos;YII_DEBUG&apos;) or define(&apos;YII_DEBUG&apos;, true);</span><br><span class="line">defined(&apos;YII_ENV&apos;) or define(&apos;YII_ENV&apos;, &apos;dev&apos;);</span><br><span class="line"></span><br><span class="line">require __DIR__ . &apos;/../vendor/autoload.php&apos;;</span><br><span class="line">require __DIR__ . &apos;/../vendor/yiisoft/yii2/Yii.php&apos;;</span><br><span class="line"></span><br><span class="line">$this-&gt;config = require __DIR__ . &apos;/../config/web.php&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function request($request, $response)</span><br><span class="line">    &#123;</span><br><span class="line">    $this-&gt;initParams($request);</span><br><span class="line">    ob_start();</span><br><span class="line">    (new yii\web\Application($this-&gt;config))-&gt;run();</span><br><span class="line">    $content = ob_get_contents();</span><br><span class="line">    ob_clean();</span><br><span class="line">    $response-&gt;end($content);</span><br><span class="line">    &#125;</span><br><span class="line">    private function initParams($request)</span><br><span class="line">    &#123;</span><br><span class="line">    $mapping = [</span><br><span class="line">    &apos;header&apos; =&gt; [&apos;suffix&apos; =&gt; &apos;http&apos;, &apos;name&apos; =&gt; &apos;_SERVER&apos;, &apos;toupper&apos; =&gt; true, &apos;replace_slash&apos; =&gt; true],</span><br><span class="line">    &apos;server&apos; =&gt; [&apos;suffix&apos; =&gt; &apos;&apos;, &apos;name&apos; =&gt; &apos;_SERVER&apos;, &apos;toupper&apos; =&gt; true, &apos;replace_slash&apos; =&gt; false],</span><br><span class="line">    &apos;request&apos; =&gt; [&apos;suffix&apos; =&gt; &apos;&apos;, &apos;name&apos; =&gt; &apos;_REQUEST&apos;, &apos;toupper&apos; =&gt; true, &apos;replace_slash&apos; =&gt; false],</span><br><span class="line">    &apos;cookie&apos; =&gt; [&apos;suffix&apos; =&gt; &apos;&apos;, &apos;name&apos; =&gt; &apos;_COOKIE&apos;, &apos;toupper&apos; =&gt; false, &apos;replace_slash&apos; =&gt; false],</span><br><span class="line">    &apos;get&apos; =&gt; [&apos;suffix&apos; =&gt; &apos;&apos;, &apos;name&apos; =&gt; &apos;_GET&apos;, &apos;toupper&apos; =&gt; false, &apos;replace_slash&apos; =&gt; false],</span><br><span class="line">    &apos;post&apos; =&gt; [&apos;suffix&apos; =&gt; &apos;&apos;, &apos;name&apos; =&gt; &apos;_POST&apos;, &apos;toupper&apos; =&gt; false, &apos;replace_slash&apos; =&gt; false],</span><br><span class="line">    &apos;files&apos; =&gt; [&apos;suffix&apos; =&gt; &apos;&apos;, &apos;name&apos; =&gt; &apos;_FILES&apos;, &apos;toupper&apos; =&gt; false, &apos;replace_slash&apos; =&gt; false],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    // å…ˆèµ‹å€¼ä¸ºç©ºï¼Œé˜²æ­¢ä»¥å‰çš„è¯·æ±‚å¯¹åé¢çš„è¯·æ±‚äº§ç”Ÿå½±å“</span><br><span class="line">    foreach ($mapping as $value) &#123;</span><br><span class="line">    $_GET = [];</span><br><span class="line">    $_POST = [];</span><br><span class="line">    $_FILES = [];</span><br><span class="line">    $_COOKIE = [];</span><br><span class="line">    $_REQUEST = [];</span><br><span class="line">    // $_SERVER = [];</span><br><span class="line">    &#125;</span><br><span class="line">    // é’ˆå¯¹mappingé‡Œé¢çš„å¾ªç¯èµ‹å€¼</span><br><span class="line">    foreach ($mapping as $key =&gt; $value) &#123;</span><br><span class="line">    if (!empty($request-&gt;$key)) &#123;</span><br><span class="line">    foreach ($request-&gt;$key as $name =&gt; $val) &#123;</span><br><span class="line">    if (!empty($value[&apos;suffix&apos;])) &#123;</span><br><span class="line">    $name = $value[&apos;suffix&apos;] . &apos;_&apos; . $name;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($value[&apos;toupper&apos;] === true) &#123;</span><br><span class="line">    $name = strtoupper($name);</span><br><span class="line">    &#125;</span><br><span class="line">    if ($value[&apos;replace_slash&apos;] === true) &#123;</span><br><span class="line">    $name = str_replace(&apos;-&apos;, &apos;_&apos;, $name);</span><br><span class="line">    &#125;</span><br><span class="line">    $&#123;strtoupper($value[&apos;name&apos;])&#125;[$name] = $val;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    $&#123;strtoupper($value[&apos;name&apos;])&#125; = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $data[strtoupper($value[&apos;name&apos;])] = $&#123;strtoupper($value[&apos;name&apos;])&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> $_GET = $data[&apos;_GET&apos;];</span><br><span class="line">$_POST = $data[&apos;_POST&apos;];</span><br><span class="line">$_FILES = $data[&apos;_FILES&apos;];</span><br><span class="line">$_COOKIE = $data[&apos;_COOKIE&apos;];</span><br><span class="line">$_REQUEST = $data[&apos;_REQUEST&apos;];</span><br><span class="line">$_SERVER = array_merge($data[&apos;_SERVER&apos;], $_SERVER);</span><br><span class="line">    // return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$swoole_index = new SwooleIndex();</span><br><span class="line">$swoole_index-&gt;start();</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œæˆ‘å‡†å¤‡é€šè¿‡å¯å˜å˜é‡æ¥å¯¹è¶…å…¨å±€å˜é‡è¿›è¡Œèµ‹å€¼çš„ï¼Œä¹Ÿå°±æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data[strtoupper($value[&apos;name&apos;])] = $&#123;strtoupper($value[&apos;name&apos;])&#125;;</span><br></pre></td></tr></table></figure><p>æ”¹æˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;strtoupper($value[&apos;name&apos;])&#125; = $&#123;strtoupper($value[&apos;name&apos;])&#125;;</span><br></pre></td></tr></table></figure><p>foreaché‡Œé¢ä¹Ÿä½¿ç”¨å¯å˜å˜é‡å¯¹è¶…å…¨å±€å˜é‡èµ‹å€¼ï¼Œä¾ç„¶æ²¡æˆåŠŸï¼Œä½†æ˜¯å¯¹éè¶…å…¨å±€å˜é‡å´å¯ä»¥èµ·åˆ°æ•ˆæœï¼Œæ‰€ä»¥æš‚æ—¶æ— è§£å†³æ–¹æ¡ˆã€‚</p><h1 id="é…ç½®æ–‡ä»¶web-php"><a href="#é…ç½®æ–‡ä»¶web-php" class="headerlink" title="é…ç½®æ–‡ä»¶web.php"></a>é…ç½®æ–‡ä»¶web.php</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$config = [</span><br><span class="line">......</span><br><span class="line">    &apos;components&apos; =&gt; [</span><br><span class="line">    ......</span><br><span class="line">        // swoole task compontents</span><br><span class="line">        &apos;task&apos; =&gt; [</span><br><span class="line">            &apos;class&apos; =&gt; &apos;app\component\Task&apos;,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">    ......</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>åŸæœ‰çš„ä¾¿ä¸å†ä¹¦å†™äº†ï¼Œè¿™é‡ŒåŠ ä¸Šäº†taskçš„ç»„ä»¶ã€‚</p><h1 id="ä»»åŠ¡ç»„ä»¶Task-php"><a href="#ä»»åŠ¡ç»„ä»¶Task-php" class="headerlink" title="ä»»åŠ¡ç»„ä»¶Task.php"></a>ä»»åŠ¡ç»„ä»¶Task.php</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * @ä»»åŠ¡å¤„ç†ç»„ä»¶ </span><br><span class="line"> * @authors Tyloafer (tyloafer@gmail.com)</span><br><span class="line"> * @date    2018-05-15 08:49:25</span><br><span class="line"> */</span><br><span class="line">namespace app\component;</span><br><span class="line"></span><br><span class="line">use yii;</span><br><span class="line">use yii\base\Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Task extends Component</span><br><span class="line">&#123;</span><br><span class="line">public function uploadFile($data)</span><br><span class="line">&#123;</span><br><span class="line">try &#123;</span><br><span class="line">file_put_contents(&apos;/home/lixy/upload/1.log&apos;, json_encode($data) . &apos;file : &apos; . file_get_contents($data[&apos;pic&apos;][&apos;tmp_name&apos;]));</span><br><span class="line">move_uploaded_file($data[&apos;pic&apos;][&apos;tmp_name&apos;], &apos;/home/lixy/upload/&apos; . $data[&apos;pic&apos;][&apos;name&apos;]);</span><br><span class="line">&#125; catch (\Exception $e) &#123;</span><br><span class="line">echo $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h1><p>ä¸Šé¢å°±ç®€å•çš„å®ç°äº†swooleæ•´åˆYiiæ¡†æ¶ï¼Œå®ç°å¤šçº¿ç¨‹ï¼Œä»»åŠ¡æŠ•é€’ç­‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Swoole </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Swoole </tag>
            
            <tag> Yii </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå€’è…¾ç¬”è®°ï¼ˆå…ˆå¯¼ï¼‰ï¼š$1ç­‰å˜é‡çš„ä½¿ç”¨</title>
      <link href="/posts/59969/"/>
      <url>/posts/59969/</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« çš„å‘½åä¹Ÿæ˜¯æ¯”è¾ƒæ™¦æ¶©ï¼Œè¿™ä¹Ÿå……åˆ†æ˜¾ç¤ºäº†æˆ‘çš„è¯­æ–‡åŠŸåº•æ˜¯å¤šä¹ˆçš„è–„å¼±ã€‚ç®€å•è§£é‡Šä¸€ä¸‹å§ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨nginxé‡Œé¢çš„æ­£åˆ™åšåŒ¹é…åŠrewriteæˆ–proxy_passçš„æ—¶å€™ï¼Œä¼šç»å¸¸ä½¿ç”¨\$1,\$2è¿™æ ·çš„å˜é‡ï¼Œè¿™è¾¹æ–‡ç« å°±æ˜¯åšè¿™ä¸ªè§£é‡Šçš„ã€‚</p><p>å…¶å®æˆ‘æ˜¯å‡†å¤‡å†™ä¸€ä¸ªNginxçš„ç³»åˆ—çš„ï¼Œè€Œè¿™ä¸ªæ˜¯æˆ‘è¿‘æœŸè¸©åˆ°çš„ä¸€ä¸ªå‘ï¼Œåˆæƒ³è®°å½•ä¸‹æ¥ï¼Œæ‰€ä»¥å°±å˜æˆäº†å…ˆå¯¼ç¯‡ã€‚</p><a id="more"></a><p>#èµ·å› </p><p>å…ˆè´´ä¸€ä¸‹é…ç½®çš„ä¾‹å­å§ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/lixy/(.*(?&lt;!\.php)$) &#123;</span><br><span class="line">    if ($request_uri ~ (create-group|set-avatar|change-avatar|set-group-avatar|resumable_upload|uploadFile\.php|webUpload\.php|resumable_upload_origin)) &#123;</span><br><span class="line">        access_log /data/logs/access.log file;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_pass https://tyloafer.github.io/$1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„åœºæ™¯æ˜¯ï¼Œæˆ‘åœ¨è®°å½•<em>request_body</em>çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯æ–‡ä»¶ä¸Šä¼ çš„è¯ï¼Œå°±ä¼šæŠŠäºŒè¿›åˆ¶æµç»™è®°å½•ä¸‹æ¥ï¼Œè¿™ä¸ªæ²¡å¿…è¦éª—çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä¾¿åšäº†ä¸¤ä¸ª <em>log_format</em> , ä¸€ä¸ªè®°å½•request_body, å¦ä¸€ä¸ªä¸è®°å½• ï¼Œé»˜è®¤ä½¿ç”¨è®°å½•çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access_log /data/logs/access.log file;</span><br></pre></td></tr></table></figure><p>è¿™å¥è¯ï¼Œä¹Ÿå°±æ˜¯æŒ‡å®š<em>access.log</em> çš„ <em>log_format</em>, ç„¶åå†è®²æˆ‘çš„è¯·æ±‚ä»£ç†åˆ°å¦ä¸€å° æœåŠ¡å™¨ä¸Š</p><p>ä¾‹ï¼šxxxxx.com/lixy/2018/05/18/nginx-proxy-1 =&gt; <a href="https://tyloafer.github.io/2018/05/18/nginx-proxy-1">https://tyloafer.github.io/2018/05/18/nginx-proxy-1</a> , æˆ‘åœ¨è¯·æ±‚çš„æ—¶å€™ï¼Œ locationä¼šåŒ¹é…åˆ°lixy/åé¢çš„å­—ç¬¦ä¸²å¹¶å¤åˆ¶ç»™$1è¿™ä¸ªå˜é‡ï¼Œæˆ‘åœ¨proxy_passçš„æ—¶å€™ï¼Œä½¿ç”¨è¿™ä¸ªå˜é‡ä¹Ÿå°±æ²¡ä»€ä¹ˆé—®é¢˜äº†ï¼Œåæ¥å‘ç°ï¼Œå¦‚æœè¯·æ±‚çš„æ¥å£åœ°å€åŒ…å«ä¸Šé¢çš„   (create-group|set-avatar|change-avatar|set-group-avatar|resumable_upload|uploadFile.php|webUpload.php|resumable_upload_origin) è¿™äº›å­—ç¬¦çš„æ—¶å€™ï¼Œè¿˜ç®—æ­£å¸¸ï¼Œä½†æ˜¯æ²¡æœ‰å°±ä¼šå‡ºé—®é¢˜ã€‚</p><h1 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h1><p>æœ€ç®€å•çš„å°±æ˜¯è°ƒè¯•ï¼Œæ‰“å°å‚æ•°äº†ï¼Œè¿™é‡Œæˆ‘åœ¨nginxé‡Œé¢ç›´æ¥è¿”å›äº†$1,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/lixy/(.*(?&lt;!\.php)$) &#123;</span><br><span class="line">    if ($request_uri ~ (create-group|set-avatar|change-avatar|set-group-avatar|resumable_upload|uploadFi    le\.php|webUpload\.php|resumable_upload_origin)) &#123;</span><br><span class="line">        access_log /data/logs/access.log file;</span><br><span class="line">    &#125;</span><br><span class="line">    root /home/;   </span><br><span class="line">    add_header  Content-Type &apos;text/html; charset=utf-8&apos;;</span><br><span class="line">    return 200 $1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è¯·æ±‚xxxxx.com/lixy/2018/05/18/nginx-proxy-1 è¿”å›ç©ºç™½ï¼Œ</p><p>å½“è¯·æ±‚xxxxx.com/lixy/2018/05/18/create-group è¿”å› create-groupï¼Œ</p><p>ç”±æ­¤å¯è§ï¼Œåœ¨ç»è¿‡ifçš„æ­£åˆ™åŒ¹é…çš„æ—¶å€™ï¼ŒåŒæ ·ä¼šå¯¹$1è¿›è¡Œèµ‹å€¼ï¼Œè¿™ä¹Ÿå°±æ˜¯å‡ºé”™çš„åŸå› äº†ï¼Œå˜é‡è¢«é‡æ–°èµ‹å€¼äº†ã€‚</p><h1 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/lixy/(.*(?&lt;!\.php)$) &#123;</span><br><span class="line">    set $path $1;</span><br><span class="line">    if ($request_uri ~ (create-group|set-avatar|change-avatar|set-group-avatar|resumable_upload|uploadFi    le\.php|webUpload\.php|resumable_upload_origin)) &#123;</span><br><span class="line">        access_log /data/logs/access.log file;</span><br><span class="line">    &#125;</span><br><span class="line">    root /home/;   </span><br><span class="line">    proxy_pass https://tyloafer.github.io/$path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆç»™ location åŒ¹é…åˆ°çš„è·¯ç”±åœ°å€ï¼Œèµ‹å€¼ç»™$pathï¼Œç„¶ååé¢ä½¿ç”¨\$pathå°±å¯ä»¥ï¼Œ\$1ä½ ä»¬æŠ¢ä½ ä»¬ç©å§ï¼Œå…¶ä»–çš„\$2 \$3 \$4 ç­‰å‚æ•°ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿéœ€è¦æ³¨æ„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Yii2å€’è…¾ç³»åˆ—ï¼šé‚®ç®±åŠå¤šé‚®ç®±é…ç½®</title>
      <link href="/posts/35776/"/>
      <url>/posts/35776/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>é‚®ä»¶å‘é€ï¼Œåœ¨ä¸€ä¸ªç¨‹åºä¸­ï¼Œç«™ç€ä¸¾è¶³è½»é‡çš„åœ°ä½ï¼Œæ‰€ä»¥ï¼Œå­¦ä¼šé…ç½®ï¼ŒYii2çš„é‚®ç®±ï¼Œä¹Ÿæ˜¯å…¥é—¨çš„ä¸€é¡¹å¿…è¦æŠ€èƒ½ï¼Œä½†æ˜¯ï¼Œåœ¨ä¸šåŠ¡å‘å±•è¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½ä¸€ä¸å°å¿ƒï¼Œé‚®ç®±è¢«æŸäº›é‚®ä»¶æœåŠ¡ä¸Šæ‹‰è¿‘é»‘åå•äº†ï¼Œå¾ˆå¤šè¿™ç§æƒ…å†µå°±æ˜¯å› ä¸ºï¼Œç»™ä¸å­˜åœ¨çš„ç”¨æˆ·å‘é€é‚®ä»¶æˆ–è¢«é’“é±¼äº†ã€‚è¿™æ—¶å€™å°±éœ€è¦è®¾ç½®å¤šä¸ªé‚®ç®±ï¼Œä¸€ä¸ªç”¨äºç»™æœªéªŒè¯çš„ç”¨æˆ·å‘é€é‚®ä»¶ï¼Œä¸€ä¸ªç»™å·²éªŒè¯çš„é‚®ç®±å‘é€é‚®ä»¶ï¼Œé˜²æ­¢ä¸»è¦çš„é‚®ç®±è¢«æ‹‰è¿‘é»‘åå•ã€‚</p><a id="more"></a><h1 id="é…ç½®å•ä¸ªé‚®ç®±"><a href="#é…ç½®å•ä¸ªé‚®ç®±" class="headerlink" title="é…ç½®å•ä¸ªé‚®ç®±"></a>é…ç½®å•ä¸ªé‚®ç®±</h1><p>é‚®ç®±çš„é…ç½®åœ¨Yii2çš„æ–‡æ¡£ä¸­ï¼Œå†™çš„è¿˜æ˜¯æ¯”è¾ƒè¯¦ç»†çš„ï¼Œå¯å‚è€ƒè¿™é‡Œ<a href="http://www.yii-china.com/doc/guide/tutorial_mailing.html" target="_blank" rel="noopener">http://www.yii-china.com/doc/guide/tutorial_mailing.html</a> </p><p>å°†maileræ³¨å†Œè¿›componentsä¸­å³å¯ä½¿ç”¨ï¼Œä¸ªäººçš„é…ç½®ä¹Ÿå…ˆè´´å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&apos;mailer&apos; =&gt; [</span><br><span class="line">            &apos;class&apos; =&gt; &apos;yii\swiftmailer\Mailer&apos;,         // è¿™é‡Œæ˜¯é‚®ä»¶å‘é€éœ€è°ƒç”¨çš„ç±»</span><br><span class="line">            &apos;viewPath&apos; =&gt; &apos;@common/mail&apos;,                // è¿™ä¸ªæ˜¯é‚®ä»¶çš„æ¨¡æ¿æ–‡ä»¶ï¼Œå½“ä½ ç”¨compose()ä¼ å…¥æ¨¡æ¿æ–‡ä»¶åç§°çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥æ ¹æ®æ¨¡æ¿æ–‡ä»¶è¿›è¡Œå®ä¾‹åŒ–ï¼Œè€Œä¸éœ€è¦è‡ªå·±å†å¤šæ¬¡é‡å†™htmlæˆ–txt ç‰ˆæœ¬çš„é‚®ä»¶å†…å®¹</span><br><span class="line">            &apos;useFileTransport&apos; =&gt; false,                 // å¦‚æœå¼€å¯è¿™ä¸ªé€‰é¡¹ï¼Œä¼šæŠŠé‚®ä»¶ä¿¡æ¯ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶è€Œä¸æ˜¯å‘é€å®ƒä»¬</span><br><span class="line">            &apos;transport&apos; =&gt; [                              // è¿™ä¸ªä¾¿æ˜¯å‘é€é‚®ç®±çš„éªŒè¯ï¼Œè¿™ä¸ªä¸‹é¢ä¼šä¸»è¦åˆ†æçš„</span><br><span class="line">                &apos;class&apos; =&gt; &apos;Swift_SmtpTransport&apos;,</span><br><span class="line">                &apos;host&apos; =&gt; &apos;xxxxxx&apos;,                      // é‚®ä»¶æœåŠ¡å•†çš„host</span><br><span class="line">                &apos;username&apos; =&gt; &apos;xxxxx&apos;,</span><br><span class="line">                &apos;password&apos; =&gt; &apos;*******&apos;,</span><br><span class="line">                &apos;port&apos; =&gt; 465,                            // ç«¯å£ ä¸€èˆ¬ ç«¯å£æ˜¯ 25 ssl 465 tls 587</span><br><span class="line">                &apos;encryption&apos; =&gt; &apos;ssl&apos;,//tls or ssl</span><br><span class="line">                //&apos;timeout&apos; =&gt; 600,</span><br><span class="line">                &apos;streamOptions&apos; =&gt; [                      // èµ°ssléªŒè¯æ—¶çš„è§„åˆ™</span><br><span class="line">                    &apos;ssl&apos; =&gt; [</span><br><span class="line">                        &apos;allow_self_signed&apos; =&gt; true,</span><br><span class="line">                        &apos;verify_peer&apos; =&gt; false,</span><br><span class="line">                        &apos;verify_peer_name&apos; =&gt; false,</span><br><span class="line">                    ],</span><br><span class="line">                ]</span><br><span class="line">           ]</span><br><span class="line">        ],</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„é…ç½®ä¸­å›½ï¼Œä¼šå‘ç°ï¼Œç›¸å¯¹äºæ–‡æ¡£ä¸­ å¤šäº†ä¸€ä¸ª<code>transport</code>çš„ è®¾ç½®ï¼Œè¿™ä¸ªå°±æ˜¯é‚®ç®±çš„ä¸€äº›é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªé…ç½®è¿æ¥æˆ‘ä»¬çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œè¿›è€Œæ”¶å‘é‚®ä»¶ï¼Œé‚£ä¹ˆï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†<code>transport</code>å°±æ˜¯ä¿®æ”¹äº†æˆ‘ä»¬çš„å‘ä»¶ç®±ï¼Œæˆ‘ä»¬åœ¨ç¨‹åºä¸­éšæ—¶æ›´æ”¹<code>transport</code>ä¹Ÿå°±å¯ä»¥å®ç°æˆ‘ä»¬æœ€åˆçš„éœ€æ±‚äº†ï¼Œé‚£ä¹ˆå¦‚ä½•ä¿®æ”¹å‘¢ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹<code>Mailer</code>çš„å®ä¾‹åŒ–è¿‡ç¨‹å¯èƒ½å°±æ¸…æ™°äº†ã€‚</p><h1 id="åˆ†æMailerå®ä¾‹åŒ–"><a href="#åˆ†æMailerå®ä¾‹åŒ–" class="headerlink" title="åˆ†æMailerå®ä¾‹åŒ–"></a>åˆ†æMailerå®ä¾‹åŒ–</h1><p>ä¸‹é¢æˆªå–äº†ä¸€äº› <em>Mailer.php</em> çš„ ä¸»è¦å®ä¾‹åŒ–ç”¨åˆ°çš„å‡½æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @return array|\Swift_Mailer Swift mailer instance or array configuration.</span><br><span class="line"> */</span><br><span class="line">public function getSwiftMailer()</span><br><span class="line">&#123;</span><br><span class="line">    if (!is_object($this-&gt;_swiftMailer)) &#123;</span><br><span class="line">        $this-&gt;_swiftMailer = $this-&gt;createSwiftMailer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $this-&gt;_swiftMailer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @param array|\Swift_Transport $transport</span><br><span class="line"> * @throws InvalidConfigException on invalid argument.</span><br><span class="line"> */</span><br><span class="line">public function setTransport($transport)</span><br><span class="line">&#123;</span><br><span class="line">    if (!is_array($transport) &amp;&amp; !is_object($transport)) &#123;</span><br><span class="line">        throw new InvalidConfigException(&apos;&quot;&apos; . get_class($this) . &apos;::transport&quot; should be either object or array, &quot;&apos; . gettype($transport) . &apos;&quot; given.&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    $this-&gt;_transport = $transport;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @return array|\Swift_Transport</span><br><span class="line"> */</span><br><span class="line">public function getTransport()</span><br><span class="line">&#123;</span><br><span class="line">    if (!is_object($this-&gt;_transport)) &#123;</span><br><span class="line">        $this-&gt;_transport = $this-&gt;createTransport($this-&gt;_transport);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $this-&gt;_transport;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> * Creates Swift mailer instance.</span><br><span class="line"> * @return \Swift_Mailer mailer instance.</span><br><span class="line"> */</span><br><span class="line">protected function createSwiftMailer()</span><br><span class="line">&#123;</span><br><span class="line">    return \Swift_Mailer::newInstance($this-&gt;getTransport());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¯ä»¥ç®€å•çš„å¦‚ä¸‹æ‰€ç¤º</p><p><pre class="mermaid">graph TD<br>    st(å¼€å§‹)â€“&gt;op1(getSwiftMailer)<br>    op1â€“å·²ç»å®ä¾‹åŒ–â€“&gt;out1&gt;å®ä¾‹åŒ–æˆåŠŸ]<br>    op1â€“è¿˜æ²¡å®ä¾‹åŒ–â€“&gt;op2(createSwiftMailer)<br>    op2â€“&gt;op3(getTransport)<br>    op3â€“è¿”å›transportå¯¹è±¡â€“&gt;op2<br>    op3â€“è¿˜æœªå®ä¾‹åŒ–â€“&gt;op4(createTransport)<br>    op4â€“å¼€å§‹å®ä¾‹åŒ–â€“&gt;op5(setTransport)<br>    op5â€“è¿”å›å¯¹è±¡â€“&gt;op4<br>    op4â€“è¿”å›å¯¹è±¡â€“&gt;op3<br>    op2â€“yesâ€“&gt;en<br>    out1â€“&gt;en(ç»“æŸ)</pre><br>ä»ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬è¦æ›´æ”¹<code>transport</code>çš„è¯ï¼Œåªéœ€è¦è°ƒç”¨<code>setTransport()</code>ï¼Œå¹¶å°†æˆ‘ä»¬çš„é…ç½®ä¼ ç»™ä»–å³å¯ã€‚</p><h1 id="é…ç½®å¤šé‚®ç®±"><a href="#é…ç½®å¤šé‚®ç®±" class="headerlink" title="é…ç½®å¤šé‚®ç®±"></a>é…ç½®å¤šé‚®ç®±</h1><p>æ—¢ç„¶ï¼Œæ•´ä½“æµç¨‹å·²ç»æ¸…æ™°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨params.phpä¸­æ·»åŠ ä¸€ä¸ªæ•°ç»„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&apos;mailer&apos; =&gt; [</span><br><span class="line">    &apos;gmail&apos; =&gt; [</span><br><span class="line">        &apos;class&apos; =&gt; &apos;Swift_SmtpTransport&apos;,</span><br><span class="line">        &apos;host&apos; =&gt; &apos;smtp.gmail.com&apos;,</span><br><span class="line">        &apos;username&apos; =&gt; &apos;xxxxxx,</span><br><span class="line">        &apos;password&apos; =&gt; &apos;*****&apos;,</span><br><span class="line">        &apos;port&apos; =&gt; 587,</span><br><span class="line">        &apos;encryption&apos; =&gt; &apos;tls&apos;,//tls or ssl</span><br><span class="line">    ],</span><br><span class="line">    &apos;163&apos; =&gt; [</span><br><span class="line">        &apos;class&apos; =&gt; &apos;Swift_SmtpTransport&apos;,</span><br><span class="line">        &apos;host&apos; =&gt; &apos;smtp.163.com&apos;,</span><br><span class="line">        &apos;username&apos; =&gt; &apos;xxxxxx&apos;,</span><br><span class="line">        &apos;password&apos; =&gt; &apos;****&apos;,</span><br><span class="line">        &apos;port&apos; =&gt; 465,</span><br><span class="line">        &apos;encryption&apos; =&gt; &apos;ssl&apos;,//tls or ssl</span><br><span class="line">        //&apos;timeout&apos; =&gt; 600,</span><br><span class="line">        &apos;streamOptions&apos; =&gt; [</span><br><span class="line">            &apos;ssl&apos; =&gt; [</span><br><span class="line">                &apos;allow_self_signed&apos; =&gt; true,</span><br><span class="line">                &apos;verify_peer&apos; =&gt; false,</span><br><span class="line">                &apos;verify_peer_name&apos; =&gt; false,</span><br><span class="line">            ],</span><br><span class="line">        ]</span><br><span class="line">   ]</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>åœ¨éœ€è¦ç”¨åˆ°é‚®ç®±å‘é€ä¸”éœ€è¦æ›´æ¢å‘é€é‚®ç®±çš„åœ°æ–¹ï¼Œå…ˆç”¨<code>setTransport()</code>è®¾ç½®å‘ä»¶ç®±é…ç½®å³å¯ã€‚ä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$mailer =  Yii::$app-&gt;mailer;</span><br><span class="line">$mailer-&gt;setTransport(Yii::$app-&gt;params[&apos;mailer&apos;][&apos;gmail&apos;]);</span><br><span class="line">$mailer-&gt;compose(&apos;register&apos;, $data)</span><br><span class="line">       -&gt;setSubject(&apos;å¤šé‚®ç®±æµ‹è¯•&apos;)</span><br><span class="line">       -&gt;setFrom(&apos;xxxxxx&apos;)</span><br><span class="line">       -&gt;setTo(&apos;xxxxxx&apos;)</span><br><span class="line">       -&gt;send();</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Yii2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Yii2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elastic Stackå€’è…¾ï¼ˆ1ï¼‰- ä½¿ç”¨Logstashä»MySQLå¯¼å…¥æ•°æ®åˆ°Elastic</title>
      <link href="/posts/41170/"/>
      <url>/posts/41170/</url>
      
        <content type="html"><![CDATA[<h1 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h1><p>Elastic Stackæ˜¯æ˜¯Elasticå…¬å¸çš„ä¸€å¥—å¼€æºé¡¹ç›®ï¼Œè¿™å¥—æŠ€æœ¯æ ˆä¹Ÿè¢«å¹¿æ³›çš„ç§°ä¹‹ä¸ºELKã€‚åŒ…æ‹¬elasicsearchï¼Œlogstashï¼Œkibanaã€‚å…¶ä¸»è¦åŠŸèƒ½å°±æ˜¯å¯¹æ•°æ®è¿›è¡Œæ”¶é›†ï¼Œæ ¼å¼åŒ–ï¼Œç´¢å¼•ï¼Œåˆ†æå’Œå¯è§†åŒ–ã€‚å…·æœ‰æ­å»ºç®€å•ï¼Œé…ç½®å®¹æ˜“ç­‰ä¼˜ç‚¹ã€‚</p><p>èµ·åˆï¼Œåªæœ‰elasticsearchæ˜¯elasticå…¬å¸çš„ï¼Œä¸è¿‡åœ¨æ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´å†…ï¼Œelasticå…¬å¸å…ˆåæ”¶è´­äº†logstashå’Œkibanaï¼Œç»Ÿä¸€ä¸‰è€…çš„å‘å¸ƒç‰ˆæœ¬å·ï¼Œå®Œå–„äº†ä¸‰è€…é—´çš„é…åˆï¼Œå°†ä¸‰è€…æ‰“é€ æˆäº†æ•°æ®æ”¶é›†åˆ†æå’Œå±•ç¤ºçš„åˆ©å™¨ã€‚</p><p>ElasticStackä»2014å¹´å¼€å§‹é€æ¸è¶‹äºå®Œå–„ç¨³å®šï¼Œä¸è¿‡ç°åœ¨ï¼ˆ2016å¹´05æœˆ16æ—¥ï¼‰ä»å¤„åœ¨å¿«é€Ÿè¿­ä»£ä¸­ã€‚</p><p><strong>å¯¹äºåˆ†ææ—¥å¿—è€Œè¨€ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼›æ—¥å¿—æ”¶é›†ï¼Œæ—¥å¿—æ•´ç†å­˜å‚¨ï¼Œæ•°æ®å±•ç¤ºã€‚å¯¹åº”ElasticStackä¸­çš„ï¼šL(ogstash)ï¼Œ E(lasticsearch)ï¼ŒK(ibana)ã€‚</strong></p><a id="more"></a><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>æœ¬äººçš„æ‰€æœ‰å®‰è£…å‡åœ¨CentOs7ä¸‹è¿›è¡Œå®‰è£…çš„ï¼Œå¦‚ç³»ç»Ÿä¸åŒï¼Œè¯·åšé€‚å½“ä¿®æ”¹ã€‚</p><h1 id="å®‰è£…JAVA"><a href="#å®‰è£…JAVA" class="headerlink" title="å®‰è£…JAVA"></a>å®‰è£…JAVA</h1><p>ELKçš„è¿è¡Œéœ€è¦åŸºäºJavaï¼Œå…¶æ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œä»–ä¼šå»åœ¨ç¯å¢ƒå˜é‡å¯»æ‰¾Javaï¼Œæ‰€ä»¥è¿˜éœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡ã€‚</p><ol><li><p>å®‰è£…Java</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.7.0-openjdk</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾æ–‡ä»¶å®‰è£…ä½ç½®</p><p>å¦‚æœæˆ‘ä»¬ä¸ç†Ÿæ‚‰yumå®‰è£…åçš„æ–‡ä»¶ä½ç½®ï¼Œå¯ä»¥é€šè¿‡<code>rpm -ql</code>æ¥æ˜¾ç¤ºå®‰è£…åçš„æ–‡ä»¶æ‰€åœ¨ä½ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ql java-1.8.0-openjdk</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®ç¯å¢ƒå˜é‡</p><p>ç¼–è¾‘<code>~/.bashrc</code>æˆ–<code>/etc/bashrc</code>ï¼Œ åœ¨é‡Œé¢æ·»åŠ  <code>JAVA_HOME</code>å’Œ <code>JRE_HOME</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set java environment </span></span><br><span class="line">JAVA_HOME=/usr/lib/jvm/java<span class="number">-1.7</span><span class="number">.0</span>-openjdk<span class="number">-1.7</span><span class="number">.0</span><span class="number">.75</span>.x86_64 </span><br><span class="line">JRE_HOME=$JAVA_HOME/jre </span><br><span class="line">CLASS_PATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib </span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin </span><br><span class="line">export JAVA_HOME JRE_HOME CLASS_PATH PATH</span><br></pre></td></tr></table></figure></li></ol><h2 id="å®‰è£…Elastic"><a href="#å®‰è£…Elastic" class="headerlink" title="å®‰è£…Elastic"></a>å®‰è£…Elastic</h2><p>å®˜æ–¹æä¾›äº†ä¸¤ç§å®‰è£…æ–¹å¼ï¼Œä¸€ç§æ˜¯å‹ç¼©åŒ…çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æ¯”è¾ƒçš„ç®€å•ï¼Œè§£å‹åæ—¢å¯ä»¥ä½¿ç”¨</p><h3 id="å‹ç¼©åŒ…å®‰è£…"><a href="#å‹ç¼©åŒ…å®‰è£…" class="headerlink" title="å‹ç¼©åŒ…å®‰è£…"></a>å‹ç¼©åŒ…å®‰è£…</h3><ol><li><p>ä»å®˜ç½‘ä¸‹è½½å¥½ tar.gz æ–‡ä»¶ ï¼ˆtar.gz å’Œ zipæ–‡ä»¶ä¸€æ · çœ‹ä¸ªäººä¹ æƒ¯ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.2.4.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>è§£å‹å‹ç¼©æ–‡ä»¶å¹¶è¿›å…¥æ–‡ä»¶å¤¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf elasticsearch-6.2.4.tar.gz</span><br><span class="line">cd elasticsearch-6.2.4</span><br></pre></td></tr></table></figure></li><li><p>è¿è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„å‘½ä»¤è¿è¡Œçš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°elasticsearchæ˜¯åœ¨å‰å°è¿è¡Œçš„ï¼Œç»ˆç«¯å…³é—­ï¼Œelasticsearchä¹Ÿå°±å…³é—­äº†ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸ªå‚æ•° <code>-d</code> å®ç°ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œå³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch -d</span><br></pre></td></tr></table></figure></li><li><p>å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜</p><ol><li><p><strong>can not run elasticsearch as root</strong></p><p>æ–°å»ºä¸€ä¸ª ç”¨æˆ·ï¼Œå¹¶åˆ‡æ¢åˆ°è¿™ä¸ªç”¨æˆ·ï¼Œç„¶åå†å¯åŠ¨elastic</p></li><li><p><strong>max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]</strong></p><p>åˆ‡æ¢åˆ° root ç”¨æˆ·ä¿®æ”¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure><p>åœ¨æœ€åé¢è¿½åŠ ä¸‹é¢å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*** hard nofile 65536</span><br><span class="line">*** soft nofile 65536</span><br></pre></td></tr></table></figure></li><li><p><strong>Error occurred during initialization of VMï¼ŒCould not reserve enough space for 2097152KB object heap</strong></p><p>è¿™é‡Œä¸»è¦æ˜¯å†…å­˜ä¸è¶³ï¼Œå°†elasticçš„è¿è¡Œå†…å­˜è°ƒä½å³å¯</p><p>åˆ‡æ¢åˆ° root ç”¨æˆ·ä¿®æ”¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure><p>å°†åŸæ–‡ä»¶ä¸­çš„ä¸‹é¢å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms2g</span><br><span class="line">-Xms2g</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms1g</span><br><span class="line">-Xms1g</span><br></pre></td></tr></table></figure></li></ol></li></ol><h3 id="YUMå®‰è£…"><a href="#YUMå®‰è£…" class="headerlink" title="YUMå®‰è£…"></a>YUMå®‰è£…</h3><ol><li><p>ä¸‹è½½å¹¶å®‰è£…ç­¾åå¯†é’¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ repoæº</p><p>ç¼–è¾‘<code>elk.repo</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/elk.repo</span><br></pre></td></tr></table></figure><p>å¹¶æ·»åŠ ä¸€ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch-6.x]</span><br><span class="line">  name=Elasticsearch repository for 6.x packages</span><br><span class="line">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">enabled=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨Yumå®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install elasticsearch</span><br></pre></td></tr></table></figure></li><li><p>æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ</p><p>è¿è¡Œåï¼Œé€šè¿‡curlè®¿é—®å¯¹åº”çš„ç«¯å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://localhost:9200</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å†…å®¹è¿”å›ï¼Œæ­å–œä½ ã€‚</p><p>â€‹</p></li></ol><h2 id="å®‰è£…Logstash"><a href="#å®‰è£…Logstash" class="headerlink" title="å®‰è£…Logstash"></a>å®‰è£…Logstash</h2><h3 id="å‹ç¼©åŒ…å®‰è£…-1"><a href="#å‹ç¼©åŒ…å®‰è£…-1" class="headerlink" title="å‹ç¼©åŒ…å®‰è£…"></a>å‹ç¼©åŒ…å®‰è£…</h3><ol><li><p>ä»å®˜ç½‘ä¸‹è½½å¥½ tar.gz æ–‡ä»¶ ï¼ˆtar.gz å’Œ zipæ–‡ä»¶ä¸€æ · çœ‹ä¸ªäººä¹ æƒ¯ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-6.2.4.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>è§£å‹å‹ç¼©æ–‡ä»¶å¹¶è¿›å…¥æ–‡ä»¶å¤¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf logstash-6.2.4.tar.gz</span><br><span class="line">cd logstash-6.2.4</span><br></pre></td></tr></table></figure></li><li><p>è¿è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/logstash -f logstash.conf</span><br></pre></td></tr></table></figure></li></ol><h3 id="YUMå®‰è£…-1"><a href="#YUMå®‰è£…-1" class="headerlink" title="YUMå®‰è£…"></a>YUMå®‰è£…</h3><ol><li><p>ä¸‹è½½å¹¶å®‰è£…ç­¾åå¯†é’¥</p><p>è¿™é‡Œå…¶å®è·Ÿelasticä¸€æ ·ï¼Œå¦‚æœä¸Šé¢æ‰§è¡Œè¿‡ï¼Œå¯è·³è¿‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ repoæº</p><p>ç¼–è¾‘<code>elk.repo</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/elk.repo</span><br></pre></td></tr></table></figure><p>å¹¶æ·»åŠ ä¸€ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[logstash-6.x]</span><br><span class="line">name=Elastic repository for 6.x packages</span><br><span class="line">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">enabled=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨Yumå®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install logstash</span><br></pre></td></tr></table></figure></li></ol><h2 id="å®‰è£…Kiban"><a href="#å®‰è£…Kiban" class="headerlink" title="å®‰è£…Kiban"></a>å®‰è£…Kiban</h2><h3 id="å‹ç¼©åŒ…å®‰è£…-2"><a href="#å‹ç¼©åŒ…å®‰è£…-2" class="headerlink" title="å‹ç¼©åŒ…å®‰è£…"></a>å‹ç¼©åŒ…å®‰è£…</h3><ol><li><p>ä»å®˜ç½‘ä¸‹è½½å¥½ tar.gz æ–‡ä»¶ ï¼ˆtar.gz å’Œ zipæ–‡ä»¶ä¸€æ · çœ‹ä¸ªäººä¹ æƒ¯ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/kibana/kibana-6.2.4-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>è§£å‹å‹ç¼©æ–‡ä»¶å¹¶è¿›å…¥æ–‡ä»¶å¤¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf kibana-6.2.4-linux-x86_64.tar.gz</span><br><span class="line">cd kibana-6.2.4-linux-x86_64</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹<code>config/kibana.yml</code>é‡Œé¢çš„<em>elasticsearch.url</em> æŒ‡å‘ä½ çš„ elasticçš„åœ°å€</p></li><li><p>è¿è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kibana</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æµè§ˆå™¨æŸ¥çœ‹</p><p>æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥ä½ çš„æœåŠ¡å™¨çš„ip:5601ï¼Œ ä¾‹<a href="http://127.0.0.1:5601" target="_blank" rel="noopener">http://127.0.0.1:5601</a>, å°±å¯ä»¥çœ‹åˆ°Kibanaçš„é¡µé¢äº†ï¼Œå½“ç„¶ï¼Œæœ‰å¯èƒ½ä½ çš„æœåŠ¡å™¨æ²¡æœ‰å¼€æ”¾5601ç«¯å£ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡nginxåšä¸ªä»£ç†ï¼Œè¿›è¡Œè®¿é—®ï¼Œè¿™ä¸ªå°±æ”¾åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« è®²è§£äº†ã€‚</p></li></ol><h3 id="YUMå®‰è£…-2"><a href="#YUMå®‰è£…-2" class="headerlink" title="YUMå®‰è£…"></a>YUMå®‰è£…</h3><ol><li><p>ä¸‹è½½å¹¶å®‰è£…ç­¾åå¯†é’¥</p><p>è¿™é‡Œå…¶å®è·Ÿelasticä¸€æ ·ï¼Œå¦‚æœä¸Šé¢æ‰§è¡Œè¿‡ï¼Œå¯è·³è¿‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ repoæº</p><p>ç¼–è¾‘<code>elk.repo</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/elk.repo</span><br></pre></td></tr></table></figure><p>å¹¶æ·»åŠ ä¸€ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[kibana-6.x]</span><br><span class="line">name=Kibana repository for 6.x packages</span><br><span class="line">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">enabled=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨Yumå®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install kibana</span><br></pre></td></tr></table></figure></li></ol><h1 id="å°†æ•°æ®ä»MySQLå¯¼å…¥åˆ°elastic"><a href="#å°†æ•°æ®ä»MySQLå¯¼å…¥åˆ°elastic" class="headerlink" title="å°†æ•°æ®ä»MySQLå¯¼å…¥åˆ°elastic"></a>å°†æ•°æ®ä»MySQLå¯¼å…¥åˆ°elastic</h1><p>æˆ‘ä»¬è¿™é‡Œå®‰è£…äº†Logstashï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¯ä»¥é€šè¿‡Logstashè¿æ¥æ•°æ®åº“ï¼Œè·å–æ•°æ®åæ¨é€åˆ°elasticï¼Œç”±äºæˆ‘ä»¬æ•°æ®åº“çš„æ•°æ®æ˜¯é€’å¢çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨Logstashçš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ä»¥é€’å¢çš„æ–¹å¼å‘elasticæ·»åŠ æ•°æ®ï¼Œè¿™æ ·ä¹Ÿå‡å°‘å„ä¸ªæ–¹é¢çš„å‹åŠ›</p><p>Logstashè¿æ¥æ•°æ®åº“éœ€è¦jdbcçš„æ”¯æŒï¼Œæ‰€ä»¥ï¼Œç¬¬ä¸€æ­¥è¿˜æ˜¯å®‰è£…æ‰©å±•</p><h3 id="å®‰è£…mysql-connector-java"><a href="#å®‰è£…mysql-connector-java" class="headerlink" title="å®‰è£…mysql-connector-java"></a>å®‰è£…mysql-connector-java</h3><p>yumç›´æ¥å®‰è£…æ—¢å¯ä»¥ï¼Œå®‰è£…å®Œæˆåï¼Œé€šè¿‡<code>rmp -ql</code> æ‰¾åˆ° <strong>/usr/share/java/mysql-connector-java-5.1.17.jar</strong> çš„ä½ç½®ï¼Œè¿™é‡Œåé¢ä¼šç”¨åˆ°</p><h3 id="é…ç½®Logstashçš„é…ç½®æ–‡ä»¶"><a href="#é…ç½®Logstashçš„é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®Logstashçš„é…ç½®æ–‡ä»¶"></a>é…ç½®Logstashçš„é…ç½®æ–‡ä»¶</h3><p>åœ¨inputé‡Œé¢ï¼Œä¹¦å†™å¤šä¸ª å¯¹è±¡ï¼Œ Logstashä¼šä»ä¸Šè€Œä¸‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯è¦†ç›–ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³ä¸€æ¬¡æ·»åŠ å¤šä¸ªè¡¨çš„æ•°æ®åˆ°elasticï¼Œå¯ä»¥å¤šå†™å‡ ä¸ªjdbcçš„å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡è®¿é—®ä¸åŒçš„åº“å’Œè¡¨</p><p><a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html</a></p><p>ä¸Šé¢æ˜¯elasticå®˜æ–¹çš„ jdbc æ’ä»¶çš„ä½¿ç”¨è¯´æ˜ï¼Œä¸‹é¢æˆ‘å°±ä¸Šä¸€ä¸‹è‡ªå·±çš„é…ç½®ï¼Œå¹¶ç®€å•çš„é™„ä¸€ä¸‹è¯´æ˜</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    jdbc &#123;</span><br><span class="line">        jdbc_connection_string =&gt; &quot;jdbc:mysql://localhost:3306/test&quot;     // jdbcçš„æ•°æ®åº“è¿æ¥</span><br><span class="line">        jdbc_user =&gt; &quot;*****&quot;            // æ•°æ®åº“ç”¨æˆ·å</span><br><span class="line">        jdbc_password =&gt; &quot;****&quot;         // æ•°æ®åº“å¯†ç </span><br><span class="line"></span><br><span class="line">        jdbc_driver_library =&gt; &quot;/usr/share/java/mysql-connector-java-5.1.17.jar&quot;     // javaçš„mysqlé©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æˆ‘ä»¬å®‰è£…çš„ï¼Œåœ°å€æ›¿æ¢æˆä½ æœåŠ¡å™¨ä¸Šçš„ä½ç½®å³å¯</span><br><span class="line">        jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;     // javaçš„mysqlé©±åŠ¨ç±»</span><br><span class="line"></span><br><span class="line">        codec =&gt; plain &#123;charset =&gt; &quot;UTF-8&quot;&#125;              // ç¼–ç ï¼Œé˜²ä¹±ç </span><br><span class="line">        </span><br><span class="line">        # åˆ†é¡µ</span><br><span class="line">        jdbc_paging_enabled =&gt; true                   // å¼€å¯åˆ†é¡µæŸ¥è¯¢ï¼Œè¿™æ ·å¯ä»¥å‡è½»å‹åŠ›</span><br><span class="line">        jdbc_page_size =&gt; 300                         // æ¯æ¬¡æŸ¥è¯¢çš„æ•°é‡</span><br><span class="line">        use_column_value =&gt; true                      // æ˜¯å¦ä½¿ç”¨åˆ—çš„å€¼ï¼Œå› ä¸ºæˆ‘ä»¬å¼€å¯äº†åˆ†é¡µï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºtrue</span><br><span class="line">        tracking_column =&gt; &quot;id&quot;                        // è·Ÿè¸ªçš„åˆ—çš„åç§°  è¿™é‡Œæ˜¯åˆ†é¡µä»¥åŠå¢é‡å¯¼å…¥elasticçš„æ—¶å€™ä½¿ç”¨ï¼Œä¸ä¸Šé¢å­—æ®µç»“åˆä½¿ç”¨ï¼Œlogstashä¼šå°†è¿™ä¸ªå­—æ®µçš„å€¼ï¼Œå­˜æ”¾åœ¨æˆ‘ä»¬ä¸‹é¢è®¾ç½®çš„æ–‡ä»¶é‡Œï¼Œç„¶åæ¯æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œä¼šä»¥å­˜å‚¨çš„å€¼ä¸ºä¾æ®ï¼Œå‘ä¸‹æŸ¥è¯¢</span><br><span class="line">        last_run_metadata_path =&gt; &quot;/data/elk/logstash-6.2.4/data/.logstash_jdbc_last_run_index&quot;</span><br><span class="line">        statement =&gt; &quot;select * from test where id &gt; :sql_last_value&quot;        // æŸ¥çœ‹çš„sqlè¯­å¥ sql_last_valueæ˜¯å†…ç½®çš„å˜é‡ ï¼Œä¹Ÿæ˜¯å­˜æ”¾åœ¨ä¸Šé¢æ–‡ä»¶ä¸­çš„å€¼</span><br><span class="line">        type =&gt; &quot;test&quot;           // ç±»å‹ï¼Œè¿™é‡Œå¯ä»¥éšä¾¿è®¾ç½®ï¼Œæˆ‘è¿™é‡Œä¸è¡¨åç›¸åŒ</span><br><span class="line">    &#125;   </span><br><span class="line">    jdbc &#123;</span><br><span class="line">        jdbc_connection_string =&gt; &quot;jdbc:mysql://localhost:3306/test&quot;</span><br><span class="line">        jdbc_user =&gt; &quot;*****&quot;</span><br><span class="line">        jdbc_password =&gt; &quot;*****&quot;</span><br><span class="line"></span><br><span class="line">        jdbc_driver_library =&gt; &quot;/usr/share/java/mysql-connector-java-5.1.17.jar&quot;</span><br><span class="line">        jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line"></span><br><span class="line">        # åˆ†é¡µ</span><br><span class="line">        jdbc_paging_enabled =&gt; true</span><br><span class="line">        jdbc_page_size =&gt; 300 </span><br><span class="line">        use_column_value =&gt; true</span><br><span class="line">        tracking_column =&gt; &quot;id&quot;</span><br><span class="line">        last_run_metadata_path =&gt; &quot;/data/elk/logstash-6.2.4/data/.logstash_jdbc_last_run_test1&quot;</span><br><span class="line">        statement =&gt; &quot;select * from test1 where id &gt; :sql_last_value&quot;</span><br><span class="line">        type =&gt; &quot;test1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;                  // è¾“å‡ºåˆ°å±å¹•ç»ˆç«¯</span><br><span class="line">        codec =&gt; rubydebug    // rubydebugæ ¼å¼è¾“å‡º</span><br><span class="line">    &#125;</span><br><span class="line">    elasticsearch &#123;             // è¾“å‡ºåˆ°elastic</span><br><span class="line">        &quot;hosts&quot; =&gt; &quot;127.0.0.1:9200&quot;           // elasticçš„åœ°å€</span><br><span class="line">        &quot;index&quot; =&gt; &quot;%&#123;type&#125;&quot;      // ç±»å‹  ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è®¾ç½®çš„typeçš„å€¼ï¼Œè¿™æ ·ç›´æ¥ç”¨ï¼Œå¯ä»¥é¿å…if åˆ¤æ–­ ä½†æ˜¯ç´¢å¼•å°±ä¸èƒ½è‡ªå®šä¹‰äº† æœ‰åˆ©æœ‰å¼Š</span><br><span class="line">        # &quot;type&quot; =&gt; &quot;index&quot;</span><br><span class="line">        &quot;document_type&quot; =&gt; &quot;index&quot;   // elasticé‡Œé¢çš„type</span><br><span class="line">        &quot;document_id&quot; =&gt; &quot;%&#123;id&#125;&quot;     // elasticé‡Œé¢çš„idï¼Œè¿™é‡Œå»ºè®®ä½¿ç”¨mysqlçš„idï¼Œé¿å…mysqlæ•°æ®åœ¨elasticé‡Œé¢é‡å¤ï¼ŒåŒæ—¶æ–¹ä¾¿æŸ¥æ‰¾åŠå¢åˆ æ”¹æŸ¥</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>ä¸ªäººä¹Ÿæ˜¯åˆšåˆšæ¥è§¦ELKï¼Œå‡†å¤‡æ‰“ç®—å°†å­¦ä¹ è¿‡ç¨‹ä¸­çš„ä¸œè¥¿è®°å½•ä¸‹æ¥ï¼Œä¹Ÿç®—æ˜¯è¸©å‘æ—¥è®°äº†ï¼Œæ‰€ä»¥ï¼ŒELKçš„ç›¸å…³ä¸œè¥¿åé¢åº”è¯¥è¿˜ä¼šæœ‰å¾ˆå¤šï¼ŒFightingï¼</p>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sublimeå€’è…¾ç³»åˆ—ï¼šSublimeLinter-PHPè¯­æ³•æ£€éªŒ</title>
      <link href="/posts/48314/"/>
      <url>/posts/48314/</url>
      
        <content type="html"><![CDATA[<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>é€šè¿‡<code>package controller</code>æœç´¢å®‰è£…<code>SublimeLinter</code>å’Œ<code>SublimeLinter-php</code>å³å¯ã€‚</p><p>å¦‚æœä¸æ¸…æ¥š<code>package controller</code>çš„ä½¿ç”¨çš„è¯ï¼Œå¯å‚è€ƒ<a href="https://tyloafer.github.io/2018/04/21/sublime-sftp/">ã€ŠSublimeå€’è…¾ç³»åˆ—ï¼šé…ç½®sftpå®ç°æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€‹</a> æˆ– å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://packagecontrol.io/installation" target="_blank" rel="noopener">https://packagecontrol.io/installation</a> </p><h1 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h1><p><code>Preference</code> -&gt; <code>Package Setting</code> -&gt; <code>SublimeLinter</code> -&gt;<code>setting</code> å³å¯æ‰“å¼€ <code>SublimeLinter</code> çš„ç”¨æˆ·è‡ªå®šä¹‰ç•Œé¢ï¼Œå·¦ä¾§æ˜¯ç³»ç»Ÿé¢„è®¾çš„é…ç½®ï¼Œå¯ä»¥æ ¹æ®å·¦ä¾§çš„é¢„è®¾ åœ¨å³è¾¹çš„ç”¨æˆ·è®¾ç½®ä¸­è¿›è¡Œä¸€ä¸‹è®¾ç½®ï¼š</p><p>æˆ‘çš„è®¾ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// SublimeLinter Settings - User</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &quot;linters&quot;: &#123;</span><br><span class="line">        &quot;php&quot;: &#123;</span><br><span class="line">            &quot;executable&quot;: &quot;D:\\soft\\php72\\php.exe&quot;,     // è¿™é‡Œå¡«å†™phpæ‰§è¡Œè„šæœ¬çš„ç»å¯¹è·¯å¾„ macå’Œlinuxä½¿ç”¨ / ï¼Œwindowsä¸‹ä½¿ç”¨\\</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;paths&quot;: &#123;</span><br><span class="line">        &quot;linux&quot;: [],</span><br><span class="line">        &quot;osx&quot;: [],</span><br><span class="line">        &quot;windows&quot;: [&quot;D:\\soft\\php72\\php.exe&quot;]  // // è¿™é‡Œå¡«å†™ç¯å¢ƒå˜é‡çš„ç»å¯¹åœ°å€  ç”¨åˆ°çš„æ·»åŠ ä¸Šå»å³å¯</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½è¿›è¡Œé…ç½®ï¼Œä¾‹å¦‚ styleï¼Œæ˜¾ç¤ºçš„æ ·å¼ï¼Œ panelæ˜¾ç¤ºç­‰ï¼Œè¿™ä¸ªå°±ä¸å¤šä»‹ç»äº†ï¼Œæ³¨é‡Šå†™çš„å¾ˆæ¸…æ™°äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Sublime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Sublime </tag>
            
            <tag> SublimeLinter </tag>
            
            <tag> Package </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Yii2å€’è…¾ç³»åˆ—ï¼šè‡ªå®šä¹‰é”™è¯¯å¤„ç†</title>
      <link href="/posts/40357/"/>
      <url>/posts/40357/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>Yii2æ¡†æ¶ï¼Œåœ¨devç¯å¢ƒä¸‹æ—¶ï¼Œé”™è¯¯æç¤ºæ˜¯å¾ˆå‹å¥½çš„ï¼Œä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬çš„ä»£ç åœ¨çº¿ä¸Šæˆ–è€…åœ¨é¢„å‘å¸ƒç¯å¢ƒä¸Šï¼Œæœ‰æ—¶æˆ‘ä»¬ä¸éœ€è¦å°†é”™è¯¯æ˜¾ç¤ºçš„é‚£ä¹ˆæ˜æ˜¾ï¼Œå½“ç„¶è¿™æ—¶æˆ‘ä»¬å¯ä»¥è®¾ç½®ç¯å¢ƒä¸ºprodï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰é”™è¯¯æç¤ºäº†ï¼Œä½†æ˜¯ä¸€æ—¦å‡ºäº†é”™è¯¯ï¼Œå¯¹äºå¼€å‘äººå‘˜çš„æ’æŸ¥ä¹Ÿå°±æ¯”è¾ƒè€—æ—¶è€—åŠ›äº†ï¼Œè¿™æ—¶ï¼Œå¦‚æœç¨‹åºå‡ºé”™äº†ï¼Œä¾¿èƒ½ç»™å¼€å‘äººå‘˜å‘é€ä¸€ä¸ªé‚®ä»¶ï¼Œå‘Šè¯‰å¼€å‘äººå‘˜ç”¨æˆ·çš„è¯·æ±‚åœ°å€ï¼Œè¯·æ±‚å‚æ•°ï¼Œé”™è¯¯æ–‡ä»¶ï¼Œé”™è¯¯çš„è¡Œæ•°ï¼Œè¿™æ ·ä¹Ÿå°±å¯ä»¥è®©å¼€å‘äººå‘˜åœ¨ç¬¬ä¸€æ—¶é—´è§£å†³bugï¼Œè€Œå±•ç¤ºç»™ç”¨æˆ·çš„ä»…ä»…æ˜¯ä¸€æ¡æˆ‘ä»¬å®šä¹‰çš„é”™è¯¯æç¤ºï¼Œè¿™æ ·æ˜¯ä¸æ˜¯ä¼šæ›´å¥½å‘¢ï¼Ÿ</p><a id="more"></a><h2 id="errorHandlerç»„ä»¶è®¾ç½®"><a href="#errorHandlerç»„ä»¶è®¾ç½®" class="headerlink" title="errorHandlerç»„ä»¶è®¾ç½®"></a>errorHandlerç»„ä»¶è®¾ç½®</h2><p>Yii2ä¸ºæˆ‘ä»¬æä¾›äº†errorHandlerç»„ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦è®¾ç½®ä¸€ä¸‹å½“å‡ºç°é”™è¯¯çš„æ—¶å€™ï¼Œåº”è¯¥è·¯ç”±åˆ°çš„æ§åˆ¶å™¨å³å¯ï¼Œåœ¨main.phpæˆ–main-local.phpä¸­çš„componentsä¸­æ·»åŠ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&apos;errorHandler&apos; =&gt; [</span><br><span class="line">    &apos;errorAction&apos; =&gt; &apos;site/error&apos;,</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œå¼€å¯errorHandler è¿™ä¸ªç»„ä»¶ï¼Œéœ€è¦ï¼Œå…³é—­debugï¼ŒåŒæ—¶ç¯å¢ƒåˆ‡æ¢çš„devä¸‹ï¼Œå³åœ¨index.phpä¸­ï¼Œå°†<em>YII_DEBUG</em>å’Œ<em>YII_ENV</em> å®šä¹‰å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">defined(&apos;YII_DEBUG&apos;) or define(&apos;YII_DEBUG&apos;, false);</span><br><span class="line">defined(&apos;YII_ENV&apos;) or define(&apos;YII_ENV&apos;, &apos;dev&apos;);</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œå‡å¦‚æˆ‘ä»¬å°†é”™è¯¯å¤„ç†äº¤ç»™SiteControllerä¸‹actionError() ï¼ˆsite/errorï¼‰è¿™ä¸ªæ–¹æ³•å¤„ç†ï¼Œè¯·ä¿è¯SiteControlleræˆ–è€…SiteControllerçš„çˆ¶ç±»æ§åˆ¶å™¨é‡Œé¢æ²¡æœ‰ä¸‹é¢çš„å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public function actions()</span><br><span class="line">&#123;</span><br><span class="line">    return [</span><br><span class="line">        &apos;error&apos; =&gt; [</span><br><span class="line">            &apos;class&apos; =&gt; &apos;yii\web\ErrorAction&apos;,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ <em>actions</em> æ–¹æ³•ä¼šå°†<em>actionError()</em>è¿™ä¸ªæ–¹æ³•é‡æ–°æŒ‡å‘ <em>yii\web\ErrorAction</em> ã€‚</p><h1 id="å°†é”™è¯¯ä¿¡æ¯ç”¨é‚®ä»¶å‘ç»™å¼€å‘äººå‘˜"><a href="#å°†é”™è¯¯ä¿¡æ¯ç”¨é‚®ä»¶å‘ç»™å¼€å‘äººå‘˜" class="headerlink" title="å°†é”™è¯¯ä¿¡æ¯ç”¨é‚®ä»¶å‘ç»™å¼€å‘äººå‘˜"></a>å°†é”™è¯¯ä¿¡æ¯ç”¨é‚®ä»¶å‘ç»™å¼€å‘äººå‘˜</h1><p>Yii2æ¡†æ¶æœ¬èº«çš„é”™è¯¯æç¤ºé¡µé¢æ¯”è¾ƒå‹å¥½ï¼Œæ‰€ä»¥æˆ‘ä¾¿å°†é¡µé¢å†…å®¹æ‹¿è¿‡æ¥ï¼Œå¹¶åšäº†ä¸€ç‚¹ä¿®æ”¹ã€‚</p><ol><li><p>é¦–å…ˆæ–°å»ºä¸€ä¸ªerrorå¯¹åº”viewæ¨¡æ¿é¡µé¢ï¼ˆviews/site/error.phpï¼‰ï¼Œå°†Yii2æœ¬èº«çš„é”™è¯¯å¼‚å¸¸å¤„ç†é¡µé¢æ¨¡æ¿exception.phpæ‹·è´è¿‡æ¥å¹¶ä¿®æ”¹ï¼Œç›¸ä¿¡å„ä½ è¿™ç‚¹ç®€å•çš„æ“ä½œ è‚¯å®šä¸æ˜¯ä»€ä¹ˆé—®é¢˜çš„ã€‚</p></li><li><p>å°†actionError()ä¿®æ”¹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public function actionError()</span><br><span class="line">&#123;</span><br><span class="line">       http_response_code(200);</span><br><span class="line">       $exception = Yii::$app-&gt;errorHandler-&gt;exception;</span><br><span class="line">       $statusCode = Yii::$app-&gt;response-&gt;statusCode;</span><br><span class="line">       // è¿‡æ»¤404</span><br><span class="line">       // æ­¤æ—¶åœ¨ file_put_contentsçš„æ—¶å€™ï¼Œç”±äºjquery.map.jsä¸å­˜åœ¨è€ŒæŠ¥404çš„é”™è¯¯</span><br><span class="line">       if ($statusCode != 404) &#123;</span><br><span class="line">           $exception_key = Yii::$app-&gt;params[&apos;ExceptionMailList&apos;];</span><br><span class="line">           $request_url = $_SERVER[&apos;REQUEST_SCHEME&apos;] . &quot;://&quot; . $_SERVER[&apos;HTTP_HOST&apos;] . $_SERVER[&apos;REQUEST_URI&apos;];</span><br><span class="line">           $params = json_encode(Yii::$app-&gt;request-&gt;post());</span><br><span class="line">           $content = $this-&gt;renderPartial(&apos;exception&apos;, [&apos;exception&apos; =&gt; $exception,</span><br><span class="line">               &apos;handler&apos; =&gt; Yii::$app-&gt;errorHandler,</span><br><span class="line">               &apos;request_url&apos; =&gt; $request_url,</span><br><span class="line">               &apos;params&apos;    =&gt;  $params</span><br><span class="line">           ]);</span><br><span class="line">           foreach (Yii::$app-&gt;params[&apos;ExceptionNotifyList&apos;] as $email) &#123;</span><br><span class="line">               Email::begin()-&gt;setType(&apos;exception&apos;)</span><br><span class="line">                   -&gt;setEmail($email)</span><br><span class="line">                   -&gt;setUsername(&apos;lixiaoyu&apos;)</span><br><span class="line">                   -&gt;setValue(&apos;content&apos;, $content)</span><br><span class="line">                   -&gt;send();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return  FunctionHelper::errorJson(&quot;An internal server error occurred&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä»…ä»…æ˜¯æ¸²æŸ“å¼‚å¸¸é¡µé¢ï¼Œç„¶åè·å–æ¸²æŸ“åçš„é¡µé¢ï¼Œå¹¶ä½œä¸ºé‚®ä»¶å†…å®¹å‘é€ç»™è®¾ç½®çš„å¼€å‘äººå‘˜çš„é‚®ç®±ï¼Œè¿™æ ·ï¼Œä¾¿èƒ½åœ¨ç¬¬ä¸€æ—¶é—´æ”¶åˆ°å¼‚å¸¸ä¿¡æ¯å¹¶å¤„ç†äº†ã€‚</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Yii2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Yii2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoä¸­å¼•å…¥Mermaidæµç¨‹å›¾</title>
      <link href="/posts/7790/"/>
      <url>/posts/7790/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>æµç¨‹å›¾æ˜¯ä¸ªå¾ˆæ¸…æ™°çš„å±•ç¤ºè‡ªå·±æ€è·¯çš„å¾ˆå¥½çš„å·¥å…·ï¼Œæˆ‘åœ¨æˆ‘çš„ç”µè„‘ä¸Šç”¨Typoraå†™çš„æ—¶å€™ï¼Œè‡ªèº«å¸¦äº†mermaidæµç¨‹å›¾ï¼Œä½†æ˜¯ä¸Šä¼ åˆ°githubä¸Šå°±æ— æ³•è§£æäº†ï¼ŒGoogleè‹¥å¹²åä¾æ—§æ²¡æœ‰æ•ˆæœï¼Œä½†æ˜¯å»Hexoå®˜ç½‘é€›é€›çš„æ—¶å€™ï¼Œæ— æ„ä¸­å‘ç°Hexoå¸¦æœ‰mermaidçš„æ’ä»¶ï¼Œæ‰€ä»¥ï¼Œå¯¹äºä¸äº†è§£çš„æŠ€æœ¯ï¼Œè¿˜æ˜¯è¦å¤šçœ‹å¤šè¯»å®˜æ–¹æ–‡æ¡£ [!å“€ä¼¤è„¸] ã€‚</p><p>ä¸‹é¢çš„å†…å®¹æ‘˜è‡ªgithubå¹¶æ ¹æ®æˆ‘è‡ªå·±çš„ä¸»é¢˜ <em>NEXT</em> åšäº†ç‚¹ä¿®æ”¹ï¼Œ ä¸‹é¢çš„å†…å®¹ä¹Ÿæ˜¯ä»¥ <em>NEXT</em> ä¸»é¢˜ä¸ºä¾‹ï¼Œå„ä½ä¹Ÿå¯ä»¥ç›´æ¥çœ‹åŸç‰ˆå†…å®¹<a href="https://github.com/webappdevelp/hexo-filter-mermaid-diagrams" target="_blank" rel="noopener">https://github.com/webappdevelp/hexo-filter-mermaid-diagrams</a></p><a id="more"></a><h1 id="å®‰è£…æ’ä»¶"><a href="#å®‰è£…æ’ä»¶" class="headerlink" title="å®‰è£…æ’ä»¶"></a>å®‰è£…æ’ä»¶</h1><ol><li><p>yarn å®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add hexo-filter-mermaid-diagrams</span><br></pre></td></tr></table></figure></li><li><p>npm å®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-filter-mermaid-diagrams</span><br></pre></td></tr></table></figure></li></ol><h1 id="ç¼–è¾‘é…ç½®æ–‡ä»¶"><a href="#ç¼–è¾‘é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘é…ç½®æ–‡ä»¶"></a>ç¼–è¾‘é…ç½®æ–‡ä»¶</h1><p>é…ç½®æ–‡ä»¶<em>_config.yml</em>ï¼Œåº”è¯¥åˆ†åˆ«åœ¨æ ¹ç›®å½•ä¸‹å’Œthemes/next/ä¸‹åˆ†åˆ«æœ‰ä¸€ä¸ªï¼Œæˆ‘ä»¬è¿™é‡Œç¼–è¾‘çš„æ˜¯æ ¹ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶</p><p>åœ¨ <em>_config.yml</em>  çš„æœ€ååŠ ä¸Šä»¥ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># mermaid chart</span><br><span class="line">mermaid: ## mermaid url https://github.com/knsv/mermaid</span><br><span class="line">  enable: true  # default true</span><br><span class="line">  version: &quot;7.1.2&quot; # default v7.1.2</span><br><span class="line">  options:  # find more api options from https://github.com/knsv/mermaid/blob/master/src/mermaidAPI.js</span><br><span class="line">    #startOnload: true  // default true</span><br></pre></td></tr></table></figure><h1 id="å¼•å…¥ç›¸å…³çš„jsæ–‡ä»¶"><a href="#å¼•å…¥ç›¸å…³çš„jsæ–‡ä»¶" class="headerlink" title="å¼•å…¥ç›¸å…³çš„jsæ–‡ä»¶"></a>å¼•å…¥ç›¸å…³çš„jsæ–‡ä»¶</h1><p>æ‰¾åˆ°ä¸»é¢˜é‡Œé¢çš„é¡µè„šæ–‡ä»¶ï¼Œä¹Ÿå³  <code>themes/next/layout/_partials/footer.swig</code> ï¼Œåœ¨æ–‡ä»¶æœ€ååŠ ä¸Šä»¥ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if (theme.mermaid.enable)  %&#125;</span><br><span class="line">  &lt;script src=&apos;https://unpkg.com/mermaid@&#123;&#123; theme.mermaid.version &#125;&#125;/dist/mermaid.min.js&apos;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    if (window.mermaid) &#123;</span><br><span class="line">      mermaid.initialize(&#123;theme: &apos;forest&apos;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œé‡å¯hexo serveråº”è¯¥å°±å¯ä»¥çœ‹åˆ°æ•ˆæœäº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Next </tag>
            
            <tag> Mermaid </tag>
            
            <tag> æµç¨‹å›¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sublimeå€’è…¾ç³»åˆ—ï¼šé…ç½®sftpå®ç°æ–‡ä»¶ä¸Šä¼ ä¸‹è½½</title>
      <link href="/posts/45096/"/>
      <url>/posts/45096/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>ä½œä¸ºä¸€æšPHPç¨‹åºçŒ¿ï¼Œç”¨sublimeåšå¼€å‘æ€»æ„Ÿè§‰è‡ªå·±å¾ˆä¸å…¥æµï¼Œæ‰€ä»¥åæ¥æ¥è§¦äº†ä¸€æ®µæ—¶é—´çš„PHPStormï¼Œä¸å¾—ä¸è¯´ï¼ŒPHPStormçœŸçš„å¾ˆå¼ºå¤§ï¼Œgitã€xdebugã€sftpç­‰èƒ½æƒ³åˆ°çš„åŸºæœ¬éƒ½é›†æˆäº†ï¼Œä½†æ˜¯ï¼Œå¯¹äºPHPStormï¼Œä¸€ç›´æœ‰ä¸¤ç‚¹ä¸æ»¡æ„ï¼Œä¸€æ˜¯è‡ªåŠ¨è¡¥å…¨ï¼ŒäºŒæ˜¯ ç•Œé¢ï¼ï¼ï¼æ‰€ä»¥ï¼Œä¹Ÿå°±ä»æ­¤å¼€å¯äº†ä¸ªäººçš„Sublimeå€’è…¾ä¹‹æ—…ã€‚è€Œæˆ‘å¯¹Sublimeè€Œåˆ«é’Ÿçˆ±çš„åœ°æ–¹ä¹Ÿå°±æ˜¯ä»–çš„æ’ä»¶ï¼Œæ¯æ¬¡ç©çš„æ—¶å€™éƒ½æ„Ÿè§‰è·Ÿå‘ç°äº†æ–°å¤§é™†ä¸€æ ·ï¼Œè®©æˆ‘æ—¶åˆ»ä¿æŒç€æ–°é²œæ„Ÿã€‚</p><p>ä¸‹é¢å°±ç®€å•ä»‹ç»ä¸€ä¸‹ï¼ŒSublimeçš„æ’ä»¶-SFTPï¼Œæ ‡æ¦œPHPStormçš„SFTPã€‚</p><a id="more"></a><h1 id="å®‰è£…sftp"><a href="#å®‰è£…sftp" class="headerlink" title="å®‰è£…sftp"></a>å®‰è£…sftp</h1><h2 id="å®‰è£…package-controller"><a href="#å®‰è£…package-controller" class="headerlink" title="å®‰è£…package controller"></a>å®‰è£…package controller</h2><p>å®˜ç½‘è™½ç„¶ä»‹ç»çš„æ¯”è¾ƒè¯¦ç»†äº†ï¼Œä½†æ˜¯è¿˜æ˜¯å¤šåºŸè¯ä¸€éå§ã€‚</p><p>é¦–å…ˆæ‰“å¼€sublimeï¼Œç„¶åé€šè¿‡å¿«æ·é”® <em>ctrl+`</em> æˆ–è€…èœå•çš„ <em>View &gt; Show Consoled</em>æ‰“å¼€Sublimeçš„æ§åˆ¶å°ï¼Œç„¶åè¾“å…¥ä¸‹åˆ—ä»£ç ï¼Œç­‰å¾…æ‰§è¡Œå®Œæˆå³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import urllib.request,os,hashlib; h = &apos;6f4c264a24d933ce70df5dedcf1dcaee&apos; + &apos;ebe013ee18cced0ef93d5f746d80ef60&apos;; pf = &apos;Package Control.sublime-package&apos;; ipp = sublime.installed_packages_path(); urllib.request.install_opener( urllib.request.build_opener( urllib.request.ProxyHandler()) ); by = urllib.request.urlopen( &apos;http://packagecontrol.io/&apos; + pf.replace(&apos; &apos;, &apos;%20&apos;)).read(); dh = hashlib.sha256(by).hexdigest(); print(&apos;Error validating download (got %s instead of %s), please try manual install&apos; % (dh, h)) if dh != h else open(os.path.join( ipp, pf), &apos;wb&apos; ).write(by)</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…sftp-1"><a href="#å®‰è£…sftp-1" class="headerlink" title="å®‰è£…sftp"></a>å®‰è£…sftp</h2><p>é€šè¿‡å¿«æ·é”®<em>ctrl_shift+p</em> ï¼Œç„¶ååœ¨å¼¹å‡ºçš„è¾“å…¥æ¡†ä¸­è¾“å…¥ <em>pci</em> , æ‰¾åˆ° <em>Package Controller: Install Package</em> ,ç¡®å®šå›è½¦ï¼Œç„¶åè¾“å…¥<em>sftp</em>, ç­‰å¾…å®‰è£…å®Œæˆå³å¯</p><h2 id="æ–°å»º-sftpé…ç½®æ–‡ä»¶"><a href="#æ–°å»º-sftpé…ç½®æ–‡ä»¶" class="headerlink" title="æ–°å»º sftpé…ç½®æ–‡ä»¶"></a>æ–°å»º sftpé…ç½®æ–‡ä»¶</h2><p>å®‰è£…å®Œæˆ<em>sftp</em>ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯é…ç½®äº†ï¼Œå°†æˆ‘ä»¬çš„ç›®å½•æŒ‡å‘è¿œç¨‹æœåŠ¡å™¨çš„ç›®å½•ï¼Œä»è€Œå®ç°é€šè¿‡ç®€å•çš„å¿«æ·é”®æˆ–è€…è‡ªåŠ¨ä¸Šä¼ æ›´æ–°è¿œç¨‹æ–‡ä»¶ä»¥ä¸æœ¬åœ°ä¿æŒåŒæ­¥</p><ol><li><p>åœ¨æ‰“å¼€çš„æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•æ–°å»ºæ–‡ä»¶<code>sftp-config.json</code></p></li><li><p>é€šè¿‡å¿«æ·é”®<em>Ctrl+shift+p</em> ,è°ƒå‡ºæ’ä»¶ç®¡ç†panel</p></li><li><p>è¾“å…¥<em>sftp</em>, å¹¶æ‰¾åˆ° <em>SFTP: Brower Server</em>, å›è½¦ç¡®å®šå°±å‘ç°sftp-config.jsonä»¥è¢«ä¿®æ”¹æˆå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // The tab key will cycle through the settings when first created</span><br><span class="line">    // Visit http://wbond.net/sublime_packages/sftp/settings for help</span><br><span class="line">    </span><br><span class="line">    // sftp, ftp or ftps</span><br><span class="line">    &quot;type&quot;: &quot;sftp&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;sync_down_on_open&quot;: true,</span><br><span class="line">    &quot;sync_same_age&quot;: true,</span><br><span class="line">    </span><br><span class="line">    &quot;host&quot;: &quot;example.com&quot;,</span><br><span class="line">    &quot;user&quot;: &quot;username&quot;,</span><br><span class="line">    //&quot;password&quot;: &quot;password&quot;,</span><br><span class="line">    //&quot;port&quot;: &quot;22&quot;,</span><br><span class="line">    </span><br><span class="line">    &quot;remote_path&quot;: &quot;/example/path/&quot;,</span><br><span class="line">    //&quot;file_permissions&quot;: &quot;664&quot;,</span><br><span class="line">    //&quot;dir_permissions&quot;: &quot;775&quot;,</span><br><span class="line">    </span><br><span class="line">    //&quot;extra_list_connections&quot;: 0,</span><br><span class="line"></span><br><span class="line">    &quot;connect_timeout&quot;: 30,</span><br><span class="line">    //&quot;keepalive&quot;: 120,</span><br><span class="line">    //&quot;ftp_passive_mode&quot;: true,</span><br><span class="line">    //&quot;ftp_obey_passive_host&quot;: false,</span><br><span class="line">    //&quot;ssh_key_file&quot;: &quot;~/.ssh/id_rsa&quot;,</span><br><span class="line">    //&quot;sftp_flags&quot;: [&quot;-F&quot;, &quot;/path/to/ssh_config&quot;],</span><br><span class="line">    </span><br><span class="line">    //&quot;preserve_modification_times&quot;: false,</span><br><span class="line">    //&quot;remote_time_offset_in_hours&quot;: 0,</span><br><span class="line">    //&quot;remote_encoding&quot;: &quot;utf-8&quot;,</span><br><span class="line">    //&quot;remote_locale&quot;: &quot;C&quot;,</span><br><span class="line">    //&quot;allow_config_upload&quot;: false,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œåˆ†åˆ«å¡«å†™ä¸Šè‡ªå·±çš„host user password remote_path å³å¯</p></li></ol><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><p>é€šè¿‡ä¸Šé¢çš„å‡ æ­¥æ“ä½œï¼Œå·²ç»å¯ä»¥å®ç°å°†æœ¬åœ°ä¸è¿œç¨‹æ–‡ä»¶å®ç°åŒæ­¥äº†ï¼Œä½†æ˜¯ï¼Œåƒæˆ‘çš„æœåŠ¡å™¨ï¼Œå…³é—­äº†ç”¨æˆ·åå¯†ç ç™»å½•ï¼Œä»…å…è®¸å¯†é’¥ç™»å½•ï¼Œè¿™åˆè¯¥å¦‚ä½•æ“ä½œå‘¢ï¼Ÿ</p><h3 id="ç”Ÿæˆppkå¯†é’¥"><a href="#ç”Ÿæˆppkå¯†é’¥" class="headerlink" title="ç”Ÿæˆppkå¯†é’¥"></a>ç”Ÿæˆppkå¯†é’¥</h3><p>ç»è¿‡æˆ‘çš„å°è¯•ï¼Œæˆ‘å‘ç°ï¼Œå¦‚æœé€šè¿‡å¯†é’¥ç™»å½•çš„è¯ï¼ŒSublimeä¸è¯†åˆ«id_rsaè¿™æ ·æ ¼å¼çš„å¯†é’¥ï¼Œè€Œä»…ä»…è¯†åˆ«.ppkç»“å°¾çš„å¯†é’¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±éœ€è¦å°†æˆ‘ä»¬çš„id_rsaæ–‡ä»¶è½¬æˆ.ppkæ ¼å¼</p><p>æˆ‘è¿™é‡Œæ˜¯ä½¿ç”¨puttygenæ¥è¿›è¡Œå¯†é’¥æ ¼å¼è½¬æ¢çš„</p><ol><li>ä¸‹è½½å¥½puttygen</li><li>é€‰æ‹©puttygenèœå•ä¸Šçš„Conversions-&gt;Import Key é€‰æ‹© å¯†é’¥</li><li>ç‚¹å‡»é¢æ¿ä¸Šçš„ Save private key ï¼Œé€‰æ‹©ä¿å­˜ä½ç½®å³å¯è½¬æ¢å®Œæˆ</li></ol><h3 id="é…ç½®sftpçš„å¯†é’¥æ¨¡å¼"><a href="#é…ç½®sftpçš„å¯†é’¥æ¨¡å¼" class="headerlink" title="é…ç½®sftpçš„å¯†é’¥æ¨¡å¼"></a>é…ç½®sftpçš„å¯†é’¥æ¨¡å¼</h3><p>å¯†é’¥ç™»å½•å…¶å®ä¸»è¦æ˜¯ä¸Šé¢é…ç½®æ–‡ä»¶ä¸­çš„ <em>ssh_key_file</em> è¿™ä¸ªé€‰é¡¹æ¥å†³å®šçš„ï¼Œè¿™é‡Œè¦ä½¿ç”¨ç»å¯¹åœ°å€ï¼ŒæŒ‡å‘ä½ çš„ .ppk ç»“å°¾çš„å¯†é’¥ï¼Œç®€å•çš„ä¸Šä¸€ä¸‹æˆ‘çš„é…ç½®å§ï¼Œå„ä½è¯»è€…åº”è¯¥å°±ä¸€ç›®äº†ç„¶äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // The tab key will cycle through the settings when first created</span><br><span class="line">    // Visit http://wbond.net/sublime_packages/sftp/settings for help</span><br><span class="line">    </span><br><span class="line">    // sftp, ftp or ftps</span><br><span class="line">    &quot;type&quot;: &quot;sftp&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;save_before_upload&quot;: true,</span><br><span class="line">    &quot;upload_on_save&quot;: false,     // å½“ä¸ºtrueçš„æ—¶å€™ï¼Œä¿å­˜æ–‡ä»¶çš„æ—¶å€™ä¼šè‡ªåŠ¨å°†ä½ çš„æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œä¸ªäººå¼€å‘æ¯”è¾ƒé€‚åˆ</span><br><span class="line">    &quot;sync_down_on_open&quot;: false,   // å½“ä¸ºtrueçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åŒæ­¥è¿œç¨‹çš„æ–‡ä»¶å¤¹</span><br><span class="line">    &quot;sync_skip_deletes&quot;: false,</span><br><span class="line">    &quot;sync_same_age&quot;: true,</span><br><span class="line">    &quot;confirm_downloads&quot;: false,</span><br><span class="line">    &quot;confirm_sync&quot;: true,</span><br><span class="line">    &quot;confirm_overwrite_newer&quot;: false,</span><br><span class="line">    </span><br><span class="line">    &quot;host&quot;: &quot;xxx.xxx.xxx.xxx&quot;,</span><br><span class="line">    &quot;user&quot;: &quot;root&quot;,</span><br><span class="line">    //&quot;password&quot;: &quot;password&quot;,</span><br><span class="line">    //&quot;port&quot;: &quot;22&quot;,</span><br><span class="line">    </span><br><span class="line">    &quot;remote_path&quot;: &quot;/data/www/html/httpserver/&quot;,    // è¿™é‡Œæ˜¯æœåŠ¡å™¨çš„æ–‡ä»¶å¤¹è·¯å¾„</span><br><span class="line">    &quot;ignore_regexes&quot;: [</span><br><span class="line">        &quot;\\.sublime-(project|workspace)&quot;, &quot;sftp-config(-alt\\d?)?\\.json&quot;,</span><br><span class="line">        &quot;sftp-settings\\.json&quot;, &quot;/venv/&quot;, &quot;\\.svn/&quot;, &quot;\\.hg/&quot;, &quot;\\.git/&quot;,</span><br><span class="line">        &quot;\\.bzr&quot;, &quot;_darcs&quot;, &quot;CVS&quot;, &quot;\\.DS_Store&quot;, &quot;Thumbs\\.db&quot;, &quot;desktop\\.ini&quot;</span><br><span class="line">    ],</span><br><span class="line">    //&quot;file_permissions&quot;: &quot;664&quot;,</span><br><span class="line">    //&quot;dir_permissions&quot;: &quot;775&quot;,</span><br><span class="line">    //&quot;extra_list_connections&quot;: 0,</span><br><span class="line"></span><br><span class="line">    &quot;connect_timeout&quot;: 30,</span><br><span class="line">    //&quot;keepalive&quot;: 120,</span><br><span class="line">    &quot;ftp_passive_mode&quot;: true,</span><br><span class="line">    &quot;ftp_obey_passive_host&quot;: false,</span><br><span class="line">    &quot;ssh_key_file&quot;: &quot;D:\\workplace\\cloudserver\\httpserver.ppk&quot;,   // windowsä¸‹è·¯å¾„æ˜¯\\ï¼Œ linuxå’ŒMac Os æ˜¯ /</span><br><span class="line">    // &quot;sftp_flags&quot;: [&quot;-F&quot;, &quot;/etc/ssh/ssh_config&quot;],</span><br><span class="line">    </span><br><span class="line">    //&quot;preserve_modification_times&quot;: false,</span><br><span class="line">    //&quot;remote_time_offset_in_hours&quot;: 0,</span><br><span class="line">    //&quot;remote_encoding&quot;: &quot;utf-8&quot;,</span><br><span class="line">    //&quot;remote_locale&quot;: &quot;C&quot;,</span><br><span class="line">    // &quot;allow_config_upload&quot;: false,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Sublime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Sublime </tag>
            
            <tag> Package </tag>
            
            <tag> Sftp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sessioné”å¯¼è‡´çš„ajaxè¯·æ±‚é˜»å¡</title>
      <link href="/posts/17445/"/>
      <url>/posts/17445/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>åœ¨åšé¡¹ç›®çš„æ—¶å€™ï¼Œåšåˆ°ç™»å½•è¿™ä¸€å—ï¼Œéœ€è¦åŒæ—¶æ”¯æŒæ‰«ç ç™»å½•åŠè´¦å·å¯†ç ç™»å½•ï¼Œæ•´ä½“çš„æ€è·¯å¦‚ä¸‹</p><pre class="mermaid">graph TD    st(å¼€å§‹)-->op1(æ‰«ç ç™»å½•ç•Œé¢)    st-->op2(å¸å¯†ç™»å½•ç•Œé¢)    op1--æ‰‹æœºç«¯æ‰«ç å¹¶ä¸Šä¼ æ‰«ç è€…ä¿¡æ¯-->op3(æ‰«ç ç™»å½•æ¥å£)    op3--è¿”å›webæ‰«ç è€…ä¿¡æ¯-->op1    op1--æºå¸¦è¿”å›è€…ä¿¡æ¯è¯·æ±‚-->op4(å¸å¯†ç™»å½•æ¥å£)    op2--æºå¸¦ç™»å½•ä¿¡æ¯-->op4    op4--yes-->out1>ç™»å½•æˆåŠŸ]    op4--no-->out2>ç™»å½•å¤±è´¥]    out1-->en(ç»“æŸ)    out2-->en</pre><p>åæ¥å‘ç°ï¼ŒwebLoginçš„æ¥å£æ¯æ¬¡è°ƒç”¨éƒ½ç‰¹åˆ«æ…¢ï¼Œæ‰“å¼€debugåï¼Œå‘ç°webLoginéƒ½æ˜¯åœ¨scanLoginæ¥å£ç»“æŸåï¼Œæ‰èƒ½å¼€å§‹å¤„ç†ï¼ŒwebLoginè¢«é˜»å¡äº†ã€‚</p><a id="more"></a><h1 id="å¤„ç†"><a href="#å¤„ç†" class="headerlink" title="å¤„ç†"></a>å¤„ç†</h1><p>æ’æŸ¥è¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œå°±ç›´æ¥çœç•¥äº†ã€‚è¿™é‡Œçš„åŸå› æ˜¯ï¼Œæ¡†æ¶è¿™é‡Œä½¿ç”¨çš„æ˜¯Yii2ï¼ŒYii2ä¼šæŠŠåœ¨åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨session_start()æ¥å¯åŠ¨sessionï¼Œè€Œsessionæ˜¯ä»¥æ–‡ä»¶å½¢å¼å­˜å‚¨çš„ï¼Œsessionå¯åŠ¨çš„æ—¶å€™ä¼šç»™ç›¸å¯¹åº”çš„sessionæ–‡ä»¶åŠ ä¸Šé”ï¼Œæ¥å£å¤„ç†ç»“æŸæ—¶ï¼Œå–æ¶ˆé”ï¼Œä»è€Œå¯¼è‡´çš„ç¬¬äºŒä¸ªæ¥å£åœ¨è°ƒç”¨çš„æ—¶å€™è¢«æŒ‚èµ·ã€‚</p><p>PHPä¸­å¯ä»¥é€šè¿‡ä¸‹é¢å‡½æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_write_close();</span><br></pre></td></tr></table></figure><p>å…³é—­sessionçš„æ–‡ä»¶é”ã€‚</p><h1 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h1><h2 id="å½“ä½ è°ƒç”¨-session-start-æ—¶ï¼Œéƒ½å‘ç”Ÿäº†ä»€ä¹ˆ"><a href="#å½“ä½ è°ƒç”¨-session-start-æ—¶ï¼Œéƒ½å‘ç”Ÿäº†ä»€ä¹ˆ" class="headerlink" title="å½“ä½ è°ƒç”¨ session_start() æ—¶ï¼Œéƒ½å‘ç”Ÿäº†ä»€ä¹ˆ"></a>å½“ä½ è°ƒç”¨ session_start() æ—¶ï¼Œéƒ½å‘ç”Ÿäº†ä»€ä¹ˆ</h2><p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåŸºæœ¬çš„ PHP é…ç½®ä¸ºä¾‹ï¼šå½“ä½ å¼€å§‹ä¸€æ¬¡ PHP ä¼šè¯æ—¶ï¼ŒPHPä¼šåœ¨ <em>session.save_path</em> è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ï¼Œé»˜è®¤è·¯å¾„ä¸º <em>/var/lib/php/session</em> ã€‚æ‰€æœ‰çš„ session æ•°æ®éƒ½ä¿å­˜åœ¨è¿™ä¸ªåœ°æ–¹ã€‚</p><p>å¦‚æœä½ çš„ç”¨æˆ·è¿˜æ²¡æœ‰ä¸€ä¸ª session cookie ï¼Œé‚£ä¹ˆ PHP å°†äº§ç”Ÿä¸€ä¸ªæ–°çš„ IDï¼Œå¹¶è®¾ç½®åˆ°ç”¨æˆ·æœºå™¨çš„ cookie ä¸­ã€‚å¦‚æœæ˜¯ä¸€ä¸ªå·²è®¿é—®è¿‡çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆä»–ä¼šå°† cookie å‘é€ç»™ä½ çš„ web æœåŠ¡å™¨ï¼ŒPHP åˆ™ä¼šè§£æå®ƒï¼Œå¹¶ä¸”ä» <em>session.save_path</em> è·¯å¾„ä¸‹åŠ è½½åˆ°ç›¸åº”çš„ session æ•°æ®ã€‚<br>ç®€è€Œè¨€ä¹‹ï¼Œè¿™å°±æ˜¯ <em>session_start()</em> çš„æ‰€åšçš„å·¥ä½œã€‚</p><h2 id="ä¼šè¯é”ä¸å¹¶å‘"><a href="#ä¼šè¯é”ä¸å¹¶å‘" class="headerlink" title="ä¼šè¯é”ä¸å¹¶å‘"></a>ä¼šè¯é”ä¸å¹¶å‘</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ä¸€ä¸ªç¨å¾®å®Œæ•´ä¸€ç‚¹çš„ä¾‹å­ï¼Œæ¥æˆ‘ä»¬è¯´æ˜PHPåˆå§‹åŒ–sessionåï¼Œå„ä¸ªåœºæ™¯ä¸‹æ‰€å‘ç”Ÿçš„äº‹æƒ…ã€‚</p><table><thead><tr><th>Timing</th><th>PHP Code</th><th>Linux/Server</th></tr></thead><tbody><tr><td>0ms</td><td><code>session_start();</code></td><td>åˆ›å»ºæ–‡ä»¶é”ï¼š/var/lib/php/session/sess_$identifier</td></tr><tr><td>15ms</td><td>SQLæŸ¥è¯¢ï¼Œforå¾ªç¯ï¼Œç¬¬ä¸‰æ–¹APIè°ƒç”¨</td><td>æŒæœ‰sessionæ–‡ä»¶é”</td></tr><tr><td>350ms</td><td>PHPè„šæœ¬æ‰§è¡Œç»“æŸ</td><td>sessionæ–‡ä»¶é”è¢«ç§»é™¤</td></tr></tbody></table><p>å½“ä½ è°ƒç”¨<strong>session_start()</strong>ï¼ˆæˆ–è€…PHPçš„<strong>session.auto_start</strong>è¢«è®¾ç½®ä¸ºtrueæ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼‰ï¼Œæ“ä½œç³»ç»Ÿä¼šé”ä½sessionæ–‡ä»¶ã€‚å¤§å¤šæ•°æ–‡ä»¶é”çš„å®ç°éƒ½æ˜¯<code>flock</code>ï¼Œåœ¨Linuxä¸Šï¼Œå®ƒä¹Ÿç”¨äº<a href="https://ma.ttias.be/prevent-cronjobs-from-overlapping-in-linux/" target="_blank" rel="noopener">é˜²æ­¢å®šæ—¶ä»»åŠ¡çš„é‡å¤æ‰§è¡Œ</a>æˆ–è€…å…¶å®ƒæ–‡ä»¶é”å®šå·¥ä½œã€‚<br>åœ¨Linuxæœºå™¨ä¸Šï¼Œä¸€ä¸ªsessionæ–‡ä»¶é”çœ‹èµ·æ¥å°±åƒè¿™æ ·å­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ fuser /var/lib/php/session/sess_cdmtgg3noi8fb6j2vqkaai9ff5</span><br><span class="line">/var/lib/php/session/sess_cdmtgg3noi8fb6j2vqkaai9ff5:  2768  2769  2770</span><br></pre></td></tr></table></figure><p><code>fuser</code>æŠ¥å‘Šäº†3ä¸ªè¿›ç¨‹çš„PIDï¼Œè¿™äº›è¿›ç¨‹è¦ä¹ˆæ­£æŒæœ‰æ­¤æ–‡ä»¶é”ï¼Œæˆ–è€…æ­£åœ¨ç­‰å¾…æ­¤æ–‡ä»¶é”çš„é‡Šæ”¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lsof /var/lib/php/session/sess_cdmtgg3noi8fb6j2vqkaai9ff5</span><br><span class="line">COMMAND PID  USER      FD  TYPE DEVICE SIZE/OFF NODE   NAME</span><br><span class="line">php-fpm 2769 http_demo 5uW REG  253,1  0        655415 sess_cdmtgg3noi8fb6j2vqkaai9ff5</span><br></pre></td></tr></table></figure><p><code>lsof</code>å¯ä»¥å‘ŠçŸ¥ä½ å½“å‰æŒæœ‰æ–‡ä»¶é”çš„PIDä»¥åŠæŒ‡ä»¤ã€‚<br>è¯¥sessionçš„æ–‡ä»¶é”ä¼šä¿æŒåˆ°è„šæœ¬æ‰§è¡Œç»“æŸæˆ–è€…è¢«ä¸»åŠ¨ç§»é™¤ï¼ˆåé¢ä¼šè®²åˆ°ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªè¯»å†™é”ï¼šä»»ä½•å¯¹sessionè¯»å–éƒ½å¿…é¡»ç­‰åˆ°é”è¢«é‡Šæ”¾ä¹‹åã€‚<br>é”æœ¬èº«å¹¶ä¸æ˜¯é—®é¢˜ã€‚å®ƒä¿æŠ¤sessionæ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œé˜²æ­¢å¤šä¸ªåŒæ—¶å†™å…¥æŸæ¯æ•°æ®æˆ–è€…è¦†ç›–ä¹‹å‰çš„æ•°æ®ã€‚<br>ä½†æ˜¯å½“ç¬¬äºŒä¸ªå¹¶å‘çš„PHPæ‰§è¡Œæƒ³è¦è·å–åŒä¸€ä¸ªPHPä¼šè¯çš„æ—¶å€™ï¼Œå°±ä¼šé€ æˆé—®é¢˜äº†ã€‚</p><table><thead><tr><th>Timing</th><th>script 1</th><th>Linux/Server</th><th>script 2</th></tr></thead><tbody><tr><td>0ms</td><td><code>session_start();</code></td><td>script1é”å®š(<code>flock</code>)æ–‡ä»¶/var/lib/php/session/sess_$identifier</td><td><code>session_start();</code>è¢«è°ƒç”¨ï¼Œä½†æ˜¯è¢«é”é˜»å¡ã€‚PHPç­‰å¾…é”è¢«ç§»é™¤ã€‚</td></tr><tr><td>15ms</td><td>SQLæŸ¥è¯¢ï¼Œforå¾ªç¯ï¼Œç¬¬ä¸‰æ–¹APIè°ƒç”¨</td><td>æ–‡ä»¶é”ä¿æŒä¸å˜ã€‚</td><td>è„šæœ¬ä»ç„¶åœ¨ç­‰å¾…ï¼Œå•¥éƒ½ä¸åšã€‚</td></tr><tr><td>350ms</td><td>script1æ‰§è¡Œç»“æŸã€‚</td><td>script1æŒæœ‰çš„æ–‡ä»¶é”è¢«ç§»é™¤ã€‚</td><td>script2ä»ç„¶åœ¨ç­‰å¾…ã€‚</td></tr><tr><td>360ms</td><td></td><td>script2å¾—åˆ°æ–°çš„æ–‡ä»¶é”ã€‚</td><td>script2ç°åœ¨å¯ä»¥æ‰§è¡Œå®ƒçš„SQLæŸ¥è¯¢ï¼Œforå¾ªç¯â€¦</td></tr><tr><td>700ms</td><td></td><td>script2æŒæœ‰çš„æ–‡ä»¶é”è¢«ç§»é™¤ã€‚</td><td>script2æ‰§è¡Œç»“æŸã€‚</td></tr></tbody></table><p>è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„è¡¨æ ¼ï¼š</p><ul><li>å½“2ä¸ªPHPæ–‡ä»¶åŒæ—¶æƒ³è¦å¼€å§‹ä¸€ä¸ªä¼šè¯æ—¶ï¼Œåªæœ‰ä¸€ä¸ªèƒ½èµ¢ä¸”è·å¾—é”ã€‚å¦ä¸€ä¸ªåˆ™éœ€è¦ç­‰å¾…ã€‚</li><li>å½“å®ƒç­‰å¾…çš„æ—¶å€™ï¼Œä¸ä¼šåšä»»ä½•äº‹æƒ…ï¼š<code>session_start()</code>é˜»å¡äº†ä¹‹ååŠ¨ä½œçš„æ‰§è¡Œã€‚</li><li>ä¸€æ—¦ç¬¬ä¸€ä¸ªè„šæœ¬çš„é”è¢«ç§»é™¤ï¼Œç¬¬äºŒä¸ªè„šæœ¬åœ¨è·å¾—é”çš„åŒæ—¶å°±å¯ä»¥å‘åç»§ç»­æ‰§è¡Œäº†ã€‚</li></ul><p><strong>åœ¨ç»å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œè¿™éƒ½ä½¿å¾—PHPå¯¹äºåŒä¸€ä¸ªç”¨æˆ·æ¥è¯´ï¼Œè¡¨ç°å¾—åƒæ˜¯ä¸€ç³»åˆ—åŒæ­¥è„šæœ¬ï¼šä¸€ä¸ªæ‰§è¡Œå®Œæˆåæ‰§è¡Œä¸‹ä¸€ä¸ªï¼Œæ²¡æœ‰å¹³è¡Œçš„è¯·æ±‚ã€‚å³ä½¿ä½ ä½¿ç”¨AJAXè°ƒç”¨è¿™äº›PHPè„šæœ¬ä¹Ÿæ— æµäºäº‹ã€‚</strong><br>æ‰€ä»¥ï¼Œåˆšæ‰ä¸¤ä¸ªè„šæœ¬æ²¡èƒ½åŒæ—¶åœ¨350mså·¦å³çš„æ—¶é—´æ‰§è¡Œå®Œæ¯•ï¼Œç¬¬ä¸€ä¸ªè„šæœ¬350msæ‰§è¡Œå®Œæ¯•ï¼Œè€Œç¬¬ä¸€ä¸ªè„šæœ¬åˆ™æ¶ˆè€—ä¸¤å€çš„æ—¶é•¿æ‰§è¡Œäº†700msï¼Œå› ä¸ºå®ƒå¾—ç­‰ç¬¬ä¸€ä¸ªè„šæœ¬å…ˆæ‰§è¡Œå®Œã€‚</p><h2 id="å¯é€‰çš„sessionå¤„ç†å™¨ï¼šredisï¼Œmemcacheï¼Œmysql"><a href="#å¯é€‰çš„sessionå¤„ç†å™¨ï¼šredisï¼Œmemcacheï¼Œmysql" class="headerlink" title="å¯é€‰çš„sessionå¤„ç†å™¨ï¼šredisï¼Œmemcacheï¼Œmysql"></a>å¯é€‰çš„sessionå¤„ç†å™¨ï¼šredisï¼Œmemcacheï¼Œmysql</h2><p>å¦‚æœä½ åœ¨å¯»æ±‚ä¸€ä¸ªå¿«é€Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œè§‰å¾—â€œæˆ‘åªéœ€è¦æŠŠsessionä¿å­˜åœ¨memcachedé‡Œâ€ï¼Œé‚£ä¹ˆä½ ä¼šå¤±æœ›çš„ã€‚é»˜è®¤çš„memcachedé…ç½®ä½¿ç”¨äº†ä¸ä¹‹å‰æè¿°ç›¸åŒçš„ã€å®‰å…¨çš„é€»è¾‘ï¼šåªè¦æœ‰ä¸€ä¸ªPHPä½¿ç”¨äº†sessionsé‚£å®ƒä»¬å°±ä¼šé˜»å¡ã€‚<br>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨PHPçš„memcachedæ‰©å±•ï¼Œä½ å¯ä»¥å°†<code>memcached.sess_locking</code>è®¾ç½®ä¸ºâ€œoffâ€ï¼Œæ¥é¿å…sessioné”ã€‚è¯¥é…ç½®é¡¹çš„é»˜è®¤å€¼æ˜¯â€œonâ€ï¼Œä¸æ™®é€šçš„sessionå¤„ç†å™¨ä¸€æ ·ä¼šé˜»å¡ã€‚<br>å¦‚æœä½ åœ¨ä½¿ç”¨redisï¼Œé‚£ä¹ˆä½ æ˜¯å¹¸è¿çš„ï¼Œå› ä¸ºredisçš„sessionå¤„ç†å™¨è¿˜æ²¡æœ‰æ”¯æŒé”åŠŸèƒ½ã€‚ç”¨redisä½œä¸ºsessionå­˜å‚¨åç«¯ï¼Œæ˜¯æ²¡æœ‰é”çš„ã€‚<br>å¦‚æœä½ åœ¨ä½¿ç”¨MySQLä½œä¸ºsessionåç«¯å­˜å‚¨ï¼Œä½ ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„å®ç°ï¼šæ²¡æœ‰ä¸€ä¸ªPHPæ‰©å±•å®ç°äº†ä½¿ç”¨MySQLä½œä¸ºsessionå­˜å‚¨çš„åŠŸèƒ½ã€‚åœ¨ä½ çš„PHPä»£ç ä¸­ä¼šæœ‰ä¸€ä¸ªå‡½æ•°<a href="http://php.net/manual/en/function.session-set-save-handler.php" target="_blank" rel="noopener">session_set_save_handler()</a>ç”³æ˜äº†è´Ÿè´£sessionæ•°æ®è¯»å–å’Œå†™å…¥çš„ç±»æˆ–è€…æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ çš„ä»£ç å®ç°å†³å®šäº†sessionæ˜¯å¦ä¼šäº§ç”Ÿé˜»å¡ã€‚</p><h2 id="PHP-sessioné”ï¼šæƒ³è¦è§£å†³çš„é—®é¢˜"><a href="#PHP-sessioné”ï¼šæƒ³è¦è§£å†³çš„é—®é¢˜" class="headerlink" title="PHP sessioné”ï¼šæƒ³è¦è§£å†³çš„é—®é¢˜"></a>PHP sessioné”ï¼šæƒ³è¦è§£å†³çš„é—®é¢˜</h2><p>æˆ‘å¯¹äºsessioné”è¡Œä¸ºçš„çœ‹æ³•çœ‹èµ·è¿‡äºè´Ÿé¢äº†ï¼Œä½†å®é™…ä¸Šæˆ‘åªæ˜¯æé†’ä½ æ³¨æ„å®ƒçš„è¡Œä¸ºæ–¹å¼ã€‚å…¶å®é”çš„å­˜åœ¨ä¹Ÿå®ƒå¥½çš„ä¸€é¢ã€‚<br>æƒ³è±¡ä»¥ä¸‹æ²¡æœ‰â€œsessioné”â€çš„åœºæ™¯ï¼Œå½“ä¸¤ä¸ªè„šæœ¬åŒæ—¶å¤„ç†åŒä¸€ä¸ªsessionæ•°æ®æ—¶ï¼Œå¯èƒ½å¼•å‘é”™è¯¯ï¼š</p><table><thead><tr><th>Timing</th><th>script 1</th><th>script 2</th></tr></thead><tbody><tr><td>0ms</td><td><code>session_start();</code>sessionæ•°æ®è¢«è¯»å…¥åˆ°$_SESSIONå˜é‡ä¸­</td><td>îº1î»sessionæ•°æ®è¢«è¯»å…¥åˆ°$_SESSIONå˜é‡ä¸­</td><td></td></tr><tr><td>15ms</td><td>è„šæœ¬1å†™å…¥sessionæ•°æ®ï¼š<code>$_SESSION[&#39;payment_id&#39;] = 1;</code></td><td>è„šæœ¬2å†™å…¥sessionæ•°æ®ï¼š<code>$_SESSION[&#39;payment_id&#39;] = 5;</code></td></tr><tr><td>350ms</td><td><code>sleep(1);</code></td><td>è„šæœ¬ç»“æŸï¼Œä¿å­˜sessionæ•°æ®</td></tr><tr><td>450ms</td><td>è„šæœ¬ç»“æŸï¼Œä¿å­˜sessionæ•°æ®</td></tr></tbody></table><blockquote><p>sessionä¸­çš„æ•°æ®å€¼åº”è¯¥æ˜¯å¤šå°‘ï¼Ÿ<br>åº”å½“æ˜¯è„šæœ¬1çš„æ‰€ä¿å­˜çš„å€¼ã€‚å› ä¸ºè„šæœ¬2æ‰€ä¿å­˜çš„å€¼è¢«è„šæœ¬1æœ€åæ‰€ä¿å­˜çš„å€¼è¦†ç›–äº†ã€‚</p></blockquote><p><strong>è¿™æ˜¯ä¸€ä¸ªéå¸¸å°´å°¬ï¼Œè€Œä¸”åˆå¾ˆéš¾æ’æŸ¥çš„å¹¶å‘é—®é¢˜ã€‚sessioné”å¯ä»¥é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿã€‚</strong><br>ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™æ˜¯å†™sessionæ•°æ®æ—¶æ‰ä¼šç¢°åˆ°çš„é—®é¢˜ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªPHPè„šæœ¬åªæ˜¯è¯»å–sessionæ•°æ®ï¼ˆå¤§å¤šæ•°ajaxè¯·æ±‚éƒ½æ˜¯ï¼‰ï¼Œä½ å¯ä»¥å®‰å…¨åœ°å¯¹æ•°æ®è¿›è¡Œå¤šæ¬¡è¯»å–ã€‚<br>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„è„šæœ¬ï¼Œå®ƒè¯»å–äº†sessionæ•°æ®å¹¶ä¸”è¿˜ä¼šä¿®æ”¹sessionæ•°æ®ï¼Œè€Œå¦ä¸€ä¸ªè„šæœ¬å¼€å§‹æ‰§è¡Œå¹¶ä¸”è¯»å–åˆ°äº†æ—§çš„è¿‡æ—¶æ•°æ® â€” è¿™ä¹Ÿå¯èƒ½ä½¿ä½ çš„åº”ç”¨å‡ºé”™ã€‚</p><h2 id="å…³é—­PHPçš„ä¼šè¯é”ï¼šPHP-5-x-å’Œ-PHP-7"><a href="#å…³é—­PHPçš„ä¼šè¯é”ï¼šPHP-5-x-å’Œ-PHP-7" class="headerlink" title="å…³é—­PHPçš„ä¼šè¯é”ï¼šPHP 5.x å’Œ PHP 7"></a>å…³é—­PHPçš„ä¼šè¯é”ï¼šPHP 5.x å’Œ PHP 7</h2><p>PHPä¸­æœ‰ä¸€ä¸ªæ–¹æ³•å«åš<code>session_write_close()</code>ã€‚å®ƒçš„åŠŸèƒ½å¦‚å…¶åï¼šå†™å…¥sessionæ•°æ®ï¼Œå…³é—­sessionæ–‡ä»¶ï¼Œä»è€Œè§£é™¤äº†sessioné”ã€‚ä½ åœ¨PHPä»£ç ä¸­ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// This works in PHP 5.x and PHP 7</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$_SESSION[&apos;something&apos;] = &apos;foo&apos;;</span><br><span class="line">$_SESSION[&apos;yolo&apos;] = &apos;swag&apos;;</span><br><span class="line"></span><br><span class="line">session_write_close();</span><br><span class="line"></span><br><span class="line">// Do the rest of your PHP execution below</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç¤ºä¾‹ä»£ç å…ˆå¼€å¯äº†sessionï¼ˆå°†sessionæ•°æ®è¯»åˆ°\$_SESSIONä¸­ï¼‰ï¼Œç„¶åå†™å…¥æ•°æ®å†è§£é™¤é”ã€‚æ¥ä¸‹æ¥ï¼Œå®ƒå°±å†ä¹Ÿä¸èƒ½å†™å…¥è¿™ä¸ªsessionæ–‡ä»¶äº†ã€‚å¦‚æœæ¥ä¸‹æ¥è¯¥è„šæœ¬è¿˜åœ¨ç»§ç»­æ“ä½œ$_SESSIONå˜é‡ï¼Œé‚£ä¹ˆè¿™äº›å˜åŒ–éƒ½ä¸ä¼šè¢«ä¿å­˜ä¸‹æ¥ã€‚<br>ä»PHP 7å¼€å§‹ï¼Œåœ¨è°ƒç”¨<code>session_start()</code>çš„æ—¶å€™ä½ å¯è®¾ç½®é¢å¤–çš„é€‰é¡¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start([</span><br><span class="line">  &apos;read_and_close&apos; =&gt; true</span><br><span class="line">]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šè¯­æ³•ç­‰åŒäºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">session_write_close();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>å®ƒå…ˆè¯»å–äº†sessionæ•°æ®ï¼Œç„¶åç«‹åˆ»é‡Šæ”¾äº†é”ï¼Œè¿™æ ·å°±ä¸ä¼šé˜»å¡å…¶å®ƒè„šæœ¬äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Ajax </tag>
            
            <tag> SESSION </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPè·å–ç¯å¢ƒå˜é‡</title>
      <link href="/posts/44810/"/>
      <url>/posts/44810/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>ä½¿ç”¨PHPçš„execç­‰å‡½æ•°ä¸ï¼šLinuxè¿›è¡Œäº¤äº’æ˜¯å¾ˆå¸¸è§çš„æ–¹å¼ï¼Œä½†æ˜¯æœ‰æ—¶å€™å‘ç°ï¼Œåœ¨ç»ˆç«¯é‡Œé¢é€šè¿‡å‘½ä»¤è¡Œæ¨¡å¼è¿è¡Œçš„ä»£ç å¯è¡Œï¼Œæ”¾åˆ°ç½‘ç«™ä¸Šå»è®¿é—®å°±å‡ºé—®é¢˜äº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯å› ä¸ºåœ¨é€šè¿‡Nginxè°ƒèµ·PHP-FPMçš„æ—¶å€™ï¼Œä¼šå­˜åœ¨ä¸€äº›å‚æ•°çš„é…ç½®é—®é¢˜ä¸‹é¢å°±ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸¤ç§æ–¹å¼ã€‚</p><a id="more"></a><h1 id="è§£å†³-PHP-FPMæ¨¡å¼"><a href="#è§£å†³-PHP-FPMæ¨¡å¼" class="headerlink" title="è§£å†³-PHP-FPMæ¨¡å¼"></a>è§£å†³-PHP-FPMæ¨¡å¼</h1><ol><li><p>é€šè¿‡Nginxä¼ é€’</p><p>å¦‚åœ¨nginxçš„é…ç½®é‡Œè®¾ç½®ï¼š<br><code>fastcgi_param  ENV_XXX  123456;</code><br>æ¯æ¬¡é¡µé¢è¯·æ±‚nginxéƒ½ä¼šå°†æ­¤å˜é‡ä¼ é€’ç»™phpï¼Œphpå¯ä»¥é€šè¿‡getenvå‡½æ•°æˆ–$_SERVERå…¨å±€å˜é‡è·å¾—ã€‚ </p></li><li><p>é€šè¿‡PHP-FPMé…ç½®ä¼ é€’</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">; Clear environment in FPM workers</span><br><span class="line">; Prevents arbitrary environment variables from reaching FPM worker processes</span><br><span class="line">; by clearing the environment in workers before env vars specified in this</span><br><span class="line">; pool configuration are added.</span><br><span class="line">; Setting to &quot;no&quot; will make all environment variables available to PHP code</span><br><span class="line">; via getenv(), _ENV and _SERVER.</span><br><span class="line">; Default Value: yes </span><br><span class="line">; clear_env = no</span><br><span class="line"></span><br><span class="line">; Pass environment variables like LD_LIBRARY_PATH. All $VARIABLEs are taken from</span><br><span class="line">; the current environment.</span><br><span class="line">; Default Value: clean env </span><br><span class="line">;env[HOSTNAME] = $HOSTNAME</span><br><span class="line">env[PATH] = /usr/local/bin:/usr/bin:/bin:/usr/local/sbin</span><br><span class="line">;env[TMP] = /tmp</span><br><span class="line">;env[TMPDIR] = /tmp</span><br><span class="line">;env[TEMP] = /tmp</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯php-fpm.confï¼ˆåŒ…æ‹¬php-fpm.d/<a href="http://www.confï¼‰é‡Œé¢å…³äºç¯å¢ƒå˜é‡çš„é…ç½®ï¼Œåœ¨é‡Œé¢æœ‰ä¸€ä¸ª`clear_env`çš„å‚æ•°é…ç½®ï¼Œè¿™ä¸ªé»˜è®¤æ˜¯*yes*ï¼Œè€Œä»–çš„å«ä¹‰å°±æ˜¯ä¼šæŠŠLinuxä¸Šè®¾ç½®çš„ç¯å¢ƒå˜é‡ç»™æ¸…ç©ºï¼Œè¿™æ ·çš„è®¾ç½®ä¹Ÿæ˜¯åŸºäºå®‰å…¨è§’åº¦æ¥è€ƒè™‘ï¼Œæˆ‘ä»¬æ­¤æ—¶æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º*no*å³å¯ï¼Œå³" target="_blank" rel="noopener">www.confï¼‰é‡Œé¢å…³äºç¯å¢ƒå˜é‡çš„é…ç½®ï¼Œåœ¨é‡Œé¢æœ‰ä¸€ä¸ª`clear_env`çš„å‚æ•°é…ç½®ï¼Œè¿™ä¸ªé»˜è®¤æ˜¯*yes*ï¼Œè€Œä»–çš„å«ä¹‰å°±æ˜¯ä¼šæŠŠLinuxä¸Šè®¾ç½®çš„ç¯å¢ƒå˜é‡ç»™æ¸…ç©ºï¼Œè¿™æ ·çš„è®¾ç½®ä¹Ÿæ˜¯åŸºäºå®‰å…¨è§’åº¦æ¥è€ƒè™‘ï¼Œæˆ‘ä»¬æ­¤æ—¶æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º*no*å³å¯ï¼Œå³</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clear_env = no</span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹é¢çš„é…ç½®ä¸­æœ‰ä¸€ä¸ª<code>env[PATH]</code>çš„å‚æ•°é…ç½®ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥æ»¡è¶³æˆ‘ä»¬è®¾ç½®ç¯å¢ƒå˜é‡çš„éœ€æ±‚</p><p>â€‹</p><h1 id="è§£å†³-å‘½ä»¤è¡Œæ¨¡å¼"><a href="#è§£å†³-å‘½ä»¤è¡Œæ¨¡å¼" class="headerlink" title="è§£å†³-å‘½ä»¤è¡Œæ¨¡å¼"></a>è§£å†³-å‘½ä»¤è¡Œæ¨¡å¼</h1><p>å‘½ä»¤è¡Œæ¨¡å¼é™åˆ¶è¾ƒå°‘ï¼Œå¯ä»¥é€šè¿‡getenvå‡½æ•°æˆ–$_SERVERå…¨å±€å˜é‡è·å–å¯¹å½“å‰æ‰§è¡Œç”¨æˆ·æœ‰æ•ˆçš„ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ŒåŒæ ·è¦æ³¨æ„sudoçš„é™åˆ¶</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
            <tag> php-fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨redis-dumpå¯¹redisçš„æ•°æ®è¿›è¡Œå¯¼å…¥å¯¼å‡º</title>
      <link href="/posts/55761/"/>
      <url>/posts/55761/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>Redisè™½ç„¶å¯ä»¥è¿›è¡Œaofå’Œrdbçš„å¤‡ä»½ï¼Œä½†æ˜¯æ€»æ˜¯ç”¨èµ·æ¥æ²¡æœ‰MySQLå¯¹æ•°æ®çš„ç®¡ç†æ„Ÿè§‰é¡ºæ‰‹ï¼Œä¾¿äº§ç”Ÿäº†ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¥è¿›è¡Œæ•°æ®ç®¡ç†çš„æƒ³æ³•ä»¥åŠå®ç°ã€‚</p><a id="more"></a><h1 id="å®‰è£…Ruby"><a href="#å®‰è£…Ruby" class="headerlink" title="å®‰è£…Ruby"></a>å®‰è£…Ruby</h1><p>Redis-dumpçš„å®‰è£…ä¾èµ–Rubyè¾ƒé«˜ç‰ˆæœ¬ï¼Œyumæºé‡Œé¢çš„Rubyç‰ˆæœ¬è¾ƒä½ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨<code>rvm</code>è¿›è¡Œå®‰è£…</p><ol><li><p>å®‰è£…<code>RVM</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB</span><br><span class="line">\curl -sSL https://get.rvm.io | bash -s stable</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨<code>RVM</code> å®‰è£…<code>Ruby</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm install ruby</span><br></pre></td></tr></table></figure></li></ol><h1 id="å®‰è£…redis-dump"><a href="#å®‰è£…redis-dump" class="headerlink" title="å®‰è£…redis-dump"></a>å®‰è£…redis-dump</h1><p>ç›´æ¥ä½¿ç”¨<code>Ruby</code>çš„<code>gem</code>åŒ…ç®¡ç†ç›´æ¥å®‰è£…å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis-dump</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨redis-dump"><a href="#ä½¿ç”¨redis-dump" class="headerlink" title="ä½¿ç”¨redis-dump"></a>ä½¿ç”¨redis-dump</h1><ol><li><p>å¯¼å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-dump -u :password@xxx.xxx.xxx.xxx:6379 &gt; redis.json</span><br></pre></td></tr></table></figure></li><li><p>å¯¼å…¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-load -u :password@localhost &lt; redis.json</span><br></pre></td></tr></table></figure></li><li><p>æ›´å¤š</p><p>æ›´å¤šå¯å‚è€ƒå®˜æ–¹ä½¿ç”¨æ‰‹å†Œ</p><p><a href="http://delanotes.com/redis-dump/" target="_blank" rel="noopener">http://delanotes.com/redis-dump/</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowsä¸Šä¼ ZIPæ–‡ä»¶åˆ°Linuxä¸‹ï¼Œè§£å‹ä¹±ç å¤„ç†</title>
      <link href="/posts/35688/"/>
      <url>/posts/35688/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>ä½œä¸ºç å†œï¼Œä»windowsä¸Šä¸Šä¼ æ–‡ä»¶ä¸€èˆ¬éƒ½ä¼šé¿å…ä¸­æ–‡å‘½åï¼Œéƒ½çŸ¥é“ä¼šæœ‰ç¼–ç çš„é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªé—®é¢˜æ˜¯ä¸å¯é€ƒé¿çš„ã€‚</p><p>è¿‘æœŸï¼Œæˆ‘ç»™PMåšä¸€ä¸ªäº§å“åŸå‹çš„ç®¡ç†é¡µé¢çš„æ—¶å€™ï¼Œè¿™ä¸ªé—®é¢˜ä¾¿ä¸å¯é¿å…çš„å‘ç”Ÿäº†ã€‚</p><a id="more"></a><h1 id="å¤„ç†"><a href="#å¤„ç†" class="headerlink" title="å¤„ç†"></a>å¤„ç†</h1><p>Linuxä¸‹è§£å‹ZIPæ–‡ä»¶ï¼Œä¸»è¦ä¾é <code>unzip</code>è¿™ä¸ªå‘½ä»¤ï¼Œé€šè¿‡<code>-h</code>æŸ¥çœ‹å¸®åŠ©åï¼Œå‘ç°<code>unzip</code>æœ‰ä¸ªÂ·<code>-O -I</code>è¿™ä¸¤ä¸ªå‚æ•°ï¼ˆps: å¦‚æœæ²¡æœ‰ï¼Œè¯·å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰</p><p>å¯¹äºè¿™ä¸¤ä¸ªå‚æ•°çš„è§£é‡Šå¦‚ä¸‹</p><blockquote><p>  -O CHARSET  specify a character encoding for DOS, Windows and OS/2 archives<br>  -I CHARSET  specify a character encoding for UNIX and other archives</p></blockquote><p>ç”±ä¸Šå¯çŸ¥ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨<code>-O</code>åº”è¯¥å°±å¯ä»¥é¿å…ç¼–ç é—®é¢˜äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -O gbk filename.zip</span><br></pre></td></tr></table></figure><h1 id="æ‰©å±•é—®é¢˜-PHPä¸‹å¤„ç†"><a href="#æ‰©å±•é—®é¢˜-PHPä¸‹å¤„ç†" class="headerlink" title="æ‰©å±•é—®é¢˜-PHPä¸‹å¤„ç†"></a>æ‰©å±•é—®é¢˜-PHPä¸‹å¤„ç†</h1><p>åœ¨Linuxç»ˆç«¯ä¸‹ï¼Œå¤„ç†ä¸Šè¿°æ–‡ä»¶å·²ç»æ²¡æœ‰é—®é¢˜äº†ï¼Œæ¥ä¸‹æ¥è‚¯å®šè¦è€ƒè™‘ä½¿ç”¨PHPæ¥è¿›è¡Œå¤„ç†äº†ã€‚</p><p>phpæœ‰ä¸€ä¸ªZipArchiv è§£å‹ç¼©ç±»ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰æ‰¾åˆ°é’ˆå¯¹ç¼–ç çš„å¤„ç†æ–¹å¼ï¼Œæ‰€ä»¥æ— å¥ˆè¿˜æ˜¯é€šè¿‡<code>exec</code>ç­‰å‘½ä»¤æ¥å¤„ç†ã€‚<strong>æ³¨æ„ï¼š</strong> å¦‚æœä½ çš„phpè„šæœ¬æ˜¯é€šè¿‡php-fpmæ¥è°ƒåº¦æ‰§è¡Œè€Œä¸æ˜¯php-cliç›´æ¥æ‰§è¡Œçš„è¯ï¼Œphp-fpmçš„é…ç½®æ–‡ä»¶<em>php-fpm.conf</em>æˆ–<em>php-fpm.d/<a href="http://www.conf" target="_blank" rel="noopener">www.conf</a></em>é‡Œé¢ä¼šæœ‰ç¯å¢ƒå˜é‡çš„è®¾ç½®ï¼Œè¿™é‡Œè¦æ³¨æ„php-fpmçš„ç¯å¢ƒå˜é‡é‡Œé¢çš„<em>LANG</em>çš„å€¼ä¸Linuxçš„è®¾ç½®çš„ç›¸åŒï¼Œä¸ç„¶è¿˜æ˜¯ä¼šå­˜åœ¨ä¹±ç çš„é—®é¢˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Debug </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Muninå®‰è£…åŠç›‘æ§-æŠ¥è­¦é…ç½®</title>
      <link href="/posts/25813/"/>
      <url>/posts/25813/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å®Œæˆ<a href="https://tyloafer.github.io/2017/12/09/Muninç›‘æ§å®‰è£…åŠé…ç½®/">ã€ŠMuninå®‰è£…åŠç›‘æ§ã€‹</a>ä¹‹åï¼Œå¦ä¸€ä¸ªåŠŸèƒ½-æŠ¥è­¦å°±è¢«æä¸Šæ—¥ç¨‹äº†ï¼Œè‹¦è‹¦æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ä¹‹åï¼Œå‘ç°ä¹Ÿä»…ä»…æ˜¯ä»‹ç»äº†æœ‰è¿™ä¸ªæŠ¥è­¦çš„åŠŸèƒ½ã€‚</p><a id="more"></a><h1 id="Commandé…ç½®"><a href="#Commandé…ç½®" class="headerlink" title="Commandé…ç½®"></a>Commandé…ç½®</h1><p>åœ¨<em>munin.conf</em> æœ‰ä¸ªé…ç½®æ˜¯ <em>contact.anotheruser.command</em>ï¼Œ è€Œæœ¬ç¯‡æ–‡ç« çš„æŠ¥è­¦ä¹Ÿæ˜¯åŸºäºè¿™ä¸ªå‘½ä»¤å®ç°çš„ï¼Œå…ˆè´´ä¸€ä¸ªç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contact.munin.command mail -s &quot;Munin notification&quot; test@163.com</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œå…¶ä¸­anotheruseræ˜¯æˆ‘ä»¬åœ¨ç›‘æ§çš„æ—¶å€™çš„ï¼Œè‡ªå·±å®šä¹‰çš„ä¸€ä¸ªç”¨æˆ·ï¼Œè¿™ä¸ªåé¢ä¼šä»‹ç»ã€‚</p><p>è¿™é‡Œçš„ <em>mail -s</em> æ˜¯è°ƒç”¨Linuxç»ˆç«¯çš„ mail å‘½ä»¤æ¥å‘é€é‚®ä»¶ï¼Œ å…·ä½“é…ç½®å¯å‚è§<a href="https://tyloafer.github.io/2017/12/03/mail/">ã€ŠLinuxä¸‹ä½¿ç”¨mailå‘é€é‚®ä»¶ã€‹</a>, å½“ç„¶è¿™é‡Œçš„å‘½ä»¤ä¹Ÿå¯ä»¥éšä¾¿å†™ï¼Œåªè¦èƒ½åœ¨ç»ˆç«¯æ‰§è¡Œå³å¯ï¼Œä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contact.munin.command /usr/sbin/php /home/test.php</span><br></pre></td></tr></table></figure><h1 id="ç”¨æˆ·é…ç½®"><a href="#ç”¨æˆ·é…ç½®" class="headerlink" title="ç”¨æˆ·é…ç½®"></a>ç”¨æˆ·é…ç½®</h1><p>æ¥ç€ä¸Šé¢åŸ‹ä¸‹çš„ä¸€ä¸ªç–‘é—®ï¼Œå°±æ˜¯commandå‰é¢çš„userï¼Œæˆ‘æ€ä¹ˆçŸ¥é“åº”è¯¥å†™å“ªä¸ªuserï¼Œå…ˆè´´ä¸€ä¸‹æˆ‘çš„ä¸€ä¸ªmemoryçš„é…ç½®ï¼Œè¿™ä¸ªé…ç½®æ—¶<em>plugin-conf.d/</em> ä¸‹é¢çš„<em>memory</em> çš„é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[memory]</span><br><span class="line">    user munin</span><br><span class="line">    env.swap_warning 80% </span><br><span class="line">    env.swap_critical 90% </span><br><span class="line">    env.active_warning 80% </span><br><span class="line">    env.cached_warning 80% </span><br><span class="line">    env.active_critical 90% </span><br><span class="line">    env.cached_critical 90% </span><br><span class="line">    env.apps_warning 80% </span><br><span class="line">    env.apps_critical 90% </span><br><span class="line">    env.cache_warning 80% </span><br><span class="line">    env.cache_critical 90%</span><br></pre></td></tr></table></figure><p>å…¶å®ï¼Œuseræ˜¯æˆ‘ä»¬é…ç½®çš„ç¬¬ä¸€è¡ŒæŒ‡å®šçš„ï¼Œè¿™ä¸ªmuninåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æœæ£€æµ‹memoryè¾¾åˆ°å‘Šè­¦å€¼çš„æ—¶å€™ï¼Œå°±å»æ‰¾è¿™ä¸ªé…ç½®çš„userï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„command</p><h1 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h1><p>Muninçš„ç›‘æ§æ’ä»¶æ˜¯ä½¿ç”¨perlå’Œpythonæ¥å†™çš„ï¼Œæ²¡äº‹å¯ä»¥å¤šçœ‹çœ‹æ’ä»¶æºç ï¼Œå¯ä»¥å¯¹ç›‘æ§çš„è®¾ç½®ä¼šæœ‰ä¸€ä¸ªæ›´åŠ æ¸…æ™°çš„è®¤çŸ¥ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å°è¯•è‡ªå·±ç”¨è„šæœ¬è¯­è¨€å†™ä¸€ä¸‹ï¼Œç»ƒç»ƒæ‰‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> munin </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxä¸‹mailå‘é€é‚®ä»¶8015é”™è¯¯</title>
      <link href="/posts/58415/"/>
      <url>/posts/58415/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>åœ¨ä¸Šä¸Šç¯‡æ–‡ç« <a href="https://tyloafer.github.io/2017/12/03/mail/">Linuxä¸‹ä½¿ç”¨mailå‘é€é‚®ä»¶</a>ä¸­ä»‹ç»äº†å¦‚ä½•åœ¨linuxä¸‹é€šè¿‡mailå‘é€é‚®ä»¶ï¼Œç„¶è€Œåœ¨åæ¥æˆ‘ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå´å‘ç°æŠ¥é”™äº†</p><blockquote><p>Error initializing NSS: Unknown error -8015.</p></blockquote><a id="more"></a><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p>å‡ºç°è¿™ä¸ªåŸå› ï¼Œä¸»è¦æ˜¯å› ä¸ºæˆ‘ç›‘æ§ç³»ç»Ÿéœ€è¦ç”¨åˆ°ï¼Œä½†ç›‘ç³»ç»Ÿçš„æ‰§è¡Œç”¨æˆ·å’Œå±ç»„è‚¯å®šä¸æ˜¯rootï¼Œä½†æ˜¯æˆ‘å®‰è£…åŠé…ç½®çš„æ—¶å€™æ˜¯ä½¿ç”¨rootï¼ŒåŒæ—¶ï¼Œæˆ‘åœ¨ä½¿ç”¨rootç”¨æˆ·å‘é€é‚®ä»¶çš„æ—¶å€™å´å¹¶æ²¡æœ‰è¿™ä¸ªé”™è¯¯ã€‚æ­¤ä¸Šï¼ŒåŸºæœ¬ç¡®å®šåº”è¯¥æ˜¯æ–‡ä»¶æƒé™çš„é—®é¢˜äº†ã€‚</p><p>æŸ¥çœ‹é…ç½®çš„æ—¶å€™ï¼Œå‘ç°ä½¿ç”¨smtpså‘é€çš„æ—¶å€™éœ€è¦é…ç½®è¯ä¹¦ï¼Œä¹Ÿå³ä¸‹é¢ä¸€æ®µ</p><blockquote><p>set nss-config-dir=/etc/mail/.certs    # SSLè¯ä¹¦ä¿å­˜ä½ç½®ï¼Œç¨åä¸ªäººåˆ¶ä½œ</p></blockquote><h1 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h1><p>èµ‹äºˆå…¶ä»–ç”¨æˆ· nss-config-dirä¸‹é¢æ–‡ä»¶çš„å†™çš„æƒé™å³å¯ï¼Œå¦‚æœæ„Ÿè§‰ä¸å®‰å…¨ï¼Œç»™äºˆå…¶ä»–ç”¨æˆ· ä½ ä½¿ç”¨çš„ è¯ä¹¦ å†™çš„æƒé™å³å¯</p><blockquote><p>chmod +r /etc/mail/.certs -R</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> mail </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPå¦‚ä½•è¯»å–å¤§æ–‡ä»¶</title>
      <link href="/posts/63198/"/>
      <url>/posts/63198/</url>
      
        <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>è¿™æ˜¯å¶ç„¶é—´çœ‹åˆ°çš„ä¸€ç¯‡æ–‡ç« ï¼Œæ„Ÿè§‰æ”¶è·é¢‡ä¸°ï¼Œæ•…è½¬è½½ã€‚è½¬è½½è‡ª<a href="https://www.luyuqiang.com/how-php-read-a-large-file" target="_blank" rel="noopener">èŠ¦é›¨å¼ºçš„ç½‘ç»œæ—¥å¿—</a></p><h1 id="å¹²è´§åˆ†å‰²çº¿"><a href="#å¹²è´§åˆ†å‰²çº¿" class="headerlink" title="å¹²è´§åˆ†å‰²çº¿"></a>å¹²è´§åˆ†å‰²çº¿</h1><p>ä½œä¸ºä¸€ä¸ªPHPå¼€å‘è€…ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å…³æ³¨å†…å­˜ç®¡ç†ã€‚PHPå¼•æ“åœ¨æˆ‘ä»¬è¿è¡Œè„šæœ¬ä¹‹ååšäº†å¾ˆå¥½çš„æ¸…ç†å·¥ä½œï¼ŒçŸ­å‘¨æœŸæ‰§è¡Œçš„webæœåŠ¡å™¨æ¨¡å‹æ„å‘³ç€å³ä½¿æ˜¯çƒ‚ä»£ç ä¹Ÿä¸ä¼šé•¿æ—¶é—´å½±å“ã€‚</p><a id="more"></a><p>æˆ‘ä»¬å¾ˆå°‘éœ€è¦èµ°å‡ºèˆ’é€‚çš„è¾¹ç•Œâ€“æ¯”å¦‚æˆ‘ä»¬å°è¯•åœ¨ä¸€ä¸ªå°çš„VPSä¸Šä¸ºåˆ›å»ºä¸€ä¸ªå¤§é¡¹ç›®è¿è¡ŒComposerï¼Œæˆ–è€…å½“æˆ‘ä»¬åœ¨å°æœåŠ¡å™¨ä¸Šè¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶ã€‚</p><p>è¿™æ˜¯åç»­å°†åœ¨æœ¬æ•™ç¨‹ä¸­å‘ˆç°çš„é—®é¢˜ã€‚</p><p>æ•™ç¨‹ä»£ç å¯ä»¥åœ¨<a href="https://github.com/sitepoint-editors/sitepoint-performant-reading-of-big-files-in-php" target="_blank" rel="noopener">github</a>æ‰¾åˆ°</p><h1 id="è¡¡é‡æˆåŠŸ"><a href="#è¡¡é‡æˆåŠŸ" class="headerlink" title="è¡¡é‡æˆåŠŸ"></a>è¡¡é‡æˆåŠŸ</h1><p>ç¡®å®šæˆ‘ä»¬å®Œå–„ä»£ç çš„å”¯ä¸€æ–¹å¼æ˜¯æŠŠçƒ‚ä»£ç å’Œä¿®æ­£è¿‡çš„ä»£ç è¿›è¡Œæ¯”è¾ƒã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬ä¸çŸ¥é“å®ƒæ˜¯å¦æ˜¯è§£å†³åŠæ³•ï¼Œé™¤éæˆ‘ä»¬çŸ¥é“å®ƒå¸®äº†å¤šå°‘ã€‚</p><p>æœ‰ä¸¤ä¸ªæˆ‘ä»¬éœ€è¦å…³å¿ƒçš„æŒ‡æ ‡ã€‚ç¬¬ä¸€ä¸ªæ˜¯CPUçš„ä½¿ç”¨ã€‚æˆ‘ä»¬æƒ³è¦è¿‡ç¨‹å¿«æˆ–è€…æ…¢ï¼Ÿç¬¬äºŒä¸ªæ˜¯å†…å­˜çš„ä½¿ç”¨ã€‚è„šæœ¬è¿è¡Œä½¿ç”¨äº†å¤šå°‘å†…å­˜ï¼Ÿè¿™äº›é€šå¸¸æ˜¯æˆåæ¯”çš„-æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨çœ‹CPUçš„ä½¿ç”¨æ—¶å€™ï¼Œä¸çœ‹å†…å­˜çš„ä½¿ç”¨ï¼Œåä¹‹äº¦ç„¶ã€‚</p><p>åœ¨ä¸€ä¸ªå¼‚æ­¥ç¨‹åºæ¨¡å‹ä¸­ï¼ˆæ¯”å¦‚å¤šè¿›ç¨‹æˆ–è€…å¤šçº¿ç¨‹çš„PHPåº”ç”¨ï¼‰ï¼ŒCPUå’Œå†…å­˜ä½¿ç”¨éƒ½éœ€è¦è°¨æ…è€ƒè™‘çš„ã€‚åœ¨ä¼ ç»ŸPHPæ¶æ„ä¸­ï¼Œå½“å®ƒä»¬ä¸­çš„å“ªä¸ªè¾¾åˆ°æœåŠ¡å™¨æé™çš„æ—¶å€™é€šå¸¸å°±ä¼šæœ‰é—®é¢˜ã€‚</p><p>åœ¨PHPä¸­æµ‹é‡CPUä½¿ç”¨ä¸åˆ‡å®é™…ã€‚å¦‚æœä½ å…³æ³¨ï¼Œå¯ä»¥è€ƒè™‘åœ¨Ubuntuæˆ–è€…MacOsä¸­ä½¿ç”¨topå‘½ä»¤ã€‚Windowså¯ä»¥è€ƒè™‘å®‰è£…ä¸€ä¸ªlinuxå­ç³»ç»Ÿï¼Œä½ å°±å¯ä»¥åœ¨Ubuntuä¸Šä½¿ç”¨topã€‚</p><p>è¿™ä¸ªæ•™ç¨‹çš„ç›®çš„æ˜¯æµ‹é‡å†…å­˜ä½¿ç”¨ã€‚æˆ‘ä»¬å°†çœ‹åˆ°ã€Œä¼ ç»Ÿã€è„šæœ¬ä¸­å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä¹‹åå°†ä¼šä¼˜åŒ–å¹¶ä¸”æµ‹é‡ï¼Œæœ€åæˆ‘å¸Œæœ›ä½ å¯ä»¥åšä¸€ä¸ªå­¦ä¹ åçš„é€‰æ‹©ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//php.netæ–‡æ¡£ä¸­æ ¼å¼åŒ–å­—èŠ‚çš„æ–¹æ³•</span><br><span class="line">memory_get_peak_usage();</span><br><span class="line"></span><br><span class="line">function formatBytes($bytes, $precision = 2) &#123;</span><br><span class="line">    $units = array(&apos;b&apos;, &apos;kb&apos;, &apos;mb&apos;, &apos;gb&apos;, &apos;tb&apos;);</span><br><span class="line"></span><br><span class="line">    $bytes = max($bytes, 0);</span><br><span class="line">    $pow = floor(($bytes ? log($bytes) : 0) / log(1024));</span><br><span class="line">    $pow = min($pow, count($units) - 1);</span><br><span class="line"></span><br><span class="line">    $bytes /= (1 &lt;&lt; (10 * $pow));</span><br><span class="line"></span><br><span class="line">    return round($bytes, $precision) . &apos; &apos; . $units[$pow];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ä¼šåœ¨è„šæœ¬çš„æœ€åä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œå› æ­¤å¯ä»¥åœ¨ç¬¬ä¸€æ—¶é—´çœ‹åˆ°å“ªä¸ªè„šæœ¬ä½¿ç”¨äº†æ›´å¤šçš„å†…å­˜ã€‚</p><h1 id="é€‰é¡¹"><a href="#é€‰é¡¹" class="headerlink" title="é€‰é¡¹"></a>é€‰é¡¹</h1><p>æˆ‘ä»¬å¯ä»¥é‡‡å–å¾ˆå¤šé«˜æ•ˆè¯»å–æ–‡ä»¶æ–¹æ³•ã€‚ä½†æ˜¯æœ‰ä¸¤ç§å¸¸ç”¨çš„åœºæ™¯ã€‚æˆ‘ä»¬å¯ä»¥å…ˆè¯»å–åå¤„ç†æ•°æ®ï¼Œç„¶åè¾“å‡ºå¤„ç†åçš„æ•°æ®æˆ–è€…æ‰§è¡Œå…¶ä»–æ“ä½œã€‚æˆ‘ä»¬å¯èƒ½ä¹Ÿæƒ³è¦è½¬æ¢ä¸€ä¸ªæ•°æ®æµè€Œä¸ç”¨è·å–æ•°æ®ã€‚</p><p>å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åæ¯ä¸€ä¸‡è¡Œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„é˜Ÿåˆ—è¿›ç¨‹ã€‚æˆ‘ä»¬éœ€è¦è‡³å°‘æŠŠä¸€ä¸‡è¡Œæ”¾åˆ°åœ¨å†…å­˜ä¸­ï¼Œç„¶åæŠŠä»–ä»¬å‘é€åˆ°é˜Ÿåˆ—ç®¡ç†å™¨ã€‚</p><p>å¯¹äºç¬¬äºŒç§æƒ…å†µï¼Œæˆ‘ä»¬å‹ç¼©ä¸€ä¸ªç‰¹åˆ«å¤§çš„APIå“åº”ã€‚æˆ‘ä»¬ä¸åœ¨ä¹å®ƒè¯´ä»€ä¹ˆï¼Œä½†æˆ‘ä»¬éœ€è¦ç¡®ä¿å®ƒæ˜¯ä»¥å‹ç¼©å½¢å¼å¤‡ä»½çš„ã€‚</p><p>ä¸¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦è¯»å–å¤§æ–‡ä»¶ï¼Œåªä¸è¿‡ä¸€ä¸ªå…³æ³¨æ•°æ®ä¸€ä¸ªä¸å…³æ³¨ã€‚è®©æˆ‘ä»¬æ¢ç´¢è¿™äº›é€‰é¡¹å§ã€‚ã€‚ã€‚</p><h1 id="ä¸€è¡Œä¸€è¡Œè¯»æ–‡ä»¶"><a href="#ä¸€è¡Œä¸€è¡Œè¯»æ–‡ä»¶" class="headerlink" title="ä¸€è¡Œä¸€è¡Œè¯»æ–‡ä»¶"></a>ä¸€è¡Œä¸€è¡Œè¯»æ–‡ä»¶</h1><p>æœ‰å¾ˆå¤šå¤„ç†æ–‡ä»¶çš„å‡½æ•°ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç®€å•æ˜äº†çš„æ–‡ä»¶è¯»å–ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// from memory.php</span><br><span class="line"></span><br><span class="line">function formatBytes($bytes, $precision = 2) &#123;</span><br><span class="line">    $units = array(&apos;b&apos;, &apos;kb&apos;, &apos;mb&apos;, &apos;gb&apos;, &apos;tb&apos;);</span><br><span class="line"></span><br><span class="line">    $bytes = max($bytes, 0);</span><br><span class="line">    $pow = floor(($bytes ? log($bytes) : 0) / log(1024));</span><br><span class="line">    $pow = min($pow, count($units) - 1);</span><br><span class="line"></span><br><span class="line">    $bytes /= (1 &lt;&lt; (10 * $pow));</span><br><span class="line"></span><br><span class="line">    return round($bytes, $precision) . &apos; &apos; . $units[$pow];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print formatBytes(memory_get_peak_usage());</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// from reading-files-line-by-line-1.php</span><br><span class="line"></span><br><span class="line">function readTheFile($path) &#123;</span><br><span class="line">    $lines = [];</span><br><span class="line">    $handle = fopen($path, &apos;r&apos;);</span><br><span class="line"></span><br><span class="line">    while(!feof($handle)) &#123;</span><br><span class="line">        $lines[] = trim(fgets($handle));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose($handle);</span><br><span class="line">    return $lines;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">readTheFile(&apos;shakespeare.txt&apos;);</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ­£åœ¨è¯»å–ä¸€ä¸ªåŒ…å«èå£«æ¯”äºšå…¨é›†çš„æ–‡æœ¬æ–‡ä»¶ã€‚æ–‡æœ¬æ–‡ä»¶å¤§çº¦5.5MBï¼Œæ¶ˆè€—äº†12.8MBçš„å†…å­˜ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ç”Ÿæˆå™¨æ¥è¯»å–æ¯ä¸€è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// from reading-files-line-by-line-2.php</span><br><span class="line"></span><br><span class="line">function readTheFile($path) &#123;</span><br><span class="line">    $handle = fopen($path, &apos;r&apos;);</span><br><span class="line"></span><br><span class="line">    while(!feof($handle)) &#123;</span><br><span class="line">        yield trim(fgets($handle));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose($handle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">readTheFile(&apos;shakespeare.txt&apos;);</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡æœ¬æ–‡ä»¶åŒæ ·å¤§å°ï¼Œä½†æ˜¯æ¶ˆè€—äº†393KBçš„å†…å­˜ã€‚è¿™ä¹Ÿè¯´æ˜ä¸äº†ä»€ä¹ˆï¼Œé™¤éæˆ‘ä»¬ä½¿ç”¨è¯»å–çš„æ•°æ®åšä¸€äº›äº‹ã€‚å‡è®¾æˆ‘ä»¬æŠŠæ–‡æ¡£ä»¥æ¯ä¸¤ä¸ªç©ºè¡Œåˆ†æˆå°ç‰‡æ®µã€‚å°±åƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// from reading-files-line-by-line-3.php</span><br><span class="line"></span><br><span class="line">$iterator = readTheFile(&apos;shakespeare.txt&apos;);</span><br><span class="line"></span><br><span class="line">$buffer = &apos;&apos;;</span><br><span class="line"></span><br><span class="line">foreach ($iterator as $iteration) &#123;</span><br><span class="line">    preg_match(&apos;/\n&#123;3&#125;/&apos;, $buffer, $matches);</span><br><span class="line"></span><br><span class="line">    if (count($matches)) &#123;</span><br><span class="line">        print &apos;.&apos;;</span><br><span class="line">        $buffer = &apos;&apos;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $buffer .= $iteration . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>çŒœä¸€ä¸‹æˆ‘ä»¬ç°åœ¨ç”¨äº†å¤šå°‘å†…å­˜ï¼Ÿå°½ç®¡æˆ‘ä»¬æŠŠæ–‡æ¡£åˆ†å‰²æˆäº†1216ä¸ªç‰‡æ®µï¼Œæˆ‘ä»¬å´åªç”¨äº†458KBçš„å†…å­˜ï¼Œæ„å¤–å—ï¼Ÿé‰´äºç”Ÿæˆå™¨çš„æ€§è´¨ï¼Œæˆ‘ä»¬å†…å­˜æ¶ˆè€—æœ€å¤§çš„æ˜¯éœ€è¦åœ¨å¾ªç¯ä¸­å­˜å‚¨æœ€å¤§æ–‡æœ¬å—çš„å†…å­˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¤§çš„å—æ˜¯101,985ä¸ªå­—ç¬¦ã€‚</p><p>æˆ‘å·²ç»å†™äº†<a href="https://www.sitepoint.com/memory-performance-boosts-with-generators-and-nikiciter/" target="_blank" rel="noopener">ä½¿ç”¨ç”Ÿæˆå™¨çš„æ€§èƒ½æå‡</a>å’Œ<a href="https://github.com/nikic/iter" target="_blank" rel="noopener">Nikita Popovçš„ç”Ÿæˆå™¨åº“</a>ï¼Œæ‰€ä»¥ä½ æƒ³è¦äº†è§£æ›´å¤šå°±å»çœ‹å§ã€‚</p><p>ç”Ÿæˆå™¨ä¹Ÿæœ‰å…¶ä»–ç”¨æ³•ï¼Œä½†å¯¹è¯»å–å¤§æ–‡ä»¶æœ‰å¾ˆæ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦å»å¤„ç†æ•°æ®ï¼Œç”Ÿæˆå™¨ä¹Ÿæ˜¯æœ€å¥½çš„æ–¹å¼ã€‚</p><h1 id="æ–‡ä»¶é—´çš„ç®¡é“è¾“é€"><a href="#æ–‡ä»¶é—´çš„ç®¡é“è¾“é€" class="headerlink" title="æ–‡ä»¶é—´çš„ç®¡é“è¾“é€"></a>æ–‡ä»¶é—´çš„ç®¡é“è¾“é€</h1><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¤„ç†æ•°æ®ï¼Œè€Œæ˜¯æŠŠä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®ä¼ é€’åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ã€‚è¿™é€šå¸¸è¢«å«åšç®¡é“è¾“é€ï¼ˆå¤§æ¦‚å› ä¸ºæˆ‘ä»¬åªçœ‹åˆ°äº†ä¸¤å¤´ï¼Œæ²¡çœ‹åˆ°ç®¡é“å†…ã€‚ã€‚ã€‚å½“ç„¶å®ƒä¸æ˜¯é€æ˜çš„ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨æµæ–¹æ³•è·å–å®ƒä»¬ã€‚å†™äº†ä¸ªä»ä¸€ä¸ªæ–‡ä»¶ä¼ é€’åˆ°å¦ä¸€ä¸ªçš„è„šæœ¬ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¯ä»¥æµ‹é‡å†…å­˜ä½¿ç”¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// from piping-files-1.php</span><br><span class="line"></span><br><span class="line">file_put_contents(</span><br><span class="line">    &apos;piping-files-1.txt&apos;, file_get_contents(&apos;shakespeare.txt&apos;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>ä¸å‡ºæ„å¤–åœ°ï¼Œè¿™ä¸ªè„šæœ¬ä½¿ç”¨æ¯”æ–‡ä»¶çš„æ‹·è´æ›´å¤šçš„å†…å­˜ã€‚è¿™æ˜¯å› ä¸ºå®ƒä¸å¾—ä¸è¯»å–ã€æŠŠæ–‡æœ¬å†…å®¹æ”¾åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†™å…¥åˆ°ä¸€ä¸ªæ–°æ–‡ä»¶ã€‚å¯¹äºå°æ–‡ä»¶è¿˜å¥½ã€‚ä½†æ˜¯å½“æˆ‘ä»¬å¤„ç†ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå°±ä¸å¦™äº†ã€‚ã€‚ã€‚</p><p>è®©æˆ‘ä»¬ä½¿ç”¨æµçš„æ–¹å¼ä»ä¸€ä¸ªæ–‡ä»¶ä¼ é€’åˆ°å¦ä¸€ä¸ªï¼ˆæˆ–è€…å«ç®¡é“è¾“é€ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// from piping-files-2.php</span><br><span class="line"></span><br><span class="line">$handle1 = fopen(&apos;shakespeare.txt&apos;, &apos;r&apos;);</span><br><span class="line">$handle2 = fopen(&apos;piping-files-2.txt&apos;, &apos;w&apos;);</span><br><span class="line"></span><br><span class="line">stream_copy_to_stream($handle1, $handle2);</span><br><span class="line"></span><br><span class="line">fclose($handle1);</span><br><span class="line">fclose($handle2);</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¾ˆå¥‡æ€ªã€‚æˆ‘ä»¬æ‰“å¼€ä¸¤ä¸ªæ–‡ä»¶çš„å¥æŸ„ï¼Œç¬¬ä¸€ä¸ªä½¿ç”¨è¯»æ¨¡å¼ï¼Œç¬¬äºŒä½¿ç”¨å†™æ¨¡å¼ã€‚ç„¶åæˆ‘ä»¬ä»ç¬¬ä¸€ä¸ªå¤åˆ¶åˆ°ç¬¬äºŒä¸ªã€‚ç„¶åå…³é—­ä¸¤ä¸ªæ–‡ä»¶çš„å¥æŸ„ã€‚æ˜¯ä¸æ˜¯æƒŠå–œåˆ°ä½ äº†ï¼Œå†…å­˜åªä½¿ç”¨äº†393KBã€‚</p><p>è¿™çœ‹èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ã€‚ä¸å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ç”Ÿæˆå™¨çš„ä»£ç ä¸€è¡Œä¸€è¡Œè¯»å–ç„¶åå­˜å‚¨å—ï¼Ÿè¿™æ˜¯å› ä¸ºç¬¬äºŒä¸ªå˜é‡ä½¿ç”¨fgetsæŒ‡å®šæ¯è¡Œè¯»å–å¤šå°‘å­—èŠ‚ï¼ˆé»˜è®¤-1æˆ–è€…ç›´åˆ°ä¸€ä¸ªæ–°è¡Œï¼‰</p><p>stream_copy_to_streamçš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å®Œå…¨ç›¸åŒçš„å‚æ•°ï¼ˆå…·æœ‰å®Œå…¨ç›¸åŒçš„é»˜è®¤å€¼ï¼‰ã€‚stream_copy_to_streamæ­£åœ¨è¯»å–ä¸€ä¸ªæµï¼Œä¸€æ¬¡ä¸€è¡Œï¼Œå¹¶å°†å…¶å†™å…¥å¦ä¸€ä¸ªæµã€‚ å®ƒè·³è¿‡äº†ç”Ÿæˆå™¨äº§ç”Ÿå€¼çš„éƒ¨åˆ†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨è¯¥å€¼ã€‚</p><p>ç®¡é“è¾“é€è¿™äº›æ–‡æœ¬å¯¹æˆ‘ä»¬æ¥è¯´æ²¡ç”¨ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»”ç»†æ€è€ƒä¸€ä¸‹å…¶ä»–å¯èƒ½çš„ä¾‹å­ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦ä»CDNè¾“å‡ºä¸€ä¸ªå›¾åƒï¼Œé‡å®šå‘åº”ç”¨çš„è·¯ç”±ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// from piping-files-3.php</span><br><span class="line"></span><br><span class="line">file_put_contents(</span><br><span class="line">    &apos;piping-files-3.jpeg&apos;, file_get_contents(</span><br><span class="line">        &apos;https://github.com/assertchris/uploads/raw/master/rick.jpg&apos;</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// ...or write this straight to stdout, if we don&apos;t need the memory info</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸Šä»£ç è§£å†³ä¸€ä¸ªåº”ç”¨çš„è·¯ç”±é—®é¢˜ã€‚ä½†æˆ‘ä»¬æƒ³ä»CDNè·å–è€Œä¸æ˜¯æŠŠæ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æˆ‘ä»¬å¯èƒ½ä½¿ç”¨æ›´ä¼˜é›…çš„ï¼ˆåƒ<a href="http://docs.guzzlephp.org/en/stable/" target="_blank" rel="noopener">Guzzle</a>ï¼‰æ›¿ä»£file_get_contentsï¼Œä½†æ˜¯æ•ˆæœä¸€æ ·ã€‚</p><p>å›¾ç‰‡çš„å†…å­˜ä½¿ç”¨å¤§çº¦581KBã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è¯•ç€ä½¿ç”¨æµæ›¿ä»£ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// from piping-files-4.php</span><br><span class="line"></span><br><span class="line">$handle1 = fopen(</span><br><span class="line">    &apos;https://github.com/assertchris/uploads/raw/master/rick.jpg&apos;, &apos;r&apos;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$handle2 = fopen(</span><br><span class="line">    &apos;piping-files-4.jpeg&apos;, &apos;w&apos;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// ...or write this straight to stdout, if we don&apos;t need the memory info</span><br><span class="line"></span><br><span class="line">stream_copy_to_stream($handle1, $handle2);</span><br><span class="line"></span><br><span class="line">fclose($handle1);</span><br><span class="line">fclose($handle2);</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>å†…å­˜ä½¿ç”¨ä¼šç•¥å°‘ï¼ˆ400KBï¼‰ï¼Œä½†æ˜¯ç»“æœå´ä¸€æ ·ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦æ›´å¤šçš„å†…å­˜ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å°åˆ°standard outputã€‚äº‹å®ä¸Šï¼ŒPHPä¸ºå®ç°è¿™ä¸ªæä¾›äº†ç®€å•çš„æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$handle1 = fopen(</span><br><span class="line">    &apos;https://github.com/assertchris/uploads/raw/master/rick.jpg&apos;, &apos;r&apos;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$handle2 = fopen(</span><br><span class="line">    &apos;php://stdout&apos;, &apos;w&apos;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">stream_copy_to_stream($handle1, $handle2);</span><br><span class="line"></span><br><span class="line">fclose($handle1);</span><br><span class="line">fclose($handle2);</span><br><span class="line"></span><br><span class="line">// require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><h1 id="å…¶ä»–æµ"><a href="#å…¶ä»–æµ" class="headerlink" title="å…¶ä»–æµ"></a>å…¶ä»–æµ</h1><p>æœ‰ä¸€äº›å…¶ä»–æµæˆ‘ä»¬å¯ä»¥ç®¡é“ä¼ é€’ã€è¯»ã€æˆ–è€…å†™ï¼š</p><ul><li>php://stdin (åªè¯»)</li><li>php://stderr (åªå†™, åƒ php://stdout)</li><li>php://input (åªè¯») è·å–åŸè¯·æ±‚ä½“</li><li>php://output (åªå†™) å¯ä»¥å†™åˆ°ç¼“å†²åŒº</li><li>php://memory å’Œ php://temp (è¯»å†™)å­˜å‚¨ä¸´æ—¶æ•°æ®çš„åœ°æ–¹ã€‚php://tempä¸åŒçš„æ˜¯ä»¥æ–‡ä»¶å­˜å‚¨ï¼Œphp://memoryå­˜å‚¨åœ¨å†…å­˜</li></ul><h1 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h1><p>è¿˜æœ‰ä¸€ä¸ªä½¿ç”¨æµçš„æŠ€å·§å«è¿‡æ»¤å™¨ã€‚å®ƒä»¬æ˜¯ä¸­é—´æ­¥éª¤ï¼Œæä¾›ç®¡ç†æµè€Œä¸æš´éœ²ç»™æˆ‘ä»¬çš„åŠŸèƒ½ã€‚è®¾æƒ³ä¸€ä¸‹æˆ‘ä»¬æƒ³è¦å‹ç¼©èå£«æ¯”äºš.txtã€‚å¯èƒ½ä¼šä½¿ç”¨Zipæ‰©å±•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// from filters-1.php</span><br><span class="line"></span><br><span class="line">$zip = new ZipArchive();</span><br><span class="line">$filename = &apos;filters-1.zip&apos;;</span><br><span class="line"></span><br><span class="line">$zip-&gt;open($filename, ZipArchive::CREATE);</span><br><span class="line">$zip-&gt;addFromString(&apos;shakespeare.txt&apos;, file_get_contents(&apos;shakespeare.txt&apos;));</span><br><span class="line">$zip-&gt;close();</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>æ•´æ´çš„ä»£ç ï¼Œä½†æ˜¯å´æ¶ˆè€—äº†10.75MBã€‚æˆ‘ä»¬ä½¿ç”¨è¿‡æ»¤å™¨æ”¹è¿›ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// from filters-2.php</span><br><span class="line"></span><br><span class="line">$handle1 = fopen(</span><br><span class="line">    &apos;php://filter/zlib.deflate/resource=shakespeare.txt&apos;, &apos;r&apos;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$handle2 = fopen(</span><br><span class="line">    &apos;filters-2.deflated&apos;, &apos;w&apos;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">stream_copy_to_stream($handle1, $handle2);</span><br><span class="line"></span><br><span class="line">fclose($handle1);</span><br><span class="line">fclose($handle2);</span><br><span class="line"></span><br><span class="line">require &apos;memory.php&apos;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨php://filter/zlib.defalteçš„è¿‡æ»¤å™¨æ¥å‹ç¼©èµ„æºã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªå‹ç¼©åçš„æ•°æ®ç®¡é“ä¼ é€’åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ã€‚å†…å­˜æ¶ˆè€—896KBã€‚</p><p>æˆ‘çŸ¥é“è¿™ä¸æ˜¯åŒä¸€ä¸ªæ ¼å¼ï¼Œæˆ–è€…ä½¿ç”¨zipå‹ç¼©æ›´å¥½ã€‚ä½†æ˜¯ä½ ä¸å¾—ä¸æ€€ç–‘ï¼šå¦‚æœä½ é€‰æ‹©ä¸åŒçš„æ ¼å¼å¯ä»¥èŠ‚çœæ‰12å€çš„å†…å­˜ï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢ï¼Ÿ</p><p>å¯ä»¥é€šè¿‡å¦ä¸€ä¸ªzlibçš„è§£å‹ç¼©è¿‡æ»¤å™¨è§£å‹æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// from filters-2.php</span><br><span class="line"></span><br><span class="line">file_get_contents(</span><br><span class="line">    &apos;php://filter/zlib.inflate/resource=filters-2.deflated&apos;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æµå·²ç»åœ¨<a href="https://www.sitepoint.com/%EF%BB%BFunderstanding-streams-in-php/" target="_blank" rel="noopener">ç†è§£PHPä¸­çš„æµ</a> å’Œ <a href="https://www.sitepoint.com/using-php-streams-effectively/" target="_blank" rel="noopener">PHPæµä¸æ•ˆç‡</a>ä¸­å¤§é‡æåŠã€‚å¦‚æœä½ æƒ³è¦äº†è§£æ›´å¤šï¼Œç‚¹å¼€çœ‹çœ‹ã€‚</p><h1 id="è‡ªå®šä¹‰æµ"><a href="#è‡ªå®šä¹‰æµ" class="headerlink" title="è‡ªå®šä¹‰æµ"></a>è‡ªå®šä¹‰æµ</h1><p>fopenå’Œfile_get_contentsæœ‰ä»–ä»¬è‡ªå·±çš„é»˜è®¤è®¾ç½®ï¼Œä½†æ˜¯å¯ä»¥å®Œå…¨çš„è‡ªå®šä¹‰ã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œè‡ªå·±åˆ›å»ºä¸€ä¸ªæ–°çš„æµï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// from creating-contexts-1.php</span><br><span class="line"></span><br><span class="line">$data = join(&apos;&amp;&apos;, [</span><br><span class="line">    &apos;twitter=assertchris&apos;,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">$headers = join(&apos;\r\n&apos;, [</span><br><span class="line">    &apos;Content-type: application/x-www-form-urlencoded&apos;,</span><br><span class="line">    &apos;Content-length: &apos; . strlen($data),</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">$options = [</span><br><span class="line">    &apos;http&apos; =&gt; [</span><br><span class="line">        &apos;method&apos; =&gt; &apos;POST&apos;,</span><br><span class="line">        &apos;header&apos;=&gt; $headers,</span><br><span class="line">        &apos;content&apos; =&gt; $data,</span><br><span class="line">    ],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$context = stream_content_create($options);</span><br><span class="line"></span><br><span class="line">$handle = fopen(&apos;https://example.com/register&apos;, &apos;r&apos;, false, $context);</span><br><span class="line">$response = stream_get_contents($handle);</span><br><span class="line"></span><br><span class="line">fclose($handle);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°è¯•å‘APIå‘å‡ºPOSTè¯·æ±‚ã€‚APIç«¯æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ä»éœ€è¦ä½¿ç”¨httpä¸Šä¸‹æ–‡å±æ€§ï¼ˆç”¨äºhttpå’Œhttpï¼‰ã€‚æˆ‘ä»¬è®¾ç½®ä¸€äº›å¤´å¹¶ä¸”æ‰“å¼€APIæ–‡ä»¶å¥æŸ„ã€‚è€ƒè™‘åˆ°å®‰å…¨ï¼Œæˆ‘ä»¬ä»¥åªè¯»æ–¹å¼æ‰“å¼€ã€‚</p><p>å¯ä»¥è‡ªå®šä¹‰å¾ˆå¤šä¸œè¥¿ï¼Œæ‰€ä»¥å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œæœ€å¥½æŸ¥çœ‹<a href="https://php.net/function.stream-context-create" target="_blank" rel="noopener">æ–‡æ¡£</a>ã€‚</p><h1 id="è‡ªå®šä¹‰åè®®çš„è¿‡æ»¤å™¨"><a href="#è‡ªå®šä¹‰åè®®çš„è¿‡æ»¤å™¨" class="headerlink" title="è‡ªå®šä¹‰åè®®çš„è¿‡æ»¤å™¨"></a>è‡ªå®šä¹‰åè®®çš„è¿‡æ»¤å™¨</h1><p>åœ¨æœ¬æ–‡ç»“æŸä¹‹å‰ï¼Œæ¥è°ˆè°ˆè‡ªå®šä¹‰åè®®ã€‚ å¦‚æœä½ çœ‹<a href="https://php.net/manual/en/class.streamwrapper.php" target="_blank" rel="noopener">æ–‡æ¡£</a>ï¼Œä½ å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ç±»æ¥å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Protocol &#123;</span><br><span class="line">    public resource $context;</span><br><span class="line">    public construct ( void )</span><br><span class="line">    public destruct ( void )</span><br><span class="line">    public bool dir_closedir ( void )</span><br><span class="line">    public bool dir_opendir ( string $path , int $options )</span><br><span class="line">    public string dir_readdir ( void )</span><br><span class="line">    public bool dir_rewinddir ( void )</span><br><span class="line">    public bool mkdir ( string $path , int $mode , int $options )</span><br><span class="line">    public bool rename ( string $path_from , string $path_to )</span><br><span class="line">    public bool rmdir ( string $path , int $options )</span><br><span class="line">    public resource stream_cast ( int $cast_as )</span><br><span class="line">    public void stream_close ( void )</span><br><span class="line">    public bool stream_eof ( void )</span><br><span class="line">    public bool stream_flush ( void )</span><br><span class="line">    public bool stream_lock ( int $operation )</span><br><span class="line">    public bool stream_metadata ( string $path , int $option , mixed $value )</span><br><span class="line">    public bool stream_open ( string $path , string $mode , int $options ,</span><br><span class="line">        string &amp;$opened_path )</span><br><span class="line">    public string stream_read ( int $count )</span><br><span class="line">    public bool stream_seek ( int $offset , int $whence = SEEK_SET )</span><br><span class="line">    public bool stream_set_option ( int $option , int $arg1 , int $arg2 )</span><br><span class="line">    public array stream_stat ( void )</span><br><span class="line">    public int stream_tell ( void )</span><br><span class="line">    public bool stream_truncate ( int $new_size )</span><br><span class="line">    public int stream_write ( string $data )</span><br><span class="line">    public bool unlink ( string $path )</span><br><span class="line">    public array url_stat ( string $path , int $flags )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸æ‰“ç®—å®ç°åœ¨æ•™ç¨‹ä¸­ï¼Œå› ä¸ºæˆ‘è®¤ä¸ºè¿™æ˜¯å€¼å¾—çš„è‡ªå·±å®Œæˆè¿‡ç¨‹ã€‚éœ€è¦åšå¾ˆå¤šå·¥ä½œï¼Œä½†æ˜¯ä¸€æ—¦è¿™ä¸ªå·¥ä½œå®Œæˆï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ³¨å†Œçš„æµåŒ…è£…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (in_array(&apos;highlight-names&apos;, stream_get_wrappers())) &#123;</span><br><span class="line">    stream_wrapper_unregister(&apos;highlight-names&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream_wrapper_register(&apos;highlight-names&apos;, &apos;HighlightNamesProtocol&apos;);</span><br><span class="line"></span><br><span class="line">$highlighted = file_get_contents(&apos;highlight-names://story.txt&apos;);</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼åœ°ï¼Œå¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æµè¿‡æ»¤å™¨ã€‚æ–‡æ¡£æœ‰ä¸€ä¸ªè¿‡æ»¤å™¨ç±»çš„ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Filter &#123;</span><br><span class="line">    public $filtername;</span><br><span class="line">    public $params</span><br><span class="line">    public int filter ( resource $in , resource $out , int &amp;$consumed ,</span><br><span class="line">        bool $closing )</span><br><span class="line">    public void onClose ( void )</span><br><span class="line">    public bool onCreate ( void )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆå®¹æ˜“æ³¨å†Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$handle = fopen(&apos;story.txt&apos;, &apos;w+&apos;);</span><br><span class="line">stream_filter_append($handle, &apos;highlight-names&apos;, STREAM_FILTER_READ);</span><br></pre></td></tr></table></figure><p>é«˜äº®åå­—è¿‡æ»¤å™¨éœ€è¦å»åŒ¹é…æ–°çš„è¿‡æ»¤å™¨ç±»çš„è¿‡æ»¤å™¨åå±æ€§ã€‚ä¹Ÿå¯ä»¥åœ¨phpï¼š//filter/highligh-names/resource=story.txtå­—ç¬¦ä¸²ä¸­ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨ã€‚å®šä¹‰è¿‡æ»¤å™¨æ¯”å®šä¹‰åè®®è¦å®¹æ˜“å¾—å¤šã€‚ å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯åè®®éœ€è¦å¤„ç†ç›®å½•æ“ä½œï¼Œè€Œè¿‡æ»¤å™¨åªéœ€å¤„ç†æ¯ä¸ªæ•°æ®å—ã€‚</p><p>å¦‚æœä½ æœ‰å¼ºçƒˆçš„è¿›å–å¿ƒï¼Œé¼“åŠ±ä½ ç¼–å†™åè®®çš„è¿‡æ»¤å™¨ã€‚å¦‚æœä½ å¯ä»¥å°†è¿‡æ»¤å™¨åº”ç”¨äºstream_copy_to_streamæ“ä½œï¼Œé‚£ä¹ˆå³ä½¿å¤„ç†å¤§å®¹é‡çš„å¤§æ–‡ä»¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºå†…å­˜ä¹Ÿä¸ä¼šè¶…é˜ˆå€¼ã€‚ è¯•ç€ç¼–å†™ä¸€ä¸ªè°ƒæ•´å›¾åƒå¤§å°çš„è¿‡æ»¤å™¨æˆ–åŠ å¯†åº”ç”¨ç¨‹åºçš„è¿‡æ»¤å™¨ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å°½ç®¡è¿™ä¸æ˜¯æˆ‘ä»¬ç»å¸¸å¤„ç†çš„é—®é¢˜ï¼Œåœ¨è¯»å–å¤§æ–‡ä»¶æ—¶ä¹Ÿå¾ˆå®¹æ˜“é™·å…¥å›°å¢ƒã€‚åœ¨å¼‚æ­¥åº”ç”¨ä¸­ï¼Œå½“æˆ‘ä»¬ä¸æ³¨æ„å†…å­˜ä½¿ç”¨æ—¶ï¼Œå¾ˆå®¹æ˜“å°±æŠŠæ•´ä¸ªæœåŠ¡ææŒ‚ã€‚</p><p>è¿™ä¸ªæ•™ç¨‹å¸Œæœ›ç»™ä½ è®²è§£ä¸€äº›æ–°æƒ³æ³•ï¼ˆæˆ–è€…å”¤é†’ä½ çš„è®°å¿†ï¼‰ï¼Œä»¥ä¾¿ä½ èƒ½åœ¨è¯»ã€å†™å¤§æ–‡ä»¶æ—¶æƒ³å¾—æ›´å¤šã€‚å½“å¼€å§‹ç†Ÿç»ƒæŒæ¡æµå’Œç”Ÿæˆå™¨åï¼Œåœæ­¢ä½¿ç”¨åƒfile_get_contentså‡½æ•°ï¼šä¸€äº›è«åå…¶å¦™é—®é¢˜å°±åœ¨ç¨‹åºä¸­æ¶ˆå¤±äº†ã€‚è¿™å°±æ˜¯æ„ä¹‰æ‰€åœ¨ï¼</p><h1 id="å£°æ˜"><a href="#å£°æ˜" class="headerlink" title="å£°æ˜"></a>å£°æ˜</h1><p>æœ¬æ–‡è½¬è½½è‡ª<a href="https://www.luyuqiang.com/how-php-read-a-large-file" target="_blank" rel="noopener">èŠ¦é›¨å¼ºçš„ç½‘ç»œæ—¥å¿—</a></p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> ä¼˜åŒ– </tag>
            
            <tag> å¤§æ–‡ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>file_get_contentsä½¿ç”¨SSLè¿æ¥æŠ¥é”™</title>
      <link href="/posts/55399/"/>
      <url>/posts/55399/</url>
      
        <content type="html"><![CDATA[<h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p>åœ¨ä½¿ç”¨file_get_contentsçš„æ—¶å€™ï¼Œæœ‰æ—¶å€™è·å–å—ä¿¡ä»»çš„httpsçš„å†…å®¹æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯é‡åˆ°ä¸€äº›ä¸å—ä¿¡ä»»çš„httpsè¿æ¥ï¼Œå°±ä¼šæŠ¥é”™ï¼Œä¸»è¦åŸå› è¿˜æ˜¯ä¸å—ä¿¡ä»»çš„httpså¤§éƒ¨åˆ†æ˜¯è‡ªåˆ¶è¯ä¹¦æˆ–è€…å·²è¿‡æœŸç­‰ç­‰ï¼Œæ£€æµ‹è¯ä¹¦çš„æ—¶å€™æ²¡é€šè¿‡ã€‚</p><p>æ—¢ç„¶çŸ¥é“äº†åŸå› ï¼Œé‚£ä¸è®©ä»–éªŒè¯sslä¸å°±å¯ä»¥äº†ã€‚</p><a id="more"></a><h1 id="å¤„ç†"><a href="#å¤„ç†" class="headerlink" title="å¤„ç†"></a>å¤„ç†</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string file_get_contents ( string $filename [, bool $use_include_path = false [, resource $context [, int $offset = -1 [, int $maxlen ]]]] )</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ˜¯<em>file_get_contents()</em> å‡½æ•°çš„æ–‡æ¡£ï¼Œç¬¬ä¸‰å‚æ•°å¯ä»¥è®¾ç½®ä¸€äº›å¤´ä¿¡æ¯ç­‰ï¼Œå°±å¦‚åŒä½¿ç”¨curlä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨å¤´éƒ¨æ·»åŠ ä¸€ä¸‹ä¿¡æ¯å°±å¯ä»¥ä¸éªŒè¯ssläº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;ssl&quot;=&gt;array(</span><br><span class="line">  &quot;verify_peer&quot;=&gt;false,</span><br><span class="line">  &quot;verify_peer_name&quot;=&gt;false,</span><br><span class="line">),</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä½¿ç”¨ç”¨ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$opts = [</span><br><span class="line">    &quot;ssl&quot; =&gt; [</span><br><span class="line">        &quot;verify_peer&quot;=&gt;false,</span><br><span class="line">        &quot;verify_peer_name&quot;=&gt;false,</span><br><span class="line">    ],</span><br><span class="line">];</span><br><span class="line">$context = stream_context_create($opts);</span><br><span class="line">$response = file_get_contents(&quot;https://tyloafer.github.io/2018/12/03/mail/&quot;, false, $context);</span><br></pre></td></tr></table></figure><h1 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h1><p>å®˜æ–¹å®ä¾‹ä¸­æœ‰å¦‚ä¸‹ç”¨æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// Create a stream</span><br><span class="line">$opts = array(</span><br><span class="line">  &apos;http&apos;=&gt;array(</span><br><span class="line">    &apos;method&apos;=&gt;&quot;GET&quot;,</span><br><span class="line">    &apos;header&apos;=&gt;&quot;Accept-language: en\r\n&quot; .</span><br><span class="line">              &quot;Cookie: foo=bar\r\n&quot;</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$context = stream_context_create($opts);</span><br><span class="line"></span><br><span class="line">// Open the file using the HTTP headers set above</span><br><span class="line">$file = file_get_contents(&apos;http://www.example.com/&apos;, false, $context);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ å…¶å®æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­è¿™æ˜¯headerã€cookieã€paramsç­‰ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥è·Ÿcurlä¸€æ ·æ¨¡æ‹Ÿpostå’Œgetè¯·æ±‚äº†ã€‚ç”¨ä¾‹å°±ä¸è¯¦è¿°äº†ï¼Œå„ä½çŒ¿ä»¬è‡ªè¡Œæ¢ç´¢å§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Muninå®‰è£…åŠç›‘æ§</title>
      <link href="/posts/62852/"/>
      <url>/posts/62852/</url>
      
        <content type="html"><![CDATA[<h1 id="å®‰è£…munin"><a href="#å®‰è£…munin" class="headerlink" title="å®‰è£…munin"></a>å®‰è£…munin</h1><ol><li><p>é€šè¿‡yumå®‰è£…munin munin-node httpd</p><pre><code>yum -y install munin munin-node httpd</code></pre><a id="more"></a></li><li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/munin/munin.conf </p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dbdir /data/www/html/munin/databases // æ•°æ®åº“å­˜æ”¾åœ°å€ </span><br><span class="line">htmldir /data/www/html/munin/html //é¡µé¢å­˜æ”¾åœ°å€</span><br><span class="line">logdir /data/www/html/munin/log // æ—¥å¿—å­˜æ”¾åœ°å€ </span><br><span class="line">rundir /var/run/munin // è¿è¡Œæ—¶pidå­˜æ”¾åœ°å€ </span><br><span class="line"></span><br><span class="line"># Where to look for the HTML templates </span><br><span class="line"># </span><br><span class="line">tmpldir /etc/munin/templates </span><br><span class="line"></span><br><span class="line"># a simple host tree </span><br><span class="line">[localhost] </span><br><span class="line">    address 127.0.0.1 </span><br><span class="line">    use_node_name yes</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºå­˜æ”¾åœ°å€å¹¶ä¿®æ”¹æƒé™<br>â€‹      </p><pre><code>mkdir /data/www/html/munin/databases /data/www/html/munin/html /data/www/html/munin/logchown munin:munin /data/www/html/munin -R</code></pre></li></ol><ol start="3"><li><p>å¯åŠ¨munin-node<br>â€‹      </p><pre><code>service munin-node start</code></pre><p>æŸ¥çœ‹é…ç½®ä¸­htmldirçš„è·¯å¾„ä¸‹æ˜¯å¦ç”Ÿæˆäº†HTMLç­‰é™æ€æ–‡ä»¶ï¼Œå¦‚æ²¡æœ‰ï¼Œè¯·æ‰§è¡Œä¸‹é¢å‘½ä»¤   </p><pre><code>su munin --shell=/bin/bashmunin-cron</code></pre></li><li><p>è®¿é—®é™æ€é¡µé¢çš„å­˜æ”¾åœ°å€å³å¯æŸ¥çœ‹,æ­¤å¤„æ²¡æœ‰å•ç‹¬é…ç½®åŸŸåï¼Œæ‰€ä»¥ç›´æ¥è®¿é—®http://åŸŸå/munin/html/å³å¯</p></li></ol><h1 id="åˆ©ç”¨cgiåŠ¨æ€ç»˜åˆ¶å›¾å½¢"><a href="#åˆ©ç”¨cgiåŠ¨æ€ç»˜åˆ¶å›¾å½¢" class="headerlink" title="åˆ©ç”¨cgiåŠ¨æ€ç»˜åˆ¶å›¾å½¢"></a>åˆ©ç”¨cgiåŠ¨æ€ç»˜åˆ¶å›¾å½¢</h1><pre><code>yum -y install  spawn-fcgi # å®‰è£…ç»˜å›¾çš„cgispawn-fcgi -s /var/run/munin/fastcgi-graph.sock    -u munin -g munin /var/www/cgi-bin/munin-cgi-graph # å¯åŠ¨è¿›ç¨‹ï¼Œè¿™é‡Œçš„sockçš„è·¯å¾„å¯è‡ªå®šä¹‰ï¼ŒåæœŸéœ€è¦åœ¨nginxä¸­è¿›è¡Œé…ç½®</code></pre><p>ç»¼ä¸Šå°†fcgiå®‰è£…å¯åŠ¨å®Œæˆï¼Œä¸‹é¢å°†fcgiæ•´åˆåˆ°nginxä¸­è¿›è¡ŒåŠ¨æ€çš„ç»˜åˆ¶å›¾ç‰‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /munin-cgi/munin-cgi-graph/ &#123;</span><br><span class="line">    root /data/www/html</span><br><span class="line">    fastcgi_split_path_info ^(/munin-cgi/munin-cgi-graph)(.*);</span><br><span class="line">    fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">    fastcgi_pass unix:/var/run/munin/fastcgi-graph.sock;</span><br><span class="line">    include fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç›‘æ§nginx"><a href="#ç›‘æ§nginx" class="headerlink" title="ç›‘æ§nginx"></a>ç›‘æ§nginx</h1><p>ç›‘æ§nginxå…¶å®æ˜¯åˆ©ç”¨äº†nginxçš„<em>http_stub_status_module</em>mæ¨¡å—æ¥è·å–nginxçš„è¯·æ±‚å’ŒçŠ¶æ€ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">my $URL = exists $ENV&#123;&apos;url&apos;&#125; ? $ENV&#123;&apos;url&apos;&#125; : &quot;http://localhost/nginx_status&quot;;                   </span><br><span class="line">my $port = exists $ENV&#123;&apos;port&apos;&#125; ? $ENV&#123;&apos;port&apos;&#125; : &quot;80&quot;;                                           </span><br><span class="line">                                                                                                </span><br><span class="line">if ( exists $ARGV[0] and $ARGV[0] eq &quot;autoconf&quot; )                                               </span><br><span class="line">&#123;</span><br><span class="line">    if ($ret)&#123;</span><br><span class="line">        print &quot;no ($ret)\n&quot;;</span><br><span class="line">        exit 0;</span><br><span class="line">    &#125;</span><br><span class="line">    my $ua = LWP::UserAgent-&gt;new(timeout =&gt; 30,</span><br><span class="line">            agent =&gt; sprintf(&quot;munin/%s (libwww-perl/%s)&quot;,    $Munin::Common::Defaults::MUNIN_VERSION, $LWP::VERSION));     </span><br><span class="line">    my $response = $ua-&gt;request(HTTP::Request-&gt;new(&apos;GET&apos;,$URL));</span><br><span class="line">    unless ($response-&gt;is_success and $response-&gt;content =~ /server/im)</span><br><span class="line">    &#123;</span><br><span class="line">        print &quot;no (no nginx status on $URL)\n&quot;;</span><br><span class="line">        exit 0;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        print &quot;yes\n&quot;;</span><br><span class="line">        exit 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ˜¯nginx_requestæ¨¡å—çš„æºç ï¼Œé€šè¿‡ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå…¶å®è¿™ä¸ªç¨‹åºæ˜¯å»è¯·æ±‚é‡Œé¢çš„urlï¼Œä»è€Œè·å¾—nginxçš„ä¸€äº›çŠ¶æ€<br>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å®˜æ–¹nginxçš„é…ç½®<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">      listen 80;</span><br><span class="line">      server_name localhost;</span><br><span class="line">      location /nginx_status &#123;</span><br><span class="line">              stub_status on;</span><br><span class="line">              access_log   off;</span><br><span class="line">              allow 127.0.0.1;</span><br><span class="line">              deny all;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç»¼ä¸Šï¼Œæ•´ä½“æ€è·¯å¯ä»¥ç†æ¸…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">muninå‘èµ·è¯·æ±‚--&gt;nginxè·å–è¯·æ±‚</span><br><span class="line">nginxè·å–è¯·æ±‚--&gt;nginxè§£æè¯·æ±‚,å¯åŠ¨stu_statusæ¨¡å—</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œåªè¦å°†å®˜æ–¹çš„nginxé…ç½®åŠ å…¥åˆ°nginx.confä¸­å³å¯ï¼Œä½†æ˜¯ï¼Œåœ¨æ­¤æˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œé€šè¿‡curlè®¿é—®è¿™<em>ä¸ª<a href="https://localhost/nginx_status" target="_blank" rel="noopener">https://localhost/nginx_status</a></em> è¿”å›çš„æ˜¯</p><pre><code>curl: (7) Failed connect to localhost:80; Connection refused</code></pre><p>ä½†æ˜¯è®¿é—®127.0.0.1å´æ˜¯å¯ä»¥çš„ï¼Œæˆ‘çš„é…ç½®å¦‚ä¸‹</p><p><strong>nginx.conf</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">      listen 80;</span><br><span class="line">      server_name 127.0.0.1;</span><br><span class="line">      location /nginx_status &#123;</span><br><span class="line">              stub_status on;</span><br><span class="line">              access_log   off;</span><br><span class="line">              allow 127.0.0.1;</span><br><span class="line">              deny all;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>nginx_request</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">my $URL = exists $ENV&#123;&apos;url&apos;&#125; ? $ENV&#123;&apos;url&apos;&#125; : &quot;http://127.0.0.1/nginx_status&quot;;                   </span><br><span class="line">my $port = exists $ENV&#123;&apos;port&apos;&#125; ? $ENV&#123;&apos;port&apos;&#125; : &quot;80&quot;;                                           </span><br><span class="line">                                                                                                </span><br><span class="line">if ( exists $ARGV[0] and $ARGV[0] eq &quot;autoconf&quot; )                                               </span><br><span class="line">&#123;</span><br><span class="line">    if ($ret)&#123;</span><br><span class="line">        print &quot;no ($ret)\n&quot;;</span><br><span class="line">        exit 0;</span><br><span class="line">    &#125;</span><br><span class="line">    my $ua = LWP::UserAgent-&gt;new(timeout =&gt; 30,</span><br><span class="line">            agent =&gt; sprintf(&quot;munin/%s (libwww-perl/%s)&quot;, $Munin::Common::Defaults::MUNIN_VERSION, $LWP::VERSION));     </span><br><span class="line">    my $response = $ua-&gt;request(HTTP::Request-&gt;new(&apos;GET&apos;,$URL));</span><br><span class="line">    unless ($response-&gt;is_success and $response-&gt;content =~ /server/im)</span><br><span class="line">    &#123;</span><br><span class="line">        print &quot;no (no nginx status on $URL)\n&quot;;</span><br><span class="line">        exit 0;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        print &quot;yes\n&quot;;</span><br><span class="line">        exit 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ£€æŸ¥æ¨¡å—æ˜¯å¦æ­£å¸¸<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">munin-node-configure |grep nginx</span><br><span class="line">nginx_request | yes |  </span><br><span class="line">nginx_status | yes |</span><br></pre></td></tr></table></figure></p><h1 id="ç›‘æ§Redis"><a href="#ç›‘æ§Redis" class="headerlink" title="ç›‘æ§Redis"></a>ç›‘æ§Redis</h1><ol><li><p>é¦–å…ˆä¸‹è½½munin redisçš„ç¬¬ä¸‰æ–¹æ’ä»¶</p><pre><code>git clone https://github.com/bpineau/redis-munin</code></pre></li><li><p>å°†gitä¸‹è½½çš„redis-muninä¸­çš„<em>redis_</em>æ›´åï¼Œæ›´æ”¹ä¸ºredis_<em>IP</em>_<em>PORT</em>, eg. <em>redis_127.0.0.1_6379</em></p></li><li><p>åŠ è½½redisæ’ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /path/to/redis_*IP*_*PORT* /etc/munin/plugins/</span><br></pre></td></tr></table></figure></li><li><p>åœ¨/etc/munin/conf.dä¸­æ·»åŠ redisï¼Œåˆ›å»ºmuninçš„redisé…ç½®æ–‡ä»¶</p><pre><code>[redis_*]   user root     //åœ¨è¿™é‡Œè¦rootç”¨æˆ·   env.host 127.0.0.1   env.port 6379</code></pre></li><li><p>æµ‹è¯•redisæ’ä»¶</p><pre><code>munin-run redis</code></pre></li><li><p>é‡å¯munin</p><pre><code>service munin-node restart</code></pre><p>â€‹     </p><h1 id="ç›‘æ§php-fpm"><a href="#ç›‘æ§php-fpm" class="headerlink" title="ç›‘æ§php-fpm"></a>ç›‘æ§php-fpm</h1></li><li><p>é¦–å…ˆå¼€å¯php-fpmçš„çŠ¶æ€</p><blockquote><p>vim /etc/php-fpm.d/<a href="http://www.conf" target="_blank" rel="noopener">www.conf</a></p><p>pm.status_path = /status     //æŠŠå‰é¢æ³¨é‡Šå»æ‰ </p><p>kill -USR2 <code>cat /run/php-fpm/php-fpm.pid</code>  // å¹³æ»‘é‡å¯php-fpmï¼Œçº¿ä¸Šå»ºè®®æ­¤ç”¨æ³•</p></blockquote></li><li><p>ä¿®æ”¹nginxé…ç½®</p><blockquote><p>åœ¨ä¸Šé¢ç›‘æ§nginxçš„serverä¸‹çš„locationä¸‹é¢æ·»åŠ ä¸€ä¸ªlocationé…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; location ~ ^/(status|ping)$ &#123;</span><br><span class="line">&gt; include fastcgi_params;</span><br><span class="line">&gt; fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">&gt; fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;  </span><br><span class="line">&gt; allow 127.0.0.1;</span><br><span class="line">&gt; deny all;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote></li><li><p>é‡å¯nginx</p></li><li><p>é€šè¿‡curlè®¿é—®ï¼Œæ£€æµ‹é…ç½®æ˜¯å¦æ­£ç¡®</p><pre><code>curl -v http://127.0.0.1/status</code></pre></li><li><p>ä¸‹è½½munin-phpfpmçš„æ’ä»¶</p><pre><code>git clone https://github.com/tjstein/php5-fpm-munin-plugins</code></pre></li><li><p>å»ºç«‹phpfpmç›¸å…³æ’ä»¶çš„è½¯é“¾</p><pre><code>ln -s /etc/munin/thirdPlugins/php5-fpm-munin-plugins/phpfpm_* /etc/munin/plugins/</code></pre></li><li><p>ç¼–è¾‘phpfpmçš„é…ç½®æ–‡ä»¶</p><blockquote><p>vim /et/munin/conf.d/phpfpm</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [phpfpm*]</span><br><span class="line">&gt; env.url http://127.0.01/status</span><br><span class="line">&gt; env.ports 80</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote></li><li><p>æµ‹è¯•phpfpmæ’ä»¶</p><blockquote><p>munin-run phpfpm_connections<br>munin-run phpfpm_memory</p></blockquote></li></ol><h1 id="ç›‘æ§MySQL"><a href="#ç›‘æ§MySQL" class="headerlink" title="ç›‘æ§MySQL"></a>ç›‘æ§MySQL</h1><p>muninæœ¬èº«è‡ªå¸¦çš„MySQLç›‘æ§ä¿¡æ¯å¤ªå°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œé€‰æ‹©ç¬¬ä¸‰æ–¹çš„munin MySQLæ’ä»¶</p><ol><li><p>å®‰è£…ç¬¬ä¸‰æ–¹MySQLæ’ä»¶æ‰€éœ€çš„ä¾èµ–</p><pre><code>yum -y install yum install perl-Cache-Cache perl-IPC-ShareLite perl-DBD-MySQL perl-Module-Pluggable</code></pre></li><li><p>ä¸‹è½½æºç åŒ…</p><pre><code>git clone https://github.com/kjellm/munin-mysql</code></pre></li><li><p>ç¼–è¾‘ä¸‹è½½ä¸‹æ¥çš„æºç åŒ…é‡Œé¢çš„<em>Makefile</em></p><blockquote><p>ä¿®æ”¹ç¬¬å››è¡Œçš„ä»£ç  <em>PLUGIN_DIR:=/usr/local/share/munin/plugins</em></p><pre><code>PLUGIN_DIR:=/usr/share/munin/plugins</code></pre><p>ä¿®æ”¹ç¬¬å››åäº”è¡Œçš„ä»£ç  <em>$(MUNIN_NODE) restart</em></p><pre><code>service munin-node restart</code></pre><p>â€‹</p></blockquote></li><li><p>ç¼–è¾‘<em>mysql.conf</em></p><blockquote><p>æ³¨é‡Šç¬¬åä¸€è¡Œ<em>env.mysqlconnection DBI:mysql:mysql</em>å¹¶åˆ é™¤ç¬¬ä¹è¡Œ<em>env.mysqlconnection DBI:mysql:mysql;host=localhost;port=3306</em>çš„æ³¨é‡Š</p><p>æŒ‰ç…§mysqlçš„é…ç½®åˆ†åˆ«å¡«å†™host port user password</p></blockquote></li><li><p>åœ¨å½“å‰è·¯å¾„ä¸‹æ‰§è¡Œç¼–è¯‘è„šæœ¬<br>â€‹      </p><pre><code>make install</code></pre></li><li><p>æ£€æµ‹MySQLæ’ä»¶æ˜¯å¦æ­£å¸¸å®‰è£…</p><pre><code>munin-run mysql</code></pre></li></ol><h1 id="é‡æ–°ç”ŸæˆHTMLæ–‡ä»¶"><a href="#é‡æ–°ç”ŸæˆHTMLæ–‡ä»¶" class="headerlink" title="é‡æ–°ç”ŸæˆHTMLæ–‡ä»¶"></a>é‡æ–°ç”ŸæˆHTMLæ–‡ä»¶</h1><p>ç»¼ä¸Šæ‰€æœ‰æ­¥éª¤å®Œæˆåï¼Œé‡å¯<em>munin-node</em>å‘ç°é¡µé¢ä¸Šè¿˜æ˜¯æ²¡æœ‰MySQLï¼Œredisï¼Œphpfpmçš„ç›¸å…³å†…å®¹ï¼Œè¿™æ—¶éœ€è¦é€šè¿‡<strong>munin-cron</strong>è„šæœ¬æ¥é‡æ–°ç”ŸæˆHTMLæ–‡ä»¶</p><blockquote><p>su - munin â€“shell=/bin/bash<br>munin-cron</p></blockquote><h1 id="Nginxæ·»åŠ è®¤è¯æ¨¡å—åŠç¦ç”¨ç¼“å­˜"><a href="#Nginxæ·»åŠ è®¤è¯æ¨¡å—åŠç¦ç”¨ç¼“å­˜" class="headerlink" title="Nginxæ·»åŠ è®¤è¯æ¨¡å—åŠç¦ç”¨ç¼“å­˜"></a>Nginxæ·»åŠ è®¤è¯æ¨¡å—åŠç¦ç”¨ç¼“å­˜</h1><p>æˆ‘ä»¬åœ¨æµè§ˆæ—¶å‘ç°ï¼Œå¾ˆå¤šåœ°æ–¹HTMLä¼šè¢«æµè§ˆå™¨ç¼“å­˜ï¼Œå¯¼è‡´å¾ˆå¤šæ—¶å€™éœ€è¦å¼ºåˆ¶åˆ·æ–°æ‰èƒ½çœ‹åˆ°æœ€æ–°çš„å›¾ç‰‡ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦åœ¨nginxä¸­ç¦æ­¢ç¼“å­˜æ¥å¤„ç†</p><p>æˆ‘ä»¬åˆ©ç”¨Nginxçš„<em>ngx_http_auth_basic_module</em>æ¥åšç”¨æˆ·éªŒè¯ä»¥ä¿è¯ä¿¡æ¯çš„å®‰å…¨</p><p>ä¸Šé¢æˆ‘ä»¬ä¸ºäº†åŠ¨æ€çš„ç”Ÿæˆå›¾ç‰‡ï¼Œåœ¨nginxä¸­åšäº†è§£æï¼Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /munin-cgi/munin-cgi-graph/ &#123;</span><br><span class="line">    root /data/www/html</span><br><span class="line">    fastcgi_split_path_info ^(/munin-cgi/munin-cgi-graph)(.*);</span><br><span class="line">    fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">    fastcgi_pass unix:/var/run/munin/fastcgi-graph.sock;</span><br><span class="line">    include fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨åšæƒé™è®¤è¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç”Ÿæˆä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç ï¼Œä»¥ä¾›nginxä½¿ç”¨<br>â€‹<br>        printf â€œmunin:$(openssl passwd -crypt 123456)\nâ€ &gt;&gt; /etc/munin/httppwd</p><p>åœ¨è¿™æ®µä»£ç çš„ä¸Šé¢æ·»åŠ æƒé™è®¤è¯åŠè¿›è¡Œç¼“å­˜ï¼Œé€šçŸ¥ä¿®æ”¹ä¸€ä¸‹è¿™æ®µè§£æç¦æ­¢ç¼“å­˜<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#munin ä¸‹é¢çš„æ–‡ä»¶ä¸ç¼“å­˜</span><br><span class="line">location ~ /munin/html &#123;</span><br><span class="line">    root /data/www/html;</span><br><span class="line">    expires -1;</span><br><span class="line">    add_header Cache-Control no-store;</span><br><span class="line">    index index.html;</span><br><span class="line">    auth_basic &quot;User Auth&quot;;</span><br><span class="line">    auth_basic_user_file /etc/munin/httppwd;</span><br><span class="line">    autoindex on;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">#munin ç›‘æ§åŠ¨æ€ç”»å›¾</span><br><span class="line">location ^~ /munin-cgi/munin-cgi-graph/ &#123;</span><br><span class="line">    root /data/www/html;</span><br><span class="line">    add_header Cache-Control no-store;</span><br><span class="line">    fastcgi_split_path_info ^(/munin-cgi/munin-cgi-graph)(.*);</span><br><span class="line">    fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">    fastcgi_pass unix:/var/run/munin/fastcgi-graph.sock;</span><br><span class="line">    include fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> munin </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxä¸‹ä½¿ç”¨mailå‘é€é‚®ä»¶</title>
      <link href="/posts/47206/"/>
      <url>/posts/47206/</url>
      
        <content type="html"><![CDATA[<p>è¿‘æœŸåœ¨åšç›‘æ§çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡å‘½ä»¤è¡Œæ¥å‘é€é‚®ä»¶ã€‚æ™®é€šé‚®ä»¶é€šè¿‡25ç«¯å£å‘é€ï¼Œç®€å•é…ç½®ä¸€ä¸‹å³å¯ï¼Œä½†æ˜¯æˆ‘ä»¬çš„é‚®ä»¶æœåŠ¡å™¨å¹¶ä¸æ”¯æŒæ™®é€šçš„smtpé‚®ä»¶å‘é€ï¼Œä»…ä»…æ”¯æŒsmtpså‘é€é‚®ä»¶ï¼Œè¿™å°±éœ€è¦è¯ä¹¦éªŒè¯äº†ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé€šè¿‡è‡ªåˆ¶è¯ä¹¦å¹¶å¿½ç•¥éªŒè¯æ¥é€šè¿‡smtpså‘é€é‚®ä»¶</p><a id="more"></a><h1 id="mailx"><a href="#mailx" class="headerlink" title="mailx"></a>mailx</h1><h2 id="å®‰è£…mailx"><a href="#å®‰è£…mailx" class="headerlink" title="å®‰è£…mailx"></a>å®‰è£…mailx</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mailx</span><br></pre></td></tr></table></figure><h2 id="é…ç½®mailxï¼ˆsmtps-465ç«¯å£ï¼‰"><a href="#é…ç½®mailxï¼ˆsmtps-465ç«¯å£ï¼‰" class="headerlink" title="é…ç½®mailxï¼ˆsmtps - 465ç«¯å£ï¼‰"></a>é…ç½®mailxï¼ˆsmtps - 465ç«¯å£ï¼‰</h2><p>ç¼–è¾‘/etc/mail.rcï¼Œå¹¶æ·»åŠ ä¸Šä»¥ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set from=username@hostname.com         # è¿™é‡Œæ˜¯å‘ä»¶äººçš„é‚®ç®±åœ°å€</span><br><span class="line">set smtp=smtps://smtp_hostname:465   # è¿™é‡Œè®¾ç½®å‘ä»¶æœåŠ¡å™¨çš„sslåœ°å€,ä¾‹ï¼šsmtps://smtp.163.com:465</span><br><span class="line">set nss-config-dir=/etc/mail/.certs    # SSLè¯ä¹¦ä¿å­˜ä½ç½®ï¼Œç¨åä¸ªäººåˆ¶ä½œ</span><br><span class="line">set ssl-verify=ignore                  # è¡¨ç¤ºä¸å¯¹sslçš„è¯ä¹¦è¿›è¡ŒéªŒè¯</span><br><span class="line">set smtp-auth-user=username@hostname.com  # é‚®ç®±éªŒè¯ç”¨æˆ·åï¼Œä¸€èˆ¬åŒé‚®ç®±åœ°å€</span><br><span class="line">set smtp-auth-password=password        # é‚®ç®±éªŒè¯å¯†ç </span><br><span class="line">set smtp-auth=login                    # è®¤è¯æ–¹å¼</span><br></pre></td></tr></table></figure><h2 id="é…ç½®mailxï¼ˆsmtp-25ç«¯å£ï¼‰"><a href="#é…ç½®mailxï¼ˆsmtp-25ç«¯å£ï¼‰" class="headerlink" title="é…ç½®mailxï¼ˆsmtp - 25ç«¯å£ï¼‰"></a>é…ç½®mailxï¼ˆsmtp - 25ç«¯å£ï¼‰</h2><p>smtpçš„å‘é€æ–¹å¼ç›¸å¯¹äºsmtpsçš„å‘é€æ–¹å¼çš„é…ç½®è¦ç®€å•éœ€è¦ï¼Œå› ä¸ºä¸éœ€è¦ssléªŒè¯ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸éœ€è¦è‡ªåˆ¶è¯ä¹¦ï¼Œé…ç½®å®Œä¸‹é¢éƒ¨åˆ†åå³å¯ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set from=username@hostname.com         # è¿™é‡Œæ˜¯å‘ä»¶äººçš„é‚®ç®±åœ°å€</span><br><span class="line">set smtp=smtp_hostname                # è¿™é‡Œè®¾ç½®å‘ä»¶æœåŠ¡å™¨çš„sslåœ°å€,ä¾‹ï¼šsmtp.163.com</span><br><span class="line">set smtp-auth-user=username@hostname.com  # é‚®ç®±éªŒè¯ç”¨æˆ·åï¼Œä¸€èˆ¬åŒé‚®ç®±åœ°å€</span><br><span class="line">set smtp-auth-password=password        # é‚®ç®±éªŒè¯å¯†ç </span><br><span class="line">set smtp-auth=login                    # è®¤è¯æ–¹å¼</span><br></pre></td></tr></table></figure><h1 id="è¯ä¹¦åˆ¶ä½œ"><a href="#è¯ä¹¦åˆ¶ä½œ" class="headerlink" title="è¯ä¹¦åˆ¶ä½œ"></a>è¯ä¹¦åˆ¶ä½œ</h1><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªç›®å½•ä¿å­˜è¯ä¹¦ï¼Œç„¶ååˆ›å»ºè¯ä¹¦å’Œå¯†é’¥çš„æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir .certs</span><br><span class="line">$ certutil -N -d .certs</span><br></pre></td></tr></table></figure><p>ç„¶åä»é‚®ç®±æœåŠ¡å™¨è·å–è¯ä¹¦ï¼Œå¹¶å¯¼å…¥åˆ°æœ¬åœ°æ•°æ®åº“ï¼ˆå°†hostnameä¿®æ”¹æˆå¯¹åº”çš„é‚®ç®±ä¸»æœºï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo -n | openssl s_client -connect smtp_hostname:465 | sed -ne &apos;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&apos; &gt; .certs/hostname.crt</span><br><span class="line">$ certutil -A -n &quot;Google Internet Authority&quot; -t &quot;C,,&quot; -d .certs -i .certs/hostname.crt</span><br></pre></td></tr></table></figure><h1 id="å‘é€é‚®ä»¶"><a href="#å‘é€é‚®ä»¶" class="headerlink" title="å‘é€é‚®ä»¶"></a>å‘é€é‚®ä»¶</h1><p>æ‰§è¡Œä¸€ä¸‹å‘½ä»¤å³å¯å‘é€é‚®ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mail -s &quot;test&quot; keven518@163.com </span><br><span class="line">this is test email</span><br><span class="line">crtl+d</span><br></pre></td></tr></table></figure><p>crtl+dç»“æŸè¾“å…¥ æˆ–è€…æ‰§è¡Œ <code>man mailx</code>æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Error in certificate: Peer&apos;s certificate issuer is not recognized.</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°é”™è¯¯ç›´æ¥æ— è§†å³å¯</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> mail </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
